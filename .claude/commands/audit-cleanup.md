---
description: 项目级代码审查与自动清理
---

# 代码审查与清理工作流

你现在作为代码审查专家，需要对 `templates/` 目录执行全面的代码审查和自动清理。

## 核心原则

**重要**: 本次审查**完全基于代码实现分析**，不可信任任何注释和文档。

## 执行流程

### 阶段 1: 扫描与依赖图构建 (5-10分钟)

#### 目标
构建完整的代码依赖关系图，识别所有被引用和未被引用的文件。

#### 步骤
1. **文件枚举**
   - 使用 Glob 扫描 `templates/.claude/hooks/**/*.py`
   - 排除 `__pycache__/`, `*.pyc` 等临时文件

2. **静态依赖分析**
   - 对每个 Python 文件，使用 Read 工具读取内容
   - 提取所有 `import` 和 `from ... import ...` 语句
   - 构建文件间的依赖关系边

3. **入口点检测**
   - 读取 `templates/.claude/settings.json.template`
   - 提取所有已注册的 hook 文件路径
   - 将这些文件标记为入口点（绝对不可删除）

4. **依赖图遍历**
   - 从所有入口点出发，使用深度优先搜索 (DFS)
   - 标记所有可达的文件为 "被引用"
   - 未被标记的文件 → 添加到候选删除列表

### 阶段 2: 多维度验证 (3-5分钟)

对候选删除列表中的文件，执行以下验证：

#### 验证 A: 动态引用检测
使用 Grep 搜索以下模式：
- `importlib.import_module.*{filename}`
- `__import__.*{filename}`

如果发现动态引用，降低删除置信度。

#### 验证 B: 配置文件引用
检查以下文件中是否引用候选文件：
- `templates/.claude/workflow-config.json`
- `templates/.claude/knowledge-base.json` (如果存在)

#### 验证 C: 特殊命名模式
- `__init__.py` → 标记为 "Python包标识符"，单独评估
- `test_*.py` → 标记为 "测试文件"
- 文件名包含 `deprecated`, `obsolete`, `old_` → 提高删除置信度

#### 验证 D: Git 状态交叉验证
使用 Bash 运行 `git status --short` 检查：
- 标记为 `D` (已删除) 的文件 → 高置信度删除（清理残留）
- 标记为 `??` (未追踪) 的文件 → 需要额外确认
- 标记为 `M` (已修改) 的文件 → 降低删除置信度

#### 验证 E: 函数级别未使用检测
对未被引用的文件：
- 提取文件中定义的所有函数和类
- 在项目中搜索这些函数/类的调用点
- 如果函数未被调用，标记为 "未使用函数"

### 阶段 3: 置信度分级 (1-2分钟)

根据验证结果，将候选文件分为三类：

#### 🔴 高置信度 (可安全删除，自动执行)
- 文件位于 `deprecated/` 目录
- 文件在 git status 中标记为 `D` (已删除)
- 文件未被任何代码引用（静态+动态检查均通过）
- 文件注释中明确标记 `# deprecated` 或 `# obsolete`

#### 🟡 中置信度 (需要用户确认)
- 文件未被引用，但位于核心模块目录 (`core/`, `utils/`, `orchestrator/`)
- 文件被引用，但所有函数/类均未被使用
- `__init__.py` 文件，但所在目录的其他文件均未被引用

#### 🟢 低置信度 (仅报告，不删除)
- 文件名包含 `test`, `debug`, `temp` 但无明确废弃标记
- 文件可能被动态引用（字符串拼接导入）
- 新增文件 (git status 显示 `??`) 但未被引用（可能未完成开发）

### 阶段 4: 生成详细报告 (1分钟)

使用 Write 工具创建报告文件：
- 路径: `audit-reports/YYYY-MM-DD-HHMMSS.md`
- 内容包括：
  - 总体统计（扫描文件数、可删除文件数、置信度分布）
  - 高置信度删除列表（每个文件的删除理由、影响分析、备份路径）
  - 中置信度确认列表（风险评估、建议操作）
  - 低置信度观察列表（仅作记录）
  - 未使用函数清单（函数名、所在文件、行号、建议）
  - 清理汇总（已删除文件、待确认文件、备份位置）
  - Git 状态（备份分支名、提交哈希）

### 阶段 5: 执行清理 (等待用户确认)

#### 5.1 创建 Git 备份
```bash
git checkout -b audit-cleanup-YYYY-MM-DD-HHMMSS
git add .
git commit -m "backup: 审查前快照"
```

#### 5.2 创建文件级备份
对每个待删除文件：
```bash
mkdir -p audit-reports/backups/YYYY-MM-DD-HHMMSS/<相对路径>
cp <文件> audit-reports/backups/YYYY-MM-DD-HHMMSS/<相对路径>
```

#### 5.3 自动删除高置信度文件
对高置信度列表中的每个文件：
```bash
rm <文件路径>
```
实时输出删除进度。

#### 5.4 询问用户确认中置信度删除
展示中置信度文件列表（每个文件的详细信息）。

询问用户：
```
是否删除中置信度文件？
- 输入 "yes" / "全部删除": 删除所有
- 输入 "1,3" / "仅删除 1 和 3": 部分删除（逗号分隔的序号）
- 输入 "no" / "取消": 跳过删除
```

#### 5.5 生成清理提交
```bash
git add .
git commit -m "cleanup: 审查清理 - 删除 N 个废弃文件

高置信度删除:
- <文件1>
- <文件2>
...

中置信度删除 (用户确认):
- <文件3>
...

生成于: YYYY-MM-DD HH:MM:SS
报告: audit-reports/YYYY-MM-DD-HHMMSS.md"
```

## 输出要求

### 进度可视化
在每个阶段开始和结束时输出进度：
```
⏳ 阶段 1/5: 扫描与依赖图构建 [████████░░] 80%
  ✅ 扫描文件: 42 个
  ✅ 构建依赖图: 35 条边
  ✅ 入口点检测: 10 个 hooks
```

### 实时输出关键发现
在分析过程中，实时输出重要发现：
```
🔍 发现未引用文件: deprecated/logger.py
🔍 发现动态引用: utils/notify.py (被 importlib 引用)
⚠️ Git 状态异常: monitors/change_logger.py 已标记删除但仍存在
```

### 最终汇总
在所有阶段完成后，输出清晰的汇总信息：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 审查完成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 汇总:
  - 已删除: 9 个文件
  - 等待确认: 3 个文件
  - 备份位置: audit-reports/backups/2025-11-16-120000/
  - 详细报告: audit-reports/2025-11-16-120000.md

🎯 下一步:
  1. 查看详细报告确认删除内容
  2. 运行测试验证: cd tests && npm test
  3. 提交清理: git commit -m "..."
```

## 重要规则

1. **不可信任注释和文档** - 仅依赖代码实现分析
2. **Git 分支备份优先** - 删除前必须创建备份分支
3. **高置信度才自动删除** - 有任何疑问的文件必须询问用户
4. **详细记录删除原因** - 每个删除操作必须有明确理由和影响分析
5. **避免过度清理** - 宁可保留可疑文件，不可误删活跃代码

## 开始执行

立即开始执行代码审查工作流，按照上述 5 个阶段依次执行。

对于每个阶段，清晰地输出：
- 阶段名称和进度
- 正在执行的操作
- 发现的关键信息
- 阶段完成状态

最终生成完整的审查报告并等待用户确认清理操作。
