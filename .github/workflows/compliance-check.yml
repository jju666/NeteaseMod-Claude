name: æ–‡æ¡£åˆè§„æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'markdown/**'
      - 'templates/**'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'markdown/**'
      - 'templates/**'
      - 'docs/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥æ–‡æ¡£åˆè§„æ€§

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽæ£€æŸ¥

      - name: ðŸ” æ£€æŸ¥ç¦æ­¢è¡¨è¿°
        run: |
          echo "ðŸ” æ£€æŸ¥markdown/å’Œtemplates/ç›®å½•ä¸­çš„ç¦æ­¢è¡¨è¿°..."

          # å®šä¹‰ç¦æ­¢è¡¨è¿°åˆ—è¡¨
          FORBIDDEN_PATTERNS=(
            "æ ¹æ®åç¼–è¯‘"
            "é€†å‘å·¥ç¨‹"
            "æºç åˆ†æž"
            "åç¼–è¯‘ä»£ç "
            "D:\\\\EcWork\\\\3\\.5"
            "åˆ†æžæºç å‘çŽ°"
            "åç¼–è¯‘ç»“æžœæ˜¾ç¤º"
          )

          VIOLATIONS_FOUND=0

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            echo "æ£€æŸ¥: $pattern"
            if grep -r -n "$pattern" markdown/ templates/ 2>/dev/null; then
              echo "âŒ å‘çŽ°è¿è§„è¡¨è¿°: $pattern"
              VIOLATIONS_FOUND=1
            fi
          done

          if [ $VIOLATIONS_FOUND -eq 1 ]; then
            echo ""
            echo "âŒ åˆè§„æ£€æŸ¥å¤±è´¥ï¼å‘çŽ°ç¦æ­¢è¡¨è¿°ã€‚"
            echo "è¯·å‚è€ƒ INTERNAL_DOCS_POLICY.md äº†è§£åˆè§„è¦æ±‚ã€‚"
            exit 1
          fi

          echo "âœ… ç¦æ­¢è¡¨è¿°æ£€æŸ¥é€šè¿‡"

      - name: ðŸ›¡ï¸ æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
        run: |
          echo "ðŸ›¡ï¸ æ£€æŸ¥Gitè·Ÿè¸ªçš„æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿå†…å®¹..."

          # å®šä¹‰æ•æ„Ÿæ–‡ä»¶æ¨¡å¼
          SENSITIVE_PATTERNS=(
            "å¼€å‘åŒ…æ–‡æ¡£åˆ†æžæŠ¥å‘Š"
            "\.internal\.md$"
            ".internal-docs"
            "ç³»ç»Ÿæ€§æ£€æŸ¥æŠ¥å‘Š"
            "åˆè§„æ£€æŸ¥æŠ¥å‘Š"
            "ä¿®å¤-å®ŒæˆæŠ¥å‘Š"
            "æ£€æŸ¥æŠ¥å‘Šç´¢å¼•"
          )

          SENSITIVE_FILES_FOUND=0

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            echo "æ£€æŸ¥: $pattern"
            if git ls-files | grep -i "$pattern" 2>/dev/null; then
              echo "âŒ å‘çŽ°æ•æ„Ÿæ–‡ä»¶: $pattern"
              SENSITIVE_FILES_FOUND=1
            fi
          done

          if [ $SENSITIVE_FILES_FOUND -eq 1 ]; then
            echo ""
            echo "âŒ æ•æ„Ÿæ–‡ä»¶æ£€æŸ¥å¤±è´¥ï¼å‘çŽ°æœªéš”ç¦»çš„å†…éƒ¨æ–‡ä»¶ã€‚"
            echo "è¯·å°†è¿™äº›æ–‡ä»¶æ·»åŠ åˆ° .gitignore"
            exit 1
          fi

          echo "âœ… æ•æ„Ÿæ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: ðŸ“ æ£€æŸ¥æœ¬åœ°è·¯å¾„æ³„éœ²
        run: |
          echo "ðŸ“ æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ¬åœ°è·¯å¾„æ³„éœ²..."

          # æ£€æŸ¥Windowsè·¯å¾„æ¨¡å¼
          if grep -r -n "D:\\\\[^\"]*\\\\" markdown/ templates/ 2>/dev/null | grep -v "CLAUDE.md\|README.md"; then
            echo "âŒ å‘çŽ°æœ¬åœ°Windowsè·¯å¾„æ³„éœ²"
            echo "è¯·ç§»é™¤æ‰€æœ‰æœ¬åœ°è·¯å¾„å¼•ç”¨"
            exit 1
          fi

          # æ£€æŸ¥Unixè·¯å¾„æ¨¡å¼ï¼ˆæŽ’é™¤åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼‰
          if grep -r -n "/Users/[^/]*/.*EcWork\|/home/[^/]*/.*EcWork" markdown/ templates/ 2>/dev/null; then
            echo "âŒ å‘çŽ°æœ¬åœ°Unixè·¯å¾„æ³„éœ²"
            echo "è¯·ç§»é™¤æ‰€æœ‰æœ¬åœ°è·¯å¾„å¼•ç”¨"
            exit 1
          fi

          echo "âœ… æœ¬åœ°è·¯å¾„æ£€æŸ¥é€šè¿‡"

      - name: ðŸ“‹ æ£€æŸ¥ç‰ˆæœ¬å·ä¸€è‡´æ€§
        run: |
          echo "ðŸ“‹ æ£€æŸ¥ç‰ˆæœ¬å·ä¸€è‡´æ€§..."

          # æå–package.jsonç‰ˆæœ¬å·
          PACKAGE_VERSION=$(grep -oP '"version":\s*"\K[^"]+' package.json)
          echo "package.jsonç‰ˆæœ¬: $PACKAGE_VERSION"

          # æ£€æŸ¥CLAUDE.mdç‰ˆæœ¬å·
          if ! grep -q "v$PACKAGE_VERSION" CLAUDE.md; then
            echo "âš ï¸ è­¦å‘Š: CLAUDE.mdç‰ˆæœ¬å·å¯èƒ½ä¸ä¸€è‡´"
            echo "è¯·ç¡®è®¤CLAUDE.mdä¸­çš„ç‰ˆæœ¬å·ä¸º: v$PACKAGE_VERSION"
          fi

          # æ£€æŸ¥templates/CLAUDE.md.templateç‰ˆæœ¬å·
          if ! grep -q "v$PACKAGE_VERSION" templates/CLAUDE.md.template; then
            echo "âš ï¸ è­¦å‘Š: templates/CLAUDE.md.templateç‰ˆæœ¬å·å¯èƒ½ä¸ä¸€è‡´"
            echo "è¯·ç¡®è®¤æ¨¡æ¿ä¸­çš„ç‰ˆæœ¬å·ä¸º: v$PACKAGE_VERSION"
          fi

          echo "âœ… ç‰ˆæœ¬å·ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ"

      - name: ðŸ“Š ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        if: always()
        run: |
          echo "ðŸ“Š åˆè§„æ£€æŸ¥æŠ¥å‘Š"
          echo "================"
          echo "æ£€æŸ¥æ—¶é—´: $(date)"
          echo "Gitæäº¤: $GITHUB_SHA"
          echo "åˆ†æ”¯: $GITHUB_REF"
          echo ""
          echo "æ£€æŸ¥é¡¹ç›®:"
          echo "  âœ… ç¦æ­¢è¡¨è¿°æ£€æŸ¥"
          echo "  âœ… æ•æ„Ÿæ–‡ä»¶æ£€æŸ¥"
          echo "  âœ… æœ¬åœ°è·¯å¾„æ£€æŸ¥"
          echo "  âœ… ç‰ˆæœ¬å·ä¸€è‡´æ€§æ£€æŸ¥"
          echo ""
          echo "åˆè§„æ£€æŸ¥å®Œæˆï¼"

  # å¯é€‰ï¼šæ–‡æ¡£é“¾æŽ¥æ£€æŸ¥ï¼ˆé˜²æ­¢å­¤å²›æ–‡æ¡£ï¼‰
  link-check:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥å®Œæ•´æ€§

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ðŸ”— æ£€æŸ¥markdowné“¾æŽ¥
        run: |
          echo "ðŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æŽ¥å®Œæ•´æ€§..."

          # æŸ¥æ‰¾æ‰€æœ‰markdownæ–‡ä»¶ä¸­çš„ç›¸å¯¹é“¾æŽ¥
          find markdown/ templates/ -name "*.md" -type f | while read file; do
            echo "æ£€æŸ¥æ–‡ä»¶: $file"

            # æå–ç›¸å¯¹è·¯å¾„é“¾æŽ¥ï¼ˆæŽ’é™¤HTTPé“¾æŽ¥ï¼‰
            grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$file" 2>/dev/null | while read link; do
              # è·³è¿‡HTTPé“¾æŽ¥å’Œé”šç‚¹
              if [[ "$link" =~ ^https?:// ]] || [[ "$link" =~ ^# ]]; then
                continue
              fi

              # è®¡ç®—é“¾æŽ¥çš„ç»å¯¹è·¯å¾„
              dir=$(dirname "$file")
              target=$(realpath -m "$dir/$link" 2>/dev/null || echo "$link")

              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if [ ! -e "$target" ]; then
                echo "âš ï¸ è­¦å‘Š: $file ä¸­çš„é“¾æŽ¥å¤±æ•ˆ: $link"
              fi
            done
          done

          echo "âœ… é“¾æŽ¥æ£€æŸ¥å®Œæˆ"

  # å¯é€‰ï¼šæ–‡æ¡£è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    name: æ–‡æ¡£è´¨é‡æ£€æŸ¥

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ðŸ“ˆ ç»Ÿè®¡æ–‡æ¡£è¡Œæ•°
        run: |
          echo "ðŸ“ˆ æ£€æŸ¥è¶…é•¿æ–‡æ¡£ï¼ˆ>1000è¡Œï¼‰..."

          find markdown/ templates/ -name "*.md" -type f | while read file; do
            lines=$(wc -l < "$file")
            if [ $lines -gt 1000 ]; then
              echo "âš ï¸ è­¦å‘Š: $file è¿‡é•¿ï¼ˆ$lines è¡Œï¼‰ï¼Œå»ºè®®åˆ†æ‹†"
            fi
          done

          echo "âœ… æ–‡æ¡£è¡Œæ•°æ£€æŸ¥å®Œæˆ"

      - name: ðŸ“ æ£€æŸ¥æ–‡æ¡£å¤´éƒ¨å£°æ˜Ž
        run: |
          echo "ðŸ“ æ£€æŸ¥æ ¸å¿ƒæ–‡æ¡£æ˜¯å¦åŒ…å«æ ‡é¢˜å’Œæ—¥æœŸ..."

          # æ£€æŸ¥å…³é”®æ–‡æ¡£æ˜¯å¦åŒ…å«ç‰ˆæœ¬ä¿¡æ¯
          KEY_DOCS=(
            "CLAUDE.md"
            "README.md"
            "templates/CLAUDE.md.template"
          )

          for doc in "${KEY_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              if ! grep -q "ç‰ˆæœ¬\|Version\|v[0-9]\+\.[0-9]\+" "$doc"; then
                echo "âš ï¸ è­¦å‘Š: $doc ç¼ºå°‘ç‰ˆæœ¬ä¿¡æ¯"
              fi
            fi
          done

          echo "âœ… æ–‡æ¡£å¤´éƒ¨æ£€æŸ¥å®Œæˆ"

  # å¯é€‰ï¼šè‡ªåŠ¨ä¿®å¤ï¼ˆä»…åœ¨å¼€å‘åˆ†æ”¯ï¼‰
  auto-fix:
    runs-on: ubuntu-latest
    name: è‡ªåŠ¨ä¿®å¤ï¼ˆå¯é€‰ï¼‰
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: [compliance-check, link-check, quality-check]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ è‡ªåŠ¨ç§»é™¤å°¾éšç©ºæ ¼
        run: |
          echo "ðŸ”§ è‡ªåŠ¨ç§»é™¤markdownæ–‡ä»¶çš„å°¾éšç©ºæ ¼..."

          find markdown/ templates/ -name "*.md" -type f | while read file; do
            # ç§»é™¤å°¾éšç©ºæ ¼ï¼ˆä¸ä¿®æ”¹æ–‡ä»¶æ—¶é—´æˆ³ï¼‰
            sed -i 's/[[:space:]]*$//' "$file"
          done

          echo "âœ… å°¾éšç©ºæ ¼æ¸…ç†å®Œæˆ"

      - name: ðŸ’¾ æäº¤ä¿®å¤
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if git diff --quiet; then
            echo "æ— éœ€ä¿®å¤"
          else
            git add markdown/ templates/
            git commit -m "chore: è‡ªåŠ¨ä¿®å¤æ–‡æ¡£æ ¼å¼é—®é¢˜ [skip ci]"
            git push
            echo "âœ… è‡ªåŠ¨ä¿®å¤å·²æäº¤"
          fi
