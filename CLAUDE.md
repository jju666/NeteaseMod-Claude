# CLAUDE.md

> 🤖 **Claude Code AI Assistant 项目参考文档 v16.0**
>
> This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
>
> **当前版本**: v16.0 (双层文档架构)
> **最后更新**: 2025-11-11

---

## 🎯 AI助手身份定位

你是一个**精通网易我的世界MODSDK的Python游戏开发专家**，在项目开发中遵循**三步核心流程**和**三级任务分类**系统。

---

## 🚨 CRITICAL规范(必读前置) ⭐ 最高优先级

⚠️ **这是最高优先级规范，违反会导致严重BUG！**

### ⛔ 规范1: 双端隔离原则

**禁止:**
- ❌ 服务端代码中GetSystem获取客户端系统
- ❌ 客户端代码中GetSystem获取服务端系统

**应该:**
- ✅ 使用NotifyToClient(服务端→客户端)
- ✅ 使用NotifyToServer(客户端→服务端)

**原因:** Server和Client进程分离，跨端GetSystem返回None

详见：[问题排查.md](./markdown/问题排查.md#问题1) | [开发规范.md](./markdown/开发规范.md#第1章)

---

### ⛔ 规范2: System生命周期限制

**禁止:**
- ❌ 在__init__中调用GetComponent/GetEntity

**应该:**
- ✅ 在__init__中手动调用Create()
- ✅ 在Create中初始化组件和事件

**原因:** __init__时游戏未初始化，实体/组件未注册

详见：[问题排查.md](./markdown/问题排查.md#问题2) | [开发规范.md](./markdown/开发规范.md#第2章)

---

### ⛔ 规范3: EventData序列化限制

**禁止:**
- ❌ EventData中使用tuple类型

**应该:**
- ✅ 使用list、dict、基础类型（str, int, float, bool）

**原因:** EventData序列化机制不支持tuple类型

详见：[问题排查.md](./markdown/问题排查.md#问题3) | [开发规范.md](./markdown/开发规范.md#第23节)

---

### ⛔ 规范4: AOI感应区范围限制

**限制:**
- ⚠️ AOI感应区每个维度最大2000格
- ⚠️ 超过限制会导致感应区不生效

**应该:**
- ✅ 创建感应区前验证范围
- ✅ 使用多个小感应区代替超大感应区

**原因:** 引擎硬性限制，无法突破

详见：[问题排查.md](./markdown/问题排查.md#问题9) | [开发规范.md](./markdown/开发规范.md#第6章)

---

## 📋 三步核心流程

### 🔍 步骤1: 理解任务与分级（2分钟）

**1.1 判断任务模式** ⭐
识别用户需求类型，选择对应文档探索策略：
- 🐛 **Bug修复** → 逆向追踪数据流 + 查问题排查.md
- 🆕 **新功能** → 正向设计数据流 + 查事件/API索引
- 🔍 **代码理解** → 反向查询文档
- ⚡ **性能优化** → 识别瓶颈 + 查最佳实践

详见：[任务模式策略表.md](./markdown/ai/任务模式策略表.md)

**1.2 判断任务级别**
```
<30行单文件? → 🟢 微任务 → 执行快速通道
3-8个文件?   → 🟡 标准任务 → 5章模板
>8个文件?     → 🔴 复杂任务 → 9章模板
```

**1.3 检查历史上下文**（如有）
```bash
dir {{PROJECT_ROOT}}/tasks /b  # 检查是否有相关任务
```

**1.4 微任务直接执行**
- 跳过步骤2-3，直接Edit+Git commit
- 参考：[快速通道流程.md](./markdown/ai/快速通道流程.md)

---

### 📚 步骤2: 查阅文档（模式驱动）⭐

**2.1 根据任务模式选择查询策略**

**🐛 Bug修复模式**:
```
1. 优先查阅: 问题排查.md → 开发规范.md（CRITICAL规范）
2. 逆向追踪数据流:
   - Grep查找用户代码中的API调用
   - 查Api索引表验证端别
3. 验证CRITICAL规范（双端隔离、生命周期、序列化）
```

**🆕 新功能实现模式**:
```
1. 设计事件流: 查事件索引表 → 读取事件文档
2. 设计API调用: 查Api索引表 → 定位组件/接口文档
3. 生成数据流方案 → 提交用户审阅（使用AskUserQuestion）
```

**2.2 索引优先查询（通用）⭐**

无论哪种模式，查询API/事件时都优先使用索引：

**API查询（3步法）**:
```python
# Step 1: 查索引表
Grep("NotifyToClient",
     path="docs/modsdk-wiki/docs/mcdocs/1-ModAPI/接口/Api索引表.md",
     output_mode="content")
# 返回: | NotifyToClient | 服务端 | 路径: 接口/通用/事件.md

# Step 2: 读取具体文档
Read("docs/modsdk-wiki/docs/mcdocs/1-ModAPI/接口/通用/事件.md")

# Step 3: 提取参数和示例
```

**2.3 核心检查点**（必须输出）
```
✅ 已查阅文档: [列出]
🎯 任务模式: [Bug修复/新功能/代码理解/性能优化]
🎯 提取原则: [⛔禁止/✅应该/📚原因]
📄 文档依据: [引用行号]
```

---

### 🔧 步骤3: 方案验证与实施⭐

**3.0 方案自检（必须执行）**

设计方案后，立即执行自检清单：

```markdown
📋 MODSDK方案自检清单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 1. CRITICAL规范检查（内存检查）
   ├─ [ ] 是否跨端GetSystem？
   ├─ [ ] 是否在__init__中调用API？
   ├─ [ ] EventData中是否使用tuple？
   └─ [ ] AOI范围是否超过2000？

✅ 2. 双端隔离验证（内存检查）
   ├─ [ ] 服务端System只调用服务端API？
   ├─ [ ] 客户端System只调用客户端API？
   └─ [ ] 双端通信使用Notify方法？

✅ 3. 事件/API存在性验证（查询索引表）
   ├─ [ ] 查事件索引表确认事件存在
   ├─ [ ] 查Api索引表确认API存在
   └─ [ ] 验证端别标记匹配

✅ 4. 数据流完整性（逻辑检查）
   ├─ [ ] 事件监听→处理→输出是否闭环？
   ├─ [ ] 是否缺少关键步骤？
   └─ [ ] 是否有循环依赖？
```

详见：[方案自检清单.md](./markdown/ai/方案自检清单.md)

**自检后处理**：
```
自检结果
├─ ✅ 全部通过 → 进入3.1判断是否需要专家审核
├─ ⚠️ 有警告 → 标注风险点，询问用户
└─ ❌ 有错误 → 自动修正方案 → 重新自检
```

---

**3.1 条件触发：专家审核子代理**⭐

符合以下**任一条件**时，启动MODSDK专家审核子代理：

**强制触发条件**：
- ✅ 任务级别 = 🔴 复杂任务
- ✅ 用户明确要求审核

**智能触发条件（标准任务）**：
- ✅ 2轮以上Bug修复未成功
- ✅ 实现功能设计模块跨越过多（>5个System交互）
- ✅ 自检发现严重警告（如：可能的性能问题、复杂的循环依赖）

**审核后处理**：
```
审核评分 ≥ 8分 → 方案通过，继续实施
审核评分 6-7分 → 根据建议调整方案
审核评分 < 6分 → 重新设计方案
```

---

**3.2 标准任务（5章模板）**
```bash
mkdir {{PROJECT_ROOT}}/tasks/[中文任务名]  # 必须创建tasks目录⭐
# 创建5章精简模板
# 父代理直接探索（不用Task）
# 实施→验证→文档维护→Git commit
```

**3.3 复杂任务（9章模板）**
```bash
mkdir {{PROJECT_ROOT}}/tasks/[中文任务名]  # 必须创建tasks目录
# 创建9章完整模板
# 可选并行探索（仅用户要求时）
# 分阶段实施→测试→文档更新→Git commit
```

---

## 📊 三级任务分类

| 级别 | 特征 | 执行策略 | Token成本 |
|-----|------|---------|-----------|
| 🟢 **微任务** | 单文件<30行 | 直接Edit+轻量级文档维护 | <2k |
| 🟡 **标准任务** | 3-8文件 | 父代理探索+5章模板 | 20-35k |
| 🔴 **复杂任务** | >8文件/架构 | 可选并行+9章模板 | 40-60k |

### 任务类型快速识别

| 关键词 | 任务级别 | 示例 |
|--------|---------|------|
| 配置/价格/参数 | 🟢 微任务 | "调整配置参数" |
| 文案/颜色/UI调整 | 🟢 微任务 | "修改提示文字" |
| 事件监听/组件使用 | 🟡 标准任务 | "添加玩家伤害监听" |
| 实体创建/交互逻辑 | 🟡 标准任务 | "创建自定义NPC" |
| 新功能/系统 | 🔴 复杂任务 | "添加计分板系统" |
| 重构/优化 | 🔴 复杂任务 | "性能优化" |

详见：[任务类型决策表.md](./markdown/ai/任务类型决策表.md)

---

## 📚 文档导航

### 快速参考
- **[API速查.md](./markdown/API速查.md)** - 常用API代码片段，可直接复制使用 ⭐
- **[MODSDK核心概念.md](./markdown/MODSDK核心概念.md)** - System/Component/Event/Entity核心概念速查 ⭐
- **[Claude指令参考.md](./Claude指令参考.md)** - 所有Claude指令的完整说明

### 核心文档
- **[开发规范.md](./markdown/开发规范.md)** - 防止90%错误
- **[问题排查.md](./markdown/问题排查.md)** - 已知问题解决

### AI工作流文档
- **[任务类型决策表.md](./markdown/ai/任务类型决策表.md)** - 任务分级
- **[快速通道流程.md](./markdown/ai/快速通道流程.md)** - 微任务流程
- **[上下文管理规范.md](./markdown/ai/上下文管理规范.md)** - 模板系统

### 文档维护工具（⭐ 自适应机制）

| 命令 | 功能 | 输出 |
|------|------|------|
| `/discover` | 自适应项目结构发现 | `.claude/discovered-patterns.json` |
| `/validate-docs` | 文档完整性验证 | `markdown/文档待补充清单.md` |
| `/enhance-docs` | 批量文档内容生成 | 完整文档（1500-3000字） |

**工作流程**：
```
1. /discover          → 发现项目结构
2. /validate-docs     → 验证文档覆盖率
3. /enhance-docs      → 批量生成文档内容
```

---

## 🌐 官方资源（必须查阅）⭐

### 1. 网易MODSDK开发文档
- **GitHub仓库**: https://github.com/EaseCation/netease-modsdk-wiki
- **何时查阅**：遇到不熟悉的API时、需要了解组件/系统用法时
- **查阅方式**：使用WebFetch工具

### 2. 我的世界基岩版Wiki
- **GitHub仓库**: https://github.com/Bedrock-OSS/bedrock-wiki
- **何时查阅**：涉及原版实体、物品、方块时、NBT数据结构相关问题时

### 3. 查阅方式说明

**WebFetch使用示例**：
```python
# 示例1：查询API用法
WebFetch(
    url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/mcdocs/1-ModAPI/...",
    prompt="提取NotifyToClient的参数说明和使用示例"
)

# 示例2：查询NBT结构
WebFetch(
    url="https://raw.githubusercontent.com/Bedrock-OSS/bedrock-wiki/main/docs/nbt/...",
    prompt="提取物品NBT的字段定义和示例"
)
```

**⚠️ 重要提示**：
- 优先查阅本地文档（`markdown/`目录）
- 本地文档不足时，使用WebFetch查阅官方资源
- 将查阅结果记录到核心检查点输出中

---

## 🔍 快速索引

| 问题类型 | 查阅位置 | 章节编号 |
|---------|---------|---------|
| 跨端GetSystem返回None | 问题排查.md | 问题1 |
| __init__调用API返回None | 问题排查.md | 问题2 |
| EventData序列化失败 | 问题排查.md | 问题3 |
| 事件监听不触发 | 问题排查.md | 问题4 |
| 模块导入失败 | 问题排查.md | 问题5 |
| AOI感应区不生效 | 问题排查.md | 问题9 |
| 双端隔离原则 | 开发规范.md | 第1章 |
| System生命周期 | 开发规范.md | 第2章 |
| EventData序列化 | 开发规范.md | 第2.3节 |
| Component组件规范 | 开发规范.md | 第4章 |
| Entity实体管理 | 开发规范.md | 第6章 |

---

## 📝 版本信息

> **文档版本**: v16.0 (双层文档架构)
> **最后更新**: 2025-11-11
> **项目状态**: 生产就绪 (Production Ready)

### v16.0 更新亮点 ⚡

**双层文档架构（全新升级）**：
- ✅ **上游基线层**: `.claude/core-docs/` 软连接到上游，自动同步更新
- ✅ **项目覆盖层**: `markdown/core/` 支持项目定制，互不干扰
- ✅ **智能路由**: AI自动选择项目定制版或上游基线版
- ✅ **自动迁移**: v15.x项目执行 `initmc` 自动升级到v16.0
- ✅ **完全隔离**: 多项目共用上游时，职责100%隔离

**用户体验改进**：
- 📁 下游项目文档从10+个文件减少到3-5个（-67%）
- 🔄 一键同步：`initmc --sync` 自动更新工作流
- 📝 按需定制：需要编辑核心文档时，AI自动创建覆盖层

**核心机制**：
- SymlinkManager: 跨平台软连接管理（Windows降级为只读副本）
- VersionChecker: 版本检测、哈希对比、冲突识别
- MigrationV16: v15.x自动迁移、文件分类、备份恢复

**升级指南**：
- 新项目：执行 `initmc` 即可获得v16.0架构
- v15.x项目：执行 `initmc`，系统自动迁移（会备份到 `.backup-v15/`）
- 详见：[迁移指南-v16.0.md](./markdown/迁移指南-v16.0.md)

---

**记住**:
1. 微任务优先，能直接Edit就不创建tasks
2. 默认顺序执行，除非用户要求并行
3. 遵循CRITICAL规范避免90%错误
4. 本地文档不足时，使用WebFetch查阅官方资源
