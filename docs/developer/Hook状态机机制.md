# HookçŠ¶æ€æœºæœºåˆ¶å®Œæ•´æŠ€æœ¯æ–‡æ¡£ (v22.0)

> **NeteaseMod-Claude å·¥ä½œæµæ ¸å¿ƒå¼•æ“**
>
> æœ¬æ–‡æ¡£æè¿°åŸºäºClaude Code Hooksçš„å››å±‚éªŒè¯é›¶å®¹å¿æ¶æ„ä¸PreToolUseé©±åŠ¨å¼ºåˆ¶å·¥ä½œæµ

---

## æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ |
|------|------|----------|
| **v22.0.0** | 2025-11-15 | **PreToolUseé©±åŠ¨å¼ºåˆ¶å·¥ä½œæµ**: Step2æ”¹ä¸ºå¼ºåˆ¶ç ”ç©¶é˜¶æ®µï¼Œæ–‡æ¡£æ·±åº¦æ£€æŸ¥ï¼ŒPreToolUseæ‹¦æˆªWrite/Editï¼Œåˆ é™¤AIè‡ªä¸»å†³ç­– |
| v21.0.0 | 2025-11-15 | æ¶æ„é‡æ„ - å•ä¸€æ•°æ®æº: åˆ é™¤workflow-state.jsonï¼Œä½¿ç”¨TaskMetaManageræ›¿ä»£StateManagerï¼Œtask-meta.jsonä¸ºå”¯ä¸€æ•°æ®æº |
| v20.3.0 | 2025-11-15 | æ¶æ„é‡æ„ - å››å±‚éªŒè¯é›¶å®¹å¿ + Step2é‡æ–°å¼•å…¥ + æ¨¡å—åŒ–æ ¸å¿ƒ |
| v20.2.17 | 2025-11-14 | æ—§æ¶æ„æœ€åç‰ˆæœ¬ï¼ˆå·²å½’æ¡£ï¼‰ |

---

## ç›®å½•

1. [æ¶æ„æ¼”è¿›](#æ¶æ„æ¼”è¿›)
2. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)
3. [å››å±‚éªŒè¯æ¶æ„](#å››å±‚éªŒè¯æ¶æ„)
4. [äº”é˜¶æ®µå·¥ä½œæµ](#äº”é˜¶æ®µå·¥ä½œæµ)
5. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
6. [ç»Ÿä¸€Hookæœºåˆ¶](#ç»Ÿä¸€hookæœºåˆ¶)
7. [çŠ¶æ€æ•°æ®ç®¡ç†](#çŠ¶æ€æ•°æ®ç®¡ç†)
8. [ä¸“å®¶è§¦å‘ç³»ç»Ÿ](#ä¸“å®¶è§¦å‘ç³»ç»Ÿ)
9. [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
10. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

---

## æ¶æ„æ¼”è¿›

### å†å²ç‰ˆæœ¬å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           v20.2.17ï¼ˆå·²åºŸå¼ƒï¼‰                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - å•ä¸€Hookæ–‡ä»¶å¤„ç†æ‰€æœ‰é€»è¾‘                                 â”‚
â”‚  - ä¸‰æ­¥å·¥ä½œæµï¼ˆæ— Step2ï¼‰                                   â”‚
â”‚  - ç®€å•å·¥å…·ç™½åå•éªŒè¯                                       â”‚
â”‚  - workflow-state.jsonï¼ˆä¸»æ•°æ®æºï¼‰                         â”‚
â”‚  - StateManager ä¸‰æ–‡ä»¶åŒæ­¥                                 â”‚
â”‚                                                          â”‚
â”‚  âŒ é—®é¢˜ï¼šéªŒè¯é€»è¾‘æ··ä¹±ï¼ŒçŠ¶æ€ç®¡ç†å¤æ‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â†“ é‡æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           v20.3.0ï¼ˆè¿‡æ¸¡ç‰ˆæœ¬ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - æ¨¡å—åŒ–æ ¸å¿ƒï¼ˆcore/ï¼‰                                     â”‚
â”‚  - å››å±‚éªŒè¯æ¶æ„                                            â”‚
â”‚  - äº”é˜¶æ®µå·¥ä½œæµï¼ˆStep2é‡æ–°å¼•å…¥ï¼‰                            â”‚
â”‚  - workflow-state.jsonï¼ˆä¸»æ•°æ®æºï¼‰                         â”‚
â”‚  - StateManager ä¸‰æ–‡ä»¶åŒæ­¥                                 â”‚
â”‚                                                          â”‚
â”‚  âœ… æ”¹è¿›ï¼šéªŒè¯æ¶æ„æ¸…æ™°                                      â”‚
â”‚  âŒ é—®é¢˜ï¼šæ•°æ®ä¸ä¸€è‡´é£é™©ï¼ˆworkflow-state vs task-metaï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â†“ æ¶æ„ç®€åŒ–

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           v21.0.0ï¼ˆè¿‡æ¸¡ç‰ˆæœ¬ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - æ¨¡å—åŒ–æ ¸å¿ƒï¼ˆcore/ï¼‰                                     â”‚
â”‚  - å››å±‚éªŒè¯æ¶æ„ï¼ˆä¿ç•™ï¼‰                                     â”‚
â”‚  - äº”é˜¶æ®µå·¥ä½œæµï¼ˆä¿ç•™ï¼‰                                     â”‚
â”‚  - task-meta.jsonï¼ˆå”¯ä¸€æ•°æ®æºï¼‰âœ¨                          â”‚
â”‚  - TaskMetaManager æ–‡ä»¶é”+åŸå­å†™å…¥                         â”‚
â”‚                                                          â”‚
â”‚  âœ… æ”¹è¿›ï¼šå•ä¸€æ•°æ®æºï¼Œæ— æ•°æ®ä¸ä¸€è‡´                           â”‚
â”‚  âŒ é—®é¢˜ï¼šAIå¿½ç•¥PostToolUseæç¤ºï¼Œè·³è¿‡æ–‡æ¡£æŸ¥é˜…ç›´æ¥ä¿®æ”¹ä»£ç      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â†“ PreToolUseå¼ºåˆ¶é©±åŠ¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           v22.0.0ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - PreToolUseé©±åŠ¨æ¶æ„ï¼ˆæ‹¦æˆª > æç¤ºï¼‰                        â”‚
â”‚  - Step2æ”¹ä¸ºå¼ºåˆ¶ç ”ç©¶é˜¶æ®µï¼ˆstep2_researchï¼‰                  â”‚
â”‚  - æ–‡æ¡£æ·±åº¦æ£€æŸ¥ï¼ˆæ ‡å‡†â‰¥3ï¼Œç©æ³•åŒ…â‰¥2ï¼‰                         â”‚
â”‚  - PreToolUseè¯­ä¹‰æ‹¦æˆªï¼ˆStep2ç¦Write/Editï¼‰                 â”‚
â”‚  - åˆ é™¤AIè‡ªä¸»å†³ç­–ï¼ˆmc.mdå¼ºåˆ¶æµç¨‹ï¼‰                          â”‚
â”‚                                                          â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šPreToolUseå¼ºåˆ¶æ‹¦æˆªï¼ŒAIæ— æ³•è·³è¿‡ç ”ç©¶é˜¶æ®µ             â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šæ–‡æ¡£æ·±åº¦æ£€æŸ¥ç¡®ä¿å……åˆ†ç ”ç©¶                           â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šå½»åº•è§£å†³AIè·³è¿‡æ–‡æ¡£æŸ¥é˜…çš„é—®é¢˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### v21.0 æ ¸å¿ƒå˜æ›´

**æ¶æ„å˜æ›´**:

| å˜æ›´ç‚¹ | v20.3.0 | v21.0.0 |
|--------|---------|---------|
| ä¸»æ•°æ®æº | workflow-state.json | task-meta.json |
| çŠ¶æ€ç®¡ç†å™¨ | StateManager | TaskMetaManager |
| æ–‡ä»¶åŒæ­¥ | ä¸‰æ–‡ä»¶åŒæ­¥ | äºŒæ–‡ä»¶ï¼ˆtask-meta.json + task-active.jsonï¼‰ |
| å¹¶å‘å®‰å…¨ | æ— é”æœºåˆ¶ | portalockeræ–‡ä»¶é” |
| åŸå­æ›´æ–° | ç›´æ¥å†™å…¥ | atomic_update()é—­åŒ…æ¨¡å¼ |
| é‡è¯•æœºåˆ¶ | æ—  | 3æ¬¡é‡è¯•ï¼Œ100msé—´éš” |

**åˆ é™¤çš„æ–‡ä»¶**:
- `.claude/workflow-state.json` - å·²åˆ é™¤ï¼Œä½¿ç”¨task-meta.jsonæ›¿ä»£
- `core/state_manager.py` - å·²åˆ é™¤ï¼Œä½¿ç”¨TaskMetaManageræ›¿ä»£

**æ–°å¢å­—æ®µ**:
- `architecture_version: "21.0"` - ç‰ˆæœ¬æ ‡è®°ï¼Œç”¨äºè¿ç§»æ£€æµ‹

**è¿ç§»è·¯å¾„**:
- è‡ªåŠ¨è¿ç§»ï¼šè¿è¡Œ`/initmc`æˆ–`npm run mc:deploy`æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶è¿ç§»v20.xä»»åŠ¡
- è¿ç§»è„šæœ¬ï¼š`lib/migration-v21.js`

### v22.0 æ ¸å¿ƒå˜æ›´ï¼ˆPreToolUseé©±åŠ¨å¼ºåˆ¶å·¥ä½œæµï¼‰

**è®¾è®¡åŸåˆ™å˜æ›´**:

| å˜æ›´ç‚¹ | v21.0.0 | v22.0.0 |
|--------|---------|---------|
| é©±åŠ¨æ–¹å¼ | PostToolUseè¢«åŠ¨æç¤º | PreToolUseä¸»åŠ¨æ‹¦æˆª |
| Step2å®šä¹‰ | step2_routeï¼ˆä»»åŠ¡æµè·¯ç”±ï¼‰ | step2_researchï¼ˆå¼ºåˆ¶ç ”ç©¶é˜¶æ®µï¼‰ |
| æ–‡æ¡£è¦æ±‚ | AIè‡ªä¸»å†³å®š | å¼ºåˆ¶â‰¥3ä¸ªï¼ˆç©æ³•åŒ…â‰¥2ä¸ªï¼‰ |
| åˆå§‹åŒ–é˜¶æ®µ | step3_execute | step2_research |
| AIè‡ªä¸»æ€§ | mc.mdè¯´"å¼ºçƒˆå»ºè®®" | mc.mdè¯´"æ— æ³•è·³è¿‡" |
| è¿è§„å¤„ç† | PostToolUseäº‹åæç¤º | PreToolUseäº‹å‰é˜»æ–­ |

**æ ¸å¿ƒæœºåˆ¶**:

1. **Step2å¼ºåˆ¶ç ”ç©¶é˜¶æ®µ** (`core/tool_matrix.py:92-188`)
   - ç¦æ­¢æ‰€æœ‰Write/Edit/Bashæ“ä½œ
   - è¦æ±‚è‡³å°‘æŸ¥é˜…3ä¸ªæ–‡æ¡£ï¼ˆç©æ³•åŒ…æ¨¡å¼é™ä¸º2ä¸ªï¼‰
   - AIå¿…é¡»æ˜ç¡®è¯´æ˜"ç ”ç©¶å®Œæˆ"æˆ–"å·²ç†è§£é—®é¢˜æ ¹å› "
   - Hookæ£€æµ‹ç¡®è®¤å…³é”®è¯åè‡ªåŠ¨æ¨è¿›åˆ°Step3

2. **PreToolUseè¯­ä¹‰æ‹¦æˆª** (`core/stage_validator.py:241-327`)
   - **Step2æ‹¦æˆª**ï¼šé˜»æ–­ä»»ä½•Write/Editå°è¯•ï¼Œæ˜¾ç¤ºç ”ç©¶è¿›åº¦ï¼ˆX/3æ–‡æ¡£ï¼‰
   - **Step3æ£€æŸ¥**ï¼šéªŒè¯docs_count >= required_docsåæ‰å…è®¸ä¿®æ”¹
   - æ‹¦æˆªæ—¶è¿”å›è¯¦ç»†å¼•å¯¼æ¶ˆæ¯ï¼Œè¯´æ˜å½“å‰è¿›åº¦å’Œä¸‹ä¸€æ­¥æ“ä½œ

3. **ä»»åŠ¡åˆå§‹åŒ–è°ƒæ•´** (`orchestrator/user_prompt_handler.py:982-1015`)
   - æ‰€æœ‰ä»»åŠ¡ç»Ÿä¸€åˆå§‹åŒ–ä¸ºstep2_research
   - åŠ¨æ€è®¾ç½®required_doc_countï¼ˆç©æ³•åŒ…2ï¼Œæ ‡å‡†3ï¼‰
   - ç©æ³•åŒ…æ¨¡å¼ä¹Ÿéœ€è¦éªŒè¯æ€§æŸ¥é˜…ï¼ˆé˜²æ­¢ç›²ç›®å¤åˆ¶ï¼‰

4. **mc.mdå·¥ä½œæµé‡æ„** (`.claude/commands/mc.md.template`)
   - åˆ é™¤æ‰€æœ‰"å¼ºçƒˆå»ºè®®ï¼Œä¸å¼ºåˆ¶"è¡¨è¿°
   - æ·»åŠ "å·¥ä½œæµå®Œå…¨ç”±Hooké©±åŠ¨"è¯´æ˜
   - æ·»åŠ PreToolUseæ‹¦æˆªç¤ºä¾‹ï¼ˆStep2/Step3ï¼‰
   - åˆ é™¤AIè‡ªä¸»å†³ç­–æµç¨‹æè¿°

**å…³é”®æ”¹è¿›**:

- âœ… **å½»åº•è§£å†³AIè·³è¿‡æ–‡æ¡£é—®é¢˜**ï¼šPreToolUseæ‹¦æˆªï¼ŒAIæ— æ³•ç»•è¿‡
- âœ… **ç¡®ä¿ç ”ç©¶æ·±åº¦**ï¼šæ–‡æ¡£æ•°é‡å¼ºåˆ¶è¦æ±‚ï¼Œä¸è¾¾æ ‡ç¦æ­¢ä¿®æ”¹
- âœ… **é™ä½CRITICALè¿è§„ç‡**ï¼šå……åˆ†ç ”ç©¶åä¿®æ”¹ï¼Œé¿å…ç›²ç›®æ“ä½œ
- âœ… **å‡å°‘è¿”å·¥è¿­ä»£**ï¼šåŸºäºå……åˆ†ç†è§£çš„ä¿®æ”¹ï¼ŒæˆåŠŸç‡æ›´é«˜

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. é›¶å®¹å¿æ‰§è¡Œï¼ˆZero-Tolerance Enforcementï¼‰

**åŸåˆ™**: è¿è§„æ“ä½œå¿…é¡»è¢«PreToolUseæ‹¦æˆªï¼Œä¸å…è®¸"äº‹åè¡¥æ•‘"ã€‚

**å®ç°**:
- PreToolUseå¼ºåˆ¶å™¨æ‰§è¡Œå››å±‚éªŒè¯ï¼Œæ‹¦æˆªæ‰€æœ‰ä¸åˆè§„å·¥å…·è°ƒç”¨
- PostToolUseæ›´æ–°å™¨ä¸ºçº¯ç²¹çš„çŠ¶æ€æ›´æ–°å™¨ï¼Œé›¶å†³ç­–é€»è¾‘
- ä»»ä½•éªŒè¯é€»è¾‘éƒ½åœ¨PreToolUseå®Œæˆ

### 2. å››å±‚éªŒè¯æ¶æ„ï¼ˆFour-Layer Validationï¼‰

**Layer 1 - å·¥å…·ç±»å‹éªŒè¯**: æ£€æŸ¥å·¥å…·æ˜¯å¦åœ¨å½“å‰é˜¶æ®µçš„ç™½åå•ä¸­
**Layer 2 - å‰ç½®æ¡ä»¶éªŒè¯**: æ£€æŸ¥é˜¶æ®µä¾èµ–æ˜¯å¦æ»¡è¶³
**Layer 3 - æ–‡ä»¶è·¯å¾„éªŒè¯**: ç™½åå•/é»‘åå•æ¨¡å¼åŒ¹é…
**Layer 4 - æ“ä½œè¯­ä¹‰åˆ†æ**: åˆ†æå·¥å…·è°ƒç”¨çš„çœŸå®æ„å›¾

### 3. å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰

**æ¨¡å—åŒ–æ ¸å¿ƒ**:
- `core/tool_matrix.py` - é…ç½®ä¸­å¿ƒï¼ˆå·¥å…·çŸ©é˜µã€é˜¶æ®µè§„åˆ™ï¼‰
- `core/stage_validator.py` - å››å±‚éªŒè¯å¼•æ“
- `core/task_meta_manager.py` - çŠ¶æ€ç®¡ç†å™¨ï¼ˆv21.0æ–°å¢ï¼‰
- `core/expert_trigger.py` - ä¸“å®¶è§¦å‘å™¨

**HookèŒè´£åˆ†ç¦»**:
- `orchestrator/pretooluse_enforcer.py` - æ‰§è¡Œå››å±‚éªŒè¯ï¼Œæ‹¦æˆªè¿è§„æ“ä½œ
- `orchestrator/posttooluse_updater.py` - çº¯ç²¹çŠ¶æ€æ›´æ–°å™¨
- `orchestrator/user_prompt_handler.py` - ä»»åŠ¡åˆå§‹åŒ–/æ¢å¤
- `lifecycle/session_start.py` - ä¼šè¯å¯åŠ¨æ¢å¤
- `lifecycle/stop.py` - ä¼šè¯ç»“æŸæ£€æŸ¥

---

## å››å±‚éªŒè¯æ¶æ„

### éªŒè¯æµç¨‹å›¾

```
PreToolUse Hookè§¦å‘
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TaskMetaManager åŠ è½½çŠ¶æ€                       â”‚
â”‚  task_id = mgr.get_active_task_id()                     â”‚
â”‚  task_meta = mgr.load_task_meta(task_id)                â”‚
â”‚  current_step = task_meta.get('current_step')           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Layer 1: å·¥å…·ç±»å‹éªŒè¯                          â”‚
â”‚  æ£€æŸ¥: tool_name in allowed_tools[current_step]?        â”‚
â”‚  âŒ DENY â†’ è¿”å›æ‹¦æˆªæ¶ˆæ¯                                  â”‚
â”‚  âœ… PASS â†’ è¿›å…¥Layer 2                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Layer 2: å‰ç½®æ¡ä»¶éªŒè¯                          â”‚
â”‚  æ£€æŸ¥: step0_context.status == "completed"?             â”‚
â”‚  âŒ DENY â†’ è¿”å›æ‹¦æˆªæ¶ˆæ¯                                  â”‚
â”‚  âœ… PASS â†’ è¿›å…¥Layer 3                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Layer 3: æ–‡ä»¶è·¯å¾„éªŒè¯                          â”‚
â”‚  æ£€æŸ¥: ç™½åå•/é»‘åå•æ¨¡å¼åŒ¹é…                              â”‚
â”‚  âŒ DENY â†’ è¿”å›æ‹¦æˆªæ¶ˆæ¯                                  â”‚
â”‚  âœ… PASS â†’ è¿›å…¥Layer 4                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Layer 4: æ“ä½œè¯­ä¹‰åˆ†æ                          â”‚
â”‚  æ£€æŸ¥: çœŸå®æ„å›¾ï¼ˆä»£ç  vs æ–‡æ¡£ã€å±é™©å‘½ä»¤ï¼‰                 â”‚
â”‚  âŒ DENY â†’ è¿”å›æ‹¦æˆªæ¶ˆæ¯                                  â”‚
â”‚  âœ… PASS â†’ å…è®¸æ‰§è¡Œ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
    âœ… ALLOW
```

### Layer 1: å·¥å…·ç±»å‹éªŒè¯

**èŒè´£**: æœ€åŸºç¡€çš„å·¥å…·ç™½åå•éªŒè¯ã€‚

**æ ¸å¿ƒæ¨¡å—**: `core/tool_matrix.py:STAGE_TOOL_MATRIX`

**éªŒè¯è§„åˆ™**:

```python
STAGE_TOOL_MATRIX = {
    "step0_context": {
        "allowed_tools": ["Read"]
    },
    "step1_understand": {
        "allowed_tools": ["Read"]
    },
    "step2_research": {
        "allowed_tools": ["Read", "Grep", "Glob"]
    },
    "step3_execute": {
        "allowed_tools": ["Read", "Write", "Edit", "Bash", "Grep", "Glob", "WebFetch", "WebSearch"]
    },
    "step4_cleanup": {
        "allowed_tools": ["Task", "Read"]  # çˆ¶ä»£ç†åªèƒ½å¯åŠ¨å­ä»£ç†
    }
}
```

**å®æˆ˜æ¡ˆä¾‹**:

```
åœºæ™¯: AIåœ¨Step1é˜¶æ®µå°è¯•ä¿®æ”¹ä»£ç 
å·¥å…·: Edit("player.py", old_str="...", new_str="...")
ç»“æœ: âŒ DENY

æ‹¦æˆªæ¶ˆæ¯:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« å·¥å…·è°ƒç”¨è¢«æ‹’ç»: Edit
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ å½“å‰é˜¶æ®µ: step1_understand
âŒ æ‹’ç»åŸå› : Editå·¥å…·åœ¨å½“å‰é˜¶æ®µä¸å¯ç”¨

âœ… å½“å‰é˜¶æ®µå…è®¸çš„å·¥å…·: Read

âš ï¸ å·¥ä½œæµå¼ºåˆ¶æ‰§è¡Œ - è¿è§„æ“ä½œå·²è¢«é˜»æ­¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Layer 2: å‰ç½®æ¡ä»¶éªŒè¯

**èŒè´£**: æ£€æŸ¥é˜¶æ®µä¾èµ–æ˜¯å¦æ»¡è¶³ï¼ˆå¦‚Step0æ˜¯å¦å®Œæˆï¼‰ã€‚

**æ ¸å¿ƒæ¨¡å—**: `core/tool_matrix.py:preconditions`

**éªŒè¯è§„åˆ™**:

```python
"step1_understand": {
    "preconditions": [
        {
            "step": "step0_context",
            "field": "status",
            "value": "completed"
        }
    ]
}
```

**å®æˆ˜æ¡ˆä¾‹**:

```
åœºæ™¯: Step0æœªå®Œæˆæ—¶å°è¯•è¿›å…¥Step1
å·¥å…·: Read("docs/API.md")
ç»“æœ: âŒ DENY

æ‹¦æˆªæ¶ˆæ¯:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« å‰ç½®æ¡ä»¶æœªæ»¡è¶³
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ å¿…é¡»å…ˆå®Œæˆ: step0_context
âŒ å½“å‰çŠ¶æ€: pending

âœ… æ­£ç¡®æµç¨‹: å…ˆé˜…è¯»CLAUDE.mdäº†è§£é¡¹ç›®ä¸Šä¸‹æ–‡

âš ï¸ å·¥ä½œæµå¼ºåˆ¶æ‰§è¡Œ - è¿è§„æ“ä½œå·²è¢«é˜»æ­¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Layer 3: æ–‡ä»¶è·¯å¾„éªŒè¯

**èŒè´£**: ç™½åå•/é»‘åå•æ¨¡å¼åŒ¹é…ï¼Œé˜²æ­¢è¯¯æ“ä½œå…³é”®æ–‡ä»¶ã€‚

**æ ¸å¿ƒæ¨¡å—**: `core/path_validator.py`

**éªŒè¯è§„åˆ™ç¤ºä¾‹**:

```python
"step1_understand": {
    "path_rules": {
        "Read": {
            "whitelist_patterns": [
                "docs/**/*.md",
                "markdown/**/*.md",
                "*.md"
            ],
            "blacklist_patterns": [
                "behavior_packs/**/*",
                "*.py",
                "*.js"
            ]
        }
    }
}
```

**å®æˆ˜æ¡ˆä¾‹**:

```
åœºæ™¯: AIåœ¨Step1é˜¶æ®µå°è¯•Readä»£ç æ–‡ä»¶
å·¥å…·: Read("behavior_packs/main.py")
ç»“æœ: âŒ DENY

æ‹¦æˆªæ¶ˆæ¯:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš« å·¥å…·è°ƒç”¨è¢«æ‹’ç»: Read
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ å½“å‰é˜¶æ®µ: step1_understand
âŒ æ‹’ç»åŸå› : æ–‡ä»¶è·¯å¾„åœ¨é»‘åå•ä¸­: behavior_packs/main.py

âœ… æ­£ç¡®åšæ³•:
åªèƒ½é˜…è¯»æ–‡æ¡£æ–‡ä»¶ï¼ˆdocs/**/*.md, markdown/**/*.mdï¼‰ï¼Œ
ç¦æ­¢é˜…è¯»ä»£ç æ–‡ä»¶ï¼ˆ*.py, *.jsï¼‰

âš ï¸ å·¥ä½œæµå¼ºåˆ¶æ‰§è¡Œ - è¿è§„æ“ä½œå·²è¢«é˜»æ­¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Layer 4: æ“ä½œè¯­ä¹‰åˆ†æ

**èŒè´£**: åˆ†æå·¥å…·è°ƒç”¨çš„çœŸå®æ„å›¾ï¼Œé˜²æ­¢è¾¹ç•Œæ¨¡ç³Šæ“ä½œã€‚

**æ ¸å¿ƒæ¨¡å—**: `core/semantic_analyzer.py`

**å…¸å‹åœºæ™¯**:

1. **åŒºåˆ†Writeä»£ç  vs Writeæ–‡æ¡£**
2. **æ£€æµ‹å±é™©Bashå‘½ä»¤**
3. **éªŒè¯å­ä»£ç†å¿…éœ€æ“ä½œ**

**å®æˆ˜æ¡ˆä¾‹**:

```
åœºæ™¯1: Step2é˜¶æ®µå°è¯•ä¿®æ”¹ä»£ç ï¼ˆç ”ç©¶é˜¶æ®µï¼‰
å·¥å…·: Edit("behavior_packs/player.py", ...)
ç»“æœ: âŒ DENY
åŸå› : è¯­ä¹‰åˆ†ææ£€æµ‹åˆ°ä¿®æ”¹ä»£ç æ–‡ä»¶ï¼Œç ”ç©¶é˜¶æ®µç¦æ­¢

åœºæ™¯2: Step3é˜¶æ®µæ‰§è¡Œå±é™©å‘½ä»¤
å·¥å…·: Bash("rm -rf /")
ç»“æœ: âŒ DENY
åŸå› : è¯­ä¹‰åˆ†ææ£€æµ‹åˆ°å±é™©å‘½ä»¤

åœºæ™¯3: Step3é˜¶æ®µæ‰§è¡Œæµ‹è¯•å‘½ä»¤
å·¥å…·: Bash("pytest tests/")
ç»“æœ: âœ… ALLOW
åŸå› : å®‰å…¨çš„æµ‹è¯•å‘½ä»¤
```

---

## äº”é˜¶æ®µå·¥ä½œæµ

### é˜¶æ®µæ¦‚è§ˆ

v20.3.0é‡æ–°å¼•å…¥Step2ï¼Œv22.0æ”¹ä¸ºå¼ºåˆ¶ç ”ç©¶é˜¶æ®µï¼š

| é˜¶æ®µ | åç§° | å…è®¸å·¥å…· | å®Œæˆæ¡ä»¶ | è‡ªåŠ¨æ¨è¿› | v22.0å˜æ›´ |
|------|------|----------|----------|----------|----------|
| **Step0** | ç†è§£é¡¹ç›®ä¸Šä¸‹æ–‡ | Read | è¯»å–CLAUDE.md | âœ… æ˜¯ | - |
| **Step1** | ç†è§£ä»»åŠ¡éœ€æ±‚ | Read | è‡³å°‘è¯»1ä¸ªæ–‡æ¡£ | âœ… æ˜¯ | - |
| **Step2** | **ä»»åŠ¡ç ”ç©¶é˜¶æ®µï¼ˆå¼ºåˆ¶ï¼‰** | Read, Grep, Glob | **æŸ¥é˜…â‰¥3ä¸ªæ–‡æ¡£** + AIç¡®è®¤ç ”ç©¶å®Œæˆ | âœ… æ˜¯ | **âœ¨ ä»ä»»åŠ¡æµè·¯ç”±æ”¹ä¸ºå¼ºåˆ¶ç ”ç©¶ï¼Œç¦æ­¢Write/Edit/Bash** |
| **Step3** | æ‰§è¡Œå®æ–½ | Read, Write, Edit, Bash, Grep, Glob, WebFetch, WebSearch | ç”¨æˆ·ç¡®è®¤å®Œæˆ | âŒ å¦ | **âœ¨ PreToolUseæ£€æŸ¥æ–‡æ¡£æ·±åº¦** |
| **Step4** | æ”¶å°¾å½’æ¡£ | Task, Read | å­ä»£ç†æ ‡è®°å®Œæˆ | âŒ å¦ | - |

**å·¥ä½œæµæ—¶åºå›¾**:

```
[/mc å‘½ä»¤] â†’ Step0(è·³è¿‡) â†’ Step1(è·³è¿‡) â†’ Step2(å¼ºåˆ¶ç ”ç©¶) â†’ Step3 â†’ Step4 â†’ [å½’æ¡£]
   åˆå§‹åŒ–                                   æŸ¥é˜…â‰¥3æ–‡æ¡£        ç”¨æˆ·ç¡®è®¤  å­ä»£ç†
                                           PreToolUseæ‹¦æˆª
```

### Step0: ç†è§£é¡¹ç›®ä¸Šä¸‹æ–‡

**ç›®æ ‡**: è®©AIäº†è§£é¡¹ç›®ç»“æ„ã€å·¥ä½œæµè§„èŒƒã€æŠ€æœ¯æ ˆã€‚

**é…ç½®ä½ç½®**: `core/tool_matrix.py:12-42`

**å…³é”®çº¦æŸ**:
- âœ… åªèƒ½Read CLAUDE.mdå’ŒREADME.md
- âŒ ç¦æ­¢Readå…¶ä»–æ–‡ä»¶
- âœ… è‡ªåŠ¨æ¨è¿›åˆ°Step1ï¼ˆæ£€æµ‹åˆ°CLAUDE.mdè¢«è¯»å–ï¼‰

### Step1: ç†è§£ä»»åŠ¡éœ€æ±‚

**ç›®æ ‡**: é˜…è¯»ç”¨æˆ·æä¾›çš„éœ€æ±‚æ–‡æ¡£ã€é—®é¢˜æè¿°ã€ç›¸å…³èµ„æ–™ã€‚

**é…ç½®ä½ç½®**: `core/tool_matrix.py:44-89`

**å…³é”®çº¦æŸ**:
- âœ… åªèƒ½Readæ–‡æ¡£æ–‡ä»¶ï¼ˆ*.mdï¼‰
- âŒ ç¦æ­¢Readä»£ç æ–‡ä»¶ï¼ˆ*.py, *.jsï¼‰
- âŒ ç¦æ­¢ä½¿ç”¨Write/Edit/Bash
- âœ… è‡ªåŠ¨æ¨è¿›åˆ°Step2ï¼ˆè‡³å°‘è¯»å–1ä¸ªæ–‡æ¡£ï¼‰

### Step2: ä»»åŠ¡ç ”ç©¶é˜¶æ®µï¼ˆå¼ºåˆ¶ï¼‰

**ç›®æ ‡**: æ·±åº¦ç ”ç©¶é—®é¢˜æ ¹å› å’ŒæŠ€æœ¯çº¦æŸï¼Œç¦æ­¢ä»»ä½•ä¿®æ”¹æ“ä½œã€‚

**é…ç½®ä½ç½®**: `core/tool_matrix.py:92-188`

**v22.0æ ¸å¿ƒè®¾è®¡åŸåˆ™**:
- ğŸš« **PreToolUseå¼ºåˆ¶æ‹¦æˆª**ï¼šä»»ä½•Write/Edit/Bashå°è¯•éƒ½è¢«ç«‹å³é˜»æ–­
- ğŸ“š **æ–‡æ¡£æ·±åº¦è¦æ±‚**ï¼šæ ‡å‡†æ¨¡å¼â‰¥3ä¸ªæ–‡æ¡£ï¼Œç©æ³•åŒ…æ¨¡å¼â‰¥2ä¸ªæ–‡æ¡£
- ğŸ” **æ˜ç¡®ç¡®è®¤æœºåˆ¶**ï¼šAIå¿…é¡»è¯´æ˜"ç ”ç©¶å®Œæˆ"æˆ–"å·²ç†è§£é—®é¢˜æ ¹å› "
- âœ¨ **è‡ªåŠ¨æ¨è¿›**ï¼šHookæ£€æµ‹ç¡®è®¤å…³é”®è¯åæ¨è¿›åˆ°Step3

**å¼ºåˆ¶çº¦æŸ**:
- âœ… å¯ä»¥Readä»£ç å’Œæ–‡æ¡£ï¼ˆæ·±åº¦ç ”ç©¶ï¼‰
- âœ… å¯ä»¥Grepæœç´¢ã€GlobæŸ¥æ‰¾æ–‡ä»¶ï¼ˆäº†è§£ç°æœ‰å®ç°ï¼‰
- âŒ **ç¦æ­¢Write/Edit**ä¿®æ”¹ä»»ä½•æ–‡ä»¶ï¼ˆPreToolUseæ‹¦æˆªï¼‰
- âŒ **ç¦æ­¢Bash**æ‰§è¡Œå‘½ä»¤ï¼ˆPreToolUseæ‹¦æˆªï¼‰
- âŒ **ç¦æ­¢è·³è¿‡**ç ”ç©¶é˜¶æ®µï¼ˆæ–‡æ¡£æ•°ä¸è¶³åˆ™æ— æ³•æ¨è¿›åˆ°Step3ï¼‰

**PreToolUseæ‹¦æˆªç¤ºä¾‹**:

```
åœºæ™¯: AIåœ¨Step2å°è¯•ä¿®æ”¹ä»£ç 
å·¥å…·: Edit("player.py", ...)
ç»“æœ: âŒ DENY

æ‹¦æˆªæ¶ˆæ¯:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ å½“å‰é˜¶æ®µ: ä»»åŠ¡ç ”ç©¶ï¼ˆStep2 - å¼ºåˆ¶ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä½ ç°åœ¨å¤„äºå¼ºåˆ¶ç ”ç©¶é˜¶æ®µï¼Œéœ€è¦å…ˆå®Œæˆæ–‡æ¡£æŸ¥é˜…ã€‚

ğŸ“Š è¿›åº¦: å·²æŸ¥é˜… 1/3 ä¸ªæ–‡æ¡£

ä¸‹ä¸€æ­¥æ“ä½œ:
1. ç»§ç»­ä½¿ç”¨ Read/Grep/Glob æŸ¥é˜…ç›¸å…³æ–‡æ¡£
2. è‡³å°‘æŸ¥é˜… 3 ä¸ªæ–‡æ¡£å
3. æ˜ç¡®è¯´æ˜ä½ çš„ç ”ç©¶ç»“è®ºï¼ˆåŒ…å«å…³é”®è¯ï¼š"ç ”ç©¶å®Œæˆ"æˆ–"å·²ç†è§£é—®é¢˜æ ¹å› "ï¼‰
4. Hookä¼šè‡ªåŠ¨æ¨è¿›åˆ°step3æ‰§è¡Œé˜¶æ®µï¼Œå±Šæ—¶å¯ä»¥ä½¿ç”¨Write/Editä¿®æ”¹ä»£ç 

**å½“å‰ç¦æ­¢æ“ä½œ**:
- âŒ Write/Editä»»ä½•æ–‡ä»¶
- âŒ Bashæ‰§è¡Œå‘½ä»¤

**å½“å‰å…è®¸æ“ä½œ**:
- âœ… Read é˜…è¯»æ–‡æ¡£å’Œä»£ç 
- âœ… Grep æœç´¢ç›¸å…³å®ç°
- âœ… Glob æŸ¥æ‰¾æ–‡ä»¶

è¯·éµå®ˆå·¥ä½œæµè§„èŒƒï¼Œå®Œæˆç ”ç©¶åå†è¿›è¡Œä¿®æ”¹ã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**AIç¡®è®¤æ ¼å¼**:

```markdown
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ç ”ç©¶å®Œæˆ - è¿›å…¥å®æ–½é˜¶æ®µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. ğŸ“š å·²æŸ¥é˜…æ–‡æ¡£ï¼ˆâ‰¥3ä¸ªï¼‰:
   - å¼€å‘è§„èŒƒ.md:164-210 - CRITICALè§„èŒƒ
   - MODSDKæ ¸å¿ƒæ¦‚å¿µ.md:50-80 - Partè®¾è®¡æ¨¡å¼
   - markdown/systems/CombatSystem.md - æˆ˜æ–—ç³»ç»Ÿæ¶æ„

2. ğŸ”‘ æå–çš„å…³é”®åŸåˆ™:
   â›” ç¦æ­¢: åœ¨Part.__init__()ä¸­è°ƒç”¨MODSDK API
   âœ… åº”è¯¥: åœ¨Create()æ–¹æ³•ä¸­åˆå§‹åŒ–Component
   ğŸ“š åŸå› : ç½‘æ˜“å¼•æ“ç”Ÿå‘½å‘¨æœŸé™åˆ¶

3. ğŸ“‹ å®æ–½æ–¹æ¡ˆ:
   [ç®€è¦è¯´æ˜ä¿®æ”¹è®¡åˆ’]

Hookæ£€æµ‹åˆ°"ç ”ç©¶å®Œæˆ"å…³é”®è¯ï¼Œå°†è‡ªåŠ¨æ¨è¿›åˆ°step3æ‰§è¡Œé˜¶æ®µã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**ç¡®è®¤å…³é”®è¯**ï¼ˆè§¦å‘è‡ªåŠ¨æ¨è¿›ï¼‰:
- "ç ”ç©¶å®Œæˆ"
- "å·²ç†è§£é—®é¢˜æ ¹å› "
- "å¼€å§‹å®æ–½"
- "å‡†å¤‡ä¿®æ”¹"
- "å¯ä»¥å¼€å§‹ç¼–ç "

### Step3: æ‰§è¡Œå®æ–½

**ç›®æ ‡**: ä»£ç ä¿®æ”¹ã€æµ‹è¯•ã€è¿­ä»£ï¼Œç›´åˆ°ç”¨æˆ·ç¡®è®¤å®Œæˆã€‚

**é…ç½®ä½ç½®**: `core/tool_matrix.py:190-281`

**v22.0å‰ç½®æ£€æŸ¥**ï¼ˆPreToolUseæ–‡æ¡£æ·±åº¦æ£€æŸ¥ï¼‰:
- ğŸ” **è¿›å…¥é—¨æ§›**ï¼šdocs_count >= required_docsï¼ˆæ ‡å‡†3ï¼Œç©æ³•åŒ…2ï¼‰
- ğŸš« **ä¸è¾¾æ ‡æ‹¦æˆª**ï¼šWrite/Editè¢«PreToolUseé˜»æ–­ï¼Œè¦æ±‚è¿”å›Step2ç»§ç»­ç ”ç©¶
- âœ… **è¾¾æ ‡æ”¾è¡Œ**ï¼šå…è®¸æ­£å¸¸ä¿®æ”¹ä»£ç 

**PreToolUseæ–‡æ¡£æ·±åº¦æ£€æŸ¥ç¤ºä¾‹**:

```
åœºæ™¯: Step3å°è¯•ä¿®æ”¹ä»£ç ï¼Œä½†æ–‡æ¡£æ•°ä¸è¶³
å·¥å…·: Edit("player.py", ...)
ç»“æœ: âŒ DENY

æ‹¦æˆªæ¶ˆæ¯:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ ç ”ç©¶æ·±åº¦ä¸è¶³ - ä¿®æ”¹è¢«æ‹’ç»
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å½“å‰æ¨¡å¼: æ ‡å‡†æ¨¡å¼
å·²æŸ¥é˜…æ–‡æ¡£: 1/3

âŒ é—®é¢˜: ä¿®æ”¹å†³ç­–éœ€è¦åŸºäºå……åˆ†çš„æ–‡æ¡£ç ”ç©¶

âœ… è§£å†³æ–¹æ¡ˆ:
1. è¿”å›step2_researché˜¶æ®µ
2. ç»§ç»­æŸ¥é˜…è‡³å°‘ 2 ä¸ªç›¸å…³æ–‡æ¡£
3. é‡ç‚¹æŸ¥é˜…:
   - CRITICALè§„èŒƒæ–‡æ¡£ï¼ˆç¡®ä¿åˆè§„ï¼‰
   - ç›¸å…³ç³»ç»Ÿå®ç°æ–‡æ¡£
   - é—®é¢˜æ’æŸ¥æŒ‡å—

å®Œæˆæ–‡æ¡£æŸ¥é˜…åï¼ŒHookä¼šè‡ªåŠ¨å…è®¸ä¿®æ”¹æ“ä½œã€‚

ğŸ’¡ æç¤º: å……åˆ†çš„æ–‡æ¡£ç ”ç©¶èƒ½é¿å…è¿åCRITICALè§„èŒƒï¼Œ
         å‡å°‘è¿”å·¥è¿­ä»£ï¼Œæé«˜ä¿®å¤æˆåŠŸç‡ã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**å…³é”®çº¦æŸ**:
- âœ… å¯ä»¥ä¿®æ”¹ä»£ç æ–‡ä»¶ï¼ˆWrite/Editï¼‰- **éœ€é€šè¿‡æ–‡æ¡£æ·±åº¦æ£€æŸ¥**
- âœ… å¯ä»¥æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼ˆBashï¼‰
- âŒ ç¦æ­¢ä¿®æ”¹å…ƒæ•°æ®æ–‡ä»¶ï¼ˆ.task-meta.jsonï¼‰
- âŒ ç¦æ­¢å±é™©Bashå‘½ä»¤ï¼ˆrm -rf /, sudo, git push --forceï¼‰
- âŒ ä¸è‡ªåŠ¨æ¨è¿›ï¼Œéœ€ç”¨æˆ·ç¡®è®¤ï¼ˆè¾“å…¥"/mc-confirm"æˆ–"å·²ä¿®å¤"ï¼‰

**å¾ªç¯æ£€æµ‹**: åœ¨æ­¤é˜¶æ®µè¿›è¡Œï¼Œæ£€æµ‹åˆ°å¾ªç¯åè§¦å‘ä¸“å®¶å®¡æŸ¥ã€‚

### Step4: æ”¶å°¾å½’æ¡£

**ç›®æ ‡**: æ–‡æ¡£æ›´æ–°ã€DEBUGæ¸…ç†ã€ä»»åŠ¡å½’æ¡£ï¼ˆå¼ºåˆ¶å­ä»£ç†æ‰§è¡Œï¼‰ã€‚

**é…ç½®ä½ç½®**: `core/tool_matrix.py:278-368`

**å…³é”®çº¦æŸ**:
- âœ… çˆ¶ä»£ç†åªèƒ½Taskå¯åŠ¨å­ä»£ç†
- âŒ çˆ¶ä»£ç†ç¦æ­¢ç›´æ¥Write/Edit/Bash
- âœ… å­ä»£ç†å¯ä»¥Write/Edit
- âš ï¸ å­ä»£ç†å¿…é¡»æ ‡è®°step4_cleanup.status=completed

**å­ä»£ç†èŒè´£**:

1. Grepæœç´¢å¾…è¡¥å……æ–‡æ¡£
2. Editæ›´æ–°æ–‡æ¡£
3. Grepæœç´¢DEBUGä»£ç 
4. Editæ¸…ç†DEBUGä»£ç 
5. **âš ï¸ CRITICAL**: ä½¿ç”¨TaskMetaManager.atomic_update()è®¾ç½®step4_cleanup.status=completed

**å½’æ¡£æµç¨‹**:

```
å­ä»£ç†å®Œæˆ â†’ step4_cleanup.status=completed
â†’ post_archive.pyæ£€æµ‹åˆ°å®Œæˆ
â†’ ç§»åŠ¨åˆ°tasks/å·²å½’æ¡£/
â†’ æ ‡è®°task_meta.archived=true
```

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### æ¨¡å—ç»“æ„

```
templates/.claude/hooks/
â”œâ”€â”€ core/                                    # æ ¸å¿ƒæ¨¡å—ç›®å½•
â”‚   â”œâ”€â”€ __init__.py                          # å¯¼å‡º StageValidator, TaskMetaManager, ExpertTrigger
â”‚   â”œâ”€â”€ tool_matrix.py                       # å·¥å…·çŸ©é˜µé…ç½®
â”‚   â”œâ”€â”€ stage_validator.py                   # å››å±‚éªŒè¯å¼•æ“
â”‚   â”œâ”€â”€ path_validator.py                    # æ–‡ä»¶è·¯å¾„éªŒè¯å™¨
â”‚   â”œâ”€â”€ semantic_analyzer.py                 # æ“ä½œè¯­ä¹‰åˆ†æå™¨
â”‚   â”œâ”€â”€ expert_trigger.py                    # ä¸“å®¶è§¦å‘å™¨
â”‚   â””â”€â”€ task_meta_manager.py                 # çŠ¶æ€ç®¡ç†å™¨ï¼ˆv21.0æ–°å¢ï¼‰
â”‚
â”œâ”€â”€ orchestrator/                            # å·¥ä½œæµç¼–æ’
â”‚   â”œâ”€â”€ pretooluse_enforcer.py               # ç»Ÿä¸€PreToolUseå¼ºåˆ¶å™¨
â”‚   â”œâ”€â”€ posttooluse_updater.py               # ç»Ÿä¸€PostToolUseæ›´æ–°å™¨
â”‚   â”œâ”€â”€ user_prompt_handler.py               # ä»»åŠ¡åˆå§‹åŒ–/æ¢å¤
â”‚   â””â”€â”€ task_cancellation_handler.py         # ä»»åŠ¡å–æ¶ˆ/å¤±è´¥å¤„ç†
â”‚
â”œâ”€â”€ lifecycle/                               # ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”œâ”€â”€ session_start.py                     # ä¼šè¯å¯åŠ¨æ¢å¤
â”‚   â”œâ”€â”€ session_end.py                       # ä¼šè¯ç»“æŸæ¸…ç†
â”‚   â”œâ”€â”€ stop.py                              # ä¼šè¯åœæ­¢æ£€æŸ¥
â”‚   â””â”€â”€ subagent_stop.py                     # å­ä»£ç†åœæ­¢å¤„ç†
â”‚
â”œâ”€â”€ archiver/                                # å½’æ¡£ç³»ç»Ÿ
â”‚   â”œâ”€â”€ post_archive.py                      # å½’æ¡£åå¤„ç†
â”‚   â”œâ”€â”€ doc_generator.py                     # æ–‡æ¡£ç”Ÿæˆ
â”‚   â””â”€â”€ doc_enforcer.py                      # æ–‡æ¡£å¼ºåˆ¶æ£€æŸ¥
â”‚
â”œâ”€â”€ monitors/                                # ç›‘æ§ç³»ç»Ÿ
â”‚   â”œâ”€â”€ change_logger.py                     # å˜æ›´æ—¥å¿—
â”‚   â””â”€â”€ error_suggester.py                   # é”™è¯¯å»ºè®®
â”‚
â”œâ”€â”€ validators/                              # éªŒè¯å™¨
â”‚   â”œâ”€â”€ api_usage_validator.py               # APIä½¿ç”¨éªŒè¯
â”‚   â”œâ”€â”€ critical_rules_checker.py            # å…³é”®è§„åˆ™æ£€æŸ¥
â”‚   â””â”€â”€ pre_compact_reminder.py              # å‹ç¼©å‰æé†’
â”‚
â””â”€â”€ utils/                                   # å·¥å…·æ¨¡å—
    â”œâ”€â”€ logger.py                            # æ—¥å¿—å·¥å…·
    â”œâ”€â”€ notify.py                            # é€šçŸ¥å·¥å…·
    â””â”€â”€ config_loader.py                     # é…ç½®åŠ è½½å™¨
```

### core/tool_matrix.py

**èŒè´£**: å·¥å…·çŸ©é˜µé…ç½®ï¼Œå®šä¹‰é˜¶æ®µ-å·¥å…·-è·¯å¾„-è¯­ä¹‰å››ç»´è§„åˆ™ã€‚

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```python
STAGE_TOOL_MATRIX = {
    "step0_context": {
        "display_name": "ç†è§£é¡¹ç›®ä¸Šä¸‹æ–‡",
        "allowed_tools": ["Read"],
        "preconditions": [],
        "path_rules": {...},
        "semantic_rules": {...},
        "completion_condition": {...}
    },
    # ... å…¶ä»–é˜¶æ®µ
}

STRATEGY_TYPES = {
    "bug_fix": {
        "display_name": "BUGä¿®å¤",
        "loop_detection_enabled": True,
        "expert_trigger_threshold": {...}
    },
    # ... å…¶ä»–ç­–ç•¥
}
```

**å…³é”®å‡½æ•°**:

```python
def get_stage_config(stage_name: str) -> dict
def get_allowed_tools(stage_name: str) -> list
def get_path_rules(stage_name: str, tool_name: str) -> dict
def get_semantic_rules(stage_name: str, tool_name: str) -> dict
def get_next_step(current_step: str) -> str
```

### core/stage_validator.py

**èŒè´£**: æ•´åˆå››å±‚éªŒè¯ï¼Œä½œä¸ºç»Ÿä¸€PreToolUseçš„æ ¸å¿ƒéªŒè¯å¼•æ“ã€‚

**æ ¸å¿ƒæ–¹æ³•ï¼ˆv21.0ï¼‰**:

```python
class StageValidator:
    def __init__(self, cwd: Optional[str] = None):
        self.cwd = cwd
        self.path_validator = PathValidator(cwd)
        self.semantic_analyzer = SemanticAnalyzer(self.path_validator)
        self.task_meta_manager = TaskMetaManager(cwd)  # v21.0: ä½¿ç”¨TaskMetaManager

    def validate(
        self,
        current_step: str,
        tool_name: str,
        tool_input: Dict,
        task_meta: Dict  # v21.0: å‚æ•°ä»workflow_stateæ”¹ä¸ºtask_meta
    ) -> Dict:
        """
        å››å±‚éªŒè¯ä¸»å…¥å£
        Returns: {"allowed": bool, "reason": str, "suggestion": str}
        """
        # ç¬¬ä¸€å±‚: é˜¶æ®µ-å·¥å…·åŸºç¡€éªŒè¯
        layer1_result = self._validate_layer1_tool_type(...)
        if not layer1_result["allowed"]:
            return layer1_result

        # ç¬¬äºŒå±‚: å‰ç½®æ¡ä»¶æ£€æŸ¥
        layer2_result = self._validate_layer2_preconditions(...)
        if not layer2_result["allowed"]:
            return layer2_result

        # ç¬¬ä¸‰å±‚: æ–‡ä»¶è·¯å¾„éªŒè¯
        layer3_result = self._validate_layer3_path(...)
        if not layer3_result["allowed"]:
            return layer3_result

        # ç¬¬å››å±‚: æ“ä½œè¯­ä¹‰åˆ†æ
        layer4_result = self._validate_layer4_semantic(...)
        if not layer4_result["allowed"]:
            return layer4_result

        return {"allowed": True, "reason": "å››å±‚éªŒè¯å…¨éƒ¨é€šè¿‡"}
```

### core/task_meta_manager.py

**èŒè´£**: çŠ¶æ€ç®¡ç†å™¨ï¼ˆv21.0æ–°å¢ï¼‰ï¼Œtask-meta.jsonå”¯ä¸€æ•°æ®æºï¼Œæ–‡ä»¶é”+åŸå­å†™å…¥ã€‚

**æ ¸å¿ƒæ–¹æ³•**:

```python
class TaskMetaManager:
    def __init__(self, cwd: str):
        self.cwd = cwd
        self.tasks_dir = os.path.join(cwd, 'tasks')
        self.active_task_file = os.path.join(cwd, '.claude', '.task-active.json')

    def get_active_task_id(self) -> Optional[str]:
        """è·å–æ´»è·ƒä»»åŠ¡ID"""
        # è¯»å– .task-active.json

    def load_task_meta(self, task_id: str) -> Optional[Dict]:
        """åŠ è½½ä»»åŠ¡å…ƒæ•°æ®ï¼ˆå¸¦æ–‡ä»¶é”ï¼‰"""
        # ä½¿ç”¨ portalocker åŠ è½½ .task-meta.json

    def save_task_meta(self, task_id: str, task_meta: Dict):
        """ä¿å­˜ä»»åŠ¡å…ƒæ•°æ®ï¼ˆå¸¦æ–‡ä»¶é”ï¼‰"""
        # ä½¿ç”¨ portalocker ä¿å­˜ .task-meta.json

    def atomic_update(
        self,
        task_id: str,
        update_func: Callable[[Dict], Dict],
        max_retries: int = 3,
        retry_delay: float = 0.1
    ) -> Optional[Dict]:
        """
        åŸå­æ›´æ–°ä»»åŠ¡å…ƒæ•°æ®ï¼ˆæ–‡ä»¶é”+é‡è¯•æœºåˆ¶ï¼‰

        Args:
            task_id: ä»»åŠ¡ID
            update_func: æ›´æ–°é—­åŒ…å‡½æ•° (meta: Dict) -> Dict
            max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
            retry_delay: é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰

        Returns:
            æ›´æ–°åçš„task_metaï¼Œå¤±è´¥è¿”å›None
        """
        for attempt in range(max_retries):
            try:
                # 1. åŠ è½½å½“å‰çŠ¶æ€ï¼ˆå¸¦é”ï¼‰
                meta = self.load_task_meta(task_id)
                if not meta:
                    return None

                # 2. æ‰§è¡Œæ›´æ–°å‡½æ•°
                updated_meta = update_func(meta)

                # 3. ä¿å­˜ï¼ˆå¸¦é”ï¼‰
                self.save_task_meta(task_id, updated_meta)

                return updated_meta

            except Exception as e:
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                else:
                    raise

    def clear_active_task(self):
        """æ¸…ç†æ´»è·ƒä»»åŠ¡æ ‡è®°"""
        # åˆ é™¤ .task-active.json

    def check_subagent_lock(self, task_id: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å­˜åœ¨å­ä»£ç†é”æ–‡ä»¶"""
        # æ£€æŸ¥ .subagent-lock æ–‡ä»¶

    def create_subagent_lock(self, task_id: str):
        """åˆ›å»ºå­ä»£ç†é”æ–‡ä»¶"""
        # åˆ›å»º .subagent-lock æ–‡ä»¶
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# åˆå§‹åŒ–
mgr = TaskMetaManager(cwd)

# åŸå­æ›´æ–°æ¨¡å¼ï¼ˆæ¨èï¼‰
def update_func(meta: Dict) -> Dict:
    meta['current_step'] = 'step3_execute'
    meta['steps']['step3_execute']['status'] = 'in_progress'
    return meta

updated_meta = mgr.atomic_update(task_id, update_func)

# ç®€å•è¯»å–
task_id = mgr.get_active_task_id()
task_meta = mgr.load_task_meta(task_id)
```

### core/expert_trigger.py

**èŒè´£**: ä¸“å®¶è§¦å‘å™¨ï¼Œå¾ªç¯æ£€æµ‹ä¸ä¸“å®¶å®¡æŸ¥ã€‚

**æ ¸å¿ƒæ–¹æ³•**:

```python
class ExpertTrigger:
    def should_trigger(self, task_meta: Dict) -> bool:  # v21.0: å‚æ•°ä»workflow_stateæ”¹ä¸ºtask_meta
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘ä¸“å®¶å®¡æŸ¥"""
        # 1. æ£€æŸ¥æ˜¯å¦å·²è§¦å‘ï¼ˆé¿å…é‡å¤ï¼‰
        # 2. åªåœ¨Step3é˜¶æ®µè§¦å‘
        # 3. æ ¹æ®ä»»åŠ¡ç±»å‹æ£€æµ‹å¾ªç¯

    def _detect_bug_fix_loop(self, task_meta: Dict) -> bool:
        """
        æ£€æµ‹BUGä¿®å¤å¾ªç¯
        è§¦å‘æ¡ä»¶: iterationsâ‰¥2, negativeâ‰¥2, same_fileâ‰¥2
        """

    def generate_prompt(self, task_meta: Dict) -> str:
        """ç”Ÿæˆä¸“å®¶åˆ†æPrompt"""
```

---

## ç»Ÿä¸€Hookæœºåˆ¶

### orchestrator/pretooluse_enforcer.py

**èŒè´£**: ç»Ÿä¸€PreToolUseå¼ºåˆ¶å™¨ï¼Œæ‹¦æˆªæ‰€æœ‰å·¥å…·è°ƒç”¨ï¼Œæ‰§è¡Œå››å±‚éªŒè¯ã€‚

**æ ¸å¿ƒæµç¨‹ï¼ˆv21.0ï¼‰**:

```python
def main():
    # 1. è§£æè¾“å…¥
    event_data = json.loads(sys.stdin.read())
    tool_name = event_data.get('toolName')
    tool_input = event_data.get('toolInput', {})

    # 2. åŠ è½½å½“å‰çŠ¶æ€ï¼ˆv21.0: ä½¿ç”¨TaskMetaManagerï¼‰
    mgr = TaskMetaManager(cwd)
    task_id = mgr.get_active_task_id()

    # 3. æ— æ´»è·ƒä»»åŠ¡æ—¶æ”¾è¡Œ
    if not task_id:
        allow_and_exit("æ— æ´»è·ƒä»»åŠ¡ï¼Œé»˜è®¤æ”¾è¡Œ")

    task_meta = mgr.load_task_meta(task_id)
    if not task_meta:
        allow_and_exit("ä»»åŠ¡å…ƒæ•°æ®ç¼ºå¤±ï¼Œé»˜è®¤æ”¾è¡Œ")

    current_step = task_meta.get('current_step', 'step0_context')

    # 4. æ‰§è¡Œå››å±‚éªŒè¯
    validator = StageValidator(cwd)
    validation_result = validator.validate(
        current_step,
        tool_name,
        tool_input,
        task_meta  # v21.0: ä¼ é€’task_metaè€Œéworkflow_state
    )

    # 5. å†³ç­–
    if validation_result["allowed"]:
        allow_and_exit(validation_result["reason"])
    else:
        deny_and_exit(validation_result["reason"])
```

### orchestrator/posttooluse_updater.py

**èŒè´£**: ç»Ÿä¸€PostToolUseæ›´æ–°å™¨ï¼Œçº¯ç²¹çš„çŠ¶æ€æ›´æ–°å™¨ï¼ˆé›¶å†³ç­–é€»è¾‘ï¼‰ã€‚

**æ ¸å¿ƒæµç¨‹ï¼ˆv21.0ï¼‰**:

```python
def main():
    # 1. è§£æè¾“å…¥
    event_data = json.loads(sys.stdin.read())
    tool_name = event_data.get('toolName')
    tool_input = event_data.get('toolInput', {})

    # 2. åŠ è½½å½“å‰çŠ¶æ€
    mgr = TaskMetaManager(cwd)
    task_id = mgr.get_active_task_id()
    task_meta = mgr.load_task_meta(task_id)

    # 3. æ ¹æ®å·¥å…·ç±»å‹æ›´æ–°çŠ¶æ€ï¼ˆä½¿ç”¨åŸå­æ›´æ–°ï¼‰
    def update_func(meta: Dict) -> Dict:
        # æ›´æ–°metricsã€stepsç­‰
        return meta

    updated_meta = mgr.atomic_update(task_id, update_func)

    # 4. æ£€æµ‹ä¸“å®¶è§¦å‘æ¡ä»¶
    expert_trigger = ExpertTrigger(cwd)
    if expert_trigger.should_trigger(updated_meta):
        expert_context = expert_trigger.generate_prompt(updated_meta)
    else:
        expert_context = None

    # 5. æ£€æµ‹æ­¥éª¤å®Œæˆæ¡ä»¶
    step_transition_context = check_step_completion(updated_meta)

    # 6. æ„å»ºè¾“å‡º
    output = {
        "hookSpecificOutput": {
            "hookEventName": "PostToolUse",
            "expertContext": expert_context,
            "stepTransitionContext": step_transition_context
        }
    }
    print(json.dumps(output, ensure_ascii=False))
```

---

## çŠ¶æ€æ•°æ®ç®¡ç†

### äºŒæ–‡ä»¶æ¶æ„ï¼ˆv21.0ï¼‰

| æ–‡ä»¶ | ä½ç½® | ç”Ÿå‘½å‘¨æœŸ | ç”¨é€” |
|------|------|----------|------|
| **.task-meta.json** | `tasks/{task_id}/` | ä»»åŠ¡çº§ | **å”¯ä¸€æ•°æ®æº** - ä»»åŠ¡å…ƒæ•°æ®ã€æ­¥éª¤çŠ¶æ€ã€æŒ‡æ ‡ |
| **.task-active.json** | `.claude/` | ä¼šè¯çº§ | å¿«é€Ÿæ´»è·ƒä»»åŠ¡æ£€æŸ¥ï¼ˆæŒ‡é’ˆï¼‰ |

**åŒæ­¥æ—¶æœº**:

| è§¦å‘äº‹ä»¶ | .task-meta.json | .task-active.json |
|----------|-----------------|-------------------|
| `/mc` å‘½ä»¤åˆå§‹åŒ– | âœ… åˆ›å»ºï¼ˆåˆå§‹åŒ–æ‰€æœ‰å­—æ®µï¼‰ | âœ… åˆ›å»ºï¼ˆæŒ‡å‘task_idï¼‰ |
| SessionStart | âœ… è¯»å–ï¼ˆæ¢å¤çŠ¶æ€ï¼‰ | âœ… è¯»å–ï¼ˆè·å–task_idï¼‰ |
| PostToolUseï¼ˆä»£ç ä¿®æ”¹ï¼‰ | âœ… åŸå­æ›´æ–°ï¼ˆmetricsï¼‰ | - |
| æ­¥éª¤æ¨è¿› | âœ… åŸå­æ›´æ–°ï¼ˆcurrent_stepï¼‰ | - |
| ä»»åŠ¡å½’æ¡£ | âœ… åŸå­æ›´æ–°ï¼ˆarchived=trueï¼‰ | âœ… åˆ é™¤ |

**æ•°æ®æµå‘ï¼ˆv21.0ï¼‰**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  .task-active.json                       â”‚
â”‚  { "task_id": "20251115-123456-ä¿®å¤ç©å®¶æ­»äº¡BUG" }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ æŒ‡å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              tasks/{task_id}/.task-meta.json             â”‚
â”‚  - architecture_version: "21.0"                          â”‚
â”‚  - task_id, task_description                             â”‚
â”‚  - current_step: "step3_execute"                         â”‚
â”‚  - steps: {...}                                          â”‚
â”‚  - metrics: {...}                                        â”‚
â”‚  - bug_fix_tracking: {...}                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŸå­æ›´æ–°æ¨¡å¼ï¼ˆv21.0æ ¸å¿ƒæœºåˆ¶ï¼‰

**é—®é¢˜**: å¹¶å‘å†™å…¥å¯¼è‡´æ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**: æ–‡ä»¶é” + é—­åŒ…æ›´æ–°å‡½æ•° + é‡è¯•æœºåˆ¶

**ä»£ç æ¨¡å¼**:

```python
# å®šä¹‰æ›´æ–°å‡½æ•°ï¼ˆé—­åŒ…ï¼‰
def update_func(meta: Dict) -> Dict:
    # 1. è¯»å–å½“å‰å€¼
    current_step = meta.get('current_step')

    # 2. æ‰§è¡Œæ›´æ–°é€»è¾‘
    meta['current_step'] = 'step3_execute'
    meta['steps']['step3_execute']['status'] = 'in_progress'

    # 3. æ›´æ–°metrics
    if 'metrics' not in meta:
        meta['metrics'] = {}
    meta['metrics']['tool_calls'] = meta['metrics'].get('tool_calls', [])
    meta['metrics']['tool_calls'].append({
        "tool": "Edit",
        "timestamp": datetime.now().isoformat()
    })

    # 4. è¿”å›æ›´æ–°åçš„meta
    return meta

# æ‰§è¡ŒåŸå­æ›´æ–°
mgr = TaskMetaManager(cwd)
updated_meta = mgr.atomic_update(task_id, update_func)
```

**å†…éƒ¨å®ç°ï¼ˆportalockeræ–‡ä»¶é”ï¼‰**:

```python
def atomic_update(self, task_id, update_func, max_retries=3, retry_delay=0.1):
    for attempt in range(max_retries):
        try:
            # 1. åŠ è½½ï¼ˆå¸¦æ–‡ä»¶é”ï¼‰
            meta_path = self.get_task_dir(task_id) / '.task-meta.json'

            with portalocker.Lock(meta_path, 'r+', timeout=5) as f:
                meta = json.load(f)

                # 2. æ‰§è¡Œæ›´æ–°å‡½æ•°
                updated_meta = update_func(meta)

                # 3. å†™å›ï¼ˆåŒä¸€ä¸ªé”å†…ï¼‰
                f.seek(0)
                f.truncate()
                json.dump(updated_meta, f, ensure_ascii=False, indent=2)

            return updated_meta

        except portalocker.exceptions.LockException:
            if attempt < max_retries - 1:
                time.sleep(retry_delay)
                continue
            else:
                raise
```

---

## ä¸“å®¶è§¦å‘ç³»ç»Ÿ

### Bugä¿®å¤å¾ªç¯æ£€æµ‹

**è§¦å‘é˜ˆå€¼**:

```python
iterations_count >= 2
negative_feedback_count >= 2
same_file_edit_count >= 2
```

**æ£€æµ‹é€»è¾‘ï¼ˆv21.0ï¼‰**:

```python
def _detect_bug_fix_loop(self, task_meta: Dict) -> bool:
    """æ£€æµ‹BUGä¿®å¤å¾ªç¯"""
    bug_tracking = task_meta.get('bug_fix_tracking', {})

    iterations = bug_tracking.get('iterations', [])
    iterations_count = len(iterations)

    # ç»Ÿè®¡è´Ÿé¢åé¦ˆ
    negative_feedback_count = sum(
        1 for it in iterations
        if it.get('user_feedback_type') == 'negative'
    )

    # ç»Ÿè®¡åŒä¸€æ–‡ä»¶ç¼–è¾‘æ¬¡æ•°
    file_edit_counts = {}
    for it in iterations:
        for file in it.get('files_modified', []):
            file_edit_counts[file] = file_edit_counts.get(file, 0) + 1

    same_file_edit_count = max(file_edit_counts.values(), default=0)

    # åˆ¤æ–­
    return (
        iterations_count >= 2 and
        negative_feedback_count >= 2 and
        same_file_edit_count >= 2
    )
```

### ä¸“å®¶Promptç»“æ„

ä¸“å®¶PromptåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

1. **é—®é¢˜æ¨¡å¼è¯†åˆ«** - å¾ªç¯ç±»å‹ã€ç½®ä¿¡åº¦ã€è¯æ®æ•°æ®
2. **è¿­ä»£å†å²æ‘˜è¦** - æ¯æ¬¡è¿­ä»£çš„æ—¶é—´ã€åé¦ˆã€ä¿®æ”¹æ–‡ä»¶
3. **åˆ†ææ¡†æ¶** - æ ¹å› åˆ†æã€å¤±è´¥æ¨¡å¼ã€å¤‡é€‰è·¯å¾„ã€æ¨èç­–ç•¥
4. **éœ€è¦æ¾„æ¸…çš„é—®é¢˜** - å¼•å¯¼ç”¨æˆ·æä¾›æ›´å¤šä¿¡æ¯

---

## å®æˆ˜æ¡ˆä¾‹

### å®Œæ•´BUGä¿®å¤æµç¨‹

**åœºæ™¯**: ä¿®å¤"ç©å®¶æ­»äº¡æ—¶èƒŒåŒ…ç‰©å“æœªæ‰è½"BUG

**Step0: ç†è§£é¡¹ç›®ä¸Šä¸‹æ–‡**

```
ç”¨æˆ·: /mc ä¿®å¤ç©å®¶æ­»äº¡æ—¶èƒŒåŒ…ç‰©å“æœªæ‰è½çš„BUG

AI: æˆ‘å…ˆäº†è§£ä¸€ä¸‹é¡¹ç›®ç»“æ„...
â†’ Read("CLAUDE.md")
â†’ [PostToolUse] æ£€æµ‹åˆ°CLAUDE.mdè¢«è¯»å–ï¼Œè‡ªåŠ¨æ¨è¿›åˆ°Step1
```

**Step1: ç†è§£ä»»åŠ¡éœ€æ±‚**

```
AI: æˆ‘å…ˆé˜…è¯»ç›¸å…³æ–‡æ¡£...
â†’ Read("docs/ç©å®¶ç³»ç»Ÿ.md")
â†’ Read("docs/æ­»äº¡æœºåˆ¶.md")
â†’ [PostToolUse] æ£€æµ‹åˆ°è‡³å°‘è¯»å–1ä¸ªæ–‡æ¡£ï¼Œè‡ªåŠ¨æ¨è¿›åˆ°Step2
```

**Step2: ä»»åŠ¡æµè·¯ç”±**

```
AI: æ ¹æ®ä»»åŠ¡æè¿°"ä¿®å¤ç©å®¶æ­»äº¡æ—¶èƒŒåŒ…ç‰©å“æœªæ‰è½çš„BUG"ï¼Œæˆ‘åˆ¤æ–­è¿™æ˜¯ä¸€ä¸ª **BUGä¿®å¤** ä»»åŠ¡ï¼ˆbug_fixï¼‰ã€‚

æ‰§è¡Œç­–ç•¥:
1. Grepæœç´¢ç©å®¶æ­»äº¡ç›¸å…³ä»£ç 
2. Grepæœç´¢ç‰©å“æ‰è½é€»è¾‘
3. å®šä½BUGæ ¹å› 

â†’ Grep("æ­»äº¡", type="py")
â†’ Grep("drop.*item", type="py")
â†’ [PostToolUse] æ£€æµ‹åˆ°AIç¡®è®¤ä»»åŠ¡ç­–ç•¥ï¼Œè‡ªåŠ¨æ¨è¿›åˆ°Step3
```

**Step3: æ‰§è¡Œå®æ–½ï¼ˆç¬¬1æ¬¡è¿­ä»£ï¼‰**

```
AI: æˆ‘å‘ç°é—®é¢˜åœ¨ player.py:123ï¼Œæ­»äº¡æ—¶æ²¡æœ‰è°ƒç”¨drop_items()
â†’ Edit("behavior_packs/player.py", old_str="...", new_str="...")

ç”¨æˆ·: è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œç‰©å“æ‰è½äº†ä½†æ˜¯åæ ‡ä¸å¯¹

â†’ [PostToolUse] æ›´æ–°bug_fix_tracking:
   - iterations[0].user_feedback_type = "negative"
   - iterations[0].files_modified = ["player.py"]
```

**Step3: æ‰§è¡Œå®æ–½ï¼ˆç¬¬2æ¬¡è¿­ä»£ï¼‰**

```
AI: æˆ‘å†ä¿®å¤åæ ‡é—®é¢˜...
â†’ Edit("behavior_packs/player.py", old_str="...", new_str="...")

ç”¨æˆ·: è¿˜æ˜¯ä¸å¯¹ï¼Œç‰©å“æ‰è½åˆ°å¤©ç©ºäº†

â†’ [PostToolUse] æ›´æ–°bug_fix_tracking:
   - iterations[1].user_feedback_type = "negative"
   - iterations[1].files_modified = ["player.py"]

â†’ [PostToolUse] æ£€æµ‹åˆ°å¾ªç¯:
   - iterations_count = 2
   - negative_feedback_count = 2
   - same_file_edit_count = 2

â†’ è§¦å‘ä¸“å®¶å®¡æŸ¥ï¼Œç”Ÿæˆä¸“å®¶Prompt
```

**ä¸“å®¶å®¡æŸ¥Prompt**

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ” ä¸“å®¶çº§é—®é¢˜åˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ£€æµ‹åˆ°å¯èƒ½çš„å¾ªç¯æ¨¡å¼:

**é—®é¢˜æ¨¡å¼è¯†åˆ«**:
- å¾ªç¯ç±»å‹: BUGä¿®å¤å¾ªç¯
- ç½®ä¿¡åº¦: é«˜
- è¯æ®:
  - è¿­ä»£æ¬¡æ•°: 2æ¬¡
  - è´Ÿé¢åé¦ˆ: 2æ¬¡
  - åŒä¸€æ–‡ä»¶ç¼–è¾‘: player.py (2æ¬¡)

**è¿­ä»£å†å²æ‘˜è¦**:
1. ç¬¬1æ¬¡è¿­ä»£ (2025-11-15 12:00):
   - ç”¨æˆ·åé¦ˆ: "è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œç‰©å“æ‰è½äº†ä½†æ˜¯åæ ‡ä¸å¯¹"
   - ä¿®æ”¹æ–‡ä»¶: player.py

2. ç¬¬2æ¬¡è¿­ä»£ (2025-11-15 12:10):
   - ç”¨æˆ·åé¦ˆ: "è¿˜æ˜¯ä¸å¯¹ï¼Œç‰©å“æ‰è½åˆ°å¤©ç©ºäº†"
   - ä¿®æ”¹æ–‡ä»¶: player.py

**åˆ†ææ¡†æ¶**:

1. **æ ¹å› åˆ†æ** - è€ƒè™‘ä»¥ä¸‹å¯èƒ½æ€§:
   - åæ ‡ç³»ç»Ÿç†è§£é”™è¯¯ï¼ˆä¸–ç•Œåæ ‡ vs ç›¸å¯¹åæ ‡ï¼‰
   - æ­»äº¡ä½ç½®è·å–æ–¹å¼é”™è¯¯
   - Yè½´åæ ‡è®¡ç®—é”™è¯¯

2. **å¤±è´¥æ¨¡å¼**:
   - åå¤ä¿®æ”¹åŒä¸€æ–‡ä»¶ player.pyï¼Œä½†æ²¡æœ‰æ£€æŸ¥åæ ‡ç³»ç»Ÿæ–‡æ¡£
   - æ²¡æœ‰æ‰§è¡Œæµ‹è¯•éªŒè¯åæ ‡è®¡ç®—é€»è¾‘

3. **å¤‡é€‰è·¯å¾„**:
   - è·¯å¾„A: é˜…è¯»åæ ‡ç³»ç»Ÿæ–‡æ¡£ï¼Œç†è§£æ­£ç¡®çš„åæ ‡è·å–æ–¹å¼
   - è·¯å¾„B: Grepæœç´¢å…¶ä»–æˆåŠŸçš„ç‰©å“æ‰è½å®ç°ï¼Œå‚è€ƒå…¶åæ ‡å¤„ç†æ–¹å¼
   - è·¯å¾„C: Bashæ‰§è¡Œæµ‹è¯•è„šæœ¬ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯éªŒè¯åæ ‡å€¼

4. **æ¨èç­–ç•¥**:
   - âœ… å…ˆReadç›¸å…³æ–‡æ¡£ï¼ˆdocs/åæ ‡ç³»ç»Ÿ.mdï¼‰
   - âœ… Grepæœç´¢æˆåŠŸæ¡ˆä¾‹ï¼ˆ"drop_item"ï¼‰
   - âœ… Bashæ‰§è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹æ—¥å¿—

**éœ€è¦æ¾„æ¸…çš„é—®é¢˜**:
1. æ­»äº¡ä½ç½®çš„åæ ‡æ˜¯å¦‚ä½•è·å–çš„ï¼Ÿï¼ˆä¸–ç•Œåæ ‡ or ç›¸å¯¹åæ ‡ï¼‰
2. ç‰©å“æ‰è½çš„ç›®æ ‡åæ ‡åº”è¯¥æ˜¯ç©å®¶å½“å‰ä½ç½®è¿˜æ˜¯æ­»äº¡ä½ç½®ï¼Ÿ
3. æ˜¯å¦æœ‰åæ ‡ç³»ç»Ÿçš„ç›¸å…³æ–‡æ¡£å¯ä»¥å‚è€ƒï¼Ÿ

è¯·åŸºäºä»¥ä¸Šåˆ†æï¼Œé‡æ–°å®¡è§†é—®é¢˜æ ¹å› ï¼Œå¹¶é€‰æ‹©æ¨èç­–ç•¥ä¸­çš„è·¯å¾„ã€‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**Step3: æ‰§è¡Œå®æ–½ï¼ˆç¬¬3æ¬¡è¿­ä»£ - ä¸“å®¶æŒ‡å¯¼åï¼‰**

```
AI: æˆ‘å…ˆé˜…è¯»åæ ‡ç³»ç»Ÿæ–‡æ¡£...
â†’ Read("docs/åæ ‡ç³»ç»Ÿ.md")

AI: æˆ‘å‘ç°é—®é¢˜äº†ï¼åº”è¯¥ä½¿ç”¨get_world_position()è€Œéget_position()
â†’ Edit("behavior_packs/player.py", old_str="...", new_str="...")
â†’ Bash("pytest tests/test_player_death.py")

ç”¨æˆ·: /mc-confirmï¼ˆBUGå·²ä¿®å¤ï¼‰

â†’ [UserPromptSubmit] æ£€æµ‹åˆ°ç”¨æˆ·ç¡®è®¤ï¼Œæ¨è¿›åˆ°Step4
```

**Step4: æ”¶å°¾å½’æ¡£**

```
AI: æˆ‘å¯åŠ¨å­ä»£ç†å¤„ç†æ”¶å°¾å·¥ä½œ...
â†’ Task(prompt="æ›´æ–°æ–‡æ¡£å¹¶æ¸…ç†DEBUGä»£ç ï¼Œå®Œæˆåæ ‡è®°step4_cleanup.status=completed")

å­ä»£ç†:
â†’ Grep("TODO", glob="docs/**/*.md")
â†’ Edit("docs/ç©å®¶ç³»ç»Ÿ.md", ...)
â†’ Grep("DEBUG", type="py")
â†’ Edit("behavior_packs/player.py", ...) # æ¸…ç†DEBUGä»£ç 

â†’ TaskMetaManager.atomic_update(task_id, lambda meta: {
    **meta,
    "steps": {
        **meta["steps"],
        "step4_cleanup": {"status": "completed", "completed_at": "..."}
    }
})

â†’ [PostArchive] æ£€æµ‹åˆ°step4_cleanup.status=completedï¼Œç§»åŠ¨åˆ°tasks/å·²å½’æ¡£/
```

---

## å¼€å‘æŒ‡å—

### å¦‚ä½•æ·»åŠ æ–°çš„éªŒè¯è§„åˆ™

1. ä¿®æ”¹ `core/tool_matrix.py` é…ç½®
2. æ·»åŠ ç›¸åº”çš„path_rulesæˆ–semantic_rules
3. ç¼–å†™æµ‹è¯•è„šæœ¬éªŒè¯

**ç¤ºä¾‹**: æ·»åŠ ç¦æ­¢ä¿®æ”¹é…ç½®æ–‡ä»¶çš„è§„åˆ™

```python
# core/tool_matrix.py

"step3_execute": {
    "path_rules": {
        "Edit": {
            "blacklist_patterns": [
                "**/*.json",  # ç¦æ­¢ä¿®æ”¹JSONé…ç½®æ–‡ä»¶
                "**/*.yaml",
                ".task-meta.json"  # ç¦æ­¢ä¿®æ”¹ä»»åŠ¡å…ƒæ•°æ®
            ]
        }
    }
}
```

### å¦‚ä½•ä¿®æ”¹é˜¶æ®µé¡ºåº

1. ä¿®æ”¹ `core/tool_matrix.py` çš„ STEP_ORDER
2. æ·»åŠ æ–°é˜¶æ®µé…ç½®åˆ° STAGE_TOOL_MATRIX
3. é…ç½®completion_condition

**ç¤ºä¾‹**: æ·»åŠ æ–°çš„Step5éªŒè¯é˜¶æ®µ

```python
# core/tool_matrix.py

STEP_ORDER = [
    "step0_context",
    "step1_understand",
    "step2_research",
    "step3_execute",
    "step4_cleanup",
    "step5_verify"  # æ–°å¢éªŒè¯é˜¶æ®µ
]

STAGE_TOOL_MATRIX["step5_verify"] = {
    "display_name": "éªŒè¯æµ‹è¯•",
    "allowed_tools": ["Bash", "Read"],
    "preconditions": [
        {"step": "step4_cleanup", "field": "status", "value": "completed"}
    ],
    "completion_condition": {
        "type": "user_confirm",
        "keywords": ["æµ‹è¯•é€šè¿‡", "éªŒè¯å®Œæˆ"]
    }
}
```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ—¥å¿—** - åœ¨Hookæ–‡ä»¶ä¸­æ·»åŠ stderrè¾“å‡º

```python
import sys

sys.stderr.write(f"[DEBUG] current_step: {current_step}\n")
sys.stderr.write(f"[DEBUG] task_meta: {json.dumps(task_meta, indent=2)}\n")
```

2. **æŸ¥çœ‹éªŒè¯ç»“æœ** - æ£€æŸ¥.claude/.hook-logs/

```bash
# æŸ¥çœ‹æœ€è¿‘çš„PreToolUseæ—¥å¿—
tail -f .claude/.hook-logs/pretooluse.log
```

3. **å•å…ƒæµ‹è¯•** - åˆ›å»ºç‹¬ç«‹æµ‹è¯•è„šæœ¬

```python
# tests/test_stage_validator.py

from core.stage_validator import StageValidator
from core.task_meta_manager import TaskMetaManager

def test_step1_deny_edit():
    validator = StageValidator("/path/to/project")

    task_meta = {
        "current_step": "step1_understand",
        "steps": {
            "step0_context": {"status": "completed"}
        }
    }

    result = validator.validate(
        current_step="step1_understand",
        tool_name="Edit",
        tool_input={"file_path": "test.py"},
        task_meta=task_meta
    )

    assert result["allowed"] == False
    assert "Editå·¥å…·åœ¨å½“å‰é˜¶æ®µä¸å¯ç”¨" in result["reason"]
```

### å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1: éªŒè¯è§„åˆ™ä¸ç”Ÿæ•ˆ**

- æ£€æŸ¥ `core/tool_matrix.py` é…ç½®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ Hook æ˜¯å¦æ­£ç¡®åŠ è½½é…ç½®
- æŸ¥çœ‹ stderr æ—¥å¿—ç¡®è®¤éªŒè¯é€»è¾‘æ‰§è¡Œ

**é—®é¢˜2: çŠ¶æ€æ›´æ–°å¤±è´¥**

```python
# é”™è¯¯ç¤ºä¾‹ï¼ˆç›´æ¥ä¿®æ”¹ï¼‰
task_meta['current_step'] = 'step3_execute'  # âŒ ä¸ä¼šä¿å­˜

# æ­£ç¡®ç¤ºä¾‹ï¼ˆåŸå­æ›´æ–°ï¼‰
def update_func(meta):
    meta['current_step'] = 'step3_execute'
    return meta

mgr.atomic_update(task_id, update_func)  # âœ… æ­£ç¡®
```

**é—®é¢˜3: æ–‡ä»¶é”è¶…æ—¶**

```python
# å¢åŠ é”è¶…æ—¶æ—¶é—´
mgr.atomic_update(
    task_id,
    update_func,
    max_retries=5,      # å¢åŠ é‡è¯•æ¬¡æ•°
    retry_delay=0.2     # å¢åŠ é‡è¯•é—´éš”
)
```

---

## é™„å½•ï¼šæ ¸å¿ƒæ–‡ä»¶é€ŸæŸ¥

| æ–‡ä»¶ | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| **å·¥å…·çŸ©é˜µé…ç½®** | `core/tool_matrix.py` | é˜¶æ®µ-å·¥å…·-è·¯å¾„-è¯­ä¹‰å››ç»´è§„åˆ™é…ç½® |
| **å››å±‚éªŒè¯å¼•æ“** | `core/stage_validator.py` | æ•´åˆå››å±‚éªŒè¯é€»è¾‘ |
| **è·¯å¾„éªŒè¯å™¨** | `core/path_validator.py` | æ–‡ä»¶è·¯å¾„ç™½åå•/é»‘åå•éªŒè¯ |
| **è¯­ä¹‰åˆ†æå™¨** | `core/semantic_analyzer.py` | æ“ä½œè¯­ä¹‰åˆ†æ |
| **ä¸“å®¶è§¦å‘å™¨** | `core/expert_trigger.py` | å¾ªç¯æ£€æµ‹ä¸ä¸“å®¶å®¡æŸ¥ |
| **çŠ¶æ€ç®¡ç†å™¨** | `core/task_meta_manager.py` | task-meta.jsonè¯»å†™ã€åŸå­æ›´æ–°ã€æ–‡ä»¶é” |
| **ç»Ÿä¸€PreToolUse** | `orchestrator/pretooluse_enforcer.py` | å”¯ä¸€éªŒè¯å…¥å£ï¼Œå¼ºåˆ¶æ‹¦æˆª |
| **ç»Ÿä¸€PostToolUse** | `orchestrator/posttooluse_updater.py` | çº¯ç²¹çŠ¶æ€æ›´æ–°å™¨ |
| **ä»»åŠ¡åˆå§‹åŒ–/æ¢å¤** | `orchestrator/user_prompt_handler.py` | ä»»åŠ¡åˆ›å»ºã€æ¢å¤ã€å–æ¶ˆæ£€æµ‹ |
| **ä¼šè¯å¯åŠ¨** | `lifecycle/session_start.py` | ä¼šè¯å¯åŠ¨æ¢å¤ |
| **ä¼šè¯åœæ­¢** | `lifecycle/stop.py` | ä¼šè¯åœæ­¢æ£€æŸ¥ |
| **å½’æ¡£å¤„ç†** | `archiver/post_archive.py` | ä»»åŠ¡å½’æ¡£ã€æ–‡æ¡£ç”Ÿæˆ |

---

## è¿ç§»æŒ‡å—ï¼ˆv20.x â†’ v21.0ï¼‰

### è‡ªåŠ¨è¿ç§»

è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨è¿ç§»ï¼š

```bash
npm run mc:deploy
# æˆ–
/initmc
```

è¿ç§»è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹ `.claude/workflow-state.json` å¹¶åˆå¹¶åˆ° `task-meta.json`
2. åˆ é™¤ `workflow-state.json`
3. ä¸ºæ‰€æœ‰ `task-meta.json` æ·»åŠ  `architecture_version: "21.0"`
4. åˆ é™¤ `workflow_state`, `workflow_state_ref`, `archived_snapshot` å­—æ®µ

### æ‰‹åŠ¨ä»£ç è¿ç§»

**v20.x ä»£ç ï¼ˆStateManagerï¼‰**:

```python
from core.state_manager import StateManager

state_mgr = StateManager(cwd)
current_step, workflow_state = state_mgr.load_current_state()

# æ›´æ–°çŠ¶æ€
workflow_state['current_step'] = 'step3_execute'
state_mgr.save_full_state(workflow_state, task_meta)
```

**v21.0 ä»£ç ï¼ˆTaskMetaManagerï¼‰**:

```python
from core.task_meta_manager import TaskMetaManager

mgr = TaskMetaManager(cwd)
task_id = mgr.get_active_task_id()
task_meta = mgr.load_task_meta(task_id)
current_step = task_meta.get('current_step')

# åŸå­æ›´æ–°
def update_func(meta):
    meta['current_step'] = 'step3_execute'
    return meta

mgr.atomic_update(task_id, update_func)
```

---

**ç‰ˆæœ¬**: v21.0.0
**æœ€åæ›´æ–°**: 2025-11-15
**ç»´æŠ¤è€…**: NeteaseMod-Claude å·¥ä½œæµå›¢é˜Ÿ

**å˜æ›´æ—¥å¿—**:
- v21.0.0 (2025-11-15): **æ¶æ„é‡æ„ - å•ä¸€æ•°æ®æº**: åˆ é™¤workflow-state.jsonï¼Œä½¿ç”¨TaskMetaManageræ›¿ä»£StateManager
- v20.3.0 (2025-11-15): æ¶æ„é‡æ„ - å››å±‚éªŒè¯é›¶å®¹å¿ + Step2é‡æ–°å¼•å…¥ + æ¨¡å—åŒ–æ ¸å¿ƒ
- v20.2.17 (2025-11-14): æ—§æ¶æ„æœ€åç‰ˆæœ¬ï¼ˆå·²å½’æ¡£ï¼‰
