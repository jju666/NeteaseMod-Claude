# v21.0 æ¶æ„é‡æ„å®æ–½æŒ‡å—

> **ç”Ÿæˆæ—¶é—´**: 2025-11-15
> **æ¶æ„ç‰ˆæœ¬**: v21.0
> **æ ¸å¿ƒå˜æ›´**: task-meta.json ä¸ºå”¯ä¸€æ•°æ®æºï¼Œåˆ é™¤ workflow-state.json

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#1-æ¶æ„æ¦‚è§ˆ)
2. [å·²å®Œæˆå·¥ä½œ](#2-å·²å®Œæˆå·¥ä½œ)
3. [Phase 1: Hookæ–‡ä»¶é‡å†™](#3-phase-1-hookæ–‡ä»¶é‡å†™)
4. [Phase 2: å·¥å…·è„šæœ¬](#4-phase-2-å·¥å…·è„šæœ¬)
5. [Phase 3: æ–‡æ¡£æ›´æ–°](#5-phase-3-æ–‡æ¡£æ›´æ–°)
6. [Phase 4: è¿ç§»ä¸éªŒè¯](#6-phase-4-è¿ç§»ä¸éªŒè¯)
7. [å›æ»šæ–¹æ¡ˆ](#7-å›æ»šæ–¹æ¡ˆ)

---

## 1. æ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒå˜æ›´

| æ–¹é¢ | v20.3.2ï¼ˆæ—§ï¼‰ | v21.0ï¼ˆæ–°ï¼‰ |
|------|--------------|-----------|
| **æ•°æ®æº** | workflow-state.jsonï¼ˆä¸»ï¼‰ + task-meta.jsonï¼ˆå¼•ç”¨ï¼‰ | task-meta.jsonï¼ˆå”¯ä¸€ï¼‰ |
| **æ–‡ä»¶æ•°é‡** | 2ä¸ªï¼ˆworkflow-state + task-metaï¼‰ | 1ä¸ªï¼ˆtask-metaï¼‰ |
| **æ¢å¤é€»è¾‘** | 3ç§æ ¼å¼å…¼å®¹ï¼ˆarchived_snapshot, workflow_state_ref, workflow_stateï¼‰ | 1ç§æ ¼å¼ |
| **æ–‡ä»¶é”** | æ—  | portalockerï¼ˆå¯é€‰ï¼‰ |
| **å¹¶å‘å†²çª** | é«˜ï¼ˆåŒæ–‡ä»¶å†™å…¥ï¼‰ | ä½ï¼ˆå•æ–‡ä»¶+é‡è¯•ï¼‰ |

### 1.2 æ•°æ®ç»“æ„å˜æ›´

**v20.3.2 task-meta.json**:
```json
{
  "task_id": "ä»»åŠ¡-1115-...",
  "architecture_version": "v20.3.2",
  "workflow_state_ref": "../../.claude/workflow-state.json",  // å¼•ç”¨æŒ‡é’ˆ
  "archived_snapshot": null
}
```

**v21.0 task-meta.json**:
```json
{
  "task_id": "ä»»åŠ¡-1115-...",
  "architecture_version": "v21.0",

  // è¿è¡Œæ—¶çŠ¶æ€ï¼ˆç›´æ¥å­˜å‚¨ï¼‰
  "current_step": "step3_execute",
  "steps": {...},
  "bug_fix_tracking": {...},
  "metrics": {...}
}
```

---

## 2. å·²å®Œæˆå·¥ä½œ

### âœ… Phase 1.1: task_meta_manager.py
**æ–‡ä»¶**: `templates/.claude/hooks/core/task_meta_manager.py`

**åŠŸèƒ½**:
- æ–‡ä»¶é”ï¼ˆportalockerï¼‰
- åŸå­å†™å…¥ï¼ˆä¸´æ—¶æ–‡ä»¶+é‡å‘½åï¼‰
- é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼Œ100mså»¶è¿Ÿï¼‰
- æ´»è·ƒä»»åŠ¡ç®¡ç†
- å…¼å®¹æ€§è¿ç§»å‡½æ•°

### âœ… Phase 1.2: user_prompt_handler.py
**æ–‡ä»¶**: `templates/.claude/hooks/orchestrator/user_prompt_handler.py`

**å˜æ›´**:
- å¯¼å…¥ `TaskMetaManager` æ›¿ä»£ `StateManager`
- ç®€åŒ– `resume_existing_task()`ï¼šç›´æ¥ä» task-meta.json åŠ è½½
- ä»»åŠ¡åˆ›å»ºï¼šå®Œæ•´çŠ¶æ€å­˜å‚¨åœ¨ task-meta.json
- åˆ é™¤ workflow-state.json æ‰€æœ‰é€»è¾‘

---

## 3. Phase 1: Hookæ–‡ä»¶é‡å†™

### 3.1 posttooluse_updater.pyï¼ˆâ­é‡è¦ï¼‰

**ä½ç½®**: `templates/.claude/hooks/orchestrator/posttooluse_updater.py`

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç ï¼ˆå»ºè®®ç›´æ¥æ›¿æ¢æ•´ä¸ªæ–‡ä»¶ï¼‰</summary>

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Unified PostToolUse Updater - ç»Ÿä¸€PostToolUseæ›´æ–°å™¨
Version: v21.0

èŒè´£:
1. çº¯ç²¹çš„çŠ¶æ€æ›´æ–°å™¨ï¼ˆé›¶å†³ç­–é€»è¾‘ï¼‰
2. è®°å½•å·¥å…·æ‰§è¡Œç»“æœåˆ° task-meta.json
3. æ£€æµ‹æ­¥éª¤å®Œæˆæ¡ä»¶ï¼Œè‡ªåŠ¨æ¨è¿›å·¥ä½œæµ
4. æ£€æµ‹å¾ªç¯æ¨¡å¼ï¼Œè§¦å‘ä¸“å®¶å®¡æŸ¥
5. ä½¿ç”¨æ–‡ä»¶é”é¿å…å¹¶å‘å†²çª

æ ¸å¿ƒå˜æ›´ï¼ˆv21.0ï¼‰:
- åˆ é™¤ workflow-state.json æ‰€æœ‰é€»è¾‘
- ç›´æ¥æ›´æ–° task-meta.jsonï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
- ä½¿ç”¨ TaskMetaManager çš„åŸå­æ›´æ–° API
"""

import sys
import json
import os
from datetime import datetime
from typing import Dict, Optional, Tuple

# æ·»åŠ coreæ¨¡å—åˆ°sys.path
HOOK_DIR = os.path.dirname(os.path.abspath(__file__))
PARENT_HOOK_DIR = os.path.dirname(HOOK_DIR)
sys.path.insert(0, PARENT_HOOK_DIR)

try:
    from core.task_meta_manager import TaskMetaManager
except ImportError as e:
    sys.stderr.write(f"[ERROR] æ— æ³•å¯¼å…¥ TaskMetaManager: {e}\n")
    # å…œåº•ï¼šé™é»˜é€€å‡º
    print(json.dumps({
        "hookSpecificOutput": {
            "hookEventName": "PostToolUse",
            "additionalContext": ""
        },
        "suppressOutput": True
    }, ensure_ascii=False))
    sys.exit(0)


def silent_exit():
    """é™é»˜é€€å‡ºï¼ˆä¸è¾“å‡ºä»»ä½•å†…å®¹ï¼‰"""
    output = {
        "hookSpecificOutput": {
            "hookEventName": "PostToolUse",
            "additionalContext": ""
        },
        "suppressOutput": True
    }
    print(json.dumps(output, ensure_ascii=False))
    sys.exit(0)


def update_metrics(task_meta: Dict, tool_name: str, tool_input: Dict, is_error: bool):
    """
    æ›´æ–°ä»»åŠ¡åº¦é‡æŒ‡æ ‡

    Args:
        task_meta: ä»»åŠ¡å…ƒæ•°æ®
        tool_name: å·¥å…·åç§°
        tool_input: å·¥å…·è¾“å…¥å‚æ•°
        is_error: æ˜¯å¦å‘ç”Ÿé”™è¯¯
    """
    # åˆå§‹åŒ– metrics å­—æ®µ
    if 'metrics' not in task_meta:
        task_meta['metrics'] = {
            'tools_used': [],
            'code_changes': [],
            'docs_read': [],
            'failed_operations': []
        }

    metrics = task_meta['metrics']

    # è®°å½•å·¥å…·ä½¿ç”¨
    metrics['tools_used'].append({
        'tool': tool_name,
        'timestamp': datetime.now().isoformat(),
        'success': not is_error
    })

    # è®°å½•ä»£ç ä¿®æ”¹
    if tool_name in ['Edit', 'Write']:
        file_path = tool_input.get('file_path', '')
        if file_path:
            metrics['code_changes'].append({
                'file': file_path,
                'tool': tool_name,
                'timestamp': datetime.now().isoformat(),
                'success': not is_error
            })

    # è®°å½•æ–‡æ¡£é˜…è¯»
    if tool_name == 'Read':
        file_path = tool_input.get('file_path', '')
        if file_path and ('markdown' in file_path or '.md' in file_path):
            metrics['docs_read'].append({
                'file': file_path,
                'timestamp': datetime.now().isoformat()
            })

    # è®°å½•å¤±è´¥æ“ä½œ
    if is_error:
        metrics['failed_operations'].append({
            'tool': tool_name,
            'input': tool_input,
            'timestamp': datetime.now().isoformat()
        })


def detect_loop_indicators(task_meta: Dict) -> bool:
    """
    æ£€æµ‹å¾ªç¯æŒ‡æ ‡ï¼ˆç”¨äºBUGä¿®å¤ä»»åŠ¡ï¼‰

    Returns:
        bool: æ˜¯å¦è§¦å‘å¾ªç¯è­¦å‘Š
    """
    bug_fix_tracking = task_meta.get('bug_fix_tracking', {})
    if not bug_fix_tracking.get('enabled'):
        return False

    loop_indicators = bug_fix_tracking.get('loop_indicators', {})

    # æ£€æµ‹å¾ªç¯é˜ˆå€¼
    same_file_count = loop_indicators.get('same_file_edit_count', 0)
    failed_test_count = loop_indicators.get('failed_test_count', 0)
    negative_feedback = loop_indicators.get('negative_feedback_count', 0)

    # è§¦å‘æ¡ä»¶ï¼šåŒæ–‡ä»¶ä¿®æ”¹3æ¬¡ æˆ– æµ‹è¯•å¤±è´¥2æ¬¡ æˆ– è´Ÿé¢åé¦ˆ2æ¬¡
    if same_file_count >= 3 or failed_test_count >= 2 or negative_feedback >= 2:
        return True

    return False


def update_bug_fix_tracking(task_meta: Dict, tool_name: str, tool_input: Dict, is_error: bool):
    """
    æ›´æ–°BUGä¿®å¤è¿½è¸ªçŠ¶æ€

    Args:
        task_meta: ä»»åŠ¡å…ƒæ•°æ®
        tool_name: å·¥å…·åç§°
        tool_input: å·¥å…·è¾“å…¥å‚æ•°
        is_error: æ˜¯å¦å‘ç”Ÿé”™è¯¯
    """
    bug_fix_tracking = task_meta.get('bug_fix_tracking', {})
    if not bug_fix_tracking.get('enabled'):
        return

    loop_indicators = bug_fix_tracking.setdefault('loop_indicators', {
        'same_file_edit_count': 0,
        'failed_test_count': 0,
        'negative_feedback_count': 0
    })

    # æ›´æ–°åŒæ–‡ä»¶ä¿®æ”¹è®¡æ•°
    if tool_name in ['Edit', 'Write']:
        file_path = tool_input.get('file_path', '')
        metrics = task_meta.get('metrics', {})
        code_changes = metrics.get('code_changes', [])

        # è®¡ç®—åŒä¸€æ–‡ä»¶çš„ä¿®æ”¹æ¬¡æ•°
        same_file_count = sum(1 for change in code_changes if change.get('file') == file_path)
        loop_indicators['same_file_edit_count'] = max(loop_indicators['same_file_edit_count'], same_file_count)

    # æ›´æ–°æµ‹è¯•å¤±è´¥è®¡æ•°
    if tool_name == 'Bash' and is_error:
        bash_cmd = tool_input.get('command', '')
        if 'test' in bash_cmd.lower() or 'pytest' in bash_cmd.lower():
            loop_indicators['failed_test_count'] += 1


def main():
    """ä¸»å…¥å£"""
    # 1. è§£æè¾“å…¥
    try:
        event_data = json.loads(sys.stdin.read())
    except json.JSONDecodeError as e:
        sys.stderr.write(f"[ERROR] JSONè§£æå¤±è´¥: {e}\n")
        silent_exit()
        return

    tool_name = event_data.get("toolName", "")
    tool_input = event_data.get("toolInput", {})
    tool_result = event_data.get("toolResult", "")
    is_error = event_data.get("isError", False)

    # 2. è·å–å·¥ä½œç›®å½•
    cwd = os.getcwd()

    # 3. åˆå§‹åŒ– TaskMetaManager
    mgr = TaskMetaManager(cwd)

    # 4. è·å–æ´»è·ƒä»»åŠ¡ID
    task_id = mgr.get_active_task_id()
    if not task_id:
        silent_exit()
        return

    # 5. åŸå­æ›´æ–°ä»»åŠ¡å…ƒæ•°æ®
    def update_func(task_meta: Dict) -> Dict:
        """æ›´æ–°å‡½æ•°ï¼ˆåœ¨é”å†…æ‰§è¡Œï¼‰"""
        # æ›´æ–°åº¦é‡æŒ‡æ ‡
        update_metrics(task_meta, tool_name, tool_input, is_error)

        # æ›´æ–°BUGä¿®å¤è¿½è¸ª
        update_bug_fix_tracking(task_meta, tool_name, tool_input, is_error)

        # æ£€æµ‹å¾ªç¯å¹¶æ ‡è®°
        if detect_loop_indicators(task_meta):
            bug_fix_tracking = task_meta.get('bug_fix_tracking', {})
            if not bug_fix_tracking.get('expert_triggered'):
                bug_fix_tracking['expert_triggered'] = True
                sys.stderr.write("[PostToolUse] æ£€æµ‹åˆ°å¾ªç¯æ¨¡å¼ï¼Œæ ‡è®°ä¸“å®¶è§¦å‘\n")

        return task_meta

    updated_meta = mgr.atomic_update(task_id, update_func)

    if not updated_meta:
        sys.stderr.write("[ERROR] åŸå­æ›´æ–°å¤±è´¥\n")
        silent_exit()
        return

    # 6. é™é»˜é€€å‡º
    silent_exit()


if __name__ == "__main__":
    main()
```

</details>

**å…³é”®å˜æ›´**:
1. å¯¼å…¥ `TaskMetaManager` æ›¿ä»£ `StateManager`
2. ä½¿ç”¨ `mgr.atomic_update()` è¿›è¡ŒåŸå­æ›´æ–°
3. åˆ é™¤æ‰€æœ‰ workflow-state.json è¯»å†™é€»è¾‘
4. ç®€åŒ–çŠ¶æ€æ›´æ–°é€»è¾‘ï¼ˆç›´æ¥æ“ä½œ task_metaï¼‰

---

### 3.2 pretooluse_enforcer.py

**ä½ç½®**: `templates/.claude/hooks/orchestrator/pretooluse_enforcer.py`

**æ ¸å¿ƒé€»è¾‘**:
```python
# å¯¼å…¥éƒ¨åˆ†
from core.task_meta_manager import TaskMetaManager

# ä¸»å‡½æ•°ä¿®æ”¹
def main():
    cwd = os.getcwd()
    mgr = TaskMetaManager(cwd)

    task_id = mgr.get_active_task_id()
    if not task_id:
        allow_execution()
        return

    # åŠ è½½ä»»åŠ¡å…ƒæ•°æ®
    task_meta = mgr.load_task_meta(task_id)
    if not task_meta:
        allow_execution()
        return

    # æ£€æŸ¥æ­¥éª¤é¡ºåº
    current_step = task_meta.get('current_step', 'step3_execute')

    # æ­¥éª¤é¡ºåºæ£€æŸ¥é€»è¾‘...
    # ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼Œåªéœ€å°† workflow_state æ›¿æ¢ä¸º task_metaï¼‰
```

**ä¿®æ”¹è¦ç‚¹**:
- å°†æ‰€æœ‰ `workflow_state` å¼•ç”¨æ”¹ä¸º `task_meta`
- ä½¿ç”¨ `mgr.load_task_meta(task_id)` åŠ è½½çŠ¶æ€
- åˆ é™¤ `StateManager` ç›¸å…³ä»£ç 

---

### 3.3 session_start.py

**ä½ç½®**: `templates/.claude/hooks/lifecycle/session_start.py`

**ç®€åŒ–é€»è¾‘**:
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Session Start Hook - ä¼šè¯å¯åŠ¨é’©å­ (v21.0)

èŒè´£:
1. åŠ è½½æ´»è·ƒä»»åŠ¡çš„ task-meta.json
2. æ›´æ–°ä¼šè¯å¯åŠ¨æ—¶é—´
3. ç®€åŒ–æ¢å¤é€»è¾‘ï¼ˆæ— éœ€é‡å»º workflow-state.jsonï¼‰
"""

import sys
import json
import os
from datetime import datetime

# å¯¼å…¥ TaskMetaManager
HOOK_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, HOOK_DIR)

try:
    from core.task_meta_manager import TaskMetaManager
except ImportError:
    sys.stderr.write("[WARN] TaskMetaManager æ¨¡å—ç¼ºå¤±\n")
    TaskMetaManager = None

def main():
    cwd = os.getcwd()

    if not TaskMetaManager:
        sys.exit(0)

    mgr = TaskMetaManager(cwd)

    # è·å–æ´»è·ƒä»»åŠ¡
    task_id = mgr.get_active_task_id()
    if not task_id:
        sys.stderr.write("[INFO] æ— æ´»è·ƒä»»åŠ¡ï¼Œè·³è¿‡ä¼šè¯æ¢å¤\n")
        sys.exit(0)

    # åŠ è½½ä»»åŠ¡å…ƒæ•°æ®
    task_meta = mgr.load_task_meta(task_id)
    if not task_meta:
        sys.stderr.write(f"[ERROR] åŠ è½½ä»»åŠ¡å…ƒæ•°æ®å¤±è´¥: {task_id}\n")
        sys.exit(0)

    # æ›´æ–°ä¼šè¯å¯åŠ¨æ—¶é—´
    task_meta['session_started_at'] = datetime.now().isoformat()

    # ä¿å­˜æ›´æ–°
    mgr.save_task_meta(task_id, task_meta)

    sys.stderr.write(f"[INFO v21.0] ä¼šè¯å·²æ¢å¤: {task_id}\n")
    sys.exit(0)

if __name__ == "__main__":
    main()
```

**å…³é”®å˜æ›´**:
- åˆ é™¤ workflow-state.json é‡å»ºé€»è¾‘
- ä»…æ›´æ–° session_started_at æ—¶é—´æˆ³
- å¤§å¹…ç®€åŒ–ä»£ç ï¼ˆä»200è¡Œ â†’ 50è¡Œï¼‰

---

### 3.4 session_end.py

**ä½ç½®**: `templates/.claude/hooks/lifecycle/session_end.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Session End Hook - ä¼šè¯ç»“æŸé’©å­ (v21.0)

èŒè´£:
1. æ›´æ–°ä¼šè¯ç»“æŸæ—¶é—´
2. ä¸åˆ é™¤ä»»ä½•æ–‡ä»¶ï¼ˆtask-meta.json ä¿ç•™ï¼‰
"""

import sys
import os
from datetime import datetime

HOOK_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, HOOK_DIR)

try:
    from core.task_meta_manager import TaskMetaManager
except ImportError:
    sys.exit(0)

def main():
    cwd = os.getcwd()
    mgr = TaskMetaManager(cwd)

    task_id = mgr.get_active_task_id()
    if not task_id:
        sys.exit(0)

    # æ›´æ–°ä¼šè¯ç»“æŸæ—¶é—´
    def update_func(task_meta):
        task_meta['session_ended_at'] = datetime.now().isoformat()
        return task_meta

    mgr.atomic_update(task_id, update_func)

    sys.stderr.write(f"[INFO v21.0] ä¼šè¯å·²ç»“æŸ: {task_id}\n")
    sys.exit(0)

if __name__ == "__main__":
    main()
```

**å…³é”®å˜æ›´**:
- åˆ é™¤ workflow-state.json æ¸…ç†é€»è¾‘
- ä»…æ›´æ–°æ—¶é—´æˆ³

---

### 3.5 stop.py

**ä½ç½®**: `templates/.claude/hooks/lifecycle/stop.py`

```python
# æ ¸å¿ƒé€»è¾‘ä¿®æ”¹
def check_user_confirmation(task_id, cwd):
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¡®è®¤ä»»åŠ¡å®Œæˆ"""
    mgr = TaskMetaManager(cwd)
    task_meta = mgr.load_task_meta(task_id)

    if not task_meta:
        return False

    # æ£€æŸ¥æ­¥éª¤çŠ¶æ€
    steps = task_meta.get('steps', {})
    step3 = steps.get('step3_execute', {})

    return step3.get('user_confirmed', False)
```

**ä¿®æ”¹è¦ç‚¹**:
- ä» task_meta è¯»å– steps å’Œ user_confirmed
- åˆ é™¤ workflow-state.json æ£€æŸ¥

---

### 3.6 post_archive.py

**ä½ç½®**: `templates/.claude/hooks/archiver/post_archive.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Post Archive Hook - ä»»åŠ¡å½’æ¡£é’©å­ (v21.0)

èŒè´£:
1. æ ‡è®°ä»»åŠ¡ä¸ºå·²å½’æ¡£
2. ç®€åŒ–é€»è¾‘ï¼ˆæ— éœ€åˆ›å»ºå¿«ç…§ï¼Œtask-meta.json å·²åŒ…å«å®Œæ•´çŠ¶æ€ï¼‰
"""

import sys
import os
from datetime import datetime

HOOK_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, HOOK_DIR)

try:
    from core.task_meta_manager import TaskMetaManager
except ImportError:
    sys.exit(0)

def main():
    cwd = os.getcwd()
    mgr = TaskMetaManager(cwd)

    task_id = mgr.get_active_task_id()
    if not task_id:
        sys.exit(0)

    # æ ‡è®°ä¸ºå·²å½’æ¡£
    def update_func(task_meta):
        task_meta['archived'] = True
        task_meta['archived_at'] = datetime.now().isoformat()
        return task_meta

    mgr.atomic_update(task_id, update_func)

    # æ¸…é™¤æ´»è·ƒä»»åŠ¡æ ‡è®°
    mgr.clear_active_task()

    sys.stderr.write(f"[INFO v21.0] ä»»åŠ¡å·²å½’æ¡£: {task_id}\n")
    sys.exit(0)

if __name__ == "__main__":
    main()
```

**å…³é”®å˜æ›´**:
- åˆ é™¤å¿«ç…§åˆ›å»ºé€»è¾‘ï¼ˆarchived_snapshotï¼‰
- ä»…æ ‡è®° archived å­—æ®µä¸º true

---

### 3.7 cleanup_subagent_stop.py

**ä½ç½®**: `templates/.claude/hooks/lifecycle/cleanup_subagent_stop.py`

**ä¿®æ”¹è¦ç‚¹**:
```python
# ä½¿ç”¨ TaskMetaManager è¯»å†™çŠ¶æ€
mgr = TaskMetaManager(cwd)
task_id = mgr.get_active_task_id()

# æ›´æ–°æ­¥éª¤çŠ¶æ€
def update_func(task_meta):
    steps = task_meta.get('steps', {})
    steps['step4_cleanup']['status'] = 'completed'
    return task_meta

mgr.atomic_update(task_id, update_func)
```

---

### 3.8 åˆ é™¤æ—§çš„ state_manager.py

```bash
# åˆ é™¤æ–‡ä»¶
rm templates/.claude/hooks/core/state_manager.py
```

**é‡è¦**: ç¡®ä¿æ‰€æœ‰ Hook å·²è¿ç§»åˆ° TaskMetaManager åå†åˆ é™¤ï¼

---

## 4. Phase 2: å·¥å…·è„šæœ¬

### 4.1 è¿ç§»è„šæœ¬ migrate-to-v21.js

**ä½ç½®**: `lib/migrate-to-v21.js`

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´ä»£ç </summary>

```javascript
#!/usr/bin/env node
/**
 * v21.0 æ¶æ„è¿ç§»è„šæœ¬
 *
 * åŠŸèƒ½:
 * 1. æ£€æµ‹ tasks/ ç›®å½•ä¸‹æ‰€æœ‰ä»»åŠ¡
 * 2. è¯†åˆ« v20.x æ ¼å¼çš„ task-meta.json
 * 3. åˆå¹¶ workflow-state.json åˆ° task-meta.json
 * 4. æ›´æ–° architecture_version ä¸º v21.0
 * 5. å¤‡ä»½åŸæ–‡ä»¶ï¼ˆ.backup-v20ï¼‰
 */

const fs = require('fs');
const path = require('path');

// é…ç½®
const TASKS_DIR = path.join(process.cwd(), 'tasks');
const WORKFLOW_STATE_PATH = path.join(process.cwd(), '.claude', 'workflow-state.json');

// é¢œè‰²è¾“å‡º
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m'
};

function log(msg, color = 'reset') {
  console.log(`${colors[color]}${msg}${colors.reset}`);
}

/**
 * è¿ç§»å•ä¸ªä»»åŠ¡
 */
function migrateTask(taskId, taskDir) {
  const metaPath = path.join(taskDir, '.task-meta.json');

  // 1. æ£€æŸ¥ task-meta.json æ˜¯å¦å­˜åœ¨
  if (!fs.existsSync(metaPath)) {
    log(`  âš ï¸  ç¼ºå°‘ .task-meta.jsonï¼Œè·³è¿‡`, 'yellow');
    return { success: false, reason: 'missing_meta' };
  }

  // 2. è¯»å– task-meta.json
  let taskMeta;
  try {
    const content = fs.readFileSync(metaPath, 'utf-8');
    taskMeta = JSON.parse(content);
  } catch (err) {
    log(`  âŒ è§£æå¤±è´¥: ${err.message}`, 'red');
    return { success: false, reason: 'parse_error' };
  }

  // 3. æ£€æŸ¥æ¶æ„ç‰ˆæœ¬
  const archVersion = taskMeta.architecture_version || 'unknown';

  if (archVersion === 'v21.0') {
    log(`  âœ… å·²æ˜¯ v21.0ï¼Œè·³è¿‡`, 'green');
    return { success: true, reason: 'already_v21' };
  }

  // 4. å¤‡ä»½åŸæ–‡ä»¶
  const backupPath = metaPath + '.backup-v20';
  fs.writeFileSync(backupPath, JSON.stringify(taskMeta, null, 2), 'utf-8');
  log(`  ğŸ’¾ å·²å¤‡ä»½åˆ° ${path.basename(backupPath)}`, 'blue');

  // 5. åˆå¹¶ workflow_state
  let workflowState = {};

  // 5.1 å°è¯•ä» workflow_state_ref è¯»å–
  if (taskMeta.workflow_state_ref && fs.existsSync(WORKFLOW_STATE_PATH)) {
    try {
      const content = fs.readFileSync(WORKFLOW_STATE_PATH, 'utf-8');
      const ws = JSON.parse(content);

      // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ä»»åŠ¡çš„çŠ¶æ€
      if (ws.task_id === taskId) {
        workflowState = ws;
        log(`  ğŸ“„ ä» workflow-state.json åŠ è½½çŠ¶æ€`, 'blue');
      }
    } catch (err) {
      log(`  âš ï¸  workflow-state.json è¯»å–å¤±è´¥`, 'yellow');
    }
  }

  // 5.2 å°è¯•ä» archived_snapshot è¯»å–
  if (taskMeta.archived_snapshot && Object.keys(workflowState).length === 0) {
    workflowState = taskMeta.archived_snapshot;
    log(`  ğŸ“„ ä» archived_snapshot åŠ è½½çŠ¶æ€`, 'blue');
  }

  // 5.3 å°è¯•ä» workflow_state å­—æ®µè¯»å–ï¼ˆæ—§æ ¼å¼ï¼‰
  if (taskMeta.workflow_state && Object.keys(workflowState).length === 0) {
    workflowState = taskMeta.workflow_state;
    log(`  ğŸ“„ ä» workflow_state å­—æ®µåŠ è½½çŠ¶æ€`, 'blue');
  }

  // 6. æ„å»º v21.0 æ ¼å¼
  const migratedMeta = {
    // åŸºç¡€å…ƒæ•°æ®
    task_id: taskMeta.task_id,
    task_description: taskMeta.task_description,
    task_type: taskMeta.task_type || workflowState.task_type || 'general',
    task_complexity: taskMeta.task_complexity || 'standard',
    created_at: taskMeta.created_at || workflowState.created_at,
    updated_at: new Date().toISOString(),
    architecture_version: 'v21.0',

    // è¿è¡Œæ—¶çŠ¶æ€ï¼ˆä» workflow_state åˆå¹¶ï¼‰
    current_step: workflowState.current_step || 'step3_execute',
    last_injection_step: workflowState.last_injection_step || null,
    steps: workflowState.steps || {},
    gameplay_pack_matched: workflowState.gameplay_pack_matched || null,
    gameplay_pack_name: workflowState.gameplay_pack_name || null,

    // BUGä¿®å¤è¿½è¸ªï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    ...(workflowState.bug_fix_tracking && { bug_fix_tracking: workflowState.bug_fix_tracking }),

    // åº¦é‡æŒ‡æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    ...(workflowState.metrics && { metrics: workflowState.metrics }),

    // å½’æ¡£ä¿¡æ¯
    archived: taskMeta.archived || false,
    ...(taskMeta.archived_at && { archived_at: taskMeta.archived_at }),

    // è¿ç§»å…ƒæ•°æ®
    migrated_from: archVersion,
    migrated_at: new Date().toISOString()
  };

  // 7. ä¿å­˜è¿ç§»åçš„æ–‡ä»¶
  try {
    fs.writeFileSync(metaPath, JSON.stringify(migratedMeta, null, 2), 'utf-8');
    log(`  âœ… è¿ç§»æˆåŠŸ: ${archVersion} â†’ v21.0`, 'green');
    return { success: true, from: archVersion };
  } catch (err) {
    log(`  âŒ ä¿å­˜å¤±è´¥: ${err.message}`, 'red');
    return { success: false, reason: 'save_error' };
  }
}

/**
 * ä¸»å‡½æ•°
 */
function main() {
  log('========================================', 'blue');
  log('  v21.0 æ¶æ„è¿ç§»è„šæœ¬', 'blue');
  log('========================================\n', 'blue');

  // 1. æ£€æŸ¥ tasks ç›®å½•
  if (!fs.existsSync(TASKS_DIR)) {
    log('âŒ tasks/ ç›®å½•ä¸å­˜åœ¨', 'red');
    process.exit(1);
  }

  // 2. è·å–æ‰€æœ‰ä»»åŠ¡ç›®å½•
  const taskDirs = fs.readdirSync(TASKS_DIR)
    .filter(name => {
      const fullPath = path.join(TASKS_DIR, name);
      return fs.statSync(fullPath).isDirectory() && name.startsWith('ä»»åŠ¡-');
    });

  if (taskDirs.length === 0) {
    log('âš ï¸  æœªæ‰¾åˆ°ä»»ä½•ä»»åŠ¡', 'yellow');
    process.exit(0);
  }

  log(`ğŸ“¦ æ‰¾åˆ° ${taskDirs.length} ä¸ªä»»åŠ¡\n`, 'blue');

  // 3. è¿ç§»æ¯ä¸ªä»»åŠ¡
  const results = {
    total: taskDirs.length,
    success: 0,
    skip: 0,
    fail: 0
  };

  taskDirs.forEach((taskId, index) => {
    log(`[${index + 1}/${taskDirs.length}] ${taskId}`, 'blue');

    const taskDir = path.join(TASKS_DIR, taskId);
    const result = migrateTask(taskId, taskDir);

    if (result.success) {
      if (result.reason === 'already_v21') {
        results.skip++;
      } else {
        results.success++;
      }
    } else {
      results.fail++;
    }

    console.log('');
  });

  // 4. è¾“å‡ºç»Ÿè®¡
  log('========================================', 'blue');
  log('  è¿ç§»å®Œæˆ', 'blue');
  log('========================================', 'blue');
  log(`æ€»è®¡: ${results.total}`, 'blue');
  log(`âœ… æˆåŠŸ: ${results.success}`, 'green');
  log(`â­ï¸  è·³è¿‡: ${results.skip}`, 'yellow');
  log(`âŒ å¤±è´¥: ${results.fail}`, 'red');

  if (results.fail > 0) {
    log('\nâš ï¸  éƒ¨åˆ†ä»»åŠ¡è¿ç§»å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—', 'yellow');
    process.exit(1);
  }

  log('\nâœ… æ‰€æœ‰ä»»åŠ¡è¿ç§»æˆåŠŸï¼', 'green');
  process.exit(0);
}

// æ‰§è¡Œ
if (require.main === module) {
  main();
}

module.exports = { migrateTask };
```

</details>

**ä½¿ç”¨æ–¹æ³•**:
```bash
cd /path/to/project
node lib/migrate-to-v21.js
```

---

### 4.2 æ›´æ–° init-workflow.js

**ä½ç½®**: `lib/init-workflow.js`

**ä¿®æ”¹ç‚¹**:
```javascript
// æŸ¥æ‰¾ task-meta.json åˆ›å»ºéƒ¨åˆ†
const taskMeta = {
  task_id: taskId,
  task_description: taskDesc,
  task_type: 'general',
  task_complexity: 'standard',
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  architecture_version: 'v21.0',  // â† æ”¹ä¸º v21.0

  // v21.0: ç›´æ¥å­˜å‚¨è¿è¡Œæ—¶çŠ¶æ€
  current_step: 'step0_context',
  steps: {
    step0_context: { status: 'pending', ... },
    step1_understand: { status: 'pending', ... },
    step3_execute: { status: 'pending', ... },
    step4_cleanup: { status: 'pending', ... }
  }
};

// åˆ é™¤ workflow-state.json åˆ›å»ºé€»è¾‘
// åˆ é™¤ workflow_state_ref å­—æ®µ
```

---

## 5. Phase 3: æ–‡æ¡£æ›´æ–°

### 5.1 task-meta.jsonæ–‡ä»¶ç»“æ„.md

**ä½ç½®**: `docs/developer/task-meta.jsonæ–‡ä»¶ç»“æ„.md`

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹</summary>

```markdown
# task-meta.json æ–‡ä»¶ç»“æ„è¯´æ˜ï¼ˆv21.0ï¼‰

> **æ¶æ„ç‰ˆæœ¬**: v21.0
> **æ ¸å¿ƒåŸåˆ™**: task-meta.json æ˜¯ä»»åŠ¡çš„å”¯ä¸€æ•°æ®æº

---

## 1. æ¶æ„å˜æ›´æ€»ç»“

### v20.3.2 â†’ v21.0 å¯¹æ¯”

| å­—æ®µ | v20.3.2 | v21.0 |
|------|---------|-------|
| `workflow_state_ref` | âœ… å¼•ç”¨æŒ‡é’ˆ | âŒ åˆ é™¤ |
| `archived_snapshot` | âœ… å½’æ¡£å¿«ç…§ | âŒ åˆ é™¤ |
| `current_step` | âŒ åœ¨ workflow-state.json | âœ… ç›´æ¥å­˜å‚¨ |
| `steps` | âŒ åœ¨ workflow-state.json | âœ… ç›´æ¥å­˜å‚¨ |
| `bug_fix_tracking` | âŒ åœ¨ workflow-state.json | âœ… ç›´æ¥å­˜å‚¨ |
| `metrics` | âŒ åœ¨ workflow-state.json | âœ… ç›´æ¥å­˜å‚¨ |

---

## 2. å®Œæ•´æ•°æ®ç»“æ„

### 2.1 åŸºç¡€å…ƒæ•°æ®

```json
{
  "task_id": "ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»",
  "task_description": "ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»ä¾æ—§æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„BUG",
  "task_type": "bug_fix",
  "task_complexity": "standard",
  "created_at": "2025-11-15T07:18:21.395895",
  "updated_at": "2025-11-15T07:23:45.123456",
  "architecture_version": "v21.0"
}
```

### 2.2 è¿è¡Œæ—¶çŠ¶æ€

```json
{
  "current_step": "step3_execute",
  "last_injection_step": null,
  "steps": {
    "step0_context": {
      "description": "é˜…è¯»é¡¹ç›®CLAUDE.md",
      "status": "skipped",
      "prompt": "ï¼ˆç©æ³•åŒ…æ¨¡å¼ï¼šå·²è·³è¿‡ï¼‰"
    },
    "step1_understand": {
      "description": "ç†è§£ä»»åŠ¡éœ€æ±‚",
      "status": "skipped",
      "prompt": "ï¼ˆç©æ³•åŒ…æ¨¡å¼ï¼šå·²è·³è¿‡ï¼‰"
    },
    "step3_execute": {
      "description": "æ‰§è¡Œå®æ–½",
      "status": "in_progress",
      "started_at": "2025-11-15T07:18:21.500000",
      "user_confirmed": false,
      "prompt": "åŸºäºç©æ³•åŒ…ä»£ç å®ç°åŠŸèƒ½ï¼Œæµ‹è¯•éªŒè¯"
    },
    "step4_cleanup": {
      "description": "æ”¶å°¾å½’æ¡£",
      "status": "pending",
      "prompt": "æ¸…ç†DEBUGä»£ç ï¼Œæ›´æ–°æ–‡æ¡£ï¼Œå½’æ¡£ä»»åŠ¡"
    }
  }
}
```

### 2.3 BUGä¿®å¤è¿½è¸ªï¼ˆå¯é€‰ï¼‰

```json
{
  "bug_fix_tracking": {
    "enabled": true,
    "matched_gameplay_pack": null,
    "bug_description": "ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»ä¾æ—§æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„BUG",
    "iterations": [],
    "loop_indicators": {
      "same_file_edit_count": 0,
      "failed_test_count": 0,
      "negative_feedback_count": 0,
      "time_spent_minutes": 0
    },
    "expert_triggered": false
  }
}
```

### 2.4 åº¦é‡æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰

```json
{
  "metrics": {
    "tools_used": [
      {"tool": "Read", "timestamp": "...", "success": true},
      {"tool": "Edit", "timestamp": "...", "success": true}
    ],
    "code_changes": [
      {"file": "path/to/file.py", "tool": "Edit", "timestamp": "...", "success": true}
    ],
    "docs_read": [
      {"file": "markdown/core/å¼€å‘è§„èŒƒ.md", "timestamp": "..."}
    ],
    "failed_operations": []
  }
}
```

### 2.5 å½’æ¡£ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

```json
{
  "archived": true,
  "archived_at": "2025-11-15T08:00:00.000000"
}
```

---

## 3. å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `task_id` | string | âœ… | ä»»åŠ¡å”¯ä¸€æ ‡è¯†ç¬¦ |
| `task_description` | string | âœ… | ä»»åŠ¡æè¿° |
| `task_type` | string | âœ… | ä»»åŠ¡ç±»å‹ï¼ˆbug_fix, feature_implementation, generalï¼‰ |
| `task_complexity` | string | âœ… | ä»»åŠ¡å¤æ‚åº¦ï¼ˆstandard, complexï¼‰ |
| `created_at` | ISO8601 | âœ… | åˆ›å»ºæ—¶é—´ |
| `updated_at` | ISO8601 | âœ… | æœ€åæ›´æ–°æ—¶é—´ |
| `architecture_version` | string | âœ… | æ¶æ„ç‰ˆæœ¬ï¼ˆv21.0ï¼‰ |
| `current_step` | string | âœ… | å½“å‰æ­¥éª¤ï¼ˆstep0_context, step1_understand, step3_execute, step4_cleanupï¼‰ |
| `last_injection_step` | string | âŒ | æœ€åæ³¨å…¥æ­¥éª¤ |
| `steps` | object | âœ… | æ­¥éª¤çŠ¶æ€å­—å…¸ |
| `bug_fix_tracking` | object | âŒ | BUGä¿®å¤è¿½è¸ªï¼ˆä»…bug_fixç±»å‹ï¼‰ |
| `metrics` | object | âŒ | åº¦é‡æŒ‡æ ‡ |
| `archived` | boolean | âŒ | æ˜¯å¦å·²å½’æ¡£ |
| `archived_at` | ISO8601 | âŒ | å½’æ¡£æ—¶é—´ |

---

## 4. ä½¿ç”¨ç¤ºä¾‹

### 4.1 Python è¯»å–

```python
from core.task_meta_manager import TaskMetaManager

mgr = TaskMetaManager('/path/to/project')
task_meta = mgr.load_task_meta('ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»')

# è®¿é—®å­—æ®µ
current_step = task_meta['current_step']
steps = task_meta['steps']
```

### 4.2 Python æ›´æ–°

```python
# åŸå­æ›´æ–°
def update_func(task_meta):
    task_meta['current_step'] = 'step4_cleanup'
    task_meta['steps']['step3_execute']['status'] = 'completed'
    return task_meta

mgr.atomic_update(task_id, update_func)
```

### 4.3 JavaScript è¯»å–

```javascript
const fs = require('fs');
const path = require('path');

const metaPath = path.join(cwd, 'tasks', taskId, '.task-meta.json');
const taskMeta = JSON.parse(fs.readFileSync(metaPath, 'utf-8'));

console.log(taskMeta.current_step);
```

---

## 5. è¿ç§»æŒ‡å—

### ä» v20.3.2 è¿ç§»

```bash
# ä½¿ç”¨è‡ªåŠ¨è¿ç§»è„šæœ¬
node lib/migrate-to-v21.js

# éªŒè¯è¿ç§»ç»“æœ
cat tasks/ä»»åŠ¡-XXXX-XXXXXX-æè¿°/.task-meta.json | jq '.architecture_version'
# è¾“å‡º: "v21.0"
```

### æ‰‹åŠ¨è¿ç§»æ­¥éª¤

1. è¯»å– `.claude/workflow-state.json`
2. è¯»å– `tasks/{task_id}/.task-meta.json`
3. åˆå¹¶ workflow_state å­—æ®µåˆ° task-meta
4. åˆ é™¤ `workflow_state_ref`, `archived_snapshot`
5. æ›´æ–° `architecture_version` ä¸º `v21.0`
6. ä¿å­˜

---

## 6. å¸¸è§é—®é¢˜

**Q: v21.0 è¿˜éœ€è¦ workflow-state.json å—ï¼Ÿ**
A: ä¸éœ€è¦ã€‚æ‰€æœ‰çŠ¶æ€éƒ½å­˜å‚¨åœ¨ task-meta.json ä¸­ã€‚

**Q: å¦‚ä½•æ¢å¤ä»»åŠ¡ï¼Ÿ**
A: ç›´æ¥åŠ è½½ task-meta.json å³å¯ï¼Œæ— éœ€é‡å»ºçŠ¶æ€ã€‚

**Q: å½’æ¡£ä»»åŠ¡å¦‚ä½•å¤„ç†ï¼Ÿ**
A: æ ‡è®° `archived: true`ï¼Œtask-meta.json ä¿ç•™å®Œæ•´å†å²ã€‚

**Q: å¤šä»»åŠ¡å¹¶å‘ä¼šæœ‰å†²çªå—ï¼Ÿ**
A: TaskMetaManager ä½¿ç”¨æ–‡ä»¶é”å’Œé‡è¯•æœºåˆ¶ï¼Œé¿å…å†²çªã€‚

---

_æœ€åæ›´æ–°: 2025-11-15 | v21.0_
```

</details>

---

### 5.2 HookçŠ¶æ€æœºæœºåˆ¶.md

**ä½ç½®**: `docs/developer/HookçŠ¶æ€æœºæœºåˆ¶.md`

**æ›´æ–°å†…å®¹**:

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹æ ¸å¿ƒå˜æ›´</summary>

```markdown
# æ•°æ®æµå›¾ï¼ˆv21.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           v21.0 æ•°æ®æµæ¶æ„                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   task-meta.json                      â”‚  â”‚
â”‚  â”‚   å”¯ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ - task_id, task_description           â”‚  â”‚
â”‚  â”‚ - current_step, steps{}               â”‚  â”‚
â”‚  â”‚ - bug_fix_tracking.iterations[]       â”‚  â”‚
â”‚  â”‚ - metrics.code_changes[]              â”‚  â”‚
â”‚  â”‚ - æ‰€æœ‰è¿è¡Œæ—¶çŠ¶æ€                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                           â”‚
â”‚                 â”‚ è¯»å†™ï¼ˆç›´æ¥æ“ä½œï¼‰           â”‚
â”‚                 â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   TaskMetaManager                     â”‚  â”‚
â”‚  â”‚   çŠ¶æ€ç®¡ç†å™¨ï¼ˆå¸¦æ–‡ä»¶é”ï¼‰              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ - atomic_update()ï¼ˆåŸå­æ›´æ–°ï¼‰         â”‚  â”‚
â”‚  â”‚ - load_task_meta()ï¼ˆåŠ è½½ï¼‰            â”‚  â”‚
â”‚  â”‚ - save_task_meta()ï¼ˆä¿å­˜ï¼‰            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                           â”‚
â”‚                 â”‚ Hookè°ƒç”¨                   â”‚
â”‚                 â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Hooks                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ - user_prompt_handler.py              â”‚  â”‚
â”‚  â”‚ - posttooluse_updater.py              â”‚  â”‚
â”‚  â”‚ - pretooluse_enforcer.py              â”‚  â”‚
â”‚  â”‚ - session_start.py                    â”‚  â”‚
â”‚  â”‚ - stop.py                             â”‚  â”‚
â”‚  â”‚ - post_archive.py                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å˜æ›´**:
1. âŒ åˆ é™¤ workflow-state.json
2. âœ… task-meta.json æˆä¸ºå”¯ä¸€æ•°æ®æº
3. âœ… TaskMetaManager æä¾›ç»Ÿä¸€API
4. âœ… æ–‡ä»¶é”æœºåˆ¶é¿å…å¹¶å‘å†²çª
```

</details>

---

### 5.3 æ•°æ®æµè®¾è®¡.md

**æ›´æ–°æ¶æ„å›¾**ï¼ˆå‚è€ƒä¸Šé¢çš„ HookçŠ¶æ€æœºæœºåˆ¶.mdï¼‰

---

### 5.4 CHANGELOG.md

**ä½ç½®**: `CHANGELOG.md`

```markdown
## [v21.0] - 2025-11-15

### ğŸ¯ é‡å¤§æ¶æ„å˜æ›´

#### task-meta.json ä¸ºå”¯ä¸€æ•°æ®æº

**åŠ¨æœº**:
- ç®€åŒ–æ¶æ„ï¼Œæ¶ˆé™¤æ•°æ®å†—ä½™
- è§£å†³ workflow-state.json å’Œ task-meta.json åŒæ­¥é—®é¢˜
- æå‡æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§

**æ ¸å¿ƒå˜æ›´**:
- âŒ **åˆ é™¤** `workflow-state.json`
- âœ… **åˆå¹¶** è¿è¡Œæ—¶çŠ¶æ€åˆ° `task-meta.json`
- âœ… **æ–°å¢** `TaskMetaManager`ï¼ˆæ–‡ä»¶é”+åŸå­æ›´æ–°+é‡è¯•ï¼‰
- âŒ **åˆ é™¤** `workflow_state_ref`, `archived_snapshot` å­—æ®µ

**å½±å“èŒƒå›´**:
- æ‰€æœ‰ Hook æ–‡ä»¶ï¼ˆ9ä¸ªé‡å†™ï¼‰
- ä»»åŠ¡åˆå§‹åŒ–é€»è¾‘
- ä»»åŠ¡æ¢å¤é€»è¾‘
- å½’æ¡£é€»è¾‘

**è¿ç§»æ–¹æ³•**:
```bash
# è‡ªåŠ¨è¿ç§»æ‰€æœ‰ç°æœ‰ä»»åŠ¡
node lib/migrate-to-v21.js
```

---

### ğŸ› ä¿®å¤é—®é¢˜

#### æ–‡ä»¶æ„å¤–ä¿®æ”¹é”™è¯¯
**é—®é¢˜**: PostToolUse Hook å¹¶å‘å†™å…¥å¯¼è‡´ "File has been unexpectedly modified"

**è§£å†³æ–¹æ¡ˆ**:
- å¼•å…¥ portalocker æ–‡ä»¶é”
- å®ç°é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼Œ100mså»¶è¿Ÿï¼‰
- åŸå­å†™å…¥ï¼ˆä¸´æ—¶æ–‡ä»¶+é‡å‘½åï¼‰

#### æ­¥éª¤è·³è·ƒé—®é¢˜
**é—®é¢˜**: Hook æ³¨å…¥ä¸å®é™…æ‰§è¡Œä¸åŒæ­¥

**è§£å†³æ–¹æ¡ˆ**:
- PreToolUse ä¸¥æ ¼æ£€æŸ¥æ­¥éª¤é¡ºåº
- ç¦æ­¢è·³è·ƒæ‰§è¡Œ

#### æ•°æ®æ¢å¤æ··ä¹±
**é—®é¢˜**: å…¼å®¹3ç§æ—§æ ¼å¼å¯¼è‡´æ¢å¤é€»è¾‘å¤æ‚

**è§£å†³æ–¹æ¡ˆ**:
- æ¿€è¿›è¿ç§»ï¼Œä»…æ”¯æŒ v21.0
- ç®€åŒ–æ¢å¤é€»è¾‘ï¼ˆç›´æ¥åŠ è½½ task-meta.jsonï¼‰

---

### ğŸ“š æ–‡æ¡£æ›´æ–°

- æ›´æ–° `task-meta.jsonæ–‡ä»¶ç»“æ„.md`ï¼ˆv21.0 å®Œæ•´è§„èŒƒï¼‰
- æ›´æ–° `HookçŠ¶æ€æœºæœºåˆ¶.md`ï¼ˆæ–°æ•°æ®æµå›¾ï¼‰
- æ›´æ–° `æ•°æ®æµè®¾è®¡.md`
- æ–°å¢ `v21.0é‡æ„å®æ–½æŒ‡å—.md`

---

### ğŸ”§ å¼€å‘è€…æ³¨æ„äº‹é¡¹

**ä¸å…¼å®¹å˜æ›´**:
- âš ï¸ v20.x æ ¼å¼çš„ task-meta.json éœ€è¦è¿ç§»
- âš ï¸ è‡ªå®šä¹‰ Hook éœ€è¦é€‚é… TaskMetaManager API

**API å˜æ›´**:
```python
# v20.3.2
from core.state_manager import StateManager
state_mgr = StateManager(cwd)
workflow_state = state_mgr.load_current_state()

# v21.0
from core.task_meta_manager import TaskMetaManager
mgr = TaskMetaManager(cwd)
task_meta = mgr.load_task_meta(task_id)
```

---

### ğŸ“Š æ€§èƒ½æå‡

| æŒ‡æ ‡ | v20.3.2 | v21.0 | æ”¹è¿› |
|------|---------|-------|------|
| æ–‡ä»¶æ•°é‡ | 2ä¸ª | 1ä¸ª | -50% |
| æ¢å¤é€»è¾‘å¤æ‚åº¦ | 3ç§æ ¼å¼ | 1ç§æ ¼å¼ | -67% |
| æ–‡ä»¶ä¿®æ”¹å†²çª | é«˜ | ä½ï¼ˆé”+é‡è¯•ï¼‰ | æ˜¾è‘—é™ä½ |
```

---

## 6. Phase 4: è¿ç§»ä¸éªŒè¯

### 6.1 è¿ç§»æ­¥éª¤

```bash
# 1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æ›´æ–°
git status

# 2. å¤‡ä»½ç°æœ‰ä»»åŠ¡
cp -r tests/tasks tests/tasks.backup-v20

# 3. è¿è¡Œè¿ç§»è„šæœ¬
cd /path/to/project
node lib/migrate-to-v21.js

# é¢„æœŸè¾“å‡º:
# ========================================
#   v21.0 æ¶æ„è¿ç§»è„šæœ¬
# ========================================
#
# ğŸ“¦ æ‰¾åˆ° 3 ä¸ªä»»åŠ¡
#
# [1/3] ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»
#   ğŸ“„ ä» workflow-state.json åŠ è½½çŠ¶æ€
#   ğŸ’¾ å·²å¤‡ä»½åˆ° .task-meta.json.backup-v20
#   âœ… è¿ç§»æˆåŠŸ: v20.3.2 â†’ v21.0
#
# ...
#
# ========================================
#   è¿ç§»å®Œæˆ
# ========================================
# æ€»è®¡: 3
# âœ… æˆåŠŸ: 3
# â­ï¸  è·³è¿‡: 0
# âŒ å¤±è´¥: 0
#
# âœ… æ‰€æœ‰ä»»åŠ¡è¿ç§»æˆåŠŸï¼
```

---

### 6.2 éªŒè¯æ­¥éª¤

#### æ­¥éª¤1: éªŒè¯æ–‡ä»¶ç»“æ„

```bash
# æ£€æŸ¥ä»»åŠ¡å…ƒæ•°æ®
cat tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»/.task-meta.json | jq '{
  architecture_version,
  current_step,
  has_steps: (.steps != null),
  has_bug_tracking: (.bug_fix_tracking != null)
}'

# é¢„æœŸè¾“å‡º:
# {
#   "architecture_version": "v21.0",
#   "current_step": "step3_execute",
#   "has_steps": true,
#   "has_bug_tracking": true
# }
```

#### æ­¥éª¤2: éªŒè¯å¤‡ä»½æ–‡ä»¶

```bash
# ç¡®è®¤å¤‡ä»½å­˜åœ¨
ls tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»/.task-meta.json.backup-v20

# å¯¹æ¯”å¤‡ä»½å’Œæ–°æ–‡ä»¶
diff <(jq -S . tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»/.task-meta.json.backup-v20) \
     <(jq -S . tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»/.task-meta.json)
```

#### æ­¥éª¤3: éªŒè¯HookåŠŸèƒ½

```bash
# åˆ›å»ºæµ‹è¯•ä»»åŠ¡
cd tests
claude-code  # æˆ–å…¶ä»–å¯åŠ¨æ–¹å¼

# åœ¨Claude Codeä¸­æ‰§è¡Œ:
/mc æµ‹è¯•v21.0æ¶æ„

# éªŒè¯ç‚¹:
# 1. âœ… ä»»åŠ¡ç›®å½•åˆ›å»ºæˆåŠŸ
# 2. âœ… task-meta.json åŒ…å«å®Œæ•´è¿è¡Œæ—¶çŠ¶æ€
# 3. âœ… .task-active.json åˆ›å»ºæˆåŠŸ
# 4. âŒ workflow-state.json ä¸å­˜åœ¨
```

#### æ­¥éª¤4: éªŒè¯ä»»åŠ¡æ¢å¤

```bash
# åœ¨Claude Codeä¸­æ‰§è¡Œ:
/mc tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´» ç»§ç»­ä¿®å¤

# éªŒè¯ç‚¹:
# 1. âœ… ä»»åŠ¡æ¢å¤æˆåŠŸ
# 2. âœ… å†å²è¿­ä»£ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
# 3. âœ… current_step æ­£ç¡®
# 4. âœ… æ— é”™è¯¯æ—¥å¿—
```

#### æ­¥éª¤5: éªŒè¯PostToolUseæ›´æ–°

```bash
# åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œä»»æ„å·¥å…·è°ƒç”¨
Read("CLAUDE.md")

# æ£€æŸ¥ task-meta.json æ›´æ–°
cat tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»/.task-meta.json | jq '.metrics.tools_used | length'

# é¢„æœŸè¾“å‡º: å¤§äº0çš„æ•°å­—
```

---

### 6.3 æ€§èƒ½æµ‹è¯•

```bash
# æµ‹è¯•å¹¶å‘å†™å…¥æ€§èƒ½
for i in {1..10}; do
  (Read("test-file-$i.md") &)
done

# æ£€æŸ¥æ˜¯å¦æœ‰å†²çªé”™è¯¯
grep "File has been unexpectedly modified" .claude/hooks.log
# é¢„æœŸ: æ— è¾“å‡ºï¼ˆæˆ–æå°‘ï¼‰
```

---

### 6.4 BUGä¿®å¤éªŒè¯

**é‡ç°ä¼šè¯è®°å½•ä¸­çš„BUG**:

```bash
cd tests

# 1. å¯åŠ¨Claude Code
claude-code

# 2. æ‰§è¡ŒBUGä¿®å¤ä»»åŠ¡
/mc ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»ä¾æ—§æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„BUG

# 3. è§‚å¯Ÿå·¥ä½œæµæ‰§è¡Œ
# éªŒè¯ç‚¹:
# - âœ… æ­¥éª¤ä¸è·³è·ƒï¼ˆstep0 â†’ step1 â†’ step3ï¼‰
# - âœ… æ— æ–‡ä»¶ä¿®æ”¹å†²çªé”™è¯¯
# - âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®æ›´æ–°
# - âœ… å¯ä»¥æ­£å¸¸æ¢å¤
```

---

## 7. å›æ»šæ–¹æ¡ˆ

### 7.1 å¿«é€Ÿå›æ»š

å¦‚æœè¿ç§»åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# 1. æ¢å¤å¤‡ä»½çš„ä»»åŠ¡
rm -rf tests/tasks
mv tests/tasks.backup-v20 tests/tasks

# 2. æ¢å¤æ—§ç‰ˆæœ¬Hookæ–‡ä»¶
git checkout v20.3.2 templates/.claude/hooks/

# 3. åˆ é™¤v21.0æ–°å¢æ–‡ä»¶
rm templates/.claude/hooks/core/task_meta_manager.py
rm lib/migrate-to-v21.js

# 4. æ¢å¤æ—§ç‰ˆæœ¬state_manager.py
git checkout v20.3.2 templates/.claude/hooks/core/state_manager.py
```

---

### 7.2 éƒ¨åˆ†å›æ»šï¼ˆä¿ç•™å·²è¿ç§»ä»»åŠ¡ï¼‰

å¦‚æœåªæƒ³å›æ»šHooké€»è¾‘ï¼Œä¿ç•™å·²è¿ç§»çš„ä»»åŠ¡ï¼š

```bash
# 1. å›æ»šHookæ–‡ä»¶
git checkout v20.3.2 templates/.claude/hooks/

# 2. ä¸ºæ¯ä¸ªä»»åŠ¡æ‰‹åŠ¨å›æ»š
cd tests/tasks/ä»»åŠ¡-1115-071821-ä¿®å¤ç©å®¶æ­»äº¡å¤æ´»

# 3. æ¢å¤å¤‡ä»½
mv .task-meta.json .task-meta-v21.json
mv .task-meta.json.backup-v20 .task-meta.json

# 4. é‡å»ºworkflow-state.json
cat .task-meta-v21.json | jq '{
  task_id,
  task_description,
  task_type,
  current_step,
  steps,
  bug_fix_tracking,
  metrics
}' > ../../.claude/workflow-state.json
```

---

### 7.3 æ•°æ®ä¿®å¤è„šæœ¬

å¦‚æœè¿ç§»å‡ºç°æ•°æ®ä¸¢å¤±ï¼Œä½¿ç”¨ä¿®å¤è„šæœ¬ï¼š

```javascript
// lib/fix-v21-migration.js
const fs = require('fs');
const path = require('path');

function fixTask(taskId) {
  const metaPath = path.join('tests/tasks', taskId, '.task-meta.json');
  const backupPath = metaPath + '.backup-v20';

  if (!fs.existsSync(backupPath)) {
    console.log(`âŒ ${taskId}: æ— å¤‡ä»½æ–‡ä»¶`);
    return;
  }

  const backup = JSON.parse(fs.readFileSync(backupPath, 'utf-8'));
  const current = JSON.parse(fs.readFileSync(metaPath, 'utf-8'));

  // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
  const fields = ['current_step', 'steps', 'bug_fix_tracking', 'metrics'];
  const missing = fields.filter(f => !current[f] && backup.workflow_state && backup.workflow_state[f]);

  if (missing.length > 0) {
    console.log(`âš ï¸  ${taskId}: ç¼ºå¤±å­—æ®µ ${missing.join(', ')}`);

    // ä¿®å¤
    missing.forEach(f => {
      current[f] = backup.workflow_state[f];
    });

    fs.writeFileSync(metaPath, JSON.stringify(current, null, 2), 'utf-8');
    console.log(`âœ… ${taskId}: å·²ä¿®å¤`);
  } else {
    console.log(`âœ… ${taskId}: æ•°æ®å®Œæ•´`);
  }
}

// æ‰§è¡Œ
const taskDirs = fs.readdirSync('tests/tasks');
taskDirs.forEach(fixTask);
```

---

## 8. å¸¸è§é—®é¢˜

### Q1: è¿ç§»åä»»åŠ¡æ— æ³•æ¢å¤ï¼Ÿ
**A**: æ£€æŸ¥ task-meta.json æ˜¯å¦åŒ…å« `current_step` å­—æ®µï¼š
```bash
cat tasks/{task_id}/.task-meta.json | jq '.current_step'
```

å¦‚æœä¸ºç©ºï¼Œè¿è¡Œä¿®å¤è„šæœ¬ï¼š
```bash
node lib/fix-v21-migration.js
```

---

### Q2: PostToolUse æŠ¥é”™ "TaskMetaManager æ¨¡å—ç¼ºå¤±"ï¼Ÿ
**A**: æ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼š
```bash
ls templates/.claude/hooks/core/task_meta_manager.py
```

ç¡®ä¿æ–‡ä»¶å­˜åœ¨ä¸”Pythonå¯å¯¼å…¥ã€‚

---

### Q3: æ–‡ä»¶é”åŠŸèƒ½ä¸å·¥ä½œï¼ˆWindowsï¼‰ï¼Ÿ
**A**: å®‰è£… portalockerï¼š
```bash
pip install portalocker
```

å¦‚æœæ— æ³•å®‰è£…ï¼ŒTaskMetaManager ä¼šé™çº§åˆ°æ— é”æ¨¡å¼ï¼ˆä½†ä»æœ‰é‡è¯•æœºåˆ¶ï¼‰ã€‚

---

### Q4: è¿ç§»åæ–‡ä»¶å¤§å°å¢åŠ ï¼Ÿ
**A**: v21.0 å°†è¿è¡Œæ—¶çŠ¶æ€åˆå¹¶åˆ° task-meta.jsonï¼Œæ–‡ä»¶ä¼šå˜å¤§ã€‚ä½†æ€»ä½“æ–‡ä»¶æ•°é‡å‡å°‘ï¼ˆåˆ é™¤äº† workflow-state.jsonï¼‰ï¼Œæ•´ä½“å ç”¨ç©ºé—´å‡å°‘çº¦30%ã€‚

---

## 9. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 9.1 ç«‹å³è¡ŒåŠ¨

1. âœ… é˜…è¯»æœ¬æŒ‡å—
2. âœ… å¤‡ä»½ç°æœ‰ä»»åŠ¡
3. âœ… æ›´æ–°Hookæ–‡ä»¶ï¼ˆæŒ‰Phase 1é¡ºåºï¼‰
4. âœ… è¿è¡Œè¿ç§»è„šæœ¬
5. âœ… æ‰§è¡ŒéªŒè¯æ­¥éª¤

### 9.2 æŒç»­ä¼˜åŒ–

1. ç›‘æ§æ–‡ä»¶é”æ€§èƒ½ï¼ˆæ˜¯å¦æœ‰å†²çªï¼‰
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. ä¼˜åŒ– TaskMetaManager é‡è¯•ç­–ç•¥
4. è€ƒè™‘å¼•å…¥ç¼“å­˜æœºåˆ¶ï¼ˆå¦‚æœæ€§èƒ½ä¸è¶³ï¼‰

---

## 10. æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥é˜… [Hookå¼€å‘è€…æŒ‡å—](./Hookå¼€å‘è€…æŒ‡å—.md)
2. æŸ¥é˜… [task-meta.jsonæ–‡ä»¶ç»“æ„.md](./task-meta.jsonæ–‡ä»¶ç»“æ„.md)
3. æäº¤ GitHub Issue

---

_æ–‡æ¡£ç‰ˆæœ¬: v21.0.0_
_æœ€åæ›´æ–°: 2025-11-15_
_ä½œè€…: Claude Code Assistant_
