# ä»ªè¡¨ç›˜åŠŸèƒ½å®ç°æŒ‡å—

> **ç‰ˆæœ¬**: v28.0
> **æœ€åæ›´æ–°**: 2025-11-21
> **çŠ¶æ€**: âœ… å·²éªŒè¯

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä»ªè¡¨ç›˜åŠŸèƒ½ç”¨äºåœ¨Claude Codeä¼šè¯ä¸­å‘ç”¨æˆ·å®æ—¶æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- å½“å‰ä»»åŠ¡é˜¶æ®µï¼ˆPlanning/Implementation/Finalizationï¼‰
- ä¸“å®¶å®¡æŸ¥çŠ¶æ€
- ç”¨æˆ·ç¡®è®¤çŠ¶æ€
- ä¸‹ä¸€æ­¥è¡ŒåŠ¨æç¤º

**æ˜¾ç¤ºæ—¶æœº**ï¼š
1. `/mc`å‘½ä»¤æ‰§è¡Œåï¼ˆä»»åŠ¡åˆ›å»ºæ—¶ï¼‰
2. çŠ¶æ€è½¬æ¢æ—¶ï¼ˆç”¨æˆ·è¾“å…¥"åŒæ„"ã€"ä¿®å¤äº†"ç­‰ï¼‰
3. æ™®é€šæ¶ˆæ¯è¾“å…¥åï¼ˆä»»ä½•éå‘½ä»¤è¾“å…¥ï¼‰

---

## âš ï¸ å…³é”®æŠ€æœ¯ç‚¹

### 1. Hookè¾“å‡ºå­—æ®µçš„å¯è§æ€§

åœ¨Claude Codeçš„Hookç³»ç»Ÿä¸­ï¼Œæœ‰ä¸¤ç§è¾“å‡ºå­—æ®µï¼š

| å­—æ®µ | å¯è§æ€§ | ç”¨é€” |
|------|--------|------|
| `additionalContext` | ä»…Claudeå¯è§ | å‘Claudeæ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯ |
| `systemMessage` | **ç”¨æˆ·å’ŒClaudeéƒ½å¯è§** | å‘ç”¨æˆ·æ˜¾ç¤ºæç¤ºä¿¡æ¯ |

**é”™è¯¯ç¤ºä¾‹** âŒï¼š
```python
output = {
    "hookSpecificOutput": {
        "additionalContext": dashboard_content  # ç”¨æˆ·çœ‹ä¸åˆ°ï¼
    }
}
```

**æ­£ç¡®ç¤ºä¾‹** âœ…ï¼š
```python
output = {
    "systemMessage": dashboard_content  # ç”¨æˆ·å¯è§ï¼
}
```

### 2. æ—¶åºé—®é¢˜

**é”™è¯¯åšæ³•** âŒï¼šåœ¨TaskInitializeræ‰§è¡Œå‰ç”Ÿæˆä»ªè¡¨ç›˜
```python
def main():
    # è¿™æ—¶ä»»åŠ¡è¿˜æ²¡åˆ›å»ºï¼
    dashboard = generate_dashboard(session_id)  # å¤±è´¥ï¼šä¼šè¯æœªç»‘å®šä»»åŠ¡

    # ç„¶åæ‰åˆ›å»ºä»»åŠ¡
    task_initializer.create_task(...)
```

**æ­£ç¡®åšæ³•** âœ…ï¼šåœ¨ä»»åŠ¡åˆ›å»ºåç”Ÿæˆä»ªè¡¨ç›˜
```python
def main():
    # å…ˆåˆ›å»ºä»»åŠ¡
    result = task_initializer.handle_mc_command(...)

    # ä»»åŠ¡åˆ›å»ºæˆåŠŸåç”Ÿæˆä»ªè¡¨ç›˜
    if result['continue']:
        dashboard = generate_dashboard(session_id)  # æˆåŠŸï¼
        output['systemMessage'] = dashboard
```

### 3. APIé€‰æ‹©

TaskMetaManageræä¾›ä¸¤ä¸ªç›¸å…³APIï¼š

| API | å‚æ•° | ç”¨é€” | æ¨è |
|-----|------|------|------|
| `get_active_task_id()` | æ—  | v3.0æ—§ç‰ˆAPI | âŒ å·²å¼ƒç”¨ |
| `get_active_task_by_session(session_id)` | session_id | v3.1æ¨èAPI | âœ… ä½¿ç”¨è¿™ä¸ª |

**é”™è¯¯ç¤ºä¾‹** âŒï¼š
```python
task_id = mgr.get_active_task_id(session_id)  # æŠ¥é”™ï¼šå‚æ•°è¿‡å¤š
```

**æ­£ç¡®ç¤ºä¾‹** âœ…ï¼š
```python
task_info = mgr.get_active_task_by_session(session_id)
task_id = task_info.get('task_id')
```

---

## ğŸ¯ å®Œæ•´å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: /mcå‘½ä»¤åæ˜¾ç¤ºä»ªè¡¨ç›˜

**ä½ç½®**ï¼š`user_prompt_handler.py` TaskInitializeræ‰§è¡Œå

**ä»£ç **ï¼š[user_prompt_handler.py:663-682](../../tests/.claude/hooks/orchestrator/user_prompt_handler.py#L663-L682)

```python
# === v27.9: ä»»åŠ¡åˆ›å»ºåç”Ÿæˆä»ªè¡¨ç›˜ ===
if TASK_INITIALIZER_AVAILABLE:
    try:
        # 1. å…ˆåˆ›å»ºä»»åŠ¡
        initializer = TaskInitializer(cwd, session_id)
        result = initializer.handle_mc_command(cmd_info['command_args'])

        # 2. æ„å»ºåŸºç¡€è¾“å‡º
        output = {
            "hookSpecificOutput": {
                "hookEventName": "UserPromptSubmit",
                "additionalContext": result['additionalContext']
            },
            "continue": result['continue']
        }

        # 3. ä»»åŠ¡åˆ›å»ºæˆåŠŸåç”Ÿæˆä»ªè¡¨ç›˜
        if TaskMetaManager and result['continue']:
            try:
                mgr = TaskMetaManager(cwd)
                task_info = mgr.get_active_task_by_session(session_id)

                if task_info:
                    task_id = task_info.get('task_id')
                    task_meta = mgr.load_task_meta(task_id)

                    if task_meta:
                        from utils.dashboard_generator import generate_context_dashboard
                        dashboard = generate_context_dashboard(task_meta)
                        # âœ… ä½¿ç”¨systemMessageå­—æ®µ
                        output['systemMessage'] = dashboard
            except Exception as e:
                # ä»ªè¡¨ç›˜ç”Ÿæˆå¤±è´¥ä¸å½±å“ä¸»æµç¨‹
                sys.stderr.write(u"[WARN] ä»ªè¡¨ç›˜ç”Ÿæˆå¤±è´¥: {}\n".format(e))

        print(json.dumps(output, ensure_ascii=False))
        sys.exit(0)
```

### æ–¹æ¡ˆ2: æ¯æ¬¡ç”¨æˆ·è¾“å…¥åæ˜¾ç¤ºä»ªè¡¨ç›˜

**ä½ç½®**ï¼š`user_prompt_handler.py` é/mcå‘½ä»¤å¤„ç†é€»è¾‘

**ä»£ç **ï¼š[user_prompt_handler.py:551-591](../../tests/.claude/hooks/orchestrator/user_prompt_handler.py#L551-L591)

```python
# === v28.0: ä¸ºé/mcå‘½ä»¤ç”Ÿæˆä»ªè¡¨ç›˜ ===
dashboard_for_normal_msg = None
if not cmd_info['is_mc_command'] and TaskMetaManager:
    try:
        mgr = TaskMetaManager(cwd)
        task_info = mgr.get_active_task_by_session(session_id)

        if task_info:
            task_id = task_info.get('task_id')
            task_meta = mgr.load_task_meta(task_id)

            if task_meta:
                from utils.dashboard_generator import generate_context_dashboard
                dashboard_for_normal_msg = generate_context_dashboard(task_meta)
    except Exception as e:
        sys.stderr.write(u"[WARN v28.0] ä»ªè¡¨ç›˜ç”Ÿæˆå¤±è´¥: {}\n".format(e))

# ä½¿ç”¨åœºæ™¯1ï¼šçŠ¶æ€è½¬æ¢
if state_transition_result:
    if dashboard_for_normal_msg:
        if 'systemMessage' in state_transition_result:
            state_transition_result['systemMessage'] = dashboard_for_normal_msg + u"\n\n" + state_transition_result['systemMessage']
        else:
            state_transition_result['systemMessage'] = dashboard_for_normal_msg
    print(json.dumps(state_transition_result, ensure_ascii=False))
    sys.exit(0)

# ä½¿ç”¨åœºæ™¯2ï¼šæ™®é€šæ¶ˆæ¯æ”¾è¡Œ
output = {"continue": True}
if dashboard_for_normal_msg:
    output['systemMessage'] = dashboard_for_normal_msg
print(json.dumps(output, ensure_ascii=False))
sys.exit(0)
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: ä»ªè¡¨ç›˜ä¸æ˜¾ç¤º

**ç—‡çŠ¶**ï¼š`/mc`å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰çœ‹åˆ°ä»ªè¡¨ç›˜

**å¯èƒ½åŸå› **ï¼š
1. âŒ ä½¿ç”¨äº†`additionalContext`å­—æ®µï¼ˆä»…Claudeå¯è§ï¼‰
2. âŒ æ—¶åºé”™è¯¯ï¼ˆåœ¨ä»»åŠ¡åˆ›å»ºå‰ç”Ÿæˆä»ªè¡¨ç›˜ï¼‰
3. âŒ ä½¿ç”¨äº†é”™è¯¯çš„APIï¼ˆ`get_active_task_id(session_id)`ï¼‰

**è¯Šæ–­æ–¹æ³•**ï¼š
```python
# æ·»åŠ è¯Šæ–­ä»£ç 
dashboard_debug = []
try:
    mgr = TaskMetaManager(cwd)
    task_info = mgr.get_active_task_by_session(session_id)
    dashboard_debug.append(u"task_info: {}".format(task_info))

    if task_info:
        task_id = task_info.get('task_id')
        dashboard_debug.append(u"task_id: {}".format(task_id))
        # ...
except Exception as e:
    dashboard_debug.append(u"å¼‚å¸¸: {}".format(e))

# è¾“å‡ºè¯Šæ–­ä¿¡æ¯
output['systemMessage'] = u"\n".join(dashboard_debug)
```

### é—®é¢˜2: "ä¼šè¯æœªç»‘å®šä»»åŠ¡"

**ç—‡çŠ¶**ï¼šè¯Šæ–­æ˜¾ç¤º"âœ— ä¼šè¯æœªç»‘å®šä»»åŠ¡"

**åŸå› **ï¼šä»ªè¡¨ç›˜ç”Ÿæˆä»£ç åœ¨TaskInitializeræ‰§è¡Œå‰è¿è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†ä»ªè¡¨ç›˜ç”Ÿæˆç§»åˆ°TaskInitializeræ‰§è¡Œåï¼ˆå‚è§æ–¹æ¡ˆ1ï¼‰

### é—®é¢˜3: APIè°ƒç”¨é”™è¯¯

**ç—‡çŠ¶**ï¼š`TaskMetaManager.get_active_task_id() takes 1 positional argument but 2 were given`

**åŸå› **ï¼šä½¿ç”¨äº†v3.0æ—§ç‰ˆAPIï¼Œè¯¥æ–¹æ³•ä¸æ¥å—å‚æ•°

**è§£å†³æ–¹æ¡ˆ**ï¼šæ”¹ç”¨v3.1 API
```python
# âŒ é”™è¯¯
task_id = mgr.get_active_task_id(session_id)

# âœ… æ­£ç¡®
task_info = mgr.get_active_task_by_session(session_id)
task_id = task_info.get('task_id')
```

---

## ğŸ“Š ç‰ˆæœ¬å†å²

### v28.0 (2025-11-21) âœ…
- **åŠŸèƒ½**ï¼šæ¯æ¬¡ç”¨æˆ·è¾“å…¥åæ˜¾ç¤ºä»ªè¡¨ç›˜
- **æ”¹è¿›**ï¼šè¦†ç›–çŠ¶æ€è½¬æ¢å’Œæ™®é€šæ¶ˆæ¯åœºæ™¯
- **ä»£ç **ï¼š551-591è¡Œ

### v27.9 (2025-11-21) âœ…
- **åŠŸèƒ½**ï¼š/mcå‘½ä»¤åæ˜¾ç¤ºä»ªè¡¨ç›˜
- **ä¿®å¤**ï¼šæ—¶åºé—®é¢˜ï¼ˆåœ¨ä»»åŠ¡åˆ›å»ºåç”Ÿæˆï¼‰
- **ä»£ç **ï¼š663-682è¡Œ

### v27.8 (2025-11-21)
- **ä¿®å¤**ï¼šAPIè°ƒç”¨é”™è¯¯ï¼ˆä½¿ç”¨æ­£ç¡®çš„`get_active_task_by_session()`ï¼‰

### v27.7 (2025-11-21)
- **è¯Šæ–­**ï¼šå‘ç°ä¼šè¯æœªç»‘å®šä»»åŠ¡é—®é¢˜

### v27.6 (2025-11-21)
- **éªŒè¯**ï¼šç¡®è®¤`systemMessage`å­—æ®µå¯¹ç”¨æˆ·å¯è§

### v27.1-v27.5 (2025-11-20)
- **æ¢ç´¢**ï¼šå°è¯•ä¸åŒçš„Hookè¾“å‡ºæ–¹å¼ï¼ˆstdout vs JSONï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [HookçŠ¶æ€æœºåŠŸèƒ½å®ç°](./HookçŠ¶æ€æœºåŠŸèƒ½å®ç°.md) - Hookç³»ç»Ÿæ¶æ„
- [HOOKæ­£ç¡®ç”¨æ³•æ–‡æ¡£](./HOOKæ­£ç¡®ç”¨æ³•æ–‡æ¡£.md) - Hookå¼€å‘è§„èŒƒ
- [dashboard_generator.py](../../tests/.claude/hooks/utils/dashboard_generator.py) - ä»ªè¡¨ç›˜ç”Ÿæˆæ¨¡å—
- [user_prompt_handler.py](../../tests/.claude/hooks/orchestrator/user_prompt_handler.py) - UserPromptSubmit Hookå®ç°

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨`systemMessage`å­—æ®µ**ï¼šéœ€è¦å‘ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯æ—¶ï¼Œå§‹ç»ˆä½¿ç”¨`systemMessage`è€Œé`additionalContext`

2. **æ³¨æ„æ‰§è¡Œæ—¶åº**ï¼šç¡®ä¿ä»ªè¡¨ç›˜ç”Ÿæˆåœ¨ä»»åŠ¡åˆ›å»º**ä¹‹å**

3. **ä½¿ç”¨v3.1 API**ï¼šä¼˜å…ˆä½¿ç”¨`get_active_task_by_session(session_id)`è€Œéå·²å¼ƒç”¨çš„`get_active_task_id()`

4. **å¼‚å¸¸å¤„ç†**ï¼šä»ªè¡¨ç›˜ç”Ÿæˆå¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹ï¼Œä½¿ç”¨try-exceptåŒ…è£¹

5. **ä¿æŒä¸€è‡´æ€§**ï¼šæ‰€æœ‰éœ€è¦æ˜¾ç¤ºä»ªè¡¨ç›˜çš„ä½ç½®ä½¿ç”¨ç›¸åŒçš„ç”Ÿæˆé€»è¾‘

---

_æœ€åæ›´æ–°: 2025-11-21 | v28.0 (æ¯æ¬¡è¾“å…¥åæ˜¾ç¤ºä»ªè¡¨ç›˜)_
