# 任务模板使用指南

> **版本**: v21.1.2
> **更新**: 2025-11-15

---

## 📋 概述

本文档介绍如何使用标准化任务上下文模板 (`context.md.template`) 来创建结构化的任务记录。

---

## 🎯 为什么需要任务模板？

### 问题背景

在 v19.4.2 之前,`/mc` 指令要求 AI 创建任务目录时填写 `context.md`,但**没有提供标准模板**,导致：

1. **格式不统一**: 不同任务的 `context.md` 结构差异很大
2. **语言不一致**: 可能出现中英文混杂的情况
3. **关键信息缺失**: AI 可能遗漏 CRITICAL 规范检查等重要章节

### 解决方案

v19.4.2 引入了 **6 章标准化模板**,确保：

- ✅ **结构统一**: 所有任务使用相同的 6 章结构
- ✅ **语言一致**: 统一使用中文描述
- ✅ **信息完整**: 强制包含 CRITICAL 规范检查、风险评估等关键章节

---

## 📂 模板位置

### 上游生成器项目
```
D:\EcWork\基于Claude的MODSDK开发工作流\templates\tasks\context.md.template
```

### 下游 MODSDK 项目（部署后）
```
<项目根目录>/.claude/core-docs/templates/tasks/context.md.template
```

---

## 📖 模板结构

```markdown
# 任务上下文

> **任务ID**: `{{TASK_ID}}`
> **创建时间**: {{CREATED_AT}}
> **项目**: {{PROJECT_NAME}}

---

## 1. 任务描述
### 1.1 原始需求
{{USER_REQUEST}}

### 1.2 任务分类
- **类型**: {{TASK_TYPE}} (🟢 微任务 / 🟡 标准任务 / 🔴 复杂任务)
- **涉及模块**: {{MODULES}}
- **预估复杂度**: {{COMPLEXITY}}

---

## 2. 技术调研
### 2.1 相关文档
1. **开发规范.md**
   - 关键规范: {{KEY_RULES}}
2. **问题排查.md**
   - 相关问题: {{RELATED_ISSUES}}
3. **Systems文档**
   - 系统交互: {{SYSTEM_INTERACTION}}

### 2.2 MODSDK API
- 事件: {{EVENTS_USED}}
- Component: {{COMPONENTS_USED}}
- 接口: {{APIS_USED}}

---

## 3. 技术方案
### 3.1 架构设计
{{ARCHITECTURE_DIAGRAM}}

### 3.2 关键实现点
1. {{KEY_POINT_1}}
2. {{KEY_POINT_2}}

### 3.3 CRITICAL规范检查
- [ ] 生命周期: 避免在`__init__`调用API
- [ ] 双端隔离: 使用`NotifyToClient/Server`
- [ ] EventData: 使用`list`/`dict`,避免`tuple`
- [ ] AOI范围: 限制在2000内
- [ ] 模块白名单: 不使用未授权模块

---

## 4. 实施计划
### 4.1 文件修改清单
| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| {{FILE_1}} | {{EDIT_TYPE_1}} | {{DESC_1}} |

### 4.2 测试计划
- [ ] 单元测试: {{TEST_PLAN_1}}
- [ ] 集成测试: {{TEST_PLAN_2}}
- [ ] 游戏内测试: {{TEST_PLAN_3}}

---

## 5. 风险评估
### 5.1 已识别风险
1. **{{RISK_1}}**
   - 影响: {{RISK_IMPACT_1}}
   - 缓解措施: {{RISK_MITIGATION_1}}

### 5.2 依赖检查
- [ ] 上游依赖: {{UPSTREAM_DEPS}}
- [ ] 下游影响: {{DOWNSTREAM_IMPACT}}

---

## 6. 执行日志
### 6.1 修改轮次
详见 [`change-log.md`](./change-log.md)

### 6.2 专家审核
详见 [`solution.md`](./solution.md) (如触发)

---

_最后更新: {{LAST_UPDATED}}_
```

---

## 🚀 使用方式

### 方式1: 命令行快速创建（推荐）

```bash
# 进入 MODSDK 项目
cd D:/EcWork/NetEaseMapECBedWars

# 创建任务目录
mkdir -p tasks/task-20251113-120000-添加VIP系统

# 复制模板
cp .claude/core-docs/templates/tasks/context.md.template \
   tasks/task-20251113-120000-添加VIP系统/context.md

# 使用编辑器填写内容
code tasks/task-20251113-120000-添加VIP系统/context.md
```

### 方式2: AI 自动填写

在 `/mc` 指令的步骤1.2中,AI 会自动：

1. 创建任务目录
2. 复制模板到 `context.md`
3. 按照任务需求填写模板中的 `{{变量}}`

**示例**：

```
/mc 添加VIP系统，玩家可以购买VIP获得移动速度加成
```

AI 会生成：

```markdown
# 任务上下文

> **任务ID**: `task-20251113-120000-添加VIP系统`
> **创建时间**: 2025-11-13 12:00:00
> **项目**: NetEaseMapECBedWars

---

## 1. 任务描述

### 1.1 原始需求
```
添加VIP系统，玩家可以购买VIP获得移动速度加成
```

### 1.2 任务分类
- **类型**: 🔴 复杂任务 (涉及双端通信、经济系统、Buff系统)
- **涉及模块**: VIPServerSystem, VIPClientSystem, ShopSystem
- **预估复杂度**: 高（>5个System）

---

## 2. 技术调研

### 2.1 相关文档
1. **开发规范.md** (.claude/core-docs/核心工作流文档/开发规范.md)
   - 关键规范: 双端隔离、生命周期、EventData序列化

2. **问题排查.md** (markdown/core/问题排查.md)
   - 相关问题: 暂无

3. **Systems文档** (markdown/systems/)
   - 系统交互: 需创建 VIPServerSystem, VIPClientSystem, ShopServerSystem

### 2.2 MODSDK API
- 事件:
  - `AddEntityBuffEvent` - 添加移动速度Buff
  - `ItemUseEvent` - 监听VIP商品使用
- Component:
  - `attrComp` - 获取/设置属性
  - `itemComp` - 物品操作
- 接口:
  - `NotifyToClient` - 通知客户端VIP状态变更

---

## 3. 技术方案

### 3.1 架构设计
```
VIPServerSystem (服务端)
  ├─ VIP数据管理 (存储、查询、更新)
  ├─ 购买逻辑处理
  └─ 速度Buff应用

ShopServerSystem (服务端)
  └─ VIP商品注册

VIPClientSystem (客户端)
  └─ VIP状态UI显示
```

### 3.2 关键实现点
1. **VIP数据持久化**: 使用 `modConfig` 组件存储VIP到期时间
2. **速度加成实现**: 使用 `AddEntityBuffEvent` 添加 `minecraft:speed` Buff
3. **双端同步**: 购买成功后通过 `NotifyToClient` 更新客户端状态
4. **定时检查**: 在玩家登录时检查VIP是否过期

### 3.3 CRITICAL规范检查
- [x] 生命周期: 在`Create()`中初始化Component
- [x] 双端隔离: 使用`NotifyToClient`通信,不跨端调用`GetSystem`
- [x] EventData: 使用`dict`类型: `{"vip_expire": 1699999999}`
- [x] AOI范围: 不涉及AOI
- [x] 模块白名单: 只使用`json`、`time`等标准模块

---

## 4. 实施计划

### 4.1 文件修改清单
| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `scripts/server/VIPServerSystem.py` | 新建 | VIP服务端逻辑 |
| `scripts/client/VIPClientSystem.py` | 新建 | VIP客户端UI |
| `scripts/server/ShopServerSystem.py` | 编辑 | 注册VIP商品 |
| `scripts/modConfig.json` | 编辑 | 注册System |

### 4.2 测试计划
- [ ] 单元测试: 测试购买VIP后数据是否正确存储
- [ ] 集成测试: 测试速度加成是否正确应用
- [ ] 游戏内测试:
  - 购买VIP后移动速度是否增加
  - VIP到期后速度是否恢复正常
  - 客户端UI是否正确显示VIP状态

---

## 5. 风险评估

### 5.1 已识别风险
1. **VIP数据丢失**
   - 影响: 玩家购买的VIP可能在服务器重启后丢失
   - 缓解措施: 使用持久化存储（modConfig + 定期备份）

2. **速度Buff冲突**
   - 影响: 可能与其他模组的速度Buff冲突
   - 缓解措施: 使用唯一Buff ID: `vip_speed_boost`

### 5.2 依赖检查
- [x] 上游依赖: 无（独立模块）
- [ ] 下游影响:
  - 需在 ShopSystem 中注册VIP商品
  - 可能影响竞技平衡（需调整速度加成数值）

---

## 6. 执行日志

### 6.1 修改轮次
详见 [`change-log.md`](./change-log.md)

### 6.2 专家审核
详见 [`solution.md`](./solution.md) (如触发)

---

_最后更新: 2025-11-13 12:05:00_
```

---

## 🔧 自动部署

当你运行 `initmc` 时,工作流会**自动部署**模板到下游项目：

```javascript
// lib/generator.js:184-198

// 7.5. ⭐ 部署任务上下文模板（templates/tasks/context.md.template）
console.log('[生成器] 部署任务上下文模板...');
const templateSourcePath = path.join(this.upstreamPath, 'templates/tasks/context.md.template');
const templateTargetPath = path.join(targetPath, '.claude/core-docs/templates/tasks/context.md.template');

// 确保目标目录存在
ensureDir(path.dirname(templateTargetPath));

// 复制模板文件
if (fs.existsSync(templateSourcePath)) {
  fs.copyFileSync(templateSourcePath, templateTargetPath);
  console.log('[生成器] ✅ 任务上下文模板部署完成');
}
```

---

## 📊 模板变量说明

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `{{TASK_ID}}` | 任务唯一标识 | `task-20251113-120000-添加VIP系统` |
| `{{CREATED_AT}}` | 创建时间 | `2025-11-13 12:00:00` |
| `{{PROJECT_NAME}}` | 项目名称 | `NetEaseMapECBedWars` |
| `{{USER_REQUEST}}` | 用户原始需求 | `添加VIP系统，玩家可以购买VIP获得移动速度加成` |
| `{{TASK_TYPE}}` | 任务类型 | `🟢 微任务` / `🟡 标准任务` / `🔴 复杂任务` |
| `{{MODULES}}` | 涉及的模块 | `VIPServerSystem, ShopSystem` |
| `{{KEY_RULES}}` | 关键CRITICAL规范 | `双端隔离、生命周期、EventData` |
| `{{EVENTS_USED}}` | 使用的事件 | `AddEntityBuffEvent, ItemUseEvent` |
| `{{COMPONENTS_USED}}` | 使用的Component | `attrComp, itemComp` |
| `{{ARCHITECTURE_DIAGRAM}}` | 架构图（文本） | 系统交互关系描述 |

---

## 🎯 最佳实践

### 1. **必填字段优先**

- `1.1 原始需求` - **必填**
- `1.2 任务分类` - **必填**
- `3.3 CRITICAL规范检查` - **必填**

### 2. **章节完整性**

即使某些章节暂时无内容,也应保留章节标题并标注 `待补充`:

```markdown
## 2.2 MODSDK API
- 事件: 待补充
- Component: 待补充
- 接口: 待补充
```

### 3. **链接引用**

在文档中引用其他文件时,使用相对路径:

```markdown
### 6.1 修改轮次
详见 [`change-log.md`](./change-log.md)
```

### 4. **实时更新**

在任务执行过程中,实时更新 `context.md` 的以下章节:

- `3.3 CRITICAL规范检查` - 每次Edit后更新
- `5.1 已识别风险` - 发现新风险时更新
- `6. 执行日志` - 添加轮次链接

---

## 📚 相关文档

- [/mc 工作流指令](./.claude/commands/mc.md)
- [Hook机制](./Hook机制.md)
- [任务恢复机制](./.claude/commands/mc.md#任务恢复)

---

_最后更新: 2025-11-13 | v19.4.2_
