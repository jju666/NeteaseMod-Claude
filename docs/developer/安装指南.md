# NeteaseMod-Claude 工作流生成器 - 安装指南

> **版本**: v21.1.2
> **最后更新**: 2025-11-15
> **适用对象**: 工作流开发者和MODSDK开发者
> **重大更新**: 🎯 智能单命令模式 - initmc 自动完成所有操作

---

## 📋 目录

- [环境要求](#环境要求)
- [安装步骤](#安装步骤)
- [验证安装](#验证安装)
- [首次部署流程](#首次部署流程)
- [常见安装问题排查](#常见安装问题排查)
- [安装流程图](#安装流程图)
- [卸载指南](#卸载指南)

---

## 🔧 环境要求

### 必需环境

| 组件 | 版本要求 | 用途 |
|------|---------|------|
| **Node.js** | ≥ 12.0.0 | 运行工作流生成器 |
| **npm** | ≥ 6.0.0 | 管理依赖包 |
| **Python** | ≥ 3.6 | 运行Hook脚本（工作流驱动） |
| **Git** | ≥ 2.0 | 下载子模块（官方文档） |
| **Claude Code CLI** | 最新版 | AI辅助开发环境 |

### 推荐环境

- **操作系统**: Windows 10+, macOS 10.14+, Linux (Ubuntu 18.04+)
- **终端**: Windows Terminal, PowerShell 7+, Bash, Zsh
- **磁盘空间**: 至少 500MB（包含官方文档）
- **网络**: 稳定的网络连接（首次安装需下载依赖和文档）

### 可选依赖（推荐）

| 组件 | 版本要求 | 用途 | 是否必需 |
|------|---------|------|---------|
| **plyer** | 最新版 | 桌面通知功能（系统原生弹窗） | ❌ 可选（无则降级为终端输出） |

**安装plyer（推荐）**:
```bash
pip install plyer
```

**如果不安装plyer**: 通知系统仍然正常工作，会自动降级为彩色终端输出（完整功能不受影响）。详见[通知功能安装指南](./通知功能安装指南.md)。

### 环境检查命令

```bash
# 检查 Node.js 版本
node --version
# 预期输出: v12.0.0 或更高

# 检查 npm 版本
npm --version
# 预期输出: 6.0.0 或更高

# 检查 Python 版本
python --version
# 预期输出: Python 3.6.0 或更高

# 检查 Git 版本
git --version
# 预期输出: git version 2.x.x

# 检查 Claude Code CLI
claude --version
# 预期输出: Claude Code CLI 版本信息

# 检查 plyer（可选）
python -c "import plyer; print('plyer installed')"
# 预期输出: plyer installed
# 如果报错: ModuleNotFoundError，说明未安装（不影响使用）
```

---

## 📦 安装步骤

### 🚀 方式零：本地开发模式（工作流开发者专用）

**适用场景**：你是工作流的开发者，需要频繁修改Hook代码并测试

#### 优势
- ✅ 修改代码后**立即生效**，无需npm发布
- ✅ 无需npm账号和登录
- ✅ 跳过繁琐的全局安装流程
- ✅ 适合快速迭代开发

#### 使用方法

**方法1: 一键批处理（最简单）**

在工作流项目根目录，双击运行：

```
快速部署到下游.bat
```

**方法2: 命令行**

```bash
# 在工作流项目目录
cd "D:\EcWork\基于Claude的MODSDK开发工作流"

# 部署到指定下游项目
node scripts/deploy-local.js "D:\EcWork\NetEaseMapECBedWars"
```

**工作原理**：
1. 直接从源码目录读取最新的Hook和配置
2. 部署到下游项目的 `.claude/` 目录
3. 修改源码 → 重新运行脚本 → 立即生效

**与其他方式的对比**：

| 维度 | 本地开发模式 | npm全局安装 | npm发布 |
|------|-------------|------------|---------|
| **部署速度** | 5秒 ⚡ | 30秒 | 5分钟+ |
| **需要npm账号** | ❌ | ❌ | ✅ |
| **代码修改后** | 重新运行脚本 | 需重新link | 需发布+更新 |
| **适用场景** | 开发调试 | 个人使用 | 公开分发 |

---

### ⭐ 方式一: npm link（推荐）

> **v20.2.12 新推荐**: 这是最简洁的安装方式，支持实时更新、无残留文件

#### 步骤1: 克隆仓库并安装依赖

```bash
# 克隆项目到本地
git clone https://github.com/jju666/NeteaseMod-Claude.git
cd NeteaseMod-Claude

# 安装npm依赖
npm install
```

#### 步骤2: 创建全局链接

```bash
# 创建全局符号链接
npm link
```

**此步骤执行以下操作**:
- ✅ 在 npm 全局目录创建符号链接到当前项目
- ✅ 注册 `initmc` 全局命令
- ✅ 修改代码后立即生效，无需重新部署
- ✅ `npm unlink` 即可完全卸载，无残留文件

#### 优势对比

| 特性 | npm link | npm run deploy (旧方式) |
|------|----------|------------------------|
| **安装速度** | 5秒 ⚡ | 30秒+ |
| **实时更新** | ✅ 修改代码立即生效 | ❌ 需重新运行 deploy |
| **卸载清理** | ✅ `npm unlink` 完全清理 | ⚠️ 需手动删除多个文件 |
| **版本一致性** | ✅ 始终使用最新代码 | ⚠️ 可能出现版本缓存 |
| **残留文件** | ✅ 无残留 | ⚠️ 用户目录有 .cmd 文件 |

---

### 方式二: 传统安装（已废弃）

> **⚠️ 警告**: 此方式已在 v20.2.12 废弃，推荐使用 `npm link`

如果仍需使用传统方式:

```bash
npm run deploy
```

此命令会显示废弃警告并提示使用 npm link。

---

### 方式三: 本地开发模式（工作流开发者专用）

如果你需要快速测试，无需全局安装:

```bash
# 直接部署到下游项目
node scripts/deploy-local.js "D:\EcWork\NetEaseMapECBedWars"
```

```bash
# 激活别名（仅首次需要）
source ~/.bashrc

# Mac用户（如果使用Zsh）
source ~/.zshrc
```

---

### 方式二: 从npm安装（未发布）

```bash
# 未来支持：全局安装npm包
npm install -g netease-mod-claude

# 安装后可直接使用命令
initmc
```

**注意**: 当前版本未发布到npm，请使用方式一安装。

---

## ✅ 验证安装

### 验证全局命令

```bash
# 测试 initmc 命令
initmc --help
# 预期输出: 工作流部署说明或版本信息

# 测试 uninstallmc 命令
uninstallmc --help
# 预期输出: 工作流卸载说明
```

### 验证全局目录结构

```bash
# Windows
dir %USERPROFILE%\.claude-modsdk-workflow

# Unix/Linux/Mac
ls -la ~/.claude-modsdk-workflow
```

**预期包含以下目录和文件**:

```
.claude-modsdk-workflow/
├── bin/                    # 可执行脚本
│   ├── initmc.js
│   ├── uninstallmc.js
│   ├── merge-conflicts.js
│   └── detect-obsolete.js
├── lib/                    # 核心库
│   ├── init-workflow.js
│   ├── generator.js
│   ├── analyzer.js
│   └── config.js
├── templates/              # 模板文件
│   ├── .claude/
│   └── CLAUDE.md.template
├── markdown/               # 通用文档
│   ├── 开发规范.md
│   ├── 问题排查.md
│   └── 开发指南.md
├── docs/                   # 官方文档（Git Submodule）
│   ├── modsdk-wiki/
│   └── bedrock-wiki/
├── package.json
└── README.md
```

### 验证官方文档下载

```bash
# 检查MODSDK Wiki
ls ~/.claude-modsdk-workflow/docs/modsdk-wiki/

# 检查Bedrock Wiki
ls ~/.claude-modsdk-workflow/docs/bedrock-wiki/
```

**如果官方文档为空**，手动下载:

```bash
cd ~/.claude-modsdk-workflow
git submodule update --init --recursive
```

---

## 🔄 版本更新指南（v20.2.7 新增）

### 自动版本检测

从 v20.2.7 开始，`initmc` 命令会**自动检测**全局工作流版本和项目工作流版本，并在检测到更新时提示你：

```bash
# 在下游项目执行
cd D:/MyProjects/MyMODSDK
initmc

# 输出示例：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 版本检测
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📦 全局工作流版本: v20.2.7
📂 项目工作流版本: v20.2.6

⚠️  检测到新版本可用！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 v20.2.7 更新内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 **BUG修复工作流用户体验增强**

  • ✅ 三文件状态同步机制（workflow-state.json）
  • ✅ Stop Hook 防止重复询问（10分钟静默）
  • ✅ AI 主动引导用户测试验证
  • ✅ 收尾意愿智能检测与自动推进
  • ✅ 任务目录名长度提升到16字符

  📊 改进：AI引导 +100% | 重复询问 -66% | 状态一致性 +33%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 更新方法：
   1. 首先更新全局工作流：
      cd <工作流项目目录>
      npm run install-global

   2. 然后在本项目中执行：
      initmc --sync

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 更新步骤

#### 步骤1: 更新全局工作流

```bash
# 进入工作流项目目录（源代码目录）
cd D:/EcWork/基于Claude的MODSDK开发工作流

# 更新npm依赖（如有）
npm install

# 重新全局安装
npm run install-global
```

#### 步骤2: 同步下游项目

```bash
# 进入下游MODSDK项目
cd D:/MyProjects/MyMODSDK

# 同步最新工作流
initmc --sync
```

**`initmc --sync` 做了什么？**
- 从全局工作流目录复制最新的 Hook 脚本（`.claude/hooks/`）
- 更新配置文件（`.claude/settings.json`、`workflow-config.json`）
- 保留项目特定的文档和自定义配置
- 更新版本标记到 `workflow-manifest.json`

### 快速更新（适合多个下游项目）

如果你有多个MODSDK项目需要更新：

```bash
# Windows批处理示例（创建 update-all.bat）
@echo off
cd D:\MyProjects\Project1
initmc --sync

cd D:\MyProjects\Project2
initmc --sync

cd D:\MyProjects\Project3
initmc --sync

echo 全部项目已更新到最新版本！
pause
```

### 检查当前版本

```bash
# 查看全局工作流版本
cat ~/.claude-modsdk-workflow/package.json | grep version

# 查看项目工作流版本
cat .claude/workflow-manifest.json | grep version
```

---

## 🚀 首次部署流程

安装完成后，在MODSDK项目中首次部署工作流：

### 步骤1: 进入MODSDK项目

```bash
# 进入你的MODSDK项目根目录
cd D:/MyProjects/MyMODSDK

# 验证项目特征（以下文件至少存在一个）
# - modMain.py
# - behavior_packs/xxx/manifest.json
# - world_behavior_packs.json
```

### 步骤2: 执行部署命令

```bash
# 部署工作流到当前项目
initmc
```

**部署过程说明**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  MODSDK 工作流部署工具 v2.0
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ℹ️  当前目录: D:/MyProjects/MyMODSDK

✅ 检测到 MODSDK 项目
   检测依据: modMain.py

🔍 检测全局工作流目录...
✅ 找到全局工作流目录: C:\Users\你的用户名\.claude-modsdk-workflow

📋 复制命令文件...
  ✅ mc.md - 25.3 KB (定制化)
  ✅ discover.md - 8.2 KB
  ✅ enhance-docs.md - 7.5 KB
  ✅ validate-docs.md - 9.1 KB
  ✅ review-design.md - 10.4 KB

📚 复制通用文档...
  ✅ 开发规范.md - 15.2 KB
  ✅ 问题排查.md - 8.3 KB
  ✅ 快速开始.md - 5.1 KB
  ✅ 开发指南.md - 12.4 KB
  ✅ API速查.md - 6.7 KB
  ✅ MODSDK核心概念.md - 4.2 KB

🤖 复制 AI 辅助文档...
  ✅ 任务类型决策表.md - 3.5 KB
  ✅ 快速通道流程.md - 2.8 KB
  ✅ 上下文管理规范.md - 3.1 KB

🔧 复制核心工具库...
  ✅ adaptive-doc-discovery.js - 8.2 KB
  ✅ utils.js - 1.5 KB
  ✅ config.js - 0.9 KB
  ✅ metadata-schema.js - 2.1 KB
  ✅ indexer.js - 4.3 KB
  ✅ search-engine.js - 5.6 KB

⚙️  生成定制化配置...
  ✅ CLAUDE.md - 35.2 KB (全新创建)

📁 创建目录结构...
  ✅ tasks/
  ✅ markdown/systems/

📚 部署官方文档...
✅ 已部署官方文档到 .claude/docs/（软链接）
📁 包含文档：
  - MODSDK Wiki (modsdk-wiki/)
  - Bedrock Wiki (bedrock-wiki/)
ℹ️  ⚡ /mc 指令将优先查询本地文档（速度提升10x）

🔍 验证部署结果...
  ✅ .claude/commands/mc.md - 25.3 KB
  ✅ .claude/commands/discover.md - 8.2 KB
  ✅ .claude/commands/enhance-docs.md - 7.5 KB
  ✅ .claude/commands/validate-docs.md - 9.1 KB
  ✅ .claude/commands/review-design.md - 10.4 KB
  ✅ CLAUDE.md - 35.2 KB
  ✅ lib/adaptive-doc-discovery.js - 8.2 KB

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 核心工作流部署完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 部署内容:
  ✅ 命令文件: 5 个 (/mc, /mc-discover, /mc-docs, /mc-review, /mc-perf)
  ✅ 通用文档: 6 个 (开发规范.md, 问题排查.md等)
  ✅ AI 文档: 3 个
  ✅ 核心工具: 6 个 (lib/目录)
  ✅ 配置文件: 1 个 (CLAUDE.md)

💡 备份保护:
  - 已自动备份现有的 CLAUDE.md 和命令文件（如有）
  - 备份文件格式: 文件名.backup.YYYY-MM-DD
  - 通用文档不备份（可随时覆盖）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 下一步（重要！）⭐

请在 Claude Code 中按顺序执行以下命令：

步骤1: /discover
  功能: 自适应发现项目结构（5-10秒，零Token）
  - 识别MODSDK官方概念（System、Component）
  - 发现项目自定义模式（State、Preset、Manager等）
  - 生成 .claude/discovered-patterns.json 映射文件

步骤2: /validate-docs
  功能: 文档审计与规范化（依赖步骤1的结果）
  - 读取自适应发现结果
  - AI智能推断规范化的中文文档名
  - 检查文档覆盖率
  - 生成文档待补充清单

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 完整工作流（四段式）:
  1. /discover - 自适应发现项目结构（零配置）
  2. /validate-docs - 发现组件并规范化文档结构
  3. /enhance-docs - 批量生成高质量文档内容
  4. /mc "任务描述" - 开发时自动维护文档

🎉 开始体验文档驱动的开发工作流吧！
```

### 步骤3: 在Claude Code中执行工作流初始化

```bash
# 在Claude Code CLI中执行
/discover
```

等待自适应发现完成后：

```bash
/validate-docs
```

---

## 🔍 常见安装问题排查

### 问题1: 命令 `initmc` 未找到

**症状**:
```
'initmc' 不是内部或外部命令，也不是可运行的程序或批处理文件。
```

**原因**:
- Windows: 用户目录未添加到PATH
- Unix/Linux/Mac: 未激活别名或终端未重启

**解决方案**:

**Windows**:
1. 检查 `initmc.cmd` 是否存在:
   ```cmd
   dir %USERPROFILE%\initmc.cmd
   ```
2. 手动添加用户目录到PATH（参见[步骤4](#步骤4-配置环境windows特定)）
3. 重启终端

**Unix/Linux/Mac**:
```bash
# 激活别名
source ~/.bashrc  # 或 source ~/.zshrc

# 验证别名
alias | grep initmc

# 如果别名不存在，手动添加
echo "alias initmc='node ~/.claude-modsdk-workflow/bin/initmc.js'" >> ~/.bashrc
source ~/.bashrc
```

---

### 问题2: Windows中文路径乱码问题

**症状**:
```
任务目录显示为: 任务-1113-214915-淇���澶嶇帺瀹舵���
# 正确应该是: 任务-1113-214915-修复玩家死亡BUG
```

**原因**:
- Windows终端默认使用GBK/CP936编码
- Claude Code传递的用户输入包含中文，但Hook脚本未正确处理编码
- stdin读取时产生代理字符（surrogate characters U+D800-U+DFFF）

**解决方案**（v20.2.5已修复，首次部署不会遇到此问题）:

**如果在旧版本遇到乱码**，更新到最新版本：
```bash
# 1. 更新工作流项目
cd "D:\EcWork\基于Claude的MODSDK开发工作流"
git pull
npm install
npm run deploy

# 2. 同步到下游项目
cd your-modsdk-project
initmc --sync
```

**技术细节**（开发者参考）:
```python
# 所有Hook脚本已添加Windows编码修复（v20.2.5+）
import io
if sys.platform == 'win32':
    sys.stdin = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8', errors='replace')
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')
```

**重要提醒**:
- ❌ **不要**认为是 `os.makedirs()` 无法创建中文路径
- ❌ **不要**尝试使用Windows UNC前缀 `\\?\` 或短路径名API
- ✅ **Python 3.6+完全支持Windows中文目录创建**
- ✅ 问题的真正原因是**stdin编码**，而非文件系统

**验证方法**:
```bash
# 检查任务目录是否包含正确的中文
ls tasks/
# 应该看到类似: 任务-1114-143025-添加VIP系统
```

详见[CLAUDE.md - Windows中文路径问题](../../CLAUDE.md#windows-中文路径问题-v2025)。

---

### 问题3: 依赖安装失败

**症状**:
```
npm ERR! code EACCES
npm ERR! syscall access
npm ERR! path /usr/local/lib/node_modules
```

**原因**:
- npm权限不足
- npm全局安装目录配置问题

**解决方案**:

**方案1: 配置npm使用用户目录（推荐）**
```bash
# 创建全局包目录
mkdir ~/.npm-global

# 配置npm使用该目录
npm config set prefix '~/.npm-global'

# 添加到PATH（Linux/Mac）
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 重新安装
npm install
```

**方案2: 使用sudo（不推荐）**
```bash
sudo npm install
```

---

### 问题4: plyer桌面通知安装（可选）

**症状**:
```
Hook运行正常，但没有系统通知弹窗
```

**原因**:
- 未安装 `plyer` 库，通知系统降级为终端输出

**解决方案**:

**方案1: 使用pip安装（推荐）**
```bash
# 安装plyer
pip install plyer

# 测试通知功能
python templates/.claude/hooks/vscode_notify.py
# 预期: 屏幕右下角弹出3个系统通知
```

**方案2: 使用国内镜像（网络慢时）**
```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple plyer
```

**方案3: 用户目录安装（权限不足时）**
```bash
pip install --user plyer
```

**Linux额外步骤**:
```bash
# Ubuntu/Debian
sudo apt-get install libnotify-bin

# Fedora/CentOS
sudo yum install libnotify

# Arch Linux
sudo pacman -S libnotify
```

**验证安装**:
```bash
python -c "import plyer; print('plyer installed successfully')"
```

**如果不安装plyer会怎样？**
- ✅ **完全可以正常工作**！
- ✅ 通知系统会自动降级为**彩色终端输出**
- ✅ 所有功能不受影响，只是显示方式不同
- 📊 对比：
  - 系统通知：屏幕右下角弹窗，5秒后消失
  - 终端输出：使用ANSI彩色文字 + Emoji图标（ℹ️ ⚠️ ❌）

详见[通知功能安装指南](./通知功能安装指南.md)。

---

### 问题5: Windows软连接权限不足

**症状**:
```
❌ 安装失败：权限不足

⚠️  Windows需要管理员权限来创建符号链接
```

**原因**:
Windows默认需要管理员权限创建符号链接

**解决方案**:

**方案1: 以管理员身份运行（推荐）**
1. 关闭当前终端
2. 右键点击"Windows PowerShell" → "以管理员身份运行"
3. 切换到项目目录:
   ```powershell
   cd "D:\EcWork\基于Claude的MODSDK开发工作流"
   ```
4. 重新运行:
   ```powershell
   npm run install-global
   ```

**方案2: 启用开发者模式（Windows 10+）**
1. 打开"设置" → "更新和安全" → "开发者选项"
2. 打开"开发人员模式"
3. 重启终端后重试

---

### 问题6: Git Submodule下载失败

**症状**:
```
⚠️  文档下载失败，将使用在线查询
```

**原因**:
- 网络不稳定
- Git未安装或版本过低
- 防火墙阻止Git连接

**解决方案**:

**方案1: 手动下载子模块**
```bash
cd ~/.claude-modsdk-workflow
git submodule update --init --recursive

# 如果网络慢，可以单独下载
git submodule update --init docs/modsdk-wiki
git submodule update --init docs/bedrock-wiki
```

**方案2: 使用国内镜像（仅限GitHub）**
```bash
# 配置Git使用国内镜像（临时）
git config --global url."https://ghproxy.com/https://github.com".insteadOf "https://github.com"

# 重新下载
git submodule update --init --recursive

# 恢复默认配置
git config --global --unset url."https://ghproxy.com/https://github.com".insteadOf
```

**方案3: 跳过文档下载（使用在线查询）**
- 工作流会自动降级为在线查询（WebFetch）
- 查询速度稍慢，但不影响功能

---

### 问题7: 检测不到MODSDK项目

**症状**:
```
❌ 未找到 MODSDK 项目

支持的项目类型:
  • 包含 modMain.py 的 MODSDK 项目
  • 包含 behavior pack (manifest.json) 的基岩版项目
  • 包含 world_behavior_packs.json 的网易地图项目
```

**原因**:
- 当前目录不是MODSDK项目
- 项目结构不符合检测规则

**解决方案**:

**检查项目特征文件**:
```bash
# 检查是否存在特征文件（至少一个）
ls modMain.py
ls behavior_packs/*/manifest.json
ls world_behavior_packs.json
```

**如果是子目录项目**，尝试在父目录执行:
```bash
# 工作流会递归搜索子目录（最多10层）
cd ..
initmc
```

**手动指定项目路径**（暂不支持）:
```bash
# 未来版本支持
initmc /path/to/modsdk-project
```

---

### 问题8: Python版本过低

**症状**:
```
SyntaxError: invalid syntax
# 或
ImportError: cannot import name 'TextIOWrapper' from 'io'
```

**原因**:
- Python版本低于3.6
- Hook脚本使用了Python 3.6+的特性（f-string、typing等）

**解决方案**:

**检查Python版本**:
```bash
python --version
# 或
python3 --version
```

**升级Python**:

**Windows**:
1. 访问 https://www.python.org/downloads/
2. 下载Python 3.6+安装包
3. 安装时勾选"Add Python to PATH"
4. 重启终端

**macOS**:
```bash
# 使用Homebrew
brew install python3

# 或下载官方安装包
# https://www.python.org/downloads/macos/
```

**Linux**:
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3.6

# Fedora/CentOS
sudo yum install python36

# Arch Linux
sudo pacman -S python
```

**验证Python版本**:
```bash
python --version
# 预期输出: Python 3.6.0 或更高
```

---

### 问题9: 升级后工作流版本不匹配

**症状**:
```
⚠️  检测到旧版格式，已自动迁移
```

**原因**:
- 项目使用旧版工作流（v15.x或更早）
- 需要迁移到新版内联式架构

**解决方案**:

**自动迁移（推荐）**:
```bash
# 重新执行部署，工作流会自动迁移
initmc
```

**手动迁移**:
1. 备份旧版 `CLAUDE.md`:
   ```bash
   cp CLAUDE.md CLAUDE.md.backup
   ```
2. 查看迁移指南:
   ```bash
   cat markdown/迁移指南-v15.0.md
   ```
3. 从备份中提取自定义内容，粘贴到新版"项目扩展区"

**验证迁移结果**:
```bash
# 检查版本追踪文件
cat .claude/workflow-version.json
```

---

## 📊 安装流程图

### 全局安装流程

```mermaid
graph TD
    A[开始] --> B[克隆仓库<br/>git clone --recursive]
    B --> C[安装依赖<br/>npm install]
    C --> D[执行全局安装<br/>npm run install-global]

    D --> E{检查依赖}
    E -->|缺失| F[自动安装依赖<br/>npm install]
    E -->|完整| G[复制文件到<br/>~/.claude-modsdk-workflow]
    F --> G

    G --> H[安装生产依赖<br/>npm install --production]
    H --> I[下载官方文档<br/>git submodule]

    I --> J{检测操作系统}
    J -->|Windows| K[创建批处理脚本<br/>initmc.cmd<br/>uninstallmc.cmd]
    J -->|Unix/Linux/Mac| L[添加别名到<br/>~/.bashrc<br/>~/.zshrc]

    K --> M{PATH配置}
    M -->|已配置| N[安装完成]
    M -->|未配置| O[手动添加用户目录到PATH]
    O --> N

    L --> P[激活别名<br/>source ~/.bashrc]
    P --> N

    N --> Q[验证安装<br/>initmc --help]
    Q --> R[结束]

    style A fill:#e1f5e1
    style R fill:#e1f5e1
    style N fill:#fff4e1
    style F fill:#ffe1e1
    style O fill:#ffe1e1
```

### 项目部署流程

```mermaid
graph TD
    A[开始] --> B[进入MODSDK项目目录<br/>cd MyProject]
    B --> C[执行部署命令<br/>initmc]

    C --> D{检测项目类型}
    D -->|工作流项目| E[错误：无需部署<br/>退出]
    D -->|未知项目| F[错误：未找到MODSDK特征<br/>退出]
    D -->|MODSDK项目| G[检测全局工作流目录]

    G --> H{v18.0迁移检查}
    H -->|需要迁移| I[执行v18.0迁移<br/>templates/ -> .claude/hooks/]
    H -->|不需要| J[v16.x迁移检查]
    I --> J

    J --> K{需要迁移?}
    K -->|是| L[执行架构迁移<br/>单层 -> 双层]
    K -->|否| M[复制命令文件<br/>.claude/commands/]
    L --> M

    M --> N[复制通用文档<br/>markdown/]
    N --> O[复制AI文档<br/>markdown/AI策略文档/]
    O --> P[复制核心工具库<br/>lib/]

    P --> Q{CLAUDE.md存在?}
    Q -->|否| R[生成新CLAUDE.md<br/>内联式架构]
    Q -->|是| S{检测格式}

    S -->|内联式| T[升级模式<br/>精确替换工作流区域]
    S -->|旧版| U[迁移模式<br/>备份 + 转换为内联式]

    R --> V[创建目录结构<br/>tasks/<br/>markdown/systems/]
    T --> V
    U --> V

    V --> W[部署官方文档<br/>软链接到 .claude/docs/]
    W --> X[验证部署结果]

    X --> Y{验证通过?}
    Y -->|是| Z[输出完成报告<br/>显示下一步提示]
    Y -->|否| AA[错误：验证失败<br/>退出]

    Z --> AB[结束]

    style A fill:#e1f5e1
    style AB fill:#e1f5e1
    style E fill:#ffe1e1
    style F fill:#ffe1e1
    style AA fill:#ffe1e1
    style Z fill:#fff4e1
```

### 工作流初始化流程（部署后）

```mermaid
graph TD
    A[部署完成] --> B[在Claude Code中<br/>打开项目]

    B --> C[执行 /discover<br/>自适应发现项目结构]
    C --> D[扫描代码文件<br/>识别System/Component]
    D --> E[发现自定义模式<br/>State/Preset/Manager]
    E --> F[生成映射文件<br/>.claude/discovered-patterns.json]

    F --> G[执行 /validate-docs<br/>文档审计]
    G --> H[读取自适应发现结果]
    H --> I[AI推断中文文档名<br/>规范化命名]
    I --> J[检查文档覆盖率]
    J --> K[生成待补充清单]

    K --> L{是否批量生成文档?}
    L -->|是| M[执行 /enhance-docs<br/>批量生成文档]
    L -->|否| N[手动编写文档]

    M --> O[AI生成高质量文档<br/>自动填充markdown/systems/]
    N --> O

    O --> P[开始开发<br/>使用 /mc 命令]
    P --> Q[AI自动维护文档<br/>同步更新系统文档]

    Q --> R[工作流就绪<br/>进入开发循环]

    style A fill:#e1f5e1
    style R fill:#e1f5e1
    style F fill:#fff4e1
    style K fill:#fff4e1
    style O fill:#fff4e1
```

---

## 🗑️ 卸载指南

### 从MODSDK项目卸载工作流

```bash
# 在MODSDK项目目录执行
uninstallmc
```

**卸载内容**:
- `.claude/` 目录（命令文件、配置文件）
- `markdown/` 目录（通用文档、AI文档）
- `lib/` 目录（核心工具库）
- `tasks/` 目录（任务文件）
- `CLAUDE.md` 文件

**保留内容**:
- 用户自定义的 `markdown/systems/` 文档（可选保留）
- 项目源代码（behavior_packs/、modMain.py等）

### 卸载全局工作流

```bash
# 删除全局目录
rm -rf ~/.claude-modsdk-workflow

# Windows
rmdir /s /q "%USERPROFILE%\.claude-modsdk-workflow"
```

**手动清理**（如需彻底卸载）:

**Windows**:
1. 删除批处理脚本:
   ```cmd
   del "%USERPROFILE%\initmc.cmd"
   del "%USERPROFILE%\uninstallmc.cmd"
   ```
2. 从PATH中移除用户目录（如果添加过）

**Unix/Linux/Mac**:
1. 编辑 `~/.bashrc` 或 `~/.zshrc`
2. 删除以下行:
   ```bash
   # MODSDK Workflow Generator
   alias initmc="node ~/.claude-modsdk-workflow/bin/initmc.js"
   alias uninstallmc="node ~/.claude-modsdk-workflow/bin/uninstallmc.js"
   ```
3. 重新加载配置:
   ```bash
   source ~/.bashrc
   ```

---

## 📚 附录

### A. 全局目录结构详解

```
~/.claude-modsdk-workflow/
├── bin/                           # 可执行脚本
│   ├── initmc.js                  # 部署命令入口
│   ├── uninstallmc.js             # 卸载命令入口
│   ├── quick-deploy.js            # 快速部署（未使用）
│   ├── merge-conflicts.js         # 合并冲突工具
│   ├── detect-obsolete.js         # 过时文件检测
│   └── install-global.js          # 全局安装脚本
│
├── lib/                           # 核心库
│   ├── init-workflow.js           # 工作流初始化
│   ├── generator.js               # 文档生成器
│   ├── analyzer.js                # 项目分析器
│   ├── config.js                  # 配置管理
│   ├── version-checker.js         # 版本检查
│   ├── symlink-manager.js         # 软链接管理
│   ├── migration-v16.js           # v16.0迁移
│   ├── migration-v16.1.js         # v16.1迁移
│   ├── migration-v18.js           # v18.0迁移
│   ├── obsolete-file-detector.js  # 过时文件检测器
│   ├── adaptive-doc-discovery.js  # 自适应文档发现
│   ├── utils.js                   # 工具函数
│   ├── metadata-schema.js         # 元数据模式
│   ├── indexer.js                 # 文档索引器
│   └── search-engine.js           # 搜索引擎
│
├── templates/                     # 模板文件
│   ├── .claude/                   # Claude Code配置模板
│   │   ├── commands/              # 命令模板
│   │   │   ├── mc.md.template
│   │   │   ├── discover.md
│   │   │   ├── enhance-docs.md
│   │   │   ├── validate-docs.md
│   │   │   └── review-design.md
│   │   ├── hooks/                 # Hooks脚本模板
│   │   │   ├── user-prompt-submit-hook.py
│   │   │   ├── stop-hook.py
│   │   │   ├── enforce-step2.py
│   │   │   ├── enforce-cleanup.py
│   │   │   ├── check-critical-rules.py
│   │   │   ├── log-changes.py
│   │   │   ├── track-doc-reading.py
│   │   │   ├── pre-compact-reminder.py
│   │   │   └── subagent-stop-hook.py
│   │   └── settings.json.template
│   └── CLAUDE.md.template         # CLAUDE.md模板
│
├── markdown/                      # 通用文档
│   ├── 开发规范.md
│   ├── 问题排查.md
│   ├── 快速开始.md
│   ├── 开发指南.md
│   ├── API速查.md
│   ├── MODSDK核心概念.md
│   ├── README.md
│   └── AI策略文档/
│       ├── 任务类型决策表.md
│       ├── 快速通道流程.md
│       └── 上下文管理规范.md
│
├── docs/                          # 官方文档（Git Submodule）
│   ├── modsdk-wiki/               # MODSDK Wiki
│   │   ├── API/
│   │   ├── Components/
│   │   ├── Events/
│   │   └── ...
│   └── bedrock-wiki/              # Bedrock Wiki
│       ├── docs/
│       ├── concepts/
│       └── ...
│
├── scripts/                       # 辅助脚本
│   ├── initmc.js                  # 旧版部署脚本（保留）
│   └── compact-claude.py          # 文档压缩工具
│
├── package.json                   # 项目配置
├── package-lock.json
├── README.md                      # 工作流说明
├── CHANGELOG.md                   # 更新日志
└── .gitignore
```

### B. 项目部署后的目录结构

```
MyMODSDKProject/
├── .claude/                       # Claude Code配置
│   ├── commands/                  # 命令文件
│   │   ├── mc.md                  # 主命令（定制化）
│   │   ├── mc-discover.md         # 结构发现
│   │   ├── mc-docs.md             # 文档验证
│   │   ├── mc-review.md           # 方案审查
│   │   ├── mc-perf.md             # 性能分析
│   │   └── mc-why.md              # 原理解释
│   ├── hooks/                     # Hooks脚本（v18.0+）
│   │   ├── user-prompt-submit-hook.py
│   │   ├── stop-hook.py
│   │   └── ...
│   ├── docs/                      # 官方文档（软链接）
│   │   ├── modsdk-wiki/
│   │   └── bedrock-wiki/
│   ├── core-docs/                 # 核心文档（软链接，v16.0+）
│   ├── discovered-patterns.json   # 自适应发现结果
│   ├── workflow-version.json      # 版本追踪
│   ├── workflow-manifest.json     # 工作流清单（v18.0+）
│   └── settings.json              # Claude Code设置
│
├── lib/                           # 核心工具库
│   ├── adaptive-doc-discovery.js
│   ├── utils.js
│   ├── config.js
│   ├── metadata-schema.js
│   ├── indexer.js
│   └── search-engine.js
│
├── markdown/                      # 文档目录
│   ├── 开发规范.md
│   ├── 问题排查.md
│   ├── 快速开始.md
│   ├── 开发指南.md
│   ├── API速查.md
│   ├── MODSDK核心概念.md
│   ├── README.md                  # 文档导航
│   ├── AI策略文档/
│   │   ├── 任务类型决策表.md
│   │   ├── 快速通道流程.md
│   │   └── 上下文管理规范.md
│   └── systems/                   # 系统实现文档
│       ├── ShopServerSystem.md    # 示例：商店系统文档
│       └── ...
│
├── tasks/                         # 任务文件
│   └── .gitkeep
│
├── behavior_packs/                # MODSDK代码
│   └── MyBehaviorPack/
│       ├── modMain.py
│       ├── manifest.json
│       └── ...
│
└── CLAUDE.md                      # 工作流配置（内联式）
```

### C. 环境变量配置

#### 环境变量说明

| 环境变量 | 说明 | 默认值 |
|---------|------|--------|
| `NETEASE_CLAUDE_HOME` | 全局工作流目录 | `~/.claude-modsdk-workflow` |
| `CLAUDE_WORKFLOW_ROOT` | 工作流根目录（备用） | 未设置 |
| `CLAUDE_AUTO_MIGRATE` | 自动迁移选项（1-4） | 未设置 |

---

#### Windows 环境变量配置（图形界面）

##### 方法1：通过系统设置（推荐）

**步骤1：打开环境变量设置**
```
方式A（Windows 10/11）:
1. 右键"此电脑" → 点击"属性"
2. 点击右侧"高级系统设置"
3. 在"系统属性"窗口点击"环境变量"按钮

方式B（快捷方式）:
1. 按 Win + R 键
2. 输入: sysdm.cpl
3. 点击"高级"选项卡 → "环境变量"按钮

方式C（设置应用）:
1. 打开"设置" → "系统" → "关于"
2. 点击"高级系统设置"
3. 点击"环境变量"按钮
```

**步骤2：配置 PATH 环境变量（让 initmc 命令全局可用）**

在"环境变量"窗口中：

1. **在"用户变量"区域**（上半部分）找到名为 `Path` 的变量
2. 选中 `Path`，点击"编辑"按钮
3. 在弹出的窗口中，点击"新建"按钮
4. 输入你的用户目录路径：
   ```
   C:\Users\你的用户名
   ```
   例如：`C:\Users\Administrator` 或 `C:\Users\张三`
5. 点击"确定"保存

**步骤3：配置自定义工作流目录（可选）**

如果你想将工作流安装到自定义位置（而非默认的 `~/.claude-modsdk-workflow`）：

1. 在"用户变量"区域，点击"新建"按钮
2. 变量名输入：`NETEASE_CLAUDE_HOME`
3. 变量值输入你的自定义路径，例如：
   ```
   D:\MyWorkflow\claude-modsdk
   ```
4. 点击"确定"保存

**步骤4：配置自动迁移模式（可选）**

如果需要自动迁移模式：

1. 在"用户变量"区域，点击"新建"按钮
2. 变量名输入：`CLAUDE_AUTO_MIGRATE`
3. 变量值输入：`1`（或 2、3、4，根据需要）
4. 点击"确定"保存

**步骤5：验证配置**

1. **重启终端**（必须！否则新配置不生效）
2. 打开新的 PowerShell 或 CMD 窗口
3. 验证 PATH：
   ```cmd
   echo %PATH%
   ```
   应该能看到你添加的用户目录路径

4. 验证自定义环境变量：
   ```cmd
   echo %NETEASE_CLAUDE_HOME%
   ```

---

##### 方法2：通过命令行（临时或永久）

**临时设置（仅当前终端有效）**

```cmd
# PowerShell
$env:NETEASE_CLAUDE_HOME = "D:\MyWorkflow"
$env:CLAUDE_AUTO_MIGRATE = "1"

# CMD
set NETEASE_CLAUDE_HOME=D:\MyWorkflow
set CLAUDE_AUTO_MIGRATE=1
```

**永久设置（推荐使用 PowerShell 管理员模式）**

```powershell
# 以管理员身份运行 PowerShell

# 添加用户目录到 PATH
[Environment]::SetEnvironmentVariable(
    "Path",
    [Environment]::GetEnvironmentVariable("Path", "User") + ";$env:USERPROFILE",
    "User"
)

# 设置自定义工作流目录
[Environment]::SetEnvironmentVariable(
    "NETEASE_CLAUDE_HOME",
    "D:\MyWorkflow",
    "User"
)

# 设置自动迁移模式
[Environment]::SetEnvironmentVariable(
    "CLAUDE_AUTO_MIGRATE",
    "1",
    "User"
)

# 刷新当前会话的环境变量
$env:Path = [System.Environment]::GetEnvironmentVariable("Path","User")
```

---

#### Unix/Linux/Mac 环境变量配置

**临时设置（仅当前终端有效）**

```bash
export NETEASE_CLAUDE_HOME=~/my-workflow
export CLAUDE_AUTO_MIGRATE=1
```

**永久设置（写入配置文件）**

```bash
# Bash 用户（~/.bashrc）
echo 'export NETEASE_CLAUDE_HOME=~/my-workflow' >> ~/.bashrc
echo 'export CLAUDE_AUTO_MIGRATE=1' >> ~/.bashrc
source ~/.bashrc

# Zsh 用户（~/.zshrc）- macOS 默认
echo 'export NETEASE_CLAUDE_HOME=~/my-workflow' >> ~/.zshrc
echo 'export CLAUDE_AUTO_MIGRATE=1' >> ~/.zshrc
source ~/.zshrc

# Fish 用户（~/.config/fish/config.fish）
echo 'set -x NETEASE_CLAUDE_HOME ~/my-workflow' >> ~/.config/fish/config.fish
echo 'set -x CLAUDE_AUTO_MIGRATE 1' >> ~/.config/fish/config.fish
source ~/.config/fish/config.fish
```

**验证配置**

```bash
# 检查环境变量
echo $NETEASE_CLAUDE_HOME
echo $CLAUDE_AUTO_MIGRATE

# 检查 PATH（应该包含工作流目录或别名路径）
echo $PATH | grep claude
```

---

#### 常见环境变量问题

**问题1：设置后命令仍然找不到**

**原因**：未重启终端

**解决**：
```bash
# 关闭所有终端窗口，重新打开
# 或者在当前终端重新加载环境变量

# Windows (PowerShell)
$env:Path = [System.Environment]::GetEnvironmentVariable("Path","User") + ";" + [System.Environment]::GetEnvironmentVariable("Path","Machine")

# Unix/Linux/Mac
source ~/.bashrc  # 或 ~/.zshrc
```

**问题2：Windows PATH 过长导致无法保存**

**原因**：PATH 环境变量有长度限制（约 2048 字符）

**解决**：
1. 清理不需要的旧路径
2. 使用短路径名（使用 `SUBST` 命令创建虚拟盘符）
3. 或者使用 PowerShell 脚本动态添加到当前会话

**问题3：环境变量被覆盖**

**原因**：其他程序修改了环境变量

**解决**：
```bash
# 检查是否有多个配置文件冲突
# Windows: 检查系统变量和用户变量
# Unix/Linux/Mac: 检查 ~/.bashrc, ~/.bash_profile, ~/.profile, ~/.zshrc
```

### D. 常用命令速查

| 命令 | 说明 | 使用场景 |
|------|------|---------|
| `npm run install-global` | 全局安装工作流 | 首次安装或更新工作流 |
| `initmc` | 部署工作流到当前项目 | 在MODSDK项目中首次部署 |
| `initmc --sync` | 同步更新工作流 | 更新现有项目的工作流 |
| `initmc --force` 或 `--reset` | 强制重置工作流（清除缓存） | 解决同步问题，两个参数功能相同 |
| `uninstallmc` | 卸载工作流 | 从项目中移除工作流 |
| `merge-conflicts` | 合并冲突工具 | 解决文件冲突 |
| `detect-obsolete` | 检测过时文件 | 清理旧版文件 |

### E. 技术支持

| 资源 | 链接 |
|------|------|
| **GitHub仓库** | https://github.com/jju666/NeteaseMod-Claude |
| **问题反馈** | https://github.com/jju666/NeteaseMod-Claude/issues |
| **MODSDK Wiki** | https://github.com/EaseCation/netease-modsdk-wiki |
| **Bedrock Wiki** | https://github.com/Bedrock-OSS/bedrock-wiki |
| **Claude Code CLI** | https://claude.ai/download |

---

## 📝 更新日志

### v20.2.10 (2025-11-14)
- 🔧 关键BUG修复：unified-workflow-driver Hook完全失效问题
- 🛡️ 新增异常隔离机制，防止单点故障
- ✅ 修复datetime变量作用域错误
- 📚 更新安装指南：补全Python依赖、plyer安装、Windows编码问题

### v20.2.9 (2025-11-14)
- 🧹 GitHub开源发布前清理（删除冗余文件、内部报告）
- ✨ README.md完全重写（从开发者视角改为用户宣传视角）
- 📖 更新文档统计（19篇文档，80,000字，30+流程图）

### v20.2.8 (2025-11-14)
- ✨ 会话历史持久化（.conversation.jsonl）
- 🎯 解决归档机制的会话上下文问题

### v20.2.5 (2025-11-13)
- 🔧 Windows中文路径乱码问题修复（stdin编码）
- 🛡️ 所有Hook脚本添加Windows编码修复

### v18.4.0 (2025-11-13)
- 完善安装指南文档
- 添加详细的流程图（Mermaid）
- 优化问题排查章节

### v18.0.0
- Hook方案3：任务隔离与知识验证机制
- 从 `templates/` 迁移Hooks到 `.claude/hooks/`
- 新增 `workflow-manifest.json` 清单文件

### v16.0.0
- 双层文档架构（核心 + 项目）
- 软链接管理（`.claude/core-docs/`）
- 自适应文档发现（`/discover`）

### v15.0.0
- 内联式 CLAUDE.md 架构
- 精确替换工作流区域
- 版本追踪（`workflow-version.json`）

---

**文档版本**: v2.0
**最后更新**: 2025-11-14
**维护者**: NeteaseMod-Claude Contributors
