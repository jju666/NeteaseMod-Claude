# 快速开始

> **5分钟完成部署和使用**
>
> 本指南帮助你快速上手 NeteaseMod-Claude 工作流系统

---

## 📦 安装部署

### 前置要求

- **Claude Code**: 已安装并配置（[官方安装指南](https://code.claude.com/docs/zh-CN/setup)）
- **Node.js**: v16.0+ （用于initmc部署工具）
- **Python**: 3.8+ （Hook系统运行环境）
- **网易我的世界开发者工具**: 已安装并创建项目

### 一键部署

在你的网易MOD项目根目录执行：

```bash
# 方式1：使用npm脚本
npm run mc:deploy

# 方式2：直接调用initmc
initmc
```

**部署过程**（自动完成）：
1. ✅ 分析项目结构（扫描behavior_packs/resource_packs）
2. ✅ 部署Hook系统（28个文件到`.claude/hooks/`）
3. ✅ 创建配置文件（rules/*.yaml, config/*.json）
4. ✅ 生成斜杠命令（/mc, /code-to-docs等）
5. ✅ 安装Python依赖（anthropic, portalocker, plyer）
6. ✅ 初始化任务目录（tasks/）

**验证部署成功**：

```bash
# 检查Hook目录
ls .claude/hooks/

# 应看到以下结构：
# core/          - 12个核心模块
# lifecycle/     - 5个生命周期Hook
# orchestrator/  - 4个编排Hook
# archiver/      - 1个归档Hook
```

### 卸载

```bash
# 执行卸载命令（会提示确认）
/uninstallmc
```

---

## 🚀 基本使用

### 启动任务工作流

在Claude Code中输入：

```
/mc 修复玩家死亡后装备丢失的BUG
```

**系统响应**（自动化流程）：

```markdown
✅ 任务已激活: 任务-1120-修复玩家死亡后装备丢失
📂 工作目录: tasks/任务-1120-修复玩家死亡后装备丢失/

🤖 当前状态: activation
📋 下一步: 系统将自动分析问题并制定修复方案...
```

### 4步工作流体验

#### 第1步：Activation（任务激活）

**Hook行为**：
- `UserPromptHandler`：解析用户输入，创建任务目录和task-meta.json
- `SessionStart`：如果任务已存在，自动恢复上下文

**用户体验**：
```
你: /mc 修复玩家死亡后装备丢失的BUG

Claude:
✅ 任务已激活！我将帮你修复这个BUG。

📊 任务信息：
- ID: 任务-1120-修复玩家死亡后装备丢失
- 类型: bug_fix（自动识别）
- 状态: activation → planning（自动推进）

让我先分析问题的根本原因...
[AI自动调用Grep/Read工具分析代码]
```

**自动推进**: activation → planning（无需用户确认）

#### 第2步：Planning（方案制定）

**Hook行为**：
- `PreToolUse`：强制AI调用TodoWrite工具制定方案
- `PostToolUse`：更新task-meta.json中的planning_summary
- `Stop`：检测到方案完成，提示用户确认

**用户体验**：
```
Claude:
📋 问题分析：
玩家死亡时，PlayerDieEvent未正确保存装备数据到custom_data。

🛠️ 修复方案（3步）：
1. 修改PlayerDieEvent监听器，在死亡时保存装备到player.custom_data
2. 修改PlayerRespawnEvent监听器，复活时从custom_data恢复装备
3. 添加单元测试验证修复效果

是否同意此方案？（回复"是"开始实施，"不"重新设计）
```

**用户确认**：
```
你: 是

Claude: ✅ 方案已确认，开始实施修复...
```

**状态转移**: planning → implementation（需用户确认）

#### 第3步：Implementation（代码实施）

**Hook行为**：
- `PreToolUse`：4层验证（Stage-Tool-Path-Semantic），防止误操作
- `PostToolUse`：记录每个工具调用到steps数组
- 用户可随时输入"重新设计"触发 implementation → planning 回退

**用户体验**：
```
Claude:
🔧 修复步骤1/3: 修改PlayerDieEvent监听器

[AI调用Edit工具修改代码]

✅ 已完成：保存装备数据逻辑已添加

🔧 修复步骤2/3: 修改PlayerRespawnEvent监听器

[AI调用Edit工具修改代码]

✅ 已完成：装备恢复逻辑已添加

🔧 修复步骤3/3: 添加单元测试

[AI调用Write工具创建测试文件]

✅ 修复完成！请测试验证：
1. 玩家死亡时，装备应保存到custom_data
2. 玩家复活时，装备应自动恢复

确认修复完成？（回复"完成"进入归档，"有问题"继续调试）
```

**用户确认完成**：
```
你: 测试通过，完成

Claude: ✅ 进入任务收尾阶段...
```

**状态转移**: implementation → finalization（需用户确认）

#### 第4步：Finalization（收尾归档）

**Hook行为**：
- `Stop`：生成solution.md总结文档
- `PostArchive`：归档任务到tasks/archive/（可选）

**用户体验**：
```
Claude:
📦 任务归档中...

📄 已生成文档：
- tasks/任务-1120-修复玩家死亡后装备丢失/solution.md

📊 任务统计：
- 耗时: 15分钟
- 工具调用: 12次（Edit×6, Read×4, Write×2）
- 代码修改: 2个文件，+45行

✅ 任务已完成！
```

---

## 📝 任务模板使用

### 功能设计类任务

```
/mc 实现床战争游戏模式的队伍系统
```

**工作流特点**：
- ✅ 自动识别为feature_design类型
- ✅ Planning阶段强制使用TodoWrite工具
- ✅ Planning → Implementation 需用户明确确认方案
- ✅ 支持"重新设计"回退到Planning阶段

### BUG修复类任务

```
/mc 修复TNT爆炸时服务器崩溃的问题
```

**工作流特点**：
- ✅ 自动识别为bug_fix类型
- ✅ Planning阶段聚焦根因分析
- ✅ Implementation阶段优先使用Edit工具（避免重写文件）
- ✅ 强制添加单元测试验证修复效果

### 任务命名规则

**自动生成格式**（task-meta.json中的task_id）：
```
任务-{日期}-{核心关键词}

示例：
- 任务-1120-修复玩家死亡装备丢失
- 任务-1120-实现床战争队伍系统
- 任务-1120-优化爆炸性能
```

**自定义规则**（修改`.claude/config/task_naming.json`）：
```json
{
  "prefix": "任务",
  "date_format": "MMDD",
  "keyword_max_length": 20,
  "separator": "-"
}
```

---

## 🎯 典型场景

### 场景1：快速BUG修复

```bash
# 1. 启动任务
/mc 修复方块破坏后掉落物品重复的BUG

# 2. AI自动分析问题（activation → planning）
# 3. 查看方案，确认开始实施
是

# 4. 等待AI完成代码修改（planning → implementation）
# 5. 本地测试验证
# 6. 确认完成
测试通过，完成

# ✅ 任务完成，自动归档
```

**耗时**: 5-10分钟（取决于BUG复杂度）

### 场景2：大型功能开发

```bash
# 1. 启动任务
/mc 实现完整的经济系统（货币、商店、交易）

# 2. AI制定详细方案（包含多个子任务）
# 3. 仔细审查方案
不，我需要支持多货币类型

# 4. AI重新设计方案（implementation → planning）
# 5. 确认方案后开始实施
是

# 6. 分阶段完成（可能需要多次会话）
# 7. 完整测试后确认
完成

# ✅ 任务完成
```

**耗时**: 1-3小时（可跨多个会话）

### 场景3：中断与恢复

```bash
# 会话1：启动任务
/mc 实现排行榜系统

# [AI开始设计方案...]
# [突然需要处理其他事情，关闭Claude Code]

# --- 几小时后 ---

# 会话2：重新打开Claude Code
# SessionStart Hook自动恢复任务上下文

Claude:
🔄 检测到未完成任务：任务-1120-实现排行榜系统
📊 当前进度：planning阶段，方案设计中...

是否继续此任务？（回复"继续"恢复工作）
```

**关键机制**：
- ✅ `SessionStart` Hook自动扫描tasks/目录
- ✅ 从task-meta.json恢复完整状态
- ✅ 注入context.md到对话上下文
- ✅ 无需手动操作，完全自动化

---

## 🔧 常见问题

### Q1: Hook系统未生效

**症状**：输入`/mc`后，AI没有创建任务目录

**排查步骤**：
```bash
# 1. 检查Hook目录是否存在
ls .claude/hooks/

# 2. 检查Python环境
python --version  # 需要3.8+

# 3. 检查依赖安装
pip list | grep anthropic
pip list | grep portalocker

# 4. 手动触发Hook测试
python .claude/hooks/lifecycle/session_start.py
```

**解决方案**：
```bash
# 重新部署Hook系统
initmc --force
```

### Q2: 任务状态转移失败

**症状**：输入"是"后，状态未从planning切换到implementation

**原因分析**：
- ❌ Claude LLM API调用失败（网络/配额问题）
- ❌ 用户输入不明确（如"可以"、"好的"等模糊表达）
- ❌ task-meta.json文件锁冲突（极少见）

**解决方案**：
```bash
# 方案1：使用明确的确认词
是  # 或：同意、开始实施、执行方案

# 方案2：检查API配置
echo $ANTHROPIC_API_KEY

# 方案3：手动修复状态（仅限紧急情况）
# 编辑 tasks/任务-xxx/.task-meta.json
# 修改 current_stage 字段
```

### Q3: Windows UTF-8编码问题

**症状**：Hook输出乱码，中文显示为`???`

**解决方案**：
```powershell
# 设置系统UTF-8（需要管理员权限）
# 1. 打开"区域设置"
# 2. "管理" → "更改系统区域设置"
# 3. 勾选"Beta: 使用UTF-8提供全球语言支持"
# 4. 重启计算机

# 或设置环境变量
$env:PYTHONIOENCODING="utf-8"

# 永久设置（添加到PowerShell配置文件）
Add-Content $PROFILE '$env:PYTHONIOENCODING="utf-8"'
```

**详细指南**: [Windows-UTF8-升级指南.md](./Windows-UTF8-升级指南.md)

### Q4: 桌面通知不显示

**症状**：任务完成后没有桌面通知弹窗

**原因**：plyer库未安装或系统通知权限未开启

**解决方案**：
```bash
# 安装通知库
pip install plyer

# Windows: 检查系统通知设置
# 设置 → 系统 → 通知和操作 → 允许应用显示通知

# macOS: 检查系统偏好设置
# 系统偏好设置 → 通知与专注模式 → 允许终端通知

# Linux: 安装通知守护进程
sudo apt-get install libnotify-bin  # Debian/Ubuntu
```

### Q5: 任务目录混乱

**症状**：tasks/目录下有很多未完成的任务目录

**清理方案**：
```bash
# 手动归档已完成任务
mv tasks/任务-1120-xxx tasks/archive/

# 删除测试任务（谨慎操作）
rm -rf tasks/任务-1120-测试*

# 重新初始化任务系统（会清空所有任务）
rm -rf tasks/
mkdir tasks/archive
```

---

## 🔍 调试技巧

### 查看Hook执行日志

**方法1：实时输出**
```bash
# Hook的print()输出会显示在Claude Code界面
# 无需额外配置
```

**方法2：文件日志**
```python
# 在Hook脚本中添加日志
import logging
logging.basicConfig(
    filename='.claude/hooks.log',
    level=logging.DEBUG
)
logging.info("Hook executed successfully")
```

### 手动测试Hook

```bash
# 测试SessionStart
python .claude/hooks/lifecycle/session_start.py

# 测试UserPromptHandler（模拟用户输入）
echo "/mc 测试任务" | python .claude/hooks/orchestrator/user_prompt_handler.py

# 测试PostToolUse（模拟工具调用）
python .claude/hooks/orchestrator/posttooluse_updater.py <<EOF
{
  "tool": "Read",
  "parameters": {"file_path": "test.py"}
}
EOF
```

### 检查任务元数据

```bash
# 查看当前任务状态
cat tasks/任务-1120-xxx/.task-meta.json | python -m json.tool

# 关键字段说明
# - current_stage: 当前状态（activation/planning/implementation/finalization）
# - planning_summary: 方案总结
# - steps: 已执行的工具调用记录
# - architecture_version: 架构版本（应为"21.0"）
```

---

## 📚 下一步

完成基本使用后，建议阅读：

- **[架构概览](./架构概览.md)** - 深入理解8个Hook的协同机制
- **[HOOK正确用法文档](./HOOK正确用法文档.md)** - Hook开发标准
- **[Claude语义分析器使用指南](./Claude语义分析器使用指南.md)** - LLM集成原理
- **[Hook状态机功能实现](./Hook状态机功能实现.md)** - 完整工作流实现

---

**文档维护**: Claude Code Development Team
**最后更新**: 2025-11-20
**适用版本**: v25.0+
