# MODSDK å·¥ä½œæµæ•°æ®æµè®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-13
> **é€‚ç”¨ç‰ˆæœ¬**: v18.4.0+

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [initmc å‘½ä»¤æ‰§è¡Œæµç¨‹](#initmc-å‘½ä»¤æ‰§è¡Œæµç¨‹)
4. [æ•°æ®è½¬æ¢æµç¨‹](#æ•°æ®è½¬æ¢æµç¨‹)
5. [æ¨¡æ¿å¤„ç†æœºåˆ¶](#æ¨¡æ¿å¤„ç†æœºåˆ¶)
6. [æ–‡æ¡£ç”Ÿæˆæµç¨‹](#æ–‡æ¡£ç”Ÿæˆæµç¨‹)
7. [è½¯è¿æ¥ç®¡ç†æœºåˆ¶](#è½¯è¿æ¥ç®¡ç†æœºåˆ¶)
8. [æ•°æ®æ¨¡å‹å®šä¹‰](#æ•°æ®æ¨¡å‹å®šä¹‰)

---

## æ¦‚è¿°

### è®¾è®¡ç›®æ ‡

MODSDK å·¥ä½œæµé‡‡ç”¨**æ¨¡æ¿é©±åŠ¨ + æ•°æ®è½¬æ¢**çš„æ¶æ„æ¨¡å¼ï¼Œå®ç°ï¼š

1. **é›¶é…ç½®éƒ¨ç½²**: ç”¨æˆ·æ‰§è¡Œ `initmc` å³å¯å®Œæˆå·¥ä½œæµéƒ¨ç½²
2. **æ™ºèƒ½åˆ†æ**: è‡ªåŠ¨åˆ†æé¡¹ç›®ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œæ¶æ„ç‰¹å¾
3. **æ¨¡æ¿å¤ç”¨**: é€šè¿‡å ä½ç¬¦æ›¿æ¢æœºåˆ¶å®ç°æ¨¡æ¿å®šåˆ¶åŒ–
4. **åŒå±‚æ–‡æ¡£æ¶æ„**: ä¸Šæ¸¸åŸºçº¿æ–‡æ¡£ + é¡¹ç›®è¦†ç›–å±‚ï¼Œæ”¯æŒé›¶é£é™©å‡çº§
5. **è½¯è¿æ¥ç®¡ç†**: è·¨å¹³å°è½¯è¿æ¥æœºåˆ¶ï¼Œä¼˜é›…é™çº§ä¸ºåªè¯»å‰¯æœ¬

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|-----|---------|-----|
| **å…¥å£è„šæœ¬** | `scripts/initmc.js` | CLI å‘½ä»¤å…¥å£ï¼Œé¡¹ç›®æ£€æµ‹ä¸éƒ¨ç½²æµç¨‹ç¼–æ’ |
| **å·¥ä½œæµåˆå§‹åŒ–å™¨** | `lib/init-workflow.js` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå„æ¨¡å—æ‰§è¡Œå·¥ä½œæµåˆå§‹åŒ– |
| **é¡¹ç›®åˆ†æå™¨** | `lib/analyzer.js` | æ‰«æä»£ç ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œå¤æ‚åº¦ |
| **æ–‡æ¡£ç”Ÿæˆå™¨** | `lib/generator.js` | åŸºäºåˆ†ææŠ¥å‘Šå’Œæ¨¡æ¿ç”Ÿæˆå®šåˆ¶åŒ–æ–‡æ¡£ |
| **è½¯è¿æ¥ç®¡ç†å™¨** | `lib/symlink-manager.js` | åˆ›å»ºå’Œç®¡ç†ä¸Šæ¸¸æ–‡æ¡£åˆ°ä¸‹æ¸¸é¡¹ç›®çš„å¼•ç”¨ |
| **é…ç½®ç®¡ç†å™¨** | `lib/config.js` | å…¨å±€é…ç½®ã€å¸¸é‡å®šä¹‰ã€è·¯å¾„è§£æ |

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚æ¶æ„æ¨¡å¼

```mermaid
graph TB
    subgraph "Layer 1: CLI å±‚"
        A[initmc CLI] --> B{é¡¹ç›®ç±»å‹æ£€æµ‹}
        B -->|MODSDK| C[ç¡®å®šé¡¹ç›®æ ¹ç›®å½•]
        B -->|å·¥ä½œæµ| D[æ‹’ç»éƒ¨ç½²]
        B -->|æœªçŸ¥| E[é€’å½’æœç´¢å­ç›®å½•]
    end

    subgraph "Layer 2: ä¸šåŠ¡é€»è¾‘å±‚"
        C --> F[init-workflow.js]
        F --> G[é¡¹ç›®åˆ†æ]
        F --> H[æ–‡æ¡£ç”Ÿæˆ]
        F --> I[è½¯è¿æ¥ç®¡ç†]
        F --> J[ç‰ˆæœ¬è¿½è¸ª]
    end

    subgraph "Layer 3: æ•°æ®å¤„ç†å±‚"
        G --> K[ProjectAnalyzer]
        H --> L[DocumentGenerator]
        I --> M[SymlinkManager]
        J --> N[VersionChecker]
    end

    subgraph "Layer 4: æ¨¡æ¿èµ„æºå±‚"
        L --> O[templates/]
        M --> P[markdown/æ ¸å¿ƒæ–‡æ¡£]
        L --> Q[å ä½ç¬¦æ›¿æ¢å¼•æ“]
    end

    style A fill:#4CAF50
    style F fill:#2196F3
    style K fill:#FF9800
    style L fill:#FF9800
    style M fill:#FF9800
    style O fill:#9C27B0
```

---

## initmc å‘½ä»¤æ‰§è¡Œæµç¨‹

### å®Œæ•´æ‰§è¡Œåºåˆ—å›¾

```mermaid
sequenceDiagram
    autonumber

    participant User as ç”¨æˆ·
    participant CLI as initmc CLI
    participant Detector as é¡¹ç›®æ£€æµ‹å™¨
    participant Init as init-workflow.js
    participant Analyzer as ProjectAnalyzer
    participant Generator as DocumentGenerator
    participant Symlink as SymlinkManager
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    User->>CLI: æ‰§è¡Œ initmc

    rect rgb(255, 245, 235)
        Note over CLI,Detector: ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®æ£€æµ‹ä¸éªŒè¯
        CLI->>Detector: detectProjectType(cwd)
        Detector->>FS: æ£€æŸ¥ modMain.py
        FS-->>Detector: è¿”å›è·¯å¾„æˆ–null
        Detector->>FS: æ£€æŸ¥ manifest.json
        FS-->>Detector: è¿”å›ç‰¹å¾ä¿¡æ¯
        Detector->>Detector: inferProjectRoot()
        Detector-->>CLI: {type, projectDir, feature}

        alt é¡¹ç›®ç±»å‹ = å·¥ä½œæµ
            CLI-->>User: é”™è¯¯ï¼šå½“å‰æ˜¯å·¥ä½œæµé¡¹ç›®æœ¬èº«
        else é¡¹ç›®ç±»å‹ = æœªçŸ¥
            CLI->>Detector: findModSDKProjects(é€’å½’æœç´¢)
            Detector-->>CLI: å€™é€‰é¡¹ç›®åˆ—è¡¨
            alt æ‰¾åˆ°å¤šä¸ªé¡¹ç›®
                CLI-->>User: æç¤ºï¼šè¯·åœ¨å…·ä½“é¡¹ç›®ç›®å½•æ‰§è¡Œ
            end
        end
    end

    rect rgb(232, 245, 233)
        Note over CLI,Init: ç¬¬äºŒé˜¶æ®µï¼šå·¥ä½œæµåˆå§‹åŒ–
        CLI->>Init: main(projectPath)

        Init->>Init: è§£æå‘½ä»¤è¡Œå‚æ•°
        Note right of Init: --sync / --force(--reset) /<br/>--auto-migrate

        alt åŒæ­¥æ¨¡å¼ (--sync)
            Init->>Init: syncWorkflow()
            Note right of Init: ç‰ˆæœ¬æ£€æµ‹<br/>è½¯è¿æ¥æ›´æ–°<br/>åºŸå¼ƒæ–‡ä»¶æ¸…ç†
        else é¦–æ¬¡éƒ¨ç½²æˆ–é‡æ–°éƒ¨ç½²
            Init->>Init: æ£€æµ‹è¿ç§»éœ€æ±‚
            Note right of Init: v18.0 / v16.1 / v16.0

            Init->>Analyzer: analyze(projectPath)
        end
    end

    rect rgb(227, 242, 253)
        Note over Analyzer,FS: ç¬¬ä¸‰é˜¶æ®µï¼šé¡¹ç›®åˆ†æ
        Analyzer->>FS: æ‰«æ Python æ–‡ä»¶
        FS-->>Analyzer: *.py æ–‡ä»¶åˆ—è¡¨
        Analyzer->>Analyzer: _analyzePythonFile()
        Note right of Analyzer: æå– System ç±»<br/>æå– Preset ç±»<br/>è®¡ç®—å¤æ‚åº¦
        Analyzer->>Analyzer: _detectProjectType()
        Analyzer->>Analyzer: _calculateProjectScale()
        Analyzer-->>Init: AnalysisReport
        Note right of Init: åŒ…å«ï¼šmetadata<br/>codeStructure<br/>docCoverage
    end

    rect rgb(248, 231, 253)
        Note over Init,Generator: ç¬¬å››é˜¶æ®µï¼šæ–‡æ¡£ç”Ÿæˆ
        Init->>Generator: new DocumentGenerator(report, upstreamPath)
        Init->>Generator: generateAll(projectPath, {minimalMode: true})

        Generator->>Generator: _createDirectoryStructure()
        Generator->>FS: åˆ›å»ºç›®å½•

        Generator->>Generator: _generateLayer1()
        Note right of Generator: é€šç”¨å±‚ï¼šæ ¸å¿ƒå·¥ä½œæµ
        Generator->>Generator: _buildReplacements()
        Note right of Generator: æ„å»ºå ä½ç¬¦æ›¿æ¢è¡¨
        Generator->>Generator: _generateFromTemplate()
        Note right of Generator: mc.md, mc-review.md,<br/>mc-perf.md, etc.
        Generator->>Generator: _deployHooks()
        Note right of Generator: éƒ¨ç½² Hook æ–‡ä»¶
        Generator->>FS: å†™å…¥å‘½ä»¤æ–‡ä»¶

        Generator->>Generator: _generateMinimalCLAUDE()
        Note right of Generator: é¦–æ¬¡éƒ¨ç½²ï¼šç”Ÿæˆæ¨¡æ¿<br/>å·²å­˜åœ¨ï¼šè·³è¿‡
        Generator->>FS: å†™å…¥ CLAUDE.md
    end

    rect rgb(255, 243, 224)
        Note over Init,Symlink: ç¬¬äº”é˜¶æ®µï¼šè½¯è¿æ¥ç®¡ç†
        Init->>Symlink: new SymlinkManager(upstreamPath, projectPath)
        Init->>Symlink: createAllSymlinks()

        Symlink->>Symlink: _getCoreFiles()
        Note right of Symlink: æ‰«æ markdown/ ç›®å½•<br/>è¿‡æ»¤æ ¸å¿ƒæ–‡æ¡£

        loop æ¯ä¸ªæ ¸å¿ƒæ–‡æ¡£
            Symlink->>Symlink: createSymlink(file)
            Symlink->>FS: å°è¯•åˆ›å»ºè½¯è¿æ¥
            alt æˆåŠŸ
                FS-->>Symlink: è½¯è¿æ¥åˆ›å»ºæˆåŠŸ
            else å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰
                Symlink->>Symlink: _createReadonlyCopy()
                Symlink->>FS: å¤åˆ¶æ–‡ä»¶ + æ·»åŠ åªè¯»æ ‡è®°
                FS-->>Symlink: åªè¯»å‰¯æœ¬åˆ›å»ºæˆåŠŸ
            end
        end

        Symlink-->>Init: ç»“æœç»Ÿè®¡

        Init->>Symlink: createMarkdownSymlinks()
        Note right of Symlink: åœ¨ markdown/ åˆ›å»º<br/>æŒ‡å‘ .claude/core-docs/ çš„å¼•ç”¨
    end

    rect rgb(255, 249, 196)
        Note over Init,User: ç¬¬å…­é˜¶æ®µï¼šå®ŒæˆæŠ¥å‘Š
        Init->>Init: ç”Ÿæˆç‰ˆæœ¬è¿½è¸ªæ–‡ä»¶
        Note right of Init: .claude/workflow-manifest.json
        Init-->>User: âœ… æ ¸å¿ƒå·¥ä½œæµéƒ¨ç½²å®Œæˆ
        Note right of User: è¾“å‡ºéƒ¨ç½²å†…å®¹æ‘˜è¦<br/>ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®
    end
```

### å…³é”®æ•°æ®æµè½¬

#### è¾“å…¥æ•°æ®

| æ•°æ®æº | æ•°æ®ç±»å‹ | ç¤ºä¾‹ |
|-------|---------|-----|
| **å‘½ä»¤è¡Œå‚æ•°** | `args[]` | `['--sync', '--auto-migrate=1']` |
| **å½“å‰å·¥ä½œç›®å½•** | `process.cwd()` | `D:/MyProject` |
| **ç¯å¢ƒå˜é‡** | `process.env` | `CLAUDE_AUTO_MIGRATE=1` |

#### ä¸­é—´æ•°æ®

| æ•°æ®ç»“æ„ | ç”Ÿæˆé˜¶æ®µ | ç”¨é€” |
|---------|---------|-----|
| **AnalysisReport** | é¡¹ç›®åˆ†æ | ä¼ é€’ç»™æ–‡æ¡£ç”Ÿæˆå™¨ |
| **Replacements** | å ä½ç¬¦æ„å»º | æ¨¡æ¿å˜é‡æ›¿æ¢ |
| **CoreFilesList** | è½¯è¿æ¥ç®¡ç† | ç¡®å®šéœ€è¦å¼•ç”¨çš„æ–‡æ¡£ |

#### è¾“å‡ºæ•°æ®

| äº§ç‰© | è·¯å¾„ | è¯´æ˜ |
|-----|------|-----|
| **å‘½ä»¤æ–‡ä»¶** | `.claude/commands/*.md` | 6ä¸ªæ ¸å¿ƒå‘½ä»¤ |
| **Hook æ–‡ä»¶** | `.claude/hooks/*.py` | ä»»åŠ¡éš”ç¦»æœºåˆ¶ |
| **è½¯è¿æ¥** | `.claude/core-docs/` | ä¸Šæ¸¸æ–‡æ¡£å¼•ç”¨ |
| **é…ç½®æ–‡ä»¶** | `.claude/settings.json` | Claude Code é…ç½® |
| **ç‰ˆæœ¬è¿½è¸ª** | `.claude/workflow-manifest.json` | ç‰ˆæœ¬å·ã€å®‰è£…æ—¶é—´ã€åŸºçº¿å“ˆå¸Œ |

---

## æ•°æ®è½¬æ¢æµç¨‹

### é¡¹ç›®ç‰¹å¾ â†’ åˆ†ææŠ¥å‘Š

```mermaid
flowchart TD
    A[æ‰«æ Python æ–‡ä»¶] --> B{æ£€æµ‹ç±»å®šä¹‰}
    B -->|class XXXSystem| C[æå– System ä¿¡æ¯]
    B -->|class XXXPreset| D[æå– Preset ä¿¡æ¯]

    C --> E[è®¡ç®—å¤æ‚åº¦è¯„åˆ†]
    E --> E1[å› ç´ 1: ä»£ç è¡Œæ•°]
    E --> E2[å› ç´ 2: æ–¹æ³•æ•°é‡]
    E --> E3[å› ç´ 3: äº‹ä»¶ç›‘å¬æ•°]
    E --> E4[å› ç´ 4: æ ¸å¿ƒå…³é”®è¯]
    E --> E5[å› ç´ 5: ä¾èµ–å…³ç³»]

    E1 & E2 & E3 & E4 & E5 --> F[complexityScore: 0-10]

    F --> G{æ¨èè¯¦ç»†åº¦}
    G -->|score â‰¥ 8| H[detailed: 3000å­—]
    G -->|5 â‰¤ score < 8| I[medium: 1500å­—]
    G -->|score < 5| J[simple: 500å­—]

    H & I & J --> K[SystemInfoå¯¹è±¡]
    D --> L[PresetInfoå¯¹è±¡]

    K & L --> M[CodeStructure]
    M --> N[AnalysisReport]

    O[é¡¹ç›®ç±»å‹æ¨æ–­] --> N
    P[æ¶æ„ç‰¹å¾æ£€æµ‹] --> N
    Q[æ–‡æ¡£è¦†ç›–ç‡ç»Ÿè®¡] --> N

    style A fill:#4CAF50
    style N fill:#2196F3
    style G fill:#FF9800
```

#### å¤æ‚åº¦è¯„åˆ†ç®—æ³•

```javascript
// lib/analyzer.js: SystemInfo._calculateComplexity()

let score = 0;

// å› ç´ 1: ä»£ç è¡Œæ•° (æœ€é«˜3åˆ†)
if (linesOfCode > 500) score += 3;
else if (linesOfCode > 200) score += 2;
else score += 1;

// å› ç´ 2: æ–¹æ³•æ•°é‡ (æœ€é«˜2åˆ†)
if (methodCount > 15) score += 2;
else if (methodCount > 5) score += 1;

// å› ç´ 3: äº‹ä»¶ç›‘å¬æ•° (æœ€é«˜1åˆ†)
if (eventListeners > 5) score += 1;

// å› ç´ 4: æ ¸å¿ƒå…³é”®è¯ (æœ€é«˜2åˆ†)
const coreKeywords = ['core', 'manager', 'game', 'state', 'main'];
if (coreKeywords.some(k => name.toLowerCase().includes(k))) score += 2;

// å› ç´ 5: ä¾èµ–å…³ç³» (æœ€é«˜2åˆ†)
if (importCount > 5) score += 2;
else if (importCount > 2) score += 1;

return score; // èŒƒå›´ï¼š1-10
```

### åˆ†ææŠ¥å‘Š â†’ å ä½ç¬¦æ›¿æ¢è¡¨

```mermaid
flowchart LR
    A[AnalysisReport] --> B[_buildReplacements]

    B --> C1["{{PROJECT_PATH}}"]
    B --> C2["{{PROJECT_NAME}}"]
    B --> C3["{{CURRENT_DATE}}"]
    B --> C4["{{VERSION}}"]
    B --> C5["{{EXAMPLE_TASKS}}"]
    B --> C6["{{CRITICAL_RULES}}"]
    B --> C7["æ›´å¤šå ä½ç¬¦..."]

    C1 --> D[æ›¿æ¢è¡¨å¯¹è±¡]
    C2 --> D
    C3 --> D
    C4 --> D
    C5 --> D
    C6 --> D
    C7 --> D

    D --> E[ä¼ é€’ç»™æ¨¡æ¿å¼•æ“]

    style A fill:#4CAF50
    style B fill:#FF9800
    style D fill:#2196F3
    style E fill:#9C27B0
```

#### å ä½ç¬¦ç”Ÿæˆé€»è¾‘

| å ä½ç¬¦ | ç”Ÿæˆé€»è¾‘ | ç¤ºä¾‹å€¼ |
|-------|---------|-------|
| `{{PROJECT_PATH}}` | `normalizePathForMarkdown(targetPath)` | `D:/MyProject` |
| `{{PROJECT_NAME}}` | `metadata.projectName` | `NetEaseMapECBedWars` |
| `{{CURRENT_DATE}}` | `getCurrentDate()` | `2025-11-13` |
| `{{VERSION}}` | `config.VERSION` | `18.4.0` |
| `{{EXAMPLE_TASKS}}` | `_generateExampleTasks()` | æ ¹æ® `businessType` ç”Ÿæˆ |
| `{{CRITICAL_RULES}}` | `_generateCriticalRulesSection()` | æ ¹æ® `usesApollo`, `usesEcpreset` ç”Ÿæˆ |
| `{{ARCHITECTURE_DOCS_SECTION}}` | `_generateArchitectureDocs()` | æ ¹æ® `usesApollo` ç”Ÿæˆ |
| `{{BUSINESS_DOCS_SECTION}}` | `_generateBusinessDocs()` | æ ¹æ® `businessType` ç”Ÿæˆ |

---

## æ¨¡æ¿å¤„ç†æœºåˆ¶

### æ¨¡æ¿å¼•æ“å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    A[è¯»å–æ¨¡æ¿æ–‡ä»¶] --> B{æ¨¡æ¿ç±»å‹}

    B -->|é™æ€æ¨¡æ¿| C[.md.template]
    B -->|é…ç½®æ¨¡æ¿| D[.json.template]
    B -->|Hook æ¨¡æ¿| E[.sh.template / .py]

    C --> F[replacePlaceholders]
    D --> F
    E --> F

    F --> G{å ä½ç¬¦æ›¿æ¢}
    G -->|ç®€å•æ›¿æ¢| H["content.replace({{KEY}}, value)"]
    G -->|æ¡ä»¶æ¸²æŸ“| I["åˆ¤æ–­ businessType/æ¶æ„ç‰¹å¾"]

    H --> J[æ›¿æ¢åå†…å®¹]
    I --> J

    J --> K{ç›®æ ‡æ–‡ä»¶å­˜åœ¨?}
    K -->|å¦| L[ç›´æ¥å†™å…¥]
    K -->|æ˜¯| M{æ–‡ä»¶ç±»å‹}

    M -->|å‘½ä»¤æ–‡ä»¶| N[å¤‡ä»½ + è¦†ç›–]
    M -->|CLAUDE.md| O[æ™ºèƒ½åˆå¹¶]
    M -->|Hook æ–‡ä»¶| P[ç›´æ¥è¦†ç›–]

    L --> Q[å†™å…¥æ–‡ä»¶ç³»ç»Ÿ]
    N --> Q
    O --> Q
    P --> Q

    style A fill:#4CAF50
    style F fill:#FF9800
    style Q fill:#2196F3
```

### æ¨¡æ¿æ–‡ä»¶ç»“æ„

```
templates/
â”œâ”€â”€ .claude/
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ mc.md.template                    # ä¸»å‘½ä»¤æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-review.md.template             # æ–¹æ¡ˆå®¡æŸ¥æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-perf.md.template               # æ€§èƒ½åˆ†ææ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-docs.md.template               # æ–‡æ¡£å®¡è®¡æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-why.md.template                # ä»£ç è¿½æº¯æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ mc-discover.md.template           # é¡¹ç›®å‘ç°æ¨¡æ¿
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ user-prompt-submit-hook.py        # ç”¨æˆ·æäº¤æ‹¦æˆª
â”‚   â”‚   â”œâ”€â”€ enforce-step2.py                  # æ­¥éª¤2å¼ºåˆ¶æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ track-doc-reading.py              # æ–‡æ¡£é˜…è¯»è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ enforce-cleanup.py                # æ¸…ç†å¼ºåˆ¶æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ stop-hook.py                      # åœæ­¢é’©å­
â”‚   â”‚   â””â”€â”€ README.md                         # Hook è¯´æ˜æ–‡æ¡£
â”‚   â””â”€â”€ settings.json.template                # Claude Code é…ç½®æ¨¡æ¿
â”œâ”€â”€ markdown/
â”‚   â”œâ”€â”€ README.md.template                    # æ–‡æ¡£å¯¼èˆªæ¨¡æ¿
â”‚   â”œâ”€â”€ ç´¢å¼•.md.template                      # é¡¹ç›®ç´¢å¼•æ¨¡æ¿
â”‚   â””â”€â”€ é¡¹ç›®çŠ¶æ€.md.template                  # é¡¹ç›®çŠ¶æ€æ¨¡æ¿
â”œâ”€â”€ CLAUDE.md.template                        # AI å·¥ä½œæµæ€»è§ˆæ¨¡æ¿
â””â”€â”€ README.md.template                        # é¡¹ç›® README æ¨¡æ¿
```

### å ä½ç¬¦æ›¿æ¢å¼•æ“

#### æ ¸å¿ƒå®ç°ï¼ˆlib/utils.jsï¼‰

```javascript
function replacePlaceholders(content, replacements) {
  let result = content;

  for (const [placeholder, value] of Object.entries(replacements)) {
    // å…¨å±€æ›¿æ¢ï¼Œæ”¯æŒå¤šæ¬¡å‡ºç°
    const regex = new RegExp(escapeRegExp(placeholder), 'g');
    result = result.replace(regex, value);
  }

  return result;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
```

#### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹

```markdown
<!-- templates/.claude/commands/mc.md.template -->

## ä»»åŠ¡æ‰§è¡Œç¤ºä¾‹

{{EXAMPLE_TASKS}}

{{#if usesApollo}}
## Apollo æ¶æ„æ³¨æ„äº‹é¡¹
{{ARCHITECTURE_DOCS_SECTION}}
{{/if}}

{{#if businessType === 'RPG'}}
## NBT å…¼å®¹æ€§æ£€æŸ¥
{{NBT_CHECK_SECTION}}
{{/if}}
```

ç”Ÿæˆå™¨ä¼šæ ¹æ®é¡¹ç›®ç‰¹å¾åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„å†…å®¹ï¼š

```javascript
// lib/generator.js
_buildReplacements(targetPath) {
  const replacements = {
    '{{EXAMPLE_TASKS}}': this._generateExampleTasks(),
    '{{ARCHITECTURE_DOCS_SECTION}}': this._generateArchitectureDocs(),
    '{{NBT_CHECK_SECTION}}': this.metadata.businessType === 'RPG'
      ? this._generateNBTSection()
      : ''
  };
  return replacements;
}
```

---

## æ–‡æ¡£ç”Ÿæˆæµç¨‹

### ä¸‰å±‚æ–‡æ¡£æ¶æ„

```mermaid
flowchart TD
    A[DocumentGenerator.generateAll] --> B{minimalMode?}

    B -->|true æœ€å°åŒ–æ¨¡å¼| C[Layer 1: é€šç”¨å±‚]
    B -->|false å®Œæ•´æ¨¡å¼| D[Layer 1 + Layer 2 + Layer 3]

    C --> C1[_generateLayer1]
    C1 --> C11[ç”Ÿæˆå‘½ä»¤æ–‡ä»¶]
    C1 --> C12[éƒ¨ç½² Hook æ–‡ä»¶]
    C1 --> C13[ç”Ÿæˆ CLAUDE.md]
    C1 --> C14[åˆ›å»ºè½¯è¿æ¥]
    C1 --> C15[ç”Ÿæˆç‰ˆæœ¬è¿½è¸ª]

    D --> D1[_generateLayer1]
    D1 --> D2[_generateLayer2]
    D2 --> D21[ç”Ÿæˆ Systems æ–‡æ¡£]
    D2 --> D22[æ™ºèƒ½æ–‡æ¡£ç»´æŠ¤]

    D2 --> D3[_generateLayer3]
    D3 --> D31[ç”Ÿæˆä¸šåŠ¡å±‚æ¡†æ¶]

    D3 --> D4[_generateTodoList]
    D4 --> D41[ç”Ÿæˆæ–‡æ¡£å¾…è¡¥å……æ¸…å•]

    C15 --> E[éƒ¨ç½²å®Œæˆ]
    D41 --> E

    style A fill:#4CAF50
    style C fill:#2196F3
    style D fill:#FF9800
    style E fill:#9C27B0
```

### Layer 1: é€šç”¨å±‚ç”Ÿæˆæµç¨‹å›¾

```mermaid
flowchart TD
    A[_generateLayer1] --> B[_buildReplacements]
    B --> C[æ„å»ºå ä½ç¬¦æ›¿æ¢è¡¨]

    C --> D{CLAUDE.md å­˜åœ¨?}
    D -->|å¦| E[_generateMinimalCLAUDE]
    D -->|æ˜¯| F[è·³è¿‡ç”Ÿæˆ]

    E --> G[ç”Ÿæˆæœ€å°åŒ–æ¨¡æ¿]
    G --> H[å†™å…¥æ–‡ä»¶ç³»ç»Ÿ]

    F --> I[_cleanupOldCommands]
    H --> I

    I --> J[åˆ é™¤æ—§ç‰ˆæœ¬å‘½ä»¤æ–‡ä»¶]

    J --> K[ç”Ÿæˆæ ¸å¿ƒå‘½ä»¤æ–‡ä»¶]
    K --> K1[mc.md]
    K --> K2[mc-review.md]
    K --> K3[mc-perf.md]
    K --> K4[mc-docs.md]
    K --> K5[mc-why.md]
    K --> K6[mc-discover.md]

    K1 & K2 & K3 & K4 & K5 & K6 --> L[_deployHooks]

    L --> L1[éƒ¨ç½² settings.json]
    L --> L2[å¤åˆ¶æ ¸å¿ƒ Hook è„šæœ¬]
    L --> L3[ç”Ÿæˆæ¨¡æ¿ Hook æ–‡ä»¶]
    L --> L4[è®¾ç½®å¯æ‰§è¡Œæƒé™]
    L --> L5[åˆå§‹åŒ–ä»»åŠ¡æ¨¡å¼çŠ¶æ€æ–‡ä»¶]

    L1 & L2 & L3 & L4 & L5 --> M[åˆ›å»ºè½¯è¿æ¥]

    M --> M1[SymlinkManager.createAllSymlinks]
    M --> M2[SymlinkManager.createMarkdownSymlinks]

    M1 & M2 --> N[ç”Ÿæˆ markdown/README.md]

    N --> O[åˆ›å»º markdown/core/ ç›®å½•]

    O --> P[ç”Ÿæˆ tasks/README.md]

    P --> Q[ç”Ÿæˆ workflow-manifest.json]
    Q --> Q1[è®°å½•ç‰ˆæœ¬å·]
    Q --> Q2[è®¡ç®—åŸºçº¿å“ˆå¸Œ]
    Q --> Q3[è®°å½•å®‰è£…æ—¶é—´]

    Q1 & Q2 & Q3 --> R[Layer 1 å®Œæˆ]

    style A fill:#4CAF50
    style C fill:#FF9800
    style K fill:#2196F3
    style L fill:#9C27B0
    style R fill:#4CAF50
```

### Layer 2: æ¶æ„å±‚ç”Ÿæˆè¯¦è§£

#### Systems æ–‡æ¡£ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[_generateLayer2] --> B[éå† codeStructure.systems]

    B --> C{å¯¹äºæ¯ä¸ª System}
    C --> D[_detectExistingSystemDoc]

    D --> E{ç°æœ‰æ–‡æ¡£å­˜åœ¨?}
    E -->|æ˜¯| F[_assessDocQuality]
    E -->|å¦| G[ç”Ÿæˆæ–°æ–‡æ¡£]

    F --> H{è´¨é‡è¯„åˆ† â‰¥ 3?}
    H -->|æ˜¯| I[ä¿ç•™ç°æœ‰æ–‡æ¡£]
    H -->|å¦| G

    G --> J[_generateSystemDoc]
    J --> J1[ç”Ÿæˆ YAML Front Matter]
    J --> J2[ç”Ÿæˆæ¦‚è¿°]
    J --> J3[ç”Ÿæˆæ¶æ„è®¾è®¡]
    J --> J4[ç”Ÿæˆä¸»è¦æ–¹æ³•åˆ—è¡¨]
    J --> J5[ç”Ÿæˆæ•°æ®æµå ä½]
    J --> J6[ç”Ÿæˆç›¸å…³æ–‡æ¡£é“¾æ¥]

    J1 & J2 & J3 & J4 & J5 & J6 --> K[AIæ™ºèƒ½å‘½å]
    K --> L[_inferChineseNameByAI]

    L --> M[å†™å…¥æ–‡ä»¶]

    I --> N[ç»Ÿè®¡ç»“æœ]
    M --> N

    N --> O[è¾“å‡ºç”ŸæˆæŠ¥å‘Š]

    style A fill:#4CAF50
    style F fill:#FF9800
    style J fill:#2196F3
    style K fill:#9C27B0
```

#### æ–‡æ¡£è´¨é‡è¯„ä¼°ç®—æ³•

```javascript
// lib/generator.js: _assessDocQuality()

function assessDocQuality(content) {
  let score = 0;

  // å› ç´ 1: æœ‰ä»£ç å—ç¤ºä¾‹ (+1)
  if (/```/.test(content)) score += 1;

  // å› ç´ 2: æœ‰å›¾è¡¨ (+1)
  if (/mermaid|graph|flowchart/.test(content)) score += 1;

  // å› ç´ 3: æœ‰ç¤ºä¾‹è¯´æ˜ (+1)
  if (/ç¤ºä¾‹|Example|æ¡ˆä¾‹|ä½¿ç”¨æ–¹æ³•/.test(content)) score += 1;

  // å› ç´ 4: å†…å®¹ä¸°å¯Œ (>500å­—ç¬¦) (+1)
  if (content.length > 500) score += 1;

  // å› ç´ 5: ä¸æ˜¯"å¾…è¡¥å……"æ¨¡æ¿ (+1)
  if (!/âš ï¸\s*\*\*å¾…è¡¥å……\*\*/.test(content)) score += 1;

  return score; // èŒƒå›´ï¼š0-5
}
```

---

## è½¯è¿æ¥ç®¡ç†æœºåˆ¶

### è·¨å¹³å°è½¯è¿æ¥ç­–ç•¥

```mermaid
flowchart TD
    A[createSymlink] --> B{æ£€æŸ¥æºæ–‡ä»¶}
    B -->|ä¸å­˜åœ¨| C[è¿”å› failed]
    B -->|å­˜åœ¨| D{æ£€æŸ¥å¹³å°}

    D -->|Windows| E[å°è¯•åˆ›å»º Junction]
    D -->|Linux/Mac| F[å°è¯•åˆ›å»ºç¬¦å·é“¾æ¥]

    E --> G{åˆ›å»ºæˆåŠŸ?}
    F --> G

    G -->|æ˜¯| H[è¿”å› type: symlink]
    G -->|å¦| I[_createReadonlyCopy]

    I --> J[å¤åˆ¶æ–‡ä»¶/ç›®å½•]
    J --> K{æ˜¯ Markdown æ–‡ä»¶?}

    K -->|æ˜¯| L[_addReadonlyHeader]
    K -->|å¦| M[è·³è¿‡æ ‡è®°]

    L --> N[æ·»åŠ åªè¯»æç¤º]
    M --> O[è®¾ç½®åªè¯»æƒé™]
    N --> O

    O --> P[è¿”å› type: readonly-copy]

    style A fill:#4CAF50
    style G fill:#FF9800
    style I fill:#2196F3
    style P fill:#9C27B0
```

### è½¯è¿æ¥ç±»å‹

| ç±»å‹ | å¹³å° | ç‰¹ç‚¹ | é™çº§æ–¹æ¡ˆ |
|-----|------|-----|---------|
| **ç¬¦å·é“¾æ¥** | Linux/Mac | æ ‡å‡†è½¯è¿æ¥ï¼Œè‡ªåŠ¨åŒæ­¥ | åªè¯»å‰¯æœ¬ |
| **Junction** | Windows | ç›®å½•çº§åˆ«ï¼Œä¸éœ€è¦ç®¡ç†å‘˜æƒé™ | åªè¯»å‰¯æœ¬ |
| **File Symlink** | Windows | æ–‡ä»¶çº§åˆ«ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™ | åªè¯»å‰¯æœ¬ |
| **åªè¯»å‰¯æœ¬** | è·¨å¹³å° | å®Œæ•´å¤åˆ¶ + åªè¯»æ ‡è®° | æ—  |

### åªè¯»æ ‡è®°æœºåˆ¶

#### æ ‡è®°å†…å®¹

```markdown
<!--
âš ï¸ **åªè¯»æ–‡æ¡£**

æ­¤æ–‡æ¡£æ¥è‡ªä¸Šæ¸¸å·¥ä½œæµï¼Œè¯·å‹¿ç›´æ¥ç¼–è¾‘ã€‚

å¦‚éœ€å®šåˆ¶ï¼š
1. å¤åˆ¶åˆ° markdown/core/å¼€å‘è§„èŒƒ.md
2. ç¼–è¾‘é¡¹ç›®å‰¯æœ¬
3. AIä¼šè‡ªåŠ¨ä¼˜å…ˆè¯»å–é¡¹ç›®å®šåˆ¶ç‰ˆæœ¬

æ‰§è¡Œ `initmc --sync` å¯æ›´æ–°æ­¤æ–‡æ¡£ã€‚
-->

# åŸæ–‡æ¡£å†…å®¹å¼€å§‹...
```

#### ä¼˜å…ˆçº§è§„åˆ™

å½“åŒæ—¶å­˜åœ¨ä¸Šæ¸¸æ–‡æ¡£å’Œé¡¹ç›®å®šåˆ¶æ–‡æ¡£æ—¶ï¼ŒAI è¯»å–é¡ºåºï¼š

1. **é¡¹ç›®å®šåˆ¶ç‰ˆæœ¬**: `markdown/core/å¼€å‘è§„èŒƒ.md`ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **é¡¹ç›®è½¯è¿æ¥**: `markdown/å¼€å‘è§„èŒƒ.md` â†’ `.claude/core-docs/å¼€å‘è§„èŒƒ.md`
3. **ä¸Šæ¸¸æ–‡æ¡£**: `.claude/core-docs/å¼€å‘è§„èŒƒ.md` â†’ `ä¸Šæ¸¸å·¥ä½œæµ/markdown/å¼€å‘è§„èŒƒ.md`

---

## æ•°æ®æ¨¡å‹å®šä¹‰

### AnalysisReport æ•°æ®ç»“æ„

```javascript
// lib/analyzer.js
class AnalysisReport {
  constructor(metadata, codeStructure, docCoverage) {
    this.metadata = {
      isModsdk: boolean,
      projectName: string,
      modMainPath: string,
      usesApollo: boolean,
      usesEcpreset: boolean,
      businessType: 'RPG' | 'BedWars' | 'PVP' | 'General',
      scale: 'small' | 'medium' | 'large'
    };

    this.codeStructure = {
      systems: {
        [systemName: string]: SystemInfo
      },
      presets: {
        [presetName: string]: PresetInfo
      },
      dependencies: {
        [systemName: string]: string[]
      },
      discoveredComponents: DiscoveredStructure // v2.0+
    };

    this.docCoverage = {
      existingDocs: string[],
      missingDocs: string[],
      lowQualityDocs: string[]
    };
  }

  toMarkdown(): string;
}
```

### SystemInfo æ•°æ®ç»“æ„

```javascript
class SystemInfo {
  name: string;              // å¦‚ "ShopServerSystem"
  filePath: string;          // ç»å¯¹è·¯å¾„
  type: 'ServerSystem' | 'ClientSystem';
  content: string;           // å®Œæ•´æºä»£ç 

  // ä»£ç åº¦é‡
  linesOfCode: number;       // ä»£ç è¡Œæ•°
  methodCount: number;       // æ–¹æ³•æ•°é‡
  eventListeners: number;    // äº‹ä»¶ç›‘å¬æ•°é‡

  // å¤æ‚åº¦åˆ†æ
  complexityScore: number;   // 0-10

  // æ–¹æ³•
  getDetailLevel(): 'simple' | 'medium' | 'detailed';
}
```

### Replacements å ä½ç¬¦è¡¨

```javascript
// lib/generator.js: _buildReplacements()
const replacements = {
  // é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  '{{PROJECT_PATH}}': string,          // é¡¹ç›®è·¯å¾„ï¼ˆè§„èŒƒåŒ–ï¼‰
  '{{PROJECT_NAME}}': string,          // é¡¹ç›®åç§°
  '{{CURRENT_DATE}}': string,          // å½“å‰æ—¥æœŸ YYYY-MM-DD
  '{{VERSION}}': string,               // å·¥ä½œæµç‰ˆæœ¬å·

  // åŠ¨æ€å†…å®¹
  '{{EXAMPLE_TASKS}}': string,         // ç¤ºä¾‹ä»»åŠ¡åˆ—è¡¨
  '{{LOG_FILES}}': string,             // æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
  '{{ARCHITECTURE_DOCS_SECTION}}': string,
  '{{BUSINESS_DOCS_SECTION}}': string,
  '{{CRITICAL_RULES}}': string,        // CRITICAL è§„èŒƒ
  '{{CRITICAL_RULES_EXTRA}}': string,

  // è·¯å¾„é…ç½®
  '{{SDK_DOC_PATH}}': string,          // SDK æ–‡æ¡£è·¯å¾„
  '{{GLOBAL_DOCS_PATH}}': string,      // å…¨å±€æ–‡æ¡£è·¯å¾„
  '{{CORE_PATHS}}': string,            // æ ¸å¿ƒè·¯å¾„åˆ—è¡¨

  // é¡¹ç›®æè¿°
  '{{PROJECT_DESCRIPTION}}': string,
  '{{PROJECT_STATUS}}': string,
  '{{EXTRA_DOCS}}': string,
  '{{QUICK_INDEX_EXTRA}}': string,
  '{{NBT_CHECK_SECTION}}': string,     // NBT æ£€æŸ¥éƒ¨åˆ†
  '{{PRESETS_DOCS_SECTION}}': string   // Presets æ–‡æ¡£éƒ¨åˆ†
};
```

### WorkflowManifest ç‰ˆæœ¬è¿½è¸ª

```javascript
// .claude/workflow-manifest.json
{
  "version": "18.4.0",
  "installedAt": "2025-11-13T10:30:00.000Z",
  "lastUpdatedAt": "2025-11-13T10:30:00.000Z",
  "baselineHashes": {
    "æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/å¼€å‘è§„èŒƒ.md": "sha256:abc123...",
    "æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/é—®é¢˜æ’æŸ¥.md": "sha256:def456...",
    // ...æ›´å¤šæ–‡æ¡£å“ˆå¸Œ
  },
  "changes": [
    {
      "version": "18.4.0",
      "date": "2025-11-13",
      "description": "å¤šå±‚ Hook æ‰§è¡ŒåŠ›ç³»ç»Ÿ",
      "previousVersion": "18.3.0"
    },
    // ...å†å²å˜æ›´è®°å½•ï¼ˆæœ€å¤šä¿ç•™10æ¡ï¼‰
  ]
}
```

---

## é™„å½•

### å…³é”®é…ç½®å¸¸é‡

```javascript
// lib/config.js

// ç‰ˆæœ¬å·
const VERSION = '18.4.0';

// å¤æ‚åº¦è¯„åˆ†é˜ˆå€¼
const COMPLEXITY_THRESHOLDS = {
  detailed: 8,   // score â‰¥ 8 â†’ detailed
  medium: 5      // score â‰¥ 5 â†’ medium, < 5 â†’ simple
};

// é¡¹ç›®è§„æ¨¡é˜ˆå€¼
const SCALE_THRESHOLDS = {
  small: 10,     // â‰¤10 Systems
  medium: 30     // 11-30 Systems, >30 â†’ large
};

// æ–‡æ¡£è´¨é‡è¯„ä¼°é˜ˆå€¼
const QUALITY_THRESHOLDS = {
  high: 80,      // â‰¥80åˆ† â†’ ä¿ç•™
  medium: 50     // 50-79åˆ† â†’ é‡å†™, <50åˆ† â†’ é‡æ–°ç”Ÿæˆ
};
```

### æ–‡ä»¶å¤§å°éªŒè¯é˜ˆå€¼

```javascript
// scripts/initmc.js: copyFileWithValidation()

const minSizeMap = {
  'mc.md': 10000,                  // 10KB
  'mc-review.md': 7000,            // 7KB
  'mc-perf.md': 5000,              // 5KB
  'mc-docs.md': 5000,              // 5KB
  'mc-why.md': 5000,               // 5KB
  'mc-discover.md': 5000,          // 5KB
  'CLAUDE.md': 10000,              // 10KB
  'å¼€å‘è§„èŒƒ.md': 10000,            // 10KB
  'é—®é¢˜æ’æŸ¥.md': 5000,             // 5KB
  'å¿«é€Ÿå¼€å§‹.md': 3000              // 3KB
};
```

---

## ç»´æŠ¤è¯´æ˜

### æ‰©å±•æ–°å ä½ç¬¦

1. åœ¨ `lib/config.js` çš„ `PLACEHOLDERS` å¯¹è±¡æ·»åŠ å®šä¹‰
2. åœ¨ `lib/generator.js` çš„ `_buildReplacements()` å®ç°ç”Ÿæˆé€»è¾‘
3. åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­ä½¿ç”¨æ–°å ä½ç¬¦
4. æ›´æ–°æœ¬æ–‡æ¡£çš„"å ä½ç¬¦æ›¿æ¢è¡¨"ç« èŠ‚

### æ·»åŠ æ–°å‘½ä»¤æ¨¡æ¿

1. åœ¨ `templates/.claude/commands/` åˆ›å»º `æ–°å‘½ä»¤.md.template`
2. åœ¨ `lib/config.js` çš„ `getTemplatePath()` æ·»åŠ æ˜ å°„
3. åœ¨ `lib/generator.js` çš„ `_generateLayer1()` è°ƒç”¨ç”Ÿæˆ
4. åœ¨ `scripts/initmc.js` æ·»åŠ æ–‡ä»¶éªŒè¯è§„åˆ™
5. æ›´æ–°æœ¬æ–‡æ¡£çš„"æ¨¡æ¿æ–‡ä»¶ç»“æ„"ç« èŠ‚

### ä¿®æ”¹æ–‡æ¡£ç”Ÿæˆé€»è¾‘

1. ç¼–è¾‘ `lib/generator.js` å¯¹åº”çš„ `_generateLayerX()` æ–¹æ³•
2. å¦‚æœæ¶‰åŠæ–°æ•°æ®æºï¼Œå…ˆæ›´æ–° `lib/analyzer.js`
3. è¿è¡Œæµ‹è¯•ç¡®ä¿å‘åå…¼å®¹
4. æ›´æ–°æœ¬æ–‡æ¡£çš„æµç¨‹å›¾å’Œæ•°æ®æ¨¡å‹

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| v1.0 | 2025-11-13 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäº v18.4.0 å·¥ä½œæµ |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code Development Team
**æœ€åå®¡æ ¸**: 2025-11-13