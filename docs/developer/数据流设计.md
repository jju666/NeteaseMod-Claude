# MODSDK å·¥ä½œæµæ•°æ®æµè®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v3.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-13
> **æœ€åæ›´æ–°**: 2025-11-14
> **é€‚ç”¨ç‰ˆæœ¬**: v20.2.10+
>
> **âš ï¸ v20.2æ›´æ–°**: æ–°å¢ä»»åŠ¡æ‰§è¡Œæ•°æ®æµã€ä¸‰æ–‡ä»¶åŒæ­¥æœºåˆ¶ã€ä¼šè¯å†å²æŒä¹…åŒ–

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [initmc å‘½ä»¤æ‰§è¡Œæµç¨‹](#initmc-å‘½ä»¤æ‰§è¡Œæµç¨‹)
4. [ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ](#ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ) â­ **NEW**
5. [ä¸‰æ–‡ä»¶çŠ¶æ€åŒæ­¥æœºåˆ¶](#ä¸‰æ–‡ä»¶çŠ¶æ€åŒæ­¥æœºåˆ¶) â­ **NEW**
6. [ä¼šè¯å†å²æŒä¹…åŒ–](#ä¼šè¯å†å²æŒä¹…åŒ–) â­ **NEW**
7. [æ•°æ®è½¬æ¢æµç¨‹](#æ•°æ®è½¬æ¢æµç¨‹)
8. [æ¨¡æ¿å¤„ç†æœºåˆ¶](#æ¨¡æ¿å¤„ç†æœºåˆ¶)
9. [æ–‡æ¡£ç”Ÿæˆæµç¨‹](#æ–‡æ¡£ç”Ÿæˆæµç¨‹)
10. [è½¯è¿æ¥ç®¡ç†æœºåˆ¶](#è½¯è¿æ¥ç®¡ç†æœºåˆ¶)
11. [å½’æ¡£æµç¨‹](#å½’æ¡£æµç¨‹) â­ **NEW**
12. [æ•°æ®æ¨¡å‹å®šä¹‰](#æ•°æ®æ¨¡å‹å®šä¹‰)

---

## æ¦‚è¿°

### è®¾è®¡ç›®æ ‡

MODSDK å·¥ä½œæµé‡‡ç”¨**æ¨¡æ¿é©±åŠ¨ + æ•°æ®è½¬æ¢**çš„æ¶æ„æ¨¡å¼ï¼Œå®ç°ï¼š

1. **é›¶é…ç½®éƒ¨ç½²**: ç”¨æˆ·æ‰§è¡Œ `initmc` å³å¯å®Œæˆå·¥ä½œæµéƒ¨ç½²
2. **æ™ºèƒ½åˆ†æ**: è‡ªåŠ¨åˆ†æé¡¹ç›®ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œæ¶æ„ç‰¹å¾
3. **æ¨¡æ¿å¤ç”¨**: é€šè¿‡å ä½ç¬¦æ›¿æ¢æœºåˆ¶å®ç°æ¨¡æ¿å®šåˆ¶åŒ–
4. **åŒå±‚æ–‡æ¡£æ¶æ„**: ä¸Šæ¸¸åŸºçº¿æ–‡æ¡£ + é¡¹ç›®è¦†ç›–å±‚ï¼Œæ”¯æŒé›¶é£é™©å‡çº§
5. **è½¯è¿æ¥ç®¡ç†**: è·¨å¹³å°è½¯è¿æ¥æœºåˆ¶ï¼Œä¼˜é›…é™çº§ä¸ºåªè¯»å‰¯æœ¬

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|-----|---------|-----|
| **å…¥å£è„šæœ¬** | `scripts/initmc.js` | CLI å‘½ä»¤å…¥å£ï¼Œé¡¹ç›®æ£€æµ‹ä¸éƒ¨ç½²æµç¨‹ç¼–æ’ |
| **å·¥ä½œæµåˆå§‹åŒ–å™¨** | `lib/init-workflow.js` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå„æ¨¡å—æ‰§è¡Œå·¥ä½œæµåˆå§‹åŒ– |
| **é¡¹ç›®åˆ†æå™¨** | `lib/analyzer.js` | æ‰«æä»£ç ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œå¤æ‚åº¦ |
| **æ–‡æ¡£ç”Ÿæˆå™¨** | `lib/generator.js` | åŸºäºåˆ†ææŠ¥å‘Šå’Œæ¨¡æ¿ç”Ÿæˆå®šåˆ¶åŒ–æ–‡æ¡£ |
| **è½¯è¿æ¥ç®¡ç†å™¨** | `lib/symlink-manager.js` | åˆ›å»ºå’Œç®¡ç†ä¸Šæ¸¸æ–‡æ¡£åˆ°ä¸‹æ¸¸é¡¹ç›®çš„å¼•ç”¨ |
| **é…ç½®ç®¡ç†å™¨** | `lib/config.js` | å…¨å±€é…ç½®ã€å¸¸é‡å®šä¹‰ã€è·¯å¾„è§£æ |

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚æ¶æ„æ¨¡å¼

```mermaid
graph TB
    subgraph "Layer 1: CLI å±‚"
        A[initmc CLI] --> B{é¡¹ç›®ç±»å‹æ£€æµ‹}
        B -->|MODSDK| C[ç¡®å®šé¡¹ç›®æ ¹ç›®å½•]
        B -->|å·¥ä½œæµ| D[æ‹’ç»éƒ¨ç½²]
        B -->|æœªçŸ¥| E[é€’å½’æœç´¢å­ç›®å½•]
    end

    subgraph "Layer 2: ä¸šåŠ¡é€»è¾‘å±‚"
        C --> F[init-workflow.js]
        F --> G[é¡¹ç›®åˆ†æ]
        F --> H[æ–‡æ¡£ç”Ÿæˆ]
        F --> I[è½¯è¿æ¥ç®¡ç†]
        F --> J[ç‰ˆæœ¬è¿½è¸ª]
    end

    subgraph "Layer 3: æ•°æ®å¤„ç†å±‚"
        G --> K[ProjectAnalyzer]
        H --> L[DocumentGenerator]
        I --> M[SymlinkManager]
        J --> N[VersionChecker]
    end

    subgraph "Layer 4: æ¨¡æ¿èµ„æºå±‚"
        L --> O[templates/]
        M --> P[markdown/æ ¸å¿ƒæ–‡æ¡£]
        L --> Q[å ä½ç¬¦æ›¿æ¢å¼•æ“]
    end

    style A fill:#4CAF50
    style F fill:#2196F3
    style K fill:#FF9800
    style L fill:#FF9800
    style M fill:#FF9800
    style O fill:#9C27B0
```

---

## initmc å‘½ä»¤æ‰§è¡Œæµç¨‹

### å®Œæ•´æ‰§è¡Œåºåˆ—å›¾

```mermaid
sequenceDiagram
    autonumber

    participant User as ç”¨æˆ·
    participant CLI as initmc CLI
    participant Detector as é¡¹ç›®æ£€æµ‹å™¨
    participant Init as init-workflow.js
    participant Analyzer as ProjectAnalyzer
    participant Generator as DocumentGenerator
    participant Symlink as SymlinkManager
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    User->>CLI: æ‰§è¡Œ initmc

    rect rgb(255, 245, 235)
        Note over CLI,Detector: ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®æ£€æµ‹ä¸éªŒè¯
        CLI->>Detector: detectProjectType(cwd)
        Detector->>FS: æ£€æŸ¥ modMain.py
        FS-->>Detector: è¿”å›è·¯å¾„æˆ–null
        Detector->>FS: æ£€æŸ¥ manifest.json
        FS-->>Detector: è¿”å›ç‰¹å¾ä¿¡æ¯
        Detector->>Detector: inferProjectRoot()
        Detector-->>CLI: {type, projectDir, feature}

        alt é¡¹ç›®ç±»å‹ = å·¥ä½œæµ
            CLI-->>User: é”™è¯¯ï¼šå½“å‰æ˜¯å·¥ä½œæµé¡¹ç›®æœ¬èº«
        else é¡¹ç›®ç±»å‹ = æœªçŸ¥
            CLI->>Detector: findModSDKProjects(é€’å½’æœç´¢)
            Detector-->>CLI: å€™é€‰é¡¹ç›®åˆ—è¡¨
            alt æ‰¾åˆ°å¤šä¸ªé¡¹ç›®
                CLI-->>User: æç¤ºï¼šè¯·åœ¨å…·ä½“é¡¹ç›®ç›®å½•æ‰§è¡Œ
            end
        end
    end

    rect rgb(232, 245, 233)
        Note over CLI,Init: ç¬¬äºŒé˜¶æ®µï¼šå·¥ä½œæµåˆå§‹åŒ–
        CLI->>Init: main(projectPath)

        Init->>Init: è§£æå‘½ä»¤è¡Œå‚æ•°
        Note right of Init: --sync / --force(--reset) /<br/>--auto-migrate

        alt åŒæ­¥æ¨¡å¼ (--sync)
            Init->>Init: syncWorkflow()
            Note right of Init: ç‰ˆæœ¬æ£€æµ‹<br/>è½¯è¿æ¥æ›´æ–°<br/>åºŸå¼ƒæ–‡ä»¶æ¸…ç†
        else é¦–æ¬¡éƒ¨ç½²æˆ–é‡æ–°éƒ¨ç½²
            Init->>Init: æ£€æµ‹è¿ç§»éœ€æ±‚
            Note right of Init: v18.0 / v16.1 / v16.0

            Init->>Analyzer: analyze(projectPath)
        end
    end

    rect rgb(227, 242, 253)
        Note over Analyzer,FS: ç¬¬ä¸‰é˜¶æ®µï¼šé¡¹ç›®åˆ†æ
        Analyzer->>FS: æ‰«æ Python æ–‡ä»¶
        FS-->>Analyzer: *.py æ–‡ä»¶åˆ—è¡¨
        Analyzer->>Analyzer: _analyzePythonFile()
        Note right of Analyzer: æå– System ç±»<br/>æå– Preset ç±»<br/>è®¡ç®—å¤æ‚åº¦
        Analyzer->>Analyzer: _detectProjectType()
        Analyzer->>Analyzer: _calculateProjectScale()
        Analyzer-->>Init: AnalysisReport
        Note right of Init: åŒ…å«ï¼šmetadata<br/>codeStructure<br/>docCoverage
    end

    rect rgb(248, 231, 253)
        Note over Init,Generator: ç¬¬å››é˜¶æ®µï¼šæ–‡æ¡£ç”Ÿæˆ
        Init->>Generator: new DocumentGenerator(report, upstreamPath)
        Init->>Generator: generateAll(projectPath, {minimalMode: true})

        Generator->>Generator: _createDirectoryStructure()
        Generator->>FS: åˆ›å»ºç›®å½•

        Generator->>Generator: _generateLayer1()
        Note right of Generator: é€šç”¨å±‚ï¼šæ ¸å¿ƒå·¥ä½œæµ
        Generator->>Generator: _buildReplacements()
        Note right of Generator: æ„å»ºå ä½ç¬¦æ›¿æ¢è¡¨
        Generator->>Generator: _generateFromTemplate()
        Note right of Generator: mc.md, mc-review.md,<br/>mc-perf.md, etc.
        Generator->>Generator: _deployHooks()
        Note right of Generator: éƒ¨ç½² Hook æ–‡ä»¶
        Generator->>FS: å†™å…¥å‘½ä»¤æ–‡ä»¶

        Generator->>Generator: _generateMinimalCLAUDE()
        Note right of Generator: é¦–æ¬¡éƒ¨ç½²ï¼šç”Ÿæˆæ¨¡æ¿<br/>å·²å­˜åœ¨ï¼šè·³è¿‡
        Generator->>FS: å†™å…¥ CLAUDE.md
    end

    rect rgb(255, 243, 224)
        Note over Init,Symlink: ç¬¬äº”é˜¶æ®µï¼šè½¯è¿æ¥ç®¡ç†
        Init->>Symlink: new SymlinkManager(upstreamPath, projectPath)
        Init->>Symlink: createAllSymlinks()

        Symlink->>Symlink: _getCoreFiles()
        Note right of Symlink: æ‰«æ markdown/ ç›®å½•<br/>è¿‡æ»¤æ ¸å¿ƒæ–‡æ¡£

        loop æ¯ä¸ªæ ¸å¿ƒæ–‡æ¡£
            Symlink->>Symlink: createSymlink(file)
            Symlink->>FS: å°è¯•åˆ›å»ºè½¯è¿æ¥
            alt æˆåŠŸ
                FS-->>Symlink: è½¯è¿æ¥åˆ›å»ºæˆåŠŸ
            else å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰
                Symlink->>Symlink: _createReadonlyCopy()
                Symlink->>FS: å¤åˆ¶æ–‡ä»¶ + æ·»åŠ åªè¯»æ ‡è®°
                FS-->>Symlink: åªè¯»å‰¯æœ¬åˆ›å»ºæˆåŠŸ
            end
        end

        Symlink-->>Init: ç»“æœç»Ÿè®¡

        Init->>Symlink: createMarkdownSymlinks()
        Note right of Symlink: åœ¨ markdown/ åˆ›å»º<br/>æŒ‡å‘ .claude/core-docs/ çš„å¼•ç”¨
    end

    rect rgb(255, 249, 196)
        Note over Init,User: ç¬¬å…­é˜¶æ®µï¼šå®ŒæˆæŠ¥å‘Š
        Init->>Init: ç”Ÿæˆç‰ˆæœ¬è¿½è¸ªæ–‡ä»¶
        Note right of Init: .claude/workflow-manifest.json
        Init-->>User: âœ… æ ¸å¿ƒå·¥ä½œæµéƒ¨ç½²å®Œæˆ
        Note right of User: è¾“å‡ºéƒ¨ç½²å†…å®¹æ‘˜è¦<br/>ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®
    end
```

### å…³é”®æ•°æ®æµè½¬

#### è¾“å…¥æ•°æ®

| æ•°æ®æº | æ•°æ®ç±»å‹ | ç¤ºä¾‹ |
|-------|---------|-----|
| **å‘½ä»¤è¡Œå‚æ•°** | `args[]` | `['--sync', '--auto-migrate=1']` |
| **å½“å‰å·¥ä½œç›®å½•** | `process.cwd()` | `D:/MyProject` |
| **ç¯å¢ƒå˜é‡** | `process.env` | `CLAUDE_AUTO_MIGRATE=1` |

#### ä¸­é—´æ•°æ®

| æ•°æ®ç»“æ„ | ç”Ÿæˆé˜¶æ®µ | ç”¨é€” |
|---------|---------|-----|
| **AnalysisReport** | é¡¹ç›®åˆ†æ | ä¼ é€’ç»™æ–‡æ¡£ç”Ÿæˆå™¨ |
| **Replacements** | å ä½ç¬¦æ„å»º | æ¨¡æ¿å˜é‡æ›¿æ¢ |
| **CoreFilesList** | è½¯è¿æ¥ç®¡ç† | ç¡®å®šéœ€è¦å¼•ç”¨çš„æ–‡æ¡£ |

#### è¾“å‡ºæ•°æ®

| äº§ç‰© | è·¯å¾„ | è¯´æ˜ |
|-----|------|-----|
| **å‘½ä»¤æ–‡ä»¶** | `.claude/commands/*.md` | 6ä¸ªæ ¸å¿ƒå‘½ä»¤ |
| **Hook æ–‡ä»¶** | `.claude/hooks/*.py` | ä»»åŠ¡éš”ç¦»æœºåˆ¶ |
| **è½¯è¿æ¥** | `.claude/core-docs/` | ä¸Šæ¸¸æ–‡æ¡£å¼•ç”¨ |
| **é…ç½®æ–‡ä»¶** | `.claude/settings.json` | Claude Code é…ç½® |
| **ç‰ˆæœ¬è¿½è¸ª** | `.claude/workflow-manifest.json` | ç‰ˆæœ¬å·ã€å®‰è£…æ—¶é—´ã€åŸºçº¿å“ˆå¸Œ |

---

## æ•°æ®è½¬æ¢æµç¨‹

### é¡¹ç›®ç‰¹å¾ â†’ åˆ†ææŠ¥å‘Š

```mermaid
flowchart TD
    A[æ‰«æ Python æ–‡ä»¶] --> B{æ£€æµ‹ç±»å®šä¹‰}
    B -->|class XXXSystem| C[æå– System ä¿¡æ¯]
    B -->|class XXXPreset| D[æå– Preset ä¿¡æ¯]

    C --> E[è®¡ç®—å¤æ‚åº¦è¯„åˆ†]
    E --> E1[å› ç´ 1: ä»£ç è¡Œæ•°]
    E --> E2[å› ç´ 2: æ–¹æ³•æ•°é‡]
    E --> E3[å› ç´ 3: äº‹ä»¶ç›‘å¬æ•°]
    E --> E4[å› ç´ 4: æ ¸å¿ƒå…³é”®è¯]
    E --> E5[å› ç´ 5: ä¾èµ–å…³ç³»]

    E1 & E2 & E3 & E4 & E5 --> F[complexityScore: 0-10]

    F --> G{æ¨èè¯¦ç»†åº¦}
    G -->|score â‰¥ 8| H[detailed: 3000å­—]
    G -->|5 â‰¤ score < 8| I[medium: 1500å­—]
    G -->|score < 5| J[simple: 500å­—]

    H & I & J --> K[SystemInfoå¯¹è±¡]
    D --> L[PresetInfoå¯¹è±¡]

    K & L --> M[CodeStructure]
    M --> N[AnalysisReport]

    O[é¡¹ç›®ç±»å‹æ¨æ–­] --> N
    P[æ¶æ„ç‰¹å¾æ£€æµ‹] --> N
    Q[æ–‡æ¡£è¦†ç›–ç‡ç»Ÿè®¡] --> N

    style A fill:#4CAF50
    style N fill:#2196F3
    style G fill:#FF9800
```

#### å¤æ‚åº¦è¯„åˆ†ç®—æ³•

```javascript
// lib/analyzer.js: SystemInfo._calculateComplexity()

let score = 0;

// å› ç´ 1: ä»£ç è¡Œæ•° (æœ€é«˜3åˆ†)
if (linesOfCode > 500) score += 3;
else if (linesOfCode > 200) score += 2;
else score += 1;

// å› ç´ 2: æ–¹æ³•æ•°é‡ (æœ€é«˜2åˆ†)
if (methodCount > 15) score += 2;
else if (methodCount > 5) score += 1;

// å› ç´ 3: äº‹ä»¶ç›‘å¬æ•° (æœ€é«˜1åˆ†)
if (eventListeners > 5) score += 1;

// å› ç´ 4: æ ¸å¿ƒå…³é”®è¯ (æœ€é«˜2åˆ†)
const coreKeywords = ['core', 'manager', 'game', 'state', 'main'];
if (coreKeywords.some(k => name.toLowerCase().includes(k))) score += 2;

// å› ç´ 5: ä¾èµ–å…³ç³» (æœ€é«˜2åˆ†)
if (importCount > 5) score += 2;
else if (importCount > 2) score += 1;

return score; // èŒƒå›´ï¼š1-10
```

### åˆ†ææŠ¥å‘Š â†’ å ä½ç¬¦æ›¿æ¢è¡¨

```mermaid
flowchart LR
    A[AnalysisReport] --> B[_buildReplacements]

    B --> C1["{{PROJECT_PATH}}"]
    B --> C2["{{PROJECT_NAME}}"]
    B --> C3["{{CURRENT_DATE}}"]
    B --> C4["{{VERSION}}"]
    B --> C5["{{EXAMPLE_TASKS}}"]
    B --> C6["{{CRITICAL_RULES}}"]
    B --> C7["æ›´å¤šå ä½ç¬¦..."]

    C1 --> D[æ›¿æ¢è¡¨å¯¹è±¡]
    C2 --> D
    C3 --> D
    C4 --> D
    C5 --> D
    C6 --> D
    C7 --> D

    D --> E[ä¼ é€’ç»™æ¨¡æ¿å¼•æ“]

    style A fill:#4CAF50
    style B fill:#FF9800
    style D fill:#2196F3
    style E fill:#9C27B0
```

#### å ä½ç¬¦ç”Ÿæˆé€»è¾‘

| å ä½ç¬¦ | ç”Ÿæˆé€»è¾‘ | ç¤ºä¾‹å€¼ |
|-------|---------|-------|
| `{{PROJECT_PATH}}` | `normalizePathForMarkdown(targetPath)` | `D:/MyProject` |
| `{{PROJECT_NAME}}` | `metadata.projectName` | `NetEaseMapECBedWars` |
| `{{CURRENT_DATE}}` | `getCurrentDate()` | `2025-11-13` |
| `{{VERSION}}` | `config.VERSION` | `18.4.0` |
| `{{EXAMPLE_TASKS}}` | `_generateExampleTasks()` | æ ¹æ® `businessType` ç”Ÿæˆ |
| `{{CRITICAL_RULES}}` | `_generateCriticalRulesSection()` | æ ¹æ® `usesApollo`, `usesEcpreset` ç”Ÿæˆ |
| `{{ARCHITECTURE_DOCS_SECTION}}` | `_generateArchitectureDocs()` | æ ¹æ® `usesApollo` ç”Ÿæˆ |
| `{{BUSINESS_DOCS_SECTION}}` | `_generateBusinessDocs()` | æ ¹æ® `businessType` ç”Ÿæˆ |

---

## æ¨¡æ¿å¤„ç†æœºåˆ¶

### æ¨¡æ¿å¼•æ“å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    A[è¯»å–æ¨¡æ¿æ–‡ä»¶] --> B{æ¨¡æ¿ç±»å‹}

    B -->|é™æ€æ¨¡æ¿| C[.md.template]
    B -->|é…ç½®æ¨¡æ¿| D[.json.template]
    B -->|Hook æ¨¡æ¿| E[.sh.template / .py]

    C --> F[replacePlaceholders]
    D --> F
    E --> F

    F --> G{å ä½ç¬¦æ›¿æ¢}
    G -->|ç®€å•æ›¿æ¢| H["content.replace({{KEY}}, value)"]
    G -->|æ¡ä»¶æ¸²æŸ“| I["åˆ¤æ–­ businessType/æ¶æ„ç‰¹å¾"]

    H --> J[æ›¿æ¢åå†…å®¹]
    I --> J

    J --> K{ç›®æ ‡æ–‡ä»¶å­˜åœ¨?}
    K -->|å¦| L[ç›´æ¥å†™å…¥]
    K -->|æ˜¯| M{æ–‡ä»¶ç±»å‹}

    M -->|å‘½ä»¤æ–‡ä»¶| N[å¤‡ä»½ + è¦†ç›–]
    M -->|CLAUDE.md| O[æ™ºèƒ½åˆå¹¶]
    M -->|Hook æ–‡ä»¶| P[ç›´æ¥è¦†ç›–]

    L --> Q[å†™å…¥æ–‡ä»¶ç³»ç»Ÿ]
    N --> Q
    O --> Q
    P --> Q

    style A fill:#4CAF50
    style F fill:#FF9800
    style Q fill:#2196F3
```

### æ¨¡æ¿æ–‡ä»¶ç»“æ„

```
templates/
â”œâ”€â”€ .claude/
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ mc.md.template                    # ä¸»å‘½ä»¤æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-review.md.template             # æ–¹æ¡ˆå®¡æŸ¥æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-perf.md.template               # æ€§èƒ½åˆ†ææ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-docs.md.template               # æ–‡æ¡£å®¡è®¡æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ mc-why.md.template                # ä»£ç è¿½æº¯æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ mc-discover.md.template           # é¡¹ç›®å‘ç°æ¨¡æ¿
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ user-prompt-submit-hook.py        # ç”¨æˆ·æäº¤æ‹¦æˆª
â”‚   â”‚   â”œâ”€â”€ enforce-step2.py                  # æ­¥éª¤2å¼ºåˆ¶æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ track-doc-reading.py              # æ–‡æ¡£é˜…è¯»è¿½è¸ª
â”‚   â”‚   â”œâ”€â”€ enforce-cleanup.py                # æ¸…ç†å¼ºåˆ¶æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ stop-hook.py                      # åœæ­¢é’©å­
â”‚   â”‚   â””â”€â”€ README.md                         # Hook è¯´æ˜æ–‡æ¡£
â”‚   â””â”€â”€ settings.json.template                # Claude Code é…ç½®æ¨¡æ¿
â”œâ”€â”€ markdown/
â”‚   â”œâ”€â”€ README.md.template                    # æ–‡æ¡£å¯¼èˆªæ¨¡æ¿
â”‚   â”œâ”€â”€ ç´¢å¼•.md.template                      # é¡¹ç›®ç´¢å¼•æ¨¡æ¿
â”‚   â””â”€â”€ é¡¹ç›®çŠ¶æ€.md.template                  # é¡¹ç›®çŠ¶æ€æ¨¡æ¿
â”œâ”€â”€ CLAUDE.md.template                        # AI å·¥ä½œæµæ€»è§ˆæ¨¡æ¿
â””â”€â”€ README.md.template                        # é¡¹ç›® README æ¨¡æ¿
```

### å ä½ç¬¦æ›¿æ¢å¼•æ“

#### æ ¸å¿ƒå®ç°ï¼ˆlib/utils.jsï¼‰

```javascript
function replacePlaceholders(content, replacements) {
  let result = content;

  for (const [placeholder, value] of Object.entries(replacements)) {
    // å…¨å±€æ›¿æ¢ï¼Œæ”¯æŒå¤šæ¬¡å‡ºç°
    const regex = new RegExp(escapeRegExp(placeholder), 'g');
    result = result.replace(regex, value);
  }

  return result;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
```

#### æ¡ä»¶æ¸²æŸ“ç¤ºä¾‹

```markdown
<!-- templates/.claude/commands/mc.md.template -->

## ä»»åŠ¡æ‰§è¡Œç¤ºä¾‹

{{EXAMPLE_TASKS}}

{{#if usesApollo}}
## Apollo æ¶æ„æ³¨æ„äº‹é¡¹
{{ARCHITECTURE_DOCS_SECTION}}
{{/if}}

{{#if businessType === 'RPG'}}
## NBT å…¼å®¹æ€§æ£€æŸ¥
{{NBT_CHECK_SECTION}}
{{/if}}
```

ç”Ÿæˆå™¨ä¼šæ ¹æ®é¡¹ç›®ç‰¹å¾åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„å†…å®¹ï¼š

```javascript
// lib/generator.js
_buildReplacements(targetPath) {
  const replacements = {
    '{{EXAMPLE_TASKS}}': this._generateExampleTasks(),
    '{{ARCHITECTURE_DOCS_SECTION}}': this._generateArchitectureDocs(),
    '{{NBT_CHECK_SECTION}}': this.metadata.businessType === 'RPG'
      ? this._generateNBTSection()
      : ''
  };
  return replacements;
}
```

---

## æ–‡æ¡£ç”Ÿæˆæµç¨‹

### ä¸‰å±‚æ–‡æ¡£æ¶æ„

```mermaid
flowchart TD
    A[DocumentGenerator.generateAll] --> B{minimalMode?}

    B -->|true æœ€å°åŒ–æ¨¡å¼| C[Layer 1: é€šç”¨å±‚]
    B -->|false å®Œæ•´æ¨¡å¼| D[Layer 1 + Layer 2 + Layer 3]

    C --> C1[_generateLayer1]
    C1 --> C11[ç”Ÿæˆå‘½ä»¤æ–‡ä»¶]
    C1 --> C12[éƒ¨ç½² Hook æ–‡ä»¶]
    C1 --> C13[ç”Ÿæˆ CLAUDE.md]
    C1 --> C14[åˆ›å»ºè½¯è¿æ¥]
    C1 --> C15[ç”Ÿæˆç‰ˆæœ¬è¿½è¸ª]

    D --> D1[_generateLayer1]
    D1 --> D2[_generateLayer2]
    D2 --> D21[ç”Ÿæˆ Systems æ–‡æ¡£]
    D2 --> D22[æ™ºèƒ½æ–‡æ¡£ç»´æŠ¤]

    D2 --> D3[_generateLayer3]
    D3 --> D31[ç”Ÿæˆä¸šåŠ¡å±‚æ¡†æ¶]

    D3 --> D4[_generateTodoList]
    D4 --> D41[ç”Ÿæˆæ–‡æ¡£å¾…è¡¥å……æ¸…å•]

    C15 --> E[éƒ¨ç½²å®Œæˆ]
    D41 --> E

    style A fill:#4CAF50
    style C fill:#2196F3
    style D fill:#FF9800
    style E fill:#9C27B0
```

### Layer 1: é€šç”¨å±‚ç”Ÿæˆæµç¨‹å›¾

```mermaid
flowchart TD
    A[_generateLayer1] --> B[_buildReplacements]
    B --> C[æ„å»ºå ä½ç¬¦æ›¿æ¢è¡¨]

    C --> D{CLAUDE.md å­˜åœ¨?}
    D -->|å¦| E[_generateMinimalCLAUDE]
    D -->|æ˜¯| F[è·³è¿‡ç”Ÿæˆ]

    E --> G[ç”Ÿæˆæœ€å°åŒ–æ¨¡æ¿]
    G --> H[å†™å…¥æ–‡ä»¶ç³»ç»Ÿ]

    F --> I[_cleanupOldCommands]
    H --> I

    I --> J[åˆ é™¤æ—§ç‰ˆæœ¬å‘½ä»¤æ–‡ä»¶]

    J --> K[ç”Ÿæˆæ ¸å¿ƒå‘½ä»¤æ–‡ä»¶]
    K --> K1[mc.md]
    K --> K2[mc-review.md]
    K --> K3[mc-perf.md]
    K --> K4[mc-docs.md]
    K --> K5[mc-why.md]
    K --> K6[mc-discover.md]

    K1 & K2 & K3 & K4 & K5 & K6 --> L[_deployHooks]

    L --> L1[éƒ¨ç½² settings.json]
    L --> L2[å¤åˆ¶æ ¸å¿ƒ Hook è„šæœ¬]
    L --> L3[ç”Ÿæˆæ¨¡æ¿ Hook æ–‡ä»¶]
    L --> L4[è®¾ç½®å¯æ‰§è¡Œæƒé™]
    L --> L5[åˆå§‹åŒ–ä»»åŠ¡æ¨¡å¼çŠ¶æ€æ–‡ä»¶]

    L1 & L2 & L3 & L4 & L5 --> M[åˆ›å»ºè½¯è¿æ¥]

    M --> M1[SymlinkManager.createAllSymlinks]
    M --> M2[SymlinkManager.createMarkdownSymlinks]

    M1 & M2 --> N[ç”Ÿæˆ markdown/README.md]

    N --> O[åˆ›å»º markdown/core/ ç›®å½•]

    O --> P[ç”Ÿæˆ tasks/README.md]

    P --> Q[ç”Ÿæˆ workflow-manifest.json]
    Q --> Q1[è®°å½•ç‰ˆæœ¬å·]
    Q --> Q2[è®¡ç®—åŸºçº¿å“ˆå¸Œ]
    Q --> Q3[è®°å½•å®‰è£…æ—¶é—´]

    Q1 & Q2 & Q3 --> R[Layer 1 å®Œæˆ]

    style A fill:#4CAF50
    style C fill:#FF9800
    style K fill:#2196F3
    style L fill:#9C27B0
    style R fill:#4CAF50
```

### Layer 2: æ¶æ„å±‚ç”Ÿæˆè¯¦è§£

#### Systems æ–‡æ¡£ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[_generateLayer2] --> B[éå† codeStructure.systems]

    B --> C{å¯¹äºæ¯ä¸ª System}
    C --> D[_detectExistingSystemDoc]

    D --> E{ç°æœ‰æ–‡æ¡£å­˜åœ¨?}
    E -->|æ˜¯| F[_assessDocQuality]
    E -->|å¦| G[ç”Ÿæˆæ–°æ–‡æ¡£]

    F --> H{è´¨é‡è¯„åˆ† â‰¥ 3?}
    H -->|æ˜¯| I[ä¿ç•™ç°æœ‰æ–‡æ¡£]
    H -->|å¦| G

    G --> J[_generateSystemDoc]
    J --> J1[ç”Ÿæˆ YAML Front Matter]
    J --> J2[ç”Ÿæˆæ¦‚è¿°]
    J --> J3[ç”Ÿæˆæ¶æ„è®¾è®¡]
    J --> J4[ç”Ÿæˆä¸»è¦æ–¹æ³•åˆ—è¡¨]
    J --> J5[ç”Ÿæˆæ•°æ®æµå ä½]
    J --> J6[ç”Ÿæˆç›¸å…³æ–‡æ¡£é“¾æ¥]

    J1 & J2 & J3 & J4 & J5 & J6 --> K[AIæ™ºèƒ½å‘½å]
    K --> L[_inferChineseNameByAI]

    L --> M[å†™å…¥æ–‡ä»¶]

    I --> N[ç»Ÿè®¡ç»“æœ]
    M --> N

    N --> O[è¾“å‡ºç”ŸæˆæŠ¥å‘Š]

    style A fill:#4CAF50
    style F fill:#FF9800
    style J fill:#2196F3
    style K fill:#9C27B0
```

#### æ–‡æ¡£è´¨é‡è¯„ä¼°ç®—æ³•

```javascript
// lib/generator.js: _assessDocQuality()

function assessDocQuality(content) {
  let score = 0;

  // å› ç´ 1: æœ‰ä»£ç å—ç¤ºä¾‹ (+1)
  if (/```/.test(content)) score += 1;

  // å› ç´ 2: æœ‰å›¾è¡¨ (+1)
  if (/mermaid|graph|flowchart/.test(content)) score += 1;

  // å› ç´ 3: æœ‰ç¤ºä¾‹è¯´æ˜ (+1)
  if (/ç¤ºä¾‹|Example|æ¡ˆä¾‹|ä½¿ç”¨æ–¹æ³•/.test(content)) score += 1;

  // å› ç´ 4: å†…å®¹ä¸°å¯Œ (>500å­—ç¬¦) (+1)
  if (content.length > 500) score += 1;

  // å› ç´ 5: ä¸æ˜¯"å¾…è¡¥å……"æ¨¡æ¿ (+1)
  if (!/âš ï¸\s*\*\*å¾…è¡¥å……\*\*/.test(content)) score += 1;

  return score; // èŒƒå›´ï¼š0-5
}
```

---

## è½¯è¿æ¥ç®¡ç†æœºåˆ¶

### è·¨å¹³å°è½¯è¿æ¥ç­–ç•¥

```mermaid
flowchart TD
    A[createSymlink] --> B{æ£€æŸ¥æºæ–‡ä»¶}
    B -->|ä¸å­˜åœ¨| C[è¿”å› failed]
    B -->|å­˜åœ¨| D{æ£€æŸ¥å¹³å°}

    D -->|Windows| E[å°è¯•åˆ›å»º Junction]
    D -->|Linux/Mac| F[å°è¯•åˆ›å»ºç¬¦å·é“¾æ¥]

    E --> G{åˆ›å»ºæˆåŠŸ?}
    F --> G

    G -->|æ˜¯| H[è¿”å› type: symlink]
    G -->|å¦| I[_createReadonlyCopy]

    I --> J[å¤åˆ¶æ–‡ä»¶/ç›®å½•]
    J --> K{æ˜¯ Markdown æ–‡ä»¶?}

    K -->|æ˜¯| L[_addReadonlyHeader]
    K -->|å¦| M[è·³è¿‡æ ‡è®°]

    L --> N[æ·»åŠ åªè¯»æç¤º]
    M --> O[è®¾ç½®åªè¯»æƒé™]
    N --> O

    O --> P[è¿”å› type: readonly-copy]

    style A fill:#4CAF50
    style G fill:#FF9800
    style I fill:#2196F3
    style P fill:#9C27B0
```

### è½¯è¿æ¥ç±»å‹

| ç±»å‹ | å¹³å° | ç‰¹ç‚¹ | é™çº§æ–¹æ¡ˆ |
|-----|------|-----|---------|
| **ç¬¦å·é“¾æ¥** | Linux/Mac | æ ‡å‡†è½¯è¿æ¥ï¼Œè‡ªåŠ¨åŒæ­¥ | åªè¯»å‰¯æœ¬ |
| **Junction** | Windows | ç›®å½•çº§åˆ«ï¼Œä¸éœ€è¦ç®¡ç†å‘˜æƒé™ | åªè¯»å‰¯æœ¬ |
| **File Symlink** | Windows | æ–‡ä»¶çº§åˆ«ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™ | åªè¯»å‰¯æœ¬ |
| **åªè¯»å‰¯æœ¬** | è·¨å¹³å° | å®Œæ•´å¤åˆ¶ + åªè¯»æ ‡è®° | æ—  |

### åªè¯»æ ‡è®°æœºåˆ¶

#### æ ‡è®°å†…å®¹

```markdown
<!--
âš ï¸ **åªè¯»æ–‡æ¡£**

æ­¤æ–‡æ¡£æ¥è‡ªä¸Šæ¸¸å·¥ä½œæµï¼Œè¯·å‹¿ç›´æ¥ç¼–è¾‘ã€‚

å¦‚éœ€å®šåˆ¶ï¼š
1. å¤åˆ¶åˆ° markdown/core/å¼€å‘è§„èŒƒ.md
2. ç¼–è¾‘é¡¹ç›®å‰¯æœ¬
3. AIä¼šè‡ªåŠ¨ä¼˜å…ˆè¯»å–é¡¹ç›®å®šåˆ¶ç‰ˆæœ¬

æ‰§è¡Œ `initmc --sync` å¯æ›´æ–°æ­¤æ–‡æ¡£ã€‚
-->

# åŸæ–‡æ¡£å†…å®¹å¼€å§‹...
```

#### ä¼˜å…ˆçº§è§„åˆ™

å½“åŒæ—¶å­˜åœ¨ä¸Šæ¸¸æ–‡æ¡£å’Œé¡¹ç›®å®šåˆ¶æ–‡æ¡£æ—¶ï¼ŒAI è¯»å–é¡ºåºï¼š

1. **é¡¹ç›®å®šåˆ¶ç‰ˆæœ¬**: `markdown/core/å¼€å‘è§„èŒƒ.md`ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **é¡¹ç›®è½¯è¿æ¥**: `markdown/å¼€å‘è§„èŒƒ.md` â†’ `.claude/core-docs/å¼€å‘è§„èŒƒ.md`
3. **ä¸Šæ¸¸æ–‡æ¡£**: `.claude/core-docs/å¼€å‘è§„èŒƒ.md` â†’ `ä¸Šæ¸¸å·¥ä½œæµ/markdown/å¼€å‘è§„èŒƒ.md`

---

## ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ

### å®Œæ•´æ‰§è¡Œåºåˆ—å›¾ (v20.2)

```mermaid
sequenceDiagram
    autonumber

    participant User as ç”¨æˆ·
    participant CLI as Claude Code CLI
    participant Hook1 as UserPromptSubmit Hook
    participant AI as Claude AI
    participant Hook2 as PostToolUse Hook
    participant Hook3 as PostArchive Hook
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    rect rgb(255, 245, 235)
        Note over User,Hook1: ç¬¬ä¸€é˜¶æ®µï¼šä»»åŠ¡åˆå§‹åŒ– (/mc å‘½ä»¤)
        User->>CLI: è¾“å…¥ "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½"
        CLI->>Hook1: UserPromptSubmit è§¦å‘

        Hook1->>Hook1: æ£€æµ‹ /mc å‘½ä»¤
        Hook1->>Hook1: ç”Ÿæˆ task_id (ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½)
        Hook1->>FS: åˆ›å»º tasks/ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½/

        Hook1->>FS: åˆå§‹åŒ– .task-meta.json
        Note right of Hook1: ä»»åŠ¡å…ƒæ•°æ®<br/>workflow_state<br/>metrics

        Hook1->>FS: åˆå§‹åŒ– .conversation.jsonl
        Note right of Hook1: v20.2.7: ä¼šè¯å†å²æŒä¹…åŒ–

        Hook1->>FS: å†™å…¥ .claude/workflow-state.json
        Note right of Hook1: å…¨å±€å·¥ä½œæµçŠ¶æ€<br/>current_step: step3_execute

        Hook1->>FS: å†™å…¥ .claude/.task-active.json
        Note right of Hook1: æ´»è·ƒä»»åŠ¡æ ‡å¿—<br/>å¿«é€ŸæŸ¥æ‰¾å½“å‰ä»»åŠ¡

        Hook1->>Hook1: åŒ¹é…ç©æ³•çŸ¥è¯†åº“
        Note right of Hook1: æŸ¥æ‰¾ knowledge-base.json<br/>æˆ–ç”ŸæˆBUGä¿®å¤æŒ‡å¼•

        Hook1-->>AI: æ³¨å…¥ç©æ³•åŒ…/BUGä¿®å¤æŒ‡å¼•
        Note right of AI: åŒ…å«å®Œæ•´å®ç°ä»£ç <br/>æˆ–æ™ºèƒ½è¯Šæ–­è·¯å¾„
    end

    rect rgb(232, 245, 233)
        Note over AI,Hook2: ç¬¬äºŒé˜¶æ®µï¼šä»»åŠ¡æ‰§è¡Œ (Read/Write/Edit/Bash)

        loop å·¥å…·è°ƒç”¨å¾ªç¯
            AI->>FS: Read(æ–‡æ¡£) / Edit(ä»£ç ) / Bash(æµ‹è¯•)
            FS-->>AI: å·¥å…·æ‰§è¡Œç»“æœ

            AI->>Hook2: PostToolUse è§¦å‘

            Hook2->>FS: åŠ è½½ .task-active.json
            Note right of Hook2: å¿«é€Ÿæ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒä»»åŠ¡

            alt æ— æ´»è·ƒä»»åŠ¡
                Hook2-->>AI: è·³è¿‡ï¼Œç»§ç»­æ‰§è¡Œ
            else æœ‰æ´»è·ƒä»»åŠ¡
                Hook2->>FS: åŠ è½½ tasks/{task_id}/.task-meta.json

                Hook2->>Hook2: å·¥å…·åˆ†å‘å¤„ç†
                Note right of Hook2: Read â†’ æ›´æ–°docs_read<br/>Write/Edit â†’ æ›´æ–°code_changes<br/>Bash â†’ æ£€æµ‹å¤±è´¥

                Hook2->>Hook2: æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶
                Note right of Hook2: step0: CLAUDE.mdå·²è¯»<br/>step1: æ–‡æ¡£å·²é˜…è¯»<br/>step3: ç”¨æˆ·ç¡®è®¤<br/>step4: cleanupå®Œæˆ

                alt æ­¥éª¤å®Œæˆ
                    Hook2->>Hook2: æ›´æ–°çŠ¶æ€æœº
                    Note right of Hook2: æ ‡è®°å½“å‰æ­¥éª¤completed<br/>æ¨è¿›åˆ°ä¸‹ä¸€æ­¥

                    Hook2->>FS: åŒæ­¥ä¸‰æ–‡ä»¶çŠ¶æ€
                    Note right of Hook2: task-meta.json<br/>â†’ workflow-state.json<br/>â†’ .task-active.json

                    Hook2-->>AI: æ³¨å…¥ä¸‹ä¸€æ­¥æŒ‡ä»¤
                    Note right of AI: æ­¥éª¤4ç‰¹æ®Šå¤„ç†ï¼š<br/>ç”Ÿæˆcontext.md/solution.md<br/>å¯åŠ¨å­ä»£ç†
                else æ­¥éª¤æœªå®Œæˆ
                    Hook2->>Hook2: æ£€æŸ¥å¾ªç¯æ¨¡å¼
                    Note right of Hook2: v20.2: æ£€æµ‹Bugä¿®å¤å¾ªç¯<br/>2æ¬¡è¿­ä»£+2æ¬¡è´Ÿé¢åé¦ˆ<br/>+2æ¬¡åŒæ–‡ä»¶ä¿®æ”¹

                    alt è§¦å‘ä¸“å®¶è¯Šæ–­
                        Hook2-->>AI: æ³¨å…¥ä¸“å®¶åˆ†æprompt
                        Note right of AI: Meta-Expertç³»ç»Ÿ<br/>æˆ˜ç•¥é«˜åº¦åˆ†æ<br/>å¤‡é€‰æ–¹æ¡ˆæ¨è
                    else ç»§ç»­æ‰§è¡Œ
                        Hook2-->>AI: ç»§ç»­å½“å‰æ­¥éª¤
                    end
                end

                Hook2->>FS: ä¿å­˜æ›´æ–°åçš„ .task-meta.json
            end
        end
    end

    rect rgb(227, 242, 253)
        Note over User,AI: ç¬¬ä¸‰é˜¶æ®µï¼šç”¨æˆ·ç¡®è®¤ä¸æ”¶å°¾
        User->>AI: "å·²ä¿®å¤" æˆ– "åŠŸèƒ½å·²å®Œæˆ"
        AI->>AI: è§£æç”¨æˆ·åé¦ˆ
        Note right of AI: æ£€æµ‹ç¡®è®¤å…³é”®è¯<br/>æ ‡è®°user_confirmed=true

        AI->>FS: Edit(.task-meta.json)
        Note right of AI: æ›´æ–°workflow_state<br/>æ ‡è®°step3å®Œæˆ

        FS-->>Hook2: PostToolUseè§¦å‘
        Hook2->>Hook2: æ£€æµ‹ step3_execute å®Œæˆ
        Hook2->>Hook2: æ¨è¿›åˆ° step4_cleanup

        Hook2->>FS: è°ƒç”¨ generate-docs-from-conversation.py
        Note right of Hook2: v20.2.7: ä»ä¼šè¯å†å²ç”Ÿæˆ<br/>context.md + solution.md

        Hook2-->>AI: æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
        Note right of AI: æ–‡æ¡£æ›´æ–°Agent<br/>è‡ªåŠ¨è¡¥å……markdownæ–‡æ¡£

        AI->>AI: å¯åŠ¨ Task Agent
        Note right of AI: ç‹¬ç«‹å­ä»£ç†<br/>ä¸æ¶ˆè€—ä¸»ä¼šè¯ä¸Šä¸‹æ–‡

        AI->>FS: æœç´¢å¾…è¡¥å……æ–‡æ¡£ (Glob)
        AI->>FS: æ›´æ–°ç›¸å…³æ–‡æ¡£ (Edit/Write)
        AI->>FS: æ ‡è®° step4_cleanup completed
    end

    rect rgb(248, 231, 253)
        Note over Hook3,FS: ç¬¬å››é˜¶æ®µï¼šä»»åŠ¡å½’æ¡£
        FS-->>Hook3: PostToolUseè§¦å‘
        Hook3->>FS: åŠ è½½æœ€æ–°ä»»åŠ¡çš„ .task-meta.json

        Hook3->>Hook3: æ£€æµ‹ step4_cleanup æ˜¯å¦å®Œæˆ

        alt step4 å·²å®Œæˆä¸”æœªå½’æ¡£
            Hook3->>Hook3: è·å–å½’æ¡£é”
            Note right of Hook3: .archive-lock<br/>é˜²æ­¢å¹¶å‘é—®é¢˜

            Hook3->>FS: ç§»åŠ¨ä»»åŠ¡ç›®å½•
            Note right of Hook3: tasks/ä»»åŠ¡-xxx/<br/>â†’ tasks/å·²å½’æ¡£/ä»»åŠ¡-xxx/

            Hook3->>FS: æ ‡è®° archived=true

            Hook3->>FS: ç”Ÿæˆæ–‡æ¡£å¿«ç…§
            Note right of Hook3: .claude/.doc-snapshot.json<br/>è®°å½•å½’æ¡£å‰çŠ¶æ€

            Hook3-->>AI: æ³¨å…¥æ–‡æ¡£åŒæ­¥ä»»åŠ¡
            Note right of AI: å¯åŠ¨ç¬¬äºŒä¸ªå­ä»£ç†<br/>åˆ†æå½’æ¡£ä»»åŠ¡<br/>åˆ›å»º/æ›´æ–°markdownæ–‡æ¡£

            Hook3->>Hook3: é‡Šæ”¾å½’æ¡£é”
        else step4 æœªå®Œæˆæˆ–å·²å½’æ¡£
            Hook3-->>AI: è·³è¿‡å½’æ¡£
        end
    end

    rect rgb(255, 249, 196)
        Note over User,AI: ç¬¬äº”é˜¶æ®µï¼šå®ŒæˆæŠ¥å‘Š
        AI-->>User: ä»»åŠ¡å®Œæˆæ€»ç»“
        Note right of User: - ä»£ç ä¿®æ”¹æ‘˜è¦<br/>- æ–‡æ¡£æ›´æ–°åˆ—è¡¨<br/>- æµ‹è¯•éªŒè¯ç»“æœ<br/>- å½’æ¡£è·¯å¾„
    end
```

### æ•°æ®æµå…³é”®è·¯å¾„

#### è·¯å¾„1: ä»»åŠ¡åˆå§‹åŒ– (/mc â†’ UserPromptSubmit Hook)

```
ç”¨æˆ·è¾“å…¥ "/mc ä»»åŠ¡æè¿°"
  â†“
UserPromptSubmit Hook æ£€æµ‹
  â†“
ç”Ÿæˆ task_id (ä»»åŠ¡-æ—¶é—´æˆ³-ç®€çŸ­æè¿°)
  â†“
åˆ›å»ºç›®å½•ç»“æ„:
  tasks/ä»»åŠ¡-xxx/
    â”œâ”€ .task-meta.json         # ä»»åŠ¡å…ƒæ•°æ®
    â”œâ”€ .conversation.jsonl      # ä¼šè¯å†å² (v20.2.7)
    â”œâ”€ context.md (å¾…ç”Ÿæˆ)      # é—®é¢˜ä¸Šä¸‹æ–‡
    â””â”€ solution.md (å¾…ç”Ÿæˆ)     # è§£å†³æ–¹æ¡ˆ
  â†“
åˆå§‹åŒ–ä¸‰ä¸ªJSONæ–‡ä»¶:
  1. tasks/ä»»åŠ¡-xxx/.task-meta.json
     - task_id, task_description
     - workflow_state (steps, current_step)
     - metrics (docs_read, code_changes, failures)

  2. .claude/workflow-state.json
     - current_step: "step3_execute"
     - steps (å®Œæ•´çŠ¶æ€æœº)
     - bug_fix_tracking (v20.2)

  3. .claude/.task-active.json
     - task_id, task_dir
     - current_step
     - created_at
  â†“
åŒ¹é…ç©æ³•çŸ¥è¯†åº“æˆ–ç”ŸæˆBUGä¿®å¤æŒ‡å¼•
  â†“
æ³¨å…¥åˆ°AIå¯¹è¯ä¸Šä¸‹æ–‡
```

#### è·¯å¾„2: å·¥å…·è°ƒç”¨å¤„ç† (Read/Write/Edit â†’ PostToolUse Hook)

```
AI è°ƒç”¨å·¥å…· (Read/Write/Edit/Bash)
  â†“
å·¥å…·æ‰§è¡Œå®Œæˆ
  â†“
PostToolUse Hook è§¦å‘
  â†“
å¿«é€Ÿæ£€æŸ¥ .task-active.json
  â”œâ”€ ä¸å­˜åœ¨ â†’ è·³è¿‡ (æ— æ´»è·ƒä»»åŠ¡)
  â””â”€ å­˜åœ¨ â†’ åŠ è½½ .task-meta.json
  â†“
å·¥å…·ç±»å‹åˆ†å‘:
  â”œâ”€ Read  â†’ update_docs_read()
  â”‚          â””â”€ metrics.docs_read.append(file_path)
  â”‚          â””â”€ åŒæ­¥åˆ° workflow_state.steps.step2_docs
  â”‚
  â”œâ”€ Write/Edit â†’ update_code_changes() æˆ– update_failed_operations()
  â”‚               â””â”€ metrics.code_changes.append(change_record)
  â”‚               â””â”€ ç»Ÿè®¡ same_file_edit_count
  â”‚               â””â”€ åŒæ­¥åˆ° bug_fix_tracking
  â”‚
  â””â”€ Bash â†’ check_test_failure()
            â””â”€ metrics.failure_count += 1
            â””â”€ æ£€æŸ¥æ˜¯å¦è§¦å‘ä¸“å®¶è¯Šæ–­
  â†“
æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶:
  â”œâ”€ step0_context: "CLAUDE.md" in docs_read
  â”œâ”€ step1_understand: docs_read_count > 0
  â”œâ”€ step3_execute: user_confirmed = true
  â””â”€ step4_cleanup: status = "completed"
  â†“
æ­¥éª¤å®Œæˆ â†’ æ¨è¿›çŠ¶æ€æœº
  â”œâ”€ æ ‡è®°å½“å‰æ­¥éª¤ completed
  â”œâ”€ æ›´æ–° current_step åˆ°ä¸‹ä¸€æ­¥
  â”œâ”€ ä¸‰æ–‡ä»¶åŒæ­¥ (v20.2.7)
  â””â”€ æ³¨å…¥ä¸‹ä¸€æ­¥æŒ‡ä»¤
  â†“
ä¿å­˜ .task-meta.json
```

#### è·¯å¾„3: æ­¥éª¤4æ”¶å°¾ (step4_cleanup â†’ æ–‡æ¡£ç”Ÿæˆ â†’ å½’æ¡£)

```
AI ç¼–è¾‘ .task-meta.json
  â””â”€ workflow_state.steps.step4_cleanup.status = "completed"
  â†“
PostToolUse Hook æ£€æµ‹åˆ° Edit(.task-meta.json)
  â†“
è°ƒç”¨ generate-docs-from-conversation.py
  â”œâ”€ è¯»å– .conversation.jsonl
  â”œâ”€ æå–é—®é¢˜æè¿°ã€åˆ†æè¿‡ç¨‹ã€ä»£ç ä¿®æ”¹
  â”œâ”€ ç”Ÿæˆ context.md
  â””â”€ ç”Ÿæˆ solution.md
  â†“
æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
  â†“
AI å¯åŠ¨ Task Agent (å­ä»£ç†)
  â”œâ”€ æœç´¢ markdown/**/*.md (å¾…è¡¥å……æ ‡è®°)
  â”œâ”€ æ›´æ–°ç›¸å…³æ–‡æ¡£ (Edit/Write)
  â””â”€ æ ‡è®° step4_cleanup completed
  â†“
PostToolUse Hook å†æ¬¡è§¦å‘
  â†“
PostArchive Hook æ£€æµ‹åˆ° step4 å®Œæˆ
  â”œâ”€ è·å–å½’æ¡£é” (.archive-lock)
  â”œâ”€ ç§»åŠ¨ tasks/ä»»åŠ¡-xxx/ â†’ tasks/å·²å½’æ¡£/ä»»åŠ¡-xxx/
  â”œâ”€ æ ‡è®° archived=true, archived_at
  â”œâ”€ ç”Ÿæˆæ–‡æ¡£å¿«ç…§ (.doc-snapshot.json)
  â””â”€ æ³¨å…¥æ–‡æ¡£åŒæ­¥ä»»åŠ¡ (ç¬¬äºŒä¸ªå­ä»£ç†)
  â†“
AI å¯åŠ¨æ–‡æ¡£åŒæ­¥ Agent
  â”œâ”€ è¯»å– context.md + solution.md
  â”œâ”€ åˆ†æä»»åŠ¡å½±å“èŒƒå›´
  â”œâ”€ åˆ›å»º/æ›´æ–° markdown æ–‡æ¡£
  â””â”€ è¾“å‡ºå®ŒæˆæŠ¥å‘Š
  â†“
ä»»åŠ¡å®Œæˆ
```

---

## ä¸‰æ–‡ä»¶çŠ¶æ€åŒæ­¥æœºåˆ¶

### è®¾è®¡åŠ¨æœº (v20.2.7)

**é—®é¢˜èƒŒæ™¯**:
- åŸå…ˆåªæœ‰ `.task-meta.json` åŒ…å«å®Œæ•´çŠ¶æ€
- AI ä¿®æ”¹ `workflow-state.json` åï¼ŒHook æ— æ³•æ„ŸçŸ¥å˜åŒ–
- å¯¼è‡´æ­¥éª¤æ¨è¿›é€»è¾‘å¤±æ•ˆï¼ˆå¦‚ step4 å®Œæˆåæ— æ³•è§¦å‘å½’æ¡£ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- ä¸‰æ–‡ä»¶äº’ç›¸åŒæ­¥ï¼Œä»»ä½•ä¸€å¤„æ›´æ–°éƒ½ä¼ æ’­åˆ°å…¶ä»–æ–‡ä»¶
- PostToolUse Hook ä½œä¸ºåŒæ­¥ä¸­å¿ƒï¼Œç¡®ä¿ä¸€è‡´æ€§

### ä¸‰æ–‡ä»¶èŒè´£åˆ’åˆ†

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | æ›´æ–°æ—¶æœº | è¯»å–è€… |
|---------|------|---------|--------|
| **tasks/{task_id}/.task-meta.json** | ä»»åŠ¡å®Œæ•´çŠ¶æ€ï¼ˆä¸»å‰¯æœ¬ï¼‰ | æ¯æ¬¡å·¥å…·è°ƒç”¨å | unified-workflow-driver.py<br/>post-archive-hook.py |
| **.claude/workflow-state.json** | å…¨å±€å·¥ä½œæµçŠ¶æ€ï¼ˆå¯è¢«AIç¼–è¾‘ï¼‰ | UserPromptSubmitåˆå§‹åŒ–<br/>PostToolUseåŒæ­¥ | AI (å¯è¯»å†™)<br/>unified-workflow-driver.py |
| **.claude/.task-active.json** | æ´»è·ƒä»»åŠ¡æ ‡å¿—ï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰ | ä»»åŠ¡åˆå§‹åŒ–<br/>æ­¥éª¤æ¨è¿› | unified-workflow-driver.py<br/>post-archive-hook.py |

### åŒæ­¥æµç¨‹å›¾

```mermaid
flowchart TD
    A[AI è°ƒç”¨å·¥å…·] --> B{å·¥å…·ç±»å‹}

    B -->|Read| C1[update_docs_read]
    B -->|Write/Edit| C2[update_code_changes]
    B -->|Bash| C3[check_test_failure]

    C1 & C2 & C3 --> D[æ›´æ–° task-meta.json]

    D --> E{æ­¥éª¤æ˜¯å¦å®Œæˆ?}

    E -->|å¦| F[ä¿å­˜ task-meta.json]
    E -->|æ˜¯| G[æ ‡è®°å½“å‰æ­¥éª¤ completed]

    G --> H[æ¨è¿›åˆ°ä¸‹ä¸€æ­¥]
    H --> I[æ›´æ–° current_step]

    I --> J[ä¸‰æ–‡ä»¶åŒæ­¥]

    J --> K[åŒæ­¥åˆ° workflow-state.json]
    K --> K1[å¤åˆ¶ current_step]
    K --> K2[å¤åˆ¶å®Œæ•´ steps å¯¹è±¡]
    K --> K3[æ›´æ–° last_sync_at]

    J --> L[åŒæ­¥åˆ° .task-active.json]
    L --> L1[æ›´æ–° current_step]
    L --> L2[æ›´æ–° updated_at]

    K3 & L2 --> M[ä¿å­˜æ‰€æœ‰æ–‡ä»¶]
    F --> M

    M --> N[æ—¥å¿—è®°å½•åŒæ­¥ç»“æœ]

    N --> O{åŒæ­¥æ˜¯å¦æˆåŠŸ?}
    O -->|æ˜¯| P[âœ… çŠ¶æ€ä¸€è‡´æ€§ä¿è¯]
    O -->|å¦| Q[âŒ è®°å½•é”™è¯¯æ—¥å¿—]

    P --> R[æ³¨å…¥ä¸‹ä¸€æ­¥æŒ‡ä»¤]

    style A fill:#4CAF50
    style J fill:#FF9800
    style P fill:#2196F3
    style Q fill:#F44336
```

### åŒæ­¥æ ¸å¿ƒä»£ç 

```python
# unified-workflow-driver.py (v20.2.7)

# === æ­¥éª¤3: ä¸‰æ–‡ä»¶åŒæ­¥ ===
# ä¿å­˜ä¸»å‰¯æœ¬
save_json(meta_path, meta)

# åŒæ­¥åˆ° .task-active.json
save_json(active_flag_path, {
    **active_flag,
    "current_step": next_step,
    "updated_at": datetime.now().isoformat()
})

# v20.2.7: åŒæ­¥åˆ° workflow-state.json (P0ä¿®å¤)
workflow_state_path = os.path.join(cwd, '.claude', 'workflow-state.json')
workflow_state = load_json(workflow_state_path)

if workflow_state:
    # å®Œæ•´åŒæ­¥ steps å¯¹è±¡ï¼ˆé¿å…éƒ¨åˆ†æ›´æ–°å¯¼è‡´ä¸ä¸€è‡´ï¼‰
    workflow_state['current_step'] = next_step
    workflow_state['steps'] = meta['workflow_state']['steps'].copy()
    workflow_state['last_sync_at'] = datetime.now().isoformat()

    if save_json(workflow_state_path, workflow_state):
        logger.info("âœ… å·²åŒæ­¥åˆ°workflow-state.json", {
            "current_step": next_step,
            "steps_synced": list(workflow_state['steps'].keys())
        })
    else:
        logger.error("âŒ workflow-state.jsonåŒæ­¥å¤±è´¥")
```

### åŒæ­¥è§¦å‘ç‚¹

| è§¦å‘åœºæ™¯ | åŒæ­¥æ–¹å‘ | ç¤ºä¾‹ |
|---------|---------|------|
| **ä»»åŠ¡åˆå§‹åŒ–** | meta â†’ workflow-state<br/>meta â†’ .task-active | UserPromptSubmit Hook åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ |
| **å·¥å…·è°ƒç”¨å** | meta â†’ workflow-state<br/>meta â†’ .task-active | PostToolUse Hook æ£€æµ‹åˆ°æ­¥éª¤å®Œæˆ |
| **AI æ‰‹åŠ¨ç¼–è¾‘** | workflow-state â†’ meta | AI ç›´æ¥ç¼–è¾‘ workflow-state.json åï¼Œä¸‹æ¬¡å·¥å…·è°ƒç”¨æ—¶é‡æ–°åŠ è½½ |
| **æ­¥éª¤æ¨è¿›** | meta â†’ workflow-state â†’ .task-active | å®Œæ•´çš„ä¸‰æ–‡ä»¶åŒæ­¥ |

### ä¸€è‡´æ€§ä¿è¯æœºåˆ¶

#### 1. ä¸»å‰¯æœ¬åŸåˆ™
- `.task-meta.json` æ˜¯æƒå¨æ•°æ®æºï¼ˆSource of Truthï¼‰
- å…¶ä»–æ–‡ä»¶ä»ä¸»å‰¯æœ¬æ´¾ç”Ÿ
- å‘ç”Ÿå†²çªæ—¶ï¼Œä»¥ `.task-meta.json` ä¸ºå‡†

#### 2. åŸå­æ€§ä¿è¯
```python
# åŸå­æ€§ä¿å­˜ï¼šå…ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼Œå†é‡å‘½å
def save_json_atomic(file_path, data):
    temp_path = file_path + '.tmp'
    with open(temp_path, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

    # åŸå­æ€§é‡å‘½åï¼ˆWindows ä¸Šå¯èƒ½éœ€è¦å…ˆåˆ é™¤ç›®æ ‡æ–‡ä»¶ï¼‰
    if os.path.exists(file_path):
        os.remove(file_path)
    os.rename(temp_path, file_path)
```

#### 3. åŒæ­¥å¤±è´¥å¤„ç†
```python
# v20.2.8: å¼‚å¸¸éš”ç¦»æœºåˆ¶
try:
    # åŒæ­¥åˆ° workflow-state.json
    if save_json(workflow_state_path, workflow_state):
        logger.info("âœ… åŒæ­¥æˆåŠŸ")
    else:
        logger.error("âŒ åŒæ­¥å¤±è´¥")
        # è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­æµç¨‹
except Exception as sync_err:
    logger.error("åŒæ­¥å¼‚å¸¸", sync_err)
    # å¼‚å¸¸éš”ç¦»ï¼šåŒæ­¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
```

---

## ä¼šè¯å†å²æŒä¹…åŒ–

### è®¾è®¡åŠ¨æœº (v20.2.7)

**æ ¸å¿ƒé—®é¢˜**:
- âŒ Claude Code ä¼šè¯å†å²æœªæŒä¹…åŒ–ï¼Œå‹ç¼©ä¼šè¯/è·¨ä¼šè¯åä¿¡æ¯ä¸¢å¤±
- âŒ `.task-meta.json` ä»…ä¿å­˜å…ƒæ•°æ®ï¼Œç¼ºå°‘ä¸Šä¸‹æ–‡ç»†èŠ‚ï¼ˆç”¨æˆ·è¯´äº†ä»€ä¹ˆã€AI å¦‚ä½•åˆ†æï¼‰
- âŒ AI ä¾èµ–è®°å¿†ç”Ÿæˆå½’æ¡£æ–‡æ¡£ï¼Œè´¨é‡æ— æ³•ä¿è¯
- âŒ å­ä»£ç†æ— æ³•è®¿é—®ä¸»ä¼šè¯ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆ**:
- æŒä¹…åŒ–å®Œæ•´ä¼šè¯å†å²åˆ° `.conversation.jsonl` (JSON Lines æ ¼å¼)
- æ”¯æŒè·¨ä¼šè¯è¡¥å……å½’æ¡£ï¼ˆä»å†å²æ•°æ®é‡å»ºï¼‰
- è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡å½’æ¡£æ–‡æ¡£ï¼ˆcontext.md + solution.mdï¼‰

### ä¼šè¯å†å²æ–‡ä»¶æ ¼å¼

#### .conversation.jsonl ç»“æ„

```jsonlines
{"timestamp": "2025-11-14T14:35:20.123Z", "role": "user", "content": "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½", "event_type": "task_init"}
{"timestamp": "2025-11-14T14:35:25.456Z", "role": "assistant", "content": "æˆ‘å°†å¸®ä½ ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½ã€‚è®©æˆ‘å…ˆæŸ¥é˜…ç›¸å…³æ–‡æ¡£...", "event_type": "response"}
{"timestamp": "2025-11-14T14:35:30.789Z", "role": "tool", "tool_name": "Read", "tool_input": {"file_path": "markdown/systems/å•†åº—ç³»ç»Ÿ.md"}, "event_type": "tool_call"}
{"timestamp": "2025-11-14T14:35:32.012Z", "role": "tool", "tool_name": "Read", "tool_result_summary": "æˆåŠŸè¯»å– 150 è¡Œ", "event_type": "tool_result"}
{"timestamp": "2025-11-14T14:36:10.345Z", "role": "tool", "tool_name": "Edit", "tool_input": {"file_path": "scripts/ShopServerSystem.py", "old_string": "...", "new_string": "..."}, "event_type": "tool_call"}
{"timestamp": "2025-11-14T14:36:15.678Z", "role": "user", "content": "æŠ¥é”™äº†ï¼šAttributeError: 'NoneType' object has no attribute 'buy'", "event_type": "feedback", "sentiment": "negative"}
{"timestamp": "2025-11-14T14:36:20.901Z", "role": "assistant", "content": "æˆ‘çœ‹åˆ°é”™è¯¯äº†ï¼Œé—®é¢˜åœ¨äºå•†å“æ•°æ®æœªæ­£ç¡®åŠ è½½...", "event_type": "response"}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|------|------|
| `timestamp` | ISO 8601 | âœ… | äº‹ä»¶æ—¶é—´æˆ³ | `"2025-11-14T14:35:20.123Z"` |
| `role` | string | âœ… | è§’è‰²ç±»å‹ | `"user"`, `"assistant"`, `"tool"` |
| `content` | string | âŒ | æ–‡æœ¬å†…å®¹ | ç”¨æˆ·è¾“å…¥æˆ–AIå›å¤ |
| `event_type` | string | âœ… | äº‹ä»¶ç±»å‹ | `"task_init"`, `"feedback"`, `"tool_call"` |
| `tool_name` | string | âŒ | å·¥å…·åç§° (role=toolæ—¶) | `"Read"`, `"Edit"`, `"Bash"` |
| `tool_input` | object | âŒ | å·¥å…·è¾“å…¥å‚æ•° | `{"file_path": "..."}` |
| `tool_result_summary` | string | âŒ | å·¥å…·æ‰§è¡Œç»“æœæ‘˜è¦ | `"æˆåŠŸè¯»å– 150 è¡Œ"` |
| `sentiment` | string | âŒ | æƒ…æ„Ÿå€¾å‘ (feedbackæ—¶) | `"positive"`, `"negative"`, `"neutral"` |

### ä¼šè¯è®°å½•æµç¨‹

```mermaid
flowchart TD
    A[äº‹ä»¶å‘ç”Ÿ] --> B{äº‹ä»¶ç±»å‹}

    B -->|ç”¨æˆ·è¾“å…¥| C1[task_init / feedback]
    B -->|AIå›å¤| C2[response]
    B -->|å·¥å…·è°ƒç”¨| C3[tool_call / tool_result]

    C1 --> D[æ„å»ºJSONè®°å½•]
    C2 --> D
    C3 --> D

    D --> E[è¿½åŠ åˆ° .conversation.jsonl]
    E --> F{å†™å…¥æ˜¯å¦æˆåŠŸ?}

    F -->|æ˜¯| G[âœ… ä¼šè¯æŒä¹…åŒ–æˆåŠŸ]
    F -->|å¦| H[âš ï¸ è®°å½•é”™è¯¯æ—¥å¿—]

    H --> I[ä¸é˜»å¡ä¸»æµç¨‹]

    style A fill:#4CAF50
    style D fill:#FF9800
    style G fill:#2196F3
    style H fill:#FFC107
```

### æ–‡æ¡£ç”Ÿæˆæµç¨‹ (ä»ä¼šè¯å†å²)

#### generate-docs-from-conversation.py å·¥ä½œåŸç†

```mermaid
flowchart LR
    A[.conversation.jsonl] --> B[è¯»å–ä¼šè¯å†å²]

    B --> C[æå–é—®é¢˜æè¿°]
    C --> C1[task_initäº‹ä»¶]

    B --> D[æå–åˆ†æè¿‡ç¨‹]
    D --> D1[Readå·¥å…·è°ƒç”¨è®°å½•]
    D --> D2[è¿‡æ»¤.mdæ–‡ä»¶]

    B --> E[æå–ä»£ç ä¿®æ”¹]
    E --> E1[Edit/Writeå·¥å…·è°ƒç”¨]
    E --> E2[æŒ‰æ–‡ä»¶åˆ†ç»„]

    B --> F[æå–ç”¨æˆ·åé¦ˆ]
    F --> F1[feedbackäº‹ä»¶]
    F --> F2[æƒ…æ„Ÿåˆ†æ]

    C1 & D2 --> G[ç”Ÿæˆ context.md]
    E2 & F2 --> H[ç”Ÿæˆ solution.md]

    G --> I[å†™å…¥ä»»åŠ¡ç›®å½•]
    H --> I

    I --> J[å½’æ¡£æ–‡æ¡£å®Œæˆ]

    style A fill:#4CAF50
    style G fill:#2196F3
    style H fill:#2196F3
    style J fill:#9C27B0
```

#### context.md ç”Ÿæˆæ¨¡æ¿

```markdown
# ä»»åŠ¡ä¸Šä¸‹æ–‡

## é—®é¢˜æè¿°

{ä» task_init äº‹ä»¶æå–çš„åŸå§‹éœ€æ±‚}

## åˆ†æè¿‡ç¨‹

1. **å¼€å‘è§„èŒƒ.md** - 2025-11-14 14:35:30
   - è·¯å¾„: `.claude/core-docs/æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/å¼€å‘è§„èŒƒ.md`
   - ç›®çš„: æŸ¥é˜…æ–‡æ¡£

2. **å•†åº—ç³»ç»Ÿ.md** - 2025-11-14 14:36:10
   - è·¯å¾„: `markdown/systems/å•†åº—ç³»ç»Ÿ.md`
   - ç›®çš„: æŸ¥é˜…æ–‡æ¡£

## ä»»åŠ¡å…ƒæ•°æ®

- **ä»»åŠ¡ID**: ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½
- **åˆ›å»ºæ—¶é—´**: 2025-11-14 14:35:20
- **ä»»åŠ¡ç±»å‹**: bug_fix
- **æ–‡æ¡£é˜…è¯»**: 2ä¸ª
- **ä»£ç ä¿®æ”¹**: 3æ¬¡
```

#### solution.md ç”Ÿæˆæ¨¡æ¿

```markdown
# è§£å†³æ–¹æ¡ˆ

## ä»£ç ä¿®æ”¹

### ShopServerSystem.py

**è·¯å¾„**: `scripts/ShopServerSystem.py`

**ä¿®æ”¹æ¬¡æ•°**: 3

**ä¿®æ”¹å†å²**:

1. **Edit** - 2025-11-14 14:36:10
   - ç»“æœ: æˆåŠŸä¿®æ”¹ 20 è¡Œ
2. **Edit** - 2025-11-14 14:38:25
   - ç»“æœ: ä¿®å¤ç©ºæŒ‡é’ˆæ£€æŸ¥
3. **Edit** - 2025-11-14 14:40:15
   - ç»“æœ: æ·»åŠ æ—¥å¿—è¾“å‡º

## æµ‹è¯•éªŒè¯

### ç”¨æˆ·åé¦ˆ

1. âŒ **2025-11-14 14:36:15**
   - æŠ¥é”™äº†ï¼šAttributeError: 'NoneType' object has no attribute 'buy'

2. âœ… **2025-11-14 14:41:00**
   - å·²ä¿®å¤ï¼ç°åœ¨å¯ä»¥æ­£å¸¸è´­ä¹°äº†

## æŠ€æœ¯å†³ç­–

1. **æ·»åŠ ç©ºå€¼æ£€æŸ¥**
   - ç†ç”±: é˜²æ­¢å•†å“æ•°æ®ä¸ºNoneæ—¶å´©æºƒ
   - å‚è€ƒ: CRITICALè§„èŒƒ-å¼‚å¸¸å¤„ç†

2. **ä½¿ç”¨æ—¥å¿—è®°å½•è´­ä¹°æµç¨‹**
   - ç†ç”±: ä¾¿äºåç»­è°ƒè¯•å’Œå®¡è®¡
```

### ä¼šè¯å†å²ç”¨é€”

| ç”¨é€” | è¯´æ˜ | å®ç° |
|-----|------|------|
| **å½’æ¡£æ–‡æ¡£ç”Ÿæˆ** | è‡ªåŠ¨ç”Ÿæˆ context.md + solution.md | generate-docs-from-conversation.py |
| **è·¨ä¼šè¯è¡¥å……å½’æ¡£** | å‹ç¼©ä¼šè¯åä»å¯é‡å»ºæ–‡æ¡£ | è¯»å– .conversation.jsonl é‡æ–°ç”Ÿæˆ |
| **å®¡è®¡å’Œå›æº¯** | è¿½æº¯ä»»åŠ¡å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ | æŒ‰æ—¶é—´æˆ³æŸ¥è¯¢ä¼šè¯å†å² |
| **è´¨é‡åˆ†æ** | ç»Ÿè®¡æ–‡æ¡£é˜…è¯»ã€ä»£ç ä¿®æ”¹ã€å¤±è´¥æ¬¡æ•° | ä»ä¼šè¯å†å²æå– metrics |
| **ç”¨æˆ·è¡Œä¸ºåˆ†æ** | åˆ†æç”¨æˆ·åé¦ˆæƒ…æ„Ÿã€ç¡®è®¤æ¨¡å¼ | sentiment å­—æ®µç»Ÿè®¡ |

---

## å½’æ¡£æµç¨‹

### å®Œæ•´å½’æ¡£åºåˆ—å›¾ (v20.2)

```mermaid
sequenceDiagram
    autonumber

    participant AI as Claude AI
    participant Hook1 as PostToolUse Hook
    participant Script as generate-docs-from-conversation.py
    participant Agent as æ–‡æ¡£æ›´æ–° Agent
    participant Hook2 as PostArchive Hook
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    rect rgb(255, 245, 235)
        Note over AI,Hook1: é˜¶æ®µ1: æ­¥éª¤4å®Œæˆæ£€æµ‹
        AI->>FS: Edit(.task-meta.json)
        Note right of AI: æ ‡è®° step4_cleanup.status<br/>= "completed"

        FS-->>Hook1: PostToolUse è§¦å‘
        Hook1->>FS: åŠ è½½ .task-meta.json
        Hook1->>Hook1: æ£€æµ‹ step4_cleanup å®Œæˆ
    end

    rect rgb(232, 245, 233)
        Note over Hook1,Script: é˜¶æ®µ2: ä»ä¼šè¯å†å²ç”Ÿæˆå½’æ¡£æ–‡æ¡£
        Hook1->>Script: è°ƒç”¨ generate-docs-from-conversation.py
        Script->>FS: è¯»å– .conversation.jsonl
        Script->>Script: æå–é—®é¢˜æè¿°ã€åˆ†æè¿‡ç¨‹
        Script->>Script: æå–ä»£ç ä¿®æ”¹ã€ç”¨æˆ·åé¦ˆ
        Script->>FS: å†™å…¥ context.md
        Script->>FS: å†™å…¥ solution.md
        Script-->>Hook1: âœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ
    end

    rect rgb(227, 242, 253)
        Note over Hook1,Agent: é˜¶æ®µ3: å¯åŠ¨æ–‡æ¡£æ›´æ–° Agent
        Hook1-->>AI: æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
        AI->>Agent: å¯åŠ¨ Task Agent

        Agent->>FS: Glob("markdown/**/*.md")
        Note right of Agent: æœç´¢å¾…è¡¥å……æ ‡è®°

        Agent->>FS: Read(ç›¸å…³æ–‡æ¡£)
        Agent->>FS: Edit/Write(æ›´æ–°æ–‡æ¡£)

        Agent->>FS: Edit(.task-meta.json)
        Note right of Agent: æœ€ç»ˆæ ‡è®° step4 completed
    end

    rect rgb(248, 231, 253)
        Note over Hook2,FS: é˜¶æ®µ4: ä»»åŠ¡ç›®å½•å½’æ¡£
        FS-->>Hook2: PostToolUse è§¦å‘
        Hook2->>FS: find_latest_task_dir()
        Hook2->>FS: åŠ è½½ .task-meta.json

        Hook2->>Hook2: check_if_just_completed()
        Note right of Hook2: æ£€æŸ¥:<br/>- step4 = completed?<br/>- archived = false?

        alt éœ€è¦å½’æ¡£
            Hook2->>Hook2: acquire_archive_lock()
            Note right of Hook2: è·å– .archive-lock<br/>é˜²æ­¢å¹¶å‘é—®é¢˜

            Hook2->>FS: generate_doc_snapshot()
            Note right of Hook2: ä¿å­˜å½’æ¡£å‰æ–‡æ¡£çŠ¶æ€<br/>.doc-snapshot.json

            Hook2->>FS: ç§»åŠ¨ç›®å½•
            Note right of Hook2: tasks/ä»»åŠ¡-xxx/<br/>â†’ tasks/å·²å½’æ¡£/ä»»åŠ¡-xxx/

            Hook2->>FS: mark_as_archived()
            Note right of Hook2: æ ‡è®° archived=true<br/>archived_at

            Hook2-->>AI: æ³¨å…¥æ–‡æ¡£åŒæ­¥ä»»åŠ¡
            Note right of AI: å¯åŠ¨ç¬¬äºŒä¸ªå­ä»£ç†<br/>åˆ†æå½’æ¡£ä»»åŠ¡<br/>åˆ›å»º/æ›´æ–°markdownæ–‡æ¡£

            Hook2->>Hook2: release_archive_lock()
        else æ— éœ€å½’æ¡£
            Hook2-->>AI: è·³è¿‡
        end
    end

    rect rgb(255, 249, 196)
        Note over AI,FS: é˜¶æ®µ5: æ–‡æ¡£åŒæ­¥ (ç¬¬äºŒä¸ªå­ä»£ç†)
        AI->>Agent: å¯åŠ¨æ–‡æ¡£åŒæ­¥ Agent

        Agent->>FS: Read(context.md + solution.md)
        Agent->>Agent: åˆ†æä»»åŠ¡å½±å“èŒƒå›´
        Note right of Agent: æ–°åŠŸèƒ½?<br/>Bugä¿®å¤?<br/>é‡æ„?

        Agent->>FS: Glob("markdown/**/*.md")
        Note right of Agent: æ£€æŸ¥ç°æœ‰æ–‡æ¡£ç»“æ„

        alt å­˜åœ¨ç›¸å…³æ–‡æ¡£ (â‰¤2ä¸ª)
            Agent->>FS: Edit(æ›´æ–°ç°æœ‰æ–‡æ¡£)
        else æ— ç›¸å…³æ–‡æ¡£
            Agent->>FS: Write(åˆ›å»ºæ–°æ–‡æ¡£)
            Note right of Agent: markdown/{{åˆ†ç±»}}/{{åŠŸèƒ½å}}.md
        end

        Agent-->>AI: è¾“å‡ºå®ŒæˆæŠ¥å‘Š
        Note right of AI: - å·²æ›´æ–°æ–‡æ¡£åˆ—è¡¨<br/>- å·²åˆ›å»ºæ–‡æ¡£åˆ—è¡¨
    end
```

### å½’æ¡£è§¦å‘æ¡ä»¶

```python
def check_if_just_completed(meta_file):
    """æ£€æŸ¥ä»»åŠ¡æ˜¯å¦éœ€è¦å½’æ¡£"""
    # 1. æ£€æŸ¥æ˜¯å¦å·²å½’æ¡£
    if meta.get("archived", False):
        return False  # å·²å½’æ¡£ï¼Œè·³è¿‡

    # 2. æ£€æŸ¥ step4 æ˜¯å¦å®Œæˆ
    step4_status = meta.get("workflow_state", {}) \
                       .get("steps", {}) \
                       .get("step4_cleanup", {}) \
                       .get("status")

    if step4_status != "completed":
        return False  # æ­¥éª¤4æœªå®Œæˆï¼Œè·³è¿‡

    # 3. æ»¡è¶³æ¡ä»¶ï¼Œéœ€è¦å½’æ¡£
    return True, meta
```

### å½’æ¡£é”æœºåˆ¶

**è®¾è®¡ç›®çš„**: é˜²æ­¢å¹¶å‘å½’æ¡£å¯¼è‡´æ–‡ä»¶å†²çª

```python
def acquire_archive_lock(task_dir):
    """è·å–å½’æ¡£é”"""
    lock_file = Path(task_dir) / ".archive-lock"

    if lock_file.exists():
        # æ£€æŸ¥é”æ˜¯å¦è¿‡æœŸ (è¶…è¿‡1åˆ†é’Ÿ)
        if time.time() - lock_file.stat().st_mtime > 60:
            lock_file.unlink()  # åˆ é™¤è¿‡æœŸé”
        else:
            return False  # é”è¢«å ç”¨

    try:
        lock_file.touch()  # åˆ›å»ºé”æ–‡ä»¶
        return True
    except:
        return False

def release_archive_lock(task_dir):
    """é‡Šæ”¾å½’æ¡£é”"""
    lock_file = Path(task_dir) / ".archive-lock"
    if lock_file.exists():
        lock_file.unlink()
```

### å½’æ¡£æ–‡ä»¶ç»“æ„

```
tasks/
â”œâ”€ å·²å½’æ¡£/
â”‚  â”œâ”€ ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½/
â”‚  â”‚  â”œâ”€ .task-meta.json          # ä»»åŠ¡å…ƒæ•°æ® (archived=true)
â”‚  â”‚  â”œâ”€ .conversation.jsonl      # å®Œæ•´ä¼šè¯å†å²
â”‚  â”‚  â”œâ”€ context.md               # é—®é¢˜ä¸Šä¸‹æ–‡
â”‚  â”‚  â”œâ”€ solution.md              # è§£å†³æ–¹æ¡ˆ
â”‚  â”‚  â””â”€ .archive-lock (åˆ é™¤)     # å½’æ¡£é” (å½’æ¡£å®Œæˆååˆ é™¤)
â”‚  â”‚
â”‚  â””â”€ ä»»åŠ¡-1115-091020-ä¼˜åŒ–æŠ€èƒ½ç³»ç»Ÿæ€§èƒ½/
â”‚     â””â”€ ...
â”‚
â””â”€ ä»»åŠ¡-1115-150230-æ·»åŠ æ–°å‰¯æœ¬/ (æ´»è·ƒä»»åŠ¡)
   â””â”€ ...
```

### æ–‡æ¡£å¿«ç…§æœºåˆ¶ (v20.1.1)

**è®¾è®¡ç›®çš„**: è®°å½•å½’æ¡£å‰ markdown æ–‡æ¡£çŠ¶æ€ï¼Œç”¨äºæ£€æµ‹æ–‡æ¡£å˜åŒ–

```python
def generate_doc_snapshot(project_path):
    """ç”Ÿæˆå½’æ¡£å‰æ–‡æ¡£å¿«ç…§"""
    markdown_dir = Path(project_path) / "markdown"
    snapshot = {}

    for md_file in markdown_dir.glob("**/*.md"):
        snapshot[str(md_file)] = {
            "mtime": md_file.stat().st_mtime,  # ä¿®æ”¹æ—¶é—´
            "size": md_file.stat().st_size      # æ–‡ä»¶å¤§å°
        }

    return snapshot

def save_doc_snapshot(snapshot, project_path):
    """ä¿å­˜æ–‡æ¡£å¿«ç…§"""
    snapshot_file = Path(project_path) / ".claude" / ".doc-snapshot.json"
    with open(snapshot_file, 'w', encoding='utf-8') as f:
        json.dump(snapshot, f, indent=2, ensure_ascii=False)
```

**å¿«ç…§ç”¨é€”**:
- æ£€æµ‹å“ªäº›æ–‡æ¡£åœ¨ä»»åŠ¡æœŸé—´è¢«ä¿®æ”¹
- éªŒè¯æ–‡æ¡£åŒæ­¥ Agent æ˜¯å¦æ­£ç¡®æ›´æ–°æ–‡æ¡£
- å®¡è®¡ä»»åŠ¡å¯¹é¡¹ç›®æ–‡æ¡£çš„å½±å“

---

## æ•°æ®æ¨¡å‹å®šä¹‰

### AnalysisReport æ•°æ®ç»“æ„

```javascript
// lib/analyzer.js
class AnalysisReport {
  constructor(metadata, codeStructure, docCoverage) {
    this.metadata = {
      isModsdk: boolean,
      projectName: string,
      modMainPath: string,
      usesApollo: boolean,
      usesEcpreset: boolean,
      businessType: 'RPG' | 'BedWars' | 'PVP' | 'General',
      scale: 'small' | 'medium' | 'large'
    };

    this.codeStructure = {
      systems: {
        [systemName: string]: SystemInfo
      },
      presets: {
        [presetName: string]: PresetInfo
      },
      dependencies: {
        [systemName: string]: string[]
      },
      discoveredComponents: DiscoveredStructure // v2.0+
    };

    this.docCoverage = {
      existingDocs: string[],
      missingDocs: string[],
      lowQualityDocs: string[]
    };
  }

  toMarkdown(): string;
}
```

### SystemInfo æ•°æ®ç»“æ„

```javascript
class SystemInfo {
  name: string;              // å¦‚ "ShopServerSystem"
  filePath: string;          // ç»å¯¹è·¯å¾„
  type: 'ServerSystem' | 'ClientSystem';
  content: string;           // å®Œæ•´æºä»£ç 

  // ä»£ç åº¦é‡
  linesOfCode: number;       // ä»£ç è¡Œæ•°
  methodCount: number;       // æ–¹æ³•æ•°é‡
  eventListeners: number;    // äº‹ä»¶ç›‘å¬æ•°é‡

  // å¤æ‚åº¦åˆ†æ
  complexityScore: number;   // 0-10

  // æ–¹æ³•
  getDetailLevel(): 'simple' | 'medium' | 'detailed';
}
```

### Replacements å ä½ç¬¦è¡¨

```javascript
// lib/generator.js: _buildReplacements()
const replacements = {
  // é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  '{{PROJECT_PATH}}': string,          // é¡¹ç›®è·¯å¾„ï¼ˆè§„èŒƒåŒ–ï¼‰
  '{{PROJECT_NAME}}': string,          // é¡¹ç›®åç§°
  '{{CURRENT_DATE}}': string,          // å½“å‰æ—¥æœŸ YYYY-MM-DD
  '{{VERSION}}': string,               // å·¥ä½œæµç‰ˆæœ¬å·

  // åŠ¨æ€å†…å®¹
  '{{EXAMPLE_TASKS}}': string,         // ç¤ºä¾‹ä»»åŠ¡åˆ—è¡¨
  '{{LOG_FILES}}': string,             // æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
  '{{ARCHITECTURE_DOCS_SECTION}}': string,
  '{{BUSINESS_DOCS_SECTION}}': string,
  '{{CRITICAL_RULES}}': string,        // CRITICAL è§„èŒƒ
  '{{CRITICAL_RULES_EXTRA}}': string,

  // è·¯å¾„é…ç½®
  '{{SDK_DOC_PATH}}': string,          // SDK æ–‡æ¡£è·¯å¾„
  '{{GLOBAL_DOCS_PATH}}': string,      // å…¨å±€æ–‡æ¡£è·¯å¾„
  '{{CORE_PATHS}}': string,            // æ ¸å¿ƒè·¯å¾„åˆ—è¡¨

  // é¡¹ç›®æè¿°
  '{{PROJECT_DESCRIPTION}}': string,
  '{{PROJECT_STATUS}}': string,
  '{{EXTRA_DOCS}}': string,
  '{{QUICK_INDEX_EXTRA}}': string,
  '{{NBT_CHECK_SECTION}}': string,     // NBT æ£€æŸ¥éƒ¨åˆ†
  '{{PRESETS_DOCS_SECTION}}': string   // Presets æ–‡æ¡£éƒ¨åˆ†
};
```

### WorkflowManifest ç‰ˆæœ¬è¿½è¸ª

```javascript
// .claude/workflow-manifest.json
{
  "version": "20.2.10",
  "installedAt": "2025-11-13T10:30:00.000Z",
  "lastUpdatedAt": "2025-11-14T10:30:00.000Z",
  "baselineHashes": {
    "æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/å¼€å‘è§„èŒƒ.md": "sha256:abc123...",
    "æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/é—®é¢˜æ’æŸ¥.md": "sha256:def456...",
    // ...æ›´å¤šæ–‡æ¡£å“ˆå¸Œ
  },
  "changes": [
    {
      "version": "20.2.10",
      "date": "2025-11-14",
      "description": "ä¿®å¤ unified-workflow-driver Hook å®Œå…¨å¤±æ•ˆé—®é¢˜",
      "previousVersion": "20.2.9"
    },
    {
      "version": "20.2.9",
      "date": "2025-11-14",
      "description": "GitHub å¼€æºå‘å¸ƒæ¸…ç†",
      "previousVersion": "20.2.8"
    },
    {
      "version": "20.2.8",
      "date": "2025-11-14",
      "description": "ä¼šè¯å†å²æŒä¹…åŒ– (æ–¹æ¡ˆB)",
      "previousVersion": "20.2.7"
    }
    // ...å†å²å˜æ›´è®°å½•ï¼ˆæœ€å¤šä¿ç•™10æ¡ï¼‰
  ]
}
```

### TaskMeta å®Œæ•´æ•°æ®ç»“æ„ (v20.2)

```javascript
// tasks/{task_id}/.task-meta.json
{
  "task_id": "ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_type": "bug_fix",  // "feature" | "bug_fix" | "refactor" | "general"
  "task_complexity": "standard",  // "simple" | "standard" | "complex"
  "created_at": "2025-11-14T14:35:20.123Z",
  "updated_at": "2025-11-14T14:45:30.456Z",
  "archived": false,  // true after moved to å·²å½’æ¡£/
  "archived_at": null,  // ISO timestamp when archived

  // v20.2.7: å®Œæ•´å·¥ä½œæµçŠ¶æ€ï¼ˆä¸»å‰¯æœ¬ï¼‰
  "workflow_state": {
    "task_id": "ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
    "task_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
    "task_type": "bug_fix",
    "created_at": "2025-11-14T14:35:20.123Z",
    "current_step": "step3_execute",
    "last_injection_step": "step3_execute",

    "steps": {
      "step0_context": {
        "description": "é˜…è¯»é¡¹ç›®CLAUDE.md",
        "status": "skipped",  // "pending" | "in_progress" | "completed" | "skipped"
        "prompt": "ï¼ˆç©æ³•åŒ…æ¨¡å¼ï¼šå·²è·³è¿‡ï¼‰"
      },
      "step1_understand": {
        "description": "ç†è§£ä»»åŠ¡éœ€æ±‚",
        "status": "skipped",
        "prompt": "ï¼ˆç©æ³•åŒ…æ¨¡å¼ï¼šå·²è·³è¿‡ï¼‰"
      },
      "step3_execute": {
        "description": "æ‰§è¡Œå®æ–½",
        "status": "in_progress",
        "started_at": "2025-11-14T14:35:20.123Z",
        "user_confirmed": false,
        "last_error": null,
        "last_error_time": null,
        "last_test_reminder_at": null,  // v20.2.7: é˜²æ­¢é¢‘ç¹æé†’
        "prompt": "åŸºäºç©æ³•åŒ…ä»£ç å®ç°åŠŸèƒ½ï¼Œæµ‹è¯•éªŒè¯ï¼Œç›´åˆ°ç”¨æˆ·ç¡®è®¤ä¿®å¤å®Œæˆã€‚"
      },
      "step4_cleanup": {
        "description": "æ”¶å°¾å½’æ¡£",
        "status": "pending",
        "prompt": "æ¸…ç†DEBUGä»£ç ï¼Œæ›´æ–°æ–‡æ¡£ï¼Œå½’æ¡£ä»»åŠ¡ã€‚"
      }
    },

    // v20.2: BUGä¿®å¤è¿½è¸ª
    "bug_fix_tracking": {
      "enabled": true,
      "bug_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
      "iterations": [
        {
          "iteration_id": 1,
          "timestamp": "2025-11-14T14:36:10.123Z",
          "user_feedback": "æŠ¥é”™äº†ï¼šAttributeError",
          "feedback_sentiment": "negative",
          "changes_made": [
            {
              "file": "scripts/ShopServerSystem.py",
              "change_summary": "æ·»åŠ ç©ºå€¼æ£€æŸ¥"
            }
          ]
        }
      ],
      "loop_indicators": {
        "same_file_edit_count": 3,
        "failed_test_count": 0,
        "negative_feedback_count": 1,
        "consecutive_failures": 0,  // v20.3: è¿ç»­å¤±è´¥è®¡æ•°
        "time_spent_minutes": 10
      },
      "expert_triggered": false
    },

    "gameplay_pack_matched": null,  // ç©æ³•åŒ…IDï¼ˆå¦‚æœåŒ¹é…ï¼‰
    "gameplay_pack_name": null
  },

  // v20.2: ä»»åŠ¡åº¦é‡æŒ‡æ ‡
  "metrics": {
    "docs_read": [
      ".claude/core-docs/æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/å¼€å‘è§„èŒƒ.md",
      "markdown/systems/å•†åº—ç³»ç»Ÿ.md"
    ],
    "docs_read_count": 2,

    "code_changes": [
      {
        "file": "scripts/ShopServerSystem.py",
        "timestamp": "2025-11-14T14:36:10.123Z",
        "operation": "Edit",
        "status": "success"  // "success" | "failed"
      },
      {
        "file": "scripts/ShopServerSystem.py",
        "timestamp": "2025-11-14T14:38:25.456Z",
        "operation": "Edit",
        "status": "failed",
        "error": "old_string not found in file"
      }
    ],
    "code_changes_count": 2,
    "consecutive_failures": 1,  // v20.3: è¿ç»­å¤±è´¥æ¬¡æ•°

    "failure_count": 0,
    "failures": [],

    "expert_review_triggered": false,
    "expert_triggered_at": null,

    "critical_violation_count": 0  // CRITICALè§„èŒƒè¿è§„æ¬¡æ•°
  },

  // v20.2.7: æŠ€æœ¯å†³ç­–è®°å½•ï¼ˆå¯é€‰ï¼‰
  "technical_decisions": [
    {
      "decision": "æ·»åŠ ç©ºå€¼æ£€æŸ¥",
      "reason": "é˜²æ­¢å•†å“æ•°æ®ä¸ºNoneæ—¶å´©æºƒ",
      "reference": "CRITICALè§„èŒƒ-å¼‚å¸¸å¤„ç†",
      "timestamp": "2025-11-14T14:36:10.123Z"
    }
  ]
}
```

### WorkflowState å…¨å±€çŠ¶æ€ (v20.2)

```javascript
// .claude/workflow-state.json
{
  "task_id": "ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_type": "bug_fix",
  "created_at": "2025-11-14T14:35:20.123Z",
  "current_step": "step3_execute",
  "last_injection_step": "step3_execute",
  "last_sync_at": "2025-11-14T14:45:30.456Z",  // v20.2.7: åŒæ­¥æ—¶é—´æˆ³

  // å®Œæ•´çš„æ­¥éª¤çŠ¶æ€ï¼ˆä» task-meta.json åŒæ­¥ï¼‰
  "steps": {
    "step0_context": { /* åŒ task-meta.json */ },
    "step1_understand": { /* åŒ task-meta.json */ },
    "step3_execute": { /* åŒ task-meta.json */ },
    "step4_cleanup": { /* åŒ task-meta.json */ }
  },

  // v20.2: BUGä¿®å¤è¿½è¸ªï¼ˆä» task-meta.json åŒæ­¥ï¼‰
  "bug_fix_tracking": {
    "enabled": true,
    "bug_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
    "iterations": [ /* ... */ ],
    "loop_indicators": { /* ... */ },
    "expert_triggered": false
  },

  "gameplay_pack_matched": null,
  "gameplay_pack_name": null
}
```

### TaskActive æ´»è·ƒæ ‡å¿— (v20.2)

```javascript
// .claude/.task-active.json
{
  "task_id": "ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_dir": "D:/Project/tasks/ä»»åŠ¡-1114-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "current_step": "step3_execute",
  "created_at": "2025-11-14T14:35:20.123Z",
  "updated_at": "2025-11-14T14:45:30.456Z"
}
```

### ConversationHistory ä¼šè¯å†å² (v20.2.7)

```jsonlines
// tasks/{task_id}/.conversation.jsonl (JSON Lines æ ¼å¼)
{"timestamp": "2025-11-14T14:35:20.123Z", "role": "user", "content": "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½", "event_type": "task_init"}
{"timestamp": "2025-11-14T14:35:30.789Z", "role": "tool", "tool_name": "Read", "tool_input": {"file_path": "markdown/systems/å•†åº—ç³»ç»Ÿ.md"}, "event_type": "tool_call"}
{"timestamp": "2025-11-14T14:36:15.678Z", "role": "user", "content": "æŠ¥é”™äº†ï¼šAttributeError", "event_type": "feedback", "sentiment": "negative"}
```

**å­—æ®µå®šä¹‰**:
```typescript
interface ConversationEntry {
  timestamp: string;           // ISO 8601 æ—¶é—´æˆ³
  role: "user" | "assistant" | "tool";
  content?: string;            // æ–‡æœ¬å†…å®¹
  event_type: string;          // "task_init" | "feedback" | "tool_call" | "tool_result" | "response"
  tool_name?: string;          // å·¥å…·åç§°ï¼ˆrole=toolæ—¶ï¼‰
  tool_input?: object;         // å·¥å…·è¾“å…¥å‚æ•°
  tool_result_summary?: string; // å·¥å…·æ‰§è¡Œç»“æœæ‘˜è¦
  sentiment?: "positive" | "negative" | "neutral"; // æƒ…æ„Ÿå€¾å‘ï¼ˆfeedbackæ—¶ï¼‰
}
```

### DocSnapshot æ–‡æ¡£å¿«ç…§ (v20.1.1)

```javascript
// .claude/.doc-snapshot.json
{
  "D:/Project/markdown/systems/å•†åº—ç³»ç»Ÿ.md": {
    "mtime": 1700000000.123,  // Unix æ—¶é—´æˆ³ï¼ˆæµ®ç‚¹æ•°ï¼‰
    "size": 15360             // å­—èŠ‚æ•°
  },
  "D:/Project/markdown/events/è´­ä¹°äº‹ä»¶.md": {
    "mtime": 1700000100.456,
    "size": 8192
  }
  // ...æ›´å¤šæ–‡æ¡£å¿«ç…§
}
```

---

## é™„å½•

### å…³é”®é…ç½®å¸¸é‡

```javascript
// lib/config.js

// ç‰ˆæœ¬å·
const VERSION = '18.4.0';

// å¤æ‚åº¦è¯„åˆ†é˜ˆå€¼
const COMPLEXITY_THRESHOLDS = {
  detailed: 8,   // score â‰¥ 8 â†’ detailed
  medium: 5      // score â‰¥ 5 â†’ medium, < 5 â†’ simple
};

// é¡¹ç›®è§„æ¨¡é˜ˆå€¼
const SCALE_THRESHOLDS = {
  small: 10,     // â‰¤10 Systems
  medium: 30     // 11-30 Systems, >30 â†’ large
};

// æ–‡æ¡£è´¨é‡è¯„ä¼°é˜ˆå€¼
const QUALITY_THRESHOLDS = {
  high: 80,      // â‰¥80åˆ† â†’ ä¿ç•™
  medium: 50     // 50-79åˆ† â†’ é‡å†™, <50åˆ† â†’ é‡æ–°ç”Ÿæˆ
};
```

### æ–‡ä»¶å¤§å°éªŒè¯é˜ˆå€¼

```javascript
// scripts/initmc.js: copyFileWithValidation()

const minSizeMap = {
  'mc.md': 10000,                  // 10KB
  'mc-review.md': 7000,            // 7KB
  'mc-perf.md': 5000,              // 5KB
  'mc-docs.md': 5000,              // 5KB
  'mc-why.md': 5000,               // 5KB
  'mc-discover.md': 5000,          // 5KB
  'CLAUDE.md': 10000,              // 10KB
  'å¼€å‘è§„èŒƒ.md': 10000,            // 10KB
  'é—®é¢˜æ’æŸ¥.md': 5000,             // 5KB
  'å¿«é€Ÿå¼€å§‹.md': 3000              // 3KB
};
```

---

## ç»´æŠ¤è¯´æ˜

### æ‰©å±•æ–°å ä½ç¬¦

1. åœ¨ `lib/config.js` çš„ `PLACEHOLDERS` å¯¹è±¡æ·»åŠ å®šä¹‰
2. åœ¨ `lib/generator.js` çš„ `_buildReplacements()` å®ç°ç”Ÿæˆé€»è¾‘
3. åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­ä½¿ç”¨æ–°å ä½ç¬¦
4. æ›´æ–°æœ¬æ–‡æ¡£çš„"å ä½ç¬¦æ›¿æ¢è¡¨"ç« èŠ‚

### æ·»åŠ æ–°å‘½ä»¤æ¨¡æ¿

1. åœ¨ `templates/.claude/commands/` åˆ›å»º `æ–°å‘½ä»¤.md.template`
2. åœ¨ `lib/config.js` çš„ `getTemplatePath()` æ·»åŠ æ˜ å°„
3. åœ¨ `lib/generator.js` çš„ `_generateLayer1()` è°ƒç”¨ç”Ÿæˆ
4. åœ¨ `scripts/initmc.js` æ·»åŠ æ–‡ä»¶éªŒè¯è§„åˆ™
5. æ›´æ–°æœ¬æ–‡æ¡£çš„"æ¨¡æ¿æ–‡ä»¶ç»“æ„"ç« èŠ‚

### ä¿®æ”¹æ–‡æ¡£ç”Ÿæˆé€»è¾‘

1. ç¼–è¾‘ `lib/generator.js` å¯¹åº”çš„ `_generateLayerX()` æ–¹æ³•
2. å¦‚æœæ¶‰åŠæ–°æ•°æ®æºï¼Œå…ˆæ›´æ–° `lib/analyzer.js`
3. è¿è¡Œæµ‹è¯•ç¡®ä¿å‘åå…¼å®¹
4. æ›´æ–°æœ¬æ–‡æ¡£çš„æµç¨‹å›¾å’Œæ•°æ®æ¨¡å‹

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| **v3.0** | **2025-11-14** | **é‡å¤§æ›´æ–°ï¼šæ–°å¢ä»»åŠ¡æ‰§è¡Œæ•°æ®æµã€ä¸‰æ–‡ä»¶åŒæ­¥æœºåˆ¶ã€ä¼šè¯å†å²æŒä¹…åŒ–ã€å½’æ¡£æµç¨‹** |
| | | - æ–°å¢"ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ"ç« èŠ‚ï¼ˆå®Œæ•´åºåˆ—å›¾ + ä¸‰æ¡å…³é”®è·¯å¾„ï¼‰ |
| | | - æ–°å¢"ä¸‰æ–‡ä»¶çŠ¶æ€åŒæ­¥æœºåˆ¶"ç« èŠ‚ï¼ˆè®¾è®¡åŠ¨æœºã€åŒæ­¥æµç¨‹å›¾ã€æ ¸å¿ƒä»£ç ï¼‰ |
| | | - æ–°å¢"ä¼šè¯å†å²æŒä¹…åŒ–"ç« èŠ‚ï¼ˆ.conversation.jsonlæ ¼å¼ã€æ–‡æ¡£ç”Ÿæˆæµç¨‹ï¼‰ |
| | | - æ–°å¢"å½’æ¡£æµç¨‹"ç« èŠ‚ï¼ˆ5é˜¶æ®µåºåˆ—å›¾ã€å½’æ¡£é”æœºåˆ¶ã€æ–‡æ¡£å¿«ç…§ï¼‰ |
| | | - æ›´æ–°æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆTaskMetaã€WorkflowStateã€TaskActiveã€ConversationHistoryï¼‰ |
| | | - é€‚ç”¨ç‰ˆæœ¬ï¼šv20.2.10+ |
| v2.0 | 2025-11-13 | æ–°å¢ SessionStart Hook æ•°æ®æµï¼Œä»»åŠ¡çŠ¶æ€æœºå‡çº§ä¸º v2.0.3 æ ¼å¼ |
| v1.0 | 2025-11-13 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäº v18.4.0 å·¥ä½œæµ |

---

## ç›¸å…³æ–‡æ¡£

- [Hookæœºåˆ¶](./Hookæœºåˆ¶.md) - Hook ç³»ç»Ÿè¯¦ç»†è®¾è®¡
- [æŠ€æœ¯æ¶æ„](./æŠ€æœ¯æ¶æ„.md) - ç³»ç»Ÿæ•´ä½“æ¶æ„
- [å¿«é€Ÿä¸Šæ‰‹](./å¿«é€Ÿä¸Šæ‰‹.md) - ä½¿ç”¨æŒ‡å—
- [CHANGELOG.md](../../CHANGELOG.md) - ç‰ˆæœ¬æ›´æ–°è®°å½•

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code Development Team
**æœ€åå®¡æ ¸**: 2025-11-14
**é€‚ç”¨ç‰ˆæœ¬**: v20.2.10+