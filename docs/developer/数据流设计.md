# MODSDK å·¥ä½œæµæ•°æ®æµè®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v4.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-13
> **æœ€åæ›´æ–°**: 2025-11-15
> **é€‚ç”¨ç‰ˆæœ¬**: v21.1.2+

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„å˜æ›´(v21.0)](#æ¶æ„å˜æ›´v210)
3. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
4. [initmc å‘½ä»¤æ‰§è¡Œæµç¨‹](#initmc-å‘½ä»¤æ‰§è¡Œæµç¨‹)
5. [ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ](#ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ)
6. [äºŒæ–‡ä»¶çŠ¶æ€æ¶æ„](#äºŒæ–‡ä»¶çŠ¶æ€æ¶æ„) â­ **v21.0é‡æ„**
7. [ä¼šè¯å†å²æŒä¹…åŒ–](#ä¼šè¯å†å²æŒä¹…åŒ–)
8. [æ•°æ®è½¬æ¢æµç¨‹](#æ•°æ®è½¬æ¢æµç¨‹)
9. [æ¨¡æ¿å¤„ç†æœºåˆ¶](#æ¨¡æ¿å¤„ç†æœºåˆ¶)
10. [æ–‡æ¡£ç”Ÿæˆæµç¨‹](#æ–‡æ¡£ç”Ÿæˆæµç¨‹)
11. [è½¯è¿æ¥ç®¡ç†æœºåˆ¶](#è½¯è¿æ¥ç®¡ç†æœºåˆ¶)
12. [å½’æ¡£æµç¨‹](#å½’æ¡£æµç¨‹)
13. [æ•°æ®æ¨¡å‹å®šä¹‰](#æ•°æ®æ¨¡å‹å®šä¹‰)

---

## æ¦‚è¿°

### è®¾è®¡ç›®æ ‡

MODSDK å·¥ä½œæµé‡‡ç”¨**æ¨¡æ¿é©±åŠ¨ + æ•°æ®è½¬æ¢**çš„æ¶æ„æ¨¡å¼ï¼Œå®ç°ï¼š

1. **é›¶é…ç½®éƒ¨ç½²**: ç”¨æˆ·æ‰§è¡Œ `initmc` å³å¯å®Œæˆå·¥ä½œæµéƒ¨ç½²
2. **æ™ºèƒ½åˆ†æ**: è‡ªåŠ¨åˆ†æé¡¹ç›®ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œæ¶æ„ç‰¹å¾
3. **æ¨¡æ¿å¤ç”¨**: é€šè¿‡å ä½ç¬¦æ›¿æ¢æœºåˆ¶å®ç°æ¨¡æ¿å®šåˆ¶åŒ–
4. **åŒå±‚æ–‡æ¡£æ¶æ„**: ä¸Šæ¸¸åŸºçº¿æ–‡æ¡£ + é¡¹ç›®è¦†ç›–å±‚ï¼Œæ”¯æŒé›¶é£é™©å‡çº§
5. **è½¯è¿æ¥ç®¡ç†**: è·¨å¹³å°è½¯è¿æ¥æœºåˆ¶ï¼Œä¼˜é›…é™çº§ä¸ºåªè¯»å‰¯æœ¬
6. **å•ä¸€æ•°æ®æº**: v21.0ä½¿ç”¨task-meta.jsonä¸ºå”¯ä¸€æ•°æ®æºï¼Œæ¶ˆé™¤æ•°æ®ä¸ä¸€è‡´

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|-----|---------|-----|
| **å…¥å£è„šæœ¬** | `scripts/initmc.js` | CLI å‘½ä»¤å…¥å£ï¼Œé¡¹ç›®æ£€æµ‹ä¸éƒ¨ç½²æµç¨‹ç¼–æ’ |
| **å·¥ä½œæµåˆå§‹åŒ–å™¨** | `lib/init-workflow.js` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå„æ¨¡å—æ‰§è¡Œå·¥ä½œæµåˆå§‹åŒ– |
| **é¡¹ç›®åˆ†æå™¨** | `lib/analyzer.js` | æ‰«æä»£ç ç»“æ„ï¼Œæ¨æ–­é¡¹ç›®ç±»å‹å’Œå¤æ‚åº¦ |
| **æ–‡æ¡£ç”Ÿæˆå™¨** | `lib/generator.js` | åŸºäºåˆ†ææŠ¥å‘Šå’Œæ¨¡æ¿ç”Ÿæˆå®šåˆ¶åŒ–æ–‡æ¡£ |
| **è½¯è¿æ¥ç®¡ç†å™¨** | `lib/symlink-manager.js` | åˆ›å»ºå’Œç®¡ç†ä¸Šæ¸¸æ–‡æ¡£åˆ°ä¸‹æ¸¸é¡¹ç›®çš„å¼•ç”¨ |
| **è¿ç§»ç®¡ç†å™¨** | `lib/migration-v21.js` | v21è¿ç§»è„šæœ¬ï¼Œæ”¯æŒæ—§ç‰ˆæœ¬ä»»åŠ¡è¿ç§» |
| **é…ç½®ç®¡ç†å™¨** | `lib/config.js` | å…¨å±€é…ç½®ã€å¸¸é‡å®šä¹‰ã€è·¯å¾„è§£æ |

---

## æ¶æ„å˜æ›´(v21.0)

### v21.0 æ ¸å¿ƒå˜æ›´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ—©æœŸæ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®æºï¼š                                                 â”‚
â”‚    1. workflow-state.json (ä¸»æ•°æ®æº, AIå¯ç¼–è¾‘)           â”‚
â”‚    2. task-meta.json (å®Œæ•´å‰¯æœ¬)                          â”‚
â”‚    3. .task-active.json (æ´»è·ƒæ ‡è®°)                       â”‚
â”‚                                                          â”‚
â”‚  çŠ¶æ€ç®¡ç†å™¨ï¼šStateManager                                 â”‚
â”‚    - ä¸‰æ–‡ä»¶åŒæ­¥é€»è¾‘                                       â”‚
â”‚    - æ‰‹åŠ¨åŒæ­¥API                                          â”‚
â”‚    - æ— æ–‡ä»¶é”æœºåˆ¶                                         â”‚
â”‚                                                          â”‚
â”‚  âŒ é—®é¢˜ï¼šæ•°æ®ä¸ä¸€è‡´é£é™©                                  â”‚
â”‚  âŒ é—®é¢˜ï¼šAIä¿®æ”¹workflow-stateåHookæ— æ³•æ„ŸçŸ¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â†“ é‡æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              v21.0 æ¶æ„ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®æºï¼š                                                 â”‚
â”‚    1. task-meta.json (å”¯ä¸€æ•°æ®æº) âœ¨                     â”‚
â”‚    2. .task-active.json (æ´»è·ƒæ ‡è®°æŒ‡é’ˆ)                   â”‚
â”‚                                                          â”‚
â”‚  çŠ¶æ€ç®¡ç†å™¨ï¼šTaskMetaManager                              â”‚
â”‚    - portalockeræ–‡ä»¶é”                                   â”‚
â”‚    - atomic_update()åŸå­æ›´æ–°                             â”‚
â”‚    - 3æ¬¡é‡è¯•+100mså»¶è¿Ÿ                                   â”‚
â”‚    - æ— éœ€æ‰‹åŠ¨åŒæ­¥                                         â”‚
â”‚                                                          â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šå•ä¸€æ•°æ®æºï¼Œæ— æ•°æ®ä¸ä¸€è‡´                         â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šæ–‡ä»¶é”ä¿è¯å¹¶å‘å®‰å…¨                               â”‚
â”‚  âœ… ä¼˜åŠ¿ï¼šç®€åŒ–Hooké€»è¾‘                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿ç§»è·¯å¾„

v21.0æä¾›è‡ªåŠ¨è¿ç§»æœºåˆ¶ï¼š

```bash
# è¿è¡Œinitmcæ—¶è‡ªåŠ¨æ£€æµ‹å¹¶è¿ç§»
npm run mc:deploy
# æˆ–
/initmc
```

**è¿ç§»è„šæœ¬**: `lib/migration-v21.js`

**è¿ç§»å†…å®¹**:
1. æ£€æµ‹ `.claude/workflow-state.json` å¹¶åˆå¹¶åˆ° `task-meta.json`
2. åˆ é™¤ `workflow-state.json`
3. ä¸ºæ‰€æœ‰ `task-meta.json` æ·»åŠ  `architecture_version: "21.0"`
4. åˆ é™¤å†—ä½™å­—æ®µ: `workflow_state`, `workflow_state_ref`, `archived_snapshot`

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚æ¶æ„æ¨¡å¼

```mermaid
graph TB
    subgraph "Layer 1: CLI å±‚"
        A[initmc CLI] --> B{é¡¹ç›®ç±»å‹æ£€æµ‹}
        B -->|MODSDK| C[ç¡®å®šé¡¹ç›®æ ¹ç›®å½•]
        B -->|å·¥ä½œæµ| D[æ‹’ç»éƒ¨ç½²]
        B -->|æœªçŸ¥| E[é€’å½’æœç´¢å­ç›®å½•]
    end

    subgraph "Layer 2: ä¸šåŠ¡é€»è¾‘å±‚"
        C --> F[init-workflow.js]
        F --> G[v21.0è¿ç§»æ£€æµ‹]
        F --> H[é¡¹ç›®åˆ†æ]
        F --> I[æ–‡æ¡£ç”Ÿæˆ]
        F --> J[è½¯è¿æ¥ç®¡ç†]
        F --> K[ç‰ˆæœ¬è¿½è¸ª]
    end

    subgraph "Layer 3: æ•°æ®å¤„ç†å±‚"
        G --> L[MigrationV21]
        H --> M[ProjectAnalyzer]
        I --> N[DocumentGenerator]
        J --> O[SymlinkManager]
        K --> P[VersionChecker]
    end

    subgraph "Layer 4: æ¨¡æ¿èµ„æºå±‚"
        N --> Q[templates/]
        O --> R[markdown/æ ¸å¿ƒæ–‡æ¡£]
        N --> S[å ä½ç¬¦æ›¿æ¢å¼•æ“]
    end

    style A fill:#4CAF50
    style F fill:#2196F3
    style L fill:#FF9800
    style M fill:#FF9800
    style N fill:#FF9800
    style O fill:#FF9800
    style Q fill:#9C27B0
```

---

## initmc å‘½ä»¤æ‰§è¡Œæµç¨‹

### å®Œæ•´æ‰§è¡Œåºåˆ—å›¾ï¼ˆv21.0ï¼‰

```mermaid
sequenceDiagram
    autonumber

    participant User as ç”¨æˆ·
    participant CLI as initmc CLI
    participant Detector as é¡¹ç›®æ£€æµ‹å™¨
    participant Init as init-workflow.js
    participant Migration as MigrationV21
    participant Analyzer as ProjectAnalyzer
    participant Generator as DocumentGenerator
    participant Symlink as SymlinkManager
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    User->>CLI: æ‰§è¡Œ initmc

    rect rgb(255, 245, 235)
        Note over CLI,Detector: ç¬¬ä¸€é˜¶æ®µï¼šé¡¹ç›®æ£€æµ‹ä¸éªŒè¯
        CLI->>Detector: detectProjectType(cwd)
        Detector->>FS: æ£€æŸ¥ modMain.py
        FS-->>Detector: è¿”å›è·¯å¾„æˆ–null
        Detector->>FS: æ£€æŸ¥ manifest.json
        FS-->>Detector: è¿”å›ç‰¹å¾ä¿¡æ¯
        Detector->>Detector: inferProjectRoot()
        Detector-->>CLI: {type, projectDir, feature}

        alt é¡¹ç›®ç±»å‹ = å·¥ä½œæµ
            CLI-->>User: é”™è¯¯ï¼šå½“å‰æ˜¯å·¥ä½œæµé¡¹ç›®æœ¬èº«
        else é¡¹ç›®ç±»å‹ = æœªçŸ¥
            CLI->>Detector: findModSDKProjects(é€’å½’æœç´¢)
            Detector-->>CLI: å€™é€‰é¡¹ç›®åˆ—è¡¨
            alt æ‰¾åˆ°å¤šä¸ªé¡¹ç›®
                CLI-->>User: æç¤ºï¼šè¯·åœ¨å…·ä½“é¡¹ç›®ç›®å½•æ‰§è¡Œ
            end
        end
    end

    rect rgb(232, 245, 233)
        Note over CLI,Migration: ç¬¬äºŒé˜¶æ®µï¼šv21.0è¿ç§»æ£€æµ‹
        CLI->>Init: main(projectPath)

        Init->>Migration: new MigrationV21(upstreamPath, projectPath)
        Init->>Migration: needsMigration()
        Migration->>FS: æ£€æŸ¥ workflow-state.json
        Migration->>FS: æ£€æŸ¥ task-meta.json
        FS-->>Migration: è¿”å›æ£€æµ‹ç»“æœ

        alt éœ€è¦è¿ç§»
            Init->>Migration: migrate({autoConfirm: true})
            Migration->>FS: åˆå¹¶ workflow-state â†’ task-meta
            Migration->>FS: åˆ é™¤ workflow-state.json
            Migration->>FS: æ·»åŠ  architecture_version: "21.0"
            Migration->>FS: åˆ é™¤å†—ä½™å­—æ®µ
            Migration-->>Init: {success, tasksProcessed, errors}
            Init-->>User: âœ… v21.0è¿ç§»å®Œæˆ
        end
    end

    rect rgb(227, 242, 253)
        Note over Analyzer,FS: ç¬¬ä¸‰é˜¶æ®µï¼šé¡¹ç›®åˆ†æ
        Init->>Analyzer: analyze(projectPath)
        Analyzer->>FS: æ‰«æ Python æ–‡ä»¶
        FS-->>Analyzer: *.py æ–‡ä»¶åˆ—è¡¨
        Analyzer->>Analyzer: _analyzePythonFile()
        Note right of Analyzer: æå– System ç±»<br/>æå– Preset ç±»<br/>è®¡ç®—å¤æ‚åº¦
        Analyzer->>Analyzer: _detectProjectType()
        Analyzer->>Analyzer: _calculateProjectScale()
        Analyzer-->>Init: AnalysisReport
        Note right of Init: åŒ…å«ï¼šmetadata<br/>codeStructure<br/>docCoverage
    end

    rect rgb(248, 231, 253)
        Note over Init,Generator: ç¬¬å››é˜¶æ®µï¼šæ–‡æ¡£ç”Ÿæˆ
        Init->>Generator: new DocumentGenerator(report, upstreamPath)
        Init->>Generator: generateAll(projectPath, {minimalMode: true})

        Generator->>Generator: _createDirectoryStructure()
        Generator->>FS: åˆ›å»ºç›®å½•

        Generator->>Generator: _generateLayer1()
        Note right of Generator: é€šç”¨å±‚ï¼šæ ¸å¿ƒå·¥ä½œæµ
        Generator->>Generator: _buildReplacements()
        Note right of Generator: æ„å»ºå ä½ç¬¦æ›¿æ¢è¡¨
        Generator->>Generator: _generateFromTemplate()
        Note right of Generator: mc.md, mc-review.md,<br/>mc-perf.md, etc.
        Generator->>Generator: _deployHooks()
        Note right of Generator: éƒ¨ç½² v21.0 Hook æ–‡ä»¶<br/>ï¼ˆä½¿ç”¨TaskMetaManagerï¼‰
        Generator->>FS: å†™å…¥å‘½ä»¤æ–‡ä»¶

        Generator->>Generator: _generateMinimalCLAUDE()
        Note right of Generator: é¦–æ¬¡éƒ¨ç½²ï¼šç”Ÿæˆæ¨¡æ¿<br/>å·²å­˜åœ¨ï¼šè·³è¿‡
        Generator->>FS: å†™å…¥ CLAUDE.md
    end

    rect rgb(255, 243, 224)
        Note over Init,Symlink: ç¬¬äº”é˜¶æ®µï¼šè½¯è¿æ¥ç®¡ç†
        Init->>Symlink: new SymlinkManager(upstreamPath, projectPath)
        Init->>Symlink: createAllSymlinks()

        Symlink->>Symlink: _getCoreFiles()
        Note right of Symlink: æ‰«æ markdown/ ç›®å½•<br/>è¿‡æ»¤æ ¸å¿ƒæ–‡æ¡£

        loop æ¯ä¸ªæ ¸å¿ƒæ–‡æ¡£
            Symlink->>Symlink: createSymlink(file)
            Symlink->>FS: å°è¯•åˆ›å»ºè½¯è¿æ¥
            alt æˆåŠŸ
                FS-->>Symlink: è½¯è¿æ¥åˆ›å»ºæˆåŠŸ
            else å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰
                Symlink->>Symlink: _createReadonlyCopy()
                Symlink->>FS: å¤åˆ¶æ–‡ä»¶ + æ·»åŠ åªè¯»æ ‡è®°
                FS-->>Symlink: åªè¯»å‰¯æœ¬åˆ›å»ºæˆåŠŸ
            end
        end

        Symlink-->>Init: ç»“æœç»Ÿè®¡

        Init->>Symlink: createMarkdownSymlinks()
        Note right of Symlink: åœ¨ markdown/ åˆ›å»º<br/>æŒ‡å‘ .claude/core-docs/ çš„å¼•ç”¨
    end

    rect rgb(255, 249, 196)
        Note over Init,User: ç¬¬å…­é˜¶æ®µï¼šå®ŒæˆæŠ¥å‘Š
        Init->>Init: ç”Ÿæˆç‰ˆæœ¬è¿½è¸ªæ–‡ä»¶
        Note right of Init: .claude/workflow-manifest.json<br/>è®°å½• v21.0.0
        Init-->>User: âœ… æ ¸å¿ƒå·¥ä½œæµéƒ¨ç½²å®Œæˆ
        Note right of User: è¾“å‡ºéƒ¨ç½²å†…å®¹æ‘˜è¦<br/>ä¸‹ä¸€æ­¥æ“ä½œå»ºè®®
    end
```

---

## ä»»åŠ¡æ‰§è¡Œæ•°æ®æµ

### å®Œæ•´æ‰§è¡Œåºåˆ—å›¾ (v21.0)

```mermaid
sequenceDiagram
    autonumber

    participant User as ç”¨æˆ·
    participant CLI as Claude Code CLI
    participant Hook1 as UserPromptSubmit Hook
    participant AI as Claude AI
    participant Hook2 as PostToolUse Hook
    participant Hook3 as PostArchive Hook
    participant TMM as TaskMetaManager
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    rect rgb(255, 245, 235)
        Note over User,Hook1: ç¬¬ä¸€é˜¶æ®µï¼šä»»åŠ¡åˆå§‹åŒ– (/mc å‘½ä»¤)
        User->>CLI: è¾“å…¥ "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½"
        CLI->>Hook1: UserPromptSubmit è§¦å‘

        Hook1->>Hook1: æ£€æµ‹ /mc å‘½ä»¤
        Hook1->>Hook1: ç”Ÿæˆ task_id (20251115-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½)
        Hook1->>FS: åˆ›å»º tasks/20251115-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½/

        Hook1->>TMM: new TaskMetaManager(cwd)
        Hook1->>TMM: åˆå§‹åŒ– task-meta.json
        Note right of Hook1: architecture_version: "21.0"<br/>current_step: "step3_execute"<br/>steps, metrics, bug_fix_tracking

        TMM->>FS: atomic_update() å†™å…¥ task-meta.json
        Note right of TMM: portalockeræ–‡ä»¶é”<br/>åŸå­æ€§å†™å…¥

        Hook1->>FS: åˆå§‹åŒ– .conversation.jsonl
        Note right of Hook1: ä¼šè¯å†å²æŒä¹…åŒ–

        Hook1->>TMM: set_active_task(task_id)
        TMM->>FS: å†™å…¥ .claude/.task-active.json
        Note right of TMM: {"task_id": "xxx",<br/>"created_at": "..."}

        Hook1->>Hook1: åŒ¹é…ç©æ³•çŸ¥è¯†åº“
        Note right of Hook1: æŸ¥æ‰¾ knowledge-base.json<br/>æˆ–ç”ŸæˆBUGä¿®å¤æŒ‡å¼•

        Hook1-->>AI: æ³¨å…¥ç©æ³•åŒ…/BUGä¿®å¤æŒ‡å¼•
        Note right of AI: åŒ…å«å®Œæ•´å®ç°ä»£ç <br/>æˆ–æ™ºèƒ½è¯Šæ–­è·¯å¾„
    end

    rect rgb(232, 245, 233)
        Note over AI,Hook2: ç¬¬äºŒé˜¶æ®µï¼šä»»åŠ¡æ‰§è¡Œ (Read/Write/Edit/Bash)

        loop å·¥å…·è°ƒç”¨å¾ªç¯
            AI->>FS: Read(æ–‡æ¡£) / Edit(ä»£ç ) / Bash(æµ‹è¯•)
            FS-->>AI: å·¥å…·æ‰§è¡Œç»“æœ

            AI->>Hook2: PostToolUse è§¦å‘

            Hook2->>TMM: get_active_task_id()
            TMM->>FS: è¯»å– .task-active.json
            FS-->>TMM: è¿”å› task_id

            alt æ— æ´»è·ƒä»»åŠ¡
                Hook2-->>AI: è·³è¿‡ï¼Œç»§ç»­æ‰§è¡Œ
            else æœ‰æ´»è·ƒä»»åŠ¡
                Hook2->>TMM: load_task_meta(task_id)
                TMM->>FS: åŠ è½½ task-meta.jsonï¼ˆå¸¦æ–‡ä»¶é”ï¼‰
                FS-->>TMM: è¿”å› task_meta

                Hook2->>Hook2: å·¥å…·åˆ†å‘å¤„ç†
                Note right of Hook2: Read â†’ æ›´æ–°docs_read<br/>Write/Edit â†’ æ›´æ–°code_changes<br/>Bash â†’ æ£€æµ‹å¤±è´¥

                Hook2->>Hook2: æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶
                Note right of Hook2: step0: CLAUDE.mdå·²è¯»<br/>step1: æ–‡æ¡£å·²é˜…è¯»<br/>step3: ç”¨æˆ·ç¡®è®¤<br/>step4: cleanupå®Œæˆ

                alt æ­¥éª¤å®Œæˆ
                    Hook2->>Hook2: å‡†å¤‡æ›´æ–°å‡½æ•°
                    Note right of Hook2: def update_func(meta):<br/>  meta['current_step'] = next_step<br/>  meta['steps'][next_step]['status'] = 'in_progress'<br/>  return meta

                    Hook2->>TMM: atomic_update(task_id, update_func)
                    TMM->>FS: åŠ è½½å½“å‰çŠ¶æ€ï¼ˆå¸¦é”ï¼‰
                    TMM->>TMM: æ‰§è¡Œæ›´æ–°å‡½æ•°
                    TMM->>FS: ä¿å­˜ï¼ˆåŒä¸€é”å†…ï¼‰
                    FS-->>TMM: âœ… åŸå­æ›´æ–°æˆåŠŸ

                    Hook2-->>AI: æ³¨å…¥ä¸‹ä¸€æ­¥æŒ‡ä»¤
                    Note right of AI: æ­¥éª¤4ç‰¹æ®Šå¤„ç†ï¼š<br/>ç”Ÿæˆcontext.md/solution.md<br/>å¯åŠ¨å­ä»£ç†
                else æ­¥éª¤æœªå®Œæˆ
                    Hook2->>Hook2: æ£€æŸ¥å¾ªç¯æ¨¡å¼
                    Note right of Hook2: æ£€æµ‹Bugä¿®å¤å¾ªç¯<br/>2æ¬¡è¿­ä»£+2æ¬¡è´Ÿé¢åé¦ˆ<br/>+2æ¬¡åŒæ–‡ä»¶ä¿®æ”¹

                    alt è§¦å‘ä¸“å®¶è¯Šæ–­
                        Hook2-->>AI: æ³¨å…¥ä¸“å®¶åˆ†æprompt
                        Note right of AI: Meta-Expertç³»ç»Ÿ<br/>æˆ˜ç•¥é«˜åº¦åˆ†æ<br/>å¤‡é€‰æ–¹æ¡ˆæ¨è
                    else ç»§ç»­æ‰§è¡Œ
                        Hook2-->>AI: ç»§ç»­å½“å‰æ­¥éª¤
                    end
                end
            end
        end
    end

    rect rgb(227, 242, 253)
        Note over User,AI: ç¬¬ä¸‰é˜¶æ®µï¼šç”¨æˆ·ç¡®è®¤ä¸æ”¶å°¾
        User->>AI: "å·²ä¿®å¤" æˆ– "åŠŸèƒ½å·²å®Œæˆ"
        AI->>AI: è§£æç”¨æˆ·åé¦ˆ
        Note right of AI: æ£€æµ‹ç¡®è®¤å…³é”®è¯<br/>æ ‡è®°user_confirmed=true

        AI->>Hook2: PostToolUseè§¦å‘ï¼ˆç”¨æˆ·æ¶ˆæ¯åï¼‰
        Hook2->>Hook2: æ£€æµ‹ step3_execute å®Œæˆæ¡ä»¶
        Hook2->>Hook2: å‡†å¤‡æ¨è¿›åˆ° step4_cleanup

        Hook2->>TMM: atomic_update(task_id, update_func)
        Note right of Hook2: æ ‡è®°step3å®Œæˆ<br/>æ¨è¿›åˆ°step4

        Hook2->>FS: è°ƒç”¨ generate-docs-from-conversation.py
        Note right of Hook2: ä»ä¼šè¯å†å²ç”Ÿæˆ<br/>context.md + solution.md

        Hook2-->>AI: æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
        Note right of AI: æ–‡æ¡£æ›´æ–°Agent<br/>è‡ªåŠ¨è¡¥å……markdownæ–‡æ¡£

        AI->>AI: å¯åŠ¨ Task Agent
        Note right of AI: ç‹¬ç«‹å­ä»£ç†<br/>ä¸æ¶ˆè€—ä¸»ä¼šè¯ä¸Šä¸‹æ–‡

        AI->>FS: æœç´¢å¾…è¡¥å……æ–‡æ¡£ (Glob)
        AI->>FS: æ›´æ–°ç›¸å…³æ–‡æ¡£ (Edit/Write)

        AI->>TMM: atomic_update(task_id, mark_step4_complete)
        Note right of AI: æ ‡è®° step4_cleanup completed
    end

    rect rgb(248, 231, 253)
        Note over Hook3,FS: ç¬¬å››é˜¶æ®µï¼šä»»åŠ¡å½’æ¡£
        FS-->>Hook3: PostToolUseè§¦å‘
        Hook3->>TMM: get_active_task_id()
        Hook3->>TMM: load_task_meta(task_id)
        TMM->>FS: åŠ è½½ task-meta.jsonï¼ˆå¸¦é”ï¼‰
        FS-->>TMM: è¿”å› task_meta

        Hook3->>Hook3: æ£€æµ‹ step4_cleanup æ˜¯å¦å®Œæˆ

        alt step4 å·²å®Œæˆä¸”æœªå½’æ¡£
            Hook3->>Hook3: è·å–å½’æ¡£é”
            Note right of Hook3: .archive-lock<br/>é˜²æ­¢å¹¶å‘é—®é¢˜

            Hook3->>FS: ç§»åŠ¨ä»»åŠ¡ç›®å½•
            Note right of Hook3: tasks/xxx/<br/>â†’ tasks/å·²å½’æ¡£/xxx/

            Hook3->>TMM: atomic_update(task_id, mark_archived)
            Note right of Hook3: archived=true<br/>archived_at=now

            Hook3->>FS: ç”Ÿæˆæ–‡æ¡£å¿«ç…§
            Note right of Hook3: .claude/.doc-snapshot.json<br/>è®°å½•å½’æ¡£å‰çŠ¶æ€

            Hook3-->>AI: æ³¨å…¥æ–‡æ¡£åŒæ­¥ä»»åŠ¡
            Note right of AI: å¯åŠ¨ç¬¬äºŒä¸ªå­ä»£ç†<br/>åˆ†æå½’æ¡£ä»»åŠ¡<br/>åˆ›å»º/æ›´æ–°markdownæ–‡æ¡£

            Hook3->>Hook3: é‡Šæ”¾å½’æ¡£é”
        else step4 æœªå®Œæˆæˆ–å·²å½’æ¡£
            Hook3-->>AI: è·³è¿‡å½’æ¡£
        end
    end

    rect rgb(255, 249, 196)
        Note over User,AI: ç¬¬äº”é˜¶æ®µï¼šå®ŒæˆæŠ¥å‘Š
        AI-->>User: ä»»åŠ¡å®Œæˆæ€»ç»“
        Note right of User: - ä»£ç ä¿®æ”¹æ‘˜è¦<br/>- æ–‡æ¡£æ›´æ–°åˆ—è¡¨<br/>- æµ‹è¯•éªŒè¯ç»“æœ<br/>- å½’æ¡£è·¯å¾„
    end
```

### æ•°æ®æµå…³é”®è·¯å¾„

#### è·¯å¾„1: ä»»åŠ¡åˆå§‹åŒ– (/mc â†’ UserPromptSubmit Hook) - v21.0

```
ç”¨æˆ·è¾“å…¥ "/mc ä»»åŠ¡æè¿°"
  â†“
UserPromptSubmit Hook æ£€æµ‹
  â†“
ç”Ÿæˆ task_id (æ—¶é—´æˆ³-ç®€çŸ­æè¿°)
  â†“
åˆ›å»ºç›®å½•ç»“æ„:
  tasks/20251115-xxx-ä»»åŠ¡æè¿°/
    â”œâ”€ .task-meta.json         # ä»»åŠ¡å®Œæ•´çŠ¶æ€ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰âœ¨
    â”œâ”€ .conversation.jsonl      # ä¼šè¯å†å²
    â”œâ”€ context.md (å¾…ç”Ÿæˆ)      # é—®é¢˜ä¸Šä¸‹æ–‡
    â””â”€ solution.md (å¾…ç”Ÿæˆ)     # è§£å†³æ–¹æ¡ˆ
  â†“
åˆå§‹åŒ–ä»»åŠ¡å…ƒæ•°æ®ï¼ˆv21.0ï¼‰:
  TaskMetaManager.atomic_update(task_id, init_func)

  .task-meta.json å†…å®¹:
    - architecture_version: "21.0" âœ¨
    - task_id, task_description
    - current_step: "step3_execute"
    - steps: {step0, step1, step3, step4}
    - metrics: {docs_read, code_changes, failures}
    - bug_fix_tracking: {iterations, loop_indicators}
  â†“
è®¾ç½®æ´»è·ƒä»»åŠ¡:
  TaskMetaManager.set_active_task(task_id)

  .claude/.task-active.json å†…å®¹:
    - task_id
    - created_at
  â†“
åŒ¹é…ç©æ³•çŸ¥è¯†åº“æˆ–ç”ŸæˆBUGä¿®å¤æŒ‡å¼•
  â†“
æ³¨å…¥åˆ°AIå¯¹è¯ä¸Šä¸‹æ–‡
```

#### è·¯å¾„2: å·¥å…·è°ƒç”¨å¤„ç† (Read/Write/Edit â†’ PostToolUse Hook) - v21.0

```
AI è°ƒç”¨å·¥å…· (Read/Write/Edit/Bash)
  â†“
å·¥å…·æ‰§è¡Œå®Œæˆ
  â†“
PostToolUse Hook è§¦å‘
  â†“
å¿«é€Ÿæ£€æŸ¥æ´»è·ƒä»»åŠ¡:
  task_id = TaskMetaManager.get_active_task_id()
  â”œâ”€ None â†’ è·³è¿‡ (æ— æ´»è·ƒä»»åŠ¡)
  â””â”€ å­˜åœ¨ â†’ ç»§ç»­å¤„ç†
  â†“
åŠ è½½ä»»åŠ¡å…ƒæ•°æ®ï¼ˆv21.0ï¼‰:
  task_meta = TaskMetaManager.load_task_meta(task_id)
  # è‡ªåŠ¨ä½¿ç”¨portalockeræ–‡ä»¶é”
  â†“
å·¥å…·ç±»å‹åˆ†å‘:
  â”œâ”€ Read  â†’ update_docs_read()
  â”‚          â””â”€ metrics.docs_read.append(file_path)
  â”‚
  â”œâ”€ Write/Edit â†’ update_code_changes()
  â”‚               â””â”€ metrics.code_changes.append(change_record)
  â”‚               â””â”€ ç»Ÿè®¡ same_file_edit_count
  â”‚               â””â”€ æ›´æ–° bug_fix_tracking
  â”‚
  â””â”€ Bash â†’ check_test_failure()
            â””â”€ metrics.failure_count += 1
            â””â”€ æ£€æŸ¥æ˜¯å¦è§¦å‘ä¸“å®¶è¯Šæ–­
  â†“
æ£€æŸ¥æ­¥éª¤å®Œæˆæ¡ä»¶:
  â”œâ”€ step0_context: "CLAUDE.md" in docs_read
  â”œâ”€ step1_understand: docs_read_count > 0
  â”œâ”€ step3_execute: user_confirmed = true
  â””â”€ step4_cleanup: status = "completed"
  â†“
æ­¥éª¤å®Œæˆ â†’ æ¨è¿›çŠ¶æ€æœºï¼ˆv21.0åŸå­æ›´æ–°ï¼‰:
  def update_func(meta):
      # 1. æ ‡è®°å½“å‰æ­¥éª¤å®Œæˆ
      meta['steps'][current_step]['status'] = 'completed'
      meta['steps'][current_step]['completed_at'] = now()

      # 2. æ¨è¿›åˆ°ä¸‹ä¸€æ­¥
      meta['current_step'] = next_step
      meta['steps'][next_step]['status'] = 'in_progress'
      meta['steps'][next_step]['started_at'] = now()

      return meta

  TaskMetaManager.atomic_update(task_id, update_func)
  # âœ¨ v21.0: æ— éœ€æ‰‹åŠ¨åŒæ­¥å…¶ä»–æ–‡ä»¶ï¼
  â†“
æ³¨å…¥ä¸‹ä¸€æ­¥æŒ‡ä»¤
```

#### è·¯å¾„3: æ­¥éª¤4æ”¶å°¾ (step4_cleanup â†’ æ–‡æ¡£ç”Ÿæˆ â†’ å½’æ¡£) - v21.0

```
AI æ ‡è®° step4 å®Œæˆ:
  TaskMetaManager.atomic_update(task_id, lambda meta: {
      **meta,
      "steps": {
          **meta["steps"],
          "step4_cleanup": {
              **meta["steps"]["step4_cleanup"],
              "status": "completed",
              "completed_at": datetime.now().isoformat()
          }
      }
  })
  â†“
PostToolUse Hook æ£€æµ‹åˆ° step4 å®Œæˆ
  â†“
è°ƒç”¨ generate-docs-from-conversation.py
  â”œâ”€ è¯»å– .conversation.jsonl
  â”œâ”€ æå–é—®é¢˜æè¿°ã€åˆ†æè¿‡ç¨‹ã€ä»£ç ä¿®æ”¹
  â”œâ”€ ç”Ÿæˆ context.md
  â””â”€ ç”Ÿæˆ solution.md
  â†“
æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
  â†“
AI å¯åŠ¨ Task Agent (å­ä»£ç†)
  â”œâ”€ æœç´¢ markdown/**/*.md (å¾…è¡¥å……æ ‡è®°)
  â”œâ”€ æ›´æ–°ç›¸å…³æ–‡æ¡£ (Edit/Write)
  â””â”€ TaskMetaManager.atomic_update() æœ€ç»ˆæ ‡è®°å®Œæˆ
  â†“
PostArchive Hook æ£€æµ‹åˆ°å½’æ¡£æ¡ä»¶
  â†“
å½’æ¡£æµç¨‹ï¼ˆv21.0ï¼‰:
  task_meta = TaskMetaManager.load_task_meta(task_id)

  if task_meta['steps']['step4_cleanup']['status'] == 'completed' and not task_meta.get('archived'):
      # 1. è·å–å½’æ¡£é”
      lock = acquire_archive_lock(task_dir)

      # 2. ç§»åŠ¨ä»»åŠ¡ç›®å½•
      shutil.move(task_dir, archived_task_dir)

      # 3. æ ‡è®°å½’æ¡£ï¼ˆåŸå­æ›´æ–°ï¼‰
      TaskMetaManager.atomic_update(task_id, lambda meta: {
          **meta,
          "archived": True,
          "archived_at": datetime.now().isoformat()
      })

      # 4. ç”Ÿæˆæ–‡æ¡£å¿«ç…§
      generate_doc_snapshot()

      # 5. é‡Šæ”¾å½’æ¡£é”
      release_archive_lock()
  â†“
AI å¯åŠ¨æ–‡æ¡£åŒæ­¥ Agent
  â”œâ”€ è¯»å– context.md + solution.md
  â”œâ”€ åˆ†æä»»åŠ¡å½±å“èŒƒå›´
  â”œâ”€ åˆ›å»º/æ›´æ–° markdown æ–‡æ¡£
  â””â”€ è¾“å‡ºå®ŒæˆæŠ¥å‘Š
  â†“
ä»»åŠ¡å®Œæˆ
```

---

## äºŒæ–‡ä»¶çŠ¶æ€æ¶æ„

### è®¾è®¡åŠ¨æœº (v21.0)

**æ—©æœŸç‰ˆæœ¬é—®é¢˜èƒŒæ™¯**:
- âŒ ä¸‰æ–‡ä»¶åŒæ­¥é€»è¾‘å¤æ‚ï¼ˆworkflow-state.json + task-meta.json + .task-active.jsonï¼‰
- âŒ æ•°æ®ä¸ä¸€è‡´é£é™©ï¼šAIä¿®æ”¹workflow-stateåï¼ŒHookæ— æ³•æ„ŸçŸ¥å˜åŒ–
- âŒ æ­¥éª¤æ¨è¿›é€»è¾‘å¤±æ•ˆï¼ˆå¦‚ step4 å®Œæˆåæ— æ³•è§¦å‘å½’æ¡£ï¼‰
- âŒ æ‰‹åŠ¨åŒæ­¥APIæ˜“å‡ºé”™

**v21.0è§£å†³æ–¹æ¡ˆ**:
- âœ… **å•ä¸€æ•°æ®æº**ï¼štask-meta.jsonä¸ºå”¯ä¸€æƒå¨æ•°æ®æº
- âœ… **æ–‡ä»¶é”æœºåˆ¶**ï¼športalockerä¿è¯å¹¶å‘å®‰å…¨
- âœ… **åŸå­æ›´æ–°**ï¼šatomic_update()é—­åŒ…æ¨¡å¼
- âœ… **è‡ªåŠ¨é‡è¯•**ï¼š3æ¬¡é‡è¯•+100mså»¶è¿Ÿ
- âœ… **ç®€åŒ–Hook**ï¼šæ— éœ€æ‰‹åŠ¨åŒæ­¥é€»è¾‘

### äºŒæ–‡ä»¶èŒè´£åˆ’åˆ†ï¼ˆv21.0ï¼‰

| æ–‡ä»¶è·¯å¾„ | èŒè´£ | ç”Ÿå‘½å‘¨æœŸ | æ›´æ–°æ—¶æœº | è¯»å–è€… |
|---------|------|---------|---------|--------|
| **tasks/{task_id}/.task-meta.json** | ä»»åŠ¡å®Œæ•´çŠ¶æ€ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰âœ¨ | ä»»åŠ¡çº§ | æ¯æ¬¡å·¥å…·è°ƒç”¨å<br/>åŸå­æ›´æ–° | pretooluse_enforcer.py<br/>posttooluse_updater.py<br/>post_archive.py |
| **.claude/.task-active.json** | æ´»è·ƒä»»åŠ¡æ ‡å¿—ï¼ˆå¿«é€ŸæŸ¥æ‰¾æŒ‡é’ˆï¼‰ | ä¼šè¯çº§ | ä»»åŠ¡åˆå§‹åŒ–<br/>ä»»åŠ¡å½’æ¡£åˆ é™¤ | pretooluse_enforcer.py<br/>posttooluse_updater.py<br/>post_archive.py |

**æ¶æ„å¯¹æ¯”**:

| ç‰¹æ€§ | æ—©æœŸç‰ˆæœ¬ | v21.0 |
|-----|-------|-------|
| æ•°æ®æºæ•°é‡ | 3ä¸ªï¼ˆworkflow-state + task-meta + task-activeï¼‰ | 2ä¸ªï¼ˆtask-meta + task-activeï¼‰ |
| æƒå¨æ•°æ®æº | workflow-state.jsonï¼ˆAIå¯ç¼–è¾‘ï¼‰| task-meta.json |
| åŒæ­¥æœºåˆ¶ | æ‰‹åŠ¨ä¸‰æ–‡ä»¶åŒæ­¥ | æ— éœ€åŒæ­¥ |
| å¹¶å‘å®‰å…¨ | æ— é”æœºåˆ¶ | portalockeræ–‡ä»¶é” |
| æ›´æ–°æ–¹å¼ | ç›´æ¥å†™å…¥ | atomic_update()é—­åŒ… |
| æ•°æ®ä¸€è‡´æ€§ | é£é™©é«˜ | ä¿è¯ä¸€è‡´ |

### æ•°æ®æµå‘å›¾ï¼ˆv21.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  .task-active.json                       â”‚
â”‚  {                                                       â”‚
â”‚    "task_id": "20251115-123456-ä¿®å¤ç©å®¶æ­»äº¡BUG",        â”‚
â”‚    "created_at": "2025-11-15T12:34:56.789Z"             â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ æŒ‡å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       tasks/{task_id}/.task-meta.json                    â”‚
â”‚  {                                                       â”‚
â”‚    "architecture_version": "21.0",        âœ¨ v21.0æ ‡è®°   â”‚
â”‚    "task_id": "...",                                     â”‚
â”‚    "task_description": "...",                            â”‚
â”‚    "current_step": "step3_execute",                      â”‚
â”‚    "steps": {                                            â”‚
â”‚      "step0_context": {...},                             â”‚
â”‚      "step1_understand": {...},                          â”‚
â”‚      "step3_execute": {...},                             â”‚
â”‚      "step4_cleanup": {...}                              â”‚
â”‚    },                                                    â”‚
â”‚    "metrics": {                                          â”‚
â”‚      "docs_read": [...],                                 â”‚
â”‚      "code_changes": [...],                              â”‚
â”‚      "failures": [...]                                   â”‚
â”‚    },                                                    â”‚
â”‚    "bug_fix_tracking": {                                 â”‚
â”‚      "iterations": [...],                                â”‚
â”‚      "loop_indicators": {...}                            â”‚
â”‚    }                                                     â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘
              æ‰€æœ‰Hookç›´æ¥è¯»å–æ­¤æ–‡ä»¶
              ä½¿ç”¨ TaskMetaManager.load_task_meta()
              ä½¿ç”¨ TaskMetaManager.atomic_update()
```

### åŸå­æ›´æ–°æµç¨‹å›¾ï¼ˆv21.0æ ¸å¿ƒæœºåˆ¶ï¼‰

```mermaid
flowchart TD
    A[Hookè°ƒç”¨ atomic_update] --> B[å®šä¹‰æ›´æ–°å‡½æ•°]

    B --> C["def update_func(meta):<br/>  meta['current_step'] = 'step3'<br/>  return meta"]

    C --> D[TaskMetaManager.atomic_update<br/>(task_id, update_func)]

    D --> E[å°è¯•æ¬¡æ•° attempt = 0]

    E --> F{attempt < max_retries?}
    F -->|å¦| G[âŒ æŠ›å‡ºå¼‚å¸¸]
    F -->|æ˜¯| H[portalocker.Lock è·å–é”]

    H --> I{é”è·å–æˆåŠŸ?}
    I -->|å¦| J[ç­‰å¾… retry_delay]
    I -->|æ˜¯| K[è¯»å–æ–‡ä»¶å†…å®¹]

    J --> L[attempt += 1]
    L --> F

    K --> M[æ‰§è¡Œ update_func]
    M --> N[å†™å›æ–‡ä»¶ seek(0) + truncate]
    N --> O[é‡Šæ”¾é”]

    O --> P[âœ… è¿”å›æ›´æ–°åçš„meta]

    style A fill:#4CAF50
    style D fill:#FF9800
    style H fill:#2196F3
    style I fill:#FFC107
    style P fill:#4CAF50
    style G fill:#F44336
```

### åŸå­æ›´æ–°ä»£ç ç¤ºä¾‹ï¼ˆv21.0ï¼‰

```python
from core.task_meta_manager import TaskMetaManager

# åˆå§‹åŒ–ç®¡ç†å™¨
mgr = TaskMetaManager(cwd)

# æ–¹å¼1: ç®€å•æ›´æ–°ï¼ˆæ¨èï¼‰
def update_func(meta: Dict) -> Dict:
    # 1. è¯»å–å½“å‰å€¼
    current_step = meta.get('current_step')

    # 2. æ‰§è¡Œæ›´æ–°é€»è¾‘
    meta['current_step'] = 'step3_execute'
    meta['steps']['step3_execute']['status'] = 'in_progress'
    meta['steps']['step3_execute']['started_at'] = datetime.now().isoformat()

    # 3. æ›´æ–°metrics
    if 'metrics' not in meta:
        meta['metrics'] = {}
    meta['metrics']['tool_calls'] = meta['metrics'].get('tool_calls', [])
    meta['metrics']['tool_calls'].append({
        "tool": "Edit",
        "timestamp": datetime.now().isoformat()
    })

    # 4. è¿”å›æ›´æ–°åçš„meta
    return meta

# æ‰§è¡ŒåŸå­æ›´æ–°
updated_meta = mgr.atomic_update(task_id, update_func)

# æ–¹å¼2: Lambdaè¡¨è¾¾å¼ï¼ˆç®€æ´ï¼‰
updated_meta = mgr.atomic_update(
    task_id,
    lambda meta: {
        **meta,
        "current_step": "step4_cleanup",
        "steps": {
            **meta["steps"],
            "step4_cleanup": {
                **meta["steps"]["step4_cleanup"],
                "status": "completed",
                "completed_at": datetime.now().isoformat()
            }
        }
    }
)
```

### å¹¶å‘å®‰å…¨ä¿è¯ï¼ˆv21.0ï¼‰

**æ–‡ä»¶é”å®ç°**:

```python
import portalocker

def atomic_update(self, task_id, update_func, max_retries=3, retry_delay=0.1):
    """åŸå­æ›´æ–°ä»»åŠ¡å…ƒæ•°æ®ï¼ˆæ–‡ä»¶é”+é‡è¯•æœºåˆ¶ï¼‰"""
    meta_path = self.get_task_dir(task_id) / '.task-meta.json'

    for attempt in range(max_retries):
        try:
            # ä½¿ç”¨portalockerè·å–ç‹¬å é”
            with portalocker.Lock(meta_path, 'r+', timeout=5) as f:
                # 1. è¯»å–å½“å‰çŠ¶æ€ï¼ˆåœ¨é”ä¿æŠ¤ä¸‹ï¼‰
                meta = json.load(f)

                # 2. æ‰§è¡Œæ›´æ–°å‡½æ•°
                updated_meta = update_func(meta)

                # 3. å†™å›æ–‡ä»¶ï¼ˆåœ¨åŒä¸€ä¸ªé”å†…ï¼‰
                f.seek(0)
                f.truncate()
                json.dump(updated_meta, f, ensure_ascii=False, indent=2)

            # æˆåŠŸè¿”å›
            return updated_meta

        except portalocker.exceptions.LockException:
            # é”è·å–å¤±è´¥ï¼Œé‡è¯•
            if attempt < max_retries - 1:
                time.sleep(retry_delay)
                continue
            else:
                raise
```

**å…³é”®ç‰¹æ€§**:
1. **ç‹¬å é”**: `portalocker.Lock` ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä¿®æ”¹æ–‡ä»¶
2. **åŸå­æ€§**: åœ¨åŒä¸€ä¸ªé”å†…å®Œæˆ è¯»å–â†’æ›´æ–°â†’å†™å…¥
3. **é‡è¯•æœºåˆ¶**: é”è·å–å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼Œ100msé—´éš”ï¼‰
4. **è¶…æ—¶ä¿æŠ¤**: é”è¶…æ—¶æ—¶é—´5ç§’ï¼Œé˜²æ­¢æ­»é”

---

## ä¼šè¯å†å²æŒä¹…åŒ–

### è®¾è®¡åŠ¨æœº

**æ ¸å¿ƒé—®é¢˜**:
- âŒ Claude Code ä¼šè¯å†å²æœªæŒä¹…åŒ–ï¼Œå‹ç¼©ä¼šè¯/è·¨ä¼šè¯åä¿¡æ¯ä¸¢å¤±
- âŒ `.task-meta.json` ä»…ä¿å­˜å…ƒæ•°æ®ï¼Œç¼ºå°‘ä¸Šä¸‹æ–‡ç»†èŠ‚
- âŒ AI ä¾èµ–è®°å¿†ç”Ÿæˆå½’æ¡£æ–‡æ¡£ï¼Œè´¨é‡æ— æ³•ä¿è¯
- âŒ å­ä»£ç†æ— æ³•è®¿é—®ä¸»ä¼šè¯ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æŒä¹…åŒ–å®Œæ•´ä¼šè¯å†å²åˆ° `.conversation.jsonl` (JSON Lines æ ¼å¼)
- âœ… æ”¯æŒè·¨ä¼šè¯è¡¥å……å½’æ¡£ï¼ˆä»å†å²æ•°æ®é‡å»ºï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡å½’æ¡£æ–‡æ¡£ï¼ˆcontext.md + solution.mdï¼‰

### ä¼šè¯å†å²æ–‡ä»¶æ ¼å¼

#### .conversation.jsonl ç»“æ„

```jsonlines
{"timestamp": "2025-11-15T14:35:20.123Z", "role": "user", "content": "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½", "event_type": "task_init"}
{"timestamp": "2025-11-15T14:35:25.456Z", "role": "assistant", "content": "æˆ‘å°†å¸®ä½ ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½ã€‚è®©æˆ‘å…ˆæŸ¥é˜…ç›¸å…³æ–‡æ¡£...", "event_type": "response"}
{"timestamp": "2025-11-15T14:35:30.789Z", "role": "tool", "tool_name": "Read", "tool_input": {"file_path": "markdown/systems/å•†åº—ç³»ç»Ÿ.md"}, "event_type": "tool_call"}
{"timestamp": "2025-11-15T14:35:32.012Z", "role": "tool", "tool_name": "Read", "tool_result_summary": "æˆåŠŸè¯»å– 150 è¡Œ", "event_type": "tool_result"}
{"timestamp": "2025-11-15T14:36:10.345Z", "role": "tool", "tool_name": "Edit", "tool_input": {"file_path": "scripts/ShopServerSystem.py"}, "event_type": "tool_call"}
{"timestamp": "2025-11-15T14:36:15.678Z", "role": "user", "content": "æŠ¥é”™äº†ï¼šAttributeError", "event_type": "feedback", "sentiment": "negative"}
{"timestamp": "2025-11-15T14:36:20.901Z", "role": "assistant", "content": "æˆ‘çœ‹åˆ°é”™è¯¯äº†ï¼Œé—®é¢˜åœ¨äºå•†å“æ•°æ®æœªæ­£ç¡®åŠ è½½...", "event_type": "response"}
```

---

## æ•°æ®è½¬æ¢æµç¨‹

### é¡¹ç›®ç‰¹å¾ â†’ åˆ†ææŠ¥å‘Š

```mermaid
flowchart TD
    A[æ‰«æ Python æ–‡ä»¶] --> B{æ£€æµ‹ç±»å®šä¹‰}
    B -->|class XXXSystem| C[æå– System ä¿¡æ¯]
    B -->|class XXXPreset| D[æå– Preset ä¿¡æ¯]

    C --> E[è®¡ç®—å¤æ‚åº¦è¯„åˆ†]
    E --> E1[å› ç´ 1: ä»£ç è¡Œæ•°]
    E --> E2[å› ç´ 2: æ–¹æ³•æ•°é‡]
    E --> E3[å› ç´ 3: äº‹ä»¶ç›‘å¬æ•°]
    E --> E4[å› ç´ 4: æ ¸å¿ƒå…³é”®è¯]
    E --> E5[å› ç´ 5: ä¾èµ–å…³ç³»]

    E1 & E2 & E3 & E4 & E5 --> F[complexityScore: 0-10]

    F --> G{æ¨èè¯¦ç»†åº¦}
    G -->|score â‰¥ 8| H[detailed: 3000å­—]
    G -->|5 â‰¤ score < 8| I[medium: 1500å­—]
    G -->|score < 5| J[simple: 500å­—]

    H & I & J --> K[SystemInfoå¯¹è±¡]
    D --> L[PresetInfoå¯¹è±¡]

    K & L --> M[CodeStructure]
    M --> N[AnalysisReport]

    O[é¡¹ç›®ç±»å‹æ¨æ–­] --> N
    P[æ¶æ„ç‰¹å¾æ£€æµ‹] --> N
    Q[æ–‡æ¡£è¦†ç›–ç‡ç»Ÿè®¡] --> N

    style A fill:#4CAF50
    style N fill:#2196F3
    style G fill:#FF9800
```

---

## æ¨¡æ¿å¤„ç†æœºåˆ¶

### æ¨¡æ¿å¼•æ“å·¥ä½œæµç¨‹

```mermaid
flowchart TD
    A[è¯»å–æ¨¡æ¿æ–‡ä»¶] --> B{æ¨¡æ¿ç±»å‹}

    B -->|é™æ€æ¨¡æ¿| C[.md.template]
    B -->|é…ç½®æ¨¡æ¿| D[.json.template]
    B -->|Hook æ¨¡æ¿| E[.py]

    C --> F[replacePlaceholders]
    D --> F
    E --> F

    F --> G{å ä½ç¬¦æ›¿æ¢}
    G -->|ç®€å•æ›¿æ¢| H["content.replace({{KEY}}, value)"]
    G -->|æ¡ä»¶æ¸²æŸ“| I["åˆ¤æ–­ businessType/æ¶æ„ç‰¹å¾"]

    H --> J[æ›¿æ¢åå†…å®¹]
    I --> J

    J --> K{ç›®æ ‡æ–‡ä»¶å­˜åœ¨?}
    K -->|å¦| L[ç›´æ¥å†™å…¥]
    K -->|æ˜¯| M{æ–‡ä»¶ç±»å‹}

    M -->|å‘½ä»¤æ–‡ä»¶| N[å¤‡ä»½ + è¦†ç›–]
    M -->|CLAUDE.md| O[æ™ºèƒ½åˆå¹¶]
    M -->|Hook æ–‡ä»¶| P[ç›´æ¥è¦†ç›–]

    L --> Q[å†™å…¥æ–‡ä»¶ç³»ç»Ÿ]
    N --> Q
    O --> Q
    P --> Q

    style A fill:#4CAF50
    style F fill:#FF9800
    style Q fill:#2196F3
```

---

## æ–‡æ¡£ç”Ÿæˆæµç¨‹

### ä¸‰å±‚æ–‡æ¡£æ¶æ„

```mermaid
flowchart TD
    A[DocumentGenerator.generateAll] --> B{minimalMode?}

    B -->|true æœ€å°åŒ–æ¨¡å¼| C[Layer 1: é€šç”¨å±‚]
    B -->|false å®Œæ•´æ¨¡å¼| D[Layer 1 + Layer 2 + Layer 3]

    C --> C1[_generateLayer1]
    C1 --> C11[ç”Ÿæˆå‘½ä»¤æ–‡ä»¶]
    C1 --> C12[éƒ¨ç½² v21.0 Hook æ–‡ä»¶]
    C1 --> C13[ç”Ÿæˆ CLAUDE.md]
    C1 --> C14[åˆ›å»ºè½¯è¿æ¥]
    C1 --> C15[ç”Ÿæˆç‰ˆæœ¬è¿½è¸ª]

    D --> D1[_generateLayer1]
    D1 --> D2[_generateLayer2]
    D2 --> D21[ç”Ÿæˆ Systems æ–‡æ¡£]
    D2 --> D22[æ™ºèƒ½æ–‡æ¡£ç»´æŠ¤]

    D2 --> D3[_generateLayer3]
    D3 --> D31[ç”Ÿæˆä¸šåŠ¡å±‚æ¡†æ¶]

    D3 --> D4[_generateTodoList]
    D4 --> D41[ç”Ÿæˆæ–‡æ¡£å¾…è¡¥å……æ¸…å•]

    C15 --> E[éƒ¨ç½²å®Œæˆ]
    D41 --> E

    style A fill:#4CAF50
    style C fill:#2196F3
    style D fill:#FF9800
    style E fill:#9C27B0
```

---

## è½¯è¿æ¥ç®¡ç†æœºåˆ¶

### è·¨å¹³å°è½¯è¿æ¥ç­–ç•¥

```mermaid
flowchart TD
    A[createSymlink] --> B{æ£€æŸ¥æºæ–‡ä»¶}
    B -->|ä¸å­˜åœ¨| C[è¿”å› failed]
    B -->|å­˜åœ¨| D{æ£€æŸ¥å¹³å°}

    D -->|Windows| E[å°è¯•åˆ›å»º Junction]
    D -->|Linux/Mac| F[å°è¯•åˆ›å»ºç¬¦å·é“¾æ¥]

    E --> G{åˆ›å»ºæˆåŠŸ?}
    F --> G

    G -->|æ˜¯| H[è¿”å› type: symlink]
    G -->|å¦| I[_createReadonlyCopy]

    I --> J[å¤åˆ¶æ–‡ä»¶/ç›®å½•]
    J --> K{æ˜¯ Markdown æ–‡ä»¶?}

    K -->|æ˜¯| L[_addReadonlyHeader]
    K -->|å¦| M[è·³è¿‡æ ‡è®°]

    L --> N[æ·»åŠ åªè¯»æç¤º]
    M --> O[è®¾ç½®åªè¯»æƒé™]
    N --> O

    O --> P[è¿”å› type: readonly-copy]

    style A fill:#4CAF50
    style G fill:#FF9800
    style I fill:#2196F3
    style P fill:#9C27B0
```

---

## å½’æ¡£æµç¨‹

### å®Œæ•´å½’æ¡£åºåˆ—å›¾ (v21.0)

```mermaid
sequenceDiagram
    autonumber

    participant AI as Claude AI
    participant Hook1 as PostToolUse Hook
    participant Script as generate-docs
    participant Agent as æ–‡æ¡£æ›´æ–° Agent
    participant Hook2 as PostArchive Hook
    participant TMM as TaskMetaManager
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    rect rgb(255, 245, 235)
        Note over AI,Hook1: é˜¶æ®µ1: æ­¥éª¤4å®Œæˆæ£€æµ‹
        AI->>TMM: atomic_update(mark_step4_complete)
        Note right of AI: æ ‡è®° step4_cleanup.status<br/>= "completed"

        TMM->>FS: åŸå­æ›´æ–° task-meta.json
        FS-->>Hook1: PostToolUse è§¦å‘
        Hook1->>TMM: load_task_meta(task_id)
        Hook1->>Hook1: æ£€æµ‹ step4_cleanup å®Œæˆ
    end

    rect rgb(232, 245, 233)
        Note over Hook1,Script: é˜¶æ®µ2: ä»ä¼šè¯å†å²ç”Ÿæˆå½’æ¡£æ–‡æ¡£
        Hook1->>Script: è°ƒç”¨ generate-docs-from-conversation.py
        Script->>FS: è¯»å– .conversation.jsonl
        Script->>Script: æå–é—®é¢˜æè¿°ã€åˆ†æè¿‡ç¨‹
        Script->>Script: æå–ä»£ç ä¿®æ”¹ã€ç”¨æˆ·åé¦ˆ
        Script->>FS: å†™å…¥ context.md
        Script->>FS: å†™å…¥ solution.md
        Script-->>Hook1: âœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ
    end

    rect rgb(227, 242, 253)
        Note over Hook1,Agent: é˜¶æ®µ3: å¯åŠ¨æ–‡æ¡£æ›´æ–° Agent
        Hook1-->>AI: æ³¨å…¥å­ä»£ç†å¯åŠ¨æŒ‡ä»¤
        AI->>Agent: å¯åŠ¨ Task Agent

        Agent->>FS: Glob("markdown/**/*.md")
        Note right of Agent: æœç´¢å¾…è¡¥å……æ ‡è®°

        Agent->>FS: Read(ç›¸å…³æ–‡æ¡£)
        Agent->>FS: Edit/Write(æ›´æ–°æ–‡æ¡£)

        Agent->>TMM: atomic_update(final_mark)
        Note right of Agent: æœ€ç»ˆæ ‡è®° step4 completed
    end

    rect rgb(248, 231, 253)
        Note over Hook2,FS: é˜¶æ®µ4: ä»»åŠ¡ç›®å½•å½’æ¡£
        FS-->>Hook2: PostToolUse è§¦å‘
        Hook2->>TMM: get_active_task_id()
        Hook2->>TMM: load_task_meta(task_id)

        Hook2->>Hook2: check_if_just_completed()
        Note right of Hook2: æ£€æŸ¥:<br/>- step4 = completed?<br/>- archived = false?

        alt éœ€è¦å½’æ¡£
            Hook2->>Hook2: acquire_archive_lock()
            Note right of Hook2: è·å– .archive-lock<br/>é˜²æ­¢å¹¶å‘é—®é¢˜

            Hook2->>FS: generate_doc_snapshot()
            Note right of Hook2: ä¿å­˜å½’æ¡£å‰æ–‡æ¡£çŠ¶æ€<br/>.doc-snapshot.json

            Hook2->>FS: ç§»åŠ¨ç›®å½•
            Note right of Hook2: tasks/xxx/<br/>â†’ tasks/å·²å½’æ¡£/xxx/

            Hook2->>TMM: atomic_update(mark_archived)
            Note right of Hook2: archived=true<br/>archived_at=now

            Hook2-->>AI: æ³¨å…¥æ–‡æ¡£åŒæ­¥ä»»åŠ¡
            Note right of AI: å¯åŠ¨ç¬¬äºŒä¸ªå­ä»£ç†<br/>åˆ†æå½’æ¡£ä»»åŠ¡<br/>åˆ›å»º/æ›´æ–°markdownæ–‡æ¡£

            Hook2->>Hook2: release_archive_lock()
        else æ— éœ€å½’æ¡£
            Hook2-->>AI: è·³è¿‡
        end
    end

    rect rgb(255, 249, 196)
        Note over AI,FS: é˜¶æ®µ5: æ–‡æ¡£åŒæ­¥ (ç¬¬äºŒä¸ªå­ä»£ç†)
        AI->>Agent: å¯åŠ¨æ–‡æ¡£åŒæ­¥ Agent

        Agent->>FS: Read(context.md + solution.md)
        Agent->>Agent: åˆ†æä»»åŠ¡å½±å“èŒƒå›´

        Agent->>FS: Glob("markdown/**/*.md")

        alt å­˜åœ¨ç›¸å…³æ–‡æ¡£ (â‰¤2ä¸ª)
            Agent->>FS: Edit(æ›´æ–°ç°æœ‰æ–‡æ¡£)
        else æ— ç›¸å…³æ–‡æ¡£
            Agent->>FS: Write(åˆ›å»ºæ–°æ–‡æ¡£)
        end

        Agent-->>AI: è¾“å‡ºå®ŒæˆæŠ¥å‘Š
    end
```

---

## æ•°æ®æ¨¡å‹å®šä¹‰

### TaskMeta å®Œæ•´æ•°æ®ç»“æ„ (v21.0)

```javascript
// tasks/{task_id}/.task-meta.json
{
  // ===== v21.0æ ¸å¿ƒå­—æ®µ =====
  "architecture_version": "21.0",  // âœ¨ v21.0ç‰ˆæœ¬æ ‡è®°

  "task_id": "20251115-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "task_type": "bug_fix",  // "feature" | "bug_fix" | "refactor" | "general"
  "task_complexity": "standard",  // "simple" | "standard" | "complex"
  "created_at": "2025-11-15T14:35:20.123Z",
  "updated_at": "2025-11-15T14:45:30.456Z",

  // ===== å½’æ¡£çŠ¶æ€ =====
  "archived": false,  // true after moved to å·²å½’æ¡£/
  "archived_at": null,  // ISO timestamp when archived

  // ===== å·¥ä½œæµçŠ¶æ€ï¼ˆv21.0ï¼šç›´æ¥åœ¨é¡¶å±‚ï¼Œåˆ é™¤workflow_stateåµŒå¥—ï¼‰=====
  "current_step": "step3_execute",
  "last_injection_step": "step3_execute",

  "steps": {
    "step0_context": {
      "description": "é˜…è¯»é¡¹ç›®CLAUDE.md",
      "status": "skipped",  // "pending" | "in_progress" | "completed" | "skipped"
      "prompt": "ï¼ˆç©æ³•åŒ…æ¨¡å¼ï¼šå·²è·³è¿‡ï¼‰"
    },
    "step1_understand": {
      "description": "ç†è§£ä»»åŠ¡éœ€æ±‚",
      "status": "skipped"
    },
    "step3_execute": {
      "description": "æ‰§è¡Œå®æ–½",
      "status": "in_progress",
      "started_at": "2025-11-15T14:35:20.123Z",
      "user_confirmed": false,
      "last_error": null,
      "last_error_time": null,
      "last_test_reminder_at": null,
      "prompt": "åŸºäºç©æ³•åŒ…ä»£ç å®ç°åŠŸèƒ½ï¼Œæµ‹è¯•éªŒè¯ï¼Œç›´åˆ°ç”¨æˆ·ç¡®è®¤ä¿®å¤å®Œæˆã€‚"
    },
    "step4_cleanup": {
      "description": "æ”¶å°¾å½’æ¡£",
      "status": "pending",
      "prompt": "æ¸…ç†DEBUGä»£ç ï¼Œæ›´æ–°æ–‡æ¡£ï¼Œå½’æ¡£ä»»åŠ¡ã€‚"
    }
  },

  // ===== BUGä¿®å¤è¿½è¸ª =====
  "bug_fix_tracking": {
    "enabled": true,
    "bug_description": "ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
    "iterations": [
      {
        "iteration_id": 1,
        "timestamp": "2025-11-15T14:36:10.123Z",
        "user_feedback": "æŠ¥é”™äº†ï¼šAttributeError",
        "feedback_sentiment": "negative",
        "changes_made": [
          {
            "file": "scripts/ShopServerSystem.py",
            "change_summary": "æ·»åŠ ç©ºå€¼æ£€æŸ¥"
          }
        ]
      }
    ],
    "loop_indicators": {
      "same_file_edit_count": 3,
      "failed_test_count": 0,
      "negative_feedback_count": 1,
      "consecutive_failures": 0,
      "time_spent_minutes": 10
    },
    "expert_triggered": false
  },

  // ===== ç©æ³•åŒ…åŒ¹é… =====
  "gameplay_pack_matched": null,
  "gameplay_pack_name": null,

  // ===== ä»»åŠ¡åº¦é‡æŒ‡æ ‡ =====
  "metrics": {
    "docs_read": [
      ".claude/core-docs/æ ¸å¿ƒå·¥ä½œæµæ–‡æ¡£/å¼€å‘è§„èŒƒ.md",
      "markdown/systems/å•†åº—ç³»ç»Ÿ.md"
    ],
    "docs_read_count": 2,

    "code_changes": [
      {
        "file": "scripts/ShopServerSystem.py",
        "timestamp": "2025-11-15T14:36:10.123Z",
        "operation": "Edit",
        "status": "success"
      }
    ],
    "code_changes_count": 1,
    "consecutive_failures": 0,

    "failure_count": 0,
    "failures": [],

    "expert_review_triggered": false,
    "expert_triggered_at": null,

    "critical_violation_count": 0
  },

  // ===== æŠ€æœ¯å†³ç­–è®°å½• =====
  "technical_decisions": [
    {
      "decision": "æ·»åŠ ç©ºå€¼æ£€æŸ¥",
      "reason": "é˜²æ­¢å•†å“æ•°æ®ä¸ºNoneæ—¶å´©æºƒ",
      "reference": "CRITICALè§„èŒƒ-å¼‚å¸¸å¤„ç†",
      "timestamp": "2025-11-15T14:36:10.123Z"
    }
  ]
}
```

### TaskActive æ´»è·ƒæ ‡å¿— (v21.0)

```javascript
// .claude/.task-active.json
{
  "task_id": "20251115-143520-ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½",
  "created_at": "2025-11-15T14:35:20.123Z"
}
```

**æ¶æ„å˜æ›´**:
- âŒ åˆ é™¤: `task_dir` (æ”¹ç”¨ TaskMetaManager.get_task_dir(task_id))
- âŒ åˆ é™¤: `current_step` (ä» task-meta.json è¯»å–)
- âŒ åˆ é™¤: `updated_at` (ä» task-meta.json è¯»å–)

### ConversationHistory ä¼šè¯å†å²

```jsonlines
// tasks/{task_id}/.conversation.jsonl (JSON Lines æ ¼å¼)
{"timestamp": "2025-11-15T14:35:20.123Z", "role": "user", "content": "/mc ä¿®å¤å•†åº—è´­ä¹°åŠŸèƒ½", "event_type": "task_init"}
{"timestamp": "2025-11-15T14:35:30.789Z", "role": "tool", "tool_name": "Read", "tool_input": {"file_path": "markdown/systems/å•†åº—ç³»ç»Ÿ.md"}, "event_type": "tool_call"}
{"timestamp": "2025-11-15T14:36:15.678Z", "role": "user", "content": "æŠ¥é”™äº†ï¼šAttributeError", "event_type": "feedback", "sentiment": "negative"}
```

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| **v4.0** | **2025-11-15** | **v21.0é‡å¤§æ›´æ–°ï¼šå•ä¸€æ•°æ®æºæ¶æ„** |
| | | - åˆ é™¤ workflow-state.json ç›¸å…³æ‰€æœ‰å†…å®¹ |
| | | - æ›´æ–°ä¸ºäºŒæ–‡ä»¶æ¶æ„ï¼ˆtask-meta.json + task-active.jsonï¼‰ |
| | | - æ–°å¢ TaskMetaManager åŸå­æ›´æ–°æœºåˆ¶ |
| | | - æ–°å¢æ–‡ä»¶é”å¹¶å‘å®‰å…¨ä¿è¯ |
| | | - æ›´æ–°æ‰€æœ‰æ•°æ®æµå›¾åæ˜ v21.0æ¶æ„ |
| | | - é€‚ç”¨ç‰ˆæœ¬ï¼šv21.0.0+ |
| v3.0 | 2025-11-14 | é‡å¤§æ›´æ–°ï¼šæ–°å¢ä»»åŠ¡æ‰§è¡Œæ•°æ®æµã€ä¸‰æ–‡ä»¶åŒæ­¥æœºåˆ¶ã€ä¼šè¯å†å²æŒä¹…åŒ–ã€å½’æ¡£æµç¨‹ |
| v2.0 | 2025-11-13 | æ–°å¢ SessionStart Hook æ•°æ®æµï¼Œä»»åŠ¡çŠ¶æ€æœºå‡çº§ä¸º v2.0.3 æ ¼å¼ |
| v4.0 | 2025-11-15 | v21.1.2æ¶æ„æ–‡æ¡£ |

---

## ç›¸å…³æ–‡æ¡£

- [HookçŠ¶æ€æœºæœºåˆ¶](./HookçŠ¶æ€æœºæœºåˆ¶.md) - Hook ç³»ç»Ÿè¯¦ç»†è®¾è®¡ï¼ˆv21.0ï¼‰
- [task-meta.jsonæ–‡ä»¶ç»“æ„](./task-meta.jsonæ–‡ä»¶ç»“æ„.md) - ä»»åŠ¡å…ƒæ•°æ®æ–‡ä»¶å®Œæ•´è¯´æ˜ï¼ˆv21.0ï¼‰
- [æŠ€æœ¯æ¶æ„](./æŠ€æœ¯æ¶æ„.md) - ç³»ç»Ÿæ•´ä½“æ¶æ„
- [å¿«é€Ÿä¸Šæ‰‹](./å¿«é€Ÿä¸Šæ‰‹.md) - ä½¿ç”¨æŒ‡å—
- [CHANGELOG.md](../../CHANGELOG.md) - ç‰ˆæœ¬æ›´æ–°è®°å½•

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code Development Team
**æœ€åå®¡æ ¸**: 2025-11-15
**é€‚ç”¨ç‰ˆæœ¬**: v21.0.0+
