# ç‰ˆæœ¬ç®¡ç† (VersionChecker)

> æ¨¡å—è·¯å¾„: `lib/version-checker.js`
> ç‰ˆæœ¬: v1.0 (å·¥ä½œæµç‰ˆæœ¬æ£€æµ‹ä¸ç®¡ç†)
> æœ€åæ›´æ–°: 2025-11-13

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

`VersionChecker` æ˜¯ MODSDK å¼€å‘å·¥ä½œæµçš„ç‰ˆæœ¬ç®¡ç†å¼•æ“ï¼Œè´Ÿè´£æ£€æµ‹å·¥ä½œæµç‰ˆæœ¬ã€æ¯”è¾ƒæ›´æ–°ã€è®¡ç®—æ–‡ä»¶å“ˆå¸Œã€æ£€æµ‹è¦†ç›–å±‚æ–‡ä»¶å†²çªã€‚è¯¥æ¨¡å—ç¡®ä¿ä¸Šæ¸¸å·¥ä½œæµæ›´æ–°æ—¶ï¼Œä¸‹æ¸¸é¡¹ç›®èƒ½å¤Ÿå®‰å…¨åœ°åŒæ­¥ï¼ŒåŒæ—¶ä¿æŠ¤ç”¨æˆ·çš„è‡ªå®šä¹‰ä¿®æ”¹ã€‚

### ä¸»è¦èŒè´£

1. **ç‰ˆæœ¬æ£€æµ‹**: æ¯”è¾ƒæœ¬åœ°å·¥ä½œæµç‰ˆæœ¬ä¸ä¸Šæ¸¸ç‰ˆæœ¬
2. **æ›´æ–°æ£€æŸ¥**: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œæä¾›æ›´æ–°æ—¥å¿—
3. **æ–‡ä»¶å“ˆå¸Œè®¡ç®—**: è®¡ç®—ä¸Šæ¸¸åŸºçº¿æ–‡ä»¶çš„SHA256å“ˆå¸Œå€¼
4. **è¦†ç›–å±‚å†²çªæ£€æµ‹**: æ£€æµ‹ç”¨æˆ·ä¿®æ”¹çš„è¦†ç›–å±‚æ–‡ä»¶ä¸ä¸Šæ¸¸æ›´æ–°çš„å†²çª
5. **åºŸå¼ƒæ–‡ä»¶æ£€æµ‹**: è¯†åˆ«ç‰ˆæœ¬å‡çº§åä¸å†éœ€è¦çš„æ–‡ä»¶
6. **Manifestç®¡ç†**: è¯»å†™ `workflow-manifest.json` å…ƒæ•°æ®æ–‡ä»¶

---

## ğŸ—ï¸ æ ¸å¿ƒç±»ä¸æ–¹æ³•

### VersionChecker (ä¸»æ£€æµ‹å™¨)

#### æ„é€ å‡½æ•°
```javascript
constructor(upstreamPath, downstreamPath)
```
- **å‚æ•°**:
  - `upstreamPath` - ä¸Šæ¸¸å·¥ä½œæµä»“åº“è·¯å¾„ï¼ˆå¦‚ `D:/EcWork/åŸºäºClaudeçš„MODSDKå¼€å‘å·¥ä½œæµ`ï¼‰
  - `downstreamPath` - ä¸‹æ¸¸é¡¹ç›®è·¯å¾„ï¼ˆå¦‚ `D:/MyProject`ï¼‰
- **åˆå§‹åŒ–**:
  - `this.upstreamPath` - ä¸Šæ¸¸è·¯å¾„
  - `this.downstreamPath` - ä¸‹æ¸¸è·¯å¾„
  - `this.manifestPath` - Manifestæ–‡ä»¶è·¯å¾„ï¼ˆ`.claude/workflow-manifest.json`ï¼‰

---

### ç‰ˆæœ¬æ£€æµ‹æ–¹æ³•

#### checkVersion() - æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
```javascript
checkVersion()
```
- **è¿”å›å€¼**:
  ```javascript
  {
    needsUpdate: Boolean,    // æ˜¯å¦éœ€è¦æ›´æ–°
    local: String,           // æœ¬åœ°ç‰ˆæœ¬å·ï¼ˆå¦‚ '15.1.0'ï¼‰
    upstream: String,        // ä¸Šæ¸¸ç‰ˆæœ¬å·ï¼ˆå¦‚ '18.2.0'ï¼‰
    changelog: String|null   // æ›´æ–°æ—¥å¿—ï¼ˆå¦‚æœéœ€è¦æ›´æ–°ï¼‰
  }
  ```

**ç¤ºä¾‹**:
```javascript
const checker = new VersionChecker(upstreamPath, projectPath);
const check = checker.checkVersion();

if (check.needsUpdate) {
  console.log(`æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: v${check.upstream}`);
  console.log(check.changelog);
  console.log('æ‰§è¡Œ initmc --sync æ›´æ–°');
} else {
  console.log('å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
}
```

---

#### getLocalVersion() - è·å–æœ¬åœ°ç‰ˆæœ¬
```javascript
getLocalVersion()
```
- **è¿”å›å€¼**: `String` - ç‰ˆæœ¬å·ï¼ˆå¦‚ `'18.2.0'`ï¼‰
- **æ£€æµ‹é€»è¾‘**:
  1. ä¼˜å…ˆæ£€æŸ¥ `.claude/workflow-version.json`ï¼ˆv15.xçš„ç‰ˆæœ¬æ–‡ä»¶ï¼‰
  2. é™çº§æ£€æŸ¥ `.claude/workflow-manifest.json`ï¼ˆv16.0+çš„ç‰ˆæœ¬æ–‡ä»¶ï¼‰
  3. å¦‚æœéƒ½ä¸å­˜åœ¨ï¼Œè¿”å› `'0.0.0'`ï¼ˆå…¨æ–°é¡¹ç›®ï¼‰

**ç‰ˆæœ¬æ ¼å¼æ ‡å‡†åŒ–**:
```javascript
// v15.xä½¿ç”¨ "15.0" æ ¼å¼ï¼Œéœ€è¦æ ‡å‡†åŒ–ä¸º "15.0.0"
if (version && !version.includes('.', version.indexOf('.') + 1)) {
  return version + '.0';
}
```

---

#### getUpstreamVersion() - è·å–ä¸Šæ¸¸ç‰ˆæœ¬
```javascript
getUpstreamVersion()
```
- **è¿”å›å€¼**: `String` - ç‰ˆæœ¬å·ï¼ˆå¦‚ `'18.2.0'`ï¼‰
- **è¯»å–ä½ç½®**: ä¸Šæ¸¸ `package.json` çš„ `version` å­—æ®µ

---

#### _compareVersions(v1, v2) - æ¯”è¾ƒç‰ˆæœ¬å·
```javascript
_compareVersions(v1, v2)
```
- **å‚æ•°**:
  - `v1` - ç‰ˆæœ¬1ï¼ˆå¦‚ `'15.1.0'`ï¼‰
  - `v2` - ç‰ˆæœ¬2ï¼ˆå¦‚ `'18.2.0'`ï¼‰
- **è¿”å›å€¼**:
  - `-1` - v1 < v2ï¼ˆéœ€è¦æ›´æ–°ï¼‰
  - `0` - v1 == v2ï¼ˆç›¸åŒç‰ˆæœ¬ï¼‰
  - `1` - v1 > v2ï¼ˆv1æ›´æ–°ï¼‰

**æ¯”è¾ƒé€»è¾‘**:
```javascript
// æŒ‰ç‚¹å·åˆ†å‰²ç‰ˆæœ¬å·ï¼Œé€æ®µæ¯”è¾ƒ
const parts1 = v1.split('.').map(Number);  // [15, 1, 0]
const parts2 = v2.split('.').map(Number);  // [18, 2, 0]

for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
  const p1 = parts1[i] || 0;
  const p2 = parts2[i] || 0;

  if (p1 < p2) return -1;
  if (p1 > p2) return 1;
}

return 0;
```

---

#### _getChangelog(fromVersion, toVersion) - è·å–æ›´æ–°æ—¥å¿—
```javascript
_getChangelog(fromVersion, toVersion)
```
- **è¿”å›å€¼**: `String` - Markdownæ ¼å¼çš„æ›´æ–°æ—¥å¿—

**ç¤ºä¾‹**:
```javascript
const changelog = checker._getChangelog('15.1.0', '16.0.0');

// è¿”å›:
// ğŸ“‹ v16.0.0 æ›´æ–°å†…å®¹:
//
// âœ¨ **æ ¸å¿ƒç‰¹æ€§**:
// - åŒå±‚æ–‡æ¡£æ¶æ„: ä¸Šæ¸¸åŸºçº¿ + é¡¹ç›®è¦†ç›–å±‚
// - è‡ªåŠ¨åŒæ­¥: initmc --sync ä¸€é”®æ›´æ–°
// ...
```

---

### Manifestç®¡ç†

#### readManifest() - è¯»å–Manifest
```javascript
readManifest()
```
- **è¿”å›å€¼**: Manifestå¯¹è±¡
  ```javascript
  {
    version: '18.2.0',
    installedAt: '2025-11-13T10:30:00.000Z',
    updatedAt: '2025-11-13T10:30:00.000Z',
    baselineHashes: {
      'å¼€å‘è§„èŒƒ.md': 'abc123...',
      'é—®é¢˜æ’æŸ¥.md': 'def456...'
    },
    obsoleteFiles: []
  }
  ```

---

#### writeManifest(data) - å†™å…¥Manifest
```javascript
writeManifest(data)
```
- **å‚æ•°**: `data` - è¦å†™å…¥çš„æ•°æ®ï¼ˆä¼šåˆå¹¶åˆ°ç°æœ‰Manifestï¼‰
- **è¿”å›å€¼**: æ›´æ–°åçš„å®Œæ•´Manifestå¯¹è±¡

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const checker = new VersionChecker(upstreamPath, projectPath);

// å†™å…¥ç‰ˆæœ¬ä¿¡æ¯
checker.writeManifest({
  version: '18.2.0',
  baselineHashes: checker.computeBaselineHashes(),
  installedAt: new Date().toISOString()
});
```

---

#### _createDefaultManifest() - åˆ›å»ºé»˜è®¤Manifest
```javascript
_createDefaultManifest()
```
- **è¿”å›å€¼**: é»˜è®¤Manifestå¯¹è±¡
  ```javascript
  {
    version: '15.1.0',
    createdAt: '2025-11-13T10:30:00.000Z',
    baselineHashes: {},
    obsoleteFiles: []
  }
  ```

---

### æ–‡ä»¶å“ˆå¸Œè®¡ç®—

#### computeBaselineHashes() - è®¡ç®—åŸºçº¿æ–‡ä»¶å“ˆå¸Œ
```javascript
computeBaselineHashes()
```
- **è¿”å›å€¼**: å“ˆå¸Œå€¼æ˜ å°„å¯¹è±¡ `{ filename: hash }`
- **è®¡ç®—èŒƒå›´**: ä¸Šæ¸¸æ ¸å¿ƒæ–‡æ¡£æ–‡ä»¶

**æ ¸å¿ƒæ–‡ä»¶åˆ—è¡¨**:
```javascript
const coreFiles = [
  'å¼€å‘è§„èŒƒ.md',
  'é—®é¢˜æ’æŸ¥.md',
  'å¿«é€Ÿå¼€å§‹.md',
  'MODSDKæ ¸å¿ƒæ¦‚å¿µ.md',
  'APIé€ŸæŸ¥.md',
  'å®˜æ–¹æ–‡æ¡£æŸ¥è¯¢æŒ‡å—.md',
  'è¿ç§»æŒ‡å—-v15.0.md'
];
```

**è¿”å›ç¤ºä¾‹**:
```javascript
{
  'å¼€å‘è§„èŒƒ.md': 'abc123def456...',
  'é—®é¢˜æ’æŸ¥.md': 'def456abc123...',
  'å¿«é€Ÿå¼€å§‹.md': 'ghi789jkl012...'
}
```

---

#### getFileHash(filePath) - è®¡ç®—å•ä¸ªæ–‡ä»¶å“ˆå¸Œ
```javascript
getFileHash(filePath)
```
- **å‚æ•°**: `filePath` - æ–‡ä»¶ç»å¯¹è·¯å¾„
- **è¿”å›å€¼**: `String` - SHA256å“ˆå¸Œå€¼ï¼ˆ64ä½åå…­è¿›åˆ¶ï¼‰

**å®ç°**:
```javascript
const content = fs.readFileSync(filePath);
return crypto.createHash('sha256').update(content).digest('hex');
```

---

#### isFileCustomized(filePath, baselineHash) - æ£€æµ‹æ–‡ä»¶æ˜¯å¦è¢«å®šåˆ¶
```javascript
isFileCustomized(filePath, baselineHash)
```
- **å‚æ•°**:
  - `filePath` - æ–‡ä»¶ç»å¯¹è·¯å¾„
  - `baselineHash` - åŸºçº¿å“ˆå¸Œå€¼ï¼ˆä»Manifestè¯»å–ï¼‰
- **è¿”å›å€¼**:
  - `true` - æ–‡ä»¶å·²è¢«ç”¨æˆ·å®šåˆ¶
  - `false` - æ–‡ä»¶æœªä¿®æ”¹æˆ–ä¸å­˜åœ¨

**ä½¿ç”¨åœºæ™¯**:
```javascript
const manifest = checker.readManifest();
const baselineHash = manifest.baselineHashes['å¼€å‘è§„èŒƒ.md'];
const filePath = path.join(projectPath, 'markdown/core/å¼€å‘è§„èŒƒ.md');

if (checker.isFileCustomized(filePath, baselineHash)) {
  console.log('âš ï¸ æ–‡ä»¶å·²è¢«å®šåˆ¶ï¼Œéœ€è¦æ‰‹åŠ¨åˆå¹¶');
} else {
  console.log('âœ… æ–‡ä»¶æœªä¿®æ”¹ï¼Œå¯ä»¥å®‰å…¨è¦†ç›–');
}
```

---

### åºŸå¼ƒæ–‡ä»¶æ£€æµ‹

#### detectObsoleteFiles(fromVersion, toVersion) - æ£€æµ‹åºŸå¼ƒæ–‡ä»¶
```javascript
detectObsoleteFiles(fromVersion, toVersion)
```
- **å‚æ•°**:
  - `fromVersion` - èµ·å§‹ç‰ˆæœ¬ï¼ˆå¦‚ `'15.1.0'`ï¼‰
  - `toVersion` - ç›®æ ‡ç‰ˆæœ¬ï¼ˆå¦‚ `'16.0.0'`ï¼‰
- **è¿”å›å€¼**: `Array<String>` - åºŸå¼ƒæ–‡ä»¶è·¯å¾„åˆ—è¡¨

**æ£€æµ‹è§„åˆ™**ï¼ˆæŒ‰ç‰ˆæœ¬ï¼‰:

**v16.0 åºŸå¼ƒæ–‡ä»¶**:
```javascript
// ä» v15.x å‡çº§åˆ° v16.0 æ—¶ï¼Œä»¥ä¸‹æ–‡ä»¶è¢«åºŸå¼ƒ
const v16CoreFiles = [
  'markdown/å¼€å‘è§„èŒƒ.md',
  'markdown/é—®é¢˜æ’æŸ¥.md',
  'markdown/å¿«é€Ÿå¼€å§‹.md',
  'markdown/MODSDKæ ¸å¿ƒæ¦‚å¿µ.md',
  'markdown/APIé€ŸæŸ¥.md',
  'markdown/å®˜æ–¹æ–‡æ¡£æŸ¥è¯¢æŒ‡å—.md',
  'markdown/è¿ç§»æŒ‡å—-v15.0.md',
  'markdown/AIç­–ç•¥æ–‡æ¡£'  // ç›®å½•
];
```

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const obsolete = checker.detectObsoleteFiles('15.1.0', '16.0.0');

console.log('ä»¥ä¸‹æ–‡ä»¶å·²åºŸå¼ƒï¼Œéœ€è¦æ¸…ç†:');
obsolete.forEach(file => console.log(`  - ${file}`));
```

---

### è¦†ç›–å±‚å†²çªæ£€æµ‹

#### detectOverrideConflicts() - æ£€æµ‹è¦†ç›–å±‚æ–‡ä»¶å†²çª
```javascript
async detectOverrideConflicts()
```
- **è¿”å›å€¼**: `Array<Object>` - å†²çªåˆ—è¡¨
  ```javascript
  [
    {
      file: 'å¼€å‘è§„èŒƒ.md',
      overridePath: 'D:/MyProject/markdown/core/å¼€å‘è§„èŒƒ.md',
      upstreamPath: 'D:/Upstream/markdown/å¼€å‘è§„èŒƒ.md',
      oldBaselineHash: 'abc123...',
      newBaselineHash: 'def456...',
      description: 'ä¸Šæ¸¸æ–‡æ¡£æœ‰æ›´æ–°ï¼Œå»ºè®®å®¡æŸ¥å¹¶åˆå¹¶'
    }
  ]
  ```

**æ£€æµ‹é€»è¾‘**:
1. è¯»å–Manifestä¸­çš„åŸºçº¿å“ˆå¸Œå€¼ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
2. è®¡ç®—å½“å‰ä¸Šæ¸¸æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
3. éå†è¦†ç›–å±‚æ–‡ä»¶ï¼ˆ`markdown/core/`ï¼‰
4. å¦‚æœä¸Šæ¸¸æ–‡ä»¶æœ‰å˜åŒ–ï¼ˆ`oldHash !== newHash`ï¼‰ï¼Œè®°å½•ä¸ºå†²çª

**ä½¿ç”¨ç¤ºä¾‹**:
```javascript
const conflicts = await checker.detectOverrideConflicts();

if (conflicts.length > 0) {
  console.log('âš ï¸ æ£€æµ‹åˆ°è¦†ç›–å±‚å†²çª:');
  conflicts.forEach(conflict => {
    console.log(`  - ${conflict.file}`);
    console.log(`    è¦†ç›–å±‚: ${conflict.overridePath}`);
    console.log(`    ä¸Šæ¸¸: ${conflict.upstreamPath}`);
    console.log(`    è¯´æ˜: ${conflict.description}`);
  });
} else {
  console.log('âœ… æ— è¦†ç›–å±‚å†²çª');
}
```

---

### ç‰ˆæœ¬æŠ¥å‘Š

#### printVersionReport() - æ‰“å°ç‰ˆæœ¬æ£€æµ‹æŠ¥å‘Š
```javascript
printVersionReport()
```
- **åŠŸèƒ½**: åœ¨æ§åˆ¶å°è¾“å‡ºç¾åŒ–çš„ç‰ˆæœ¬æŠ¥å‘Š
- **è¿”å›å€¼**: ç‰ˆæœ¬æ£€æŸ¥ç»“æœå¯¹è±¡

**è¾“å‡ºç¤ºä¾‹**:
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š å·¥ä½œæµç‰ˆæœ¬æ£€æµ‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æœ¬åœ°ç‰ˆæœ¬: v15.1.0
ä¸Šæ¸¸ç‰ˆæœ¬: v18.2.0

âš ï¸ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼

ğŸ“‹ v16.0.0 æ›´æ–°å†…å®¹:

âœ¨ **æ ¸å¿ƒç‰¹æ€§**:
- åŒå±‚æ–‡æ¡£æ¶æ„: ä¸Šæ¸¸åŸºçº¿ + é¡¹ç›®è¦†ç›–å±‚
- è‡ªåŠ¨åŒæ­¥: initmc --sync ä¸€é”®æ›´æ–°
- æ™ºèƒ½æ¸…ç†: è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†åºŸå¼ƒæ–‡ä»¶
- è¦†ç›–å±‚æ”¯æŒ: markdown/core/ å®ç°é¡¹ç›®å®šåˆ¶

ğŸ”§ **æ¶æ„å˜æ›´**:
- ä¸Šæ¸¸æ–‡æ¡£ç§»è‡³ .claude/core-docs/ (è½¯è¿æ¥)
- æ”¯æŒéMODSDKé¡¹ç›®å®šåˆ¶åŒ–
- å®Œå…¨èŒè´£éš”ç¦» (å¤šé¡¹ç›®äº’ä¸å½±å“)

ğŸ“š **æ–‡æ¡£æ”¹è¿›**:
- æ–°å¢ markdown/README.md å¯¼èˆªæ–‡æ¡£
- AIæ™ºèƒ½æ–‡æ¡£è·¯ç”± (è¦†ç›–å±‚ä¼˜å…ˆ)
- è‡ªåŠ¨è¿ç§»v15.xé¡¹ç›®

âš ï¸ **ç ´åæ€§å˜æ›´**:
- markdown/ ç›®å½•ç»“æ„è°ƒæ•´
- éœ€è¦æ‰§è¡Œè¿ç§»è„šæœ¬ (è‡ªåŠ¨)

ğŸ’¡ æ‰§è¡Œ `initmc --sync` æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ç‰ˆæœ¬æ£€æµ‹
```javascript
const { VersionChecker } = require('./lib/version-checker');

const upstreamPath = 'D:/EcWork/åŸºäºClaudeçš„MODSDKå¼€å‘å·¥ä½œæµ';
const projectPath = 'D:/MyProject';

const checker = new VersionChecker(upstreamPath, projectPath);

// æ£€æŸ¥ç‰ˆæœ¬
const check = checker.checkVersion();

if (check.needsUpdate) {
  console.log(`ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬: v${check.upstream} (å½“å‰: v${check.local})`);
  console.log('\næ›´æ–°å†…å®¹:');
  console.log(check.changelog);
  console.log('\nğŸ’¡ æ‰§è¡Œ initmc --sync æ›´æ–°');
} else {
  console.log('âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
}
```

---

### ç¤ºä¾‹2: åŸºçº¿å“ˆå¸Œè®¡ç®—
```javascript
const checker = new VersionChecker(upstreamPath, projectPath);

// è®¡ç®—ä¸Šæ¸¸åŸºçº¿æ–‡ä»¶å“ˆå¸Œ
const baselineHashes = checker.computeBaselineHashes();

console.log('ä¸Šæ¸¸åŸºçº¿æ–‡ä»¶å“ˆå¸Œ:');
Object.entries(baselineHashes).forEach(([file, hash]) => {
  console.log(`  ${file}: ${hash.substring(0, 8)}...`);
});

// å†™å…¥Manifest
checker.writeManifest({
  version: '18.2.0',
  baselineHashes: baselineHashes,
  installedAt: new Date().toISOString()
});
```

---

### ç¤ºä¾‹3: è¦†ç›–å±‚å†²çªæ£€æµ‹
```javascript
const checker = new VersionChecker(upstreamPath, projectPath);

// æ£€æµ‹è¦†ç›–å±‚å†²çª
const conflicts = await checker.detectOverrideConflicts();

if (conflicts.length > 0) {
  console.log('âš ï¸ æ£€æµ‹åˆ°è¦†ç›–å±‚å†²çªï¼Œéœ€è¦æ‰‹åŠ¨åˆå¹¶:');
  conflicts.forEach(conflict => {
    console.log(`\næ–‡ä»¶: ${conflict.file}`);
    console.log(`è¦†ç›–å±‚: ${conflict.overridePath}`);
    console.log(`ä¸Šæ¸¸: ${conflict.upstreamPath}`);

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å®šåˆ¶
    const isCustomized = checker.isFileCustomized(
      conflict.overridePath,
      conflict.oldBaselineHash
    );

    if (isCustomized) {
      console.log('çŠ¶æ€: å·²å®šåˆ¶ï¼ˆéœ€è¦æ‰‹åŠ¨åˆå¹¶ï¼‰');
    } else {
      console.log('çŠ¶æ€: æœªå®šåˆ¶ï¼ˆå¯ä»¥å®‰å…¨è¦†ç›–ï¼‰');
    }
  });
} else {
  console.log('âœ… æ— è¦†ç›–å±‚å†²çª');
}
```

---

### ç¤ºä¾‹4: åºŸå¼ƒæ–‡ä»¶æ¸…ç†
```javascript
const checker = new VersionChecker(upstreamPath, projectPath);

const localVersion = checker.getLocalVersion();
const upstreamVersion = checker.getUpstreamVersion();

// æ£€æµ‹åºŸå¼ƒæ–‡ä»¶
const obsolete = checker.detectObsoleteFiles(localVersion, upstreamVersion);

if (obsolete.length > 0) {
  console.log('ğŸ§¹ æ£€æµ‹åˆ°åºŸå¼ƒæ–‡ä»¶:');
  obsolete.forEach(file => console.log(`  - ${file}`));

  // è¯¢é—®ç”¨æˆ·æ˜¯å¦æ¸…ç†
  console.log('\nâš ï¸ è¿™äº›æ–‡ä»¶åœ¨æ–°ç‰ˆæœ¬ä¸­å·²è¢«åºŸå¼ƒï¼Œå»ºè®®æ¸…ç†');
  console.log('æ‰§è¡Œ: initmc --sync --clean');
} else {
  console.log('âœ… æ— åºŸå¼ƒæ–‡ä»¶');
}
```

---

### ç¤ºä¾‹5: é›†æˆåˆ°initmcå‘½ä»¤
```javascript
// scripts/initmc.js

const checker = new VersionChecker(upstreamPath, projectPath);

// æ‰“å°ç‰ˆæœ¬æŠ¥å‘Š
const check = checker.printVersionReport();

if (check.needsUpdate) {
  // è¯¢é—®ç”¨æˆ·æ˜¯å¦æ›´æ–°
  const shouldUpdate = await askUser('æ˜¯å¦æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬? (y/n)');

  if (shouldUpdate) {
    // æ£€æµ‹è¦†ç›–å±‚å†²çª
    const conflicts = await checker.detectOverrideConflicts();

    if (conflicts.length > 0) {
      console.log('âš ï¸ æ£€æµ‹åˆ°è¦†ç›–å±‚å†²çª:');
      conflicts.forEach(conflict => {
        console.log(`  - ${conflict.file}`);
      });

      const shouldContinue = await askUser('æ˜¯å¦ç»§ç»­æ›´æ–°? (y/n)');
      if (!shouldContinue) {
        console.log('âŒ å–æ¶ˆæ›´æ–°');
        return;
      }
    }

    // æ‰§è¡Œæ›´æ–°
    await updateWorkflow();

    // æ›´æ–°Manifest
    checker.writeManifest({
      version: check.upstream,
      baselineHashes: checker.computeBaselineHashes(),
      updatedAt: new Date().toISOString()
    });

    console.log('âœ… æ›´æ–°å®Œæˆï¼');
  }
}
```

---

## ğŸ“Š å·¥ä½œæµç¨‹å›¾

### ç‰ˆæœ¬æ£€æµ‹æµç¨‹

```mermaid
graph TB
    Start[å¼€å§‹æ£€æµ‹] --> GetLocal[è·å–æœ¬åœ°ç‰ˆæœ¬]

    GetLocal --> CheckVersionFile{æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶}
    CheckVersionFile -->|workflow-version.json| ReadV15[è¯»å–v15æ ¼å¼]
    CheckVersionFile -->|workflow-manifest.json| ReadV16[è¯»å–v16æ ¼å¼]
    CheckVersionFile -->|éƒ½ä¸å­˜åœ¨| SetNew[è®¾ç½®ä¸º0.0.0]

    ReadV15 --> Normalize[æ ‡å‡†åŒ–ç‰ˆæœ¬å·]
    ReadV16 --> Normalize
    SetNew --> Normalize

    Normalize --> GetUpstream[è·å–ä¸Šæ¸¸ç‰ˆæœ¬]
    GetUpstream --> ReadPackage[è¯»å–package.json]

    ReadPackage --> Compare[æ¯”è¾ƒç‰ˆæœ¬å·]
    Compare --> Split1[åˆ†å‰²v1]
    Compare --> Split2[åˆ†å‰²v2]

    Split1 --> LoopCompare[é€æ®µæ¯”è¾ƒ]
    Split2 --> LoopCompare

    LoopCompare --> CheckDiff{ç‰ˆæœ¬ä¸åŒ?}
    CheckDiff -->|v1 < v2| NeedsUpdate[éœ€è¦æ›´æ–°]
    CheckDiff -->|v1 == v2| UpToDate[å·²æ˜¯æœ€æ–°]
    CheckDiff -->|v1 > v2| Ahead[é¢†å…ˆä¸Šæ¸¸]

    NeedsUpdate --> GetChangelog[è·å–æ›´æ–°æ—¥å¿—]
    GetChangelog --> BuildResult[æ„å»ºç»“æœå¯¹è±¡]

    UpToDate --> BuildResult
    Ahead --> BuildResult

    BuildResult --> End[è¿”å›ç»“æœ]

    style Start fill:#90EE90
    style End fill:#90EE90
    style NeedsUpdate fill:#FFD700
    style UpToDate fill:#87CEEB
```

### è¦†ç›–å±‚å†²çªæ£€æµ‹æµç¨‹

```mermaid
graph TB
    Start[å¼€å§‹æ£€æµ‹] --> ReadManifest[è¯»å–Manifest]
    ReadManifest --> GetOldHashes[è·å–æ—§åŸºçº¿å“ˆå¸Œ]

    GetOldHashes --> ComputeNew[è®¡ç®—æ–°åŸºçº¿å“ˆå¸Œ]
    ComputeNew --> CheckOverride{è¦†ç›–å±‚ç›®å½•å­˜åœ¨?}

    CheckOverride -->|å¦| NoConflicts[æ— å†²çª]
    CheckOverride -->|æ˜¯| ScanOverride[æ‰«æè¦†ç›–å±‚æ–‡ä»¶]

    ScanOverride --> LoopFiles[éå†æ¯ä¸ªæ–‡ä»¶]
    LoopFiles --> GetFileHash[è·å–æ–‡ä»¶å“ˆå¸Œ]

    GetFileHash --> Compare{å“ˆå¸Œå€¼å˜åŒ–?}
    Compare -->|å¦| NextFile
    Compare -->|æ˜¯| RecordConflict[è®°å½•å†²çª]

    RecordConflict --> CheckCustom{æ–‡ä»¶è¢«å®šåˆ¶?}
    CheckCustom -->|æ˜¯| MarkManual[æ ‡è®°éœ€è¦æ‰‹åŠ¨åˆå¹¶]
    CheckCustom -->|å¦| MarkAuto[æ ‡è®°å¯è‡ªåŠ¨è¦†ç›–]

    MarkManual --> NextFile{æ›´å¤šæ–‡ä»¶?}
    MarkAuto --> NextFile

    NextFile -->|æ˜¯| LoopFiles
    NextFile -->|å¦| BuildReport[æ„å»ºå†²çªæŠ¥å‘Š]

    NoConflicts --> End[è¿”å›ç»“æœ]
    BuildReport --> End

    style Start fill:#90EE90
    style End fill:#90EE90
    style RecordConflict fill:#FFD700
    style MarkManual fill:#FF6B6B
    style MarkAuto fill:#87CEEB
```

### æ–‡ä»¶å“ˆå¸Œè®¡ç®—æµç¨‹

```mermaid
graph TB
    Start[è¾“å…¥: æ–‡ä»¶è·¯å¾„] --> ReadFile[è¯»å–æ–‡ä»¶å†…å®¹]

    ReadFile --> CheckExists{æ–‡ä»¶å­˜åœ¨?}
    CheckExists -->|å¦| ReturnNull[è¿”å›null]
    CheckExists -->|æ˜¯| CreateHash[åˆ›å»ºSHA256å“ˆå¸Œ]

    CreateHash --> UpdateHash[æ›´æ–°å“ˆå¸Œå†…å®¹]
    UpdateHash --> DigestHash[ç”Ÿæˆåå…­è¿›åˆ¶æ‘˜è¦]

    DigestHash --> Return[è¿”å›64ä½å“ˆå¸Œå€¼]

    ReturnNull --> End[å®Œæˆ]
    Return --> End

    style Start fill:#90EE90
    style End fill:#90EE90
    style CreateHash fill:#FFD700
    style DigestHash fill:#87CEEB
```

---

## ğŸ”— ç±»å…³ç³»å›¾

```mermaid
classDiagram
    class VersionChecker {
        +String upstreamPath
        +String downstreamPath
        +String manifestPath
        +checkVersion() Object
        +getLocalVersion() String
        +getUpstreamVersion() String
        -_compareVersions(v1, v2) Number
        -_getChangelog(from, to) String
        +readManifest() Object
        +writeManifest(data) Object
        -_createDefaultManifest() Object
        +computeBaselineHashes() Object
        +getFileHash(filePath) String
        +isFileCustomized(path, hash) Boolean
        +detectObsoleteFiles(from, to) Array
        +detectOverrideConflicts() Promise~Array~
        +printVersionReport() Object
    }

    class DocumentGenerator {
        +generateAll(path, options) Promise
    }

    class SyncManager {
        +syncWorkflow() Promise
    }

    DocumentGenerator --> VersionChecker : uses
    SyncManager --> VersionChecker : uses
```

---

## âš™ï¸ é…ç½®ä¸å¸¸é‡

### æ ¸å¿ƒæ–‡ä»¶åˆ—è¡¨
```javascript
const CORE_FILES = [
  'å¼€å‘è§„èŒƒ.md',
  'é—®é¢˜æ’æŸ¥.md',
  'å¿«é€Ÿå¼€å§‹.md',
  'MODSDKæ ¸å¿ƒæ¦‚å¿µ.md',
  'APIé€ŸæŸ¥.md',
  'å®˜æ–¹æ–‡æ¡£æŸ¥è¯¢æŒ‡å—.md',
  'è¿ç§»æŒ‡å—-v15.0.md'
];
```

### Manifestæ–‡ä»¶ç»“æ„
```javascript
{
  version: String,              // å·¥ä½œæµç‰ˆæœ¬å·
  installedAt: String,          // å®‰è£…æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  updatedAt: String,            // æ›´æ–°æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  baselineHashes: {             // åŸºçº¿æ–‡ä»¶å“ˆå¸Œå€¼
    [filename: String]: String  // SHA256å“ˆå¸Œ
  },
  obsoleteFiles: Array<String>  // åºŸå¼ƒæ–‡ä»¶åˆ—è¡¨
}
```

### å“ˆå¸Œç®—æ³•
```javascript
const HASH_ALGORITHM = 'sha256';
const HASH_ENCODING = 'hex';
const HASH_LENGTH = 64;  // åå…­è¿›åˆ¶å­—ç¬¦æ•°
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **å®šæœŸæ£€æŸ¥**: åœ¨é¡¹ç›®å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ç‰ˆæœ¬
2. **ä¿æŠ¤ç”¨æˆ·ä¿®æ”¹**: ä½¿ç”¨å“ˆå¸Œå€¼æ£€æµ‹æ–‡ä»¶æ˜¯å¦è¢«å®šåˆ¶
3. **å¢é‡æ›´æ–°**: åªæ›´æ–°æœ‰å˜åŒ–çš„æ–‡ä»¶
4. **å†²çªæç¤º**: æ£€æµ‹åˆ°è¦†ç›–å±‚å†²çªæ—¶ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åˆå¹¶
5. **åºŸå¼ƒæ–‡ä»¶æ¸…ç†**: å‡çº§åè‡ªåŠ¨æ¸…ç†åºŸå¼ƒæ–‡ä»¶
6. **Manifestå¤‡ä»½**: æ›´æ–°å‰å¤‡ä»½æ—§Manifest

---

## ğŸ“š ä¾èµ–æ¨¡å—

- `fs-extra` - å¢å¼ºæ–‡ä»¶ç³»ç»Ÿæ“ä½œ
- `path` - è·¯å¾„å¤„ç†
- `crypto` - å“ˆå¸Œè®¡ç®—

---

## ğŸ”„ ç‰ˆæœ¬å†å²

- **v1.0** (å½“å‰): ç‰ˆæœ¬æ£€æµ‹ã€å“ˆå¸Œè®¡ç®—ã€è¦†ç›–å±‚å†²çªæ£€æµ‹

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **å“ˆå¸Œå€¼ä¸åŒ¹é…â‰ å†²çª**: éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ä¸Šæ¸¸æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°
2. **ç‰ˆæœ¬å·æ ‡å‡†åŒ–**: v15.xä½¿ç”¨"15.0"æ ¼å¼ï¼Œéœ€è¦è½¬æ¢ä¸º"15.0.0"
3. **æ–‡ä»¶ç¼–ç **: ç¡®ä¿æ–‡ä»¶ä»¥UTF-8ç¼–ç è¯»å–ï¼Œé¿å…å“ˆå¸Œå€¼é”™è¯¯
4. **è·¯å¾„åˆ†éš”ç¬¦**: Windowsä½¿ç”¨åæ–œæ ï¼Œéœ€è¦ç»Ÿä¸€å¤„ç†
5. **ç©ºæ–‡ä»¶å¤„ç†**: ç©ºæ–‡ä»¶çš„å“ˆå¸Œå€¼ä¸ºæœ‰æ•ˆå€¼ï¼Œä¸æ˜¯null

---

**æ–‡æ¡£å…ƒæ•°æ®**:
- ä½œè€…: MODSDKå·¥ä½œæµå›¢é˜Ÿ
- æœ€åæ›´æ–°: 2025-11-13
- ç›¸å…³æ–‡æ¡£: [é¡¹ç›®åˆ†æå™¨.md](./é¡¹ç›®åˆ†æå™¨.md), [æ–‡æ¡£ç”Ÿæˆå™¨.md](./æ–‡æ¡£ç”Ÿæˆå™¨.md), [æ™ºèƒ½æ–‡æ¡£ç»´æŠ¤.md](./æ™ºèƒ½æ–‡æ¡£ç»´æŠ¤.md)
