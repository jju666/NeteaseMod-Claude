# 玩法包质量标准

> **版本**: v1.0.0
> **创建日期**: 2025-11-13
> **适用于**: NeteaseMod-Claude v19.0+
> **目标**: 确保玩法包的质量和一致性

---

## 📋 目录

1. [质量标准总览](#质量标准总览)
2. [核心指标](#核心指标)
3. [代码质量要求](#代码质量要求)
4. [文档质量要求](#文档质量要求)
5. [关键词质量要求](#关键词质量要求)
6. [测试要求](#测试要求)
7. [评分体系](#评分体系)

---

## 质量标准总览

### 三级质量标准

| 等级 | 匹配度 | 代码行数 | 关键词数 | 常见问题 | 测试覆盖 |
|------|--------|---------|---------|---------|---------|
| ⭐⭐⭐ **优秀** | ≥85% | ≥200行 | ≥12个 | ≥5个 | 100% |
| ⭐⭐ **良好** | ≥75% | ≥150行 | ≥8个 | ≥3个 | ≥80% |
| ⭐ **合格** | ≥60% | ≥100行 | ≥6个 | ≥2个 | ≥50% |

### 准入门槛

**最低要求**（低于此标准将被拒绝）:
- ❌ 匹配度 < 60%
- ❌ 代码行数 < 100行
- ❌ 关键词数 < 6个
- ❌ 常见问题 < 2个
- ❌ 未提供测试用例

---

## 核心指标

### 1. 匹配度（权重: 30%）

**定义**: 玩法包关键词与目标任务的匹配程度

**计算方法**:
```python
匹配度 = (匹配的关键词数量 / 总关键词数量) * 100%

# 示例
关键词列表 = ["击杀", "掉落", "怪物", "物品", "战利品", "loot", "drop", "monster"]
用户输入 = "实现玩家击杀怪物掉落自定义物品"

# 分词后匹配
用户关键词 = ["击杀", "怪物", "掉落", "物品", "自定义"]
匹配关键词 = ["击杀", "怪物", "掉落", "物品"]  # 4个

匹配度 = 4 / 8 * 100% = 50%
```

**质量要求**:
- ⭐⭐⭐ **优秀**: ≥85%（用户输入的80%+关键词都能匹配）
- ⭐⭐ **良好**: ≥75%（用户输入的75%+关键词都能匹配）
- ⭐ **合格**: ≥60%（用户输入的60%+关键词都能匹配）

**优化建议**:
- ✅ 增加长尾关键词（如"自定义掉落"）
- ✅ 添加英文术语（如"loot"、"drop"）
- ✅ 包含常见变体（如"怪物"、"实体"、"生物"）

### 2. 代码长度（权重: 20%）

**定义**: `complete_code.content` 字段的有效代码行数

**计算方法**:
```python
有效行数 = 总行数 - 空行数 - 纯注释行数

# 注释行也计入有效行数,但不包括文档字符串外的独立注释块
```

**质量要求**:
- ⭐⭐⭐ **优秀**: ≥200行（包含详细注释、边界检查、配置示例）
- ⭐⭐ **良好**: ≥150行（包含基本注释、核心逻辑）
- ⭐ **合格**: ≥100行（最小可用实现）

**代码结构要求**:
```python
# 必需部分（约60-80行）
1. 文件头（编码、导入、文档字符串）        10-15行
2. 类定义和__init__                       10-15行
3. Create方法（组件创建、事件监听）        15-20行
4. 事件处理器（核心业务逻辑）              20-30行
5. Destroy方法（资源清理）                 5-10行

# 推荐部分（约40-60行）
6. 配置表和示例                           10-15行
7. 辅助方法（数据验证、格式化等）          15-20行
8. 详细注释（参数说明、使用示例）          15-25行

# 优秀加分项（约40-60行）
9. 边界情况处理                           10-15行
10. 错误处理和日志                        10-15行
11. 性能优化（缓存、批处理等）             10-15行
12. 多场景示例                            10-15行
```

### 3. API覆盖度（权重: 20%）

**定义**: `modsdk_apis` 数组中API的数量和完整性

**质量要求**:
- ⭐⭐⭐ **优秀**: ≥4个API,每个API包含完整字段说明
- ⭐⭐ **良好**: ≥2个API,核心字段说明完整
- ⭐ **合格**: ≥1个API,基本字段说明

**API文档完整性检查**:
```json
{
  "name": "API名称",                    // ✅ 必需
  "type": "事件|组件方法|接口",          // ✅ 必需
  "trigger": "触发时机",                // ⚠️ 事件必需
  "fields": {                          // ✅ 必需（至少1个）
    "字段名": "类型和说明"
  },
  "params": {                          // ⚠️ 方法必需
    "参数名": {
      "type": "类型",
      "required": ["必需字段"],
      "example": "示例值"
    }
  },
  "doc_path": "MODSDK文档路径",         // ✅ 必需
  "common_pitfall": "常见陷阱"          // ⭐ 推荐
}
```

### 4. 问题覆盖度（权重: 15%）

**定义**: `common_issues` 数组中问题的数量和质量

**质量要求**:
- ⭐⭐⭐ **优秀**: ≥5个,覆盖多个场景
- ⭐⭐ **良好**: ≥3个,覆盖核心场景
- ⭐ **合格**: ≥2个,覆盖关键场景

**问题类型分布**（推荐）:
```json
[
  {
    "category": "配置错误",
    "problem": "配置参数错误导致的问题",
    "example": "掉落概率设置>1导致必定掉落"
  },
  {
    "category": "API使用错误",
    "problem": "MODSDK API使用不当",
    "example": "pos参数使用tuple而非list"
  },
  {
    "category": "边界情况",
    "problem": "特殊情况下的异常",
    "example": "实体在虚空中被击杀"
  },
  {
    "category": "多人游戏问题",
    "problem": "多玩家环境下的冲突",
    "example": "同时击杀导致重复掉落"
  },
  {
    "category": "性能问题",
    "problem": "高频触发导致的性能问题",
    "example": "大量实体同时死亡"
  }
]
```

**问题质量评分**:
- **优秀问题**（3分）: 实际遇到 + 根因分析 + 可操作方案
- **良好问题**（2分）: 可能遇到 + 原因说明 + 解决方案
- **合格问题**（1分）: 常见问题 + 简单方案

### 5. 关键词质量（权重: 15%）

**定义**: 关键词的数量、覆盖度和合理性

**质量要求**:
- ⭐⭐⭐ **优秀**: ≥12个,覆盖多语言、领域术语、长尾词
- ⭐⭐ **良好**: ≥8个,覆盖核心概念和常见变体
- ⭐ **合格**: ≥6个,覆盖核心概念

**关键词分类**（示例：击杀掉落系统）:
```json
{
  "核心动作": ["击杀", "kill"],             // 2个
  "核心对象": ["怪物", "实体", "monster"],   // 3个
  "核心产出": ["掉落", "物品", "drop"],     // 3个
  "领域术语": ["战利品", "loot"],           // 2个
  "长尾词": ["自定义掉落", "击杀奖励"],      // 2个
  "相关概念": ["经验", "概率"]              // 2个
}
// 总计: 14个关键词
```

---

## 代码质量要求

### CRITICAL规范遵守（一票否决）

玩法包代码**必须**遵守12项CRITICAL规范,违反任何一项将被拒绝:

1. ✅ **双端隔离**: 不跨端GetSystem
2. ✅ **生命周期**: 在Create()中初始化,不在__init__调用API
3. ✅ **EventData序列化**: 使用list/dict,不使用tuple
4. ✅ **AOI范围**: 不超过2000格
5. ✅ **print语法**: 使用`from __future__ import print_function`
6. ✅ **模块导入**: 只导入白名单模块
7. ✅ **编码声明**: 含中文时添加UTF-8声明
8. ✅ **Component顺序**: 先创建再使用
9. ✅ **事件名拼写**: 参考官方事件索引表
10. ✅ **跨System调用**: 使用事件通知,不直接调用
11. ✅ **全局变量**: 使用实例变量,不用模块级全局变量
12. ✅ **事件解绑**: Destroy()中调用UnListenAllEvents()

**检查方法**:
```bash
# 使用Hook自动检查
python templates/.claude/hooks/check-critical-rules.py < test_input.json
```

### 代码风格要求

**命名规范**:
- ✅ 类名: PascalCase（如`DropServerSystem`）
- ✅ 方法名: camelCase（如`OnPlayerKillEntity`）
- ✅ 变量名: snake_case（如`drop_table`）
- ✅ 常量: UPPER_SNAKE_CASE（如`MAX_DROP_COUNT`）

**注释规范**:
```python
# ✅ 良好注释示例
def OnPlayerKillEntity(self, args):
    """
    玩家击杀实体事件处理器

    Args:
        args (dict): 事件数据
            - playerId (str): 击杀者玩家ID
            - entityId (str): 被击杀实体ID
            - killer (str): 击杀者实体ID（与playerId对应）

    Returns:
        None

    Raises:
        None

    Note:
        entityId在事件触发时可能已销毁,需先用isValid检查
    """
    # 安全获取实体ID
    entity_id = args.get('entityId')
    if not entity_id:
        print("[WARNING] entityId缺失")
        return

    # 业务逻辑...
```

**错误处理**:
```python
# ✅ 推荐: 安全获取 + 边界检查
value = args.get('field')
if not value:
    print("[WARNING] field缺失")
    return

# ✅ 推荐: try-except捕获异常
try:
    result = self.comp.Method(value)
except Exception as e:
    print(f"[ERROR] 操作失败: {e}")
    return

# ❌ 禁止: 直接访问可能不存在的字段
value = args['field']  # KeyError风险

# ❌ 禁止: 不处理异常
result = self.comp.Method(value)  # 可能崩溃
```

### 性能要求

**禁止性能杀手**:
- ❌ **嵌套循环**: O(n²)或更高复杂度（除非有明确注释说明场景限制）
- ❌ **频繁字符串拼接**: 使用join()代替+运算符
- ❌ **全局扫描**: 遍历所有玩家/实体（应使用事件驱动）
- ❌ **无限缓存**: 字典/列表无限增长（应设置上限）

**推荐优化**:
```python
# ✅ 使用字典索引代替嵌套循环
item_map = {item['id']: item for item in all_items}
for player_id in players:
    item_id = self.GetPlayerItemId(player_id)
    if item_id in item_map:
        self.ProcessItem(item_map[item_id])

# ✅ 设置缓存上限
MAX_HISTORY = 100
def OnEvent(self, args):
    history = self.history.setdefault(key, [])
    history.append(data)
    if len(history) > MAX_HISTORY:
        history.pop(0)  # 移除最旧的记录
```

---

## 文档质量要求

### description 字段

**要求**:
- ✅ 长度: 10-50个汉字
- ✅ 格式: 一句话概括功能和效果
- ✅ 内容: 说明"谁 + 做什么 + 达到什么效果"

**示例**:
```json
// ✅ 优秀
"description": "玩家击杀实体后,根据配置表生成自定义掉落物"

// ✅ 良好
"description": "监听击杀事件,在实体死亡位置生成物品"

// ❌ 不合格
"description": "掉落系统"  // 太简短
"description": "这是一个用于实现玩家在击杀怪物之后能够获得自定义物品掉落的完整系统实现方案"  // 太冗长
```

### principle 字段

**要求**:
- ✅ 长度: 20-100个汉字
- ✅ 格式: 监听XX事件 → 处理逻辑 → 调用XX API
- ✅ 内容: 说明技术实现路径

**示例**:
```json
// ✅ 优秀
"principle": "监听ServerPlayerKillEntityEvent → 判断实体类型和掉落配置 → 调用SpawnItemToLevel在实体位置生成物品 → 添加掉落概率判断和边界检查"

// ✅ 良好
"principle": "监听击杀事件 → 查询掉落表 → 生成物品到世界"

// ❌ 不合格
"principle": "使用MODSDK API实现"  // 太简略,没有说明具体流程
```

### config_guide 字段

**要求**:
- ✅ 包含完整的配置示例
- ✅ 说明每个配置字段的含义
- ✅ 提供多个配置场景示例

**示例**:
```json
{
  "config_guide": {
    "description": "在 drop_table 中配置掉落规则,支持多种实体和多个掉落项",
    "example": {
      "minecraft:zombie": [
        {
          "item": "minecraft:rotten_flesh",
          "count": 1,
          "chance": 1.0,
          "comment": "100%掉落1个腐肉"
        },
        {
          "item": "minecraft:iron_ingot",
          "count": 1,
          "chance": 0.05,
          "comment": "5%概率掉落1个铁锭"
        }
      ]
    },
    "fields": {
      "item": "物品ID,格式: 'minecraft:物品名' 或 '自定义命名空间:物品名'",
      "count": "掉落数量 (整数,≥1)",
      "chance": "掉落概率 (0.0-1.0, 0.1表示10%)"
    }
  }
}
```

---

## 关键词质量要求

### 关键词选择原则

1. **用户视角**: 用户会用什么词描述这个需求？
2. **多样性**: 包含中文、英文、术语、口语
3. **完整性**: 覆盖核心概念和相关概念
4. **准确性**: 避免歧义和误导

### 关键词类型分布（推荐比例）

| 类型 | 比例 | 示例 |
|------|------|------|
| 核心动作词 | 15-20% | 击杀、攻击、使用 |
| 核心对象词 | 20-25% | 怪物、玩家、方块 |
| 核心概念词 | 20-25% | 掉落、伤害、传送 |
| 领域术语 | 15-20% | 战利品、DPS、AOE |
| 英文术语 | 15-20% | kill、loot、damage |
| 长尾词 | 5-10% | 自定义掉落、击杀奖励 |

### 关键词质量检查

**自动化检查**:
```python
# 检查1: 关键词数量
assert len(keywords) >= 8, "关键词数量不足"

# 检查2: 重复检查
assert len(keywords) == len(set(keywords)), "存在重复关键词"

# 检查3: 长度检查
for kw in keywords:
    assert 2 <= len(kw) <= 20, f"关键词'{kw}'长度不合理"

# 检查4: 相关性检查（基于TF-IDF）
similarity = calculate_similarity(keywords, description)
assert similarity >= 0.5, "关键词与描述相关性低"
```

---

## 测试要求

### 必需测试用例

**1. 关键词匹配测试**:
```python
# tests/test-keyword-matching.py
def test_[gameplay_id]_keywords():
    """测试关键词匹配"""
    test_cases = [
        {
            "input": "实现击杀掉落自定义物品",
            "expected_match": True,
            "expected_score": 0.75  # 最低匹配度
        },
        {
            "input": "玩家杀死怪物后获得战利品",
            "expected_match": True,
            "expected_score": 0.60
        }
    ]

    for case in test_cases:
        result = match_gameplay(case["input"], "kill-drop-system")
        assert result.matched == case["expected_match"]
        assert result.score >= case["expected_score"]
```

**2. 代码执行测试**（推荐）:
```python
# tests/test-[gameplay-id]-code.py
def test_code_syntax():
    """测试代码语法正确性"""
    code = get_gameplay_code("kill-drop-system")
    compile(code, '<string>', 'exec')  # 编译检查

def test_critical_rules():
    """测试CRITICAL规范"""
    code = get_gameplay_code("kill-drop-system")
    violations = check_critical_rules(code)
    assert len(violations) == 0, f"发现{len(violations)}个规范违规"
```

### 可选测试用例

**3. 集成测试**（优秀加分项）:
```python
def test_in_game():
    """游戏内集成测试"""
    # 需要MODSDK测试环境
    # 1. 加载System
    # 2. 触发事件
    # 3. 验证结果
    pass
```

---

## 评分体系

### 总分计算

```python
总分 = 匹配度得分 * 30%
     + 代码长度得分 * 20%
     + API覆盖度得分 * 20%
     + 问题覆盖度得分 * 15%
     + 关键词质量得分 * 15%

# 各项得分计算方法
匹配度得分 = min(匹配度 / 85% * 100, 100)
代码长度得分 = min(代码行数 / 200 * 100, 100)
API覆盖度得分 = min(API数量 / 4 * 100, 100)
问题覆盖度得分 = min(问题数量 / 5 * 100, 100)
关键词质量得分 = min(关键词数量 / 12 * 100, 100)
```

### 评级标准

| 总分 | 评级 | 说明 |
|------|------|------|
| 90-100 | ⭐⭐⭐ 优秀 | 立即合并,作为标杆 |
| 75-89 | ⭐⭐ 良好 | 通过审核,可以合并 |
| 60-74 | ⭐ 合格 | 需要改进,建议优化 |
| <60 | ❌ 不合格 | 拒绝合并,要求修改 |

### 加分项（最多+10分）

- ✅ **提供游戏内测试截图**: +3分
- ✅ **提供完整测试用例**: +3分
- ✅ **文档引用精确到行号**: +2分
- ✅ **提供多个配置示例**: +2分

---

## 质量检查清单

### 提交前自查

**基础检查**:
- [ ] JSON格式正确（可解析）
- [ ] 所有必需字段完整
- [ ] 代码长度≥150行
- [ ] 关键词数量≥8个
- [ ] API数量≥2个
- [ ] 常见问题≥3个

**CRITICAL规范检查**:
- [ ] 通过check-critical-rules.py检查
- [ ] 无双端隔离违规
- [ ] 无生命周期违规
- [ ] 无EventData序列化违规
- [ ] 遵守其他9项规范

**文档检查**:
- [ ] description清晰简洁
- [ ] principle说明实现路径
- [ ] config_guide提供完整示例
- [ ] common_issues实用可操作
- [ ] doc_path引用准确

**测试检查**:
- [ ] 关键词匹配测试通过
- [ ] 代码语法检查通过
- [ ] （可选）游戏内测试通过

### 审核者检查清单

**质量评分**:
- [ ] 计算总分（使用评分体系）
- [ ] 确认评级（优秀/良好/合格/不合格）

**代码审查**:
- [ ] 遵循CRITICAL规范
- [ ] 代码风格一致
- [ ] 注释清晰充分
- [ ] 错误处理完善
- [ ] 性能考虑合理

**文档审查**:
- [ ] 文档准确无误
- [ ] API用法正确
- [ ] 常见问题实用
- [ ] 配置示例完整

**最终决策**:
- [ ] ✅ 通过（合并）
- [ ] ⚠️ 需修改（提供建议）
- [ ] ❌ 拒绝（说明原因）

---

## 参考资源

### 标杆玩法包

**⭐⭐⭐ 优秀示例**:
- `kill-drop-system` - 击杀掉落系统（匹配度100%, 192行代码）

**⭐⭐ 良好示例**:
- `npc-dialogue-system` - NPC对话系统（匹配度88%, 233行代码）
- `custom-shop-system` - 自定义商店（匹配度82%, 233行代码）

### 相关文档

- [玩法包贡献指南](./玩法包贡献指南.md)
- [开发规范](../../.claude/core-docs/核心工作流文档/开发规范.md)
- [技术架构](./技术架构.md)

---

_最后更新: 2025-11-13 | v1.0.0_
