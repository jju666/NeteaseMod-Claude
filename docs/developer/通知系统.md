# 🔔 通知系统设计文档

> **版本**: v20.2.8
> **更新时间**: 2025-11-14
> **状态**: ✅ 已实现
>
> **核心模块**: `templates/.claude/hooks/vscode_notify.py`

---

## 📐 系统架构

### 设计目标

为 MODSDK 工作流提供**非侵入式**的用户反馈机制,在关键节点主动通知用户,提升任务可见性和用户体验。

### 核心原则

1. **降级容错**: 系统通知不可用时自动降级为终端输出
2. **异常隔离**: 通知失败不影响 Hook 正常执行
3. **跨平台**: 支持 Windows/macOS/Linux 三大平台
4. **最小依赖**: 仅依赖可选的 plyer 库,未安装时自动降级

---

## 🏗️ 技术实现

### 通知模块 (vscode_notify.py)

```
通知策略决策树:
┌─────────────┐
│ notify()    │
└──────┬──────┘
       │
       ├─ plyer可用? ────Yes──> plyer_notify.notify()
       │                          ├─ Windows: 通知中心
       │                          ├─ macOS: 通知中心
       │                          └─ Linux: libnotify
       │
       └─ plyer不可用 ──No───> notify_fallback()
                                  └─ 彩色终端输出 (ANSI转义码)
```

### 三级通知接口

| 函数 | 级别 | 图标 | 颜色 | 适用场景 |
|------|------|------|------|---------|
| `notify_info(msg, detail)` | INFO | ℹ️ | 蓝色 | 步骤完成、任务启动 |
| `notify_warning(msg, detail)` | WARNING | ⚠️ | 黄色 | 任务失败、专家推荐 |
| `notify_error(msg, detail)` | ERROR | ❌ | 红色 | 连续失败、专家触发 |

---

## 📢 通知触发点全览

### 基于 v20.2.8 实际实现分析

| 序号 | 触发时机 | 级别 | 消息内容 | Hook文件 | 代码位置 |
|------|---------|------|---------|---------|---------|
| 1 | `/mc` 命令启动任务 | INFO | "步骤3：执行实施 \| 玩法包: XXX" | user-prompt-submit-hook.py | L636, L673 |
| 2 | 工作流步骤完成 | INFO | "Step completed<br>Current: XXX → Next: XXX" | unified-workflow-driver.py | L1040 |
| 3 | 阅读第3个文档后 | INFO | "步骤2完成：查阅文档<br>已阅读N个文档 → 进入步骤3" | track-doc-reading.py | L161 |
| 4 | 任务文档被修改 | INFO | "任务文档更新<br>已更新: 任务上下文/解决方案" | log-changes.py | L61 |
| 5 | Subagent 任务完成 | INFO | "✅ XXX completed<br>Exploration results returned" | subagent-complete-notifier.py | L51 |
| 6 | 专家诊断被推荐 | WARNING | "Expert diagnosis recommended<br>触发原因: XXX" | unified-workflow-driver.py | L979 |
| 7 | 专家审查已触发 | WARNING | "专家审查已触发<br>循环类型: XXX \| 置信度: XX%" | unified-workflow-driver.py | L1080 |
| 8 | BUG修复未确认 | WARNING | "BUG修复未确认<br>等待用户输入'已修复'" | enforce-cleanup.py | L250, L421 |
| 9 | 任务修复已确认 | WARNING | "任务修复已确认<br>是否需要执行收尾工作？" | enforce-cleanup.py | L316 |
| 🔟 | 任务未完成阻止结束 | WARNING | "Task not complete, please finish cleanup work" | enforce-cleanup.py | L539 |

### 通知内容示例

**步骤推进通知** (unified-workflow-driver.py):
```python
notify_info(
    "Step completed",
    "Current: step1_understand → Next: step3_execute"
)
```

**专家审查通知** (unified-workflow-driver.py):
```python
notify_warning(
    "专家审查已触发",
    "循环类型: bug_fix_loop | 置信度: 90%"
)
```

**任务失败通知** (stop-hook.py):
```python
notify_warning(
    "任务未完成(失败 1 次)",
    "会话已被阻止"
)
```

---

## 🔗 集成方式

### Hook 中使用通知

所有 Hook 文件遵循统一的导入模式:

```python
# 导入通知模块 (容错处理)
try:
    from vscode_notify import notify_info, notify_warning, notify_error
except ImportError:
    # 降级为空操作 (不影响Hook执行)
    def notify_info(msg, detail=""): pass
    def notify_warning(msg, detail=""): pass
    def notify_error(msg, detail=""): pass
```

### 异常隔离机制

关键通知调用包装在 try-except 中,防止通知失败导致 Hook 中断:

```python
# unified-workflow-driver.py 示例
try:
    from vscode_notify import notify_warning
    notify_warning("专家审查已触发", details)
except:
    pass  # 通知失败不影响Hook执行
```

---

## 🎯 设计特点

### 1. 非阻塞异步设计

- 通知发送不阻塞 Hook 执行
- plyer 通知设置 5 秒超时自动消失
- 终端输出立即返回

### 2. 双通道反馈

| 通道 | 优势 | 适用场景 |
|------|------|---------|
| **系统通知** | 跨窗口可见、后台提醒 | 长时间运行任务 |
| **终端输出** | 永久记录、易于调试 | 开发测试阶段 |

### 3. 智能降级策略

```
检测逻辑:
1. 模块导入时检测 plyer 库 → HAS_PLYER = True/False
2. 调用 notify() 时根据 HAS_PLYER 选择策略:
   - True  → 尝试系统通知 (失败则降级)
   - False → 直接使用终端输出
3. 即使降级,所有功能正常工作
```

---

## 🚀 用户体验改进

### 问题解决: 多轮会话进度可见性

**问题**: "对同一个任务进行多轮会话需要写入task时有通知吗？"

**解决方案** (v20.0+):

当 AI 修改任务文档时,`log-changes.py` 自动发送通知:

```python
# log-changes.py (line 61)
notify_info(
    "任务文档更新",
    "已更新: {}".format(doc_type)  # context.md / solution.md
)
```

**效果**: 用户在多轮会话中能实时知道 AI 的进度更新。

---

## 💻 代码实现细节

### vscode_notify.py 核心函数

```python
def notify(level, message, detail=""):
    """
    核心通知函数

    Args:
        level: "info" | "warning" | "error"
        message: 主消息文本
        detail: 详细信息（可选）

    实现逻辑:
    1. 合并 message 和 detail 为完整消息
    2. 尝试系统原生通知 (plyer)
    3. 失败则降级为彩色终端输出
    4. 异常不抛出,确保调用者不受影响
    """
    try:
        full_message = "{} - {}".format(message, detail) if detail else message

        # 策略1: 系统原生通知
        if HAS_PLYER:
            try:
                safe_message = str(full_message).encode('utf-8', errors='replace').decode('utf-8')
                plyer_notify.notify(
                    title="Claude Code - {}".format(level.upper()),
                    message=safe_message,
                    app_name="Claude Code Hooks",
                    timeout=5
                )
                sys.stderr.write("[SYSTEM-NOTIFY] {}\n".format(safe_message))
                return
            except Exception as e:
                sys.stderr.write("[PLYER-ERROR] {}\n".format(str(e)))

        # 策略2: 降级为彩色终端输出
        notify_fallback(level, message, detail)

    except Exception as e:
        sys.stderr.write("[NOTIFY-ERROR] {}\n".format(str(e)))
```

### 字符编码安全处理

**问题**: Windows 环境下中文字符可能引发编码错误

**解决方案**:
```python
# 使用 errors='replace' 替换无效字符,而非抛出异常
safe_message = str(full_message).encode('utf-8', errors='replace').decode('utf-8')
```

**关键点**: 确保通知模块永远不会因编码问题而失败。

---

## 🧪 测试与验证

### 测试命令

```bash
# 在项目根目录执行
python templates/.claude/hooks/vscode_notify.py
```

### 预期输出

```
=== 测试跨平台通知系统 ===

环境检测:
- plyer库可用: True
- 操作系统: Windows

发送测试通知...

如果你看到了系统弹窗,说明通知功能正常工作！

plyer 支持:
  - Windows: 原生通知中心
  - macOS: 通知中心
  - Linux: libnotify (需先安装 notify-send)
```

### 预期现象

1. 屏幕右下角弹出 3 个系统通知（信息、警告、错误）
2. 终端输出环境检测信息

---

## 🛡️ 最佳实践

### 在 Hook 中使用通知

**推荐模式**:

```python
# 1. 导入时提供降级函数
try:
    from vscode_notify import notify_info
except ImportError:
    def notify_info(msg, detail=""): pass

# 2. 使用时包裹异常处理
try:
    notify_info("步骤完成", "进入下一步")
except:
    pass  # 通知失败不影响主流程
```

**关键原则**:
- ✅ 总是提供导入降级方案
- ✅ 总是用 try-except 包裹通知调用
- ✅ 通知失败时静默处理,不阻塞工作流
- ❌ 不要依赖通知的成功执行
- ❌ 不要在通知中包含关键逻辑

### 通知消息设计

**推荐格式**:

```python
notify_info(
    "主消息（简洁明确）",
    "详细信息（可选,补充上下文）"
)
```

**示例**:

```python
# ✅ 好的消息设计
notify_info("步骤2完成：查阅文档", "已阅读3个文档 → 进入步骤3")
notify_warning("BUG修复未确认", "等待用户输入'已修复'")

# ❌ 不好的消息设计
notify_info("成功")  # 太模糊
notify_warning("任务失败，需要用户确认修复完成后才能结束，请输入'已修复'")  # 太长
```

### 通知级别选择

| 级别 | 适用场景 | 示例 |
|------|---------|------|
| **INFO** | 正常进度更新、成功完成 | 任务初始化、步骤完成、文档更新 |
| **WARNING** | 需要用户注意的情况 | 等待确认、需要选择、循环检测 |
| **ERROR** | 严重错误、审核未通过 | 专家诊断触发、任务失败超限 |

---

## 📚 相关文档

- [通知功能安装指南](./通知功能安装指南.md) - 安装步骤与故障排查
- [Hook机制文档](./Hook机制.md) - Hook系统完整说明
- [技术架构文档](./技术架构.md) - 整体系统设计

---

## 🔗 源码参考

**通知模块**: `templates/.claude/hooks/vscode_notify.py`

**主要调用者**:
- `unified-workflow-driver.py` (L53, L979, L1040, L1079)
- `user-prompt-submit-hook.py` (L35, L636, L673)
- `track-doc-reading.py` (L26, L161)
- `log-changes.py` (L24, L61)
- `enforce-cleanup.py` (L50, L250, L316, L421, L539)
- `subagent-complete-notifier.py` (L22, L51)

---

**版本**: v20.2.8
**最后更新**: 2025-11-14
**维护者**: MODSDK 工作流团队
