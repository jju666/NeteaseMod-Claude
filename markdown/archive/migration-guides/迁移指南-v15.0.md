# 迁移指南：v14.x → v15.0

> 从旧版工作流迁移到内联式架构

**版本**: v15.0
**最后更新**: 2025-11-10

---

## 🎯 为什么要迁移？

v15.0 引入**内联式架构**，彻底解决了升级时的内容合并风险。

### 旧版痛点
- ❌ 升级需要 AI 智能合并
- ❌ 可能丢失用户自定义内容
- ❌ 不敢频繁升级

### 新版优势
- ✅ 精确替换，零风险
- ✅ 自定义内容完全隔离
- ✅ 支持快速迭代

---

## 📋 迁移步骤

### 1. 自动迁移（推荐）

在您的 MODSDK 项目根目录执行：

```bash
initmc
```

系统会自动：
1. 检测旧版 CLAUDE.md
2. 备份为 `CLAUDE.md.backup.YYYY-MM-DD`
3. 生成新版内联式 CLAUDE.md
4. 创建版本追踪文件

### 2. 检查备份文件

```bash
# 查看备份
cat CLAUDE.md.backup.2025-11-10

# 对比新旧文件（可选）
diff CLAUDE.md.backup.2025-11-10 CLAUDE.md
```

### 3. 提取自定义内容

如果旧版 CLAUDE.md 中有以下内容，请手动迁移：

- **自定义开发规范**
- **项目特定约定**
- **团队协作流程**
- **自定义工作流配置**

> ⚠️ **重要**：新版 CLAUDE.md 已包含所有通用工作流内容，您只需迁移**项目特定**的自定义内容。

### 4. 添加到新版扩展区

打开新版 `CLAUDE.md`，找到：

```markdown
<!-- ==================== 项目扩展区 START ==================== -->

## 🎯 项目特定规范

<!-- 在此添加 -->
```

将提取的内容粘贴到此处。

**示例**：

```markdown
## 🎯 项目特定规范

### 自定义架构

- 本项目使用 State 模式管理游戏状态
- 所有数据库操作统一使用 DBManager
- UI 组件统一使用 UIHelper

### 团队约定

- 提交代码前必须运行单元测试
- 函数命名使用驼峰命名法
- 注释使用中文

---

## 🔧 扩展配置

<!-- 可选：覆盖工作流默认行为 -->
```

### 5. 验证工作流

```bash
# 在 Claude Code 中测试工作流是否正常
/cc 创建一个测试 System
```

---

## 📊 新版 CLAUDE.md 结构

### 三段式架构

```markdown
<!-- ==================== 用户配置区 START ==================== -->
## 📌 项目配置
- 项目路径、类型等
（用户可编辑，升级保留）
<!-- ==================== 用户配置区 END ==================== -->

<!-- ==================== 工作流内容 START v15.0 ==================== -->
⚠️ 警告：请勿手动修改
## 🎯 AI助手身份定位
## 🚨 CRITICAL规范
...（完整工作流）
（自动管理，升级时精确替换）
<!-- ==================== 工作流内容 END v15.0 ==================== -->

<!-- ==================== 项目扩展区 START ==================== -->
## 🎯 项目特定规范
（用户可编辑，升级保留）
<!-- ==================== 项目扩展区 END ==================== -->
```

### 区域职责

| 区域 | 用途 | 可编辑 | 升级时 |
|-----|------|--------|--------|
| 用户配置区 | 项目路径、类型等基础配置 | ✅ 是 | 保留 |
| 工作流内容 | AI 行为规范、开发流程 | ❌ 否 | 替换 |
| 项目扩展区 | 项目特定规范、团队约定 | ✅ 是 | 保留 |

---

## ⚡ 后续升级

迁移完成后，未来的升级非常简单：

```bash
# 在项目目录执行（零风险）
initmc
```

系统会：
1. 识别内联式架构
2. 精确替换工作流区域
3. 保留用户配置区和扩展区
4. 更新版本追踪文件

**优势**：
- ✅ 10秒完成
- ✅ 零风险（精确替换）
- ✅ 自定义内容 100% 保留

---

## ❓ 常见问题

### Q: 我的自定义内容会丢失吗？

**A**: 不会！旧版文件已自动备份为 `CLAUDE.md.backup.YYYY-MM-DD`。新版迁移只会覆盖工作流内容，您的自定义内容需要从备份中手动提取到"项目扩展区"。

### Q: 迁移后如何升级？

**A**: 执行 `initmc` 即可，系统会自动识别内联式格式并精确替换工作流区域，您的自定义内容完全不受影响。

### Q: 我可以回退到旧版吗？

**A**: 可以，使用备份文件恢复：

```bash
cp CLAUDE.md.backup.2025-11-10 CLAUDE.md
```

但我们**强烈建议**使用新版，享受零风险升级体验。

### Q: 什么是版本追踪文件？

**A**: `.claude/workflow-version.json` 记录了工作流的版本历史，包括：
- 当前版本号
- 安装/升级时间
- 历史变更记录

您可以查看此文件了解工作流的升级历史。

### Q: 我需要更新其他文件吗？

**A**: 不需要。`initmc` 会自动更新所有必要的文件，包括：
- CLAUDE.md（内联式架构）
- .claude/commands/（命令文件）
- markdown/（通用文档）
- lib/（工具库）

---

## 🔍 排查问题

### 问题1：迁移后工作流不正常

**原因**：可能是 CLAUDE.md 格式错误

**解决**：
1. 检查三段标记是否完整
2. 查看 `.claude/workflow-version.json` 确认版本
3. 如有问题，从备份恢复后重新迁移

### 问题2：找不到备份文件

**原因**：可能是首次安装（无旧版文件）

**解决**：新安装无需备份，直接使用新版即可

### 问题3：自定义内容太多，不知道如何迁移

**原因**：旧版中混合了工作流和自定义内容

**解决**：
1. 对比备份文件和新版 CLAUDE.md
2. 只提取**明显不属于工作流**的内容
3. 工作流通用内容（CRITICAL规范、三步流程等）无需迁移

---

## 📚 参考资源

- [CLAUDE.md](../CLAUDE.md) - 工作流主文档
- [开发规范.md](./开发规范.md) - CRITICAL规范详解
- [上下文管理规范.md](./ai/上下文管理规范.md) - 内联式架构说明

---

**迁移完成后，享受零风险升级体验！** 🎉
