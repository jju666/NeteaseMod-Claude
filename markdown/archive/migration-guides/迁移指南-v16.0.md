# v16.0 迁移指南 - 双层文档架构

> 📚 **从 v15.x 升级到 v16.0 的完整迁移指南**
>
> **发布日期**: 2025-11-11
> **目标用户**: 所有使用"基于Claude的MODSDK开发工作流"的项目

---

## 🎯 v16.0 核心变更

### 架构升级：单层 → 双层

**v15.x 架构（单层）:**
```
markdown/
├─ 开发规范.md          (10+个核心文档)
├─ 问题排查.md
├─ 快速开始.md
├─ MODSDK核心概念.md
├─ API速查.md
├─ ... (更多核心文档)
├─ systems/            (项目System文档)
└─ 文档待补充清单.md    (项目跟踪)
```

**v16.0 架构（双层）:**
```
.claude/
├─ core-docs/           ⭐ 新增：上游基线层（软连接）
│  ├─ 开发规范.md @ → 上游
│  ├─ 问题排查.md @ → 上游
│  └─ ... (所有核心文档)
│
└─ workflow-manifest.json ⭐ 新增：版本追踪

markdown/
├─ README.md            ⭐ 新增：文档导航
├─ core/                ⭐ 新增：项目覆盖层（按需创建）
│  └─ 开发规范.md       (项目定制版)
├─ systems/             (项目System文档)
└─ 文档待补充清单.md    (项目跟踪)
```

---

## 🚀 自动迁移（推荐）

### 步骤1: 备份现有项目（可选）

```bash
# 进入项目目录
cd D:\MyMODProject

# 创建备份（如需要）
git add .
git commit -m "迁移前备份（v15.x）"
```

### 步骤2: 执行自动迁移

```bash
# 执行迁移（自动检测v15.x并升级到v16.0）
initmc

# 输出示例：
# [迁移] 检测到 v15.x 项目，开始迁移到 v16.0...
# [迁移] 分析文件定制状态...
# [迁移] 📦 备份当前文档到 .backup-v15/
# [迁移] 📝 迁移定制文档到 markdown/core/
# [迁移] 🧹 清理未定制文档（改为引用上游）
# [迁移] 📂 创建上游文档引用（.claude/core-docs/）
# [迁移] 📄 生成导航文档（markdown/README.md）
# [迁移] 📝 更新工作流元数据
# [迁移] ✅ 迁移完成！
```

### 步骤3: 验证迁移结果

```bash
# 检查目录结构
dir .claude\core-docs   # 应该看到软连接或只读副本
dir markdown\core       # 如有定制文档，应该在这里
dir markdown\README.md  # 应该有导航文档

# 验证文档内容
code markdown\README.md
```

---

## 🔍 迁移详细说明

### 文件分类逻辑

迁移工具会自动分析每个核心文档的定制状态：

**未定制文档（与上游一致）:**
- ✅ 删除本地副本
- ✅ 改为引用 `.claude/core-docs/`（软连接到上游）
- 💡 减少冗余，保持同步

**已定制文档（与上游不同）:**
- ✅ 移动到 `markdown/core/`
- ✅ 添加项目定制标记
- 💡 保留定制内容，AI优先读取

**判断依据**：
```javascript
// 计算文件哈希
const localHash = computeHash('markdown/开发规范.md');
const upstreamHash = computeHash('上游/templates/markdown/开发规范.md.template');

if (localHash === upstreamHash) {
  // 未定制，删除并引用上游
} else {
  // 已定制，迁移到markdown/core/
}
```

### 迁移流程图

```
检测v15.x项目
    ↓
分析文件定制状态（计算哈希）
    ↓
备份到.backup-v15/
    ↓
    ├─ 未定制文档 → 删除
    └─ 已定制文档 → 迁移到markdown/core/
    ↓
创建.claude/core-docs/（软连接到上游）
    ↓
生成markdown/README.md
    ↓
更新.claude/workflow-manifest.json
    ↓
✅ 迁移完成
```

---

## 📂 文件对照表

| v15.x 位置 | v16.0 位置 | 说明 |
|-----------|-----------|------|
| `markdown/开发规范.md` | `.claude/core-docs/开发规范.md`（未定制）<br>`markdown/core/开发规范.md`（已定制） | 智能分类 |
| `markdown/问题排查.md` | 同上 | 智能分类 |
| `markdown/快速开始.md` | 同上 | 智能分类 |
| `markdown/MODSDK核心概念.md` | 同上 | 智能分类 |
| `markdown/API速查.md` | 同上 | 智能分类 |
| `markdown/官方文档查询指南.md` | 同上 | 智能分类 |
| `markdown/ai/` | `.claude/core-docs/ai/` | 全部改为引用上游 |
| `markdown/systems/` | `markdown/systems/` | 保持不变 |
| `markdown/文档待补充清单.md` | `markdown/文档待补充清单.md` | 保持不变 |
| ❌ 不存在 | ✅ `markdown/README.md` | 新增导航文档 |
| ❌ 不存在 | ✅ `markdown/core/` | 新增覆盖层目录 |
| ❌ 不存在 | ✅ `.claude/workflow-manifest.json` | 新增版本追踪 |

---

## 🛠️ 手动迁移（不推荐）

如果自动迁移失败，可以手动执行以下步骤：

### 步骤1: 备份现有文档

```bash
mkdir .backup-v15
xcopy markdown .backup-v15\markdown /E /I /H
```

### 步骤2: 删除未定制的核心文档

```bash
# 如果你没有修改过这些文档，可以删除：
del markdown\开发规范.md
del markdown\问题排查.md
del markdown\快速开始.md
del markdown\MODSDK核心概念.md
del markdown\API速查.md
del markdown\官方文档查询指南.md
rmdir /s /q markdown\ai
```

### 步骤3: 迁移定制文档

```bash
# 如果你定制过某些文档，移动到markdown/core/
mkdir markdown\core
move markdown\开发规范.md markdown\core\开发规范.md
# （根据实际情况迁移其他定制文档）
```

### 步骤4: 创建上游文档引用

```bash
# 执行initmc会自动创建软连接
initmc --reset
```

---

## 🔄 后续升级流程

### v16.0 项目升级到更新版本

```bash
# 检查上游更新
initmc --sync

# 自动执行：
# 1. 检测版本（本地 vs 上游）
# 2. 更新软连接（.claude/core-docs/）
# 3. 检测覆盖层冲突
# 4. 清理废弃文件（带备份）
# 5. 更新manifest.json
```

---

## ⚙️ AI行为变更

### v15.x AI行为

```python
# AI直接读取markdown/目录
Read("markdown/开发规范.md")

# AI直接编辑markdown/目录
Edit("markdown/开发规范.md", ...)
```

### v16.0 AI行为（智能路由）

```python
# 层级1: 优先读取项目覆盖层
if exists("markdown/core/开发规范.md"):
    Read("markdown/core/开发规范.md")  # 📝 项目定制版
    标记: "项目定制版"

# 层级2: 回退到上游基线
else:
    Read(".claude/core-docs/开发规范.md")  # 📦 上游基线
    标记: "上游基线版本"

# 层级3: 项目特定文档
Read("markdown/systems/XXX系统.md")

# 自动创建覆盖层（编辑时）
if AI需要编辑核心文档 and not exists("markdown/core/开发规范.md"):
    复制(".claude/core-docs/开发规范.md" → "markdown/core/开发规范.md")
    添加定制标记
    编辑("markdown/core/开发规范.md")
```

---

## 🎯 预期效果对比

### 用户体验改进

| 指标 | v15.x | v16.0 | 改进幅度 |
|-----|-------|-------|---------|
| **文档数量**（markdown/） | 10-15个 | 3-5个 | -67% |
| **升级操作** | 手动复制 | `initmc --sync` | 自动化 |
| **定制成本** | 编辑后升级困难 | 覆盖层自动隔离 | 零风险 |
| **多项目共用** | 软连接易污染 | 完全隔离 | 100%安全 |
| **废弃文件清理** | 手动删除 | 自动检测+备份 | 自动化 |

### 技术指标

- ✅ **职责隔离**: 100%（多项目互不影响）
- ✅ **自动化程度**: 95%（仅覆盖层冲突需手动合并）
- ✅ **兼容性**: Windows/Linux/Mac全平台
- ✅ **向后兼容**: v15.x项目自动迁移

---

## ❓ 常见问题

### Q1: 迁移后我的定制内容会丢失吗？

**A**: 不会。迁移工具会：
1. 备份所有文件到 `.backup-v15/`
2. 自动识别定制文档并迁移到 `markdown/core/`
3. 添加定制标记，AI优先读取

### Q2: 如果我不想迁移怎么办？

**A**: v15.x项目可以继续使用，但无法获得v16.0的新特性：
- 无法使用 `initmc --sync` 自动同步
- 升级时需要手动处理冲突
- 不支持项目覆盖层机制

### Q3: 迁移失败怎么办？

**A**:
1. 检查 `.backup-v15/` 目录，确认备份存在
2. 执行 `initmc --reset` 强制重置
3. 如仍失败，手动恢复备份并联系开发者

### Q4: 如何回退到v15.x？

**A**:
```bash
# 删除v16.0生成的文件
rmdir /s /q .claude\core-docs
rmdir /s /q markdown\core
del markdown\README.md
del .claude\workflow-manifest.json

# 恢复备份
xcopy .backup-v15\markdown markdown /E /I /H

# 恢复CLAUDE.md（需要手动从v15.x模板获取）
```

### Q5: Windows无法创建软连接怎么办？

**A**: 迁移工具会自动降级为只读副本：
- 功能等同于软连接
- AI仍然能正常读取
- 文件头部有"只读"标记，引导用户复制到 `markdown/core/`

### Q6: 如何查看上游更新了哪些内容？

**A**:
```bash
# 对比上游与项目定制版
diff .claude\core-docs\开发规范.md markdown\core\开发规范.md

# 或在VSCode中对比
code --diff .claude\core-docs\开发规范.md markdown\core\开发规范.md

# 查看上游版本号
type .claude\workflow-manifest.json
```

---

## 📞 技术支持

如遇到迁移问题，请：

1. **检查备份**：`.backup-v15/` 目录应该包含所有旧文件
2. **查看日志**：迁移过程中的输出信息
3. **手动恢复**：从备份中恢复关键文件
4. **提交Issue**: 前往 GitHub Issues 反馈问题

---

## 📝 版本历史

- **v16.0** (2025-11-11): 双层文档架构发布
- **v15.1** (2025-11-10): 文档导航优化
- **v15.0** (2025-11-09): 内联式架构重构

---

_最后更新: 2025-11-11_
_文档版本: v16.0_
