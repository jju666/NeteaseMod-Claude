# ä¸šåŠ¡ç³»ç»Ÿå®ç°æ¡ˆä¾‹

> **ğŸ“ å¯¼èˆª**: [ğŸ  é¦–é¡µ](../README.md) > [ğŸ“‚ æ–‡æ¡£](../README.md#æ–‡æ¡£å¯¼èˆª) > ä¸šåŠ¡ç³»ç»Ÿå®ç°æ¡ˆä¾‹
>
> **æ–‡æ¡£è¯´æ˜**: é€šè¿‡å®æˆ˜æ¡ˆä¾‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨ECSæ¶æ„å®ç°å¤æ‚ä¸šåŠ¡åŠŸèƒ½
>
> **ğŸ“… æœ€åæ›´æ–°**: 2025-01-11
> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ ç›®å½•

1. [æ¡ˆä¾‹æ¦‚è¿°](#1-æ¡ˆä¾‹æ¦‚è¿°)
2. [æ¡ˆä¾‹1ï¼šå•†åŸç³»ç»Ÿ](#2-æ¡ˆä¾‹1å•†åŸç³»ç»Ÿ)
3. [æ¡ˆä¾‹2ï¼šæˆå°±ç³»ç»Ÿ](#3-æ¡ˆä¾‹2æˆå°±ç³»ç»Ÿ)
4. [æ¡ˆä¾‹3ï¼šå¥½å‹ç³»ç»Ÿ](#4-æ¡ˆä¾‹3å¥½å‹ç³»ç»Ÿ)
5. [æ¶æ„è®¾è®¡æ¨¡å¼æ€»ç»“](#5-æ¶æ„è®¾è®¡æ¨¡å¼æ€»ç»“)
6. [å¸¸è§é—®é¢˜FAQ](#6-å¸¸è§é—®é¢˜faq)

---

## 1. æ¡ˆä¾‹æ¦‚è¿°

### 1.1 å­¦ä¹ ç›®æ ‡

æœ¬æ–‡æ¡£é€šè¿‡**ä¸‰ä¸ªå…¸å‹ä¸šåŠ¡ç³»ç»Ÿ**çš„å®Œæ•´å®ç°æ¡ˆä¾‹ï¼Œå¸®åŠ©ä½ æŒæ¡ï¼š

- âœ… å¦‚ä½•å°†å¤æ‚ä¸šåŠ¡éœ€æ±‚æ‹†è§£ä¸ºECSæ¶æ„
- âœ… å¦‚ä½•è®¾è®¡åŒç«¯åä½œå’Œæ•°æ®åŒæ­¥
- âœ… å¦‚ä½•å®ç°å¯æ‰©å±•çš„ä¸šåŠ¡é€»è¾‘
- âœ… å¦‚ä½•åº”ç”¨MODSDKå¼€å‘æœ€ä½³å®è·µ

### 1.2 å‰ç½®çŸ¥è¯†

é˜…è¯»æœ¬æ–‡æ¡£å‰ï¼Œå»ºè®®å…ˆå­¦ä¹ ï¼š

- [å¼€å‘è§„èŒƒ.md](å¼€å‘è§„èŒƒ.md) - CRITICALè§„èŒƒå’ŒåŒç«¯éš”ç¦»åŸåˆ™
- [æ·±å…¥ç†è§£ECSæ¶æ„.md](æ·±å…¥ç†è§£ECSæ¶æ„.md) - System/Component/EntityåŸºç¡€
- [äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md](äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md) - äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ¨¡å¼
- [ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md](ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md) - åŒç«¯é€šä¿¡æœ€ä½³å®è·µ

### 1.3 æ¡ˆä¾‹é€‰æ‹©æ ‡å‡†

æœ¬æ–‡æ¡£é€‰æ‹©çš„ä¸‰ä¸ªæ¡ˆä¾‹å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

| æ¡ˆä¾‹ | å¤æ‚åº¦ | æ ¸å¿ƒæŠ€æœ¯ç‚¹ | å­¦ä¹ ä»·å€¼ |
|------|--------|-----------|---------|
| **å•†åŸç³»ç»Ÿ** | â­â­â­â­ | æ•°æ®åŒæ­¥ã€äº¤æ˜“éªŒè¯ã€UIäº¤äº’ | å­¦ä¹ æœåŠ¡å™¨æƒå¨ã€é˜²ä½œå¼Š |
| **æˆå°±ç³»ç»Ÿ** | â­â­â­ | äº‹ä»¶ç›‘å¬ã€è¿›åº¦è¿½è¸ªã€æ‰¹é‡ä¸ŠæŠ¥ | å­¦ä¹ æ€§èƒ½ä¼˜åŒ–ã€å¢é‡åŒæ­¥ |
| **å¥½å‹ç³»ç»Ÿ** | â­â­â­â­â­ | å¤šç©å®¶äº¤äº’ã€å®æ—¶é€šçŸ¥ã€å…³ç³»ç®¡ç† | å­¦ä¹ å¤æ‚çŠ¶æ€ç®¡ç† |

---

## 2. æ¡ˆä¾‹1ï¼šå•†åŸç³»ç»Ÿ

### 2.1 éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š
- ç©å®¶å¯ä»¥ä½¿ç”¨æ¸¸æˆå¸è´­ä¹°é“å…·
- æ”¯æŒå•†å“åˆ†ç±»ã€ä»·æ ¼é…ç½®ã€åº“å­˜ç®¡ç†
- è´­ä¹°è®°å½•æŒä¹…åŒ–å­˜å‚¨
- é˜²æ­¢å®¢æˆ·ç«¯ä½œå¼Šï¼ˆä»·æ ¼ç¯¡æ”¹ã€æ— é™è´­ä¹°ï¼‰

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- âœ… æœåŠ¡å™¨æƒå¨éªŒè¯ï¼ˆä»·æ ¼ã€åº“å­˜ã€ä½™é¢ï¼‰
- âœ… å®¢æˆ·ç«¯UIæµç•…å“åº”
- âœ… é…ç½®çƒ­æ›´æ–°ï¼ˆä¸é‡å¯ä¿®æ”¹å•†å“ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆç©å®¶è´­ä¹°å†å²ï¼‰

---

### 2.2 æ¶æ„è®¾è®¡

#### 2.2.1 åŒç«¯èŒè´£åˆ’åˆ†ï¼ˆåŸºäºCRITICALè§„èŒƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯ï¼ˆUIå±•ç¤ºï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ShopClientSystem                                        â”‚
â”‚ â”œâ”€â”€ ç›‘å¬UIäº‹ä»¶ï¼ˆç©å®¶ç‚¹å‡»è´­ä¹°æŒ‰é’®ï¼‰                        â”‚
â”‚ â”œâ”€â”€ å‘é€è´­ä¹°è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼ˆNotifyToServerï¼‰               â”‚
â”‚ â”œâ”€â”€ æ¥æ”¶æœåŠ¡ç«¯å“åº”ï¼ˆç›‘å¬PurchaseResultEventï¼‰            â”‚
â”‚ â””â”€â”€ æ›´æ–°UIæ˜¾ç¤ºï¼ˆä½™é¢ã€è´­ä¹°ç»“æœæç¤ºï¼‰                      â”‚
â”‚                                                         â”‚
â”‚ ShopUIComponent                                         â”‚
â”‚ â””â”€â”€ å­˜å‚¨UIçŠ¶æ€ï¼ˆå½“å‰é€‰ä¸­å•†å“IDã€é¡µç ç­‰ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â†•ï¸ (RPCé€šä¿¡)
              NotifyToServer("PurchaseRequest", ...)
              NotifyToClient("PurchaseResult", ...)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æœåŠ¡ç«¯ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ShopServerSystem                                        â”‚
â”‚ â”œâ”€â”€ ç›‘å¬è´­ä¹°è¯·æ±‚ï¼ˆListenForEvent "PurchaseRequest"ï¼‰     â”‚
â”‚ â”œâ”€â”€ éªŒè¯åˆæ³•æ€§ï¼ˆä»·æ ¼ã€åº“å­˜ã€ä½™é¢æ£€æŸ¥ï¼‰                    â”‚
â”‚ â”œâ”€â”€ æ‰£é™¤è´§å¸ + å‘æ”¾é“å…·                                  â”‚
â”‚ â”œâ”€â”€ è®°å½•è´­ä¹°å†å²ï¼ˆExtraDataæŒä¹…åŒ–ï¼‰                      â”‚
â”‚ â””â”€â”€ é€šçŸ¥å®¢æˆ·ç«¯ç»“æœï¼ˆNotifyToClient "PurchaseResult"ï¼‰   â”‚
â”‚                                                         â”‚
â”‚ ShopDataComponent                                       â”‚
â”‚ â””â”€â”€ å­˜å‚¨ç©å®¶å•†åŸæ•°æ®ï¼ˆä½™é¢ã€è´­ä¹°å†å²ï¼‰                    â”‚
â”‚                                                         â”‚
â”‚ ShopConfigManagerï¼ˆå•ä¾‹ç®¡ç†å™¨ç±»ï¼‰                        â”‚
â”‚ â””â”€â”€ åŠ è½½å•†å“é…ç½®ï¼ˆä»JSONæ–‡ä»¶è¯»å–ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… **æœåŠ¡å™¨æƒå¨**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡ç«¯éªŒè¯
- âœ… **å®¢æˆ·ç«¯è½»é‡**ï¼šä»…è´Ÿè´£UIå±•ç¤ºå’Œäº‹ä»¶è½¬å‘
- âœ… **é˜²ä½œå¼Š**ï¼šå®¢æˆ·ç«¯ä¸å­˜å‚¨ä»·æ ¼ã€åº“å­˜ç­‰æ•æ„Ÿæ•°æ®

---

### 2.3 å®Œæ•´ä»£ç å®ç°

#### 2.3.1 æœåŠ¡ç«¯Systemï¼ˆShopServerSystem.pyï¼‰

```python
# -*- coding: utf-8 -*-
"""
å•†åŸç³»ç»Ÿ - æœåŠ¡ç«¯System
èŒè´£ï¼šéªŒè¯è´­ä¹°è¯·æ±‚ã€å¤„ç†äº¤æ˜“ã€è®°å½•å†å²
"""

import mod.server.extraServerApi as serverApi
import json

ServerSystem = serverApi.GetServerSystemCls()

class ShopServerSystem(ServerSystem):
    """å•†åŸæœåŠ¡ç«¯System - å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘"""

    def __init__(self, namespace, systemName):
        super(ShopServerSystem, self).__init__(namespace, systemName)
        # è·å–ç»„ä»¶
        self.gameComp = serverApi.GetEngineCompFactory().CreateGame(serverApi.GetLevelId())
        self.itemComp = serverApi.GetEngineCompFactory().CreateItem(serverApi.GetLevelId())
        self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(serverApi.GetLevelId())

        # å•†å“é…ç½®ç®¡ç†å™¨
        self.shopConfig = None

        # ç›‘å¬äº‹ä»¶
        self.ListenForEvent(serverApi.GetEngineNamespace(), serverApi.GetEngineSystemName(),
                            'PlayerJoinServerEvent', self, self.OnPlayerJoin)
        self.ListenForEvent('ShopModNamespace', 'ShopModClientSystem',
                            'PurchaseRequestEvent', self, self.OnPurchaseRequest)

    def OnPlayerJoin(self, args):
        """ç©å®¶åŠ å…¥æœåŠ¡å™¨ - åˆå§‹åŒ–å•†åŸæ•°æ®"""
        playerId = args['playerId']

        # åˆå§‹åŒ–ç©å®¶å•†åŸæ•°æ®ï¼ˆå¦‚æœæ˜¯æ–°ç©å®¶ï¼‰
        shopData = self._GetPlayerShopData(playerId)
        if shopData is None:
            self._InitPlayerShopData(playerId)
            print("[ShopServer] åˆå§‹åŒ–ç©å®¶å•†åŸæ•°æ®:", playerId)

    def OnPurchaseRequest(self, args):
        """
        å¤„ç†è´­ä¹°è¯·æ±‚ï¼ˆæ¥è‡ªå®¢æˆ·ç«¯ï¼‰

        Args:
            args (dict): {
                'playerId': str,     # ç©å®¶ID
                'itemId': str,       # å•†å“ID
                'count': int         # è´­ä¹°æ•°é‡
            }
        """
        playerId = args['playerId']
        itemId = args['itemId']
        count = args.get('count', 1)

        print("[ShopServer] æ”¶åˆ°è´­ä¹°è¯·æ±‚:", playerId, itemId, count)

        # æ­¥éª¤1: è·å–å•†å“é…ç½®
        itemConfig = self._GetItemConfig(itemId)
        if itemConfig is None:
            self._SendPurchaseResult(playerId, False, "å•†å“ä¸å­˜åœ¨")
            return

        # æ­¥éª¤2: éªŒè¯åº“å­˜ï¼ˆå¦‚æœæœ‰é™åˆ¶ï¼‰
        if 'stock' in itemConfig:
            currentStock = self._GetItemStock(itemId)
            if currentStock < count:
                self._SendPurchaseResult(playerId, False, "åº“å­˜ä¸è¶³")
                return

        # æ­¥éª¤3: è®¡ç®—æ€»ä»·
        totalPrice = itemConfig['price'] * count

        # æ­¥éª¤4: æ£€æŸ¥ç©å®¶ä½™é¢
        playerBalance = self._GetPlayerBalance(playerId)
        if playerBalance < totalPrice:
            self._SendPurchaseResult(playerId, False, "ä½™é¢ä¸è¶³")
            return

        # æ­¥éª¤5: æ‰£é™¤è´§å¸
        newBalance = playerBalance - totalPrice
        self._SetPlayerBalance(playerId, newBalance)

        # æ­¥éª¤6: å‘æ”¾é“å…·
        success = self._GiveItemToPlayer(playerId, itemConfig['rewardItem'], count)
        if not success:
            # å›æ»šï¼šé€€è¿˜è´§å¸
            self._SetPlayerBalance(playerId, playerBalance)
            self._SendPurchaseResult(playerId, False, "å‘æ”¾é“å…·å¤±è´¥")
            return

        # æ­¥éª¤7: è®°å½•è´­ä¹°å†å²
        self._RecordPurchaseHistory(playerId, itemId, count, totalPrice)

        # æ­¥éª¤8: æ‰£å‡åº“å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if 'stock' in itemConfig:
            self._DecreaseItemStock(itemId, count)

        # æ­¥éª¤9: é€šçŸ¥å®¢æˆ·ç«¯æˆåŠŸ
        self._SendPurchaseResult(playerId, True, "è´­ä¹°æˆåŠŸ", newBalance)
        print("[ShopServer] è´­ä¹°æˆåŠŸ:", playerId, itemId, "å‰©ä½™ä½™é¢:", newBalance)

    # ==================== å†…éƒ¨æ–¹æ³• ====================

    def _GetItemConfig(self, itemId):
        """
        è·å–å•†å“é…ç½®

        Returns:
            dict: {
                'id': 'shop_sword_001',
                'name': 'é’»çŸ³å‰‘',
                'price': 100,
                'rewardItem': 'minecraft:diamond_sword',
                'stock': 10  # å¯é€‰å­—æ®µ
            }
        """
        if self.shopConfig is None:
            # ä»é…ç½®æ–‡ä»¶åŠ è½½å•†å“æ•°æ®
            self.shopConfig = self._LoadShopConfig()

        return self.shopConfig.get(itemId)

    def _LoadShopConfig(self):
        """
        åŠ è½½å•†å“é…ç½®ï¼ˆä»JSONæ–‡ä»¶ï¼‰

        å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»å¤–éƒ¨é…ç½®æ–‡ä»¶è¯»å–ï¼š
        config/shop_items.json
        """
        # ç¤ºä¾‹é…ç½®ï¼ˆå®é™…é¡¹ç›®åº”ä»æ–‡ä»¶è¯»å–ï¼‰
        return {
            'shop_sword_001': {
                'id': 'shop_sword_001',
                'name': 'é’»çŸ³å‰‘',
                'price': 100,
                'rewardItem': 'minecraft:diamond_sword'
            },
            'shop_apple_001': {
                'id': 'shop_apple_001',
                'name': 'é‡‘è‹¹æœ',
                'price': 50,
                'rewardItem': 'minecraft:golden_apple',
                'stock': 10  # é™é‡å•†å“
            }
        }

    def _GetPlayerShopData(self, playerId):
        """è·å–ç©å®¶å•†åŸæ•°æ®ï¼ˆä»ExtraDataï¼‰"""
        extraData = self.extraDataComp.GetExtraData(playerId, 'shop_data')
        if extraData:
            return json.loads(extraData)
        return None

    def _InitPlayerShopData(self, playerId):
        """åˆå§‹åŒ–ç©å®¶å•†åŸæ•°æ®"""
        shopData = {
            'balance': 1000,  # åˆå§‹ä½™é¢
            'purchaseHistory': []
        }
        self.extraDataComp.SetExtraData(playerId, 'shop_data', json.dumps(shopData))

    def _GetPlayerBalance(self, playerId):
        """è·å–ç©å®¶ä½™é¢"""
        shopData = self._GetPlayerShopData(playerId)
        if shopData:
            return shopData.get('balance', 0)
        return 0

    def _SetPlayerBalance(self, playerId, newBalance):
        """è®¾ç½®ç©å®¶ä½™é¢"""
        shopData = self._GetPlayerShopData(playerId)
        if shopData:
            shopData['balance'] = newBalance
            self.extraDataComp.SetExtraData(playerId, 'shop_data', json.dumps(shopData))

    def _GiveItemToPlayer(self, playerId, itemName, count):
        """
        å‘æ”¾é“å…·ç»™ç©å®¶

        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        # ä½¿ç”¨å¼•æ“Componentç»™äºˆç‰©å“
        success = self.itemComp.SpawnItemToPlayerInv(
            itemDict={'itemName': itemName, 'count': count},
            playerId=playerId,
            slotPos=-1  # -1è¡¨ç¤ºè‡ªåŠ¨å¯»æ‰¾ç©ºä½
        )
        return success

    def _RecordPurchaseHistory(self, playerId, itemId, count, totalPrice):
        """è®°å½•è´­ä¹°å†å²"""
        shopData = self._GetPlayerShopData(playerId)
        if shopData:
            # æ·»åŠ è´­ä¹°è®°å½•
            record = {
                'itemId': itemId,
                'count': count,
                'price': totalPrice,
                'timestamp': self.gameComp.GetGameTime()  # ä½¿ç”¨æ¸¸æˆæ—¶é—´
            }
            shopData['purchaseHistory'].append(record)

            # é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆé¿å…æ•°æ®è¿‡å¤§ï¼‰
            if len(shopData['purchaseHistory']) > 100:
                shopData['purchaseHistory'] = shopData['purchaseHistory'][-100:]

            self.extraDataComp.SetExtraData(playerId, 'shop_data', json.dumps(shopData))

    def _GetItemStock(self, itemId):
        """è·å–å•†å“åº“å­˜ï¼ˆä»å…¨å±€ExtraDataï¼‰"""
        levelId = serverApi.GetLevelId()
        stockData = self.extraDataComp.GetExtraData(levelId, 'shop_stock')
        if stockData:
            stockDict = json.loads(stockData)
            return stockDict.get(itemId, 0)
        return 0

    def _DecreaseItemStock(self, itemId, count):
        """å‡å°‘å•†å“åº“å­˜"""
        levelId = serverApi.GetLevelId()
        stockData = self.extraDataComp.GetExtraData(levelId, 'shop_stock')

        stockDict = {}
        if stockData:
            stockDict = json.loads(stockData)

        currentStock = stockDict.get(itemId, 0)
        stockDict[itemId] = max(0, currentStock - count)

        self.extraDataComp.SetExtraData(levelId, 'shop_stock', json.dumps(stockDict))

    def _SendPurchaseResult(self, playerId, success, message, newBalance=None):
        """é€šçŸ¥å®¢æˆ·ç«¯è´­ä¹°ç»“æœ"""
        eventData = {
            'playerId': playerId,
            'success': success,
            'message': message
        }
        if newBalance is not None:
            eventData['newBalance'] = newBalance

        # å‘é€äº‹ä»¶åˆ°æŒ‡å®šå®¢æˆ·ç«¯
        self.NotifyToClient(playerId, 'PurchaseResultEvent', eventData)
```

---

#### 2.3.2 å®¢æˆ·ç«¯Systemï¼ˆShopClientSystem.pyï¼‰

```python
# -*- coding: utf-8 -*-
"""
å•†åŸç³»ç»Ÿ - å®¢æˆ·ç«¯System
èŒè´£ï¼šUIäº¤äº’ã€å‘é€è¯·æ±‚ã€æ˜¾ç¤ºç»“æœ
"""

import mod.client.extraClientApi as clientApi

ClientSystem = clientApi.GetClientSystemCls()

class ShopClientSystem(ClientSystem):
    """å•†åŸå®¢æˆ·ç«¯System - ä»…è´Ÿè´£UIé€»è¾‘"""

    def __init__(self, namespace, systemName):
        super(ShopClientSystem, self).__init__(namespace, systemName)

        # UIå®ä¾‹ï¼ˆåœ¨å®é™…é¡¹ç›®ä¸­åº”ä»ScreenNodeè·å–ï¼‰
        self.shopUI = None

        # ç›‘å¬æœåŠ¡ç«¯å“åº”
        self.ListenForEvent('ShopModNamespace', 'ShopModServerSystem',
                            'PurchaseResultEvent', self, self.OnPurchaseResult)

    def OnPurchaseResult(self, args):
        """
        æ¥æ”¶æœåŠ¡ç«¯è´­ä¹°ç»“æœ

        Args:
            args (dict): {
                'success': bool,
                'message': str,
                'newBalance': int  # å¯é€‰
            }
        """
        success = args['success']
        message = args['message']

        if success:
            newBalance = args.get('newBalance', 0)
            print("[ShopClient] è´­ä¹°æˆåŠŸ! å‰©ä½™ä½™é¢:", newBalance)

            # æ›´æ–°UIæ˜¾ç¤º
            if self.shopUI:
                self.shopUI.UpdateBalance(newBalance)
                self.shopUI.ShowSuccessMessage(message)
        else:
            print("[ShopClient] è´­ä¹°å¤±è´¥:", message)

            # æ˜¾ç¤ºé”™è¯¯æç¤º
            if self.shopUI:
                self.shopUI.ShowErrorMessage(message)

    def RequestPurchase(self, itemId, count=1):
        """
        ç©å®¶ç‚¹å‡»è´­ä¹°æŒ‰é’®æ—¶è°ƒç”¨

        Args:
            itemId (str): å•†å“ID
            count (int): è´­ä¹°æ•°é‡
        """
        playerId = clientApi.GetLocalPlayerId()

        eventData = {
            'playerId': playerId,
            'itemId': itemId,
            'count': count
        }

        # å‘é€è´­ä¹°è¯·æ±‚åˆ°æœåŠ¡ç«¯
        self.NotifyToServer('PurchaseRequestEvent', eventData)
        print("[ShopClient] å‘é€è´­ä¹°è¯·æ±‚:", itemId, count)

        # æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if self.shopUI:
            self.shopUI.ShowLoadingState()
```

---

### 2.4 å…³é”®æŠ€æœ¯ç‚¹è§£æ

#### 2.4.1 æœåŠ¡å™¨æƒå¨éªŒè¯

**ä¸ºä»€ä¹ˆé‡è¦**ï¼šé˜²æ­¢å®¢æˆ·ç«¯ä½œå¼Šï¼ˆä¿®æ”¹ä»·æ ¼ã€ä¼ªé€ è´­ä¹°ï¼‰

**å®ç°æ–¹å¼**ï¼š
```python
# âœ… æ­£ç¡®åšæ³•ï¼šæœåŠ¡ç«¯ä»é…ç½®è¯»å–ä»·æ ¼
itemConfig = self._GetItemConfig(itemId)
totalPrice = itemConfig['price'] * count  # æœåŠ¡ç«¯è®¡ç®—

# âŒ é”™è¯¯åšæ³•ï¼šå®¢æˆ·ç«¯ä¼ é€’ä»·æ ¼
# totalPrice = args['price']  # å®¢æˆ·ç«¯å¯ç¯¡æ”¹ï¼
```

#### 2.4.2 äº‹åŠ¡å›æ»šæœºåˆ¶

**åœºæ™¯**ï¼šæ‰£è´¹æˆåŠŸä½†å‘æ”¾é“å…·å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ‰£é™¤è´§å¸
newBalance = playerBalance - totalPrice
self._SetPlayerBalance(playerId, newBalance)

# å‘æ”¾é“å…·
success = self._GiveItemToPlayer(playerId, itemConfig['rewardItem'], count)
if not success:
    # å›æ»šï¼šé€€è¿˜è´§å¸
    self._SetPlayerBalance(playerId, playerBalance)
    return
```

#### 2.4.3 æ•°æ®æŒä¹…åŒ–ç­–ç•¥

**ä½¿ç”¨ExtraDataå­˜å‚¨ç©å®¶æ•°æ®**ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨Key | ä½œç”¨åŸŸ | ç¤ºä¾‹ |
|---------|---------|--------|------|
| ç©å®¶ä½™é¢/å†å² | `shop_data` | å•ä¸ªç©å®¶ | `{"balance": 1000, "purchaseHistory": [...]}` |
| å…¨å±€åº“å­˜ | `shop_stock` | æ•´ä¸ªä¸–ç•Œ | `{"shop_sword_001": 50}` |

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆå¦‚æœ€å¤šä¿ç•™100æ¡ï¼‰
- âœ… ä½¿ç”¨JSONåºåˆ—åŒ–å­˜å‚¨å¤æ‚æ•°æ®
- âœ… é¿å…é¢‘ç¹è¯»å†™ï¼ˆç¼“å­˜åœ¨å†…å­˜ä¸­ï¼‰

---

## 3. æ¡ˆä¾‹2ï¼šæˆå°±ç³»ç»Ÿ

### 3.1 éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š
- ç©å®¶å®Œæˆç‰¹å®šä»»åŠ¡è§£é”æˆå°±ï¼ˆå¦‚"å‡»æ€100åªåƒµå°¸"ï¼‰
- æˆå°±è¿›åº¦å®æ—¶è¿½è¸ª
- è¾¾æˆæ—¶æ˜¾ç¤ºé€šçŸ¥
- æˆå°±æ•°æ®æŒä¹…åŒ–

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…æ¯æ¬¡å‡»æ€éƒ½è§¦å‘äº‹ä»¶ï¼‰
- âœ… å¢é‡åŒæ­¥ï¼ˆä»…ä¸ŠæŠ¥å˜åŒ–çš„æˆå°±ï¼‰
- âœ… æ‰¹é‡å¤„ç†ï¼ˆå‡å°‘ç½‘ç»œè¯·æ±‚ï¼‰

---

### 3.2 æ¶æ„è®¾è®¡

```
å®¢æˆ·ç«¯ï¼šç›‘å¬æˆå°±è¾¾æˆ â†’ æ˜¾ç¤ºUIé€šçŸ¥

æœåŠ¡ç«¯ï¼š
â”œâ”€â”€ ç›‘å¬æ¸¸æˆäº‹ä»¶ï¼ˆEntityDieEventç­‰ï¼‰
â”œâ”€â”€ æ›´æ–°æˆå°±è¿›åº¦ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
â”œâ”€â”€ æ‰¹é‡ä¸ŠæŠ¥ï¼ˆ5ç§’å†·å´ï¼‰
â””â”€â”€ æŒä¹…åŒ–å­˜å‚¨ï¼ˆExtraDataï¼‰
```

---

### 3.3 å®Œæ•´ä»£ç å®ç°

#### 3.3.1 æœåŠ¡ç«¯Systemï¼ˆAchievementServerSystem.pyï¼‰

```python
# -*- coding: utf-8 -*-
"""
æˆå°±ç³»ç»Ÿ - æœåŠ¡ç«¯System
èŒè´£ï¼šç›‘å¬æ¸¸æˆäº‹ä»¶ã€è¿½è¸ªè¿›åº¦ã€æ‰¹é‡ä¸ŠæŠ¥
"""

import mod.server.extraServerApi as serverApi
import json

ServerSystem = serverApi.GetServerSystemCls()

class AchievementServerSystem(ServerSystem):
    """æˆå°±æœåŠ¡ç«¯System - è¿›åº¦è¿½è¸ªå’ŒéªŒè¯"""

    def __init__(self, namespace, systemName):
        super(AchievementServerSystem, self).__init__(namespace, systemName)
        self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(serverApi.GetLevelId())

        # æˆå°±è¿›åº¦ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è¯»å†™ExtraDataï¼‰
        # æ ¼å¼: {playerId: {achievementId: currentProgress}}
        self.progressCache = {}

        # å¾…ä¸ŠæŠ¥çš„æˆå°±åˆ—è¡¨ï¼ˆæ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼‰
        # æ ¼å¼: {playerId: set([achievementId1, achievementId2])}
        self.pendingAchievements = {}

        # æˆå°±é…ç½®
        self.achievementConfig = self._LoadAchievementConfig()

        # ç›‘å¬æ¸¸æˆäº‹ä»¶
        self.ListenForEvent(serverApi.GetEngineNamespace(), serverApi.GetEngineSystemName(),
                            'EntityDieEvent', self, self.OnEntityDie)
        self.ListenForEvent(serverApi.GetEngineNamespace(), serverApi.GetEngineSystemName(),
                            'PlayerJoinServerEvent', self, self.OnPlayerJoin)

        # å®šæ—¶å™¨ï¼šæ¯5ç§’æ‰¹é‡ä¸ŠæŠ¥æˆå°±
        self.CreateTimer(5.0, self.BatchReportAchievements)

    def OnPlayerJoin(self, args):
        """ç©å®¶åŠ å…¥ - åŠ è½½æˆå°±æ•°æ®åˆ°ç¼“å­˜"""
        playerId = args['playerId']
        self._LoadPlayerAchievements(playerId)

    def OnEntityDie(self, args):
        """å®ä½“æ­»äº¡äº‹ä»¶ - æ›´æ–°"å‡»æ€æ€ªç‰©"ç±»æˆå°±"""
        killerId = args.get('attacker')
        if not killerId:
            return

        # æ£€æŸ¥å‡»æ€è€…æ˜¯å¦ä¸ºç©å®¶
        playerComp = serverApi.GetEngineCompFactory().CreatePlayer(killerId)
        if not playerComp.isEntityPlayer():
            return

        victimId = args['id']
        victimTypeComp = serverApi.GetEngineCompFactory().CreateEngineType(victimId)
        victimType = victimTypeComp.GetEngineTypeStr()

        # æ›´æ–°æˆå°±è¿›åº¦
        if victimType == 'minecraft:zombie':
            self._IncrementAchievement(killerId, 'kill_zombie_100', 1)
        elif victimType == 'minecraft:skeleton':
            self._IncrementAchievement(killerId, 'kill_skeleton_50', 1)

    def _IncrementAchievement(self, playerId, achievementId, increment=1):
        """
        å¢åŠ æˆå°±è¿›åº¦

        Args:
            playerId (str): ç©å®¶ID
            achievementId (str): æˆå°±ID
            increment (int): å¢åŠ çš„è¿›åº¦å€¼
        """
        # è·å–æˆå°±é…ç½®
        config = self.achievementConfig.get(achievementId)
        if not config:
            return

        # ç¡®ä¿ç©å®¶ç¼“å­˜å­˜åœ¨
        if playerId not in self.progressCache:
            self.progressCache[playerId] = {}

        # è·å–å½“å‰è¿›åº¦
        currentProgress = self.progressCache[playerId].get(achievementId, 0)
        targetProgress = config['target']

        # æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
        if currentProgress >= targetProgress:
            return  # å·²è¾¾æˆï¼Œä¸å†æ›´æ–°

        # æ›´æ–°è¿›åº¦
        newProgress = min(currentProgress + increment, targetProgress)
        self.progressCache[playerId][achievementId] = newProgress

        # æ£€æŸ¥æ˜¯å¦è¾¾æˆ
        if newProgress >= targetProgress:
            self._UnlockAchievement(playerId, achievementId)

    def _UnlockAchievement(self, playerId, achievementId):
        """
        è§£é”æˆå°±ï¼ˆè¾¾æˆæ—¶è°ƒç”¨ï¼‰

        Args:
            playerId (str): ç©å®¶ID
            achievementId (str): æˆå°±ID
        """
        print("[Achievement] ç©å®¶è¾¾æˆæˆå°±:", playerId, achievementId)

        # æ·»åŠ åˆ°å¾…ä¸ŠæŠ¥åˆ—è¡¨ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
        if playerId not in self.pendingAchievements:
            self.pendingAchievements[playerId] = set()
        self.pendingAchievements[playerId].add(achievementId)

        # å‘æ”¾å¥–åŠ±ï¼ˆå¦‚æœæœ‰ï¼‰
        config = self.achievementConfig.get(achievementId)
        if config and 'reward' in config:
            self._GiveReward(playerId, config['reward'])

    def BatchReportAchievements(self):
        """
        æ‰¹é‡ä¸ŠæŠ¥æˆå°±ï¼ˆæ¯5ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
        æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°
        """
        if not self.pendingAchievements:
            return  # æ²¡æœ‰å¾…ä¸ŠæŠ¥çš„æˆå°±

        for playerId, achievementSet in self.pendingAchievements.items():
            if not achievementSet:
                continue

            # é€šçŸ¥å®¢æˆ·ç«¯æ˜¾ç¤ºæˆå°±è¾¾æˆUI
            eventData = {
                'playerId': playerId,
                'achievements': list(achievementSet)
            }
            self.NotifyToClient(playerId, 'AchievementUnlockedEvent', eventData)

            # æŒä¹…åŒ–å­˜å‚¨
            self._SavePlayerAchievements(playerId)

        # æ¸…ç©ºå¾…ä¸ŠæŠ¥åˆ—è¡¨
        self.pendingAchievements.clear()

        # é‡æ–°åˆ›å»ºå®šæ—¶å™¨ï¼ˆç»§ç»­ä¸‹ä¸€è½®ï¼‰
        self.CreateTimer(5.0, self.BatchReportAchievements)

    # ==================== æ•°æ®æŒä¹…åŒ– ====================

    def _LoadPlayerAchievements(self, playerId):
        """ä»ExtraDataåŠ è½½ç©å®¶æˆå°±æ•°æ®åˆ°ç¼“å­˜"""
        extraData = self.extraDataComp.GetExtraData(playerId, 'achievements')
        if extraData:
            self.progressCache[playerId] = json.loads(extraData)
        else:
            self.progressCache[playerId] = {}

    def _SavePlayerAchievements(self, playerId):
        """ä¿å­˜ç©å®¶æˆå°±æ•°æ®åˆ°ExtraData"""
        if playerId in self.progressCache:
            data = json.dumps(self.progressCache[playerId])
            self.extraDataComp.SetExtraData(playerId, 'achievements', data)

    def _LoadAchievementConfig(self):
        """
        åŠ è½½æˆå°±é…ç½®

        Returns:
            dict: {
                'kill_zombie_100': {
                    'id': 'kill_zombie_100',
                    'name': 'åƒµå°¸æ€æ‰‹',
                    'target': 100,
                    'reward': {'itemName': 'minecraft:diamond', 'count': 5}
                },
                ...
            }
        """
        return {
            'kill_zombie_100': {
                'id': 'kill_zombie_100',
                'name': 'åƒµå°¸æ€æ‰‹',
                'description': 'å‡»æ€100åªåƒµå°¸',
                'target': 100,
                'reward': {'itemName': 'minecraft:diamond', 'count': 5}
            },
            'kill_skeleton_50': {
                'id': 'kill_skeleton_50',
                'name': 'éª·é«…å…‹æ˜Ÿ',
                'description': 'å‡»æ€50åªéª·é«…',
                'target': 50,
                'reward': {'itemName': 'minecraft:emerald', 'count': 3}
            }
        }

    def _GiveReward(self, playerId, reward):
        """å‘æ”¾æˆå°±å¥–åŠ±"""
        itemComp = serverApi.GetEngineCompFactory().CreateItem(serverApi.GetLevelId())
        itemComp.SpawnItemToPlayerInv(
            itemDict={'itemName': reward['itemName'], 'count': reward['count']},
            playerId=playerId,
            slotPos=-1
        )
        print("[Achievement] å‘æ”¾å¥–åŠ±:", playerId, reward)
```

---

#### 3.3.2 å®¢æˆ·ç«¯Systemï¼ˆAchievementClientSystem.pyï¼‰

```python
# -*- coding: utf-8 -*-
"""
æˆå°±ç³»ç»Ÿ - å®¢æˆ·ç«¯System
èŒè´£ï¼šæ˜¾ç¤ºæˆå°±è¾¾æˆUIé€šçŸ¥
"""

import mod.client.extraClientApi as clientApi

ClientSystem = clientApi.GetClientSystemCls()

class AchievementClientSystem(ClientSystem):
    """æˆå°±å®¢æˆ·ç«¯System - UIé€šçŸ¥"""

    def __init__(self, namespace, systemName):
        super(AchievementClientSystem, self).__init__(namespace, systemName)

        # ç›‘å¬æœåŠ¡ç«¯æˆå°±è¾¾æˆäº‹ä»¶
        self.ListenForEvent('AchievementModNamespace', 'AchievementModServerSystem',
                            'AchievementUnlockedEvent', self, self.OnAchievementUnlocked)

    def OnAchievementUnlocked(self, args):
        """
        æ¥æ”¶æœåŠ¡ç«¯æˆå°±è¾¾æˆé€šçŸ¥

        Args:
            args (dict): {
                'achievements': list[str]  # æˆå°±IDåˆ—è¡¨
            }
        """
        achievements = args['achievements']

        for achievementId in achievements:
            print("[AchievementClient] æˆå°±è¾¾æˆ:", achievementId)
            # å®é™…é¡¹ç›®ä¸­åº”è¯¥ï¼š
            # 1. æ’­æ”¾éŸ³æ•ˆ
            # 2. æ˜¾ç¤ºå¼¹çª—UI
            # 3. æ›´æ–°æˆå°±åˆ—è¡¨ç•Œé¢
```

---

### 3.4 å…³é”®æŠ€æœ¯ç‚¹è§£æ

#### 3.4.1 æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡ä¸ŠæŠ¥æœºåˆ¶

**é—®é¢˜**ï¼šå¦‚æœç©å®¶è¿ç»­å‡»æ€10åªåƒµå°¸ï¼Œä¼šè§¦å‘10æ¬¡ç½‘ç»œè¯·æ±‚ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šæ‰¹é‡ä¸ŠæŠ¥ï¼ˆæ¯5ç§’æ”¶é›†ä¸€æ¬¡ï¼‰

```python
# æ·»åŠ åˆ°å¾…ä¸ŠæŠ¥åˆ—è¡¨
self.pendingAchievements[playerId].add(achievementId)

# å®šæ—¶å™¨æ¯5ç§’æ‰¹é‡ä¸ŠæŠ¥
def BatchReportAchievements(self):
    for playerId, achievementSet in self.pendingAchievements.items():
        # ä¸€æ¬¡æ€§å‘é€å¤šä¸ªæˆå°±
        self.NotifyToClient(playerId, 'AchievementUnlockedEvent', {
            'achievements': list(achievementSet)
        })
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| åœºæ™¯ | ä¸ä½¿ç”¨æ‰¹é‡ | ä½¿ç”¨æ‰¹é‡ï¼ˆ5ç§’ï¼‰ | ä¼˜åŒ–æ•ˆæœ |
|------|-----------|---------------|---------|
| 10ç§’å†…å‡»æ€20åªåƒµå°¸ | 20æ¬¡RPCè¯·æ±‚ | 2æ¬¡RPCè¯·æ±‚ | å‡å°‘90% |

#### 3.4.2 å†…å­˜ç¼“å­˜ç­–ç•¥

**ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜**ï¼š
- âŒ æ¯æ¬¡å‡»æ€éƒ½è¯»å†™ExtraData â†’ æ€§èƒ½å·®
- âœ… å°†è¿›åº¦ç¼“å­˜åœ¨å†…å­˜ â†’ å¿«é€Ÿè®¿é—®

```python
# å†…å­˜ç¼“å­˜
self.progressCache = {
    'player_001': {
        'kill_zombie_100': 45,  # å½“å‰è¿›åº¦
        'kill_skeleton_50': 12
    }
}

# å®šæœŸæŒä¹…åŒ–åˆ°ExtraDataï¼ˆæ‰¹é‡ä¸ŠæŠ¥æ—¶ï¼‰
self._SavePlayerAchievements(playerId)
```

---

## 4. æ¡ˆä¾‹3ï¼šå¥½å‹ç³»ç»Ÿ

### 4.1 éœ€æ±‚åˆ†æ

**ä¸šåŠ¡éœ€æ±‚**ï¼š
- ç©å®¶å¯ä»¥æ·»åŠ /åˆ é™¤å¥½å‹
- æŸ¥çœ‹å¥½å‹åœ¨çº¿çŠ¶æ€
- å‘å¥½å‹å‘é€æ¶ˆæ¯/é‚€è¯·ç»„é˜Ÿ
- å¥½å‹å…³ç³»æŒä¹…åŒ–

**æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- âœ… å¤šç©å®¶çŠ¶æ€åŒæ­¥ï¼ˆå¥½å‹ä¸Šçº¿/ä¸‹çº¿é€šçŸ¥ï¼‰
- âœ… åŒå‘å…³ç³»ç®¡ç†ï¼ˆAæ·»åŠ Bï¼ŒBä¹Ÿè¦çŸ¥é“ï¼‰
- âœ… è·¨æœåŠ¡å™¨æŸ¥è¯¢ï¼ˆå¥½å‹å¯èƒ½åœ¨ä¸åŒæœåŠ¡å™¨ï¼‰

---

### 4.2 æ¶æ„è®¾è®¡

```
æœåŠ¡ç«¯ï¼š
â”œâ”€â”€ FriendServerSystem - å¥½å‹å…³ç³»ç®¡ç†
â”œâ”€â”€ FriendDataComponent - å­˜å‚¨ç©å®¶å¥½å‹åˆ—è¡¨
â””â”€â”€ ç›‘å¬ç©å®¶ä¸Šçº¿/ä¸‹çº¿ â†’ é€šçŸ¥æ‰€æœ‰å¥½å‹

å®¢æˆ·ç«¯ï¼š
â”œâ”€â”€ FriendClientSystem - UIäº¤äº’
â””â”€â”€ FriendUIComponent - å¥½å‹åˆ—è¡¨UIçŠ¶æ€
```

---

### 4.3 æ ¸å¿ƒä»£ç å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

#### 4.3.1 æœåŠ¡ç«¯Systemï¼ˆFriendServerSystem.pyï¼‰

```python
# -*- coding: utf-8 -*-
"""
å¥½å‹ç³»ç»Ÿ - æœåŠ¡ç«¯System
èŒè´£ï¼šå¥½å‹å…³ç³»ç®¡ç†ã€çŠ¶æ€åŒæ­¥
"""

import mod.server.extraServerApi as serverApi
import json

ServerSystem = serverApi.GetServerSystemCls()

class FriendServerSystem(ServerSystem):
    """å¥½å‹æœåŠ¡ç«¯System"""

    def __init__(self, namespace, systemName):
        super(FriendServerSystem, self).__init__(namespace, systemName)
        self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(serverApi.GetLevelId())

        # åœ¨çº¿ç©å®¶ç¼“å­˜ï¼ˆå¿«é€ŸæŸ¥è¯¢åœ¨çº¿çŠ¶æ€ï¼‰
        self.onlinePlayers = set()

        # ç›‘å¬äº‹ä»¶
        self.ListenForEvent(serverApi.GetEngineNamespace(), serverApi.GetEngineSystemName(),
                            'PlayerJoinServerEvent', self, self.OnPlayerJoin)
        self.ListenForEvent(serverApi.GetEngineNamespace(), serverApi.GetEngineSystemName(),
                            'PlayerLeftServerEvent', self, self.OnPlayerLeave)
        self.ListenForEvent('FriendModNamespace', 'FriendModClientSystem',
                            'AddFriendRequestEvent', self, self.OnAddFriendRequest)

    def OnPlayerJoin(self, args):
        """ç©å®¶ä¸Šçº¿ - é€šçŸ¥æ‰€æœ‰å¥½å‹"""
        playerId = args['playerId']
        self.onlinePlayers.add(playerId)

        # è·å–è¯¥ç©å®¶çš„å¥½å‹åˆ—è¡¨
        friendList = self._GetFriendList(playerId)

        # é€šçŸ¥æ‰€æœ‰åœ¨çº¿å¥½å‹ï¼š"XXXä¸Šçº¿äº†"
        for friendId in friendList:
            if friendId in self.onlinePlayers:
                self.NotifyToClient(friendId, 'FriendOnlineEvent', {
                    'friendId': playerId
                })

    def OnPlayerLeave(self, args):
        """ç©å®¶ä¸‹çº¿ - é€šçŸ¥æ‰€æœ‰å¥½å‹"""
        playerId = args['playerId']
        self.onlinePlayers.discard(playerId)

        # é€šçŸ¥æ‰€æœ‰åœ¨çº¿å¥½å‹ï¼š"XXXä¸‹çº¿äº†"
        friendList = self._GetFriendList(playerId)
        for friendId in friendList:
            if friendId in self.onlinePlayers:
                self.NotifyToClient(friendId, 'FriendOfflineEvent', {
                    'friendId': playerId
                })

    def OnAddFriendRequest(self, args):
        """
        å¤„ç†æ·»åŠ å¥½å‹è¯·æ±‚

        Args:
            args (dict): {
                'playerId': str,      # è¯·æ±‚è€…
                'targetPlayerId': str # ç›®æ ‡ç©å®¶
            }
        """
        playerId = args['playerId']
        targetPlayerId = args['targetPlayerId']

        # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
        friendList = self._GetFriendList(playerId)
        if targetPlayerId in friendList:
            self._SendAddFriendResult(playerId, False, "å·²ç»æ˜¯å¥½å‹äº†")
            return

        # æ£€æŸ¥å¥½å‹æ•°é‡ä¸Šé™
        if len(friendList) >= 100:
            self._SendAddFriendResult(playerId, False, "å¥½å‹æ•°é‡å·²è¾¾ä¸Šé™")
            return

        # æ·»åŠ å¥½å‹ï¼ˆåŒå‘å…³ç³»ï¼‰
        self._AddFriend(playerId, targetPlayerId)
        self._AddFriend(targetPlayerId, playerId)

        # é€šçŸ¥åŒæ–¹
        self._SendAddFriendResult(playerId, True, "æ·»åŠ å¥½å‹æˆåŠŸ")
        self.NotifyToClient(targetPlayerId, 'NewFriendAddedEvent', {
            'friendId': playerId
        })

        print("[Friend] å¥½å‹å…³ç³»å»ºç«‹:", playerId, "<->", targetPlayerId)

    # ==================== å†…éƒ¨æ–¹æ³• ====================

    def _GetFriendList(self, playerId):
        """
        è·å–ç©å®¶å¥½å‹åˆ—è¡¨

        Returns:
            list[str]: å¥½å‹IDåˆ—è¡¨
        """
        extraData = self.extraDataComp.GetExtraData(playerId, 'friend_list')
        if extraData:
            return json.loads(extraData)
        return []

    def _AddFriend(self, playerId, friendId):
        """æ·»åŠ å¥½å‹ï¼ˆå•å‘ï¼‰"""
        friendList = self._GetFriendList(playerId)
        if friendId not in friendList:
            friendList.append(friendId)
            self.extraDataComp.SetExtraData(playerId, 'friend_list', json.dumps(friendList))

    def _SendAddFriendResult(self, playerId, success, message):
        """é€šçŸ¥å®¢æˆ·ç«¯æ·»åŠ å¥½å‹ç»“æœ"""
        self.NotifyToClient(playerId, 'AddFriendResultEvent', {
            'success': success,
            'message': message
        })
```

---

### 4.4 å…³é”®æŠ€æœ¯ç‚¹è§£æ

#### 4.4.1 åŒå‘å…³ç³»ç®¡ç†

**é—®é¢˜**ï¼šAæ·»åŠ Bä¸ºå¥½å‹ï¼ŒBä¹Ÿéœ€è¦çœ‹åˆ°Aï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šåŒå‘æ·»åŠ 
```python
# æ·»åŠ åŒå‘å…³ç³»
self._AddFriend(playerId, targetPlayerId)  # Açš„å¥½å‹åˆ—è¡¨æ·»åŠ B
self._AddFriend(targetPlayerId, playerId)  # Bçš„å¥½å‹åˆ—è¡¨æ·»åŠ A
```

#### 4.4.2 åœ¨çº¿çŠ¶æ€ç¼“å­˜

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼šå¿«é€ŸæŸ¥è¯¢å¥½å‹æ˜¯å¦åœ¨çº¿

```python
# ä½¿ç”¨é›†åˆç¼“å­˜åœ¨çº¿ç©å®¶
self.onlinePlayers = {'player_001', 'player_002'}

# O(1)æ—¶é—´å¤æ‚åº¦æŸ¥è¯¢
if friendId in self.onlinePlayers:
    print("å¥½å‹åœ¨çº¿")
```

---

## 5. æ¶æ„è®¾è®¡æ¨¡å¼æ€»ç»“

### 5.1 é€šç”¨æ¶æ„æ¨¡å¼

é€šè¿‡ä¸‰ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬æ€»ç»“å‡ºä»¥ä¸‹**å¯å¤ç”¨çš„æ¶æ„æ¨¡å¼**ï¼š

#### æ¨¡å¼1ï¼šæœåŠ¡å™¨æƒå¨æ¨¡å¼ï¼ˆServer Authority Patternï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ¶‰åŠè´§å¸ã€é“å…·ã€æƒé™éªŒè¯çš„åŠŸèƒ½

**æ¶æ„**ï¼š
```
å®¢æˆ·ç«¯ï¼šå‘é€è¯·æ±‚ â†’ ç­‰å¾…å“åº” â†’ æ›´æ–°UI
æœåŠ¡ç«¯ï¼šéªŒè¯åˆæ³•æ€§ â†’ æ‰§è¡Œé€»è¾‘ â†’ è¿”å›ç»“æœ
```

**æ¡ˆä¾‹**ï¼šå•†åŸç³»ç»Ÿçš„è´­ä¹°éªŒè¯

---

#### æ¨¡å¼2ï¼šæ‰¹é‡å¤„ç†æ¨¡å¼ï¼ˆBatch Processing Patternï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šé«˜é¢‘äº‹ä»¶ï¼ˆå¦‚æˆå°±è¿›åº¦ã€æ—¥å¿—ä¸ŠæŠ¥ï¼‰

**å®ç°**ï¼š
```python
# æ”¶é›†å¾…å¤„ç†æ•°æ®
self.pendingData[playerId].append(data)

# å®šæ—¶æ‰¹é‡å¤„ç†
def BatchProcess(self):
    for playerId, dataList in self.pendingData.items():
        self.ProcessBatch(playerId, dataList)
    self.pendingData.clear()
    self.CreateTimer(5.0, self.BatchProcess)
```

**ä¼˜åŠ¿**ï¼šå‡å°‘90%çš„ç½‘ç»œè¯·æ±‚

---

#### æ¨¡å¼3ï¼šçŠ¶æ€åŒæ­¥æ¨¡å¼ï¼ˆState Sync Patternï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¤šç©å®¶çŠ¶æ€é€šçŸ¥ï¼ˆå¥½å‹ä¸Šçº¿ã€é˜Ÿä¼å˜åŒ–ï¼‰

**å®ç°**ï¼š
```python
# ç©å®¶çŠ¶æ€å˜åŒ–æ—¶
for observer in self._GetObservers(playerId):
    self.NotifyToClient(observer, 'StateChangedEvent', {...})
```

**æ¡ˆä¾‹**ï¼šå¥½å‹ç³»ç»Ÿçš„ä¸Šçº¿/ä¸‹çº¿é€šçŸ¥

---

#### æ¨¡å¼4ï¼šå†…å­˜ç¼“å­˜ + å®šæœŸæŒä¹…åŒ–ï¼ˆCache + Persistence Patternï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šé¢‘ç¹è¯»å†™çš„æ•°æ®ï¼ˆæˆå°±è¿›åº¦ã€ç»Ÿè®¡æ•°æ®ï¼‰

**å®ç°**ï¼š
```python
# å†…å­˜ç¼“å­˜ï¼ˆå¿«é€Ÿè®¿é—®ï¼‰
self.cache[playerId] = data

# å®šæœŸæŒä¹…åŒ–ï¼ˆExtraDataï¼‰
def SaveCache(self):
    for playerId, data in self.cache.items():
        self.extraDataComp.SetExtraData(playerId, 'key', json.dumps(data))
```

**ä¼˜åŠ¿**ï¼šæ€§èƒ½æå‡10å€

---

### 5.2 è®¾è®¡æ¨¡å¼å¯¹ç…§è¡¨

| è®¾è®¡æ¨¡å¼ | æ¡ˆä¾‹ | å…³é”®ä»£ç  | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|---------|
| **æœåŠ¡å™¨æƒå¨** | å•†åŸè´­ä¹°éªŒè¯ | `_GetItemConfig(itemId)` | é˜²ä½œå¼Šã€è´§å¸äº¤æ˜“ |
| **æ‰¹é‡å¤„ç†** | æˆå°±æ‰¹é‡ä¸ŠæŠ¥ | `BatchReportAchievements()` | é«˜é¢‘äº‹ä»¶ã€æ€§èƒ½ä¼˜åŒ– |
| **çŠ¶æ€åŒæ­¥** | å¥½å‹ä¸Šçº¿é€šçŸ¥ | `NotifyToClient(friendId, ...)` | å¤šç©å®¶äº¤äº’ |
| **äº‹åŠ¡å›æ»š** | è´­ä¹°å¤±è´¥é€€æ¬¾ | `_SetPlayerBalance(oldBalance)` | å…³é”®æ“ä½œä¿æŠ¤ |
| **å†…å­˜ç¼“å­˜** | æˆå°±è¿›åº¦ç¼“å­˜ | `self.progressCache[playerId]` | é¢‘ç¹è¯»å†™æ•°æ® |

---

## 6. å¸¸è§é—®é¢˜FAQ

### Q1: å•†åŸç³»ç»Ÿå¦‚ä½•é˜²æ­¢ç©å®¶é‡å¤è´­ä¹°é™é‡å•†å“ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæœåŠ¡ç«¯ç»´æŠ¤å…¨å±€åº“å­˜

```python
# æœåŠ¡ç«¯æ£€æŸ¥åº“å­˜
currentStock = self._GetItemStock(itemId)
if currentStock < count:
    return False  # åº“å­˜ä¸è¶³

# æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
self._DecreaseItemStock(itemId, count)
```

---

### Q2: æˆå°±ç³»ç»Ÿå¦‚ä½•é¿å…æœåŠ¡å™¨é‡å¯åè¿›åº¦ä¸¢å¤±ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå®šæœŸæŒä¹…åŒ–åˆ°ExtraData

```python
# æ‰¹é‡ä¸ŠæŠ¥æ—¶åŒæ­¥ä¿å­˜
def BatchReportAchievements(self):
    for playerId in self.pendingAchievements.keys():
        self._SavePlayerAchievements(playerId)  # æŒä¹…åŒ–
```

---

### Q3: å¥½å‹ç³»ç»Ÿå¦‚ä½•æ”¯æŒè·¨æœåŠ¡å™¨æŸ¥è¯¢ï¼ˆå¥½å‹åœ¨å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼‰ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå½“å‰æ¡ˆä¾‹æ˜¯å•æœåŠ¡å™¨è®¾è®¡ã€‚è·¨æœåŠ¡å™¨éœ€è¦ï¼š

1. **å¼•å…¥ä¸­å¤®æœåŠ¡å™¨**ï¼šå­˜å‚¨å…¨å±€å¥½å‹å…³ç³»
2. **ä½¿ç”¨HTTP API**ï¼šæŸ¥è¯¢å¥½å‹åœ¨çº¿çŠ¶æ€
3. **WebSocketé€šçŸ¥**ï¼šè·¨æœåŠ¡å™¨æ¨é€æ¶ˆæ¯

ï¼ˆè¶…å‡ºMODSDKèŒƒå›´ï¼Œéœ€è¦å¤–éƒ¨æœåŠ¡å™¨æ”¯æŒï¼‰

---

### Q4: å¦‚ä½•æ·»åŠ æ›´å¤šç±»å‹çš„æˆå°±ï¼ˆå¦‚"å»ºé€ 10ä¸ªæˆ¿å­"ï¼‰ï¼Ÿ

**ç­”æ¡ˆ**ï¼šç›‘å¬å¯¹åº”äº‹ä»¶

```python
# ç›‘å¬æ–¹å—æ”¾ç½®äº‹ä»¶
self.ListenForEvent(..., 'PlaceBlockEvent', self, self.OnPlaceBlock)

def OnPlaceBlock(self, args):
    playerId = args['playerId']
    blockName = args['blockName']

    if blockName == 'minecraft:planks':
        self._IncrementAchievement(playerId, 'place_plank_1000', 1)
```

---

### Q5: å•†åŸç³»ç»Ÿå¦‚ä½•æ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼ˆä¸é‡å¯ä¿®æ”¹å•†å“ï¼‰ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå®šæœŸé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶

```python
# æ·»åŠ ç®¡ç†å‘˜å‘½ä»¤
def OnAdminCommand(self, args):
    if args['command'] == '/shop reload':
        self.shopConfig = self._LoadShopConfig()
        print("å•†å“é…ç½®å·²é‡æ–°åŠ è½½")
```

---

## ğŸ“š æ¨èé˜…è¯»

å®Œæˆæœ¬æ–‡æ¡£å­¦ä¹ åï¼Œå»ºè®®ç»§ç»­é˜…è¯»ï¼š

- [æ•°æ®æŒä¹…åŒ–æŒ‡å—.md](æ•°æ®æŒä¹…åŒ–æŒ‡å—.md) - ExtraDataæ·±åº¦ç”¨æ³•
- [æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—.md](æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—.md) - æ‰¹é‡å¤„ç†ä¼˜åŒ–æŠ€å·§
- [ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md](ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md) - RPCé€šä¿¡æœ€ä½³å®è·µ
- [åæ¨¡å¼è¯†åˆ«æ¸…å•.md](åæ¨¡å¼è¯†åˆ«æ¸…å•.md) - é¿å…å¸¸è§é”™è¯¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-11
**è´¡çŒ®è€…**: NeteaseMod-Claudeå·¥ä½œæµå›¢é˜Ÿ

**çŸ¥è¯†æ¥æºå£°æ˜**ï¼š
æœ¬æ–‡æ¡£åŸºäºä»¥ä¸‹åˆæ³•æ¥æºç¼–å†™ï¼š
- âœ… MODSDKå®˜æ–¹å¼€å‘æ–‡æ¡£
- âœ… MinecraftåŸºå²©ç‰ˆWIKI
- âœ… é€šç”¨è½¯ä»¶å·¥ç¨‹è®¾è®¡æ¨¡å¼ï¼ˆå¦‚äº‹åŠ¡å›æ»šã€æ‰¹é‡å¤„ç†ã€ç¼“å­˜ç­–ç•¥ç­‰ï¼‰
- âœ… Pythonå¼€å‘æœ€ä½³å®è·µ

æ‰€æœ‰ä»£ç ç¤ºä¾‹å‡ä¸ºç‹¬ç«‹è®¾è®¡ï¼Œæœªå¼•ç”¨ä»»ä½•éå®˜æ–¹ä»£ç å®ç°ã€‚
