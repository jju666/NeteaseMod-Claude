# v16.0 可选优化工具说明

> 本文档介绍v16.0提供的可选优化工具，用于高级用户和特殊场景

---

## 📋 工具清单

| 工具命令 | 用途 | 使用场景 |
|---------|------|---------|
| `merge-conflicts` | 覆盖层冲突合并 | 上游更新后，项目定制文档与上游产生冲突 |
| `detect-obsolete` | 废弃文件检测 | 版本升级后，手动检查和清理废弃文件 |

---

## 1️⃣ merge-conflicts - 覆盖层冲突合并工具

### 用途

当您在 `markdown/core/` 中创建了项目定制文档，而上游核心文档有更新时，此工具帮助您：
- 检测哪些文件存在冲突（上游和项目定制版本不一致）
- 提供交互式合并选项（查看差异、使用上游、保留定制、手动合并）
- 自动备份和更新版本追踪

### 使用方式

```bash
# 交互式合并冲突
merge-conflicts

# 只列出冲突，不合并
merge-conflicts --list
```

### 交互流程示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔀 覆盖层冲突合并工具
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️  发现 2 个文件的上游版本已更新:

📄 文件: 开发规范.md
   路径: markdown/core/开发规范.md
   说明: 上游文档有更新，建议审查并合并

   差异: 245行 → 268行, 大小变化: +1523字节

   请选择操作:
   1) 查看详细差异 (diff)
   2) 使用上游版本覆盖 (接受上游更新)
   3) 保留当前版本 (忽略上游更新)
   4) 手动合并 (生成合并文件)
   5) 跳过此文件

   选择 [1-5]:
```

### 选项说明

| 选项 | 动作 | 说明 |
|-----|------|------|
| 1 | 查看详细差异 | 显示两个版本的逐行对比（前50行） |
| 2 | 使用上游版本 | 复制上游版本到覆盖层，旧版本自动备份 |
| 3 | 保留当前版本 | 保留项目定制版本，标记为已处理 |
| 4 | 手动合并 | 生成 `.merge` 文件，包含两个版本，供手动编辑 |
| 5 | 跳过 | 不处理此文件 |

### 手动合并文件格式

选择选项4后，会生成如下格式的 `.merge` 文件：

```
<<<<<<< 当前版本 (markdown/core/开发规范.md)
[您的项目定制内容]
=======
>>>>>>> 上游版本 (.claude/core-docs/开发规范.md)
[上游最新内容]
<<<<<<< END

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 合并指南
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 手动编辑此文件，合并两个版本的内容
2. 删除冲突标记 (<<<<<<< / ======= / >>>>>>>)
3. 保存为 开发规范.md
4. 删除此 .merge 文件
```

---

## 2️⃣ detect-obsolete - 废弃文件检测工具

### 用途

版本升级时，检测和处理不再需要的旧文件：
- 支持多种处理动作（删除、备份、迁移、警告）
- 可配置的检测规则
- 模拟运行模式（dry-run）

### 使用方式

```bash
# 交互式检测和处理
detect-obsolete

# 只列出废弃文件
detect-obsolete --list

# 模拟运行（不实际修改）
detect-obsolete --dry-run

# 自动确认所有操作
detect-obsolete --auto-confirm

# 指定版本范围
detect-obsolete --from 15.0.0 --to 16.0.0
```

### 处理动作说明

| 动作 | 说明 | 示例 |
|-----|------|------|
| `delete` | 直接删除文件 | v17.0移除过时的迁移指南 |
| `backup` | 备份后删除（备份到 `.backup-obsolete/`） | 旧配置文件 |
| `migrate` | 迁移到新位置 | v16.0核心文档迁移到 `markdown/core/` |
| `warn` | 仅警告，不自动处理 | 开发中可能使用的脚本 |

### 执行示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 废弃文件检测
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

版本范围: v15.1.0 → v16.0.0

⚠️  发现 9 个废弃文件:

[MIGRATE] 7 个文件:
  - markdown/开发规范.md
    原因: 双层文档架构：核心文档移至.claude/core-docs/引用
  - markdown/问题排查.md
    原因: 双层文档架构：核心文档移至.claude/core-docs/引用
  ...

[WARN] 1 个文件:
  - scripts/initmc.js
    原因: 架构重构：改用lib/init-workflow.js

[BACKUP] 1 个文件:
  - .claude/workflow-config.json
    原因: 配置合并到.claude/workflow-manifest.json

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

是否自动处理? [Y/n]:
```

---

## 📚 与 initmc --sync 的关系

这两个工具在 `initmc --sync` 同步更新流程中会自动调用，但您也可以单独运行：

### initmc --sync 流程

```
initmc --sync
├─ 步骤1: 版本检测
├─ 步骤2: 更新软连接
├─ 步骤3: 检测废弃文件 (自动调用 detect-obsolete)
├─ 步骤4: 检测覆盖层冲突
│          (如有冲突，提示运行 merge-conflicts)
└─ 步骤5: 更新manifest
```

### 单独运行场景

- **merge-conflicts**: 当您想重新处理之前跳过的冲突时
- **detect-obsolete**: 当您想检查特定版本范围的废弃文件时

---

## 🛠️ 高级用法

### 自定义废弃文件检测规则

您可以在项目中扩展废弃文件检测规则：

```javascript
// 在项目的 .claude/custom-rules.js 中

const { ObsoleteFileDetector } = require('netease-mod-claude/lib/obsolete-file-detector');

// 添加自定义规则
ObsoleteFileDetector.addRule({
  fromVersion: '16.0.0',
  toVersion: '17.0.0',
  files: [
    'custom/old-module.js'
  ],
  reason: '重构: 旧模块已迁移到新架构',
  action: 'backup'
});
```

### 导出冲突列表

```bash
# 只列出冲突，不处理
merge-conflicts --list > conflicts.txt

# 编写脚本批量处理
cat conflicts.txt | while read file; do
  # 自定义处理逻辑
done
```

---

## 🎯 最佳实践

### 1. 定期检查冲突

在上游更新后，定期运行：

```bash
merge-conflicts --list
```

### 2. 谨慎处理警告类废弃文件

对于 `action: 'warn'` 的文件，建议手动检查后再删除。

### 3. 保留备份

工具会自动备份，但重要文件建议手动备份到版本控制：

```bash
# 在处理前手动备份
cp -r markdown/core markdown/core.backup-$(date +%Y%m%d)
```

### 4. 测试后再提交

处理完冲突和废弃文件后，务必测试项目正常运行：

```bash
# 测试工作流
initmc --sync

# 测试项目
# (运行您的MODSDK项目)
```

---

## ❓ 常见问题

### Q1: merge-conflicts 报错 "未找到全局工作流目录"

**A**: 请先运行 `npm run install-global` 完成全局安装。

### Q2: 选择"使用上游版本"后，我的定制内容丢失了

**A**: 工具会自动备份旧版本，文件名为 `原文件名.backup-时间戳`，您可以从备份中恢复内容。

### Q3: detect-obsolete 显示的文件我还在使用，怎么办？

**A**: 选择"跳过"或手动编辑 `.claude/workflow-manifest.json` 中的 `obsoleteFiles` 数组，移除该文件。

### Q4: 可以批量接受所有上游更新吗？

**A**: 目前需要逐个文件确认，这是为了避免误操作。您可以在每个文件选择时都选"2"（使用上游版本）。

---

## 📝 版本历史

- **v16.0** (2025-11-11): 初次发布
  - 实现覆盖层冲突合并工具
  - 实现废弃文件检测器扩展

---

## 🔗 相关文档

- [迁移指南-v16.0.md](./迁移指南-v16.0.md) - 完整的v16.0迁移指南
- [CLAUDE.md](../CLAUDE.md) - AI工作流总览
- [Claude指令参考.md](../Claude指令参考.md) - 所有命令说明
