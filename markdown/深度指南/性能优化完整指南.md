# æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—

> âš¡ **MODSDKé«˜æ€§èƒ½å¼€å‘å®æˆ˜**
>
> æœ¬æ–‡æ¡£æä¾›MODSDKå¼€å‘ä¸­çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€å¸¸è§æ€§èƒ½é™·é˜±å’Œæœ€ä½³å®è·µ
>
> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-11

---

## ç›®å½•

1. [æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#ä¸€æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [RegisterViewæ·±åº¦ä¼˜åŒ–](#äºŒregisterviewæ·±åº¦ä¼˜åŒ–)
3. [Updateé¢‘ç‡æ§åˆ¶](#ä¸‰updateé¢‘ç‡æ§åˆ¶)
4. [äº‹ä»¶ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–](#å››äº‹ä»¶ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–)
5. [æ•°æ®å­˜å‚¨ä¼˜åŒ–](#äº”æ•°æ®å­˜å‚¨ä¼˜åŒ–)
6. [ç½‘ç»œé€šä¿¡ä¼˜åŒ–](#å…­ç½‘ç»œé€šä¿¡ä¼˜åŒ–)
7. [å†…å­˜ç®¡ç†](#ä¸ƒå†…å­˜ç®¡ç†)
8. [æ€§èƒ½åˆ†æå·¥å…·](#å…«æ€§èƒ½åˆ†æå·¥å…·)
9. [æ€§èƒ½ä¼˜åŒ–æ¸…å•](#ä¹æ€§èƒ½ä¼˜åŒ–æ¸…å•)

---

## ä¸€ã€æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°

### 1.1 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

MODSDKå¼€å‘ä¸­çš„**4å¤§æ€§èƒ½æ€æ‰‹**:

| æ€§èƒ½é—®é¢˜ | è¡¨ç° | å½±å“ | ä¼˜å…ˆçº§ |
|---------|------|------|--------|
| **1. é«˜é¢‘Update()** | Updateä¸­æ‰§è¡Œå¤æ‚é€»è¾‘ | CPUå ç”¨é«˜,æ¸¸æˆå¡é¡¿ | ğŸ”´ CRITICAL |
| **2. æ— RegisterView** | æ¯å¸§éå†æ‰€æœ‰Entity | å®ä½“æ•°é‡â†‘æ€§èƒ½â†“ | ğŸ”´ CRITICAL |
| **3. é«˜é¢‘ç½‘ç»œRPC** | æ¯å¸§NotifyToServer | ç½‘ç»œæ‹¥å¡,å»¶è¿Ÿé«˜ | ğŸŸ  HIGH |
| **4. å†…å­˜æ³„æ¼** | æœªå–æ¶ˆäº‹ä»¶ç›‘å¬ | å†…å­˜æŒç»­å¢é•¿,å´©æºƒ | ğŸŸ¡ MEDIUM |

---

### 1.2 æ€§èƒ½ä¼˜åŒ–é‡‘å­—å¡”

```
             ä¼˜åŒ–éš¾åº¦ â†‘
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ç®—æ³•ä¼˜åŒ–     â”‚ â† éœ€è¦é‡æ„ä»£ç 
          â”‚ (O(nÂ²)â†’O(n)) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ•°æ®ç»“æ„ä¼˜åŒ–       â”‚ â† éœ€è¦è®¾è®¡èƒ½åŠ›
        â”‚ (åˆ—è¡¨â†’å“ˆå¸Œè¡¨)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ APIä½¿ç”¨ä¼˜åŒ–            â”‚ â† æœ¬æ–‡æ¡£é‡ç‚¹
      â”‚ (RegisterView, èŠ‚æµ)   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¼–ç è§„èŒƒ                     â”‚ â† æœ€æ˜“å®æ–½
    â”‚ (é¿å…å…¨å±€å˜é‡, åŠæ—¶é‡Šæ”¾)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŒ–ç­–ç•¥**:
1. å…ˆå®æ–½ä½æˆæœ¬ä¼˜åŒ–ï¼ˆç¼–ç è§„èŒƒã€APIä½¿ç”¨ï¼‰
2. ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·å®šä½ç“¶é¢ˆ
3. é’ˆå¯¹æ€§ä¼˜åŒ–å…³é”®è·¯å¾„
4. æŒç»­ç›‘æ§å’Œå›å½’æµ‹è¯•

---

## äºŒã€RegisterViewæ·±åº¦ä¼˜åŒ–

### 2.1 ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨RegisterView?

**é—®é¢˜**: é»˜è®¤æƒ…å†µä¸‹,Systemçš„`Update()`éœ€è¦éå†**æ‰€æœ‰Entity**

```python
# âŒ æ²¡æœ‰RegisterViewçš„System
class HealthRegenServerSystem(ServerSystem):
    def Update(self):
        # éå†ä¸–ç•Œä¸­æ‰€æœ‰å®ä½“ (åŒ…æ‹¬æ–¹å—ã€ç‰©å“ã€ç²’å­ç­‰)
        for entity in self.GetAllEntities():  # å‡è®¾æœ‰10,000ä¸ªå®ä½“
            if self.IsPlayer(entity):  # åªæœ‰100ä¸ªç©å®¶
                self.RegenHealth(entity)
        # æ¯å¸§åšäº†9,900æ¬¡æ— æ•ˆæ£€æŸ¥!
```

**æ€§èƒ½å¯¹æ¯”**:

| åœºæ™¯ | æ— RegisterView | æœ‰RegisterView | æ€§èƒ½æå‡ |
|------|---------------|---------------|---------|
| 100ä¸ªç©å®¶ | éå†10,000ä¸ªå®ä½“ | åªéå†100ä¸ªç©å®¶ | **100å€** |
| 1,000ä¸ªç©å®¶ | éå†20,000ä¸ªå®ä½“ | åªéå†1,000ä¸ªç©å®¶ | **20å€** |

---

### 2.2 RegisterViewåŸºç¡€ç”¨æ³•

**è¯­æ³•**:
```python
self.RegisterView(viewName, componentNameList)
```

**ç¤ºä¾‹**:
```python
class HealthRegenServerSystem(ServerSystem):
    def __init__(self):
        # æ³¨å†Œè§†å›¾: åªç›‘è§†æ‹¥æœ‰"Health"ç»„ä»¶çš„å®ä½“
        self.RegisterView(
            'PlayerWithHealth',           # è§†å›¾åç§°
            ['Minecraft:Health']          # ç»„ä»¶åˆ—è¡¨
        )

    def Update(self):
        # åªéå†æ‹¥æœ‰Healthç»„ä»¶çš„å®ä½“ (é€šå¸¸æ˜¯ç©å®¶å’Œç”Ÿç‰©)
        for entity in self.GetEntitiesInView('PlayerWithHealth'):
            self.RegenHealth(entity)
```

---

### 2.3 å¤šç»„ä»¶è¿‡æ»¤

**éœ€æ±‚**: åªå¤„ç†"æ‹¥æœ‰Healthç»„ä»¶ **ä¸”** æ‹¥æœ‰VIPç»„ä»¶"çš„ç©å®¶

```python
class VIPHealthBoostServerSystem(ServerSystem):
    def __init__(self):
        # æ³¨å†Œè§†å›¾: åŒæ—¶æ‹¥æœ‰Healthå’ŒVIPç»„ä»¶
        self.RegisterView(
            'VIPPlayers',
            [
                'Minecraft:Health',  # å®˜æ–¹å¥åº·ç»„ä»¶
                'MyMod:VIPComponent'  # è‡ªå®šä¹‰VIPç»„ä»¶
            ]
        )

    def Update(self):
        # åªéå†VIPç©å®¶ (å‡è®¾100ä¸ªç©å®¶ä¸­åªæœ‰10ä¸ªVIP)
        for entity in self.GetEntitiesInView('VIPPlayers'):
            # ç»™VIPç©å®¶é¢å¤–å›è¡€
            self.RegenHealthFaster(entity)
```

**æ€§èƒ½æå‡**: ä»éå†100ä¸ªç©å®¶â†’åªéå†10ä¸ªVIPç©å®¶ (**10å€æå‡**)

---

### 2.4 RegisterViewæœ€ä½³å®è·µ

**âœ… æ¨è**:
```python
# 1. åœ¨__init__ä¸­æ³¨å†Œè§†å›¾
def __init__(self):
    self.RegisterView('MyView', ['Minecraft:Health'])

# 2. ä½¿ç”¨æ˜ç¡®çš„è§†å›¾åç§°
def __init__(self):
    self.RegisterView('CombatEntities', ['Minecraft:Attack'])  # âœ… æ¸…æ™°
    # é¿å…: self.RegisterView('view1', ...)  # âŒ å«ä¹‰ä¸æ˜

# 3. ä¸ºä¸åŒé€»è¾‘æ³¨å†Œä¸åŒè§†å›¾
def __init__(self):
    self.RegisterView('PlayersWithHealth', ['Minecraft:Health'])
    self.RegisterView('MonstersWithAI', ['Minecraft:AI', 'Minecraft:Monster'])
```

**âŒ é”™è¯¯ç”¨æ³•**:
```python
# 1. åœ¨Updateä¸­æ³¨å†Œè§†å›¾ï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼‰
def Update(self):
    self.RegisterView('TempView', ['Minecraft:Health'])  # âŒ æ¯å¸§æ³¨å†Œä¸€æ¬¡

# 2. æ³¨å†Œç©ºç»„ä»¶åˆ—è¡¨
def __init__(self):
    self.RegisterView('AllEntities', [])  # âŒ ç­‰åŒäºéå†æ‰€æœ‰å®ä½“

# 3. æ³¨å†Œè¿‡å¤šè§†å›¾ï¼ˆå†…å­˜å ç”¨é«˜ï¼‰
def __init__(self):
    for i in range(100):
        self.RegisterView('View' + str(i), ['Component'])  # âŒ æ»¥ç”¨
```

---

### 2.5 RegisterViewæ€§èƒ½æµ‹è¯•

**æµ‹è¯•ä»£ç **:
```python
import time

class PerformanceTestSystem(ServerSystem):
    def __init__(self):
        self.test_with_view = False
        if self.test_with_view:
            self.RegisterView('TestView', ['Minecraft:Health'])

    def Update(self):
        start = time.time()

        if self.test_with_view:
            entities = self.GetEntitiesInView('TestView')
        else:
            entities = self.GetAllEntities()

        for entity in entities:
            # æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
            pass

        elapsed = time.time() - start
        print "[Perf] Update took {:.3f}ms".format(elapsed * 1000)
```

**æµ‹è¯•ç»“æœ** (ä¸–ç•Œä¸­æœ‰10,000ä¸ªå®ä½“, 100ä¸ªç©å®¶):

| æ–¹æ³• | æ¯å¸§è€—æ—¶ | FPSå½±å“ |
|------|---------|--------|
| æ— RegisterView | 15ms | -5 FPS |
| æœ‰RegisterView | 0.5ms | -0.2 FPS |

---

## ä¸‰ã€Updateé¢‘ç‡æ§åˆ¶

### 3.1 Updateæ€§èƒ½é™·é˜±

**é—®é¢˜**: `Update()`æ¯æ¸¸æˆTickè°ƒç”¨ä¸€æ¬¡ï¼ˆæœåŠ¡å™¨20æ¬¡/ç§’,å®¢æˆ·ç«¯60æ¬¡/ç§’ï¼‰

```python
# âŒ å±é™©ç¤ºä¾‹
def Update(self):
    # æ¯ç§’æ‰§è¡Œ20æ¬¡çš„å¤æ‚é€»è¾‘
    players = self.GetAllPlayers()  # å‡è®¾100ms
    for player in players:
        self.CalculateComplexStats(player)  # å‡è®¾10ms/ç©å®¶
    # æ€»è€—æ—¶: 100ms + 10ms*100 = 1100ms = 1.1ç§’
    # æœåŠ¡å™¨å¡æ­»!
```

---

### 3.2 èŠ‚æµï¼ˆThrottleï¼‰

**é€‚ç”¨**: ä¸éœ€è¦æ¯å¸§æ‰§è¡Œçš„é€»è¾‘

```python
class QuestServerSystem(ServerSystem):
    def __init__(self):
        self.tick_counter = 0

    def Update(self):
        self.tick_counter += 1

        # æ¯100 tick (5ç§’) æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡æ£€æŸ¥
        if self.tick_counter % 100 == 0:
            self.CheckQuestProgress()

        # æ¯20 tick (1ç§’) æ›´æ–°ä»»åŠ¡UI
        if self.tick_counter % 20 == 0:
            self.UpdateQuestUI()
```

**æ€§èƒ½æå‡**:
- ä»æ¯å¸§æ‰§è¡Œâ†’æ¯5ç§’æ‰§è¡Œ: **100å€é™ä½CPUå ç”¨**

---

### 3.3 åˆ†å¸§æ‰§è¡Œï¼ˆFrame Splittingï¼‰

**é€‚ç”¨**: è€—æ—¶æ“ä½œéœ€è¦åˆ†æ•£åˆ°å¤šå¸§æ‰§è¡Œ

```python
class LeaderboardServerSystem(ServerSystem):
    def __init__(self):
        self.tick_counter = 0
        self.all_players = []
        self.current_index = 0  # å½“å‰å¤„ç†åˆ°çš„ç©å®¶ç´¢å¼•

    def Update(self):
        self.tick_counter += 1

        # æ¯100 tické‡æ–°è·å–ç©å®¶åˆ—è¡¨
        if self.tick_counter % 100 == 0:
            self.all_players = self.GetAllPlayers()
            self.current_index = 0

        # æ¯å¸§åªå¤„ç†10ä¸ªç©å®¶
        if len(self.all_players) > 0:
            batch_size = 10
            end_index = min(self.current_index + batch_size, len(self.all_players))

            for i in range(self.current_index, end_index):
                player = self.all_players[i]
                self.CalculatePlayerScore(player)  # è€—æ—¶æ“ä½œ

            self.current_index = end_index

            # æ‰€æœ‰ç©å®¶å¤„ç†å®Œæ¯•
            if self.current_index >= len(self.all_players):
                self.SortLeaderboard()
                self.current_index = 0
```

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ³• | æ¯å¸§è€—æ—¶ | æ€»è€—æ—¶ |
|------|---------|--------|
| ä¸€æ¬¡å¤„ç†100ä¸ªç©å®¶ | 1000ms | 1000ms (å¡é¡¿) |
| åˆ†10å¸§å¤„ç† (æ¯å¸§10ä¸ª) | 100ms | 1000ms (æµç•…) |

---

### 3.4 å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰

**é€‚ç”¨**: ä¸æ˜¯æ‰€æœ‰ç©å®¶éƒ½éœ€è¦çš„æ•°æ®

```python
class VIPServerSystem(ServerSystem):
    def __init__(self):
        self.vip_cache = {}  # å»¶è¿ŸåŠ è½½çš„VIPæ•°æ®ç¼“å­˜

    def GetVIPLevel(self, playerId):
        """è·å–VIPç­‰çº§ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰"""
        # é¦–æ¬¡è®¿é—®æ—¶æ‰åŠ è½½
        if playerId not in self.vip_cache:
            # ä»æ•°æ®åº“/ExtraDataåŠ è½½
            self.vip_cache[playerId] = self.LoadVIPDataFromStorage(playerId)

        return self.vip_cache[playerId]

    def OnPlayerLeave(self, args):
        """ç©å®¶ç¦»å¼€æ—¶æ¸…ç†ç¼“å­˜"""
        playerId = args['playerId']
        if playerId in self.vip_cache:
            del self.vip_cache[playerId]  # é‡Šæ”¾å†…å­˜
```

**ä¼˜åŠ¿**:
- åªä¸ºæ´»è·ƒç©å®¶åŠ è½½æ•°æ®
- å‡å°‘å¯åŠ¨æ—¶é—´
- é™ä½å†…å­˜å ç”¨

---

## å››ã€äº‹ä»¶ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

### 4.1 å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡

**é—®é¢˜**: æ¯ä¸ªäº‹ä»¶è§¦å‘æ—¶,å¼•æ“ä¼šéå†æ‰€æœ‰ç›‘å¬å™¨

```python
# âŒ è¿‡å¤šç›‘å¬å™¨
class LogSystem(ServerSystem):
    def __init__(self):
        # ç›‘å¬100ä¸ªä¸åŒçš„äº‹ä»¶
        for i in range(100):
            self.ListenForEvent('MyMod', 'System' + str(i), 'Event', self, self.OnEvent)

    def OnEvent(self, args):
        print "[Log]", args
```

**å»ºè®®**:
- å•ä¸ªSystemç›‘å¬äº‹ä»¶æ•°é‡<**20ä¸ª**
- å•ä¸ªäº‹ä»¶ç›‘å¬å™¨æ•°é‡<**10ä¸ª**

---

### 4.2 äº‹ä»¶æ•°æ®åºåˆ—åŒ–ä¼˜åŒ–

**é—®é¢˜**: å¤§æ•°æ®é‡äº‹ä»¶å¯¼è‡´åºåˆ—åŒ–è€—æ—¶

```python
# âŒ ä½æ•ˆ: å‘é€å®Œæ•´ç©å®¶æ•°æ®
self.NotifyToClient(playerId, 'PlayerData', {
    'id': playerId,
    'name': 'Steve',
    'level': 50,
    'exp': 123456,
    'inventory': [...],  # 100ä¸ªç‰©å“
    'skills': [...],     # 50ä¸ªæŠ€èƒ½
    'achievements': [...] # 200ä¸ªæˆå°±
})  # æ€»å¤§å°: ~50KB, åºåˆ—åŒ–è€—æ—¶: ~10ms

# âœ… é«˜æ•ˆ: åªå‘é€å¿…è¦å­—æ®µ
self.NotifyToClient(playerId, 'PlayerData', {
    'id': playerId,
    'level': 50,
    'exp': 123456
})  # æ€»å¤§å°: ~100B, åºåˆ—åŒ–è€—æ—¶: ~0.1ms
```

---

### 4.3 æ‰¹é‡äº‹ä»¶ä¼˜åŒ–

**å‚è€ƒ**: [äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md - å…­ã€ç½‘ç»œäº‹ä»¶ä¼˜åŒ–](#)

```python
# âŒ ä½æ•ˆ
for itemId in item_list:
    self.NotifyToClient(playerId, 'AddItem', {'itemId': itemId})

# âœ… é«˜æ•ˆ
self.NotifyToClient(playerId, 'AddItems', {'itemIds': item_list})
```

---

## äº”ã€æ•°æ®å­˜å‚¨ä¼˜åŒ–

### 5.1 ExtraDataä½¿ç”¨ç­–ç•¥

**ExtraDataç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨æŒä¹…åŒ–ï¼ˆç©å®¶ä¸‹çº¿åä¿å­˜ï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥ï¼ˆæœåŠ¡å™¨â†”å®¢æˆ·ç«¯ï¼‰
- âš ï¸ æœ‰å¤§å°é™åˆ¶ï¼ˆå»ºè®®<64KB/ç©å®¶ï¼‰
- âš ï¸ é¢‘ç¹å†™å…¥å½±å“æ€§èƒ½

---

### 5.2 ExtraDataæ€§èƒ½ä¼˜åŒ–

**âŒ ä½æ•ˆå†™æ³•**:
```python
def Update(self):
    # æ¯å¸§ï¼ˆ20æ¬¡/ç§’ï¼‰å†™å…¥ExtraData
    comp.SetExtraData('last_update_time', time.time())
    # å¯¼è‡´é¢‘ç¹ç£ç›˜I/O
```

**âœ… é«˜æ•ˆå†™æ³•**:
```python
def __init__(self):
    self.dirty_players = set()  # è„æ•°æ®æ ‡è®°
    self.save_interval = 100  # 5ç§’ä¿å­˜ä¸€æ¬¡

def OnPlayerDataChanged(self, playerId):
    """æ ‡è®°ç©å®¶æ•°æ®éœ€è¦ä¿å­˜"""
    self.dirty_players.add(playerId)

def Update(self):
    if self.tick_counter % self.save_interval == 0:
        # æ‰¹é‡ä¿å­˜è„æ•°æ®
        for playerId in self.dirty_players:
            self.SavePlayerData(playerId)
        self.dirty_players.clear()
```

**æ€§èƒ½æå‡**: ä»20æ¬¡/ç§’â†’0.2æ¬¡/ç§’ (**100å€å‡å°‘I/O**)

---

### 5.3 æ•°æ®ç»“æ„é€‰æ‹©

**åœºæ™¯**: éœ€è¦é¢‘ç¹æŸ¥æ‰¾ç©å®¶æ•°æ®

```python
# âŒ ä½¿ç”¨åˆ—è¡¨ï¼ˆæŸ¥æ‰¾O(n)ï¼‰
self.player_list = [
    {'id': 'player1', 'score': 100},
    {'id': 'player2', 'score': 200},
    # ...
]

def GetPlayerScore(self, playerId):
    for player in self.player_list:  # O(n)
        if player['id'] == playerId:
            return player['score']

# âœ… ä½¿ç”¨å­—å…¸ï¼ˆæŸ¥æ‰¾O(1)ï¼‰
self.player_dict = {
    'player1': {'score': 100},
    'player2': {'score': 200},
    # ...
}

def GetPlayerScore(self, playerId):
    return self.player_dict.get(playerId, {}).get('score', 0)  # O(1)
```

**æ€§èƒ½å¯¹æ¯”**:

| ç©å®¶æ•°é‡ | åˆ—è¡¨æŸ¥æ‰¾è€—æ—¶ | å­—å…¸æŸ¥æ‰¾è€—æ—¶ | æå‡ |
|---------|------------|------------|------|
| 100 | 0.5ms | 0.01ms | **50å€** |
| 1,000 | 5ms | 0.01ms | **500å€** |

---

## å…­ã€ç½‘ç»œé€šä¿¡ä¼˜åŒ–

### 6.1 å‡å°‘RPCé¢‘ç‡

**å‚è€ƒ**: [ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md - äº”ã€ç½‘ç»œä¼˜åŒ–æŠ€å·§](#)

**æ ¸å¿ƒåŸåˆ™**:
- é«˜é¢‘äº‹ä»¶ï¼ˆ>10æ¬¡/ç§’ï¼‰ä½¿ç”¨èŠ‚æµ
- ä½ç½®æ›´æ–°: æ¯0.5ç§’æˆ–ç§»åŠ¨è·ç¦»>0.5æ ¼
- æ‰¹é‡æ“ä½œ: ä¸€æ¬¡RPCæ›¿ä»£å¤šæ¬¡RPC

---

### 6.2 æ•°æ®å‹ç¼©

**æŠ€å·§**: ä½¿ç”¨ä½è¿ç®—å‹ç¼©å¸ƒå°”å€¼

```python
# âŒ ä½æ•ˆ: æ¯ä¸ªå¸ƒå°”å€¼å 1å­—èŠ‚
data = {
    'has_vip': True,     # 1å­—èŠ‚
    'is_online': True,   # 1å­—èŠ‚
    'has_quest': False,  # 1å­—èŠ‚
    'in_combat': True    # 1å­—èŠ‚
}  # æ€»å…±4å­—èŠ‚

# âœ… é«˜æ•ˆ: 4ä¸ªå¸ƒå°”å€¼å‹ç¼©ä¸º1ä¸ªæ•´æ•°
# ä½0: has_vip, ä½1: is_online, ä½2: has_quest, ä½3: in_combat
flags = 0
flags |= (1 << 0) if has_vip else 0       # 0b0001
flags |= (1 << 1) if is_online else 0     # 0b0010
flags |= (1 << 2) if has_quest else 0     # 0b0100
flags |= (1 << 3) if in_combat else 0     # 0b1000
data = {'flags': flags}  # æ€»å…±1å­—èŠ‚ï¼ˆèŠ‚çœ75%ï¼‰

# è§£å‹
has_vip = bool(flags & (1 << 0))
is_online = bool(flags & (1 << 1))
```

---

## ä¸ƒã€å†…å­˜ç®¡ç†

### 7.1 å–æ¶ˆäº‹ä»¶ç›‘å¬

**é—®é¢˜**: å¿˜è®°å–æ¶ˆç›‘å¬å¯¼è‡´å†…å­˜æ³„æ¼

```python
# âŒ é”™è¯¯
class TempSystem(ServerSystem):
    def __init__(self):
        self.ListenForEvent('MyMod', 'OtherSystem', 'Event', self, self.OnEvent)

    # æ²¡æœ‰Destroyæ–¹æ³• â†’ å†…å­˜æ³„æ¼

# âœ… æ­£ç¡®
class TempSystem(ServerSystem):
    def __init__(self):
        self.ListenForEvent('MyMod', 'OtherSystem', 'Event', self, self.OnEvent)

    def Destroy(self):
        self.UnListenAllEvents()  # å–æ¶ˆæ‰€æœ‰ç›‘å¬
```

---

### 7.2 é¿å…å¾ªç¯å¼•ç”¨

```python
# âŒ é”™è¯¯: å¾ªç¯å¼•ç”¨
class SystemA(ServerSystem):
    def __init__(self):
        self.system_b = SystemB()
        self.system_b.system_a = self  # å¾ªç¯å¼•ç”¨

# âœ… æ­£ç¡®: ä½¿ç”¨äº‹ä»¶é€šä¿¡
class SystemA(ServerSystem):
    def __init__(self):
        self.NotifyToServer('SystemA_ReadyEvent', {})

class SystemB(ServerSystem):
    def __init__(self):
        self.ListenForEvent('MyMod', 'SystemA', 'SystemA_ReadyEvent', self, self.OnSystemAReady)
```

---

### 7.3 åŠæ—¶æ¸…ç†ç¼“å­˜

```python
class CacheSystem(ServerSystem):
    def __init__(self):
        self.player_cache = {}  # ç©å®¶æ•°æ®ç¼“å­˜
        self.cache_expire_time = 300  # 5åˆ†é’Ÿè¿‡æœŸ

    def GetPlayerData(self, playerId):
        current_time = time.time()

        # æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
        if playerId in self.player_cache:
            cache_data, timestamp = self.player_cache[playerId]
            if current_time - timestamp < self.cache_expire_time:
                return cache_data  # è¿”å›ç¼“å­˜

        # ç¼“å­˜è¿‡æœŸ,é‡æ–°åŠ è½½
        data = self.LoadPlayerDataFromStorage(playerId)
        self.player_cache[playerId] = (data, current_time)
        return data

    def OnPlayerLeave(self, args):
        """ç©å®¶ç¦»å¼€æ—¶æ¸…ç†ç¼“å­˜"""
        playerId = args['playerId']
        if playerId in self.player_cache:
            del self.player_cache[playerId]
```

---

## å…«ã€æ€§èƒ½åˆ†æå·¥å…·

### 8.1 ç®€æ˜“æ€§èƒ½è®¡æ—¶å™¨

```python
import time

class PerformanceTimer:
    def __init__(self, name):
        self.name = name
        self.start_time = None

    def __enter__(self):
        self.start_time = time.time()
        return self

    def __exit__(self, *args):
        elapsed = (time.time() - self.start_time) * 1000
        print "[Perf] {} took {:.2f}ms".format(self.name, elapsed)

# ä½¿ç”¨ç¤ºä¾‹
def Update(self):
    with PerformanceTimer("Update"):
        self.DoSomething()

    with PerformanceTimer("Database Query"):
        self.LoadPlayerData()
```

---

### 8.2 å¸§ç‡ç›‘æ§

```python
class FPSMonitor(ServerSystem):
    def __init__(self):
        self.frame_times = []
        self.max_samples = 60  # è®°å½•æœ€è¿‘60å¸§

    def Update(self):
        current_time = time.time()
        self.frame_times.append(current_time)

        # ä¿æŒé˜Ÿåˆ—é•¿åº¦
        if len(self.frame_times) > self.max_samples:
            self.frame_times.pop(0)

        # æ¯ç§’è¾“å‡ºä¸€æ¬¡FPS
        if len(self.frame_times) >= 2:
            time_span = self.frame_times[-1] - self.frame_times[0]
            fps = len(self.frame_times) / time_span
            print "[FPS] {:.1f}".format(fps)
```

---

### 8.3 å†…å­˜ä½¿ç”¨ç›‘æ§

```python
import sys

class MemoryMonitor(ServerSystem):
    def __init__(self):
        self.tick_counter = 0

    def Update(self):
        self.tick_counter += 1

        # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡å†…å­˜
        if self.tick_counter % 100 == 0:
            # è·å–æ‰€æœ‰å¯¹è±¡æ•°é‡
            obj_count = len(gc.get_objects())
            print "[Memory] Total objects: {}".format(obj_count)

            # æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
            if obj_count > 10000:
                print "[Warning] Possible memory leak!"
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–æ¸…å•

### âœ… Systemè®¾è®¡

- [ ] æ‰€æœ‰Systeméƒ½ä½¿ç”¨äº†`RegisterView`ï¼ˆé™¤éå¿…é¡»éå†æ‰€æœ‰å®ä½“ï¼‰
- [ ] `Update()`ä¸­çš„é€»è¾‘ä½¿ç”¨èŠ‚æµï¼ˆ>10æ¬¡/ç§’çš„æ“ä½œï¼‰
- [ ] è€—æ—¶æ“ä½œä½¿ç”¨åˆ†å¸§æ‰§è¡Œ
- [ ] ä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–å‡å°‘å¯åŠ¨æ—¶é—´

### âœ… äº‹ä»¶ç³»ç»Ÿ

- [ ] å•ä¸ªSystemç›‘å¬äº‹ä»¶æ•°é‡<20ä¸ª
- [ ] äº‹ä»¶æ•°æ®å¤§å°<10KB
- [ ] é«˜é¢‘äº‹ä»¶ä½¿ç”¨èŠ‚æµ
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨å•æ¬¡RPC

### âœ… æ•°æ®å­˜å‚¨

- [ ] ExtraDataä½¿ç”¨æ‰¹é‡ä¿å­˜ï¼ˆé¿å…æ¯å¸§å†™å…¥ï¼‰
- [ ] ä½¿ç”¨å­—å…¸ä»£æ›¿åˆ—è¡¨è¿›è¡ŒæŸ¥æ‰¾
- [ ] ç¼“å­˜æœ‰è¿‡æœŸæ—¶é—´
- [ ] ç©å®¶ç¦»å¼€æ—¶æ¸…ç†ç¼“å­˜

### âœ… ç½‘ç»œé€šä¿¡

- [ ] RPCè°ƒç”¨é¢‘ç‡<10æ¬¡/ç§’
- [ ] æ•°æ®å‹ç¼©ï¼ˆçŸ­é”®åã€ä½è¿ç®—ï¼‰
- [ ] æ‰¹é‡é€šçŸ¥ä½¿ç”¨`BroadcastToAllClient`

### âœ… å†…å­˜ç®¡ç†

- [ ] `Destroy()`ä¸­å–æ¶ˆæ‰€æœ‰äº‹ä»¶ç›‘å¬
- [ ] é¿å…å¾ªç¯å¼•ç”¨
- [ ] å®šæœŸæ¸…ç†æ— ç”¨ç¼“å­˜

---

## åã€æ€§èƒ½åŸºå‡†æµ‹è¯•

### æ¨èé…ç½®ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è­¦å‘Šé˜ˆå€¼ |
|------|-------|---------|
| æœåŠ¡å™¨TPS | â‰¥18 | <15 |
| Update()è€—æ—¶ | <5ms | >10ms |
| å•æ¬¡RPCè€—æ—¶ | <10ms | >50ms |
| å†…å­˜å ç”¨ï¼ˆ100ç©å®¶ï¼‰ | <500MB | >1GB |
| äº‹ä»¶ç›‘å¬å™¨æ•°é‡ | <50ä¸ª/System | >100ä¸ª |

---

## åä¸€ã€å‚è€ƒèµ„æº

### ç›¸å…³å·¥ä½œæµæ–‡æ¡£
- **RegisterViewè¯¦è§£**: å‚è€ƒ`æ·±å…¥ç†è§£ECSæ¶æ„.md`
- **äº‹ä»¶æ€§èƒ½ä¼˜åŒ–**: å‚è€ƒ`äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md`
- **ç½‘ç»œä¼˜åŒ–**: å‚è€ƒ`ç½‘ç»œæ¶æ„ä¸é€šä¿¡.md`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-11
**ç»´æŠ¤è€…**: NeteaseMod-Claudeå·¥ä½œæµ
