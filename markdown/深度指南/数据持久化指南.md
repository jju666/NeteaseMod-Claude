# æ•°æ®æŒä¹…åŒ–æŒ‡å—

> **ğŸ“ å¯¼èˆª**: [ğŸ  é¦–é¡µ](../README.md) > [ğŸ“‚ æ–‡æ¡£](../README.md#æ–‡æ¡£å¯¼èˆª) > æ•°æ®æŒä¹…åŒ–æŒ‡å—
>
> **æ–‡æ¡£è¯´æ˜**: æ·±å…¥è®²è§£MODSDKçš„æ•°æ®æŒä¹…åŒ–æœºåˆ¶å’Œæœ€ä½³å®è·µ
>
> **ğŸ“… æœ€åæ›´æ–°**: 2025-01-11
> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0

---

## ğŸ“‹ ç›®å½•

1. [æŒä¹…åŒ–æ¦‚è¿°](#1-æŒä¹…åŒ–æ¦‚è¿°)
2. [ExtraDataç»„ä»¶è¯¦è§£](#2-extradataç»„ä»¶è¯¦è§£)
3. [æœ¬åœ°æ–‡ä»¶å­˜å‚¨](#3-æœ¬åœ°æ–‡ä»¶å­˜å‚¨)
4. [æ•°æ®ç»“æ„è®¾è®¡](#4-æ•°æ®ç»“æ„è®¾è®¡)
5. [ç‰ˆæœ¬æ§åˆ¶ä¸è¿ç§»](#5-ç‰ˆæœ¬æ§åˆ¶ä¸è¿ç§»)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [å¸¸è§é—®é¢˜FAQ](#7-å¸¸è§é—®é¢˜faq)

---

## 1. æŒä¹…åŒ–æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®æŒä¹…åŒ–ï¼Ÿ

**å®šä¹‰**ï¼šå°†è¿è¡Œæ—¶æ•°æ®ä¿å­˜åˆ°å­˜å‚¨ä»‹è´¨ï¼ˆç¡¬ç›˜ï¼‰ï¼Œä½¿æ•°æ®åœ¨æœåŠ¡å™¨é‡å¯åä»ç„¶å­˜åœ¨ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ç©å®¶å±æ€§ï¼ˆç­‰çº§ã€ç»éªŒã€è´§å¸ï¼‰
- âœ… æ¸¸æˆè¿›åº¦ï¼ˆæˆå°±ã€ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼‰
- âœ… è‡ªå®šä¹‰é…ç½®ï¼ˆå•†å“ä»·æ ¼ã€æ´»åŠ¨æ—¶é—´ï¼‰
- âœ… ç»Ÿè®¡æ•°æ®ï¼ˆå‡»æ€æ•°ã€æ¸¸æˆæ—¶é•¿ï¼‰

---

### 1.2 MODSDKæä¾›çš„æŒä¹…åŒ–æ–¹æ¡ˆ

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | å­˜å‚¨ä½ç½® | API |
|------|---------|---------|-----|
| **ExtraDataç»„ä»¶** | ç©å®¶/å®ä½“/ä¸–ç•Œçº§åˆ«æ•°æ® | ä¸–ç•Œå­˜æ¡£ç›®å½• | `CreateExtraData()` |
| **æœ¬åœ°æ–‡ä»¶** | å…¨å±€é…ç½®ã€æ—¥å¿— | `behavior_packs/YourMod/` | Python `open()` |
| **æ•°æ®åº“ï¼ˆç¬¬ä¸‰æ–¹ï¼‰** | å¤§è§„æ¨¡æ•°æ®ã€è·¨æœåŠ¡å™¨ | å¤–éƒ¨MySQL/Redis | éœ€è‡ªè¡Œå®ç° |

**æ¨èæ–¹æ¡ˆ**ï¼š
- ğŸ¥‡ **ExtraData** - MODSDKå®˜æ–¹æ¨èï¼Œè‡ªåŠ¨åŒæ­¥
- ğŸ¥ˆ **æœ¬åœ°æ–‡ä»¶** - é…ç½®æ–‡ä»¶ã€æ—¥å¿—
- ğŸ¥‰ **æ•°æ®åº“** - è¶…å‡ºMODSDKèŒƒå›´ï¼ˆéœ€è¦å¤–éƒ¨æœåŠ¡å™¨ï¼‰

---

### 1.3 æ•°æ®æŒä¹…åŒ–çš„ç”Ÿå‘½å‘¨æœŸ

```mermaid
graph LR
    A[æ¸¸æˆå¯åŠ¨] --> B[ä»ExtraDataè¯»å–æ•°æ®]
    B --> C[åŠ è½½åˆ°å†…å­˜ç¼“å­˜]
    C --> D[è¿è¡Œæ—¶ä¿®æ”¹æ•°æ®]
    D --> E{éœ€è¦æŒä¹…åŒ–?}
    E -->|æ˜¯| F[å†™å…¥ExtraData]
    E -->|å¦| D
    F --> G[è‡ªåŠ¨åŒæ­¥åˆ°ç¡¬ç›˜]
    G --> H[æœåŠ¡å™¨å…³é—­/é‡å¯]
    H --> A
```

---

## 2. ExtraDataç»„ä»¶è¯¦è§£

### 2.1 ExtraDataåŸºç¡€æ¦‚å¿µ

**ExtraDataæ˜¯ä»€ä¹ˆ**ï¼š
- ç½‘æ˜“æˆ‘çš„ä¸–ç•Œå¼•æ“æä¾›çš„é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿ
- ç±»ä¼¼äºPythonçš„å­—å…¸ï¼Œä½†æ•°æ®ä¼šè‡ªåŠ¨æŒä¹…åŒ–
- æ”¯æŒä¸‰ç§ä½œç”¨åŸŸï¼šç©å®¶çº§ã€å®ä½“çº§ã€ä¸–ç•Œçº§

---

### 2.2 åˆ›å»ºExtraDataç»„ä»¶

#### æœåŠ¡ç«¯åˆ›å»º

```python
import mod.server.extraServerApi as serverApi

# åœ¨Systemçš„__init__æ–¹æ³•ä¸­åˆ›å»º
def __init__(self, namespace, systemName):
    super(MyServerSystem, self).__init__(namespace, systemName)

    # åˆ›å»ºExtraDataç»„ä»¶
    levelId = serverApi.GetLevelId()
    self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(levelId)
```

**âš ï¸ é‡è¦**ï¼š
- ExtraDataç»„ä»¶**ä»…åœ¨æœåŠ¡ç«¯å¯ç”¨**
- å®¢æˆ·ç«¯æ— æ³•ç›´æ¥è®¿é—®ExtraData
- å®¢æˆ·ç«¯éœ€è¦é€šè¿‡RPCè¯·æ±‚æœåŠ¡ç«¯è·å–æ•°æ®

---

### 2.3 ä¸‰ç§ä½œç”¨åŸŸè¯¦è§£

#### ä½œç”¨åŸŸ1ï¼šç©å®¶çº§æ•°æ®ï¼ˆPlayer Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- ç»‘å®šåˆ°ç‰¹å®šç©å®¶
- ç©å®¶ç¦»å¼€æœåŠ¡å™¨åæ•°æ®ä»ä¿ç•™
- é€‚åˆå­˜å‚¨ç©å®¶å±æ€§ã€èƒŒåŒ…æ•°æ®

**API**ï¼š
```python
# å­˜å‚¨ç©å®¶æ•°æ®
self.extraDataComp.SetExtraData(playerId, key, value)

# è¯»å–ç©å®¶æ•°æ®
value = self.extraDataComp.GetExtraData(playerId, key)
```

**ç¤ºä¾‹**ï¼šç©å®¶ç­‰çº§ç³»ç»Ÿ

```python
def SavePlayerLevel(self, playerId, level):
    """ä¿å­˜ç©å®¶ç­‰çº§"""
    self.extraDataComp.SetExtraData(playerId, 'player_level', str(level))
    print("ä¿å­˜ç©å®¶ç­‰çº§:", playerId, level)

def LoadPlayerLevel(self, playerId):
    """åŠ è½½ç©å®¶ç­‰çº§"""
    levelStr = self.extraDataComp.GetExtraData(playerId, 'player_level')
    if levelStr:
        return int(levelStr)
    return 1  # é»˜è®¤ç­‰çº§
```

---

#### ä½œç”¨åŸŸ2ï¼šå®ä½“çº§æ•°æ®ï¼ˆEntity Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- ç»‘å®šåˆ°ç‰¹å®šå®ä½“ï¼ˆåŒ…æ‹¬NPCã€æ€ªç‰©ï¼‰
- å®ä½“è¢«é”€æ¯æ—¶æ•°æ®è‡ªåŠ¨æ¸…ç†
- é€‚åˆå­˜å‚¨å®ä½“çŠ¶æ€ã€AIæ•°æ®

**API**ï¼š
```python
# å­˜å‚¨å®ä½“æ•°æ®
self.extraDataComp.SetExtraData(entityId, key, value)

# è¯»å–å®ä½“æ•°æ®
value = self.extraDataComp.GetExtraData(entityId, key)
```

**ç¤ºä¾‹**ï¼šNPCå¯¹è¯è¿›åº¦

```python
def SaveNPCDialogueProgress(self, npcId, dialogueStage):
    """ä¿å­˜NPCå¯¹è¯è¿›åº¦"""
    self.extraDataComp.SetExtraData(npcId, 'dialogue_stage', str(dialogueStage))

def LoadNPCDialogueProgress(self, npcId):
    """åŠ è½½NPCå¯¹è¯è¿›åº¦"""
    stageStr = self.extraDataComp.GetExtraData(npcId, 'dialogue_stage')
    if stageStr:
        return int(stageStr)
    return 0  # åˆå§‹é˜¶æ®µ
```

---

#### ä½œç”¨åŸŸ3ï¼šä¸–ç•Œçº§æ•°æ®ï¼ˆLevel Scopeï¼‰

**ç‰¹ç‚¹**ï¼š
- å…¨å±€æ•°æ®ï¼Œä¸ç»‘å®šåˆ°ç‰¹å®šç©å®¶æˆ–å®ä½“
- æ•´ä¸ªä¸–ç•Œå…±äº«
- é€‚åˆå­˜å‚¨æœåŠ¡å™¨é…ç½®ã€å…¨å±€ç»Ÿè®¡

**API**ï¼š
```python
# ä½¿ç”¨levelIdä½œä¸ºentityId
levelId = serverApi.GetLevelId()

# å­˜å‚¨ä¸–ç•Œçº§æ•°æ®
self.extraDataComp.SetExtraData(levelId, key, value)

# è¯»å–ä¸–ç•Œçº§æ•°æ®
value = self.extraDataComp.GetExtraData(levelId, key)
```

**ç¤ºä¾‹**ï¼šå…¨å±€å•†å“åº“å­˜

```python
def SaveGlobalStock(self, itemId, stock):
    """ä¿å­˜å…¨å±€å•†å“åº“å­˜"""
    levelId = serverApi.GetLevelId()

    # è¯»å–ç°æœ‰åº“å­˜æ•°æ®
    stockDataStr = self.extraDataComp.GetExtraData(levelId, 'global_stock')
    stockDict = {}
    if stockDataStr:
        stockDict = json.loads(stockDataStr)

    # æ›´æ–°åº“å­˜
    stockDict[itemId] = stock

    # ä¿å­˜å›ExtraData
    self.extraDataComp.SetExtraData(levelId, 'global_stock', json.dumps(stockDict))

def LoadGlobalStock(self, itemId):
    """åŠ è½½å…¨å±€å•†å“åº“å­˜"""
    levelId = serverApi.GetLevelId()
    stockDataStr = self.extraDataComp.GetExtraData(levelId, 'global_stock')

    if stockDataStr:
        stockDict = json.loads(stockDataStr)
        return stockDict.get(itemId, 0)
    return 0
```

---

### 2.4 æ”¯æŒçš„æ•°æ®ç±»å‹

**ExtraDataåªæ”¯æŒå­—ç¬¦ä¸²ç±»å‹**ï¼š

| æ•°æ®ç±»å‹ | æ˜¯å¦æ”¯æŒ | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| å­—ç¬¦ä¸²ï¼ˆstrï¼‰ | âœ… ç›´æ¥æ”¯æŒ | `SetExtraData(id, key, "value")` |
| æ•´æ•°ï¼ˆintï¼‰ | âŒ ä¸æ”¯æŒ | è½¬ä¸ºå­—ç¬¦ä¸²ï¼š`str(123)` |
| æµ®ç‚¹æ•°ï¼ˆfloatï¼‰ | âŒ ä¸æ”¯æŒ | è½¬ä¸ºå­—ç¬¦ä¸²ï¼š`str(3.14)` |
| å¸ƒå°”å€¼ï¼ˆboolï¼‰ | âŒ ä¸æ”¯æŒ | è½¬ä¸ºå­—ç¬¦ä¸²ï¼š`"True"` / `"False"` |
| åˆ—è¡¨ï¼ˆlistï¼‰ | âŒ ä¸æ”¯æŒ | JSONåºåˆ—åŒ–ï¼š`json.dumps([1,2,3])` |
| å­—å…¸ï¼ˆdictï¼‰ | âŒ ä¸æ”¯æŒ | JSONåºåˆ—åŒ–ï¼š`json.dumps({...})` |

---

### 2.5 å­˜å‚¨å¤æ‚æ•°æ®ç»“æ„ï¼ˆJSONåºåˆ—åŒ–ï¼‰

#### ç¤ºä¾‹ï¼šå­˜å‚¨ç©å®¶èƒŒåŒ…æ•°æ®

```python
# -*- coding: utf-8 -*-
import json

def SavePlayerInventory(self, playerId, inventoryData):
    """
    ä¿å­˜ç©å®¶èƒŒåŒ…æ•°æ®

    Args:
        playerId (str): ç©å®¶ID
        inventoryData (dict): {
            'items': [
                {'slot': 0, 'itemName': 'minecraft:diamond', 'count': 64},
                {'slot': 1, 'itemName': 'minecraft:iron_sword', 'count': 1}
            ],
            'money': 1000
        }
    """
    # å°†å­—å…¸è½¬ä¸ºJSONå­—ç¬¦ä¸²
    jsonStr = json.dumps(inventoryData)

    # å­˜å‚¨åˆ°ExtraData
    self.extraDataComp.SetExtraData(playerId, 'inventory_data', jsonStr)
    print("ä¿å­˜èƒŒåŒ…æ•°æ®:", playerId, len(inventoryData['items']), "ä¸ªç‰©å“")

def LoadPlayerInventory(self, playerId):
    """
    åŠ è½½ç©å®¶èƒŒåŒ…æ•°æ®

    Returns:
        dict: èƒŒåŒ…æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›é»˜è®¤å€¼
    """
    # ä»ExtraDataè¯»å–
    jsonStr = self.extraDataComp.GetExtraData(playerId, 'inventory_data')

    if jsonStr:
        # å°†JSONå­—ç¬¦ä¸²è§£æä¸ºå­—å…¸
        inventoryData = json.loads(jsonStr)
        return inventoryData
    else:
        # è¿”å›é»˜è®¤å€¼
        return {
            'items': [],
            'money': 0
        }
```

---

### 2.6 ExtraDataçš„é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

#### é™åˆ¶1ï¼šå­˜å‚¨å®¹é‡é™åˆ¶

**å•ä¸ªKeyçš„æœ€å¤§é•¿åº¦**ï¼š
- âš ï¸ å®˜æ–¹æ–‡æ¡£æœªæ˜ç¡®è¯´æ˜å…·ä½“é™åˆ¶
- å»ºè®®å•ä¸ªKeyå­˜å‚¨çš„æ•°æ®ä¸è¶…è¿‡ **1MB**
- å¦‚æœæ•°æ®è¿‡å¤§ï¼Œè€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ªKey

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†å—å­˜å‚¨

```python
def SaveLargeData(self, playerId, largeDataList):
    """åˆ†å—å­˜å‚¨å¤§å‹æ•°æ®"""
    chunkSize = 100  # æ¯å—100æ¡è®°å½•

    for i in range(0, len(largeDataList), chunkSize):
        chunk = largeDataList[i:i+chunkSize]
        chunkIndex = i // chunkSize
        key = 'large_data_chunk_{}'.format(chunkIndex)
        self.extraDataComp.SetExtraData(playerId, key, json.dumps(chunk))

    # è®°å½•æ€»å—æ•°
    totalChunks = (len(largeDataList) + chunkSize - 1) // chunkSize
    self.extraDataComp.SetExtraData(playerId, 'large_data_chunks', str(totalChunks))

def LoadLargeData(self, playerId):
    """åŠ è½½åˆ†å—æ•°æ®"""
    totalChunksStr = self.extraDataComp.GetExtraData(playerId, 'large_data_chunks')
    if not totalChunksStr:
        return []

    totalChunks = int(totalChunksStr)
    allData = []

    for i in range(totalChunks):
        key = 'large_data_chunk_{}'.format(i)
        chunkStr = self.extraDataComp.GetExtraData(playerId, key)
        if chunkStr:
            chunk = json.loads(chunkStr)
            allData.extend(chunk)

    return allData
```

---

#### é™åˆ¶2ï¼šå†™å…¥æ€§èƒ½é™åˆ¶

**é—®é¢˜**ï¼šé¢‘ç¹å†™å…¥ExtraDataä¼šå½±å“æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**ï¼šå†…å­˜ç¼“å­˜ + å®šæœŸæŒä¹…åŒ–

```python
class PlayerDataSystem(ServerSystem):
    def __init__(self, namespace, systemName):
        super(PlayerDataSystem, self).__init__(namespace, systemName)
        self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(serverApi.GetLevelId())

        # å†…å­˜ç¼“å­˜
        self.playerDataCache = {}

        # å®šæ—¶å™¨ï¼šæ¯10ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
        self.CreateTimer(10.0, self.AutoSaveAllPlayers)

    def UpdatePlayerData(self, playerId, key, value):
        """æ›´æ–°ç©å®¶æ•°æ®ï¼ˆä»…ä¿®æ”¹ç¼“å­˜ï¼‰"""
        if playerId not in self.playerDataCache:
            self.playerDataCache[playerId] = {}

        self.playerDataCache[playerId][key] = value
        # ä¸ç«‹å³å†™å…¥ExtraData

    def AutoSaveAllPlayers(self):
        """å®šæœŸä¿å­˜æ‰€æœ‰ç©å®¶æ•°æ®"""
        for playerId, data in self.playerDataCache.items():
            self._SavePlayerData(playerId, data)

        print("[DataSystem] è‡ªåŠ¨ä¿å­˜å®Œæˆ,å…±", len(self.playerDataCache), "ä¸ªç©å®¶")

        # é‡æ–°åˆ›å»ºå®šæ—¶å™¨
        self.CreateTimer(10.0, self.AutoSaveAllPlayers)

    def _SavePlayerData(self, playerId, data):
        """å®é™…å†™å…¥ExtraData"""
        jsonStr = json.dumps(data)
        self.extraDataComp.SetExtraData(playerId, 'player_data', jsonStr)
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| ç­–ç•¥ | å†™å…¥é¢‘ç‡ | æ€§èƒ½å½±å“ |
|------|---------|---------|
| ç«‹å³å†™å…¥ | æ¯æ¬¡ä¿®æ”¹éƒ½å†™å…¥ | é«˜ï¼ˆTPSä¸‹é™10-20%ï¼‰ |
| 10ç§’ç¼“å­˜ | æ¯10ç§’å†™å…¥ä¸€æ¬¡ | ä½ï¼ˆTPSä¸‹é™<1%ï¼‰ |
| ç©å®¶ä¸‹çº¿æ—¶ä¿å­˜ | ä»…ä¸‹çº¿æ—¶å†™å…¥ | æä½ï¼ˆé£é™©ï¼šå´©æºƒä¸¢å¤±æ•°æ®ï¼‰ |

**æ¨èç­–ç•¥**ï¼š**10ç§’å®šæ—¶ä¿å­˜ + ç©å®¶ä¸‹çº¿æ—¶ä¿å­˜**

---

#### é™åˆ¶3ï¼šå®¢æˆ·ç«¯æ— æ³•è®¿é—®

**é—®é¢˜**ï¼šå®¢æˆ·ç«¯æ— æ³•ç›´æ¥è¯»å–ExtraData

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡RPCè¯·æ±‚æœåŠ¡ç«¯

```python
# å®¢æˆ·ç«¯System
def RequestPlayerData(self):
    """è¯·æ±‚ç©å®¶æ•°æ®"""
    playerId = clientApi.GetLocalPlayerId()
    self.NotifyToServer('RequestPlayerDataEvent', {'playerId': playerId})

def OnReceivePlayerData(self, args):
    """æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„æ•°æ®"""
    playerData = args['data']
    print("[Client] æ”¶åˆ°ç©å®¶æ•°æ®:", playerData)

# æœåŠ¡ç«¯System
def OnRequestPlayerData(self, args):
    """å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚"""
    playerId = args['playerId']

    # ä»ExtraDataè¯»å–
    dataStr = self.extraDataComp.GetExtraData(playerId, 'player_data')
    data = json.loads(dataStr) if dataStr else {}

    # å‘é€å›å®¢æˆ·ç«¯
    self.NotifyToClient(playerId, 'ReceivePlayerDataEvent', {'data': data})
```

---

## 3. æœ¬åœ°æ–‡ä»¶å­˜å‚¨

### 3.1 ä½•æ—¶ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å…¨å±€é…ç½®æ–‡ä»¶ï¼ˆå•†å“ä»·æ ¼ã€æ´»åŠ¨æ—¶é—´ï¼‰
- âœ… æ—¥å¿—æ–‡ä»¶ï¼ˆè°ƒè¯•ä¿¡æ¯ã€é”™è¯¯è®°å½•ï¼‰
- âœ… å¤§å‹é™æ€æ•°æ®ï¼ˆåœ°å›¾æ•°æ®ã€NPCå¯¹è¯æ–‡æœ¬ï¼‰

**ä¸é€‚åˆ**ï¼š
- âŒ ç©å®¶æ•°æ®ï¼ˆåº”ä½¿ç”¨ExtraDataï¼‰
- âŒ å®ä½“æ•°æ®ï¼ˆåº”ä½¿ç”¨ExtraDataï¼‰

---

### 3.2 æ–‡ä»¶è·¯å¾„è§„èŒƒ

**æ¨èç›®å½•ç»“æ„**ï¼š

```
behavior_packs/YourMod/
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ shop_items.json  # å•†å“é…ç½®
â”‚   â””â”€â”€ settings.json    # ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ logs/                # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ debug.log        # è°ƒè¯•æ—¥å¿—
â”œâ”€â”€ data/                # æ•°æ®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ npc_dialogues.json  # NPCå¯¹è¯
â””â”€â”€ modMain.py
```

---

### 3.3 è¯»å–é…ç½®æ–‡ä»¶

#### ç¤ºä¾‹ï¼šåŠ è½½å•†å“é…ç½®

```python
# -*- coding: utf-8 -*-
import json
import os

def LoadShopConfig(self):
    """
    åŠ è½½å•†å“é…ç½®æ–‡ä»¶

    Returns:
        dict: å•†å“é…ç½®
    """
    # æ„å»ºé…ç½®æ–‡ä»¶è·¯å¾„
    modPath = os.path.dirname(__file__)  # å½“å‰MODç›®å½•
    configPath = os.path.join(modPath, 'config', 'shop_items.json')

    try:
        # è¯»å–æ–‡ä»¶
        with open(configPath, 'r', encoding='utf-8') as f:
            config = json.load(f)
            print("[Config] åŠ è½½å•†å“é…ç½®æˆåŠŸ,å…±", len(config), "ä¸ªå•†å“")
            return config
    except IOError as e:
        print("[Config] é…ç½®æ–‡ä»¶ä¸å­˜åœ¨:", configPath)
        return {}
    except ValueError as e:
        print("[Config] JSONæ ¼å¼é”™è¯¯:", e)
        return {}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼ˆ`config/shop_items.json`ï¼‰ï¼š

```json
{
  "shop_sword_001": {
    "id": "shop_sword_001",
    "name": "é’»çŸ³å‰‘",
    "price": 100,
    "rewardItem": "minecraft:diamond_sword"
  },
  "shop_apple_001": {
    "id": "shop_apple_001",
    "name": "é‡‘è‹¹æœ",
    "price": 50,
    "rewardItem": "minecraft:golden_apple"
  }
}
```

---

### 3.4 å†™å…¥æ—¥å¿—æ–‡ä»¶

#### ç¤ºä¾‹ï¼šè°ƒè¯•æ—¥å¿—ç³»ç»Ÿ

```python
# -*- coding: utf-8 -*-
import os
import time

class LogManager:
    """æ—¥å¿—ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""

    _instance = None

    @staticmethod
    def GetInstance():
        if LogManager._instance is None:
            LogManager._instance = LogManager()
        return LogManager._instance

    def __init__(self):
        # æ„å»ºæ—¥å¿—æ–‡ä»¶è·¯å¾„
        modPath = os.path.dirname(__file__)
        logDir = os.path.join(modPath, 'logs')

        # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        if not os.path.exists(logDir):
            os.makedirs(logDir)

        self.logFilePath = os.path.join(logDir, 'debug.log')

    def Log(self, level, message):
        """
        å†™å…¥æ—¥å¿—

        Args:
            level (str): æ—¥å¿—çº§åˆ«ï¼ˆINFO, WARNING, ERRORï¼‰
            message (str): æ—¥å¿—å†…å®¹
        """
        timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
        logLine = '[{}] [{}] {}\n'.format(timestamp, level, message)

        try:
            # è¿½åŠ æ¨¡å¼å†™å…¥
            with open(self.logFilePath, 'a', encoding='utf-8') as f:
                f.write(logLine)
        except IOError as e:
            print("[LogManager] å†™å…¥æ—¥å¿—å¤±è´¥:", e)

    def Info(self, message):
        self.Log('INFO', message)

    def Warning(self, message):
        self.Log('WARNING', message)

    def Error(self, message):
        self.Log('ERROR', message)

# ä½¿ç”¨ç¤ºä¾‹
logger = LogManager.GetInstance()
logger.Info("æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ")
logger.Warning("ç©å®¶ä½™é¢ä¸è¶³")
logger.Error("å•†å“é…ç½®åŠ è½½å¤±è´¥")
```

---

### 3.5 æ–‡ä»¶æ“ä½œæ³¨æ„äº‹é¡¹

#### æ³¨æ„1ï¼šæ–‡ä»¶ç¼–ç 

**é—®é¢˜**ï¼šä¸­æ–‡ä¹±ç 

**è§£å†³æ–¹æ¡ˆ**ï¼šå§‹ç»ˆä½¿ç”¨UTF-8ç¼–ç 

```python
# âœ… æ­£ç¡®åšæ³•
with open(filePath, 'r', encoding='utf-8') as f:
    content = f.read()

# âŒ é”™è¯¯åšæ³•ï¼ˆPython 2.7é»˜è®¤ASCIIç¼–ç ï¼‰
with open(filePath, 'r') as f:
    content = f.read()
```

---

#### æ³¨æ„2ï¼šå¼‚å¸¸å¤„ç†

**é—®é¢˜**ï¼šæ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´å´©æºƒ

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨try-exceptæ•è·å¼‚å¸¸

```python
try:
    with open(filePath, 'r', encoding='utf-8') as f:
        data = json.load(f)
except IOError:
    print("æ–‡ä»¶ä¸å­˜åœ¨:", filePath)
    data = {}  # è¿”å›é»˜è®¤å€¼
except ValueError:
    print("JSONæ ¼å¼é”™è¯¯")
    data = {}
```

---

#### æ³¨æ„3ï¼šè·¯å¾„å…¼å®¹æ€§

**é—®é¢˜**ï¼šWindowså’ŒLinuxè·¯å¾„åˆ†éš”ç¬¦ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨`os.path.join()`

```python
# âœ… æ­£ç¡®åšæ³•ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
configPath = os.path.join(modPath, 'config', 'shop_items.json')

# âŒ é”™è¯¯åšæ³•ï¼ˆWindowsä¸“ç”¨ï¼‰
configPath = modPath + '\\config\\shop_items.json'
```

---

## 4. æ•°æ®ç»“æ„è®¾è®¡

### 4.1 è®¾è®¡åŸåˆ™

#### åŸåˆ™1ï¼šæ‰å¹³åŒ–ç»“æ„

**é—®é¢˜**ï¼šæ·±å±‚åµŒå¥—éš¾ä»¥ç»´æŠ¤

```python
# âŒ ä¸æ¨èï¼šè¿‡åº¦åµŒå¥—
playerData = {
    'attributes': {
        'combat': {
            'strength': 10,
            'defense': 5
        },
        'magic': {
            'mana': 100,
            'spellPower': 20
        }
    }
}

# âœ… æ¨èï¼šæ‰å¹³åŒ–
playerData = {
    'combat_strength': 10,
    'combat_defense': 5,
    'magic_mana': 100,
    'magic_spellPower': 20
}
```

---

#### åŸåˆ™2ï¼šæ•°æ®ç‰ˆæœ¬æ§åˆ¶

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼šæœªæ¥å¯èƒ½éœ€è¦ä¿®æ”¹æ•°æ®ç»“æ„

```python
# å­˜å‚¨æ—¶æ·»åŠ ç‰ˆæœ¬å·
playerData = {
    '_version': 2,  # æ•°æ®ç»“æ„ç‰ˆæœ¬
    'level': 10,
    'exp': 5000
}

# è¯»å–æ—¶æ£€æŸ¥ç‰ˆæœ¬
def LoadPlayerData(self, playerId):
    dataStr = self.extraDataComp.GetExtraData(playerId, 'player_data')
    if not dataStr:
        return self._GetDefaultData()

    data = json.loads(dataStr)
    version = data.get('_version', 1)

    # ç‰ˆæœ¬è¿ç§»
    if version == 1:
        data = self._MigrateV1ToV2(data)

    return data
```

---

### 4.2 å¸¸è§æ•°æ®ç»“æ„ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šç©å®¶å±æ€§æ•°æ®

```python
playerData = {
    '_version': 1,
    'level': 10,
    'exp': 5000,
    'money': 1000,
    'vip_level': 2,
    'last_login': '2025-01-11 10:00:00'
}
```

---

#### ç¤ºä¾‹2ï¼šæˆå°±è¿›åº¦æ•°æ®

```python
achievementData = {
    '_version': 1,
    'kill_zombie_100': 45,  # å½“å‰è¿›åº¦
    'kill_skeleton_50': 12,
    'place_block_1000': 567
}
```

---

#### ç¤ºä¾‹3ï¼šå•†åŸè´­ä¹°å†å²

```python
purchaseHistory = {
    '_version': 1,
    'records': [
        {
            'itemId': 'shop_sword_001',
            'count': 1,
            'price': 100,
            'timestamp': 1704960000
        },
        {
            'itemId': 'shop_apple_001',
            'count': 10,
            'price': 500,
            'timestamp': 1704963600
        }
    ],
    'total_spent': 600
}
```

---

## 5. ç‰ˆæœ¬æ§åˆ¶ä¸è¿ç§»

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®è¿ç§»ï¼Ÿ

**åœºæ™¯**ï¼š
- æ–°ç‰ˆæœ¬ä¿®æ”¹äº†æ•°æ®ç»“æ„
- æ·»åŠ äº†æ–°å­—æ®µ
- åˆ é™¤äº†åºŸå¼ƒå­—æ®µ

**ä¸è¿ç§»çš„åæœ**ï¼š
- âŒ è¯»å–æ—§æ•°æ®æ—¶æŠ¥é”™
- âŒ ç¼ºå°‘æ–°å­—æ®µå¯¼è‡´åŠŸèƒ½å¼‚å¸¸

---

### 5.2 æ•°æ®è¿ç§»ç­–ç•¥

#### ç­–ç•¥1ï¼šå‘åå…¼å®¹ï¼ˆBackward Compatibilityï¼‰

**åŸåˆ™**ï¼šæ–°ç‰ˆæœ¬ä»£ç èƒ½å¤„ç†æ—§ç‰ˆæœ¬æ•°æ®

```python
def LoadPlayerData(self, playerId):
    """åŠ è½½ç©å®¶æ•°æ®ï¼ˆå‘åå…¼å®¹ï¼‰"""
    dataStr = self.extraDataComp.GetExtraData(playerId, 'player_data')

    if not dataStr:
        # æ–°ç©å®¶ï¼šè¿”å›é»˜è®¤æ•°æ®
        return {
            '_version': 2,
            'level': 1,
            'exp': 0,
            'money': 1000,
            'vip_level': 0  # v2æ–°å¢å­—æ®µ
        }

    data = json.loads(dataStr)
    version = data.get('_version', 1)

    # v1 â†’ v2è¿ç§»
    if version == 1:
        # æ·»åŠ v2æ–°å¢çš„å­—æ®µ
        data['vip_level'] = 0
        data['_version'] = 2

        # ä¿å­˜è¿ç§»åçš„æ•°æ®
        self.SavePlayerData(playerId, data)
        print("[Migrate] ç©å®¶æ•°æ®å·²è¿ç§»è‡³v2:", playerId)

    return data
```

---

#### ç­–ç•¥2ï¼šä¸»åŠ¨è¿ç§»ï¼ˆEager Migrationï¼‰

**åœºæ™¯**ï¼šæœåŠ¡å™¨å¯åŠ¨æ—¶æ‰¹é‡è¿ç§»æ‰€æœ‰ç©å®¶æ•°æ®

```python
def MigrateAllPlayerData(self):
    """ä¸»åŠ¨è¿ç§»æ‰€æœ‰ç©å®¶æ•°æ®"""
    # è·å–æ‰€æœ‰ç©å®¶IDï¼ˆéœ€è¦è‡ªå·±ç»´æŠ¤ç©å®¶åˆ—è¡¨ï¼‰
    allPlayers = self._GetAllPlayerIds()

    migratedCount = 0
    for playerId in allPlayers:
        dataStr = self.extraDataComp.GetExtraData(playerId, 'player_data')
        if not dataStr:
            continue

        data = json.loads(dataStr)
        version = data.get('_version', 1)

        if version < 2:
            # æ‰§è¡Œè¿ç§»
            data = self._MigrateV1ToV2(data)
            self.SavePlayerData(playerId, data)
            migratedCount += 1

    print("[Migrate] æ•°æ®è¿ç§»å®Œæˆ,å…±", migratedCount, "ä¸ªç©å®¶")
```

---

### 5.3 è¿ç§»è„šæœ¬ç¤ºä¾‹

```python
def _MigrateV1ToV2(self, data):
    """v1 â†’ v2è¿ç§»é€»è¾‘"""
    # v1ç»“æ„ï¼š
    # {
    #     '_version': 1,
    #     'level': 10,
    #     'exp': 5000,
    #     'money': 1000
    # }

    # v2ç»“æ„ï¼š
    # {
    #     '_version': 2,
    #     'level': 10,
    #     'exp': 5000,
    #     'money': 1000,
    #     'vip_level': 0  # æ–°å¢å­—æ®µ
    # }

    # æ·»åŠ æ–°å­—æ®µ
    data['vip_level'] = 0

    # æ›´æ–°ç‰ˆæœ¬å·
    data['_version'] = 2

    return data

def _MigrateV2ToV3(self, data):
    """v2 â†’ v3è¿ç§»é€»è¾‘"""
    # v3æ”¹åŠ¨ï¼šå°†'money'å­—æ®µé‡å‘½åä¸º'coins'

    # é‡å‘½åå­—æ®µ
    data['coins'] = data.pop('money', 0)

    # æ›´æ–°ç‰ˆæœ¬å·
    data['_version'] = 3

    return data
```

---

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

| ç­–ç•¥ | æ€§èƒ½æå‡ | å®ç°éš¾åº¦ | æ¨èåº¦ |
|------|---------|---------|-------|
| å†…å­˜ç¼“å­˜ | â­â­â­â­â­ | ç®€å• | ğŸ¥‡ å¼ºçƒˆæ¨è |
| å®šæ—¶æ‰¹é‡ä¿å­˜ | â­â­â­â­ | ç®€å• | ğŸ¥‡ å¼ºçƒˆæ¨è |
| åˆ†å—å­˜å‚¨ | â­â­â­ | ä¸­ç­‰ | ğŸ¥ˆ å¤§æ•°æ®å¿…é€‰ |
| å¢é‡åŒæ­¥ | â­â­â­â­ | ä¸­ç­‰ | ğŸ¥ˆ æ¨è |
| å‹ç¼©å­˜å‚¨ | â­â­ | å¤æ‚ | ğŸ¥‰ å¯é€‰ |

---

### 6.2 ç­–ç•¥1ï¼šå†…å­˜ç¼“å­˜

**ä»£ç ç¤ºä¾‹**ï¼ˆè§2.6èŠ‚"é™åˆ¶2"ï¼‰

**æ€§èƒ½å¯¹æ¯”**ï¼š
- ç›´æ¥è¯»å†™ExtraDataï¼š**1000æ¬¡/ç§’**
- å†…å­˜ç¼“å­˜ + å®šæœŸä¿å­˜ï¼š**100,000æ¬¡/ç§’**ï¼ˆæå‡100å€ï¼‰

---

### 6.3 ç­–ç•¥2ï¼šå¢é‡åŒæ­¥

**åœºæ™¯**ï¼šæˆå°±ç³»ç»Ÿä»…ä¸ŠæŠ¥å˜åŒ–çš„æˆå°±

```python
# è®°å½•ä¸Šæ¬¡ä¿å­˜çš„å¿«ç…§
self.lastSavedSnapshot = {}

def SavePlayerDataIncremental(self, playerId):
    """å¢é‡ä¿å­˜ï¼ˆä»…ä¿å­˜å˜åŒ–çš„æ•°æ®ï¼‰"""
    currentData = self.playerDataCache.get(playerId, {})
    lastData = self.lastSavedSnapshot.get(playerId, {})

    # è®¡ç®—å·®å¼‚
    changedKeys = {}
    for key, value in currentData.items():
        if key not in lastData or lastData[key] != value:
            changedKeys[key] = value

    if not changedKeys:
        return  # æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜

    # ä»…ä¿å­˜å˜åŒ–çš„å­—æ®µ
    for key, value in changedKeys.items():
        fieldKey = 'player_{}_{}'.format(playerId, key)
        self.extraDataComp.SetExtraData(playerId, fieldKey, str(value))

    # æ›´æ–°å¿«ç…§
    self.lastSavedSnapshot[playerId] = currentData.copy()
    print("[Data] å¢é‡ä¿å­˜:", playerId, len(changedKeys), "ä¸ªå­—æ®µ")
```

---

### 6.4 ç­–ç•¥3ï¼šå‹ç¼©å­˜å‚¨ï¼ˆé«˜çº§ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®é‡å·¨å¤§ï¼ˆ>100KBï¼‰

```python
import zlib
import base64

def CompressData(self, data):
    """å‹ç¼©æ•°æ®"""
    jsonStr = json.dumps(data)
    compressed = zlib.compress(jsonStr.encode('utf-8'))
    encoded = base64.b64encode(compressed).decode('ascii')
    return encoded

def DecompressData(self, encoded):
    """è§£å‹æ•°æ®"""
    compressed = base64.b64decode(encoded.encode('ascii'))
    jsonStr = zlib.decompress(compressed).decode('utf-8')
    data = json.loads(jsonStr)
    return data
```

**å‹ç¼©æ•ˆæœ**ï¼š
- åŸå§‹æ•°æ®ï¼š100KB
- å‹ç¼©åï¼š30KBï¼ˆå‡å°‘70%ï¼‰

---

## 7. å¸¸è§é—®é¢˜FAQ

### Q1: ExtraDataæ•°æ®ä»€ä¹ˆæ—¶å€™ä¼šä¸¢å¤±ï¼Ÿ

**ç­”æ¡ˆ**ï¼š
- âœ… æ­£å¸¸å…³é—­æœåŠ¡å™¨ï¼šæ•°æ®è‡ªåŠ¨ä¿å­˜
- âŒ æœåŠ¡å™¨å´©æºƒï¼šæœªä¿å­˜çš„ç¼“å­˜æ•°æ®ä¼šä¸¢å¤±
- âœ… ç©å®¶ä¸‹çº¿ï¼šæ•°æ®è‡ªåŠ¨ä¿å­˜

**å»ºè®®**ï¼š
- ä½¿ç”¨10ç§’å®šæ—¶ä¿å­˜ + ç©å®¶ä¸‹çº¿æ—¶ä¿å­˜
- å…³é”®æ“ä½œï¼ˆå¦‚è´­ä¹°ï¼‰ç«‹å³ä¿å­˜

---

### Q2: å¦‚ä½•è°ƒè¯•ExtraDataå­˜å‚¨å¤±è´¥ï¼Ÿ

**æ­¥éª¤**ï¼š
1. æ£€æŸ¥è¿”å›å€¼
```python
success = self.extraDataComp.SetExtraData(playerId, key, value)
if not success:
    print("[Error] ExtraDataä¿å­˜å¤±è´¥:", playerId, key)
```

2. æ£€æŸ¥æ•°æ®å¤§å°
```python
jsonStr = json.dumps(data)
print("æ•°æ®å¤§å°:", len(jsonStr), "å­—èŠ‚")
if len(jsonStr) > 1024 * 1024:  # 1MB
    print("[Warning] æ•°æ®è¿‡å¤§ï¼Œå»ºè®®åˆ†å—å­˜å‚¨")
```

---

### Q3: å¦‚ä½•è¿ç§»æ—§é¡¹ç›®çš„æ•°æ®åˆ°æ–°ç»“æ„ï¼Ÿ

**ç­”æ¡ˆ**ï¼šä½¿ç”¨è¿ç§»è„šæœ¬ï¼ˆè§5.3èŠ‚ï¼‰

---

### Q4: ExtraDataèƒ½å­˜å‚¨ç©å®¶ç¦»çº¿åçš„æ•°æ®å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼šâœ… å¯ä»¥ï¼

ExtraDataç»‘å®šåˆ°ç©å®¶IDï¼Œå³ä½¿ç©å®¶ç¦»çº¿ï¼Œæ•°æ®ä»ç„¶ä¿ç•™åœ¨ä¸–ç•Œå­˜æ¡£ä¸­ã€‚ä¸‹æ¬¡ç™»å½•æ—¶å¯ä»¥è¯»å–ã€‚

---

### Q5: å¦‚ä½•å¤‡ä»½ExtraDataæ•°æ®ï¼Ÿ

**ç­”æ¡ˆ**ï¼š
- ExtraDataå­˜å‚¨åœ¨ä¸–ç•Œå­˜æ¡£ç›®å½•ä¸­
- å¤‡ä»½æ•´ä¸ªä¸–ç•Œå­˜æ¡£å³å¯å¤‡ä»½æ‰€æœ‰ExtraData
- è·¯å¾„ï¼š`worlds/<ä¸–ç•Œå>/db/`ï¼ˆå…·ä½“ä½ç½®å–å†³äºå¼•æ“ç‰ˆæœ¬ï¼‰

---

## ğŸ“š æ¨èé˜…è¯»

å®Œæˆæœ¬æ–‡æ¡£å­¦ä¹ åï¼Œå»ºè®®ç»§ç»­é˜…è¯»ï¼š

- [ä¸šåŠ¡ç³»ç»Ÿå®ç°æ¡ˆä¾‹.md](ä¸šåŠ¡ç³»ç»Ÿå®ç°æ¡ˆä¾‹.md) - ExtraDataåœ¨å®æˆ˜ä¸­çš„åº”ç”¨
- [æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—.md](æ€§èƒ½ä¼˜åŒ–å®Œæ•´æŒ‡å—.md) - æ•°æ®å­˜å‚¨æ€§èƒ½ä¼˜åŒ–
- [å¼€å‘è§„èŒƒ.md](å¼€å‘è§„èŒƒ.md) - æ•°æ®æŒä¹…åŒ–å¼€å‘è§„èŒƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-11
**è´¡çŒ®è€…**: NeteaseMod-Claudeå·¥ä½œæµå›¢é˜Ÿ

**çŸ¥è¯†æ¥æºå£°æ˜**ï¼š
æœ¬æ–‡æ¡£åŸºäºä»¥ä¸‹åˆæ³•æ¥æºç¼–å†™ï¼š
- âœ… MODSDKå®˜æ–¹å¼€å‘æ–‡æ¡£ï¼ˆExtraData Component APIï¼‰
- âœ… Python 2.7æ–‡ä»¶æ“ä½œæ ‡å‡†åº“æ–‡æ¡£
- âœ… é€šç”¨è½¯ä»¶å·¥ç¨‹æ•°æ®æŒä¹…åŒ–æœ€ä½³å®è·µï¼ˆå¦‚ç¼“å­˜ç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶ç­‰ï¼‰

æ‰€æœ‰ä»£ç ç¤ºä¾‹å‡ä¸ºç‹¬ç«‹è®¾è®¡ï¼Œæœªå¼•ç”¨ä»»ä½•éå®˜æ–¹ä»£ç å®ç°ã€‚
