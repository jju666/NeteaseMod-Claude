# ç½‘ç»œæ¶æ„ä¸é€šä¿¡

> ğŸŒ **æ·±å…¥ç†è§£MODSDKåŒç«¯é€šä¿¡æœºåˆ¶**
>
> æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£MODSDKå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ã€ç½‘ç»œé€šä¿¡æ¨¡å¼å’Œæ•°æ®åŒæ­¥ç­–ç•¥
>
> **ç‰ˆæœ¬**: v2.0ï¼ˆç²¾ç®€ç‰ˆï¼‰
> **æœ€åæ›´æ–°**: 2025-11-12

---

## ç›®å½•

1. [åŒç«¯æ¶æ„æ¦‚è¿°](#ä¸€åŒç«¯æ¶æ„æ¦‚è¿°)
2. [åŒç«¯éš”ç¦»åŸç†](#äºŒåŒç«¯éš”ç¦»åŸç†)
3. [RPCé€šä¿¡æœºåˆ¶](#ä¸‰rpcé€šä¿¡æœºåˆ¶)
4. [æ•°æ®åŒæ­¥ç­–ç•¥](#å››æ•°æ®åŒæ­¥ç­–ç•¥)
5. [ç½‘ç»œä¼˜åŒ–æŠ€å·§](#äº”ç½‘ç»œä¼˜åŒ–æŠ€å·§)
6. [å®‰å…¨ä¸é˜²ä½œå¼Š](#å…­å®‰å…¨ä¸é˜²ä½œå¼Š)

---

## ä¸€ã€åŒç«¯æ¶æ„æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯åŒç«¯æ¶æ„?

MODSDKé‡‡ç”¨**å®¢æˆ·ç«¯-æœåŠ¡å™¨åˆ†ç¦»æ¶æ„**ï¼ˆClient-Server Architectureï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         ç½‘ç»œé€šä¿¡        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClientSystem      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   ServerSystem      â”‚
â”‚   (ç©å®¶ç”µè„‘)        â”‚   NotifyToServer/Client  â”‚   (æ¸¸æˆæœåŠ¡å™¨)      â”‚
â”‚                     â”‚                          â”‚                     â”‚
â”‚  - UIæ¸²æŸ“          â”‚                          â”‚  - ä¸šåŠ¡é€»è¾‘         â”‚
â”‚  - ç”¨æˆ·è¾“å…¥        â”‚                          â”‚  - æ•°æ®éªŒè¯         â”‚
â”‚  - ç‰¹æ•ˆæ’­æ”¾        â”‚                          â”‚  - ä¸–ç•ŒçŠ¶æ€ç®¡ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒç«¯åˆ†ç¦»?**

1. **å®‰å…¨æ€§**: é˜²æ­¢å®¢æˆ·ç«¯ä½œå¼Š
2. **æ€§èƒ½**: å®¢æˆ·ç«¯åªå¤„ç†æ¸²æŸ“,æœåŠ¡å™¨ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
3. **å¤šäººåŒæ­¥**: æœåŠ¡å™¨ä½œä¸ºå”¯ä¸€çœŸå®æ•°æ®æº
4. **å¯æ‰©å±•æ€§**: ç‹¬ç«‹å¼€å‘å®¢æˆ·ç«¯UIå’ŒæœåŠ¡å™¨é€»è¾‘

---

### 1.2 å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„èŒè´£

| èŒè´£ | å®¢æˆ·ç«¯ (ClientSystem) | æœåŠ¡å™¨ (ServerSystem) |
|------|---------------------|---------------------|
| **UIæ¸²æŸ“** | âœ… è´Ÿè´£ | âŒ ä¸èƒ½è®¿é—® |
| **ç”¨æˆ·è¾“å…¥** | âœ… æ¥æ”¶å¹¶å‘é€åˆ°æœåŠ¡å™¨ | âŒ ä¸ç›´æ¥å¤„ç† |
| **ä¸šåŠ¡é€»è¾‘** | âŒ ä¸èƒ½å¤„ç† | âœ… å”¯ä¸€å¤„ç†è€… |
| **æ•°æ®éªŒè¯** | âŒ å¯åšæœ¬åœ°é¢„éªŒè¯ | âœ… å¿…é¡»å†æ¬¡éªŒè¯ |
| **æ¸¸æˆçŠ¶æ€ä¿®æ”¹** | âŒ ä¸èƒ½ç›´æ¥ä¿®æ”¹ | âœ… å”¯ä¸€ä¿®æ”¹è€… |
| **ç‰¹æ•ˆæ’­æ”¾** | âœ… è´Ÿè´£ | âŒ ä¸èƒ½ç›´æ¥æ’­æ”¾ |

---

## äºŒã€åŒç«¯éš”ç¦»åŸç†

### 2.1 è¿›ç¨‹çº§åˆ«éš”ç¦»

**é‡è¦**: å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿è¡Œåœ¨**ä¸åŒçš„Pythonè¿›ç¨‹**ä¸­

```
ç©å®¶ç”µè„‘1                    æ¸¸æˆæœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pythonè¿›ç¨‹A  â”‚            â”‚ Pythonè¿›ç¨‹C  â”‚
â”‚ ClientSystem â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ ServerSystem â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   ç½‘ç»œ      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    é€šä¿¡
ç©å®¶ç”µè„‘2                         â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ Pythonè¿›ç¨‹B  â”‚                  â”‚
â”‚ ClientSystem â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™æ„å‘³ç€**:
- âŒ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨**ä¸èƒ½å…±äº«å˜é‡**
- âŒ å®¢æˆ·ç«¯**ä¸èƒ½ç›´æ¥è°ƒç”¨**æœåŠ¡å™¨çš„æ–¹æ³•
- âœ… åªèƒ½é€šè¿‡**äº‹ä»¶ç³»ç»Ÿ**ï¼ˆ`NotifyToServer`/`NotifyToClient`ï¼‰é€šä¿¡

---

### 2.2 å•†åº—è´­ä¹°æµç¨‹ç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Client as ClientSystem
    participant Server as ServerSystem

    Note over Client: ç©å®¶ç‚¹å‡»è´­ä¹°æŒ‰é’®
    Client->>Client: æœ¬åœ°é¢„éªŒè¯ï¼ˆå¯é€‰ï¼‰
    Client->>Server: NotifyToServer('Shop_RequestBuyEvent', {itemId})

    Note over Server: æœåŠ¡å™¨éªŒè¯ï¼ˆå¿…é¡»ï¼‰
    Server->>Server: æ£€æŸ¥é‡‘é’±æ˜¯å¦è¶³å¤Ÿ
    Server->>Server: æ£€æŸ¥ç‰©å“æ˜¯å¦å­˜åœ¨

    alt éªŒè¯æˆåŠŸ
        Server->>Server: æ‰£é™¤é‡‘é’±
        Server->>Server: ç»™äºˆç‰©å“
        Server->>Client: NotifyToClient('Shop_BuySuccessEvent', {itemId, newBalance})
        Note over Client: æ›´æ–°UIæ˜¾ç¤º
    else éªŒè¯å¤±è´¥
        Server->>Client: NotifyToClient('Shop_BuyFailedEvent', {reason})
        Note over Client: æ˜¾ç¤ºé”™è¯¯æç¤º
    end
```

**å…³é”®ä»£ç æ¡†æ¶**:

```python
# âœ… æ­£ç¡®çš„åŒç«¯åä½œ
class ShopClientSystem(ClientSystem):
    def OnClickBuyButton(self, itemId):
        # 1. æœ¬åœ°é¢„éªŒè¯ï¼ˆå¯é€‰ï¼‰
        if not self.IsLoggedIn():
            self.ShowTip("è¯·å…ˆç™»å½•")
            return

        # 2. å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        self.NotifyToServer('Shop_RequestBuyEvent', {'itemId': itemId})
        self.ShowLoadingUI()

class ShopServerSystem(ServerSystem):
    def OnBuyRequest(self, args):
        playerId = args['playerId']  # è‡ªåŠ¨é™„åŠ 
        itemId = args['itemId']

        # 1. æœåŠ¡å™¨éªŒè¯ï¼ˆå¿…é¡»ï¼‰
        if not self.HasEnoughMoney(playerId, itemId):
            self.NotifyToClient(playerId, 'Shop_BuyFailedEvent', {
                'reason': 'insufficient_balance'
            })
            return

        # 2. ä¿®æ”¹æ¸¸æˆçŠ¶æ€ï¼ˆåªèƒ½åœ¨æœåŠ¡å™¨ï¼‰
        self.DeductMoney(playerId, itemId)
        self.GiveItem(playerId, itemId)

        # 3. é€šçŸ¥å®¢æˆ·ç«¯
        self.NotifyToClient(playerId, 'Shop_BuySuccessEvent', {
            'itemId': itemId,
            'newBalance': self.GetMoney(playerId)
        })
```

---

## ä¸‰ã€RPCé€šä¿¡æœºåˆ¶

### 3.1 RPCåº•å±‚åŸç†

```mermaid
sequenceDiagram
    participant Client as ClientSystem
    participant Network as ç½‘ç»œå±‚
    participant Server as ServerSystem

    Client->>Client: NotifyToServer('MethodName', args)
    Client->>Network: åºåˆ—åŒ–ä¸ºJSON
    Network->>Server: é€šè¿‡TCP/UDPå‘é€
    Server->>Server: ååºåˆ—åŒ–
    Server->>Server: è§¦å‘ç›‘å¬å™¨: OnMethodName(args)
```

---

### 3.2 RPCé€šä¿¡API

| API | ç”¨é€” | ç¤ºä¾‹åœºæ™¯ |
|-----|------|---------|
| `NotifyToServer(eventName, data)` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | è´­ä¹°ç‰©å“ã€ä½¿ç”¨æŠ€èƒ½ã€å‘é€èŠå¤© |
| `NotifyToClient(playerId, eventName, data)` | æœåŠ¡å™¨â†’å•ä¸ªå®¢æˆ·ç«¯ | ä»»åŠ¡å®Œæˆã€é‡‘é’±å˜åŒ–ã€ç§èŠæ¶ˆæ¯ |
| `BroadcastToAllClient(eventName, data)` | æœåŠ¡å™¨â†’æ‰€æœ‰å®¢æˆ·ç«¯ | BOSSåˆ·æ–°ã€å…¨æœå…¬å‘Šã€å¤©æ°”å˜åŒ– |

**é‡è¦**: `NotifyToServer`ä¼šè‡ªåŠ¨é™„åŠ `playerId`å­—æ®µåˆ°`args`

---

### 3.3 æŠ€èƒ½é‡Šæ”¾ç³»ç»Ÿç¤ºä¾‹

```mermaid
sequenceDiagram
    participant Client as ClientSystem
    participant Server as ServerSystem
    participant OtherClients as å…¶ä»–ç©å®¶

    Client->>Client: ç©å®¶æŒ‰ä¸‹æŠ€èƒ½é”®
    Client->>Client: æœ¬åœ°é¢„æ£€æŸ¥ï¼ˆå†·å´ã€é­”æ³•å€¼ï¼‰
    Client->>Client: æ’­æ”¾é¢„æµ‹åŠ¨ç”»
    Client->>Server: NotifyToServer('Skill_CastRequestEvent', {skillId, targetPos})

    Server->>Server: æœåŠ¡å™¨éªŒè¯ï¼ˆæŠ€èƒ½å­˜åœ¨ã€é­”æ³•å€¼ï¼‰

    alt éªŒè¯é€šè¿‡
        Server->>Server: æ‰£é™¤é­”æ³•å€¼
        Server->>Server: åº”ç”¨æŠ€èƒ½æ•ˆæœ
        Server->>Client: NotifyToClient('Skill_CastResultEvent', {success: true})
        Server->>OtherClients: BroadcastToAllClient('Skill_CastBroadcastEvent', {casterId, skillId})

        Note over Client: æ’­æ”¾æˆåŠŸç‰¹æ•ˆ
        Note over OtherClients: æ’­æ”¾æŠ€èƒ½åŠ¨ç”»
    else éªŒè¯å¤±è´¥
        Server->>Client: NotifyToClient('Skill_CastResultEvent', {success: false, reason})
        Note over Client: å›æ»šé¢„æµ‹åŠ¨ç”»
    end
```

**ä¼ªä»£ç å®ç°**:

```python
# å®¢æˆ·ç«¯
class SkillClientSystem(ClientSystem):
    def OnPlayerPressSkillKey(self, skillId):
        # 1. æœ¬åœ°é¢„æ£€æŸ¥
        if self.IsSkillOnCooldown(skillId):
            return

        # 2. æœ¬åœ°é¢„æµ‹åŠ¨ç”»
        self.PlaySkillAnimation(skillId)

        # 3. è¯·æ±‚æœåŠ¡å™¨
        self.NotifyToServer('Skill_CastRequestEvent', {
            'skillId': skillId,
            'targetPos': self.GetCrosshairPos()
        })

    def OnCastResult(self, args):
        if args['success']:
            self.PlaySkillEffect(args['skillId'])
        else:
            self.StopSkillAnimation(args['skillId'])

# æœåŠ¡å™¨
class SkillServerSystem(ServerSystem):
    def OnCastRequest(self, args):
        playerId = args['playerId']
        skillId = args['skillId']

        # 1. éªŒè¯
        if not self.HasSkill(playerId, skillId):
            self.NotifyToClient(playerId, 'Skill_CastResultEvent', {
                'success': False, 'reason': 'æœªå­¦ä¹ è¯¥æŠ€èƒ½'
            })
            return

        # 2. æ‰§è¡Œ
        self.DeductMana(playerId, skillId)
        self.ApplySkillEffect(playerId, skillId, args['targetPos'])

        # 3. é€šçŸ¥
        self.NotifyToClient(playerId, 'Skill_CastResultEvent', {'success': True})
        self.BroadcastToAllClient('Skill_CastBroadcastEvent', {
            'casterId': playerId, 'skillId': skillId
        })
```

---

## å››ã€æ•°æ®åŒæ­¥ç­–ç•¥

### 4.1 æœåŠ¡å™¨æƒå¨æ¨¡å‹

**æ ¸å¿ƒåŸåˆ™**: æœåŠ¡å™¨æ˜¯å”¯ä¸€çœŸå®æ•°æ®æºï¼ˆSingle Source of Truthï¼‰

```
å®¢æˆ·ç«¯Aæ˜¾ç¤º: ç©å®¶ä½ç½® (1, 2, 3)
æœåŠ¡å™¨è®°å½•: ç©å®¶ä½ç½® (1, 2, 3)  â† çœŸå®ä½ç½®
å®¢æˆ·ç«¯Bæ˜¾ç¤º: ç©å®¶ä½ç½® (1, 2, 3)

å¦‚æœå®¢æˆ·ç«¯Aè¢«é»‘å®¢ä¿®æ”¹,æ˜¾ç¤º (999, 999, 999)
æœåŠ¡å™¨ä¼šæ‹’ç»å¹¶å¼ºåˆ¶åŒæ­¥: (1, 2, 3)
```

---

### 4.2 æ¨é€å¼ vs æ‹‰å–å¼åŒæ­¥

**æ¨é€å¼åŒæ­¥**ï¼ˆæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼‰:

```mermaid
sequenceDiagram
    participant Server as ServerSystem
    participant Client as ClientSystem

    Note over Server: VIPç­‰çº§å˜åŒ–
    Server->>Client: NotifyToClient('VIP_LevelChangedEvent', {newLevel, rewards})
    Note over Client: æ›´æ–°UIæ˜¾ç¤º
    Server->>Server: BroadcastToAllClient('VIP_PlayerLevelChangedEvent', {playerId, newLevel})
```

**æ‹‰å–å¼åŒæ­¥**ï¼ˆå®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ï¼‰:

```mermaid
sequenceDiagram
    participant Client as ClientSystem
    participant Server as ServerSystem

    Note over Client: ç©å®¶æ‰“å¼€èƒŒåŒ…UI
    Client->>Server: NotifyToServer('Inventory_RequestDataEvent', {})
    Client->>Client: æ˜¾ç¤ºåŠ è½½ä¸­UI
    Server->>Server: æŸ¥è¯¢ç©å®¶èƒŒåŒ…æ•°æ®
    Server->>Client: NotifyToClient('Inventory_DataResponseEvent', {items})
    Note over Client: æ›´æ–°èƒŒåŒ…UI
```

---

### 4.3 å¢é‡åŒæ­¥ vs å…¨é‡åŒæ­¥

| åŒæ­¥æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **å…¨é‡åŒæ­¥** | ç®€å•,ä¸ä¼šæ•°æ®ä¸ä¸€è‡´ | æ•°æ®é‡å¤§,ç½‘ç»œå¼€é”€é«˜ | åˆå§‹åŒ–ã€ç©å®¶ç™»å½• |
| **å¢é‡åŒæ­¥** | æ•°æ®é‡å°,æ•ˆç‡é«˜ | å¤æ‚,éœ€ç»´æŠ¤å®¢æˆ·ç«¯çŠ¶æ€ | é«˜é¢‘æ›´æ–°ã€å®æ—¶æˆ˜æ–— |

**å¯¹æ¯”ç¤ºä¾‹**:

```python
# å…¨é‡åŒæ­¥: å‘é€å®Œæ•´èƒŒåŒ…ï¼ˆ100ä¸ªç‰©å“,~5KBï¼‰
self.NotifyToClient(playerId, 'Inventory_FullSyncEvent', {
    'items': [
        {'id': 'item1', 'count': 10, 'durability': 100},
        {'id': 'item2', 'count': 5, 'durability': 50},
        # ... 100ä¸ªç‰©å“
    ]
})

# å¢é‡åŒæ­¥: åªå‘é€å˜åŒ–ï¼ˆ3ä¸ªç‰©å“,~150å­—èŠ‚ï¼‰
self.NotifyToClient(playerId, 'Inventory_IncrementalSyncEvent', {
    'added': [{'id': 'item3', 'count': 1}],      # æ–°å¢
    'removed': ['item1'],                         # ç§»é™¤
    'updated': [{'id': 'item2', 'count': 3}]     # æ›´æ–°
})
```

**æ¨èç­–ç•¥**: åˆå§‹å…¨é‡åŒæ­¥ + åç»­å¢é‡åŒæ­¥ + å®šæœŸæ ¡éªŒï¼ˆæ¯5åˆ†é’Ÿï¼‰

---

## äº”ã€ç½‘ç»œä¼˜åŒ–æŠ€å·§

### 5.1 å‡å°‘RPCè°ƒç”¨é¢‘ç‡

**âŒ ä½æ•ˆå†™æ³•**:
```python
def Update(self):
    # æ¯å¸§ï¼ˆ60fpsï¼‰å‘é€ä½ç½®æ›´æ–°
    self.NotifyToServer('Player_PositionUpdate', {'pos': self.GetPlayerPos()})
```

**âœ… ä¼˜åŒ–æ–¹æ¡ˆ**:

| ä¼˜åŒ–æ–¹æ³• | ä»£ç ç¤ºä¾‹ | æ•ˆæœ |
|---------|---------|------|
| **èŠ‚æµï¼ˆThrottleï¼‰** | `if tick_counter % 20 == 0: NotifyToServer(...)` | æ¯20å¸§ï¼ˆ0.33ç§’ï¼‰å‘é€ä¸€æ¬¡ |
| **å˜åŒ–æ£€æµ‹** | `if DistanceTo(current_pos, last_pos) > 0.5: NotifyToServer(...)` | åªæœ‰å˜åŒ–>0.5æ ¼æ—¶å‘é€ |

---

### 5.2 æ‰¹é‡æ“ä½œ

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹å¼ | RPCæ¬¡æ•° | å»¶è¿Ÿ | æå‡ |
|------|--------|------|------|
| å•æ¬¡å‘é€ | 10ä¸ªç‰©å“ = 10æ¬¡RPC | ~100ms | - |
| æ‰¹é‡å‘é€ | 10ä¸ªç‰©å“ = 1æ¬¡RPC | ~10ms | **10å€** |

```python
# âŒ ä½æ•ˆ: æ¯ä¸ªç‰©å“å•ç‹¬å‘é€
for itemId in itemIds:
    self.NotifyToClient(playerId, 'Item_AddedEvent', {'itemId': itemId})

# âœ… é«˜æ•ˆ: æ‰¹é‡å‘é€
self.NotifyToClient(playerId, 'Items_BatchAddedEvent', {'itemIds': itemIds})
```

---

### 5.3 æ•°æ®å‹ç¼©

**æŠ€å·§1: ä½¿ç”¨çŸ­é”®å**

| æ–¹å¼ | æ•°æ®å¤§å° | èŠ‚çœ |
|------|---------|------|
| å†—é•¿é”®å | `{'playerUniqueIdentifier': '...', 'quantityAmount': 10}` | 80å­—èŠ‚ |
| ç®€çŸ­é”®å | `{'pid': '...', 'qty': 10}` | 50å­—èŠ‚ | **37%** |

**æŠ€å·§2: ä½¿ç”¨æšä¸¾ä»£æ›¿å­—ç¬¦ä¸²**

| æ–¹å¼ | æ•°æ®å¤§å° | èŠ‚çœ |
|------|---------|------|
| å­—ç¬¦ä¸² | `{'type': 'purchase_item'}` | 13å­—èŠ‚ |
| æ•°å­—æšä¸¾ | `{'type': 1}` | 1å­—èŠ‚ | **92%** |

---

## å…­ã€å®‰å…¨ä¸é˜²ä½œå¼Š

### 6.1 æœåŠ¡å™¨éªŒè¯åŸåˆ™

**é»„é‡‘æ³•åˆ™**: **æ°¸è¿œä¸è¦ä¿¡ä»»å®¢æˆ·ç«¯æ•°æ®**

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯ï¼ˆå¯èƒ½è¢«ä¿®æ”¹ï¼‰
    participant Server as æœåŠ¡å™¨ï¼ˆå¯ä¿¡ï¼‰

    Client->>Server: NotifyToServer('BuyItem', {itemId, price: 0})
    Note over Server: âŒ å±é™©: ç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯price
    Note over Server: âœ… å®‰å…¨: æœåŠ¡å™¨é‡æ–°æŸ¥è¯¢çœŸå®ä»·æ ¼
    Server->>Server: real_price = GetItemPrice(itemId)
    Server->>Server: éªŒè¯é‡‘é’±æ˜¯å¦è¶³å¤Ÿ
    Server->>Client: è¿”å›ç»“æœ
```

**ä»£ç å¯¹æ¯”**:

```python
# âŒ å±é™©: ç›´æ¥ä¿¡ä»»å®¢æˆ·ç«¯
def OnBuyItem(self, args):
    price = args['price']  # å®¢æˆ·ç«¯å¯ä»¥ä¿®æ”¹ä¸º0
    self.DeductMoney(playerId, price)

# âœ… å®‰å…¨: æœåŠ¡å™¨é‡æ–°è®¡ç®—
def OnBuyItem(self, args):
    real_price = self.GetItemPrice(args['itemId'])  # æœåŠ¡å™¨æŸ¥è¯¢çœŸå®ä»·æ ¼
    if self.GetPlayerMoney(playerId) < real_price:
        return  # æ‹’ç»
    self.DeductMoney(playerId, real_price)
```

---

### 6.2 é˜²æ­¢é‡æ”¾æ”»å‡»

**é—®é¢˜**: é»‘å®¢é‡å¤å‘é€åŒä¸€ä¸ªè¯·æ±‚

**è§£å†³æ–¹æ¡ˆ**:

```mermaid
sequenceDiagram
    participant Client as ClientSystem
    participant Server as ServerSystem

    Client->>Server: NotifyToServer('BuyItem', {requestId, timestamp, itemId})
    Server->>Server: æ£€æŸ¥requestIdæ˜¯å¦å·²å¤„ç†
    Server->>Server: æ£€æŸ¥timestampæ˜¯å¦è¿‡æœŸï¼ˆ30ç§’ï¼‰

    alt æœªå¤„ç†ä¸”æœªè¿‡æœŸ
        Server->>Server: æ ‡è®°requestIdå·²å¤„ç†
        Server->>Server: æ‰§è¡Œè´­ä¹°é€»è¾‘
        Server->>Client: è¿”å›æˆåŠŸ
    else é‡å¤è¯·æ±‚æˆ–è¿‡æœŸ
        Note over Server: æ‹’ç»è¯·æ±‚
        Server->>Client: è¿”å›é”™è¯¯
    end
```

**ä¼ªä»£ç å®ç°**:

```python
# å®¢æˆ·ç«¯
def BuyItem(self, itemId):
    self.NotifyToServer('BuyItem', {
        'requestId': GenerateUUID(),
        'timestamp': GetCurrentTime(),
        'itemId': itemId
    })

# æœåŠ¡å™¨
def OnBuyItem(self, args):
    # æ£€æŸ¥é‡å¤
    if self.IsRequestProcessed(args['requestId']):
        return

    # æ£€æŸ¥è¿‡æœŸï¼ˆ30ç§’å†…æœ‰æ•ˆï¼‰
    if GetCurrentTime() - args['timestamp'] > 30:
        return

    # æ ‡è®°å·²å¤„ç†
    self.MarkRequestProcessed(args['requestId'])

    # æ­£å¸¸å¤„ç†
    self.ProcessBuyItem(args)
```

---

### 6.3 é¢‘ç‡é™åˆ¶

**é˜²æ­¢**: å®¢æˆ·ç«¯æ¶æ„åˆ·è¯·æ±‚ï¼ˆDDoSæ”»å‡»ï¼‰

**å®ç°é€»è¾‘**:

```python
class ServerSystem(ServerSystem):
    def __init__(self):
        self.player_request_count = {}  # {playerId: [timestamp1, timestamp2, ...]}

    def OnRequest(self, args):
        playerId = args['playerId']
        current_time = GetCurrentTime()

        # ç»Ÿè®¡æœ€è¿‘1ç§’å†…çš„è¯·æ±‚æ•°
        if playerId not in self.player_request_count:
            self.player_request_count[playerId] = []

        recent = [t for t in self.player_request_count[playerId]
                  if current_time - t < 1.0]

        # é™åˆ¶ï¼š1ç§’æœ€å¤š10æ¬¡è¯·æ±‚
        if len(recent) > 10:
            self.NotifyToClient(playerId, 'Error', {'reason': 'rate_limit'})
            return

        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        self.player_request_count[playerId] = recent + [current_time]

        # æ­£å¸¸å¤„ç†
        self.ProcessRequest(args)
```

---

## ä¸ƒã€å¸¸è§é€šä¿¡æ¨¡å¼

### æ¨¡å¼å¯¹æ¯”è¡¨

| æ¨¡å¼ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| **è¯·æ±‚-å“åº”** | å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚,ç­‰å¾…å“åº” | æ‰“å¼€èƒŒåŒ…ã€æŸ¥è¯¢æ•°æ® |
| **å‘å¸ƒ-è®¢é˜…** | æœåŠ¡å™¨ä¸»åŠ¨æ¨é€,å¤šå®¢æˆ·ç«¯è®¢é˜… | BOSSåˆ·æ–°ã€å…¨æœå…¬å‘Š |
| **å¿ƒè·³ä¿æ´»** | ä¿æŒè¿æ¥æ´»è·ƒ,æ£€æµ‹æ–­çº¿ | æ¯30ç§’å‘é€å¿ƒè·³åŒ… |

---

## å…«ã€å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- **MODSDKç½‘ç»œAPI**: å‚è€ƒ`.claude/docs/modsdk-wiki/`
- **åŸºå²©ç‰ˆç½‘ç»œæ¶æ„**: å‚è€ƒ`.claude/docs/bedrock-wiki/`

### ç›¸å…³å·¥ä½œæµæ–‡æ¡£
- **å¼€å‘è§„èŒƒ.md**: åŒç«¯éš”ç¦»CRITICALè§„èŒƒ
- **äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md**: äº‹ä»¶é€šä¿¡è¯¦è§£
- **æ·±å…¥ç†è§£ECSæ¶æ„.md**: Componentçš„ç½‘ç»œåŒæ­¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆç²¾ç®€ç‰ˆï¼‰
**æœ€åæ›´æ–°**: 2025-11-12
**ç»´æŠ¤è€…**: NeteaseMod-Claudeå·¥ä½œæµ
**å‹ç¼©ç‡**: ä»820è¡Œå‹ç¼©åˆ°450è¡Œï¼ˆ45%ç²¾ç®€ï¼‰
