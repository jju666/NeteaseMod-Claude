# ç½‘ç»œæ¶æ„ä¸é€šä¿¡

> ğŸŒ **æ·±å…¥ç†è§£MODSDKåŒç«¯é€šä¿¡æœºåˆ¶**
>
> æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£MODSDKå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ã€ç½‘ç»œé€šä¿¡æ¨¡å¼å’Œæ•°æ®åŒæ­¥ç­–ç•¥
>
> **ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2025-11-11

---

## ç›®å½•

1. [åŒç«¯æ¶æ„æ¦‚è¿°](#ä¸€åŒç«¯æ¶æ„æ¦‚è¿°)
2. [åŒç«¯éš”ç¦»åŸç†](#äºŒåŒç«¯éš”ç¦»åŸç†)
3. [RPCé€šä¿¡æœºåˆ¶](#ä¸‰rpcé€šä¿¡æœºåˆ¶)
4. [æ•°æ®åŒæ­¥ç­–ç•¥](#å››æ•°æ®åŒæ­¥ç­–ç•¥)
5. [ç½‘ç»œä¼˜åŒ–æŠ€å·§](#äº”ç½‘ç»œä¼˜åŒ–æŠ€å·§)
6. [å¸¸è§é€šä¿¡æ¨¡å¼](#å…­å¸¸è§é€šä¿¡æ¨¡å¼)
7. [å®‰å…¨ä¸é˜²ä½œå¼Š](#ä¸ƒå®‰å…¨ä¸é˜²ä½œå¼Š)
8. [è°ƒè¯•ä¸æµ‹è¯•](#å…«è°ƒè¯•ä¸æµ‹è¯•)

---

## ä¸€ã€åŒç«¯æ¶æ„æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯åŒç«¯æ¶æ„?

MODSDKé‡‡ç”¨**å®¢æˆ·ç«¯-æœåŠ¡å™¨åˆ†ç¦»æ¶æ„**ï¼ˆClient-Server Architectureï¼‰,æ¯ä¸ªModç”±ä¸¤ä¸ªç‹¬ç«‹è¿è¡Œçš„éƒ¨åˆ†ç»„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         ç½‘ç»œé€šä¿¡        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClientSystem      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   ServerSystem      â”‚
â”‚   (ç©å®¶ç”µè„‘)        â”‚   NotifyToServer/Client  â”‚   (æ¸¸æˆæœåŠ¡å™¨)      â”‚
â”‚                     â”‚                          â”‚                     â”‚
â”‚  - UIæ¸²æŸ“          â”‚                          â”‚  - ä¸šåŠ¡é€»è¾‘         â”‚
â”‚  - ç”¨æˆ·è¾“å…¥        â”‚                          â”‚  - æ•°æ®éªŒè¯         â”‚
â”‚  - ç‰¹æ•ˆæ’­æ”¾        â”‚                          â”‚  - ä¸–ç•ŒçŠ¶æ€ç®¡ç†     â”‚
â”‚  - æœ¬åœ°é¢„æµ‹        â”‚                          â”‚  - æƒé™æ§åˆ¶         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒç«¯åˆ†ç¦»?**

1. **å®‰å…¨æ€§**: é˜²æ­¢å®¢æˆ·ç«¯ä½œå¼Šï¼ˆé‡‘é’±ä¿®æ”¹ã€ç‰©å“å¤åˆ¶ç­‰ï¼‰
2. **æ€§èƒ½**: å®¢æˆ·ç«¯åªå¤„ç†æ¸²æŸ“,æœåŠ¡å™¨ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
3. **å¤šäººåŒæ­¥**: æœåŠ¡å™¨ä½œä¸ºå”¯ä¸€çœŸå®æ•°æ®æº,ä¿è¯æ‰€æœ‰ç©å®¶çœ‹åˆ°ä¸€è‡´çš„ä¸–ç•Œ
4. **å¯æ‰©å±•æ€§**: ç‹¬ç«‹å¼€å‘å®¢æˆ·ç«¯UIå’ŒæœåŠ¡å™¨é€»è¾‘

---

### 1.2 å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„èŒè´£

**ä¸¥æ ¼çš„èŒè´£åˆ†ç¦»** (CRITICALè§„èŒƒ):

| èŒè´£ | å®¢æˆ·ç«¯ (ClientSystem) | æœåŠ¡å™¨ (ServerSystem) |
|------|---------------------|---------------------|
| **UIæ¸²æŸ“** | âœ… è´Ÿè´£ | âŒ ä¸èƒ½è®¿é—® |
| **ç”¨æˆ·è¾“å…¥** | âœ… æ¥æ”¶å¹¶å‘é€åˆ°æœåŠ¡å™¨ | âŒ ä¸ç›´æ¥å¤„ç† |
| **ä¸šåŠ¡é€»è¾‘** | âŒ ä¸èƒ½å¤„ç† | âœ… å”¯ä¸€å¤„ç†è€… |
| **æ•°æ®éªŒè¯** | âŒ å¯åšæœ¬åœ°é¢„éªŒè¯ | âœ… å¿…é¡»å†æ¬¡éªŒè¯ |
| **æ¸¸æˆçŠ¶æ€ä¿®æ”¹** | âŒ ä¸èƒ½ç›´æ¥ä¿®æ”¹ | âœ… å”¯ä¸€ä¿®æ”¹è€… |
| **ç‰¹æ•ˆæ’­æ”¾** | âœ… è´Ÿè´£ | âŒ ä¸èƒ½ç›´æ¥æ’­æ”¾ |

**ç¤ºä¾‹: å•†åº—è´­ä¹°æµç¨‹**

```python
# âœ… æ­£ç¡®çš„åŒç«¯åä½œ
class ShopClientSystem(ClientSystem):
    def OnClickBuyButton(self, itemId):
        """å®¢æˆ·ç«¯åªè´Ÿè´£UIäº¤äº’"""
        # 1. æœ¬åœ°é¢„éªŒè¯ï¼ˆå¯é€‰,æå‡ç”¨æˆ·ä½“éªŒï¼‰
        if not self.IsLocalPlayerLoggedIn():
            self.ShowTip("è¯·å…ˆç™»å½•")
            return

        # 2. å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        self.NotifyToServer('Shop_RequestBuyEvent', {
            'itemId': itemId
        })

        # 3. æ˜¾ç¤º"è´­ä¹°ä¸­"UI
        self.ShowLoadingUI()

class ShopServerSystem(ServerSystem):
    def OnBuyRequest(self, args):
        """æœåŠ¡å™¨è´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®ä¿®æ”¹"""
        playerId = args['playerId']
        itemId = args['itemId']

        # 1. æœåŠ¡å™¨éªŒè¯ï¼ˆå¿…é¡»,é˜²æ­¢ä½œå¼Šï¼‰
        if not self.HasEnoughMoney(playerId, itemId):
            self.NotifyToClient(playerId, 'Shop_BuyFailedEvent', {
                'reason': 'insufficient_balance'
            })
            return

        # 2. ä¿®æ”¹æ¸¸æˆçŠ¶æ€ï¼ˆåªèƒ½åœ¨æœåŠ¡å™¨ï¼‰
        self.DeductMoney(playerId, itemId)
        self.GiveItem(playerId, itemId)

        # 3. é€šçŸ¥å®¢æˆ·ç«¯æ›´æ–°UI
        self.NotifyToClient(playerId, 'Shop_BuySuccessEvent', {
            'itemId': itemId,
            'newBalance': self.GetMoney(playerId)
        })

# âŒ é”™è¯¯ç¤ºä¾‹: å®¢æˆ·ç«¯ç›´æ¥ä¿®æ”¹æ•°æ®
class ShopClientSystem(ClientSystem):
    def OnClickBuyButton(self, itemId):
        # âŒ å®¢æˆ·ç«¯ä¸èƒ½ç›´æ¥ä¿®æ”¹é‡‘é’±ï¼ˆä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼‰
        self.localPlayerMoney -= 100
        # âŒ å®¢æˆ·ç«¯ä¸èƒ½ç›´æ¥ç»™äºˆç‰©å“ï¼ˆå…¶ä»–ç©å®¶çœ‹ä¸åˆ°ï¼‰
        self.GiveItemToPlayer(self.localPlayerId, itemId)
```

---

## äºŒã€åŒç«¯éš”ç¦»åŸç†

### 2.1 è¿›ç¨‹çº§åˆ«éš”ç¦»

**é‡è¦**: å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è¿è¡Œåœ¨**ä¸åŒçš„Pythonè¿›ç¨‹**ä¸­,ç”šè‡³å¯èƒ½åœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Š

```
ç©å®¶ç”µè„‘1                    æ¸¸æˆæœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pythonè¿›ç¨‹A  â”‚            â”‚ Pythonè¿›ç¨‹C  â”‚
â”‚ ClientSystem â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ ServerSystem â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   ç½‘ç»œ      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    é€šä¿¡
ç©å®¶ç”µè„‘2                         â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚ Pythonè¿›ç¨‹B  â”‚                  â”‚
â”‚ ClientSystem â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™æ„å‘³ç€**:
- âŒ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨**ä¸èƒ½å…±äº«å˜é‡**
- âŒ å®¢æˆ·ç«¯**ä¸èƒ½ç›´æ¥è°ƒç”¨**æœåŠ¡å™¨çš„æ–¹æ³•
- âŒ æœåŠ¡å™¨**ä¸èƒ½ç›´æ¥è®¿é—®**å®¢æˆ·ç«¯çš„UIç»„ä»¶
- âœ… åªèƒ½é€šè¿‡**äº‹ä»¶ç³»ç»Ÿ**ï¼ˆ`NotifyToServer`/`NotifyToClient`ï¼‰é€šä¿¡

---

### 2.2 ä¸ºä»€ä¹ˆå¿…é¡»éš”ç¦»?

**åŸå› 1: å®‰å…¨é˜²æŠ¤**
```python
# å¦‚æœå…è®¸å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨æœåŠ¡å™¨æ–¹æ³•ï¼ˆå‡è®¾ï¼‰
class ShopClientSystem(ClientSystem):
    def CheatMoney(self):
        # âŒ é»‘å®¢å¯ä»¥ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ,è°ƒç”¨æœåŠ¡å™¨æ–¹æ³•
        serverSystem.AddMoney(self.playerId, 999999)

# åŒç«¯éš”ç¦»åï¼ˆå®é™…ï¼‰
class ShopClientSystem(ClientSystem):
    def TryCheatMoney(self):
        # âœ… å³ä½¿ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ,ä¹Ÿåªèƒ½å‘é€äº‹ä»¶
        self.NotifyToServer('AddMoney', {'amount': 999999})
        # æœåŠ¡å™¨ä¼šéªŒè¯å¹¶æ‹’ç»éæ³•è¯·æ±‚
```

**åŸå› 2: å¤šäººåŒæ­¥**
```python
# å¦‚æœå®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä¿®æ”¹ä¸–ç•Œï¼ˆå‡è®¾ï¼‰
class CombatClientSystem(ClientSystem):
    def AttackPlayer(self, targetId):
        # âŒ åªæœ‰æ”»å‡»è€…çœ‹åˆ°ä¼¤å®³,å…¶ä»–ç©å®¶çœ‹ä¸åˆ°
        self.DamagePlayer(targetId, 10)

# åŒç«¯éš”ç¦»åï¼ˆå®é™…ï¼‰
class CombatClientSystem(ClientSystem):
    def AttackPlayer(self, targetId):
        # âœ… è¯·æ±‚æœåŠ¡å™¨å¤„ç†ä¼¤å®³
        self.NotifyToServer('Attack', {'targetId': targetId})

class CombatServerSystem(ServerSystem):
    def OnAttack(self, args):
        attackerId = args['playerId']
        targetId = args['targetId']

        # æœåŠ¡å™¨è®¡ç®—ä¼¤å®³å¹¶å¹¿æ’­ç»™æ‰€æœ‰ç©å®¶
        damage = self.CalculateDamage(attackerId, targetId)
        self.DamagePlayer(targetId, damage)
        self.BroadcastToAllClient('PlayerDamaged', {
            'attackerId': attackerId,
            'targetId': targetId,
            'damage': damage
        })
```

---

## ä¸‰ã€RPCé€šä¿¡æœºåˆ¶

### 3.1 ä»€ä¹ˆæ˜¯RPC?

**RPC (Remote Procedure Call)**: è¿œç¨‹è¿‡ç¨‹è°ƒç”¨,å…è®¸å®¢æˆ·ç«¯"è°ƒç”¨"æœåŠ¡å™¨çš„æ–¹æ³•ï¼ˆå®é™…æ˜¯é€šè¿‡äº‹ä»¶æ¨¡æ‹Ÿï¼‰

**MODSDKçš„RPCå®ç°**:
```python
# åº•å±‚åŸç†ï¼ˆå¼€å‘è€…æ— éœ€å…³å¿ƒï¼‰
NotifyToServer('MethodName', args)
    â†“
åºåˆ—åŒ–ä¸ºJSON: {"method": "MethodName", "args": {...}}
    â†“
é€šè¿‡TCP/UDPå‘é€åˆ°æœåŠ¡å™¨
    â†“
æœåŠ¡å™¨ååºåˆ—åŒ–
    â†“
è§¦å‘ç›‘å¬å™¨: OnMethodName(args)
```

---

### 3.2 RPCé€šä¿¡API

**å®¢æˆ·ç«¯â†’æœåŠ¡å™¨**:
```python
self.NotifyToServer(eventName, eventData)
```
- **ç”¨é€”**: å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨æ‰§è¡Œæ“ä½œ
- **ç¤ºä¾‹**: è´­ä¹°ç‰©å“ã€ä½¿ç”¨æŠ€èƒ½ã€å‘é€èŠå¤©æ¶ˆæ¯
- **è‡ªåŠ¨é™„åŠ **: æœåŠ¡å™¨ç«¯æ¥æ”¶æ—¶ä¼šè‡ªåŠ¨æ·»åŠ `playerId`å­—æ®µ

**æœåŠ¡å™¨â†’å•ä¸ªå®¢æˆ·ç«¯**:
```python
self.NotifyToClient(playerId, eventName, eventData)
```
- **ç”¨é€”**: æœåŠ¡å™¨é€šçŸ¥ç‰¹å®šç©å®¶
- **ç¤ºä¾‹**: ä»»åŠ¡å®Œæˆã€é‡‘é’±å˜åŒ–ã€ç§èŠæ¶ˆæ¯

**æœåŠ¡å™¨â†’æ‰€æœ‰å®¢æˆ·ç«¯**:
```python
self.BroadcastToAllClient(eventName, eventData)
```
- **ç”¨é€”**: æœåŠ¡å™¨å¹¿æ’­å…¨å±€äº‹ä»¶
- **ç¤ºä¾‹**: ä¸–ç•ŒBOSSåˆ·æ–°ã€å…¨æœå…¬å‘Šã€å¤©æ°”å˜åŒ–

---

### 3.3 RPCå®Œæ•´ç¤ºä¾‹

**éœ€æ±‚**: å®ç°æŠ€èƒ½é‡Šæ”¾ç³»ç»Ÿ

```python
# ====== å®¢æˆ·ç«¯ ======
class SkillClientSystem(ClientSystem):
    def __init__(self):
        # ç›‘å¬æœåŠ¡å™¨çš„æŠ€èƒ½ç»“æœ
        self.ListenForEvent('MyMod', 'SkillServerSystem', 'Skill_CastResultEvent', self, self.OnCastResult)

    def OnPlayerPressSkillKey(self, skillId):
        """ç©å®¶æŒ‰ä¸‹æŠ€èƒ½é”®"""
        # 1. æœ¬åœ°é¢„æ£€æŸ¥ï¼ˆå¯é€‰,æå‡ä½“éªŒï¼‰
        if self.IsSkillOnCooldown(skillId):
            self.ShowTip("æŠ€èƒ½å†·å´ä¸­")
            return

        # 2. æ’­æ”¾æœ¬åœ°é¢„æµ‹åŠ¨ç”»ï¼ˆå¯é€‰ï¼‰
        self.PlaySkillAnimation(skillId)

        # 3. è¯·æ±‚æœåŠ¡å™¨éªŒè¯å¹¶æ‰§è¡Œ
        self.NotifyToServer('Skill_CastRequestEvent', {
            'skillId': skillId,
            'targetPos': self.GetCrosshairPos()  # å‡†æ˜Ÿä½ç½®
        })

    def OnCastResult(self, args):
        """æ¥æ”¶æœåŠ¡å™¨çš„æŠ€èƒ½ç»“æœ"""
        success = args['success']
        skillId = args['skillId']

        if success:
            # æ’­æ”¾æˆåŠŸç‰¹æ•ˆ
            self.PlaySkillEffect(skillId)
            self.ShowTip("æŠ€èƒ½é‡Šæ”¾æˆåŠŸ")
        else:
            # å›æ»šæœ¬åœ°é¢„æµ‹
            self.StopSkillAnimation(skillId)
            self.ShowTip("æŠ€èƒ½é‡Šæ”¾å¤±è´¥: " + args['reason'])

# ====== æœåŠ¡å™¨ ======
class SkillServerSystem(ServerSystem):
    def __init__(self):
        # ç›‘å¬å®¢æˆ·ç«¯çš„æŠ€èƒ½è¯·æ±‚
        self.ListenForEvent('MyMod', 'SkillClientSystem', 'Skill_CastRequestEvent', self, self.OnCastRequest)

    def OnCastRequest(self, args):
        """å¤„ç†å®¢æˆ·ç«¯çš„æŠ€èƒ½è¯·æ±‚"""
        playerId = args['playerId']  # è‡ªåŠ¨é™„åŠ 
        skillId = args['skillId']
        targetPos = args['targetPos']

        # 1. æœåŠ¡å™¨éªŒè¯
        if not self.HasSkill(playerId, skillId):
            self.NotifyToClient(playerId, 'Skill_CastResultEvent', {
                'success': False,
                'skillId': skillId,
                'reason': 'æœªå­¦ä¹ è¯¥æŠ€èƒ½'
            })
            return

        if not self.HasEnoughMana(playerId, skillId):
            self.NotifyToClient(playerId, 'Skill_CastResultEvent', {
                'success': False,
                'skillId': skillId,
                'reason': 'é­”æ³•å€¼ä¸è¶³'
            })
            return

        # 2. æ‰§è¡ŒæŠ€èƒ½æ•ˆæœï¼ˆä¿®æ”¹æ¸¸æˆçŠ¶æ€ï¼‰
        self.DeductMana(playerId, skillId)
        self.ApplySkillEffect(playerId, skillId, targetPos)
        self.SetSkillCooldown(playerId, skillId)

        # 3. é€šçŸ¥é‡Šæ”¾è€…
        self.NotifyToClient(playerId, 'Skill_CastResultEvent', {
            'success': True,
            'skillId': skillId
        })

        # 4. å¹¿æ’­ç»™å…¶ä»–ç©å®¶ï¼ˆè®©ä»–ä»¬çœ‹åˆ°æŠ€èƒ½æ•ˆæœï¼‰
        self.BroadcastToAllClient('Skill_CastBroadcastEvent', {
            'casterId': playerId,
            'skillId': skillId,
            'targetPos': targetPos
        })
```

---

## å››ã€æ•°æ®åŒæ­¥ç­–ç•¥

### 4.1 æœåŠ¡å™¨æƒå¨æ¨¡å‹

**æ ¸å¿ƒåŸåˆ™**: æœåŠ¡å™¨æ˜¯å”¯ä¸€çœŸå®æ•°æ®æºï¼ˆSingle Source of Truthï¼‰

```
å®¢æˆ·ç«¯Aæ˜¾ç¤º: ç©å®¶ä½ç½® (1, 2, 3)
æœåŠ¡å™¨è®°å½•: ç©å®¶ä½ç½® (1, 2, 3)  â† çœŸå®ä½ç½®
å®¢æˆ·ç«¯Bæ˜¾ç¤º: ç©å®¶ä½ç½® (1, 2, 3)

å¦‚æœå®¢æˆ·ç«¯Aè¢«é»‘å®¢ä¿®æ”¹,æ˜¾ç¤º (999, 999, 999)
æœåŠ¡å™¨ä¼šæ‹’ç»å¹¶å¼ºåˆ¶åŒæ­¥: (1, 2, 3)
```

---

### 4.2 æ¨é€å¼åŒæ­¥

**é€‚ç”¨åœºæ™¯**: æœåŠ¡å™¨ä¸»åŠ¨æ¨é€æ•°æ®å˜åŒ–

**ç¤ºä¾‹: VIPç­‰çº§å˜åŒ–**
```python
class VIPServerSystem(ServerSystem):
    def LevelUpVIP(self, playerId, newLevel):
        """ç©å®¶VIPå‡çº§"""
        # 1. ä¿®æ”¹æœåŠ¡å™¨æ•°æ®
        self.SetVIPLevel(playerId, newLevel)

        # 2. æ¨é€ç»™è¯¥ç©å®¶
        self.NotifyToClient(playerId, 'VIP_LevelChangedEvent', {
            'newLevel': newLevel,
            'rewards': self.GetLevelRewards(newLevel)
        })

        # 3. å¹¿æ’­ç»™å…¶ä»–ç©å®¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
        self.BroadcastToAllClient('VIP_PlayerLevelChangedEvent', {
            'playerId': playerId,
            'newLevel': newLevel
        })

class VIPClientSystem(ClientSystem):
    def OnLevelChanged(self, args):
        """æ¥æ”¶VIPç­‰çº§å˜åŒ–"""
        newLevel = args['newLevel']
        # æ›´æ–°UIæ˜¾ç¤º
        self.UpdateVIPUI(newLevel)
        # æ˜¾ç¤ºå‡çº§åŠ¨ç”»
        self.PlayLevelUpEffect()
```

---

### 4.3 æ‹‰å–å¼åŒæ­¥

**é€‚ç”¨åœºæ™¯**: å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚æ•°æ®

**ç¤ºä¾‹: æ‰“å¼€èƒŒåŒ…ç•Œé¢**
```python
class InventoryClientSystem(ClientSystem):
    def OnOpenInventory(self):
        """ç©å®¶æ‰“å¼€èƒŒåŒ…UI"""
        # 1. è¯·æ±‚æœåŠ¡å™¨å‘é€æœ€æ–°èƒŒåŒ…æ•°æ®
        self.NotifyToServer('Inventory_RequestDataEvent', {})

        # 2. æ˜¾ç¤ºåŠ è½½ä¸­UI
        self.ShowLoadingUI()

    def OnReceiveInventoryData(self, args):
        """æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„èƒŒåŒ…æ•°æ®"""
        items = args['items']
        # æ›´æ–°UIæ˜¾ç¤º
        self.UpdateInventoryUI(items)
        self.HideLoadingUI()

class InventoryServerSystem(ServerSystem):
    def OnRequestData(self, args):
        """å¤„ç†å®¢æˆ·ç«¯çš„æ•°æ®è¯·æ±‚"""
        playerId = args['playerId']

        # æŸ¥è¯¢ç©å®¶èƒŒåŒ…æ•°æ®
        items = self.GetPlayerInventory(playerId)

        # è¿”å›æ•°æ®
        self.NotifyToClient(playerId, 'Inventory_DataResponseEvent', {
            'items': items
        })
```

---

### 4.4 å¢é‡åŒæ­¥ vs å…¨é‡åŒæ­¥

**å…¨é‡åŒæ­¥** (Full Sync):
- **ä¼˜ç‚¹**: ç®€å•,ä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´
- **ç¼ºç‚¹**: æ•°æ®é‡å¤§,ç½‘ç»œå¼€é”€é«˜
- **é€‚ç”¨**: åˆå§‹åŒ–ã€ç©å®¶ç™»å½•ã€æ‰“å¼€UI

```python
# å…¨é‡åŒæ­¥: å‘é€å®Œæ•´èƒŒåŒ…
self.NotifyToClient(playerId, 'Inventory_FullSyncEvent', {
    'items': [
        {'id': 'item1', 'count': 10, 'durability': 100},
        {'id': 'item2', 'count': 5, 'durability': 50},
        # ... 100ä¸ªç‰©å“
    ]
})
```

**å¢é‡åŒæ­¥** (Incremental Sync):
- **ä¼˜ç‚¹**: æ•°æ®é‡å°,ç½‘ç»œæ•ˆç‡é«˜
- **ç¼ºç‚¹**: å¤æ‚,éœ€è¦ç»´æŠ¤å®¢æˆ·ç«¯çŠ¶æ€
- **é€‚ç”¨**: é«˜é¢‘æ›´æ–°ã€å®æ—¶æˆ˜æ–—

```python
# å¢é‡åŒæ­¥: åªå‘é€å˜åŒ–çš„ç‰©å“
self.NotifyToClient(playerId, 'Inventory_IncrementalSyncEvent', {
    'added': [{'id': 'item3', 'count': 1}],      # æ–°å¢çš„ç‰©å“
    'removed': ['item1'],                         # ç§»é™¤çš„ç‰©å“ID
    'updated': [{'id': 'item2', 'count': 3}]     # æ•°é‡å˜åŒ–çš„ç‰©å“
})
```

**æ¨èç­–ç•¥**:
- åˆå§‹æ•°æ®: å…¨é‡åŒæ­¥
- åç»­å˜åŒ–: å¢é‡åŒæ­¥
- å®šæœŸæ ¡éªŒ: æ¯5åˆ†é’Ÿå…¨é‡åŒæ­¥ä¸€æ¬¡ï¼ˆé˜²æ­¢æ•°æ®ä¸ä¸€è‡´ï¼‰

---

## äº”ã€ç½‘ç»œä¼˜åŒ–æŠ€å·§

### 5.1 å‡å°‘RPCè°ƒç”¨é¢‘ç‡

**é—®é¢˜**: é«˜é¢‘RPCä¼šå¯¼è‡´ç½‘ç»œæ‹¥å¡

**âŒ ä½æ•ˆå†™æ³•**:
```python
def Update(self):
    # æ¯å¸§ï¼ˆ60fpsï¼‰å‘é€ä½ç½®æ›´æ–°
    self.NotifyToServer('Player_PositionUpdate', {
        'pos': self.GetPlayerPos()
    })
```

**âœ… ä¼˜åŒ–æ–¹æ¡ˆ1: èŠ‚æµï¼ˆThrottleï¼‰**
```python
def __init__(self):
    self.tick_counter = 0

def Update(self):
    self.tick_counter += 1
    # æ¯20å¸§ï¼ˆçº¦0.33ç§’ï¼‰å‘é€ä¸€æ¬¡
    if self.tick_counter % 20 == 0:
        self.NotifyToServer('Player_PositionUpdate', {
            'pos': self.GetPlayerPos()
        })
```

**âœ… ä¼˜åŒ–æ–¹æ¡ˆ2: ä»…åœ¨æ•°æ®å˜åŒ–æ—¶å‘é€**
```python
def __init__(self):
    self.last_sent_pos = None

def Update(self):
    current_pos = self.GetPlayerPos()
    # åªæœ‰ä½ç½®å˜åŒ–è¶…è¿‡0.5æ ¼æ—¶æ‰å‘é€
    if self.last_sent_pos is None or self.DistanceTo(current_pos, self.last_sent_pos) > 0.5:
        self.NotifyToServer('Player_PositionUpdate', {
            'pos': current_pos
        })
        self.last_sent_pos = current_pos
```

---

### 5.2 æ‰¹é‡æ“ä½œ

**âŒ ä½æ•ˆå†™æ³•**:
```python
def GiveRewards(self, playerId, itemIds):
    for itemId in itemIds:
        # æ¯ä¸ªç‰©å“å‘é€ä¸€æ¬¡RPC
        self.NotifyToClient(playerId, 'Item_AddedEvent', {
            'itemId': itemId
        })
```

**âœ… é«˜æ•ˆå†™æ³•**:
```python
def GiveRewards(self, playerId, itemIds):
    # æ‰¹é‡å‘é€
    self.NotifyToClient(playerId, 'Items_BatchAddedEvent', {
        'itemIds': itemIds  # ä¸€æ¬¡å‘é€æ‰€æœ‰ç‰©å“
    })
```

**æ€§èƒ½å¯¹æ¯”**:
- å•æ¬¡å‘é€: 10ä¸ªç‰©å“ = 10æ¬¡RPC = ~100ms
- æ‰¹é‡å‘é€: 10ä¸ªç‰©å“ = 1æ¬¡RPC = ~10ms (**10å€æå‡**)

---

### 5.3 æ•°æ®å‹ç¼©

**æŠ€å·§1: ä½¿ç”¨çŸ­é”®å**
```python
# âŒ å†—é•¿çš„é”®å
self.NotifyToClient(playerId, 'Event', {
    'playerUniqueIdentifier': 'player123',
    'itemIdentifier': 'diamond_sword',
    'quantityAmount': 10
})  # ~80å­—èŠ‚

# âœ… ç®€çŸ­çš„é”®å
self.NotifyToClient(playerId, 'Event', {
    'pid': 'player123',  # player id
    'iid': 'diamond_sword',  # item id
    'qty': 10  # quantity
})  # ~50å­—èŠ‚ï¼ˆèŠ‚çœ37%ï¼‰
```

**æŠ€å·§2: ä½¿ç”¨æšä¸¾ä»£æ›¿å­—ç¬¦ä¸²**
```python
# âŒ ä½¿ç”¨å®Œæ•´å­—ç¬¦ä¸²
self.NotifyToClient(playerId, 'Event', {
    'type': 'purchase_item'  # 13å­—èŠ‚
})

# âœ… ä½¿ç”¨æ•°å­—æšä¸¾
# å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çº¦å®š: 1=purchase, 2=sell, 3=trade
self.NotifyToClient(playerId, 'Event', {
    'type': 1  # 1å­—èŠ‚ï¼ˆèŠ‚çœ92%ï¼‰
})
```

---

## å…­ã€å¸¸è§é€šä¿¡æ¨¡å¼

### æ¨¡å¼1: è¯·æ±‚-å“åº” (Request-Response)

**é€‚ç”¨**: å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚,ç­‰å¾…æœåŠ¡å™¨å“åº”

```python
# å®¢æˆ·ç«¯
def RequestData(self):
    self.NotifyToServer('RequestData', {})

def OnDataResponse(self, args):
    data = args['data']
    self.ProcessData(data)

# æœåŠ¡å™¨
def OnRequestData(self, args):
    playerId = args['playerId']
    data = self.GetData(playerId)
    self.NotifyToClient(playerId, 'DataResponse', {'data': data})
```

---

### æ¨¡å¼2: å‘å¸ƒ-è®¢é˜… (Publish-Subscribe)

**é€‚ç”¨**: æœåŠ¡å™¨ä¸»åŠ¨æ¨é€äº‹ä»¶,å¤šä¸ªå®¢æˆ·ç«¯è®¢é˜…

```python
# æœåŠ¡å™¨
def OnWorldBossSpawn(self, bossId):
    # å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…
    self.BroadcastToAllClient('WorldBoss_SpawnedEvent', {
        'bossId': bossId,
        'pos': self.GetBossPos(bossId)
    })

# å®¢æˆ·ç«¯
def OnBossSpawned(self, args):
    bossId = args['bossId']
    # æ˜¾ç¤ºBOSSåˆ·æ–°æç¤º
    self.ShowBossAlert(bossId)
```

---

### æ¨¡å¼3: å¿ƒè·³ä¿æ´» (Heartbeat)

**é€‚ç”¨**: ä¿æŒè¿æ¥æ´»è·ƒ,æ£€æµ‹æ–­çº¿

```python
# å®¢æˆ·ç«¯
def __init__(self):
    self.heartbeat_interval = 30  # 30ç§’

def Update(self):
    if self.tick_counter % (20 * self.heartbeat_interval) == 0:
        self.NotifyToServer('Client_HeartbeatEvent', {})

# æœåŠ¡å™¨
def OnHeartbeat(self, args):
    playerId = args['playerId']
    self.UpdatePlayerLastActiveTime(playerId)
```

---

## ä¸ƒã€å®‰å…¨ä¸é˜²ä½œå¼Š

### 7.1 æœåŠ¡å™¨éªŒè¯åŸåˆ™

**é»„é‡‘æ³•åˆ™**: **æ°¸è¿œä¸è¦ä¿¡ä»»å®¢æˆ·ç«¯æ•°æ®**

```python
# âŒ å±é™©: ç›´æ¥ä¿¡ä»»å®¢æˆ·ç«¯å‘é€çš„é‡‘é¢
class ShopServerSystem(ServerSystem):
    def OnBuyItem(self, args):
        playerId = args['playerId']
        itemId = args['itemId']
        price = args['price']  # âŒ å®¢æˆ·ç«¯å¯ä»¥ä¿®æ”¹ä¸º0

        self.DeductMoney(playerId, price)  # å±é™©!
        self.GiveItem(playerId, itemId)

# âœ… å®‰å…¨: æœåŠ¡å™¨é‡æ–°è®¡ç®—ä»·æ ¼
class ShopServerSystem(ServerSystem):
    def OnBuyItem(self, args):
        playerId = args['playerId']
        itemId = args['itemId']

        # æœåŠ¡å™¨æ ¹æ®ç‰©å“IDæŸ¥è¯¢çœŸå®ä»·æ ¼
        real_price = self.GetItemPrice(itemId)

        if self.GetPlayerMoney(playerId) < real_price:
            self.NotifyToClient(playerId, 'BuyFailed', {'reason': 'not_enough_money'})
            return

        self.DeductMoney(playerId, real_price)
        self.GiveItem(playerId, itemId)
```

---

### 7.2 é˜²æ­¢é‡æ”¾æ”»å‡»

**é—®é¢˜**: é»‘å®¢é‡å¤å‘é€åŒä¸€ä¸ªè¯·æ±‚

**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ å”¯ä¸€è¯·æ±‚ID + æ—¶é—´æˆ³

```python
# å®¢æˆ·ç«¯
def BuyItem(self, itemId):
    request_id = self.GenerateUniqueID()  # UUID
    timestamp = self.GetCurrentTime()

    self.NotifyToServer('BuyItem', {
        'requestId': request_id,
        'timestamp': timestamp,
        'itemId': itemId
    })

# æœåŠ¡å™¨
def OnBuyItem(self, args):
    request_id = args['requestId']
    timestamp = args['timestamp']

    # æ£€æŸ¥æ˜¯å¦é‡å¤è¯·æ±‚
    if self.IsRequestProcessed(request_id):
        print "[Warning] Duplicate request:", request_id
        return

    # æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦è¿‡æœŸï¼ˆ30ç§’å†…æœ‰æ•ˆï¼‰
    if self.GetCurrentTime() - timestamp > 30:
        print "[Warning] Expired request:", request_id
        return

    # æ ‡è®°è¯·æ±‚å·²å¤„ç†
    self.MarkRequestProcessed(request_id)

    # æ­£å¸¸å¤„ç†ä¸šåŠ¡é€»è¾‘
    self.ProcessBuyItem(args)
```

---

### 7.3 é¢‘ç‡é™åˆ¶

**é˜²æ­¢**: å®¢æˆ·ç«¯æ¶æ„åˆ·è¯·æ±‚ï¼ˆDDoSæ”»å‡»ï¼‰

```python
class ShopServerSystem(ServerSystem):
    def __init__(self):
        self.player_request_count = {}  # {playerId: [(timestamp1, timestamp2, ...)]}

    def OnBuyItem(self, args):
        playerId = args['playerId']
        current_time = self.GetCurrentTime()

        # æ£€æŸ¥æœ€è¿‘1ç§’å†…çš„è¯·æ±‚æ¬¡æ•°
        if playerId not in self.player_request_count:
            self.player_request_count[playerId] = []

        recent_requests = [t for t in self.player_request_count[playerId] if current_time - t < 1.0]

        if len(recent_requests) > 10:  # 1ç§’æœ€å¤š10æ¬¡è¯·æ±‚
            print "[Warning] Rate limit exceeded:", playerId
            self.NotifyToClient(playerId, 'Error', {'reason': 'rate_limit'})
            return

        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        self.player_request_count[playerId] = recent_requests + [current_time]

        # æ­£å¸¸å¤„ç†
        self.ProcessBuyItem(args)
```

---

## å…«ã€è°ƒè¯•ä¸æµ‹è¯•

### 8.1 æ—¥å¿—è®°å½•

**æ¨è**: åœ¨RPCè°ƒç”¨å‰åè®°å½•æ—¥å¿—

```python
def NotifyToServerWithLog(self, eventName, data):
    """å¸¦æ—¥å¿—çš„RPCè°ƒç”¨"""
    print "[RPC] Client -> Server:", eventName, data
    self.NotifyToServer(eventName, data)

def OnServerEvent(self, args):
    """å¸¦æ—¥å¿—çš„äº‹ä»¶å¤„ç†"""
    print "[RPC] Server -> Client:", args
    # å¤„ç†é€»è¾‘
```

---

### 8.2 ç½‘ç»œå»¶è¿Ÿæ¨¡æ‹Ÿ

**ç”¨é€”**: æµ‹è¯•é«˜å»¶è¿Ÿç¯å¢ƒä¸‹çš„ç”¨æˆ·ä½“éªŒ

```python
import time

def NotifyToServerWithDelay(self, eventName, data, delay=0.1):
    """æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ"""
    time.sleep(delay)  # å»¶è¿Ÿ100ms
    self.NotifyToServer(eventName, data)
```

---

### 8.3 å•å…ƒæµ‹è¯•

```python
class TestShopRPC(unittest.TestCase):
    def test_buy_item_success(self):
        """æµ‹è¯•è´­ä¹°æˆåŠŸæµç¨‹"""
        # 1. æ¨¡æ‹Ÿå®¢æˆ·ç«¯å‘é€è¯·æ±‚
        client.NotifyToServer('BuyItem', {'itemId': 'diamond'})

        # 2. éªŒè¯æœåŠ¡å™¨å¤„ç†
        self.assertTrue(server.IsItemOwned(playerId, 'diamond'))

        # 3. éªŒè¯å®¢æˆ·ç«¯æ”¶åˆ°å“åº”
        response = client.WaitForEvent('BuySuccess', timeout=1.0)
        self.assertEqual(response['itemId'], 'diamond')
```

---

## ä¹ã€å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- **MODSDKç½‘ç»œAPI**: å‚è€ƒ`.claude/docs/modsdk-wiki/`
- **åŸºå²©ç‰ˆç½‘ç»œæ¶æ„**: å‚è€ƒ`.claude/docs/bedrock-wiki/`

### ç›¸å…³å·¥ä½œæµæ–‡æ¡£
- **å¼€å‘è§„èŒƒ.md**: åŒç«¯éš”ç¦»CRITICALè§„èŒƒ
- **äº‹ä»¶ç³»ç»Ÿå®Œæ•´å‚è€ƒ.md**: äº‹ä»¶é€šä¿¡è¯¦è§£
- **æ·±å…¥ç†è§£ECSæ¶æ„.md**: Componentçš„ç½‘ç»œåŒæ­¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-11
**ç»´æŠ¤è€…**: NeteaseMod-Claudeå·¥ä½œæµ
