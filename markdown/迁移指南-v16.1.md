# v16.1 迁移指南 - 项目扩展区支持

> 📚 **从 v16.0 升级到 v16.1 的完整迁移指南**
>
> **发布日期**: 2025-11-11
> **核心变更**: CLAUDE.md新增项目扩展区，支持项目特定规范

---

## 🎯 v16.1 核心变更

### 架构升级：单文件四段式结构

**v16.0 架构（工作流内容固化）:**
```
CLAUDE.md
├─ 工作流内容（完整，无法定制）
└─ 升级时整个文件被覆盖
```

**v16.1 架构（四段式）:**
```
CLAUDE.md
├─ 📌 项目配置区（用户可编辑，升级保留）
├─ 📦 工作流内容区（自动管理，升级替换）
├─ 🎯 项目扩展区（用户可编辑，升级保留） ⭐ 新增
└─ 📝 文档元数据区（自动管理）
```

**关键改进**：
- ✅ 项目扩展区：添加项目特定规范（依赖声明、团队约定、自定义架构）
- ✅ 智能升级：自动提取并保留用户编辑内容
- ✅ 三层文档优先级：扩展区 → 覆盖层 → 上游基线

---

## 🚀 自动迁移（推荐）

### 步骤1: 执行自动迁移

```bash
# 进入项目目录
cd D:\MyMODProject

# 执行迁移（自动检测v16.0并升级到v16.1）
initmc

# 输出示例：
# [迁移] 检测到 v16.0 项目，开始迁移到 v16.1...
# [迁移] 📝 升级CLAUDE.md到v16.1...
# [迁移] 📦 已备份到: CLAUDE.md.backup.2025-11-11
# [迁移] ✅ CLAUDE.md已升级
# [迁移] ✅ 迁移完成！
```

### 步骤2: 验证迁移结果

打开 `CLAUDE.md`，检查文件结构：

```markdown
<!-- ==================== 项目配置区 START ==================== -->
## 📌 项目信息
...
<!-- ==================== 项目配置区 END ==================== -->

<!-- ==================== 工作流内容 START v16.1 ==================== -->
...完整工作流...
<!-- ==================== 工作流内容 END v16.1 ==================== -->

<!-- ==================== 项目扩展区 START ==================== -->  ⭐ 新增
## 🎯 项目特定规范
...
<!-- ==================== 项目扩展区 END ==================== -->

<!-- ==================== 文档元数据区 START ==================== -->
...
<!-- ==================== 文档元数据区 END ==================== -->
```

---

## 🎯 项目扩展区使用指南

### 何时使用项目扩展区？

**✅ 适合添加（项目扩展区）**：
- 项目依赖声明（如依赖其他MOD项目）
- 团队协作流程（提交规范、Code Review流程）
- 自定义架构模式（State模式、数据管理规范）
- 命名约定（变量命名、文件组织）

**❌ 不适合添加（应使用 `markdown/core/开发规范.md`）**：
- MODSDK API/事件规范定制
- CRITICAL规范修改
- System/Component生命周期规范

### 示例1：添加项目依赖声明

```markdown
<!-- CLAUDE.md → 项目扩展区 -->
## 🎯 项目特定规范

### 项目依赖

#### EC预设模块依赖
- **依赖项目**: ECPresetMod
- **项目路径**: `D:\EcWork\ECPresetMod`
- **用途**: 提供通用预设功能和基础组件
- **说明**: 本起床战争项目依赖EC预设项目的基础设施

当需要查阅EC预设模块的实现时，请访问：
- 项目根目录: `D:\EcWork\ECPresetMod`
- 文档目录: `D:\EcWork\ECPresetMod\markdown`
```

### 示例2：添加团队协作流程

```markdown
### 团队协作流程

#### Git提交规范
- 提交前必须运行单元测试
- Commit message格式：`[类型] 简短描述`
  - feat: 新功能
  - fix: Bug修复
  - docs: 文档更新

#### Code Review流程
- 所有PR需要至少1人Review
- 关键模块需要技术负责人Review
```

### 示例3：添加自定义架构

```markdown
### 自定义架构模式

#### State管理模式
- 本项目使用State模式管理游戏状态
- 所有状态类继承自 `BaseState`
- 状态切换通过 `StateManager` 统一管理

**示例**：
\`\`\`python
class GamePlayState(BaseState):
    def OnEnter(self):
        # 进入游戏状态
        StateManager.SetState("GamePlay")
\`\`\`

#### 数据持久化规范
- 所有数据库操作统一使用 `DBManager`
- 禁止在System中直接操作文件
- 使用异步保存机制避免卡顿
```

---

## 📊 三层文档优先级（v16.1）

AI查阅文档时的优先级：

**层级1: CLAUDE.md项目扩展区（最高优先级）** ⭐ v16.1新增
- 位置：`CLAUDE.md` 文档底部
- 内容：项目特定规范（依赖、约定、架构）
- AI行为：优先查阅，严格遵循

**层级2: 项目覆盖层**
- 位置：`markdown/core/开发规范.md` 等
- 内容：项目定制的MODSDK规范
- AI行为：覆盖上游MODSDK规范

**层级3: 上游基线**
- 位置：`.claude/core-docs/`
- 内容：标准MODSDK规范
- AI行为：默认遵循

**示例AI查询流程**：
```
1. 读取 CLAUDE.md → 发现项目扩展区有依赖声明
2. 读取 markdown/core/开发规范.md（如存在）
3. 读取 .claude/core-docs/开发规范.md（标准规范）
```

---

## 🔄 后续升级流程

### v16.1 项目升级到更新版本

```bash
# 检查上游更新
initmc --sync

# 自动执行：
# 1. 检测版本（本地 vs 上游）
# 2. 智能提取项目配置区和项目扩展区
# 3. 更新工作流内容区
# 4. 重新组装CLAUDE.md
# 5. 备份旧版（CLAUDE.md.backup.{date}）
```

---

## ⚙️ AI行为变更

### v16.0 AI行为

```python
# AI直接读取CLAUDE.md（无法定制）
Read("CLAUDE.md")  # 完整工作流，无项目特定规范

# 需要定制时，只能使用markdown/core/
Read("markdown/core/开发规范.md")
```

### v16.1 AI行为（三层优先级）

```python
# 层级1: 优先读取项目扩展区
Read("CLAUDE.md")  # 查看"项目扩展区"
if 发现项目依赖声明 or 团队约定:
    优先遵循项目特定规范

# 层级2: 读取项目覆盖层（如有）
if exists("markdown/core/开发规范.md"):
    Read("markdown/core/开发规范.md")  # 项目定制的MODSDK规范

# 层级3: 读取上游基线
Read(".claude/core-docs/开发规范.md")  # 标准MODSDK规范
```

---

## 🎯 预期效果对比

| 指标 | v16.0 | v16.1 | 改进幅度 |
|-----|-------|-------|---------|
| **定制成本** | 需创建markdown/core/文件 | 直接编辑CLAUDE.md | -90% |
| **定制范围** | 仅MODSDK规范 | 项目特定规范+MODSDK规范 | +100% |
| **升级安全性** | CLAUDE.md整个覆盖 | 智能提取保留 | 100%安全 |
| **文档优先级** | 两层 | 三层 | 更清晰 |

---

## ❓ 常见问题

### Q1: 迁移后我的CLAUDE.md自定义内容会丢失吗？

**A**: 不会。迁移工具会：
1. 自动备份旧版到 `CLAUDE.md.backup.{date}`
2. 如果旧版有自定义内容，会尽力提取到项目扩展区
3. 无法自动提取的内容，可以从备份中手动复制

### Q2: 项目扩展区 vs markdown/core/ 如何选择？

**A**:
- **项目扩展区**：非MODSDK相关规范
  - 示例：依赖声明、团队流程、自定义架构、命名约定
  - 优势：轻量级，直接在CLAUDE.md编辑

- **markdown/core/**：MODSDK规范定制
  - 示例：禁用某些事件、修改CRITICAL规范
  - 优势：完整覆盖上游文档，独立维护

### Q3: 如何查看上游更新了哪些内容？

**A**:
```bash
# 对比上游模板与项目CLAUDE.md
diff templates/CLAUDE.md.template CLAUDE.md

# 查看当前版本
type .claude/workflow-manifest.json
```

### Q4: 如果我不想迁移怎么办？

**A**: v16.0项目可以继续使用，但无法获得v16.1的新特性：
- 无法使用项目扩展区
- CLAUDE.md升级时会整个覆盖（需手动备份）

---

## 📞 技术支持

如遇到迁移问题，请：

1. **检查备份**：`CLAUDE.md.backup.{date}` 应该包含旧版内容
2. **查看日志**：迁移过程中的输出信息
3. **手动恢复**：从备份中复制关键内容到项目扩展区
4. **提交Issue**: 前往 GitHub Issues 反馈问题

---

## 📝 版本历史

- **v16.1** (2025-11-11): 项目扩展区支持，三层文档优先级
- **v16.0** (2025-11-11): 双层文档架构发布
- **v15.1** (2025-11-10): 文档导航优化
- **v15.0** (2025-11-09): 内联式架构重构

---

_最后更新: 2025-11-11_
_文档版本: v16.1_
