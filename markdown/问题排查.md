# é—®é¢˜æ’æŸ¥æŒ‡å—

> **ğŸ“ å¯¼èˆª**: [ğŸ  é¦–é¡µ](../README.md) > [ğŸ“‚ æ–‡æ¡£](../README.md#æ–‡æ¡£å¯¼èˆª) > é—®é¢˜æ’æŸ¥
>
> ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€è°ƒè¯•æŠ€å·§å’Œæ€§èƒ½ä¼˜åŒ–å»ºè®®
>
> **ğŸ“… æœ€åæ›´æ–°**: 2025-02-01

---

## ğŸ“‹ ç›®å½•

1. [å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰](#å¸¸è§é—®é¢˜faq)
2. [è°ƒè¯•æŠ€å·§](#è°ƒè¯•æŠ€å·§)
3. [ç½‘æ˜“å¼•æ“é™åˆ¶](#ç½‘æ˜“å¼•æ“é™åˆ¶)
4. [ECPresetæ¡†æ¶ç›¸å…³é—®é¢˜](#ecpresetæ¡†æ¶ç›¸å…³é—®é¢˜)
5. [æ€§èƒ½é—®é¢˜](#æ€§èƒ½é—®é¢˜)
6. [é—®é¢˜æ¡ˆä¾‹ï¼šé¢„è®¾äº‹ä»¶é‡å¤è§¦å‘](#é—®é¢˜æ¡ˆä¾‹é¢„è®¾äº‹ä»¶é‡å¤è§¦å‘)
7. [é—®é¢˜8ï¼šæ¸¸æˆç»“æŸåˆ¤å®šæ— æ³•è§¦å‘](#é—®é¢˜8æ¸¸æˆç»“æŸåˆ¤å®šæ— æ³•è§¦å‘)
8. [é—®é¢˜9ï¼šæ¸¸æˆç»“æŸtitleæ˜¾ç¤ºä¸æ­£ç¡®](#é—®é¢˜9æ¸¸æˆç»“æŸtitleæ˜¾ç¤ºä¸æ­£ç¡®)

---

## å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### é—®é¢˜1ï¼šå¯¼å…¥é”™è¯¯ - æ‰¾ä¸åˆ°æ¨¡å—

**ç—‡çŠ¶**ï¼š`ImportError: No module named 'XXX'`

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ£€æŸ¥modConfig.pyä¸­çš„ç³»ç»Ÿè·¯å¾„æ˜¯å¦æ­£ç¡®**
   - æœåŠ¡ç«¯ç³»ç»Ÿï¼š`"Script_NeteaseMod.systems.XXXSystem.XXXSystem"`
   - å®¢æˆ·ç«¯ç³»ç»Ÿï¼š`"Script_NeteaseMod.systems.XXXClientSystem.XXXClientSystem"`

2. **ç¡®è®¤æ–‡ä»¶åå’Œç±»ååŒ¹é…**ï¼ˆPython 2.7åŒºåˆ†å¤§å°å†™ï¼‰

3. **æ£€æŸ¥æ‰€æœ‰åŒ…ç›®å½•éƒ½æœ‰`__init__.py`æ–‡ä»¶**

4. **ç¡®è®¤ECPresetæ¡†æ¶å¯è®¿é—®**ï¼ˆ`D:\EcWork\ECPresetMod`ï¼‰

---

### é—®é¢˜2ï¼šé¢„è®¾å®ä½“æ— æ³•äº¤äº’

**ç—‡çŠ¶**ï¼šåœ°å›¾ä¸­æ”¾ç½®çš„é¢„è®¾å®ä½“æ— å“åº”

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥é¢„è®¾ç±»å‹æ˜¯å¦åœ¨`modConfig.py`çš„`PRESET_TYPE_DEFINITIONS`ä¸­æ³¨å†Œ
2. éªŒè¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é¢„è®¾ç±»éƒ½å·²å®ç°
3. ä½¿ç”¨è°ƒè¯•å‘½ä»¤æŸ¥çœ‹é¢„è®¾ç®¡ç†å™¨çŠ¶æ€

---

### é—®é¢˜11: å¼•æ“äº‹ä»¶å›è°ƒç­¾åé”™è¯¯å¯¼è‡´NPCæ— æ³•äº¤äº’

**ç—‡çŠ¶**:
- ç‚¹å‡»NPCæ—¶ç¨‹åºæŠ¥é”™ï¼š`TypeError: _on_damage() takes exactly 3 arguments (2 given)`
- æˆ–ç‚¹å‡»NPCæ— ä»»ä½•ååº”ï¼ŒUIæ— æ³•æ‰“å¼€

**å…¸å‹é”™è¯¯ä¿¡æ¯**:
```
[15:46:38] TypeError: _on_damage() takes exactly 3 arguments (2 given)
```

**æ ¹æœ¬åŸå› **:
æ··æ·†äº†ä¸¤ç§äº‹ä»¶ç³»ç»Ÿçš„å›è°ƒç­¾åï¼š
- **å¼•æ“äº‹ä»¶**ï¼ˆå¦‚ DamageEventã€PlayerDoInteractServerEventï¼‰ï¼šåªæ¥å—**1ä¸ªå‚æ•°** `args`
- **ECPresetè‡ªå®šä¹‰äº‹ä»¶**ï¼ˆå¦‚ BedWarsRunningã€BedWarsEndingï¼‰ï¼šæ¥å—**2ä¸ªå‚æ•°** `event_name, event_data`

å½“ä½¿ç”¨ `ListenForEvent()` æ³¨å†Œå¼•æ“äº‹ä»¶æ—¶ï¼Œå›è°ƒå‡½æ•°å¿…é¡»ä½¿ç”¨1å‚æ•°ç­¾åï¼Œå¦åˆ™ä¼šå¯¼è‡´å‚æ•°æ•°é‡ä¸åŒ¹é…é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. **æ£€æŸ¥äº‹ä»¶ç±»å‹**ï¼šç¡®è®¤æ˜¯å¼•æ“äº‹ä»¶è¿˜æ˜¯è‡ªå®šä¹‰äº‹ä»¶
   - å¼•æ“äº‹ä»¶ï¼šé€šè¿‡ `server_system.ListenForEvent(engineNamespace, engineSystem, eventName, ...)` æ³¨å†Œ
   - è‡ªå®šä¹‰äº‹ä»¶ï¼šé€šè¿‡ `instance.subscribe_event(eventName, callback)` æ³¨å†Œ

2. **ä½¿ç”¨æ­£ç¡®çš„å›è°ƒç­¾å**ï¼š

```python
# âœ… æ­£ç¡® - å¼•æ“äº‹ä»¶å›è°ƒï¼ˆ1ä¸ªå‚æ•°ï¼‰
def _on_damage(self, args):
    """
    å¤„ç†ä¼¤å®³äº‹ä»¶

    Args:
        args: dict äº‹ä»¶å‚æ•°
            - entityId: str å—ä¼¤å®ä½“ID
            - srcId: str æ”»å‡»è€…ID
            - damage: float ä¼¤å®³å€¼
    """
    entity_id = args.get('entityId')
    player_id = args.get('srcId')
    # å¤„ç†é€»è¾‘...

# âœ… æ­£ç¡® - è‡ªå®šä¹‰äº‹ä»¶å›è°ƒï¼ˆ2ä¸ªå‚æ•°ï¼‰
def _on_bedwars_running(self, event_name, event_data):
    """
    å¤„ç†æ¸¸æˆRunningäº‹ä»¶

    Args:
        event_name (str): äº‹ä»¶åç§°
        event_data (dict): äº‹ä»¶æ•°æ®
    """
    # å¤„ç†é€»è¾‘...

# âŒ é”™è¯¯ - å¼•æ“äº‹ä»¶ä½¿ç”¨äº†2å‚æ•°ç­¾å
def _on_damage(self, event_name, event_data):  # ä¼šæŠ¥é”™ï¼
    entity_id = event_data.get('entityId')
```

3. **å•†åº—NPCäº¤äº’çš„ç‰¹æ®Šå¤„ç†**ï¼š
   - å•†åº—NPCçš„äº¤äº’æ˜¯é€šè¿‡**æ”»å‡»ï¼ˆå·¦é”®ï¼‰**å®ç°çš„ï¼Œè€Œä¸æ˜¯å³é”®äº¤äº’
   - åœ¨ `_on_damage` äº‹ä»¶ä¸­ï¼š
     - ä¿æŠ¤NPCå…ç–«ä¼¤å®³ï¼ˆdamage=0, knock=False, ignite=Falseï¼‰
     - è·å–æ”»å‡»è€…ID (`srcId`)
     - è°ƒç”¨å•†åº—æ‰“å¼€é€»è¾‘

```python
# âœ… æ­£ç¡® - å•†åº—NPCæ”»å‡»äº¤äº’å®ç°
def _on_damage(self, args):
    entity_id = args.get('entityId')

    # æ£€æŸ¥æ˜¯å¦æ˜¯å•†åº—NPC
    if entity_id != self.shop_npc_id:
        return

    # ä¿æŠ¤NPCå…ç–«ä¼¤å®³
    args['damage'] = 0
    args['knock'] = False
    args['ignite'] = False

    # è·å–æ”»å‡»è€…å¹¶æ‰“å¼€å•†åº—
    player_id = args.get('srcId')
    if self._can_player_use_shop(player_id):
        self._open_shop_ui(player_id)
```

**ç›¸å…³ä»£ç ä½ç½®**:
- [ShopPresetDefServer.py:178-214] æ­£ç¡®çš„äº‹ä»¶å›è°ƒå®ç°
- [GuideShopPresetDefServer.py:117-135] å‚è€ƒå®ç°

**ç›¸å…³æ–‡æ¡£**:
- [å¼€å‘è§„èŒƒ.md:152] Systemç”Ÿå‘½å‘¨æœŸ - äº‹ä»¶æ³¨å†Œè§„èŒƒ
- [presets/08_é¢„è®¾å¼€å‘æŒ‡å—.md] ECPresetäº‹ä»¶ç³»ç»Ÿ

**å†å²ä¿®å¤**: 2025-11-06

**æ¡ˆä¾‹**:
å•†åº—NPCç‚¹å‡»æ— å“åº”é—®é¢˜ï¼š
1. åˆå§‹é”™è¯¯ï¼š`_on_damage` ä½¿ç”¨äº†2å‚æ•°ç­¾å `(self, event_name, event_data)`ï¼Œå¯¼è‡´TypeError
2. ä¸­é—´é—®é¢˜ï¼šä¿®å¤ç­¾ååNPCä¸å—ä¼¤ä½†ç‚¹å‡»æ— å“åº”ï¼Œå› ä¸ºé—æ¼äº†æ”»å‡»äº¤äº’é€»è¾‘
3. æœ€ç»ˆä¿®å¤ï¼šä½¿ç”¨1å‚æ•°ç­¾å `(self, args)` + åœ¨ `_on_damage` ä¸­æ·»åŠ å•†åº—æ‰“å¼€é€»è¾‘

---

### é—®é¢˜8: å•†åº—é…ç½®ä¸è€é¡¹ç›®ä¸ä¸€è‡´

**ç—‡çŠ¶**:
- å•†åº—çª—å£ä¸­æœ‰é‡å¤å•†å“ï¼ˆä¾‹å¦‚é»‘æ›œçŸ³åœ¨åŒä¸€çª—å£å‡ºç°å¤šæ¬¡ï¼‰
- ç¼ºå°‘è€é¡¹ç›®çš„ç¬¬ä¸€ä¸ª"å¿«æ·åˆ—è¡¨"çª—å£ï¼ˆå¸¸ç”¨é“å…·å¿«é€Ÿè´­ä¹°çª—å£ï¼‰
- å•†åº—çª—å£æ•°é‡å’Œå•†å“é…ç½®ä¸è€é¡¹ç›®å­˜åœ¨è¾ƒå¤§å·®å¼‚

**å…¸å‹é”™è¯¯ä¿¡æ¯**:
æ— é”™è¯¯æ—¥å¿—ï¼Œä½†ç”¨æˆ·åœ¨æ¸¸æˆä¸­è§‚å¯Ÿåˆ°UIæ˜¾ç¤ºä¸æ­£ç¡®ï¼š
- åŒä¸€å•†å“çš„ä¸åŒå˜ä½“ï¼ˆå¦‚ obsidian å’Œ obsidian.4ï¼‰åŒæ—¶å‡ºç°
- é˜²å…·çª—å£åŒæ—¶æ˜¾ç¤ºèƒ¸ç”²å’ŒæŠ¤è…¿ç‰ˆæœ¬
- ç¼ºå°‘åŒ…å«40ä¸ªå¸¸ç”¨å•†å“çš„å¿«æ·åˆ—è¡¨çª—å£

**æ ¹æœ¬åŸå› **:
æ–°é¡¹ç›®çš„ `shop_config.py` é…ç½®æ–‡ä»¶ä¸è€é¡¹ç›®å­˜åœ¨å¤šå¤„å·®å¼‚ï¼š

1. **ç¼ºå°‘å¿«æ·åˆ—è¡¨çª—å£**: è€é¡¹ç›®ç¬¬ä¸€ä¸ªçª—å£æ˜¯"å¿«æ·åˆ—è¡¨"ï¼ˆ40ä¸ªå¸¸ç”¨å•†å“ï¼‰ï¼Œæ–°é¡¹ç›®å®Œå…¨ç¼ºå¤±
2. **å•†å“æ•°é‡è¿‡å¤š**: æ–°é¡¹ç›®å„çª—å£å•†å“æ•°é‡è¿œè¶…è€é¡¹ç›®ï¼Œå¯¼è‡´é‡å¤å’Œå†—ä½™
   - æ–¹å—çª—å£: 15ä¸ª â†’ åº”ä¸º7ä¸ª
   - åˆ©å‰‘çª—å£: 5ä¸ª â†’ åº”ä¸º4ä¸ª
   - å¼“ç®­çª—å£: 7ä¸ª â†’ åº”ä¸º4ä¸ª
   - é˜²å…·çª—å£: 8ä¸ª â†’ åº”ä¸º3ä¸ªï¼ˆä»…æŠ¤è…¿ç‰ˆæœ¬ï¼‰
   - å·¥å…·çª—å£: 6ä¸ª â†’ åº”ä¸º3ä¸ªï¼ˆä»…å¯å‡çº§å·¥å…·ï¼‰
   - é…¿é€ çª—å£: 4ä¸ª â†’ åº”ä¸º3ä¸ª
   - é“å…·çª—å£: 12ä¸ª â†’ åº”ä¸º9ä¸ª
3. **å¸ƒå±€æ¨¡å¼é”™è¯¯**: å¤§éƒ¨åˆ†çª—å£ä½¿ç”¨äº†GRIDå¸ƒå±€ï¼Œåº”è¯¥ä½¿ç”¨BLOCKå¸ƒå±€
4. **å‡çº§çª—å£å•†å“é”™è¯¯**: åŒ…å«7ä¸ªå‡çº§é¡¹ï¼ˆå«upgrade.healthï¼‰ï¼Œåº”ä¸º6ä¸ª

**æŠ€æœ¯åŸå› **:
1. æ–°é¡¹ç›®é…ç½®æ–‡ä»¶æ²¡æœ‰å‚è€ƒè€é¡¹ç›®çš„ `ECBedWarsConfig.py` ä¸­çš„ `shopCategoriesConfig` ç»“æ„
2. å•†å“IDé‡å¤æˆ–ä½¿ç”¨äº†ä¸å¿…è¦çš„å˜ä½“ï¼ˆå¦‚obsidianå’Œobsidian.4åŒæ—¶å­˜åœ¨ï¼‰
3. é˜²å…·é…ç½®åŒæ—¶åŒ…å«chestplateå’Œleggingsç‰ˆæœ¬ï¼Œåº”åªä¿ç•™leggings
4. å¸ƒå±€æ¨¡å¼é€‰æ‹©ä¸å½“ï¼Œå¯¼è‡´å•†å“æ˜¾ç¤ºæ–¹å¼ä¸ç¬¦åˆé¢„æœŸ

**è§£å†³æ–¹æ¡ˆ**:

1. **å‚è€ƒè€é¡¹ç›®é…ç½®**:
   ä» `NetEaseMapECBedWars_å¤‡ä»½\behavior_packs\behavior_pack_TSK85dvb\Parts\ECBedWars\ECBedWarsConfig.py`
   è·å–æ­£ç¡®çš„ `shopCategoriesConfig` ç»“æ„

2. **æ·»åŠ å¿«æ·åˆ—è¡¨çª—å£**ï¼ˆæœ€é‡è¦ï¼‰:
```python
{
    "id": "quick_list",
    "name": u"å¿«æ·åˆ—è¡¨",
    "intro": u"å¸¸ç”¨é“å…·å¿«é€Ÿè´­ä¹°",
    "goods_ids": [
        # 40ä¸ªå¸¸ç”¨å•†å“ID
        "block.wool", "sword.stone", "armor.chain.r",
        "tool.pickaxe-upgrade", "arrow.0", "prop.fireball",
        # ... ç­‰40ä¸ªå•†å“
    ],
    "ui": {
        "layout": "GRID",  # å¿«æ·åˆ—è¡¨ä½¿ç”¨GRIDå¸ƒå±€
        "recommend": True,  # ä»…å¿«æ·åˆ—è¡¨æ ‡è®°ä¸ºæ¨è
        "title": "quick_list",
        "categoryTexture": "textures/ui/bw/bw_category_fast"
    }
}
```

3. **å‡å°‘å„çª—å£å•†å“æ•°é‡**è‡³ä¸è€é¡¹ç›®ä¸€è‡´:
   - ç§»é™¤é‡å¤å•†å“ï¼ˆåªä¿ç•™å¸¸ç”¨å˜ä½“ï¼‰
   - é˜²å…·çª—å£åªä¿ç•™æŠ¤è…¿ç‰ˆæœ¬
   - å·¥å…·çª—å£åªä¿ç•™å¯å‡çº§å·¥å…·
   - ç§»é™¤ä¸å¸¸ç”¨çš„é“å…·

4. **ä¿®æ”¹å¸ƒå±€æ¨¡å¼**:
   é™¤å¿«æ·åˆ—è¡¨å¤–ï¼Œæ‰€æœ‰å•†å“çª—å£ä½¿ç”¨ `BLOCK` å¸ƒå±€ï¼Œå‡çº§/é™·é˜±çª—å£ä½¿ç”¨ `DETAIL` å¸ƒå±€

5. **ä¿®å¤å‡çº§çª—å£**:
   ç§»é™¤ `upgrade.health` å•†å“ï¼Œä¿æŒ6ä¸ªå‡çº§é¡¹

**ç›¸å…³ä»£ç ä½ç½®**:
- [config/shop_config.py:976-1197](D:\EcWork\NetEaseMapECBedWars\behavior_packs\behavior_pack_TSK85dvb\Script_NeteaseMod\config\shop_config.py#L976-L1197) - SHOP_CONFIG å’Œ UPGRADE_SHOP_CONFIG é…ç½®

**ç›¸å…³æ–‡æ¡£**:
- [è€é¡¹ç›®å‚è€ƒ] `ECBedWarsConfig.py` - shopCategoriesConfig ç»“æ„
- [å•†åº—é…ç½®ä¿®å¤å®ŒæˆæŠ¥å‘Š.md](D:\EcWork\å•†åº—é…ç½®ä¿®å¤å®ŒæˆæŠ¥å‘Š.md) - è¯¦ç»†çš„é…ç½®å¯¹æ¯”å’Œä¿®å¤è¯´æ˜

**å†å²ä¿®å¤**: 2025-11-05

**å…³é”®è¯Šæ–­æ–¹æ³•**:
1. ä½¿ç”¨ Task/Explore å·¥å…·æœç´¢è€é¡¹ç›®ä¸­çš„å•†åº—é…ç½®ç»“æ„
2. å¯¹æ¯”æ–°æ—§é¡¹ç›®çš„å•†å“IDåˆ—è¡¨å’Œçª—å£é…ç½®
3. æ£€æŸ¥æ¯ä¸ªçª—å£çš„å•†å“æ•°é‡å’Œå¸ƒå±€æ¨¡å¼
4. éªŒè¯æ¸¸æˆä¸­UIæ˜¾ç¤ºæ˜¯å¦ä¸è€é¡¹ç›®ä¸€è‡´

**éªŒè¯ç»“æœ**:
ä¿®å¤åå•†åº—é…ç½®ä¸è€é¡¹ç›®100%ä¸€è‡´ï¼Œæ‰€æœ‰é‡å¤å•†å“å·²æ¶ˆé™¤ï¼Œå¿«æ·åˆ—è¡¨çª—å£å·²æ·»åŠ ã€‚

---

### é—®é¢˜9: ç©å®¶æŠ¤ç”²æ²¡æœ‰è£…å¤‡åˆ°èº«ä¸Šè€Œæ˜¯æ‰åˆ°èƒŒåŒ…

**ç—‡çŠ¶**:
- å¯¹å±€å¼€å§‹æˆ–æ­»äº¡å¤æ´»æ—¶,ç©å®¶çš„æŠ¤ç”²(å¤´ç›”ã€èƒ¸ç”²ã€è£¤å­ã€é´å­)æ²¡æœ‰ç©¿åœ¨èº«ä¸Š
- æŠ¤ç”²ç‰©å“å‡ºç°åœ¨èƒŒåŒ…ä¸­,è€Œä¸æ˜¯æŠ¤ç”²æ§½
- æœ¨å‰‘å’ŒæŒ‡å—é’ˆæ­£å¸¸å‘æ”¾åˆ°èƒŒåŒ…

**å…¸å‹é”™è¯¯ä¿¡æ¯**:
```
[INFO] [GamingStateSystem] æ¸…ç©ºç©å®¶-4294967295çš„èƒŒåŒ…
[INFO] [GamingStateSystem] ç©å®¶-4294967295è·å¾—ç‰©å“: minecraft:wooden_sword (result=True)
[INFO] [GamingStateSystem] ç©å®¶-4294967295è·å¾—ç‰©å“: minecraft:compass (result=True)
[INFO] [GamingStateSystem] ç©å®¶-4294967295çš„è£…å¤‡åˆå§‹åŒ–å®Œæˆ team=RED
# æ—¥å¿—æ˜¾ç¤ºæˆåŠŸ,ä½†æŠ¤ç”²å®é™…æ²¡æœ‰è£…å¤‡
```

**æ ¹æœ¬åŸå› **:
1. **æŠ¤ç”²ç‰©å“å­—æ®µåé”™è¯¯**: ä½¿ç”¨äº†`newItemName`å­—æ®µ,ä½†æŠ¤ç”²ç‰©å“å¿…é¡»ä½¿ç”¨`itemName`å­—æ®µ
2. **æŠ¤ç”²è®¾ç½®æ–¹æ³•é”™è¯¯**: ä½¿ç”¨`SpawnItemToPlayerInv`é€ä¸ªè®¾ç½®æŠ¤ç”²æ§½,ä½†è¿™ç§æ–¹å¼ä¼šå¯¼è‡´æŠ¤ç”²æ‰åˆ°èƒŒåŒ…è€Œéè£…å¤‡æ 

**æŠ€æœ¯åŸå› **:
1. æŠ¤ç”²ç‰©å“å­—å…¸ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå`newItemName`,SDKè¦æ±‚ä½¿ç”¨`itemName`
2. `SpawnItemToPlayerInv`æ˜¯ä¸“é—¨ç”¨äºèƒŒåŒ…(INVENTORY)çš„API,ä¸é€‚åˆè®¾ç½®æŠ¤ç”²æ§½(ARMOR)
3. æ­£ç¡®æ–¹æ³•æ˜¯ä½¿ç”¨`SetPlayerAllItems`ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰æŠ¤ç”²æ§½ä½

**è§£å†³æ–¹æ¡ˆ**:

1. **ä¿®å¤æŠ¤ç”²ç‰©å“å­—æ®µå**:
```python
# âŒ é”™è¯¯
armor_item = {
    "newItemName": item_name,  # é”™è¯¯å­—æ®µ
    ...
}

# âœ… æ­£ç¡®
armor_item = {
    "itemName": item_name,     # æ­£ç¡®å­—æ®µ
    ...
}
```

2. **ä¿®å¤æŠ¤ç”²è®¾ç½®æ–¹æ³•**:
```python
# âŒ é”™è¯¯: ä½¿ç”¨SpawnItemToPlayerInvé€ä¸ªè®¾ç½®
for i in range(4):
    comp_item.SpawnItemToPlayerInv(...)  # æŠ¤ç”²ä¼šæ‰åˆ°èƒŒåŒ…

# âœ… æ­£ç¡®: ä½¿ç”¨SetPlayerAllItemsä¸€æ¬¡æ€§è®¾ç½®
# å…ˆæ¸…ç©ºæŠ¤ç”²æ§½
comp_item.SetPlayerAllItems({
    (ItemPosType.ARMOR, 0): None,
    (ItemPosType.ARMOR, 1): None,
    (ItemPosType.ARMOR, 2): None,
    (ItemPosType.ARMOR, 3): None
})

# å†è®¾ç½®æ‰€æœ‰æŠ¤ç”²(åªå½±å“ARMORæ§½ä½,ä¸ä¼šæ¸…ç©ºèƒŒåŒ…)
comp_item.SetPlayerAllItems(armor_slots)
```

**ç›¸å…³ä»£ç ä½ç½®**:
- [BedWarsGameSystem.py:2004-2040](D:\EcWork\NetEaseMapECBedWars\behavior_packs\behavior_pack_TSK85dvb\Script_NeteaseMod\systems\BedWarsGameSystem.py#L2004-L2040) - æŠ¤ç”²åˆå§‹åŒ–ä»£ç 

**ç›¸å…³æ–‡æ¡£**:
- [SDKæ–‡æ¡£/æ¥å£/ç©å®¶/èƒŒåŒ….md:615-658] SetPlayerAllItems APIè¯´æ˜
- [SDKæ–‡æ¡£/æ¥å£/ç©å®¶/èƒŒåŒ….md:704-746] SpawnItemToPlayerInv APIè¯´æ˜(ä¸“ç”¨äºèƒŒåŒ…)
- [è€é¡¹ç›®å‚è€ƒ] ECBedWarsPart.py:1417 ä½¿ç”¨itemNameå­—æ®µ
- [è€é¡¹ç›®å‚è€ƒ] ECBedWarsPart.py:1446-1454 ä½¿ç”¨SetPlayerAllItemsè®¾ç½®æŠ¤ç”²

**å†å²ä¿®å¤**: 2025-11-06

**å…³é”®è¯Šæ–­æ–¹æ³•**:
1. æ£€æŸ¥æŠ¤ç”²ç‰©å“å­—å…¸çš„å­—æ®µåæ˜¯å¦ä¸º`itemName`
2. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨`SetPlayerAllItems`è®¾ç½®æŠ¤ç”²è€Œé`SpawnItemToPlayerInv`
3. å¯¹æ¯”è€é¡¹ç›®çš„æŠ¤ç”²è®¾ç½®å®ç°

**éªŒè¯ç»“æœ**:
ä¿®å¤åç©å®¶å¯¹å±€å¼€å§‹å’Œæ­»äº¡å¤æ´»æ—¶,æŠ¤ç”²æ­£ç¡®è£…å¤‡åˆ°æŠ¤ç”²æ§½,ä¸ä¼šæ‰åˆ°èƒŒåŒ…ã€‚

---

### é—®é¢˜10: ç©å®¶æ¯æ¬¡å¤æ´»éƒ½é¢å¤–è·å¾—ä¸€ä¸ªæŒ‡å—é’ˆ

**ç—‡çŠ¶**:
- å¯¹å±€å¼€å§‹æ—¶ç©å®¶è·å¾—1ä¸ªæŒ‡å—é’ˆ(æ­£å¸¸)
- æ¯æ¬¡æ­»äº¡å¤æ´»ååˆé¢å¤–è·å¾—1ä¸ªæŒ‡å—é’ˆ
- æŒ‡å—é’ˆä¸æ–­ç´¯ç§¯,èƒŒåŒ…ä¸­å‡ºç°å¤šä¸ªæŒ‡å—é’ˆ

**å…¸å‹é”™è¯¯ä¿¡æ¯**:
```
[15:46:34] å¯¹å±€å¼€å§‹ - ç©å®¶-4294967295è·å¾—ç‰©å“: minecraft:compass (result=True)  âœ… æ­£ç¡®
[15:47:58] æ­»äº¡å¤æ´» - ç©å®¶-4294967295è·å¾—ç‰©å“: minecraft:compass (result=True)  âŒ é‡å¤å‘æ”¾
```

**æ ¹æœ¬åŸå› **:
`GetPlayerAllItems` APIè¿”å›å€¼ç±»å‹åˆ¤æ–­é”™è¯¯,å°†`list(dict)`è¯¯åˆ¤ä¸ºéœ€è¦`dict`ç±»å‹,å¯¼è‡´æŒ‡å—é’ˆæ£€æŸ¥é€»è¾‘è¢«è·³è¿‡ã€‚

**æŠ€æœ¯åŸå› **:
1. SDKæ–‡æ¡£æ˜ç¡®è¯´æ˜`GetPlayerAllItems`è¿”å›`list(dict)` - åˆ—è¡¨ç±»å‹
2. ä»£ç ä¸­ä½¿ç”¨`if isinstance(all_items, dict):`è¿›è¡Œåˆ¤æ–­,æ°¸è¿œä¸º`False`
3. æŒ‡å—é’ˆæ£€æŸ¥é€»è¾‘è¢«è·³è¿‡,`has_compass`æ°¸è¿œä¸º`False`
4. æ¯æ¬¡å¤æ´»éƒ½ä¼šå‘æ”¾æ–°çš„æŒ‡å—é’ˆ

**è§£å†³æ–¹æ¡ˆ**:

```python
# âŒ é”™è¯¯: åˆ¤æ–­ä¸ºdictç±»å‹
if isinstance(all_items, dict):  # APIè¿”å›listä¸æ˜¯dict
    for slot_id, item_dict in all_items.items():
        ...

# âœ… æ­£ç¡®: ä¼˜å…ˆåˆ¤æ–­listç±»å‹
if isinstance(all_items, list):  # APIè¿”å›list(dict)
    for item_dict in all_items:
        if item_dict and item_dict.get("itemName") == "minecraft:compass":
            has_compass = True
            break
elif isinstance(all_items, dict):  # å…¼å®¹æ€§å¤„ç†
    for slot_id, item_dict in all_items.items():
        if item_dict and item_dict.get("itemName") == "minecraft:compass":
            has_compass = True
            break
```

**ç›¸å…³ä»£ç ä½ç½®**:
- [BedWarsGameSystem.py:1950-1977](D:\EcWork\NetEaseMapECBedWars\behavior_packs\behavior_pack_TSK85dvb\Script_NeteaseMod\systems\BedWarsGameSystem.py#L1950-L1977) - æŒ‡å—é’ˆæ£€æŸ¥å’Œå‘æ”¾é€»è¾‘

**ç›¸å…³æ–‡æ¡£**:
- [SDKæ–‡æ¡£/æ¥å£/ç©å®¶/èƒŒåŒ….md:299-311] GetPlayerAllItemsè¿”å›å€¼è¯´æ˜: `list(dict)`
- [è€é¡¹ç›®å‚è€ƒ] ECBedWarsPart.py:1355-1361 åŒæ—¶å¤„ç†dictå’Œlistä¸¤ç§æƒ…å†µ

**å†å²ä¿®å¤**: 2025-11-06

**å…³é”®è¯Šæ–­æ–¹æ³•**:
1. æŸ¥çœ‹SDKæ–‡æ¡£ç¡®è®¤`GetPlayerAllItems`çš„è¿”å›å€¼ç±»å‹
2. æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦ä¼˜å…ˆåˆ¤æ–­`list`ç±»å‹
3. æµ‹è¯•å¤šæ¬¡æ­»äº¡å¤æ´»è§‚å¯ŸæŒ‡å—é’ˆæ•°é‡

**éªŒè¯ç»“æœ**:
ä¿®å¤åç©å®¶æ•´ä¸ªå¯¹å±€åªä¿æŒ1ä¸ªæŒ‡å—é’ˆ,æ­»äº¡å¤æ´»æ—¶æ£€æµ‹åˆ°å·²æœ‰æŒ‡å—é’ˆåˆ™è·³è¿‡å‘æ”¾ã€‚

---

### é—®é¢˜11: ç©å®¶æ­»äº¡å¤æ´»å€’è®¡æ—¶UIä¸æ˜¾ç¤º

**ç—‡çŠ¶**:
- ç©å®¶æ­»äº¡ååºŠæœªè¢«ç ´åï¼Œå¯ä»¥å¤æ´»
- å¤æ´»é€»è¾‘æ­£å¸¸è¿è¡Œï¼ˆ5ç§’åæˆåŠŸå¤æ´»ï¼‰
- ä½†ç©å®¶åº•éƒ¨UIæ²¡æœ‰æ˜¾ç¤ºä»»ä½•å¤æ´»å€’è®¡æ—¶æç¤º
- ç©å®¶ä¸çŸ¥é“ä½•æ—¶ä¼šå¤æ´»

**å…¸å‹æ—¥å¿—ä¿¡æ¯**:
```
[INFO] [GamingStateSystem] ç©å®¶-4294967295å¼€å§‹å¤æ´»å€’è®¡æ—¶(5ç§’)
[INFO] [GamingStateSystem] ç©å®¶ -4294967295 å·²åˆ‡æ¢ä¸ºè§‚æˆ˜è€…æ¨¡å¼
[INFO] [GamingStateSystem] ä½¿ç”¨å‡ºç”Ÿç‚¹å¤æ´»ç©å®¶
# ä½†å®¢æˆ·ç«¯UIæ²¡æœ‰æ˜¾ç¤ºå€’è®¡æ—¶
```

**æ ¹æœ¬åŸå› **:
æœåŠ¡ç«¯åœ¨ `_update_respawn_system()` æ–¹æ³•ä¸­åªæ£€æŸ¥å¤æ´»æ—¶é—´å¹¶æ‰§è¡Œå¤æ´»ï¼Œä½†**æ²¡æœ‰å‘å®¢æˆ·ç«¯å‘é€å¤æ´»å€’è®¡æ—¶çš„UIæç¤º**ã€‚

**æŠ€æœ¯åŸå› **:
1. `BedWarsGameSystem._update_respawn_system()` æ–¹æ³•åªè´Ÿè´£æ£€æµ‹å¤æ´»æ—¶é—´å¹¶è°ƒç”¨å¤æ´»é€»è¾‘
2. è€é¡¹ç›®ä½¿ç”¨ `send_action_bar()` æ¯å¸§æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œæ–°é¡¹ç›®ç¼ºå°‘è¿™éƒ¨åˆ†å®ç°
3. å°è¯•ä½¿ç”¨ActionBarä¼šä¸åº•éƒ¨çš„ `stack_msg_bottom` ç³»ç»Ÿï¼ˆæ˜¾ç¤ºæ¸¸æˆé˜¶æ®µã€å‡»æ€æ•°ã€åºŠç ´åæ•°ï¼‰å‘ç”Ÿé‡å 

**è§£å†³æ–¹æ¡ˆ**:

ä½¿ç”¨**åº•éƒ¨å †å æ¶ˆæ¯ç³»ç»Ÿ(`stack_msg_bottom`)**æ˜¾ç¤ºå¤æ´»å€’è®¡æ—¶ï¼Œè€Œä¸æ˜¯ActionBarï¼š

```python
# åœ¨ BedWarsGameSystem._update_respawn_system() ä¸­æ·»åŠ 
def _update_respawn_system(self):
    """æ›´æ–°å¤æ´»ç³»ç»Ÿ"""
    if not self.respawning:
        return

    current_time = time.time()
    respawned_players = []

    for player_id, respawn_time in self.respawning.items():
        if current_time >= respawn_time:
            self._respawn_player(player_id)
            respawned_players.append(player_id)

            # âœ… æ¸…é™¤å¤æ´»å€’è®¡æ—¶æ¶ˆæ¯
            if self.room_system:
                self.room_system.clear_stack_msg_bottom(
                    key='respawn_countdown',
                    player_id=player_id
                )
        else:
            # âœ… æ˜¾ç¤ºå¤æ´»å€’è®¡æ—¶ï¼ˆä½¿ç”¨åº•éƒ¨å †å æ¶ˆæ¯ï¼‰
            remaining_seconds = int(respawn_time - current_time)
            respawn_msg = u"\xa7l\xa7cä½ æ­»äº†ï¼\xa7r \xa77ä½ å°†åœ¨ \xa7e{}\xa77 ç§’åé‡ç”Ÿ".format(remaining_seconds)

            if self.room_system:
                self.room_system.update_stack_msg_bottom(
                    key='respawn_countdown',
                    value=respawn_msg,
                    player_id=player_id  # åªå‘é€ç»™æ­£åœ¨å¤æ´»çš„ç©å®¶
                )

    for player_id in respawned_players:
        self.respawning.pop(player_id, None)
```

**å…³é”®ä¼˜åŠ¿**:
1. ä½¿ç”¨ `stack_msg_bottom` ç³»ç»Ÿä¸æ¸¸æˆå…¶ä»–åº•éƒ¨ä¿¡æ¯ç»Ÿä¸€æ˜¾ç¤ºï¼Œä¸ä¼šé‡å 
2. åº•éƒ¨å †å æ¶ˆæ¯ä¼šè‡ªåŠ¨å‚ç›´æ’åˆ—å¤šæ¡æ¶ˆæ¯
3. åªå‘é€ç»™æ­£åœ¨å¤æ´»çš„ç©å®¶ï¼ˆé€šè¿‡ `player_id` å‚æ•°ï¼‰
4. å¤æ´»å®Œæˆåè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯

**ç›¸å…³ä»£ç ä½ç½®**:
- [BedWarsGameSystem.py:1009-1045] - `_update_respawn_system()` æ–¹æ³•
- [GamingStateSystem.py:820-836] - `update_stack_msg_bottom()` æ–¹æ³•
- [è€é¡¹ç›®å‚è€ƒ] `NetEaseMapECBedWars_å¤‡ä»½/.../BedWarsRunningState.py:1085-1089` - åŸå§‹å®ç°

**ç›¸å…³æ–‡æ¡£**:
- [å¼€å‘è§„èŒƒ.md](./å¼€å‘è§„èŒƒ.md) - æœåŠ¡ç«¯é€šè¿‡å‘½ä»¤ç»„ä»¶ä¸å®¢æˆ·ç«¯é€šä¿¡
- [å®¢æˆ·ç«¯ç³»ç»Ÿ.md](./systems/å®¢æˆ·ç«¯ç³»ç»Ÿ.md) - HUDç³»ç»Ÿæ¶æ„
- [UIç³»ç»Ÿ.md](./systems/UIç³»ç»Ÿ.md) - åº•éƒ¨å †å æ¶ˆæ¯ç³»ç»Ÿ

**å†å²ä¿®å¤**: 2025-11-06

---

### é—®é¢˜7: é¢„è®¾å®ä½“åˆ›å»ºåˆ°é”™è¯¯ç»´åº¦å¯¼è‡´ä¸å¯è§

**ç—‡çŠ¶**:
- æ—¥å¿—æ˜¾ç¤ºé¢„è®¾å®ä½“åˆ›å»ºæˆåŠŸ
- ä½†ç©å®¶åœ¨æ¸¸æˆåœ°å›¾ä¸Šçœ‹ä¸åˆ°å®ä½“
- äº¤äº’æ— å“åº”

**å…¸å‹é”™è¯¯ä¿¡æ¯**:
```
[ShopPreset] å‡†å¤‡å¼‚æ­¥åˆ›å»ºNPC: entity=ecbedwars:shop, pos=[...], dimension=0
[INFO] [EntityPresetBase] å®ä½“åˆ›å»ºæˆåŠŸ: entity_id=...
[ShopPreset] NPCåˆ›å»ºæˆåŠŸ: id=...
# ä½†ç©å®¶åœ¨ç»´åº¦20001æ¸¸æˆï¼Œå®ä½“å´åœ¨ç»´åº¦0
```

**æ ¹æœ¬åŸå› **:
é¢„è®¾ä»é…ç½®ä¸­è¯»å–`dimension_id`å­—æ®µï¼Œä½†é…ç½®ä¸­æ²¡æœ‰è¯¥å­—æ®µï¼Œå¯¼è‡´ä½¿ç”¨é»˜è®¤å€¼0(å¤§å…ç»´åº¦)ï¼Œè€Œæ¸¸æˆå®é™…åœ¨å…¶ä»–ç»´åº¦(å¦‚20001)è¿›è¡Œã€‚

**æŠ€æœ¯åŸå› **:
1. é…ç½®æ–‡ä»¶ä¸­é¢„è®¾æ²¡æœ‰`dimension_id`å­—æ®µ
2. ä»£ç ä½¿ç”¨`instance.get_config("dimension_id", 0)`è·å–ç»´åº¦ï¼Œæ€»æ˜¯è¿”å›é»˜è®¤å€¼0
3. å®ä½“è¢«åˆ›å»ºåˆ°ç»´åº¦0ï¼Œä½†ç©å®¶åœ¨æ¸¸æˆç»´åº¦(20001)ï¼Œå¯¼è‡´ä¸å¯è§

**è§£å†³æ–¹æ¡ˆ**:

1. **ä»RoomManagementSystemè·å–å½“å‰æ¸¸æˆç»´åº¦**ï¼ˆæ¨èï¼‰:
```python
# âœ… æ­£ç¡® - ä»RoomManagementSystemè·å–å½“å‰æ¸¸æˆç»´åº¦
import mod.server.extraServerApi as serverApi
room_system = serverApi.GetSystem(MOD_NAME, "RoomManagementSystem")

if room_system and hasattr(room_system, 'current_dimension') and room_system.current_dimension is not None:
    dimension = room_system.current_dimension
    print("[é¢„è®¾å] ä»RoomManagementSystemè·å–ç»´åº¦: {}".format(dimension))
else:
    # å¤‡ç”¨æ–¹æ¡ˆï¼šä»é…ç½®è·å–
    dimension = instance.get_config("dimension_id", 0)
    print("[WARN] [é¢„è®¾å] RoomManagementSystemä¸å¯ç”¨,ä½¿ç”¨é»˜è®¤ç»´åº¦: {}".format(dimension))
```

2. **æˆ–è€…åœ¨é…ç½®ä¸­æ˜¾å¼æ·»åŠ `dimension_id`å­—æ®µ**:
```python
{
    "type": "bedwars:shop",
    "id": "...",
    "config": {
        "pos": [100, 64, 100],
        "dimension_id": 20001,  # æ˜¾å¼æŒ‡å®šç»´åº¦
        # ...
    }
}
```

**ç›¸å…³ä»£ç ä½ç½®**:
- [ShopPresetDefServer.py:282-295](D:\EcWork\NetEaseMapECBedWars\behavior_packs\behavior_pack_TSK85dvb\Script_NeteaseMod\presets\server\ShopPresetDefServer.py#L282-L295) - æ­£ç¡®çš„ç»´åº¦è·å–å®ç°
- [BedPresetDefServer.py:1005-1024](D:\EcWork\NetEaseMapECBedWars\behavior_packs\behavior_pack_TSK85dvb\Script_NeteaseMod\presets\server\BedPresetDefServer.py#L1005-L1024) - å‚è€ƒå®ç°

**ç›¸å…³æ–‡æ¡£**:
- [å¼€å‘è§„èŒƒ.md - ç½‘æ˜“å¼•æ“é™åˆ¶](./å¼€å‘è§„èŒƒ.md#ç½‘æ˜“å¼•æ“é™åˆ¶) - ç»´åº¦ç®¡ç†è§„èŒƒ
- [å•†äººé¢„è®¾.md](./presets/03-å•†äººé¢„è®¾.md) - å•†åº—é¢„è®¾æ–‡æ¡£

**å†å²ä¿®å¤**: 2025-11-05

**å…³é”®è¯Šæ–­æ–¹æ³•**:
1. æ£€æŸ¥æ—¥å¿—ä¸­å®ä½“åˆ›å»ºæ—¶çš„`dimension`å‚æ•°
2. æ£€æŸ¥æ—¥å¿—ä¸­ç©å®¶çš„å½“å‰ç»´åº¦ï¼ˆ`DimensionChangeFinishServerEvent`ï¼‰
3. å¯¹æ¯”ä¸¤è€…æ˜¯å¦ä¸€è‡´

---

### é—®é¢˜3ï¼šçŠ¶æ€æœºä¸åˆ‡æ¢çŠ¶æ€

**ç—‡çŠ¶**ï¼šæ¸¸æˆå¡åœ¨æŸä¸ªçŠ¶æ€ï¼Œæ— æ³•è¿›å…¥ä¸‹ä¸€çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥çŠ¶æ€çš„`on_enter()`æ˜¯å¦è°ƒç”¨äº†`switch_to_sub_state()`
2. éªŒè¯çŠ¶æ€è½¬æ¢æ¡ä»¶æ˜¯å¦æ»¡è¶³
3. æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆçŠ¶æ€æœºä¼šè‡ªåŠ¨æ‰“å°çŠ¶æ€åˆ‡æ¢ä¿¡æ¯ï¼‰
4. æ£€æŸ¥`TimedGamingState`çš„è¶…æ—¶æ—¶é—´è®¾ç½®

---

### é—®é¢˜4ï¼šé…ç½®æ–‡ä»¶è¯»å–å¤±è´¥

**ç—‡çŠ¶**ï¼šJSONé…ç½®æ— æ³•åŠ è½½ï¼ŒæŠ¥è¯­æ³•é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ä½¿ç”¨JSONéªŒè¯å·¥å…·æ£€æŸ¥æ ¼å¼
2. æ³¨æ„JSONè¯­æ³•ï¼šä¸æ”¯æŒæœ«å°¾é€—å·ï¼Œå­—ç¬¦ä¸²å¿…é¡»ç”¨åŒå¼•å·ï¼Œä¸æ”¯æŒæ³¨é‡Š
3. é…ç½®æ–‡ä»¶è·¯å¾„ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„

---

### é—®é¢˜5ï¼šå®¢æˆ·ç«¯äº‹ä»¶æ— æ³•æ¥æ”¶

**ç—‡çŠ¶**ï¼šæœåŠ¡ç«¯å‘é€çš„äº‹ä»¶å®¢æˆ·ç«¯æ”¶ä¸åˆ°

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥äº‹ä»¶åç§°åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ˜¯å¦ä¸€è‡´
2. éªŒè¯å®¢æˆ·ç«¯ç³»ç»Ÿæ˜¯å¦åœ¨`modConfig.py`ä¸­æ³¨å†Œ
3. ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„å‘é€æ–¹æ³•ï¼š
   - å•ä¸ªç©å®¶ï¼š`self.NotifyToClient(player_id, event_name, data)`
   - æ‰€æœ‰ç©å®¶ï¼š`self.BroadcastToAllClient(event_name, data)`

---

### é—®é¢˜6ï¼šTypeError: 'module' object is not callable

**ç—‡çŠ¶**ï¼šå¯åŠ¨æ—¶æŠ¥é”™`TypeError: 'module' object is not callable`

**åŸå› **ï¼šæ¨¡å—å¯¼å…¥æ–¹å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼šâš ï¸ **ä½¿ç”¨`from ... import ...`è€Œä¸æ˜¯`import module`**

è¯¦è§ [å¼€å‘è§„èŒƒ - æ¨¡å—å¯¼å…¥è§„èŒƒ](./å¼€å‘è§„èŒƒ.md#æ¨¡å—å¯¼å…¥è§„èŒƒ-critical)

[â¬†ï¸ è¿”å›ç›®å½•](#ç›®å½•)

---

## è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨print()è¾“å‡ºæ—¥å¿—

```python
# æ¨èçš„æ—¥å¿—æ ¼å¼
print("[INFO] [ç³»ç»Ÿå] æ¶ˆæ¯å†…å®¹")
print("[ERROR] [ç³»ç»Ÿå] é”™è¯¯ä¿¡æ¯")
print("[DEBUG] [ç³»ç»Ÿå] è°ƒè¯•ä¿¡æ¯")
```

### 2. æ—¥å¿—è¾“å‡ºä½ç½®

- **æ¸¸æˆæ—¥å¿—**ï¼šç½‘æ˜“MCå®¢æˆ·ç«¯çš„æ—¥å¿—ç›®å½•
- **æ§åˆ¶å°è¾“å‡º**ï¼šæ¸¸æˆè¿è¡Œæ—¶çš„æ§åˆ¶å°çª—å£

### 3. çŠ¶æ€æœºè‡ªåŠ¨æ—¥å¿—

çŠ¶æ€æœºä¼šè‡ªåŠ¨æ‰“å°çŠ¶æ€åˆ‡æ¢ä¿¡æ¯ï¼Œæ–¹ä¾¿è¿½è¸ªçŠ¶æ€æµè½¬ã€‚

### 4. å¼‚å¸¸æ•è·

```python
try:
    # ä½ çš„ä»£ç 
    pass
except Exception as e:
    print("[ERROR] å‘ç”Ÿå¼‚å¸¸:", e)
    import traceback
    traceback.print_exc()
```

[â¬†ï¸ è¿”å›ç›®å½•](#ç›®å½•)

---

## ç½‘æ˜“å¼•æ“é™åˆ¶

### 1. Pythonç‰ˆæœ¬é™åˆ¶
- âœ… å¿…é¡»å…¼å®¹Python 2.7
- âŒ ä¸èƒ½ä½¿ç”¨Python 3ä¸“æœ‰ç‰¹æ€§

### 2. å®ä½“æ ‡è¯†ç¬¦é™åˆ¶
- å®ä½“ç±»å‹åç§°å»ºè®®ä¸è¶…è¿‡32å­—ç¬¦
- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿

### 3. ç»´åº¦ç®¡ç†é™åˆ¶
- ç»´åº¦IDå¿…é¡»æ˜¯æ•´æ•°
- æ¨èä½¿ç”¨10000ä»¥ä¸Šé¿å…å†²çª

### 4. äº‹ä»¶ç³»ç»Ÿé™åˆ¶
- äº‹ä»¶æ•°æ®å¿…é¡»å¯åºåˆ—åŒ–ï¼ˆå­—å…¸ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²ã€æ•°å­—ï¼‰
- ä¸èƒ½ä¼ é€’å¯¹è±¡å®ä¾‹

### 5. ç»„ä»¶é™åˆ¶
- æŸäº›ç»„ä»¶åœ¨ç‰¹å®šç»´åº¦æˆ–æ¸¸æˆæ¨¡å¼ä¸‹å¯èƒ½ä¸å¯ç”¨
- å®¢æˆ·ç«¯ç»„ä»¶ä¸èƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼Œåä¹‹äº¦ç„¶

[â¬†ï¸ è¿”å›ç›®å½•](#ç›®å½•)

---

## ECPresetæ¡†æ¶ç›¸å…³é—®é¢˜

### context_idé”™è¯¯

ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„context_idï¼š

```python
# âœ… æ­£ç¡®
server_mgr = get_server_mgr("bedwars_room")

# âŒ é”™è¯¯
server_mgr = get_server_mgr("wrong_context")
```

### é¢„è®¾ç”Ÿå‘½å‘¨æœŸ

å…³é”®é’©å­æ–¹æ³•ï¼š
- `on_init()` - é¢„è®¾å®ä¾‹åˆ›å»ºæ—¶
- `on_start()` - é¢„è®¾å¯åŠ¨æ—¶
- `on_tick()` - æ¯Tickè°ƒç”¨ï¼ˆéœ€æ˜¾å¼å¯ç”¨ï¼‰
- `on_stop()` - é¢„è®¾åœæ­¢æ—¶
- `on_destroy()` - é¢„è®¾é”€æ¯æ—¶

[â¬†ï¸ è¿”å›ç›®å½•](#ç›®å½•)

---

### é—®é¢˜16: åºŠç ´ååæ²¡æœ‰å‘å…¨ä½“ç©å®¶å‘é€Titleé€šçŸ¥å’ŒéŸ³æ•ˆ

**ç—‡çŠ¶**:
- å¯¹å±€å†…ç©å®¶ç ´åå…¶ä»–é˜Ÿä¼åºŠåï¼Œçœ‹ä¸åˆ°Titleé€šçŸ¥ï¼ˆå¦‚"Â» Â§cçº¢Â§fçš„åºŠ Â«"ï¼‰
- å¬ä¸åˆ°éŸ³æ•ˆï¼ˆè¢«ç ´åé˜Ÿä¼åº”è¯¥å¬åˆ°å‡‹çµæ­»äº¡éŸ³æ•ˆï¼Œå…¶ä»–é˜Ÿä¼åº”è¯¥å¬åˆ°æœ«å½±é¾™å’†å“®éŸ³æ•ˆï¼‰
- èŠå¤©æ¶ˆæ¯æ­£å¸¸æ˜¾ç¤º

**å…¸å‹æ—¥å¿—ä¿¡æ¯**:
```
[INFO] [GamingStateSystem] é˜Ÿä¼BLUEçš„åºŠå·²è¢«ç ´å by -4294967295ï¼Œå·²å¹¿æ’­PresetBedDestroyedäº‹ä»¶
[INFO] [åºŠé¢„è®¾] æ’­æ”¾ç ´ååºŠç‰¹æ•ˆå’Œæ¶ˆæ¯å®Œæˆ: attacker=-4294967295, team=BLUE
# ä½†æ²¡æœ‰Titleå’ŒéŸ³æ•ˆç›¸å…³æ—¥å¿—
```

**æ ¹æœ¬åŸå› **:
1. **Titleé€šçŸ¥ç¼ºå¤±**: `BedWarsGameSystem.on_bed_destroyed()` æ–¹æ³•åªå¹¿æ’­äº†èŠå¤©æ¶ˆæ¯ï¼Œæ²¡æœ‰å‘é€Titleé€šçŸ¥
2. **éŸ³æ•ˆæ’­æ”¾é”™è¯¯**: ä½¿ç”¨äº†é”™è¯¯çš„éŸ³æ•ˆæ’­æ”¾æ–¹å¼ `NotifyToClient(player_id, 'S2CPlaySoundEvent', {...})`ï¼Œè¿™æ˜¯è‡ªå®šä¹‰äº‹ä»¶éœ€è¦å®¢æˆ·ç«¯ç›‘å¬å™¨

**æŠ€æœ¯åŸå› **:
1. è™½ç„¶ `BedWarsRunningState._on_bed_destroyed()` æœ‰å®Œæ•´çš„Titleå’ŒéŸ³æ•ˆé€»è¾‘ï¼Œä½†å®ƒé€šè¿‡ `PresetBedDestroyed` äº‹ä»¶è§¦å‘ï¼Œå¯èƒ½äº‹ä»¶ç›‘å¬å™¨æœªæ­£ç¡®æ³¨å†Œ
2. éŸ³æ•ˆæ’­æ”¾æ¥å£éƒ½æ˜¯**å®¢æˆ·ç«¯æ¥å£**ï¼ˆå‚è€ƒSDKæ–‡æ¡£ `docs/mcdocs/1-ModAPI/æ¥å£/éŸ³æ•ˆ.md`ï¼‰ï¼Œä¸èƒ½ç›´æ¥ä»æœåŠ¡ç«¯è°ƒç”¨è‡ªå®šä¹‰äº‹ä»¶

**è§£å†³æ–¹æ¡ˆ**:

åœ¨ `BedWarsGameSystem.on_bed_destroyed()` ä¸­ç›´æ¥æ·»åŠ Titleé€šçŸ¥å’ŒéŸ³æ•ˆæ’­æ”¾åŠŸèƒ½ï¼š

```python
def on_bed_destroyed(self, team_id, destroyer_id, bed_pos=None):
    """åºŠè¢«ç ´åäº‹ä»¶å¤„ç†"""
    if team_id in self.destroyed_beds:
        return

    self.destroyed_beds.append(team_id)

    # âœ… [FIX] å‘æ‰€æœ‰ç©å®¶å‘é€Titleé€šçŸ¥
    self._send_bed_destroyed_title_notifications(team_id)

    # å¹¿æ’­æ¶ˆæ¯
    self._broadcast_bed_destroyed_message(team_id, destroyer_id)

    # æ’­æ”¾åºŠç ´åç‰¹æ•ˆ...

def _send_bed_destroyed_title_notifications(self, team_id):
    """å‘æ‰€æœ‰ç©å®¶å‘é€åºŠç ´åTitleé€šçŸ¥"""
    from Script_NeteaseMod.systems.team.TeamType import team_types, get_team_color_name

    team_color_name = get_team_color_name(team_id)
    player_ids = serverApi.GetPlayerList()

    for player_id in player_ids:
        player_team = self.team_module.get_player_team(player_id)
        player_obj = self.get_better_player_obj(player_id)

        if player_team == team_id:
            # === è¢«ç ´åé˜Ÿä¼çš„ç©å®¶ ===
            # å‘é€çº¢è‰²Titleè­¦å‘Š
            player_obj.send_title(
                self.format_text(u"{red}åºŠå·²è¢«ç ´åï¼"),
                self.format_text(u"æ­»äº¡åæ— æ³•é‡ç”Ÿï¼")
            )

            # âœ… ä½¿ç”¨BetterPlayerObject.play_sound()æ’­æ”¾éŸ³æ•ˆ
            # é€šè¿‡/playsoundå‘½ä»¤å®ç°ï¼Œè€Œä¸æ˜¯NotifyToClient
            pos_comp = serverApi.GetEngineCompFactory().CreatePos(player_id)
            player_pos = pos_comp.GetPos()
            player_obj.play_sound('mob.wither.death', player_pos, 1.0, 1.0)
        else:
            # === å…¶ä»–é˜Ÿä¼çš„ç©å®¶ ===
            player_obj.send_title(
                self.format_text(u"Â» {bold}{team}{white}çš„åºŠ{reset}{white} Â«", team=team_color_name),
                self.format_text(u"{bold}å·²è¢«ç ´å")
            )

            # âœ… æ’­æ”¾æœ«å½±é¾™å’†å“®éŸ³æ•ˆ
            pos_comp = serverApi.GetEngineCompFactory().CreatePos(player_id)
            player_pos = pos_comp.GetPos()
            player_obj.play_sound('mob.enderdragon.growl', player_pos, 1.0, 1.0)
```

**å…³é”®è¦ç‚¹**:
1. **Titleé€šçŸ¥**: ä½¿ç”¨ `BetterPlayerObject.send_title()` æ–¹æ³•
2. **éŸ³æ•ˆæ’­æ”¾**: ä½¿ç”¨ `BetterPlayerObject.play_sound()` æ–¹æ³•ï¼Œåº•å±‚é€šè¿‡ `/playsound` å‘½ä»¤å®ç°
3. **åŒºåˆ†é˜Ÿä¼**: è¢«ç ´åé˜Ÿä¼çœ‹åˆ°çº¢è‰²è­¦å‘Šï¼Œå…¶ä»–é˜Ÿä¼çœ‹åˆ°é€šçŸ¥
4. **åŒé‡éŸ³æ•ˆ**: å‡‹çµæ­»äº¡éŸ³æ•ˆ vs æœ«å½±é¾™å’†å“®éŸ³æ•ˆ

**ç›¸å…³ä»£ç ä½ç½®**:
- ä¿®å¤ä½ç½®: `systems/BedWarsGameSystem.py:338-490`
- å‚è€ƒå®ç°: `systems/bedwars_states/BedWarsRunningState.py:806-869`
- éŸ³æ•ˆæ’­æ”¾: `systems/util/BetterPlayerObject.py:127-154`

**ç›¸å…³æ–‡æ¡£**:
- SDKæ–‡æ¡£: `netease-modsdk-wiki/docs/mcdocs/1-ModAPI/æ¥å£/éŸ³æ•ˆ.md`
- å¼€å‘è§„èŒƒ: `markdown/å¼€å‘è§„èŒƒ.md` - åŒç«¯éš”ç¦»åŸåˆ™

**å†å²ä¿®å¤**: 2025-11-07

---

## æ€§èƒ½é—®é¢˜

### é—®é¢˜1ï¼šTickæ€§èƒ½ä½

**è§£å†³**ï¼šä½¿ç”¨è®¡æ•°å™¨é™ä½é¢‘ç‡

```python
def on_tick(self):
    self.tick_counter += 1
    if self.tick_counter % 20 == 0:  # æ¯ç§’æ‰§è¡Œä¸€æ¬¡
        self.expensive_operation()
```

### é—®é¢˜2ï¼šå†…å­˜æ³„æ¼

**è§£å†³**ï¼š
- åœ¨çŠ¶æ€å†…ä½¿ç”¨`listen_event()`ä¼šè‡ªåŠ¨å–æ¶ˆ
- æ‰‹åŠ¨æ³¨å†Œçš„äº‹ä»¶è®°å¾—åœ¨`Destroy()`ä¸­å–æ¶ˆ

### é—®é¢˜3ï¼šå¤§é‡æ—¥å¿—å½±å“æ€§èƒ½

**è§£å†³**ï¼šä½¿ç”¨DEBUGå¼€å…³

```python
DEBUG = False  # ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºFalse

if DEBUG:
    print("[DEBUG] è°ƒè¯•ä¿¡æ¯")
```

---

## è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. ğŸ“– **æŸ¥çœ‹ç›¸å…³æ–‡æ¡£**ï¼š
   - [å¼€å‘è§„èŒƒ](./å¼€å‘è§„èŒƒ.md)
   - [å¼€å‘æŒ‡å—](./å¼€å‘æŒ‡å—.md)
   - [æ ¸å¿ƒæ¶æ„](../CLAUDE.md)

2. ğŸ” **æ£€æŸ¥è€é¡¹ç›®å®ç°**ï¼š
   - å‚è€ƒ [è¿ç§»æŒ‡å—](./è¿ç§»æŒ‡å—.md)

3. ğŸ“ **è®°å½•é—®é¢˜è¯¦æƒ…**å¹¶å¯»æ±‚å¸®åŠ©

[â¬†ï¸ è¿”å›ç›®å½•](#ç›®å½•)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### é‡è¦å‚è€ƒ
- [å¼€å‘è§„èŒƒ](./å¼€å‘è§„èŒƒ.md) - é¿å…å¸¸è§é”™è¯¯
- [å¼€å‘æŒ‡å—](./å¼€å‘æŒ‡å—.md) - æ­£ç¡®å¼€å‘æ–¹å¼
- [å¿«é€Ÿå¼€å§‹](./å¿«é€Ÿå¼€å§‹.md) - ç¯å¢ƒé…ç½®é—®é¢˜

### æ¶æ„æ–‡æ¡£
- [CLAUDE.md](../CLAUDE.md) - æ ¸å¿ƒæ¶æ„å‚è€ƒ
- [è¿ç§»æŒ‡å—](./è¿ç§»æŒ‡å—.md) - è€é¡¹ç›®å¯¹æ¯”

---

## é—®é¢˜æ¡ˆä¾‹ï¼šé¢„è®¾äº‹ä»¶é‡å¤è§¦å‘

### é—®é¢˜7ï¼šé¢„è®¾æ”¶åˆ°é‡å¤çš„äº‹ä»¶é€šçŸ¥

**ç—‡çŠ¶**ï¼š
- é¢„è®¾çš„äº‹ä»¶å›è°ƒè¢«è°ƒç”¨å¤šæ¬¡ï¼ˆå¦‚26æ¬¡ï¼‰
- é€ æˆé‡å¤åˆ›å»ºUIå…ƒç´ ã€é‡å¤æ’­æ”¾éŸ³æ•ˆç­‰é—®é¢˜
- æ—¥å¿—æ˜¾ç¤ºåŒä¸€äº‹ä»¶è¢«å¤šæ¬¡å¤„ç†

**æ¡ˆä¾‹**ï¼šåºŠé¢„è®¾åœ¨æ¸¸æˆå¼€å§‹æ—¶åˆ›å»º26ä¸ªé‡å¤çš„æµ®åŠ¨æ–‡å­—é¢æ¿

**æ ¹æœ¬åŸå› **ï¼š
é”™è¯¯åœ°éå†æ‰€æœ‰é¢„è®¾å®ä¾‹æ¥å‘å¸ƒäº‹ä»¶ï¼Œå¯¼è‡´äº‹ä»¶è¢«å‘å¸ƒNæ¬¡ï¼ˆN=é¢„è®¾æ•°é‡ï¼‰

```python
# âŒ é”™è¯¯çš„å®ç°
for preset_instance in all_presets.values():
    preset_instance.publish_event(event_name, event_data)  # æ¯ä¸ªé¢„è®¾éƒ½å‘å¸ƒ1æ¬¡
# ç»“æœï¼šäº‹ä»¶è¢«å‘å¸ƒNæ¬¡ï¼Œæ¯ä¸ªè®¢é˜…è€…éƒ½æ”¶åˆ°Næ¬¡é€šçŸ¥
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œç›´æ¥å‘ EventBus å‘å¸ƒä¸€æ¬¡äº‹ä»¶ï¼š

```python
# âœ… æ­£ç¡®çš„å®ç°
preset_mgr.event_bus.publish(event_name, event_data)  # åªå‘å¸ƒ1æ¬¡
# ç»“æœï¼šäº‹ä»¶è¢«å‘å¸ƒ1æ¬¡ï¼ŒEventBusè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
```

**æŠ€æœ¯ç»†èŠ‚**ï¼š
1. `preset_instance.publish_event()` å†…éƒ¨ä¼šè°ƒç”¨ `event_bus.publish()`
2. å¦‚æœéå†Nä¸ªé¢„è®¾è°ƒç”¨ `publish_event()`ï¼Œäº‹ä»¶ä¼šè¢«å‘å¸ƒNæ¬¡
3. EventBus ç»´æŠ¤è®¢é˜…è€…åˆ—è¡¨ï¼Œæ¯æ¬¡å‘å¸ƒéƒ½ä¼šé€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
4. æ­£ç¡®åšæ³•æ˜¯ç›´æ¥è°ƒç”¨ `event_bus.publish()` ä¸€æ¬¡

**ç›¸å…³ä»£ç ä½ç½®**ï¼š
- `systems/GamingStateSystem.py:778-782` - broadcast_preset_event å®ç°
- `presets/server/BedPresetDefServer.py:109` - äº‹ä»¶è®¢é˜…
- `presets/server/BedPresetDefServer.py:291-320` - äº‹ä»¶å¤„ç†

**å†å²ä¿®å¤**ï¼š2025-11-04

---

### é—®é¢˜8ï¼šæ¸¸æˆç»“æŸåˆ¤å®šæ— æ³•è§¦å‘

**ç—‡çŠ¶**ï¼š
- æ¸¸æˆä¸­åªå‰©ä¸€ä¸ªé˜Ÿä¼æˆ–æ‰€æœ‰ç©å®¶æ­»äº¡ï¼Œä½†æ¸¸æˆæ°¸è¿œä¸ä¼šç»“æŸ
- ç©å®¶ä¸ä¼šæ”¶åˆ°æ¸¸æˆç»“æŸçš„titleé€šçŸ¥
- æ¸¸æˆçŠ¶æ€å¡åœ¨runningçŠ¶æ€ï¼Œæ— æ³•åˆ‡æ¢åˆ°endingçŠ¶æ€

**å…¸å‹æµ‹è¯•åœºæ™¯**ï¼š
- 2é˜Ÿæ¨¡å¼ï¼Œè“é˜Ÿ0äººï¼ˆç©ºé˜Ÿï¼‰ï¼Œçº¢é˜Ÿ1äºº
- çº¢é˜Ÿç©å®¶æ‹†æ‰è“é˜ŸåºŠåè·³è™šç©ºæ­»äº¡
- é¢„æœŸï¼šçº¢é˜Ÿè·èƒœï¼Œæ˜¾ç¤ºèƒœåˆ©title
- å®é™…ï¼šæ¸¸æˆç»§ç»­è¿è¡Œï¼Œæ²¡æœ‰ä»»ä½•ç»“æŸåˆ¤å®š

**æ ¹æœ¬åŸå› **ï¼š

æ–°é¡¹ç›®ç¼ºå°‘äº†è€é¡¹ç›®ä¸­çš„ä¸¤ä¸ªå…³é”®é€»è¾‘ï¼š

1. **ç¼ºå°‘ç©å®¶æ­»äº¡åçš„æ¸¸æˆç»“æŸæ£€æŸ¥**
   - è€é¡¹ç›®ï¼šæ¯æ¬¡ç©å®¶æ­»äº¡åéƒ½è°ƒç”¨`check_win()`æ£€æŸ¥æ¸¸æˆæ˜¯å¦åº”è¯¥ç»“æŸ
   - æ–°é¡¹ç›®ï¼šåªåœ¨æ•´ä¸ªé˜Ÿä¼æ·˜æ±°æ—¶æ‰æ£€æŸ¥ï¼Œå¯¼è‡´å¾ˆå¤šæƒ…å†µä¸‹æ— æ³•è§¦å‘

2. **æ·˜æ±°ç©å®¶æ—¶æœªä»é˜Ÿä¼ä¸­ç§»é™¤**
   - è€é¡¹ç›®ï¼šç»ˆç»“å‡»æ€(final_kill)æ—¶è°ƒç”¨`remove_player_team()`å°†ç©å®¶ä»`team_to_player`ç§»é™¤
   - æ–°é¡¹ç›®ï¼šåªæ ‡è®°ä¸ºeliminatedï¼Œä½†ç©å®¶ä»åœ¨é˜Ÿä¼åˆ—è¡¨ä¸­
   - å¯¼è‡´`_get_remaining_teams()`æ— æ³•æ­£ç¡®åˆ¤æ–­é˜Ÿä¼æ˜¯å¦ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### 1. åœ¨`on_player_die()`æœ«å°¾æ·»åŠ æ¸¸æˆç»“æŸæ£€æŸ¥

```python
def on_player_die(self, player_id, attacker_id=None, damage_cause=None):
    # ... æ­»äº¡å¤„ç†é€»è¾‘ ...
    if is_final_kill:
        self._eliminate_player(player_id)
    else:
        self._start_respawn(player_id)

    # [FIX] æ¯æ¬¡ç©å®¶æ­»äº¡åæ£€æŸ¥æ¸¸æˆæ˜¯å¦åº”è¯¥ç»“æŸ
    # å‚è€ƒè€é¡¹ç›® BedWarsRunningState.on_player_die() line 869
    self._check_game_end_after_death()
```

#### 2. åœ¨`_eliminate_player()`ä¸­ç§»é™¤é˜Ÿä¼æˆå‘˜

```python
def _eliminate_player(self, player_id):
    if player_id in self.eliminated_players:
        return

    self.eliminated_players.append(player_id)

    # [FIX] ä»é˜Ÿä¼ä¸­ç§»é™¤ç©å®¶ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
    # å‚è€ƒè€é¡¹ç›® BedWarsRunningState.on_player_die() line 784
    team_id = self.team_module.get_player_team(player_id) if self.team_module else None
    if self.team_module:
        self.team_module.remove_player_from_team(player_id)

    # åˆ‡æ¢ä¸ºæ—è§‚æ¨¡å¼
    comp = self.comp_factory.CreatePlayer(player_id)
    comp.SetPlayerGameType(serverApi.GetMinecraftEnum().GameType.SPECTATOR)

    # æ£€æŸ¥é˜Ÿä¼æ˜¯å¦å…¨ç­
    if team_id and self._is_team_eliminated(team_id):
        self._on_team_eliminated(team_id)
```

#### 3. å®ç°`_check_game_end_after_death()`æ–¹æ³•

```python
def _check_game_end_after_death(self):
    """
    ç©å®¶æ­»äº¡åæ£€æŸ¥æ¸¸æˆæ˜¯å¦åº”è¯¥ç»“æŸ
    å‚è€ƒ: è€é¡¹ç›® BedWarsRunningState.on_player_die() line 869
    """
    # é˜²æ­¢é‡å¤è§¦å‘
    if hasattr(self, '_winning_team') and self._winning_team is not None:
        return
    if hasattr(self, '_game_ended') and self._game_ended:
        return

    remaining_teams = self._get_remaining_teams()

    if len(remaining_teams) <= 1:
        # æ¸¸æˆç»“æŸ
        if len(remaining_teams) == 1:
            self._winning_team = remaining_teams[0]  # è·èƒœé˜Ÿä¼
        else:
            self._winning_team = None  # å¹³å±€
            self._game_ended = True

        # æ¸…ç©ºå¤æ´»é˜Ÿåˆ—
        self.respawning.clear()

        # åˆ‡æ¢åˆ°endingçŠ¶æ€
        if hasattr(self, 'root_state') and self.root_state:
            self.root_state.next_sub_state()
```

**æ¸¸æˆç»“æŸåˆ¤å®šè§„åˆ™**ï¼š

è€é¡¹ç›®çš„`check_win()`é€»è¾‘ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ï¼š
```python
# ç»Ÿè®¡éç©ºé˜Ÿä¼
not_empty_teams = []
for team, players in team_to_player.items():
    if len(players) > 0:
        not_empty_teams.append(team)

# å¦‚æœåªå‰©1ä¸ªæˆ–0ä¸ªé˜Ÿä¼ï¼Œæ¸¸æˆç»“æŸ
if len(not_empty_teams) <= 1:
    win_team = not_empty_teams[0] if len(not_empty_teams) == 1 else None
    # è®¾ç½®è·èƒœé˜Ÿä¼ï¼Œåˆ‡æ¢çŠ¶æ€
```

**å…³é”®ç†è§£**ï¼š
- æ¸¸æˆå¼€å§‹æ—¶çš„ç©ºé˜Ÿä¼ï¼ˆ0äººï¼‰ä¸ç®—æœ‰æ•ˆé˜Ÿä¼
- ç©å®¶åœ¨å¤æ´»é˜Ÿåˆ—ä¸­æ—¶ï¼Œä»ç®—åœ¨é˜Ÿä¼ä¸­ï¼ˆåºŠæœªç ´åï¼‰
- ç©å®¶ç»ˆç»“å‡»æ€åï¼Œå¿…é¡»ä»`team_to_player`ç§»é™¤ï¼Œå¦åˆ™é˜Ÿä¼ä»è¢«è®¤ä¸ºéç©º
- æ¯æ¬¡ç©å®¶æ­»äº¡åéƒ½è¦æ£€æŸ¥ï¼Œä¸èƒ½åªåœ¨é˜Ÿä¼å…¨ç­æ—¶æ£€æŸ¥

**ç›¸å…³ä»£ç ä½ç½®**ï¼š
- è€é¡¹ç›®ï¼š`Parts/ECBedWars/state/BedWarsRunningState.py:869` - check_win()è°ƒç”¨
- è€é¡¹ç›®ï¼š`Parts/ECBedWars/state/BedWarsRunningState.py:784` - remove_player_team()è°ƒç”¨
- è€é¡¹ç›®ï¼š`Parts/ECBedWars/state/BedWarsRunningState.py:1428-1441` - check_win()å®ç°
- æ–°é¡¹ç›®ï¼š`systems/BedWarsGameSystem.py:643-646` - æ¸¸æˆç»“æŸæ£€æŸ¥è°ƒç”¨
- æ–°é¡¹ç›®ï¼š`systems/BedWarsGameSystem.py:660-666` - ç§»é™¤é˜Ÿä¼æˆå‘˜
- æ–°é¡¹ç›®ï¼š`systems/BedWarsGameSystem.py:1038-1109` - `_check_game_end_after_death()`æ–¹æ³•

**å†å²ä¿®å¤**ï¼š2025-11-07

---

### é—®é¢˜9ï¼šæ¸¸æˆç»“æŸtitleæ˜¾ç¤ºä¸æ­£ç¡®

**ç—‡çŠ¶**ï¼š
- æ¸¸æˆç»“æŸåˆ¤å®šæ­£å¸¸ï¼ˆèƒ½æ­£ç¡®åˆ¤æ–­è·èƒœé˜Ÿä¼ï¼‰
- ä½†ç©å®¶æ”¶åˆ°çš„titleæç¤ºæ ¼å¼ä¸æ­£ç¡®ï¼Œä¸è€é¡¹ç›®ä¸ä¸€è‡´
- titleå†…å®¹è¿‡äºç®€å•ï¼Œç¼ºå°‘æ ·å¼å’ŒéŸ³æ•ˆ

**æ ¹æœ¬åŸå› **ï¼š

æ–°é¡¹ç›®çš„titleæ˜¾ç¤ºå®ç°ä¸è€é¡¹ç›®å®Œå…¨ä¸åŒï¼š

| å¯¹æ¯”é¡¹ | è€é¡¹ç›® | æ–°é¡¹ç›®(ä¿®å¤å‰) |
|--------|--------|----------------|
| **ä¸»æ ‡é¢˜** | `Â§fÂ§lÂ» Â§eæ¸¸æˆç»“æŸÂ§f Â«` | `XXXè·èƒœ!` |
| **å‰¯æ ‡é¢˜** | `Â§cçº¢é˜Ÿ Â§6è·å¾—äº†èƒœåˆ©` | `æ­å–œ!` |
| **titleé‡ç½®** | âœ… è°ƒç”¨`broadcast_title_reset()` | âŒ æ—  |
| **èƒœåˆ©éŸ³æ•ˆ** | âœ… æ’­æ”¾`sound.ec.win` | âŒ æ—  |
| **æ ¼å¼åŒ–** | ä½¿ç”¨`BetterPartUtil.format_text()` | ç®€å•å­—ç¬¦ä¸²æ‹¼æ¥ |

**è§£å†³æ–¹æ¡ˆ**ï¼š

åœ¨`BedWarsEndingState._display_victory()`ä¸­ä½¿ç”¨ä¸è€é¡¹ç›®ä¸€è‡´çš„æ ¼å¼ï¼š

```python
def _display_victory(self, winning_team):
    """
    æ˜¾ç¤ºèƒœåˆ©ä¿¡æ¯
    å‚è€ƒ: è€é¡¹ç›® BedWarsEndingState.on_enter() line 27-43
    """
    system = self.get_system()
    player_ids = serverApi.GetPlayerList()

    if winning_team:
        # æœ‰è·èƒœé˜Ÿä¼
        team_name = system.team_module.get_colored_team_name(winning_team)

        # ä¸»æ ‡é¢˜: "Â» æ¸¸æˆç»“æŸ Â«" (ç²—ä½“ç™½è‰²+é»„è‰²+ç™½è‰²)
        main_title = u"Â§fÂ§lÂ» Â§eæ¸¸æˆç»“æŸÂ§f Â«"
        # å‰¯æ ‡é¢˜: "XXXé˜Ÿ è·å¾—äº†èƒœåˆ©" (é˜Ÿä¼é¢œè‰² + é‡‘è‰²æ–‡å­—)
        sub_title = u"{} Â§6è·å¾—äº†èƒœåˆ©".format(team_name)

        chat_message = u"{} Â§6è·å¾—äº†èƒœåˆ©".format(team_name)
        system._broadcast_message(chat_message, 'YELLOW')
    else:
        # å¹³å±€
        main_title = u"Â§fÂ§lÂ» Â§eæ¸¸æˆç»“æŸÂ§f Â«"
        sub_title = u"å¹³å±€"
        system._broadcast_message(u"Â§eæ¸¸æˆç»“æŸ - å¹³å±€", 'YELLOW')

    # å‘æ‰€æœ‰ç©å®¶å‘é€Titleå’Œæ’­æ”¾éŸ³æ•ˆ
    for player_id in player_ids:
        try:
            player_obj = system.get_better_player_obj(player_id)

            # [FIX] å…ˆé‡ç½®ä¹‹å‰çš„title (å‚è€ƒè€é¡¹ç›®ç¬¬30è¡Œ)
            comp = serverApi.GetEngineCompFactory().CreateCommand(serverApi.GetLevelId())
            comp.SetCommand("title @s reset", player_id)

            # å‘é€title (ä½¿ç”¨ä¸è€é¡¹ç›®ä¸€è‡´çš„æ—¶é—´å‚æ•°)
            player_obj.send_title(main_title, sub_title, fadein=10, duration=70, fadeout=20)

            # [FIX] æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ (å‚è€ƒè€é¡¹ç›®ç¬¬44-45è¡Œ)
            player_pos = player_obj.GetPos()
            if player_pos:
                player_obj.play_sound("sound.ec.win", player_pos, 1.0, 1.0)
        except Exception as e:
            system.LogError("å‘é€Titleå¤±è´¥: {}".format(str(e)))
```

**Minecrafté¢œè‰²ä»£ç è¯´æ˜**ï¼š
- `Â§f` - ç™½è‰²
- `Â§e` - é»„è‰²
- `Â§6` - é‡‘è‰²
- `Â§c` - çº¢è‰²
- `Â§l` - ç²—ä½“
- `Â§r` - é‡ç½®æ ¼å¼

**ç›¸å…³ä»£ç ä½ç½®**ï¼š
- è€é¡¹ç›®ï¼š`Parts/ECBedWars/state/BedWarsEndingState.py:27-45` - titleæ˜¾ç¤ºå®ç°
- æ–°é¡¹ç›®ï¼š`systems/bedwars_states/BedWarsEndingState.py:78-151` - `_display_victory()`æ–¹æ³•

**å†å²ä¿®å¤**ï¼š2025-11-07

---

**[â¬†ï¸ è¿”å›é¡¶éƒ¨](#é—®é¢˜æ’æŸ¥æŒ‡å—)** | **[ğŸ  è¿”å›é¦–é¡µ](../README.md)**

---

_æœ€åæ›´æ–°: 2025-11-07 | æ–‡æ¡£ç‰ˆæœ¬: 2.3_
