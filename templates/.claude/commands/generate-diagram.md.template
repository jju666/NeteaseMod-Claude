# /generate-diagram - è‡ªåŠ¨ç”ŸæˆSystemæ¶æ„å›¾

## å‘½ä»¤è¯´æ˜

è‡ªåŠ¨åˆ†æé¡¹ç›®ä¸­çš„Systemä»£ç ï¼Œç”ŸæˆMermaidæ¶æ„å›¾ï¼Œå¸®åŠ©ç†è§£Systemä¹‹é—´çš„å…³ç³»å’Œæ•°æ®æµã€‚

## æ‰§è¡Œæµç¨‹

### ç¬¬1æ­¥ï¼šæ‰«æé¡¹ç›®System

ä½¿ç”¨Globå·¥å…·æœç´¢é¡¹ç›®ä¸­çš„æ‰€æœ‰Systemæ–‡ä»¶ï¼š

```python
# æ‰«ææœåŠ¡ç«¯System
Glob("behavior_packs/{{PROJECT_NAME}}/*/server/*ServerSystem.py")

# æ‰«æå®¢æˆ·ç«¯System
Glob("behavior_packs/{{PROJECT_NAME}}/*/client/*ClientSystem.py")
```

### ç¬¬2æ­¥ï¼šåˆ†æSystemä»£ç 

å¯¹æ¯ä¸ªSystemæ–‡ä»¶ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š

#### 2.1 åŸºç¡€ä¿¡æ¯

```python
# è¯»å–Systemæ–‡ä»¶å†…å®¹
class ShopServerSystem(ServerSystem):
    def __init__(self, namespace, systemName):
        ...

# æå–ä¿¡æ¯ï¼š
- Systemåç§°: ShopServerSystem
- Systemç±»å‹: ServerSystemï¼ˆæœåŠ¡ç«¯ï¼‰
- æ–‡ä»¶è·¯å¾„: behavior_packs/{{PROJECT_NAME}}/shop/server/ShopServerSystem.py
```

#### 2.2 Componentä¾èµ–

```python
# åˆ†æä»£ç ä¸­åˆ›å»ºçš„Component
self.extraDataComp = serverApi.GetEngineCompFactory().CreateExtraData(...)
self.itemComp = serverApi.GetEngineCompFactory().CreateItem(...)

# æå–ä¿¡æ¯ï¼š
- ä½¿ç”¨çš„Component: ExtraData, Item
```

#### 2.3 äº‹ä»¶ç›‘å¬

```python
# åˆ†æListenForEventè°ƒç”¨
self.ListenForEvent('ShopModNamespace', 'ShopModClientSystem',
                    'PurchaseRequestEvent', self, self.OnPurchaseRequest)

# æå–ä¿¡æ¯ï¼š
- ç›‘å¬çš„äº‹ä»¶: PurchaseRequestEvent
- æ¥æºSystem: ShopModClientSystem
```

#### 2.4 äº‹ä»¶é€šçŸ¥

```python
# åˆ†æNotifyToClient/NotifyToServerè°ƒç”¨
self.NotifyToClient(playerId, 'PurchaseResultEvent', {...})

# æå–ä¿¡æ¯ï¼š
- å‘é€çš„äº‹ä»¶: PurchaseResultEvent
- ç›®æ ‡: Clientï¼ˆå®¢æˆ·ç«¯ï¼‰
```

---

### ç¬¬3æ­¥ï¼šç”ŸæˆMermaidæ¶æ„å›¾

æ ¹æ®åˆ†æç»“æœï¼Œç”Ÿæˆä»¥ä¸‹ç±»å‹çš„æ¶æ„å›¾ï¼š

#### å›¾1ï¼šSystemæ€»è§ˆå›¾

```mermaid
graph TB
    subgraph "æœåŠ¡ç«¯System"
        ShopServerSystem[ShopServerSystem<br/>å•†åŸæœåŠ¡ç«¯]
        VIPServerSystem[VIPServerSystem<br/>VIPæœåŠ¡ç«¯]
        AchievementServerSystem[AchievementServerSystem<br/>æˆå°±æœåŠ¡ç«¯]
    end

    subgraph "å®¢æˆ·ç«¯System"
        ShopClientSystem[ShopClientSystem<br/>å•†åŸå®¢æˆ·ç«¯]
        VIPClientSystem[VIPClientSystem<br/>VIPå®¢æˆ·ç«¯]
        AchievementClientSystem[AchievementClientSystem<br/>æˆå°±å®¢æˆ·ç«¯]
    end

    ShopClientSystem -->|PurchaseRequest| ShopServerSystem
    ShopServerSystem -->|PurchaseResult| ShopClientSystem

    VIPClientSystem -->|QueryVIPStatus| VIPServerSystem
    VIPServerSystem -->|VIPStatusUpdate| VIPClientSystem

    AchievementServerSystem -->|AchievementUnlocked| AchievementClientSystem

    style ShopServerSystem fill:#ffe0b2
    style VIPServerSystem fill:#ffe0b2
    style AchievementServerSystem fill:#ffe0b2
    style ShopClientSystem fill:#e1f5ff
    style VIPClientSystem fill:#e1f5ff
    style AchievementClientSystem fill:#e1f5ff
```

---

#### å›¾2ï¼šå•ä¸ªSystemè¯¦ç»†æ¶æ„å›¾

**ç¤ºä¾‹ï¼šShopServerSystemè¯¦ç»†å›¾**

```mermaid
graph TD
    A[ShopServerSystem] --> B[ç›‘å¬äº‹ä»¶]
    A --> C[ä½¿ç”¨Component]
    A --> D[å‘é€äº‹ä»¶]

    B --> B1[PurchaseRequestEvent<br/>æ¥è‡ªShopClientSystem]
    B --> B2[PlayerJoinServerEvent<br/>æ¥è‡ªå¼•æ“]

    C --> C1[ExtraData<br/>å­˜å‚¨ç©å®¶æ•°æ®]
    C --> C2[Item<br/>å‘æ”¾é“å…·]
    C --> C3[Game<br/>è·å–æ¸¸æˆæ—¶é—´]

    D --> D1[PurchaseResultEvent<br/>å‘é€åˆ°ShopClientSystem]

    style A fill:#ff9800,color:#fff
    style B fill:#e1f5ff
    style C fill:#c8e6c9
    style D fill:#fff9c4
```

---

#### å›¾3ï¼šæ•°æ®æµå‘å›¾

**ç¤ºä¾‹ï¼šå•†åŸè´­ä¹°æµç¨‹**

```mermaid
sequenceDiagram
    participant Player as ç©å®¶
    participant Client as ShopClientSystem
    participant Server as ShopServerSystem
    participant ExtraData as ExtraDataç»„ä»¶
    participant Item as Itemç»„ä»¶

    Player->>Client: ç‚¹å‡»è´­ä¹°æŒ‰é’®
    Client->>Server: NotifyToServer(PurchaseRequestEvent)
    Server->>Server: éªŒè¯å•†å“ID
    Server->>ExtraData: GetExtraData(playerId, "shop_data")
    ExtraData-->>Server: è¿”å›ç©å®¶æ•°æ®
    Server->>Server: æ£€æŸ¥ä½™é¢
    alt ä½™é¢å……è¶³
        Server->>ExtraData: SetExtraData(æ–°ä½™é¢)
        Server->>Item: SpawnItemToPlayerInv(é“å…·)
        Item-->>Server: å‘æ”¾æˆåŠŸ
        Server->>Client: NotifyToClient(PurchaseResultEvent, success)
        Client->>Player: æ˜¾ç¤º"è´­ä¹°æˆåŠŸ"
    else ä½™é¢ä¸è¶³
        Server->>Client: NotifyToClient(PurchaseResultEvent, fail)
        Client->>Player: æ˜¾ç¤º"ä½™é¢ä¸è¶³"
    end
```

---

### ç¬¬4æ­¥ï¼šç”ŸæˆMarkdownæ–‡æ¡£

å°†ç”Ÿæˆçš„æ¶æ„å›¾ä¿å­˜åˆ°æ–‡æ¡£æ–‡ä»¶ï¼š

**æ–‡ä»¶è·¯å¾„**ï¼š`markdown/diagrams/architecture.md`

**æ–‡ä»¶å†…å®¹**ï¼š

```markdown
# Systemæ¶æ„å›¾

> ğŸ¤– **è‡ªåŠ¨ç”Ÿæˆäº**: {{CURRENT_DATE}}
> **é¡¹ç›®åç§°**: {{PROJECT_NAME}}

---

## 1. Systemæ€»è§ˆ

ä»¥ä¸‹æ˜¯é¡¹ç›®ä¸­æ‰€æœ‰Systemçš„æ€»è§ˆå›¾ï¼š

{æ’å…¥æ€»è§ˆMermaidå›¾}

---

## 2. æœåŠ¡ç«¯Systemè¯¦ç»†æ¶æ„

### 2.1 ShopServerSystemï¼ˆå•†åŸæœåŠ¡ç«¯ï¼‰

{æ’å…¥ShopServerSystemè¯¦ç»†å›¾}

**åŠŸèƒ½è¯´æ˜**ï¼š
- å¤„ç†å•†å“è´­ä¹°è¯·æ±‚
- éªŒè¯ç©å®¶ä½™é¢å’Œå•†å“åº“å­˜
- å‘æ”¾é“å…·å¹¶æ‰£é™¤è´§å¸

**å…³é”®äº‹ä»¶**ï¼š
- ç›‘å¬: `PurchaseRequestEvent`ï¼ˆæ¥è‡ªShopClientSystemï¼‰
- å‘é€: `PurchaseResultEvent`ï¼ˆå‘é€åˆ°ShopClientSystemï¼‰

**ä½¿ç”¨çš„Component**ï¼š
- `ExtraData`: å­˜å‚¨ç©å®¶ä½™é¢å’Œè´­ä¹°å†å²
- `Item`: å‘æ”¾é“å…·åˆ°ç©å®¶èƒŒåŒ…
- `Game`: è·å–æ¸¸æˆæ—¶é—´

---

### 2.2 VIPServerSystemï¼ˆVIPæœåŠ¡ç«¯ï¼‰

{æ’å…¥VIPServerSystemè¯¦ç»†å›¾}

...

---

## 3. å®¢æˆ·ç«¯Systemè¯¦ç»†æ¶æ„

...

---

## 4. æ•°æ®æµå‘å›¾

### 4.1 å•†åŸè´­ä¹°æµç¨‹

{æ’å…¥å•†åŸè´­ä¹°æµç¨‹åºåˆ—å›¾}

...
```

---

### ç¬¬5æ­¥ï¼šè¾“å‡ºç»“æœ

å‘ç”¨æˆ·è¾“å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š

```
âœ… Systemæ¶æ„å›¾å·²ç”Ÿæˆï¼

ğŸ“Š **ç»Ÿè®¡ä¿¡æ¯**ï¼š
- æœåŠ¡ç«¯System: 3ä¸ª
- å®¢æˆ·ç«¯System: 3ä¸ª
- ç›‘å¬çš„äº‹ä»¶: 8ä¸ª
- å‘é€çš„äº‹ä»¶: 6ä¸ª
- ä½¿ç”¨çš„Component: 10ä¸ª

ğŸ“ **ç”Ÿæˆæ–‡ä»¶**ï¼š
- markdown/diagrams/architecture.md

ğŸ’¡ **ä½¿ç”¨å»ºè®®**ï¼š
1. æŸ¥çœ‹æ€»è§ˆå›¾ï¼Œç†è§£Systemä¹‹é—´çš„å…³ç³»
2. æŸ¥çœ‹è¯¦ç»†å›¾ï¼Œäº†è§£æ¯ä¸ªSystemçš„èŒè´£
3. æŸ¥çœ‹æ•°æ®æµå‘å›¾ï¼Œç†è§£ä¸šåŠ¡æµç¨‹

ğŸ”— **ä¸‹ä¸€æ­¥**ï¼š
- ä½¿ç”¨ /validate-architecture éªŒè¯æ¶æ„è®¾è®¡
- ä½¿ç”¨ /enhance-docs ä¸ºSystemæ·»åŠ æ–‡æ¡£æ³¨é‡Š
```

---

## ä»£ç åˆ†ææŠ€å·§

### æŠ€å·§1ï¼šè¯†åˆ«Systemç±»å‹

```python
# é€šè¿‡ç»§æ‰¿å…³ç³»åˆ¤æ–­Systemç±»å‹
class ShopServerSystem(ServerSystem):  # æœåŠ¡ç«¯System
class ShopClientSystem(ClientSystem):  # å®¢æˆ·ç«¯System
```

### æŠ€å·§2ï¼šæå–äº‹ä»¶ä¾èµ–

```python
# æå–ListenForEventè°ƒç”¨
# æ¨¡å¼: self.ListenForEvent(namespace, systemName, eventName, ...)
import re

pattern = r"ListenForEvent\(['\"]([^'\"]+)['\"],\s*['\"]([^'\"]+)['\"],\s*['\"]([^'\"]+)['\"]"
matches = re.findall(pattern, systemCode)

for namespace, systemName, eventName in matches:
    print("ç›‘å¬äº‹ä»¶:", eventName, "æ¥è‡ª:", systemName)
```

### æŠ€å·§3ï¼šæå–Componentä½¿ç”¨

```python
# æå–CreateXxxè°ƒç”¨
# æ¨¡å¼: CreateExtraData(...), CreateItem(...), etc.
import re

pattern = r"Create([A-Z][a-zA-Z]+)\("
matches = re.findall(pattern, systemCode)

components = set(matches)
print("ä½¿ç”¨çš„Component:", components)
```

---

## ç¤ºä¾‹å¯¹è¯

### ç¤ºä¾‹1ï¼šç”Ÿæˆå®Œæ•´æ¶æ„å›¾

**ç”¨æˆ·**ï¼š
```
/generate-diagram
```

**AIè¾“å‡º**ï¼š

```
ğŸ” **æ‰«æé¡¹ç›®System**...

å‘ç°ä»¥ä¸‹Systemï¼š
- behavior_packs/MyMod/shop/server/ShopServerSystem.py
- behavior_packs/MyMod/shop/client/ShopClientSystem.py
- behavior_packs/MyMod/vip/server/VIPServerSystem.py
- behavior_packs/MyMod/vip/client/VIPClientSystem.py
- behavior_packs/MyMod/achievement/server/AchievementServerSystem.py
- behavior_packs/MyMod/achievement/client/AchievementClientSystem.py

ğŸ“Š **åˆ†æSystemä»£ç **...

âœ… ShopServerSystemåˆ†æå®Œæˆ
  - ç›‘å¬äº‹ä»¶: PurchaseRequestEvent, PlayerJoinServerEvent
  - å‘é€äº‹ä»¶: PurchaseResultEvent
  - ä½¿ç”¨Component: ExtraData, Item, Game

âœ… ShopClientSystemåˆ†æå®Œæˆ
  - ç›‘å¬äº‹ä»¶: PurchaseResultEvent
  - å‘é€äº‹ä»¶: PurchaseRequestEvent
  - ä½¿ç”¨Component: æ— 

âœ… VIPServerSystemåˆ†æå®Œæˆ
  ...

ğŸ¨ **ç”ŸæˆMermaidæ¶æ„å›¾**...

âœ… ç”ŸæˆSystemæ€»è§ˆå›¾
âœ… ç”ŸæˆShopServerSystemè¯¦ç»†å›¾
âœ… ç”ŸæˆShopClientSystemè¯¦ç»†å›¾
âœ… ç”ŸæˆVIPServerSystemè¯¦ç»†å›¾
âœ… ç”ŸæˆVIPClientSystemè¯¦ç»†å›¾
âœ… ç”ŸæˆAchievementServerSystemè¯¦ç»†å›¾
âœ… ç”ŸæˆAchievementClientSystemè¯¦ç»†å›¾
âœ… ç”Ÿæˆå•†åŸè´­ä¹°æµç¨‹åºåˆ—å›¾

ğŸ“ **ä¿å­˜åˆ°æ–‡ä»¶**: markdown/diagrams/architecture.md

---

âœ… **Systemæ¶æ„å›¾å·²ç”Ÿæˆï¼**

ğŸ“Š **ç»Ÿè®¡ä¿¡æ¯**ï¼š
- æœåŠ¡ç«¯System: 3ä¸ªï¼ˆShopServerSystem, VIPServerSystem, AchievementServerSystemï¼‰
- å®¢æˆ·ç«¯System: 3ä¸ªï¼ˆShopClientSystem, VIPClientSystem, AchievementClientSystemï¼‰
- ç›‘å¬çš„äº‹ä»¶: 8ä¸ª
- å‘é€çš„äº‹ä»¶: 6ä¸ª
- ä½¿ç”¨çš„Component: 10ä¸ªï¼ˆExtraData, Item, Game, Attr, Posç­‰ï¼‰

ğŸ“ **ç”Ÿæˆæ–‡ä»¶**ï¼š
- [markdown/diagrams/architecture.md](../../markdown/diagrams/architecture.md)

ğŸ’¡ **ä½¿ç”¨å»ºè®®**ï¼š
1. æŸ¥çœ‹æ€»è§ˆå›¾ï¼Œç†è§£Systemä¹‹é—´çš„å…³ç³»
2. æŸ¥çœ‹è¯¦ç»†å›¾ï¼Œäº†è§£æ¯ä¸ªSystemçš„èŒè´£
3. æŸ¥çœ‹æ•°æ®æµå‘å›¾ï¼Œç†è§£ä¸šåŠ¡æµç¨‹
4. å°†æ¶æ„å›¾åˆ†äº«ç»™å›¢é˜Ÿæˆå‘˜ï¼Œæå‡åä½œæ•ˆç‡

ğŸ”— **ä¸‹ä¸€æ­¥**ï¼š
- ä½¿ç”¨ /validate-architecture éªŒè¯æ¶æ„è®¾è®¡æ˜¯å¦ç¬¦åˆCRITICALè§„èŒƒ
- ä½¿ç”¨ /enhance-docs ä¸ºSystemæ·»åŠ è¯¦ç»†æ–‡æ¡£æ³¨é‡Š
- ä½¿ç”¨ /review-design è®©æˆ‘å®¡æŸ¥Systemçš„è®¾è®¡è´¨é‡
```

---

### ç¤ºä¾‹2ï¼šç”Ÿæˆç‰¹å®šSystemçš„æ¶æ„å›¾

**ç”¨æˆ·**ï¼š
```
/generate-diagram ShopServerSystem
```

**AIè¾“å‡º**ï¼š

```
ğŸ” **åˆ†æShopServerSystem**...

ğŸ“‚ æ–‡ä»¶è·¯å¾„: behavior_packs/MyMod/shop/server/ShopServerSystem.py

ğŸ“Š **åˆ†æç»“æœ**ï¼š

**ç›‘å¬çš„äº‹ä»¶**ï¼š
1. PurchaseRequestEventï¼ˆæ¥è‡ªShopClientSystemï¼‰
2. PlayerJoinServerEventï¼ˆæ¥è‡ªå¼•æ“ï¼‰

**å‘é€çš„äº‹ä»¶**ï¼š
1. PurchaseResultEventï¼ˆå‘é€åˆ°ShopClientSystemï¼‰

**ä½¿ç”¨çš„Component**ï¼š
1. ExtraData - å­˜å‚¨ç©å®¶å•†åŸæ•°æ®ï¼ˆä½™é¢ã€è´­ä¹°å†å²ï¼‰
2. Item - å‘æ”¾é“å…·åˆ°ç©å®¶èƒŒåŒ…
3. Game - è·å–æ¸¸æˆæ—¶é—´

**å…³é”®æ–¹æ³•**ï¼š
1. OnPlayerJoin(args) - åˆå§‹åŒ–ç©å®¶å•†åŸæ•°æ®
2. OnPurchaseRequest(args) - å¤„ç†è´­ä¹°è¯·æ±‚
3. _GetPlayerShopData(playerId) - è·å–ç©å®¶æ•°æ®
4. _SendPurchaseResult(playerId, success, message) - é€šçŸ¥å®¢æˆ·ç«¯ç»“æœ

---

ğŸ¨ **ç”Ÿæˆæ¶æ„å›¾**ï¼š

{æ˜¾ç¤ºShopServerSystemè¯¦ç»†Mermaidå›¾}

ğŸ“ **ä¿å­˜åˆ°æ–‡ä»¶**: markdown/diagrams/ShopServerSystem.md

âœ… å®Œæˆï¼
```

---

## æ³¨æ„äº‹é¡¹

### 1. ä»£ç åˆ†æé™åˆ¶

âš ï¸ **ä»…åˆ†æPythonä»£ç ç»“æ„**ï¼Œä¸æ‰§è¡Œä»£ç é€»è¾‘
âš ï¸ æ— æ³•åˆ†æåŠ¨æ€åˆ›å»ºçš„äº‹ä»¶ç›‘å¬ï¼ˆå¦‚å¾ªç¯ä¸­çš„ListenForEventï¼‰
âš ï¸ æ— æ³•è¯†åˆ«é—´æ¥çš„Componentä½¿ç”¨ï¼ˆå¦‚é€šè¿‡å·¥å…·å‡½æ•°åˆ›å»ºï¼‰

### 2. å›¾è¡¨å¤æ‚åº¦æ§åˆ¶

å¦‚æœé¡¹ç›®Systemæ•°é‡è¿‡å¤šï¼ˆ>10ä¸ªï¼‰ï¼Œå»ºè®®ï¼š
- æŒ‰æ¨¡å—åˆ†ç»„ç”Ÿæˆå¤šä¸ªæ¶æ„å›¾
- ä»…ç”Ÿæˆå…³é”®Systemçš„è¯¦ç»†å›¾
- ä½¿ç”¨æŠ˜å /å±•å¼€è¯­æ³•ç®€åŒ–å›¾è¡¨

### 3. æ–‡ä»¶ä¿å­˜ä½ç½®

**é»˜è®¤è·¯å¾„**ï¼š`markdown/diagrams/architecture.md`

**è‡ªå®šä¹‰è·¯å¾„**ï¼šç”¨æˆ·å¯ä»¥æŒ‡å®šè¾“å‡ºè·¯å¾„
```
/generate-diagram --output=docs/architecture.md
```

---

## å®Œæˆæ ‡å‡†

ç”Ÿæˆçš„æ¶æ„å›¾å¿…é¡»åŒ…å«ï¼š
1. âœ… Systemæ€»è§ˆå›¾ï¼ˆæ‰€æœ‰Systemçš„å…³ç³»ï¼‰
2. âœ… æ¯ä¸ªSystemçš„è¯¦ç»†æ¶æ„å›¾
3. âœ… å…³é”®ä¸šåŠ¡æµç¨‹çš„åºåˆ—å›¾
4. âœ… ç»Ÿè®¡ä¿¡æ¯ï¼ˆSystemæ•°é‡ã€äº‹ä»¶æ•°é‡ã€Componentæ•°é‡ï¼‰
5. âœ… ä¿å­˜åˆ°Markdownæ–‡æ¡£æ–‡ä»¶

---

**å‘½ä»¤ç±»å‹**: ä»£ç åˆ†æå‘½ä»¤
**é¢„æœŸæ‰§è¡Œæ—¶é—´**: 30-60ç§’ï¼ˆå–å†³äºSystemæ•°é‡ï¼‰
**è¾“å‡ºæ ¼å¼**: Mermaid + Markdownæ–‡æ¡£
