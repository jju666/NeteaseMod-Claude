# /mc - MODSDK标准工作流

> **版本**: v18.3.0 (Hook驱动精简版)
> **设计理念**: Hook自动化 + 最小化指令

---

## 📋 快速开始

```bash
/mc <任务描述>
```

**示例**：
{{EXAMPLE_TASKS}}

---

## 🎯 工作流程（3步法）

**Hook会自动处理**：
- ✅ 任务目录创建（`tasks/task-XXX/`）
- ✅ 修改日志记录（`change-log.md`）
- ✅ 任务恢复检测（关键词：继续/恢复）
- ✅ 完成提示（关键词：完成/done）

**你需要专注**：
- 📖 查阅文档
- 🔍 理解需求
- 💻 编写代码

---

### 步骤0：理解项目 (1分钟)

**必做**：
```bash
Read ../../CLAUDE.md
```

**输出检查点**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 步骤0：项目上下文
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
项目：{{PROJECT_NAME}}
类型：{{PROJECT_TYPE}}
规范：[列出关键规范，如有]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 步骤1：理解任务 (2分钟)

#### 1.1 检查任务历史

```bash
# 查看是否有相关历史任务
ls {{PROJECT_PATH}}/tasks/
```

**判断**：
- 如找到相关任务 → 阅读其 `context.md` 和 `solution.md`
- 如是新任务 → 继续下一步

#### 1.2 识别任务类型

**Hook会根据你的判断自动创建目录**，你只需要在脑海中分类：

| 类型 | 特征 | 下一步 |
|------|------|--------|
| 🟢 **微任务** | 单文件、<30行、无需探索 | 跳到步骤3 |
| 🟡 **标准任务** | 3-8文件、需理解交互 | 继续步骤2 |
| 🔴 **复杂任务** | >5 System、架构变更 | 步骤2后触发审核 |

**任务目录说明**（标准/复杂任务）：
- Hook会在你创建任务目录时自动生成：
  - `context.md` - 任务上下文（6章模板）
  - `change-log.md` - 修改日志（Hook自动记录）
  - `status.json` - 任务状态（Hook自动维护）
  - `recovery-checklist.md` - 恢复清单（5步流程）

**微任务不创建目录**，直接执行。

---

### 步骤2：查阅文档 (3-5分钟) ⭐ 核心步骤

#### 2.1 强制要求

⚠️ **必须满足**：
1. 查阅 ≥ 3个 markdown 文档
2. 禁止在此步骤 `Grep/Read` Python代码
3. 输出"步骤2检查点"报告

**Hook会统计你查阅的文档数**（通过read-hook.sh）

#### 2.2 文档优先级

**🔍 必查文档**（按优先级）：

1. **开发规范.md** - 检查CRITICAL规范 ⭐⭐⭐
   ```bash
   # 优先项目定制版
   Read markdown/core/开发规范.md
   # 降级：上游基线版
   Read .claude/core-docs/核心工作流文档/开发规范.md
   ```

2. **问题排查.md** - 查找已知问题
   ```bash
   Read markdown/core/问题排查.md
   ```

3. **Systems文档** - 系统实现参考
   ```bash
   Read markdown/systems/[SystemName].md
   ```

**🌐 官方MODSDK文档**（按需查阅）：

**查阅路径**（三级降级）：
- ✅ **优先**：本地离线（`{{GLOBAL_DOCS_PATH}}/modsdk-wiki/`）
- 🌐 **降级**：在线GitHub（WebFetch）
- ⚠️ **失败**：标记为"未找到"（高风险）

**重要**：MODSDK文档按分类组织，使用**3步查询法**：

**【事件查询】**：
```bash
# 步骤1：查索引表
Grep("ServerPlayerTryDestroyBlockEvent",
     path="{{GLOBAL_DOCS_PATH}}/modsdk-wiki/docs/mcdocs/1-ModAPI/事件/事件索引表.md",
     output_mode="content")
# → 输出：位于"方块.md"

# 步骤2：读分类文档
Read("{{GLOBAL_DOCS_PATH}}/modsdk-wiki/docs/mcdocs/1-ModAPI/事件/方块.md")

# 步骤3：定位章节（在输出中搜索事件名）
```

**【API查询】**：
```bash
# 直接Grep搜索API名
Grep("GetHealth",
     path="{{GLOBAL_DOCS_PATH}}/modsdk-wiki/docs/mcdocs/1-ModAPI/",
     output_mode="files_with_matches")
# → 找到文件后Read该文件
```

**【事件/API分类索引】**：
```
事件按端别和功能分类：
  - 玩家事件 → 事件/玩家.md
  - 方块事件 → 事件/方块.md
  - 实体事件 → 事件/实体.md
  - 等级事件 → 事件/等级.md
  (完整列表见：事件/事件索引表.md)

API按功能分类：
  - Component → Component/healthComp.md
  - 接口类 → 接口/玩家.md, 接口/物品.md
  (完整列表见：接口/接口索引.md)
```

{{NBT_CHECK_SECTION}}

#### 2.3 输出检查点 ⭐ 必须输出

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 步骤2检查点：文档查阅报告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 📚 已查阅文档（≥3个）:
   - 开发规范.md:164-210 - CRITICAL规范
   - MODSDK核心概念.md:50-80 - Part设计模式
   - markdown/systems/CombatSystem.md - 战斗系统架构

2. 🔑 提取的关键原则（禁止推测）:
   ⛔ 禁止: 在Part.__init__()中调用MODSDK API
   ✅ 应该: 在Create()方法中初始化Component
   📚 原因: 网易引擎生命周期限制

   ⛔ 禁止: 使用GetSystem跨端获取System
   ✅ 应该: 使用NotifyToClient/NotifyToServer通信
   📚 原因: 双端隔离原则

3. 📋 文档依据清单（精确到行号）:
   - 开发规范.md:164 - System生命周期规范
   - 开发规范.md:210 - 双端隔离原则
   - MODSDK核心概念.md:72 - Part初始化流程

4. 🌐 官方文档查阅（如有）:
   [列出查阅的事件/API和结果]

⚠️ 确认检查点输出后，进入步骤3！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 步骤3：执行实施

#### 3.1 任务级别分支

根据步骤1的任务类型判断：

```python
if 任务类型 == "🟢 微任务":
    # 直接执行，无需审核
    执行修改()
    测试验证()
    完成任务()

elif 任务类型 == "🟡 标准任务":
    # 可选审核（满足触发条件时）
    if 满足任意触发条件():
        触发专家审核("/mc-review")  # Hook会自动处理
    else:
        执行修改()

    测试验证()
    完成任务()

elif 任务类型 == "🔴 复杂任务":
    # 强制审核
    触发专家审核("/mc-review")  # 100%触发
    等待用户确认()
    执行修改()
    测试验证()
    完成任务()
```

**专家审核触发条件**（标准任务）：
1. 涉及 > 5个 System
2. 多轮修复（≥2次失败）
3. 用户明确要求（关键词："审核"/"review"）
4. 自检发现高风险问题
5. （复杂任务100%触发）

**触发审核时输出**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 触发专家审核
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
任务级别: 🔴 复杂任务
触发原因: [具体原因]
涉及System: [列出System名称]

正在调用 /mc-review 进行方案审核...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 3.2 实施修改

**Hook会自动**：
- ✅ 记录每次Edit到 `change-log.md`
- ✅ 更新 `status.json` 的轮次
- ✅ 维护 `.claude/.task-mode.json` 状态

**你只需要**：
1. 执行Edit/Write修改代码
2. 运行测试验证
3. 如失败，分析原因并重试

**修改后必须测试**：
```bash
# 运行测试（根据项目类型）
npm test
# 或
python -m pytest
# 或
游戏内测试
```

#### 3.3 完成任务

**说出关键词触发Hook**：
```
"任务完成" / "修复成功" / "done" / "finished"
```

**Hook会提示**：
1. 文档补充（如有标记）
2. DEBUG清理（如有调试代码）
3. 任务归档（提取经验）

**归档任务**（可选）：
```bash
# Hook会提示你执行以下操作
mv tasks/task-XXX tasks/completed/
# 更新知识库（如有专家审核）
```

---

## 🔄 任务恢复（上下文丢失时）

**说出关键词触发Hook**：
```
"继续" / "恢复" / "context lost" / "resume"
```

**Hook会强制你执行恢复流程**：
1. Read `tasks/task-XXX/recovery-checklist.md`
2. 按5步恢复上下文：
   - 步骤1：恢复任务基本信息（Read context.md）
   - 步骤2：恢复修改历史（Read change-log.md）
   - 步骤3：恢复文件状态（Read 所有修改文件）
   - 步骤4：理解失败原因（分析最后一轮）
   - 步骤5：输出恢复报告（必须！）
3. 恢复报告输出后才能继续任务

**恢复时间**: <3秒（只需读3个文件）
**恢复准确率**: 100%

---

## 📚 附录

### A. CRITICAL规范速查

**必须遵守**（违反会导致运行时错误）：

| 规范 | 禁止 | 应该 | 文档引用 |
|------|------|------|----------|
| **生命周期** | 在`__init__`调用MODSDK API | 在`Create()`初始化 | 开发规范.md:164 |
| **双端隔离** | 跨端`GetSystem` | 使用`NotifyToClient/Server` | 开发规范.md:210 |
| **数据结构** | EventData使用`tuple` | 使用`list`/`dict` | 开发规范.md:258 |
| **AOI范围** | 超过2000范围 | 限制在2000内 | 开发规范.md:312 |
| **Python模块** | 使用未授权模块 | 只用白名单模块 | 开发规范.md:375 |

### B. 常用代码模板

**ServerSystem基础框架**：
```python
# -*- coding: utf-8 -*-
from mod.server.system.serverSystem import ServerSystem
import mod.server.extraServerApi as serverApi

class MyServerSystem(ServerSystem):
    def __init__(self, namespace, systemName):
        super(MyServerSystem, self).__init__(namespace, systemName)
        self.comp = None
        self.Create()  # ⚠️ 手动调用

    def Create(self):
        """✅ 在Create中初始化"""
        levelId = serverApi.GetLevelId()
        self.comp = serverApi.GetEngineCompFactory().CreateXXX(levelId)

        # 监听事件
        self.ListenForEvent(namespace, system, event, self, self.OnEvent)

    def OnEvent(self, args):
        """事件处理器"""
        # 业务逻辑
        pass
```

**ClientSystem基础框架**：
```python
# -*- coding: utf-8 -*-
from mod.client.system.clientSystem import ClientSystem
import mod.client.extraClientApi as clientApi

class MyClientSystem(ClientSystem):
    def __init__(self, namespace, systemName):
        super(MyClientSystem, self).__init__(namespace, systemName)
        self.Create()

    def Create(self):
        """监听服务端事件"""
        self.ListenForEvent(namespace, server_system, custom_event,
                           self, self.OnServerEvent)

    def OnServerEvent(self, args):
        """更新UI"""
        pass
```

**双端通信**：
```python
# Server → Client
data = self.CreateEventData()
data["key"] = value
self.NotifyToClient(playerId, "CustomEvent", data)

# Client → Server
data = self.CreateEventData()
data["key"] = value
self.NotifyToServer("CustomEvent", data)
```

### C. 文档路径速查

| 文档类型 | 路径 | 用途 |
|---------|------|------|
| 项目指导 | `../../CLAUDE.md` | 项目上下文 |
| 开发规范 | `markdown/core/开发规范.md` | CRITICAL规范 |
| 问题排查 | `markdown/core/问题排查.md` | 已知问题 |
| System文档 | `markdown/systems/[Name].md` | 系统实现 |
| 事件索引 | `{{GLOBAL_DOCS_PATH}}/modsdk-wiki/.../事件/事件索引表.md` | 事件查询 |
| API文档 | `{{GLOBAL_DOCS_PATH}}/modsdk-wiki/.../Component/` | API参考 |

---

## 🎯 总结

**Hook已自动化**：
- ✅ 任务目录创建
- ✅ 修改日志记录
- ✅ 任务恢复检测
- ✅ 文档查阅统计
- ✅ 完成提示

**你只需专注**：
- 📖 步骤0：理解项目（Read CLAUDE.md）
- 🔍 步骤1：理解任务（判断类型）
- 📚 步骤2：查阅文档（≥3个，输出检查点）
- 💻 步骤3：编写代码（Hook自动记录）

**极简工作流，专注核心价值！** 🚀
