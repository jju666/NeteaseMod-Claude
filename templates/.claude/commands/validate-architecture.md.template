# 架构验证命令

> 🏗️ 验证MODSDK项目是否符合ECS架构原则和开发规范

---

## 你的任务

请对当前MODSDK项目进行架构验证，检查是否存在反模式和架构违规，并生成验证报告。

---

## 执行步骤

### 1. 扫描项目结构

使用Glob工具扫描项目文件：

```
behavior_packs/*/scripts/server/*System.py
behavior_packs/*/scripts/client/*System.py
behavior_packs/*/scripts/server/*Component.py
behavior_packs/*/scripts/client/*Component.py
```

### 2. 检测架构问题

针对每个文件，使用Read工具读取内容，检测以下架构问题：

#### 反模式1：客户端处理业务逻辑 🔴 CRITICAL

**检测方法**：
- 文件路径包含`/client/`
- 代码中包含以下关键词：
  - `DeductMoney`（扣除金钱）
  - `AddExp`（增加经验）
  - `GiveItem`（给予物品）
  - `SetPlayerData`（设置玩家数据）

**判断标准**：客户端代码中包含业务逻辑修改

**危害**：严重的安全漏洞，客户端可被黑客修改

---

#### 反模式2：System之间直接调用 🟠 HIGH

**检测方法**：
- 搜索`GetSystem`调用
- 检查是否直接调用其他System的方法

**判断标准**：
```python
# ❌ 错误示例
self.other_system = GetSystem("MyMod", "OtherSystem")
self.other_system.DoSomething()
```

**危害**：强耦合，难以维护和测试

---

#### 反模式3：在`__init__`中调用游戏API 🟠 HIGH

**检测方法**：
- 检查`__init__`方法中是否调用以下API：
  - `GetComponent`
  - `GetEngineCompFactory`
  - `ListenForEvent`
  - `GetPlayerPos`

**判断标准**：`__init__`中包含游戏API调用（除了`self.Create()`）

**危害**：初始化顺序问题，可能导致崩溃

---

#### 反模式4：过度使用全局变量 🟡 MEDIUM

**检测方法**：
- 搜索文件级别的全局变量定义
- 检查`g_`前缀的变量

**判断标准**：
```python
# ❌ 错误示例
g_player_money = {}
g_shop_items = []
```

**危害**：命名冲突，难以测试

---

#### 反模式5：硬编码配置 🟡 MEDIUM

**检测方法**：
- 检查代码中的魔术数字和字符串
- 搜索`if level == 1:`等硬编码逻辑

**判断标准**：配置值直接写在代码中，而非配置文件

**危害**：修改配置需要重新发布代码

---

#### 反模式6：缺少错误处理 🟡 MEDIUM

**检测方法**：
- 检查是否有`try-except`块
- 检查文件I/O、网络调用等危险操作

**判断标准**：危险操作缺少异常处理

**危害**：容易崩溃

---

### 3. 检查ECS架构规范

#### 检查项1：Component设计

**规范**：
- ✅ Component应只包含数据，不包含逻辑
- ✅ Component应继承自官方Component基类
- ❌ Component不应包含复杂的方法

**检测方法**：
- 读取Component文件
- 检查方法数量和复杂度

---

#### 检查项2：System职责分离

**规范**：
- ✅ 客户端System只负责UI和输入
- ✅ 服务器System负责业务逻辑
- ❌ 不允许跨端GetSystem

**检测方法**：
- 检查System文件路径（client/server）
- 分析System的职责

---

#### 检查项3：双端通信规范

**规范**：
- ✅ 使用`NotifyToServer`/`NotifyToClient`通信
- ❌ 不允许跨端GetSystem
- ✅ 客户端请求需要服务器验证

**检测方法**：
- 搜索`NotifyToServer`/`NotifyToClient`
- 检查是否有验证逻辑

---

### 4. 生成验证报告

以Markdown格式生成报告：

```markdown
# 架构验证报告

**项目名称**：{{PROJECT_NAME}}
**验证时间**：{{CURRENT_DATE}}
**验证文件数**：[总数]

---

## 执行摘要

- ✅ 符合规范的System：[数量]
- 🔴 CRITICAL违规：[数量]
- 🟠 HIGH违规：[数量]
- 🟡 MEDIUM违规：[数量]

**架构健康度**：[A/B/C/D]

---

## 反模式检测结果

### 🔴 CRITICAL 反模式

#### 1. [System名称] - 客户端处理业务逻辑

**文件**：[文件路径]
**行号**：[行号]

**违规代码**：
```python
[违规代码]
```

**安全风险**：
- 客户端可被黑客修改
- 游戏经济系统崩溃
- 作弊泛滥

**修复建议**：
```python
[正确的双端分离代码]
```

---

### 🟠 HIGH 反模式

[同上格式]

---

### 🟡 MEDIUM 反模式

[同上格式]

---

## ECS架构规范检查

### ✅ 通过的检查项

1. Component设计符合规范（[数量]个Component）
2. System职责分离明确（[数量]个System）

### ❌ 未通过的检查项

1. [检查项名称]
   - **问题**：[描述]
   - **影响**：[影响]
   - **建议**：[建议]

---

## 修复建议清单

### 必须立即修复（CRITICAL）

- [ ] [System1]：将业务逻辑从客户端移至服务器
- [ ] [System2]：添加服务器端验证

### 高优先级修复（HIGH）

- [ ] [System3]：使用事件通信替代直接调用
- [ ] [System4]：将API调用从`__init__`移至`Create()`

### 中优先级优化（MEDIUM）

- [ ] [System5]：将全局变量改为实例变量
- [ ] [System6]：配置外部化
- [ ] [System7]：添加错误处理

---

## 架构改进建议

基于当前项目分析，建议：

1. **安全性改进**：
   - [ ] 所有客户端请求添加服务器验证
   - [ ] 敏感操作添加权限检查

2. **可维护性改进**：
   - [ ] 解除System间的直接依赖
   - [ ] 配置文件外部化
   - [ ] 添加单元测试

3. **性能改进**：
   - [ ] 参考 `/analyze-performance` 命令的分析结果

---

## 参考文档

- [开发规范.md](./markdown/开发规范.md) - CRITICAL规范
- [反模式识别清单.md](./markdown/反模式识别清单.md)
- [深入理解ECS架构.md](./markdown/深入理解ECS架构.md)
- [网络架构与通信.md](./markdown/网络架构与通信.md)

---

**验证工具版本**：v1.0
**AI助手**：Claude Code
```

### 5. 输出报告并询问

将报告输出给用户，并询问是否需要：
1. 自动修复CRITICAL反模式
2. 生成重构代码示例
3. 创建架构设计文档

---

## 重要提示

- ⚠️ 这是只读分析，不会修改任何代码
- ⚠️ CRITICAL反模式可能导致严重的安全问题
- ⚠️ 如果需要自动修复，请明确确认
- ⚠️ 修复建议基于MODSDK开发规范

---

## 相关文档

请在验证前阅读以下文档以了解架构标准：

- [开发规范.md](../../markdown/开发规范.md)
- [反模式识别清单.md](../../markdown/反模式识别清单.md)
- [深入理解ECS架构.md](../../markdown/深入理解ECS架构.md)
