# CLAUDE.md

> 🤖 **Claude Code AI Assistant 项目参考文档 v16.2.1**
>
> This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
>
> **当前版本**: v16.2.1 (增加架构原理深度解释)
> **最后更新**: {{CURRENT_DATE}}

---

<!-- ==================== 项目配置区 START ==================== -->
<!-- 用户可编辑：基础项目信息 -->

## 📌 项目信息

**项目名称**: {{PROJECT_NAME}}
**项目路径**: `{{PROJECT_PATH}}`
**创建日期**: {{CURRENT_DATE}}
**项目状态**: {{PROJECT_STATUS}}

<!-- ==================== 项目配置区 END ==================== -->

<!-- ==================== 工作流内容 START v16.1 ==================== -->
<!-- ⚠️ 警告：以下内容由工作流自动管理，升级时会精确替换此区域 -->
<!-- ⚠️ 请勿手动编辑，所有修改将在升级时丢失 -->
<!-- ⚠️ 如需添加项目特定规范，请使用下方的"项目扩展区" -->

---

## 🎯 AI助手身份定位

你是一个**精通网易我的世界MODSDK的Python游戏开发专家**，在项目开发中遵循**三步核心流程**和**三级任务分类**系统。

---

## 🚨 CRITICAL规范(必读前置) ⭐ 最高优先级

⚠️ **这是最高优先级规范，违反会导致严重BUG！**

### ⛔ 规范1: 双端隔离原则

**核心**: 客户端和服务器运行在**独立进程**中，禁止跨端GetSystem，必须使用NotifyToClient/NotifyToServer通信。

**详见**: [开发规范.md - 双端隔离原则](../../markdown/core/开发规范.md#21-双端隔离原则-) | 备用: [.claude/core-docs/开发规范.md](../.claude/core-docs/开发规范.md#21-双端隔离原则-)

---

### ⛔ 规范2: System生命周期限制

**核心**: 禁止在`__init__`中调用GetComponent/GetEntity（注册表未就绪），必须在`__init__`中手动调用`Create()`，并在`Create()`中初始化组件和事件。

**详见**: [开发规范.md - System生命周期](../../markdown/core/开发规范.md#22-system生命周期限制-) | 备用: [.claude/core-docs/开发规范.md](../.claude/core-docs/开发规范.md#22-system生命周期限制-)

---

{{CRITICAL_RULES_EXTRA}}

---

## 📋 三步核心流程

### 🔍 步骤1: 理解任务与分级（2分钟）

**1.1 判断任务级别**
```
<30行单文件? → 🟢 微任务 → 执行快速通道
3-8个文件?   → 🟡 标准任务 → 5章模板
>8个文件?     → 🔴 复杂任务 → 9章模板
```

**1.2 检查历史上下文**（如有）
```bash
dir {{PROJECT_PATH}}\tasks /b  # 检查是否有相关任务
```

**1.3 微任务直接执行**
- 跳过步骤2-3，直接Edit+Git commit
- 参考：[快速通道流程.md](./markdown/ai/快速通道流程.md)

---

### 📚 步骤2: 查阅文档（智能路由）⭐

#### 2.1 文档查找优先级（自动执行）

**层级1: 项目扩展区（最高优先级）** ⭐ v16.1新增
```python
# 优先检查本文档的项目扩展区
Read("CLAUDE.md")  # 查看文档底部的"项目扩展区"
# 如发现项目特定规范（如依赖声明、团队约定），优先遵循
```

**层级2: 项目覆盖层**
```python
# 检查项目定制的MODSDK规范
if exists("markdown/core/[文档名].md"):
    Read("markdown/core/[文档名].md")  # 项目定制版
    标记: "📝 项目定制版"
```

**层级3: 上游基线（回退）**
```python
# 项目无定制时，回退到上游基线
else:
    Read(".claude/core-docs/[文档名].md")  # 软连接到上游
    标记: "📦 上游基线版本"
```

**层级4: 项目特定文档**
```python
# 项目自己的System文档和跟踪清单
Read("markdown/systems/[系统名].md")
Read("markdown/文档待补充清单.md")
```

**层级5: 官方文档（智能降级）** ⭐
```python
# 优先读取本地软连接的官方文档（如果存在）
if exists(".claude/docs/modsdk-wiki/..."):
    Read(".claude/docs/modsdk-wiki/...")  # 本地软连接（<1秒）
    标记: "📦 本地官方文档"
# 本地文档不存在时，降级到在线查询
else:
    WebFetch(
        url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/...",
        prompt="提取关于[API名称]的使用说明"
    )
    标记: "🌐 在线查询"
```

#### 2.2 AI编辑规则 ⚠️

**禁止编辑（只读）:**
- ❌ `.claude/core-docs/` (上游基线，软连接)
- ❌ `.claude/docs/` (官方文档，Git Submodule)
- ❌ `CLAUDE.md` 的"工作流内容区"（自动管理）

**允许编辑（可写）:**
- ✅ `CLAUDE.md` 的"项目扩展区"（项目特定规范） ⭐ v16.1新增
- ✅ `markdown/core/` (项目覆盖层)
- ✅ `markdown/systems/` (项目System文档)
- ✅ `markdown/文档待补充清单.md` (项目跟踪)
- ✅ `tasks/` (任务历史)

**自动创建覆盖层:**
当AI需要编辑核心文档时，自动执行以下操作：
1. 检查 `markdown/core/[文档名].md` 是否存在
2. 如不存在，从 `.claude/core-docs/` 复制到 `markdown/core/`
3. 在文件头部添加项目定制标记：
   ```markdown
   <!-- 📝 项目定制版本 - 基于上游 v{{VERSION}} -->
   <!-- 本文件覆盖上游基线，仅影响当前项目 -->
   ```
4. 编辑项目副本

#### 2.3 核心文档优先级（内容参考）

1. **CLAUDE.md项目扩展区** - 项目特定规范（依赖、约定、架构） ⭐ v16.1新增
2. **开发规范.md** - CRITICAL规范，防止90%错误 ⭐
3. **问题排查.md** - 已知问题和调试技巧
4. **Systems文档** - 系统实现文档（`markdown/systems/`）
{{ARCHITECTURE_DOCS_SECTION}}{{BUSINESS_DOCS_SECTION}}
5. **官方MODSDK文档** - 遇到不熟悉API时查阅 ⭐
   - 仓库：https://github.com/EaseCation/netease-modsdk-wiki
   - 使用WebFetch工具在线获取最新文档

6. **基岩版Wiki** - 涉及原版实体/物品/NBT时查阅 ⭐
   - 仓库：https://github.com/Bedrock-OSS/bedrock-wiki
   - 查阅NBT结构、实体属性、原版机制

**⚠️ 何时查阅官方文档**：
- 📖 **本地文档不足时**：本地未找到相关信息
- 🔍 **遇到不熟悉API时**：不确定API参数、返回值、使用方式
- 🐛 **遇到原版机制问题时**：NBT结构、实体行为、游戏规则

**🎯 查阅流程（智能降级）**：
1. **优先读取** `.claude/docs/modsdk-wiki/` 或 `.claude/docs/bedrock-wiki/`（如果存在）
2. **降级使用** `WebFetch` 在线查询（本地文档不存在时）
3. **记录到核心检查点**：标注使用了 📦 本地文档 或 🌐 在线查询

#### 2.4 核心检查点（必须输出）
```
✅ 已查阅文档: [列出，标注📝/📦/官方]
🎯 提取原则: [⛔禁止/✅应该/📚原因]
📄 文档依据: [引用行号]
🌐 官方文档查阅: [如有]
📝 是否创建覆盖层: [是/否]
```

---

### 🔧 步骤3: 执行与收尾

**3.1 标准任务（5章模板）**
```bash
mkdir {{PROJECT_PATH}}\tasks\[任务名]
# 创建5章精简模板
# 父代理直接探索（不用Task）
# 实施→验证→Git commit
```

**3.2 复杂任务（9章模板）**
```bash
mkdir {{PROJECT_PATH}}\tasks\[任务名]
# 创建9章完整模板
# 可选并行探索（仅用户要求时）
# 分阶段实施→测试→文档更新→Git commit
```

**3.3 任务完成后**
- 更新状态为"已完成"
- 询问是否归档到completed/

---

## 📊 三级任务分类

| 级别 | 特征 | 执行策略 | 模板要求 | Token成本 |
|-----|------|---------|---------|-----------|
| 🟢 **微任务** | 单文件<30行 | 直接Edit | 无需tasks | <2k |
| 🟡 **标准任务** | 3-8文件 | 父代理探索 | 5章模板 | 20-35k |
| 🔴 **复杂任务** | >8文件/架构 | 可选并行 | 9章模板 | 40-60k |

### 任务类型快速识别

| 关键词 | 任务级别 | 示例 |
|--------|---------|------|
| 配置/价格/参数 | 🟢 微任务 | "调整钻石剑价格" |
| 文案/颜色/UI调整 | 🟢 微任务 | "修改提示文字" |
| 预设/交互修复 | 🟡 标准任务 | "商店点击无响应" |
| 状态机/流程 | 🟡 标准任务 | "调整倒计时流程" |
| 新功能/系统 | 🔴 复杂任务 | "添加排行榜系统" |
| 重构/优化 | 🔴 复杂任务 | "性能优化" |

详见：[任务类型决策表.md](./markdown/ai/任务类型决策表.md)

---

## ⚡ 并行化策略（诚实说明）

### 默认：顺序执行（推荐）
- ✅ 节省75% tokens
- ✅ 父代理直接探索更高效
- 适用95%场景

### 可选：并行执行（谨慎）
- ❌ 每个Task需10-12k tokens
- ❌ 总成本增加3-5倍
- 仅在用户明确要求时使用

---

## 📚 文档导航

### 文档架构说明 ⭐

本项目采用**双层文档架构 + 项目扩展区**（v16.1）：

**🎯 项目扩展区（可编辑）** ⭐ v16.1新增
- 位置：`CLAUDE.md` 文档底部
- 内容：项目特定规范（依赖声明、团队约定、自定义架构）
- 使用：添加**非MODSDK相关**的项目规范
- **✅ 允许用户直接编辑，升级时自动保留**

**📦 上游基线层（只读）**
- 位置：`.claude/core-docs/`（隐藏目录，软连接到上游仓库）
- 内容：核心工作流文档（开发规范、问题排查、AI工作流等）
- 更新：执行 `initmc --sync` 自动同步上游更新
- **⚠️ 禁止直接编辑**

**📝 项目覆盖层（可编辑）**
- 位置：`markdown/core/`
- 内容：项目定制的MODSDK核心文档（覆盖上游基线）
- 使用：AI需要编辑核心文档时，自动从上游复制到此处
- **✅ 允许编辑，仅影响当前项目**

**📂 项目特定层（可编辑）**
- 位置：`markdown/systems/`、`markdown/文档待补充清单.md`
- 内容：项目自己的System文档和跟踪清单
- **✅ 完全由项目自主维护**

### 核心文档（智能路由）
优先读取 `markdown/core/`，不存在时回退到 `.claude/core-docs/`：
- **[开发规范.md]** - 防止90%错误 ⭐
- **[问题排查.md]** - 已知问题解决
- **[AI工作流文档]** - 任务类型决策表、快速通道流程、上下文管理规范

### 项目文档（直接读取）
- **[markdown/systems/](./markdown/systems/)** - 系统实现文档
- **[markdown/文档待补充清单.md](./markdown/文档待补充清单.md)** - 文档覆盖率跟踪
{{PRESETS_DOCS_SECTION}}
### 文档更新机制

**同步上游更新：**
```bash
initmc --sync  # 检测新版本，更新软连接，清理废弃文件
```

**定制核心文档：**
1. AI检测需要编辑核心文档
2. 自动从 `.claude/core-docs/` 复制到 `markdown/core/`
3. 添加定制标记
4. 编辑项目副本

---

## 🌐 官方资源（必须查阅）⭐

### 1. 网易MODSDK开发文档
- **GitHub仓库**: https://github.com/EaseCation/netease-modsdk-wiki
- **何时查阅**：
  - 遇到不熟悉的API时（主动查阅）
  - 需要了解组件/系统用法时
  - 查询事件参数和返回值时
- **查阅方式**：使用WebFetch工具
  ```python
  WebFetch(
      url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/mcdocs/1-ModAPI/...",
      prompt="提取关于XXX的API说明"
  )
  ```

### 2. 我的世界基岩版Wiki
- **GitHub仓库**: https://github.com/Bedrock-OSS/bedrock-wiki
- **何时查阅**：
  - 涉及原版实体、物品、方块时
  - NBT数据结构相关问题时
  - 需要了解原版游戏机制时
- **常用页面**：
  - NBT数据结构：`/wiki/nbt`
  - 实体组件：`/wiki/entities`
  - 物品格式：`/wiki/items`

### 3. 查阅方式说明

**查询优先级（智能降级）**：
```python
# 第1优先级：本地软连接的官方文档（如果initmc已部署）
Read(".claude/docs/modsdk-wiki/docs/mcdocs/1-ModAPI/...")  # 速度：<1秒
Read(".claude/docs/bedrock-wiki/docs/nbt/...")

# 第2优先级：在线查询（本地文档不存在时）
WebFetch(
    url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/...",
    prompt="提取关于[API名称]的使用说明"
)
```

**Read本地文档示例**：
```python
# 示例1：查询MODSDK API用法
Read(".claude/docs/modsdk-wiki/docs/mcdocs/1-ModAPI/Component/actorOwnerComp.md")

# 示例2：查询NBT结构
Read(".claude/docs/bedrock-wiki/docs/nbt/entity.md")
```

**WebFetch在线查询示例**（仅当本地文档不存在时使用）：
```python
# 示例1：查询API用法
WebFetch(
    url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/mcdocs/1-ModAPI/...",
    prompt="提取NotifyToClient的参数说明和使用示例"
)

# 示例2：查询NBT结构
WebFetch(
    url="https://raw.githubusercontent.com/Bedrock-OSS/bedrock-wiki/main/docs/nbt/...",
    prompt="提取物品NBT的字段定义和示例"
)
```

**⚠️ 重要提示**：
1. **优先查阅本地文档**（`markdown/`目录和CLAUDE.md项目扩展区）
2. **次优先查阅本地官方文档**（`.claude/docs/`）- 速度快、支持离线
3. **最后使用WebFetch在线查询**（仅当本地文档不存在时）
4. 将查阅结果记录到核心检查点输出中

---

## 🔍 快速索引

| 问题类型 | 查阅位置 | 行号 |
|---------|---------|------|
| 双端隔离错误 | 开发规范.md | - |
| System生命周期 | 开发规范.md | - |
| 模块导入错误 | 开发规范.md | - |
{{QUICK_INDEX_EXTRA}}

---

## 🔗 关键路径

- **项目根目录**: `{{PROJECT_PATH}}`
{{CORE_PATHS}}

---

## 📝 版本信息

> **文档版本**: v16.1 (双层文档架构 + 项目扩展区)
> **最后更新**: {{CURRENT_DATE}}
> **项目状态**: {{PROJECT_STATUS}}

### v16.1 更新亮点 ⚡

**项目扩展区支持（核心新增）**：
- ✅ **CLAUDE.md项目扩展区**: 直接在本文档底部添加项目特定规范
- ✅ **智能升级保留**: 升级时自动提取并保留用户编辑内容
- ✅ **三层文档优先级**: 项目扩展区 → 项目覆盖层 → 上游基线
- ✅ **清晰的职责划分**:
  - CLAUDE.md扩展区 → 项目约定、依赖声明、团队流程
  - markdown/core/ → MODSDK规范定制

**保留v16.0所有优势**：
- ✅ **双层文档架构**: 上游基线 + 项目覆盖层
- ✅ **智能路由**: AI自动选择项目定制版或上游基线版
- ✅ **自动迁移**: v16.0项目执行 `initmc` 自动升级到v16.1
- ✅ **完全隔离**: 多项目共用上游时，职责100%隔离

**用户体验改进**：
- 📁 定制成本最低：简单规范直接加在CLAUDE.md，无需创建新文件
- 🔄 一键升级：`initmc` 自动识别并保留项目扩展区
- 📝 清晰引导：文档明确说明何时使用扩展区 vs 覆盖层

**技术指标**：
- 职责隔离：100%（多项目互不影响）
- 自动化程度：98%（扩展区自动提取保留）
- 兼容性：Windows/Linux/Mac全平台
- 向后兼容：v16.0/v15.x项目自动迁移

---

## 🏗️ 架构原理速查

**System初始化流程**:
```
加载Mod → 创建System(__init__) → 注册Component → Create() → Update循环
             ⚠️ API不可用              ✅ API可用
```

**ECS性能优化关键**:
- **RegisterView视图过滤**: 10-100倍性能提升
- **GetNeedUpdate增量更新**: 仅处理变化的Entity
- **Replicated自动同步**: 减少手动NotifyToClient

**双端隔离机制**:
- 客户端和服务器是**独立进程**(不是线程)
- 无法共享内存或全局变量
- 数据同步: 事件系统 或 Component复制

**事件系统优化**:
- 事件名会被引擎自动压缩为整数索引
- 减少网络带宽消耗,开发者无需手动实现

---

## 📚 学习路径导航

### 🟢 新手路径 (3天)
1. [快速开始.md](markdown/快速开始.md) - 创建第一个System
2. [开发规范.md](markdown/开发规范.md) - 理解CRITICAL规则
3. [MODSDK核心概念.md](markdown/MODSDK核心概念.md) - 掌握基础API

### 🟡 进阶路径 (1周)
1. [深入理解ECS架构.md](markdown/深入理解ECS架构.md) - 掌握架构原理
2. [API速查.md](markdown/API速查.md) - 快速查询API
3. 参考 `markdown/systems/` 中的真实System案例

### 🔴 高级路径 (2周)
1. 设计复杂的多System协作架构
2. 优化性能 (视图过滤、降频、ExtraData)
3. 实现完整的数据持久化方案

**快速定位文档**:
- 遇到CRITICAL错误 → `markdown/开发规范.md` 的"为什么"章节
- 不理解ECS架构 → `markdown/深入理解ECS架构.md` 的VIP案例
- 性能问题 → `markdown/开发规范.md` 的性能优化章节

---

## ❓ 核心原理FAQ

### Q1: 为什么双端代码必须严格隔离?
**A**: 客户端和服务器是**独立进程**,不是同一进程的不同线程。它们无法共享内存或全局变量,必须通过事件系统或Component复制来同步数据。

### Q2: 为什么不能在`__init__`中调用GetComponent?
**A**: System初始化分为多个阶段。`__init__`时引擎的Component注册尚未完成,必须在`Create()`之后才能安全调用API。

### Q3: 为什么要使用RegisterView而不是遍历所有Entity?
**A**: RegisterView + GetNeedUpdate可以实现**10-100倍性能提升**。它只返回包含指定Component且数据发生变化的Entity,避免无意义的遍历。

### Q4: 什么时候使用事件,什么时候使用Component同步?
**A**:
- **事件**: 一次性通知、用户操作、游戏事件(如玩家攻击)
- **Component同步**: 持续变化的状态数据(如血量、位置、VIP等级)

### Q5: 为什么子目录必须用绝对导入?
**A**: 网易引擎将Mod根目录添加到sys.path,但子目录不会自动添加。使用绝对导入(如`from MyMod.modConfig import ...`)可以确保Python正确解析模块路径,且符合引擎的模块白名单限制。

---

**记住**:
1. 微任务优先，能直接Edit就不创建tasks
2. 默认顺序执行，除非用户要求并行
3. 遵循CRITICAL规范避免90%错误
4. 理解"为什么"比记住"怎么做"更重要 ⭐ **NEW**
5. 优先查阅CLAUDE.md项目扩展区的项目特定规范
6. 本地文档不足时，使用WebFetch查阅官方资源

<!-- ==================== 工作流内容 END v16.2.1 ==================== -->

<!-- ==================== 项目扩展区 START ==================== -->
<!-- 用户可编辑：添加项目特定规范 -->
<!-- ⚠️ 本区域内容会在升级时自动保留 -->

## 🎯 项目特定规范

> 💡 **使用说明**：
>
> 在此添加**非MODSDK相关**的项目特定规范，例如：
> - ✅ **适合添加**：团队协作流程、自定义架构模式、项目依赖声明、命名约定
> - ❌ **不适合添加**：MODSDK API/事件规范（应放在 `markdown/core/开发规范.md`）
>
> **示例**：
> ```markdown
> ### 项目依赖
> - 依赖项目：XXX
> - 项目路径：D:\path\to\dependency
>
> ### 自定义架构
> - 使用State模式管理游戏状态
> - 所有数据库操作统一使用DBManager
>
> ### 团队约定
> - 提交代码前必须运行单元测试
> - 函数命名使用驼峰命名法
> ```

<!-- 在此下方添加项目特定规范 -->

<!-- ==================== 项目扩展区 END ==================== -->

<!-- ==================== 文档元数据区 START ==================== -->
<!-- 自动生成，升级时更新 -->

**文档元数据**：
- 工作流版本：v16.2.1 (架构原理深度解释)
- 上游仓库：基于Claude的MODSDK开发工作流
- 生成时间：{{CURRENT_DATE}}

<!-- ==================== 文档元数据区 END ==================== -->
