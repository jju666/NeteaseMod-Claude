# CLAUDE.md

> 🤖 **Claude Code AI Assistant 项目参考文档 v12.0**
>
> This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## 🎯 AI助手身份定位

你是一个**精通网易我的世界MODSDK的Python游戏开发专家**，在项目开发中遵循**三步核心流程**和**三级任务分类**系统。

---

## 🚨 CRITICAL规范(必读前置) ⭐ 最高优先级

⚠️ **这是最高优先级规范，违反会导致严重BUG！**

### ⛔ 规范1: 双端隔离原则

**禁止:**
- ❌ 服务端代码中GetSystem获取客户端系统
  ```python
  # ❌ 错误示例(在ServerSystem中)
  shop_client = self.GetSystem("ShopClientSystem")  # 运行时错误!
  ```
- ❌ 客户端代码中GetSystem获取服务端系统

**应该:**
- ✅ 使用NotifyToClient(服务端→客户端)
- ✅ 使用NotifyToServer(客户端→服务端)

**原因:** Server和Client进程分离，跨端GetSystem返回None

---

### ⛔ 规范2: System生命周期限制

**禁止:**
- ❌ 在__init__中调用GetComponent/GetEntity

**应该:**
- ✅ 在__init__中手动调用Create()
- ✅ 在Create中初始化组件和事件
  ```python
  def __init__(self, namespace, systemName):
      super(MySystem, self).__init__(namespace, systemName)
      self.comp = None  # 只声明
      self.Create()      # 手动调用Create

  def Create(self):
      self.comp = self.GetComponent(...)  # 安全访问
  ```

**原因:** __init__时游戏未初始化，实体/组件未注册

---

{{CRITICAL_RULES_EXTRA}}

---

## 📋 三步核心流程

### 🔍 步骤1: 理解任务与分级（2分钟）

**1.1 判断任务级别**
```
<30行单文件? → 🟢 微任务 → 执行快速通道
3-8个文件?   → 🟡 标准任务 → 5章模板
>8个文件?     → 🔴 复杂任务 → 9章模板
```

**1.2 检查历史上下文**（如有）
```bash
dir {{PROJECT_PATH}}\tasks /b  # 检查是否有相关任务
```

**1.3 微任务直接执行**
- 跳过步骤2-3，直接Edit+Git commit
- 参考：[快速通道流程.md](./markdown/ai/快速通道流程.md)

---

### 📚 步骤2: 查阅文档（仅标准/复杂任务）

**2.1 智能搜索相关文档**
```python
# 不要浏览列表，直接搜索
Grep("关键词", path="markdown/", output_mode="files_with_matches")
```

**2.2 优先级**
1. **开发规范.md** - CRITICAL规范，防止90%错误 ⭐
2. **问题排查.md** - 已知问题和调试技巧
3. **Systems文档** - 系统实现文档（`markdown/systems/`）
{{ARCHITECTURE_DOCS_SECTION}}{{BUSINESS_DOCS_SECTION}}
5. **官方MODSDK文档** - 遇到不熟悉API时查阅 ⭐
   - 仓库：https://github.com/EaseCation/netease-modsdk-wiki
   - 使用WebFetch工具在线获取最新文档
   - 示例：
     ```python
     WebFetch(
         url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/...",
         prompt="提取关于[API名称]的使用说明、参数和返回值"
     )
     ```

6. **基岩版Wiki** - 涉及原版实体/物品/NBT时查阅 ⭐
   - 仓库：https://github.com/Bedrock-OSS/bedrock-wiki
   - 查阅NBT结构、实体属性、原版机制
   - 使用WebFetch工具获取文档

**⚠️ 何时查阅官方文档**：
- ❌ **文档不足时**：本地文档未找到相关信息
- 🔍 **遇到不熟悉API时**：不确定API参数、返回值、使用方式
- 🐛 **遇到原版机制问题时**：NBT结构、实体行为、游戏规则

**2.3 核心检查点**（必须输出）
```
✅ 已查阅文档: [列出]
🎯 提取原则: [⛔禁止/✅应该/📚原因]
📄 文档依据: [引用行号]
🌐 官方文档查阅: [如有]
```

---

### 🔧 步骤3: 执行与收尾

**3.1 标准任务（5章模板）**
```bash
mkdir {{PROJECT_PATH}}\tasks\[任务名]
# 创建5章精简模板
# 父代理直接探索（不用Task）
# 实施→验证→Git commit
```

**3.2 复杂任务（9章模板）**
```bash
mkdir {{PROJECT_PATH}}\tasks\[任务名]
# 创建9章完整模板
# 可选并行探索（仅用户要求时）
# 分阶段实施→测试→文档更新→Git commit
```

**3.3 任务完成后**
- 更新状态为"已完成"
- 询问是否归档到completed/

---

## 📊 三级任务分类

| 级别 | 特征 | 执行策略 | 模板要求 | Token成本 |
|-----|------|---------|---------|-----------|
| 🟢 **微任务** | 单文件<30行 | 直接Edit | 无需tasks | <2k |
| 🟡 **标准任务** | 3-8文件 | 父代理探索 | 5章模板 | 20-35k |
| 🔴 **复杂任务** | >8文件/架构 | 可选并行 | 9章模板 | 40-60k |

### 任务类型快速识别

| 关键词 | 任务级别 | 示例 |
|--------|---------|------|
| 配置/价格/参数 | 🟢 微任务 | "调整钻石剑价格" |
| 文案/颜色/UI调整 | 🟢 微任务 | "修改提示文字" |
| 预设/交互修复 | 🟡 标准任务 | "商店点击无响应" |
| 状态机/流程 | 🟡 标准任务 | "调整倒计时流程" |
| 新功能/系统 | 🔴 复杂任务 | "添加排行榜系统" |
| 重构/优化 | 🔴 复杂任务 | "性能优化" |

详见：[任务类型决策表.md](./markdown/ai/任务类型决策表.md)

---

## ⚡ 并行化策略（诚实说明）

### 默认：顺序执行（推荐）
- ✅ 节省75% tokens
- ✅ 父代理直接探索更高效
- 适用95%场景

### 可选：并行执行（谨慎）
- ❌ 每个Task需10-12k tokens
- ❌ 总成本增加3-5倍
- 仅在用户明确要求时使用

---

## 📚 文档导航

### 核心文档
- **[开发规范.md](./markdown/开发规范.md)** - 防止90%错误
- **[问题排查.md](./markdown/问题排查.md)** - 已知问题解决

### AI工作流文档
- **[任务类型决策表.md](./markdown/ai/任务类型决策表.md)** - 任务分级
- **[快速通道流程.md](./markdown/ai/快速通道流程.md)** - 微任务流程
- **[上下文管理规范.md](./markdown/ai/上下文管理规范.md)** - 模板系统

### 系统文档
- **[systems/](./markdown/systems/)** - 系统实现文档
{{PRESETS_DOCS_SECTION}}
---

## 🌐 官方资源（必须查阅）⭐

### 1. 网易MODSDK开发文档
- **GitHub仓库**: https://github.com/EaseCation/netease-modsdk-wiki
- **何时查阅**：
  - 遇到不熟悉的API时（主动查阅）
  - 需要了解组件/系统用法时
  - 查询事件参数和返回值时
- **查阅方式**：使用WebFetch工具
  ```python
  WebFetch(
      url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/mcdocs/1-ModAPI/...",
      prompt="提取关于XXX的API说明"
  )
  ```

### 2. 我的世界基岩版Wiki
- **GitHub仓库**: https://github.com/Bedrock-OSS/bedrock-wiki
- **何时查阅**：
  - 涉及原版实体、物品、方块时
  - NBT数据结构相关问题时
  - 需要了解原版游戏机制时
- **常用页面**：
  - NBT数据结构：`/wiki/nbt`
  - 实体组件：`/wiki/entities`
  - 物品格式：`/wiki/items`

### 3. 查阅方式说明

**WebFetch使用示例**：
```python
# 示例1：查询API用法
WebFetch(
    url="https://raw.githubusercontent.com/EaseCation/netease-modsdk-wiki/main/docs/mcdocs/1-ModAPI/...",
    prompt="提取NotifyToClient的参数说明和使用示例"
)

# 示例2：查询NBT结构
WebFetch(
    url="https://raw.githubusercontent.com/Bedrock-OSS/bedrock-wiki/main/docs/nbt/...",
    prompt="提取物品NBT的字段定义和示例"
)
```

**⚠️ 重要提示**：
- 优先查阅本地文档（`markdown/`目录）
- 本地文档不足时，使用WebFetch查阅官方资源
- 将查阅结果记录到核心检查点输出中

---

## 🔍 快速索引

| 问题类型 | 查阅位置 | 行号 |
|---------|---------|------|
| 双端隔离错误 | 开发规范.md | - |
| System生命周期 | 开发规范.md | - |
| 模块导入错误 | 开发规范.md | - |
{{QUICK_INDEX_EXTRA}}

---

## 🔗 关键路径

- **项目根目录**: `{{PROJECT_PATH}}`
{{CORE_PATHS}}

---

## 📝 版本信息

> **文档版本**: 12.0 (集成官方文档查阅)
> **最后更新**: {{CURRENT_DATE}}
> **项目状态**: {{PROJECT_STATUS}}

### v12.0 更新亮点 ⚡

**新增功能**：
- ✅ **官方文档集成**: 支持WebFetch查阅网易MODSDK Wiki
- ✅ **基岩版Wiki集成**: 支持查阅原版NBT/实体/机制
- ✅ **智能文档路由**: 本地不足时自动引导查阅官方资源
- ✅ **完整模板化**: 移除外部项目依赖，完全自包含

**保留优势**：
- ✅ CRITICAL规范前置（前150行）
- ✅ 三步工作流程
- ✅ 三级任务分类
- ✅ 快速索引表
- ✅ 完整文档体系

---

**记住**:
1. 微任务优先，能直接Edit就不创建tasks
2. 默认顺序执行，除非用户要求并行
3. 遵循CRITICAL规范避免90%错误
4. 本地文档不足时，使用WebFetch查阅官方资源
