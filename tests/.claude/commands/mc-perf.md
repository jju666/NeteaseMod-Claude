# 性能分析命令

> 🔍 自动检测MODSDK项目中的性能问题并生成优化建议报告

---

## 你的任务

请对当前MODSDK项目进行全面的性能分析，识别性能瓶颈并提供优化建议。

---

## 🎯 步骤0：理解项目上下文（新增步骤 v18.0）⭐

在开始性能分析前，**必须**先理解本项目的基本情况和特定规范。

### 0.1 读取项目指导文档

```
Read ../../CLAUDE.md
```

**理解目标**：
- 📌 项目基本信息（项目名称、类型、路径）
- 🎯 项目特定规范（性能标准、优化优先级等）
- 📝 项目背景和特殊说明

**输出**（简短总结）：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 步骤0检查点：项目上下文理解
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

项目：tests
类型：{{PROJECT_TYPE}}
性能标准：（如有项目特定性能要求，列出关键点）

⚠️ 确认检查点输出完成后，才能进入性能分析！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 0.2 项目特定性能标准优先级

⚠️ **重要**：如果项目CLAUDE.md中定义了特定的性能标准或优化优先级，**优先遵循项目规范**。

---

## 执行步骤

### 1. 扫描System文件

使用Glob工具扫描所有System文件：

```
behavior_packs/*/scripts/server/*System.py
behavior_packs/*/scripts/client/*System.py
```

### 2. 检测性能问题

针对每个System文件，使用Read工具读取内容，检测以下性能问题：

#### 问题1：缺少RegisterView 🔴 CRITICAL
- **检测方法**：搜索`RegisterView`关键词
- **判断标准**：如果System有`Update()`方法但没有`RegisterView`调用
- **影响**：每帧遍历所有实体，性能极差
- **优先级**：CRITICAL

#### 问题2：高频Update操作 🟠 HIGH
- **检测方法**：分析`Update()`方法中的逻辑复杂度
- **判断标准**：
  - 包含复杂循环（嵌套for）
  - 调用耗时API（数据库查询、文件I/O）
  - 缺少节流机制（tick_counter）
- **影响**：CPU占用高，游戏卡顿
- **优先级**：HIGH

#### 问题3：高频网络RPC 🟠 HIGH
- **检测方法**：检查`Update()`中是否调用`NotifyToServer`/`NotifyToClient`
- **判断标准**：每帧或高频率（>10次/秒）发送RPC
- **影响**：网络拥塞，延迟高
- **优先级**：HIGH

#### 问题4：缺少Destroy方法 🟡 MEDIUM
- **检测方法**：搜索`def Destroy`
- **判断标准**：System有事件监听但没有Destroy方法
- **影响**：内存泄漏
- **优先级**：MEDIUM

#### 问题5：频繁创建EventData 🟡 MEDIUM
- **检测方法**：检查`CreateEventData()`调用频率
- **判断标准**：在循环中重复调用
- **影响**：性能下降
- **优先级**：MEDIUM

### 3. 生成性能报告

以Markdown格式生成报告，包含：

```markdown
# 性能分析报告

**项目名称**：tests
**分析时间**：2025-11-15
**分析文件数**：[总数]

---

## 执行摘要

- ✅ 无问题的System：[数量]
- 🔴 CRITICAL问题：[数量]
- 🟠 HIGH问题：[数量]
- 🟡 MEDIUM问题：[数量]

**总体评分**：[A/B/C/D]

---

## 详细问题清单

### 🔴 CRITICAL 问题

#### 1. [System名称] - 缺少RegisterView

**文件**：[文件路径]
**行号**：[行号]

**问题描述**：
System有Update()方法但未使用RegisterView，导致每帧遍历所有实体。

**代码片段**：
```python
[有问题的代码]
```

**优化建议**：
```python
[优化后的代码]
```

**预期性能提升**：100倍

---

### 🟠 HIGH 问题

[同上格式]

---

### 🟡 MEDIUM 问题

[同上格式]

---

## 优化建议总结

1. **立即修复（CRITICAL）**：
   - [ ] [System1]：添加RegisterView
   - [ ] [System2]：添加RegisterView

2. **高优先级（HIGH）**：
   - [ ] [System3]：在Update中添加节流
   - [ ] [System4]：减少RPC调用频率

3. **中优先级（MEDIUM）**：
   - [ ] [System5]：添加Destroy方法
   - [ ] [System6]：优化EventData创建

---

## 性能基准测试建议

建议在优化前后进行以下测试：

1. **服务器TPS测试**
   - 优化前：[预测值]
   - 优化后目标：≥18 TPS

2. **内存占用测试**
   - 优化前：[预测值]
   - 优化后目标：<500MB（100玩家）

3. **网络延迟测试**
   - 优化前：[预测值]
   - 优化后目标：<50ms

---

## 参考文档

- [性能优化完整指南.md](./markdown/性能优化完整指南.md)
- [反模式识别清单.md](./markdown/反模式识别清单.md)
- [问题排查.md](./markdown/问题排查.md) - 问题12-15

---

**分析工具版本**：v1.0
**AI助手**：Claude Code
```

### 4. 输出报告

将报告输出到用户，并询问是否需要：
1. 自动修复CRITICAL问题
2. 生成详细优化代码
3. 创建性能测试脚本

---

## 重要提示

- ⚠️ 这是只读分析，不会修改任何代码
- ⚠️ 如果需要自动修复，请明确确认
- ⚠️ 优化建议基于MODSDK最佳实践
- ⚠️ 性能提升数据为理论估算值

---

## 相关文档

### 步骤0.5：项目文档结构扫描（v18.0 智能路由）⭐

在分析前，先扫描项目文档结构，确定查阅优先级：

```bash
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 项目文档结构扫描（性能分析用）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 1. 扫描项目性能相关文档
perf_guide=$(find ../../markdown -maxdepth 2 \( -name "*性能*.md" -o -name "*优化*.md" -o -name "*PERFORMANCE*.md" \) 2>/dev/null | head -1)
if [ -n "$perf_guide" ]; then
    echo "  ✅ 项目性能文档: $perf_guide"
fi

# 2. 扫描项目规范文档
dev_guide=$(find ../../markdown -maxdepth 2 \( -name "*开发规范*.md" -o -name "*规范*.md" \) 2>/dev/null | head -1)
if [ -n "$dev_guide" ]; then
    echo "  ✅ 项目开发规范: $dev_guide"
fi

echo ""
echo "📋 文档查阅优先级："
echo "  1️⃣ P0 - 项目CLAUDE.md + 项目性能文档（优先）"
echo "  2️⃣ P1 - 上游性能指南（补充）"
echo "  3️⃣ P2 - 问题排查文档（参考）"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
```

### 智能文档查阅（基于扫描结果）

请按以下优先级查阅性能相关文档：

**第一优先**：项目性能文档（如存在）
- 项目性能优化指南（基于步骤0.5扫描结果，如`../../markdown/custom/性能优化.md`）
- 项目开发规范（性能相关章节）

**第二优先**：上游性能指南（补充标准）
- `.claude/core-docs/深度指南/性能优化完整指南.md`
- `.claude/core-docs/深度指南/反模式识别清单.md`
- `.claude/core-docs/核心工作流文档/开发规范.md`（性能相关CRITICAL规范）

**第三优先**：问题排查文档（参考案例）
- `.claude/core-docs/核心工作流文档/问题排查.md`（问题12-15：性能问题）
