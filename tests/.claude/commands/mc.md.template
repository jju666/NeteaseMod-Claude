# /mc - MODSDK标准工作流

> **版本**: v3.0 Final - 完整4步语义化状态机
> **设计理念**: Hook驱动 + 差异化流程 + 用户主导

---

## 📋 快速开始

```bash
/mc <任务描述>
```

**示例**：
{{EXAMPLE_TASKS}}

---

## 🎯 v3.0核心架构

### 完整4步语义化状态机

```
Activation (激活) - 任务类型识别
    ↓ (自动推进)
Planning (方案) - 差异化流程
    ├─ BUG修复: 定位问题 + 专家审查
    └─ 功能设计: 文档研究 + 玩法包匹配
    ↓ (用户确认方案)
Implementation (实施) - 轮次循环
    ├─ 修改代码
    ├─ Stop Hook: 展示摘要,等待反馈
    ├─ "已修复" → Finalization
    ├─ "没修复" → Planning（重新设计）
    └─ "继续" → 下一轮Implementation
    ↓ (用户确认完成)
Finalization (收尾) - 子代理执行
    ├─ 文档更新
    ├─ DEBUG清理
    └─ 任务归档
```

### Hook驱动原则

**工作流完全由Hook驱动，AI无法跳过任何强制阶段**：

1. **PreToolUse拦截** - 在AI执行工具之前进行四层验证，不满足条件直接阻断
2. **差异化流程** - BUG修复vs功能设计使用不同的验证规则
3. **用户主导** - 关键转移点（Planning→Implementation, Implementation→Finalization）需要用户显式确认
4. **轮次边界** - Stop Hook在每轮结束时触发，强制用户反馈

---

## 🔄 当前阶段规则

### 📌 Activation: 任务激活（自动完成）

**此阶段由系统自动完成，AI无需关注**。

系统会根据任务描述中的关键词识别任务类型：
- **BUG修复任务**: 包含"BUG"、"修复"、"错误"等关键词
- **功能设计任务**: 包含"实现"、"添加"、"功能"等关键词

识别完成后，系统自动推进到Planning阶段。

---

### 📝 Planning: 方案制定（差异化流程）

#### 🐛 BUG修复流程

**当前状态**: Planning阶段 - BUG修复任务

**允许的工具**:
- ✅ Read - 阅读代码
- ✅ Grep - 搜索相关实现
- ✅ Glob - 查找文件
- ✅ Task - 启动专家审查子代理（自动触发）

**禁止的工具**（PreToolUse会拦截）:
- ❌ Write - 严禁创建文件
- ❌ Edit - 严禁修改文件
- ❌ Bash - 禁止执行命令

**文档要求**:
- **BUG修复无需强制查阅文档**（可选）
- 可以直接使用Read/Grep定位问题代码

**工作流程**:
1. **定位问题**: 使用Read/Grep/Glob定位问题代码位置
2. **制定方案**: 描述修复方案（文本形式，不修改代码）
3. **专家审查**: 系统自动启动专家审查子代理，检查方案合规性
4. **调整方案**: 如专家审查未通过，根据建议调整方案
5. **用户确认**: 向用户展示最终方案，等待用户确认（输入"同意"/"可以"）

**完成条件**:
用户输入确认关键词：
- "同意"、"可以"、"OK"、"好的"、"开始实施"

---

#### ⭐ 功能设计流程

**当前状态**: Planning阶段 - 功能设计任务

**允许的工具**:
- ✅ Read - 阅读文档和代码
- ✅ Grep - 搜索相关实现
- ✅ Glob - 查找文件
- ✅ Task - 启动文档查询子代理（可选）

**禁止的工具**（PreToolUse会拦截）:
- ❌ Write - 严禁创建文件
- ❌ Edit - 严禁修改文件
- ❌ Bash - 禁止执行命令

**文档要求**:
- **功能设计强制查阅≥3个文档**
- 理解API使用方法和CRITICAL规范约束

**工作流程**:
1. **文档研究**: 查阅至少3个相关文档（CRITICAL规范、API文档等）
2. **玩法包匹配**: 系统推荐相似玩法包，可参考实现（可选）
3. **制定方案**: 描述功能设计（文本形式，不修改代码）
4. **用户确认**: 向用户展示设计方案，等待用户确认（输入"同意"/"可以"）

**完成条件**:
用户输入确认关键词：
- "同意"、"可以"、"OK"、"好的"、"开始实施"

---

**PreToolUse拦截示例**（Planning阶段尝试Write/Edit）:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⛔ 工具调用被拒绝
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
当前阶段: 📝 方案制定
尝试工具: Write
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 拒绝原因:
方案制定阶段严禁修改任何文件

✅ 正确做法:
1. 先完成方案制定（文本描述）
2. 等待用户确认方案
3. 推进到Implementation阶段后才能修改代码

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 工作流强制执行 - 违规操作已被阻止
请按照上述"正确做法"继续操作
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### ⚙️ Implementation: 代码实施（轮次循环）

**前置条件**:
- Planning阶段已完成
- 用户已确认方案

**允许的工具**:
- ✅ Read/Write/Edit - 修改代码
- ✅ Bash - 执行测试
- ✅ Grep/Glob - 继续查阅
- ✅ WebFetch/WebSearch - 查询资料

**禁止的工具**:
- ❌ 修改.task-meta.json等元数据
- ❌ 执行危险Bash命令（rm -rf /等）

**轮次循环流程**:

```
┌─────────────────────────────────────┐
│ 1. AI修改代码（可能多次Write/Edit） │
│    PostToolUse记录每次修改          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 2. AI完成修改，准备Stop              │
│    Stop Hook触发（轮次边界）         │
│    ├─ 主动等待PostToolUse完成       │
│    ├─ 轮次计数器+1                  │
│    ├─ 汇总本轮所有代码修改          │
│    ├─ 向用户展示修改摘要            │
│    ├─ decision="block" 阻止会话结束 │
│    └─ 要求用户测试并反馈            │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 3. 用户反馈（UserPromptSubmit）     │
│    ├─ "已修复"/"修复完成"           │
│    │    → 推进到Finalization       │
│    ├─ "没修复"/"需要调整"           │
│    │    → 回到Planning重新设计     │
│    ├─ "继续"                        │
│    │    → 保持Implementation,下一轮│
│    └─ 其他反馈                      │
│         → AI继续优化               │
└─────────────────────────────────────┘
```

**Stop Hook示例输出**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 第 1 轮修改完成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

本轮修改文件:
  - behavior_packs/main.py (新增onPlayerDeath事件处理)
  - behavior_packs/utils.py (修复物品掉落逻辑)

代码修改摘要:
  - 新增2个文件
  - 修改1个文件
  - 共23行代码变更

⚠️ 请测试修改是否符合预期！

**下一步**:
1. 测试修改效果
2. 反馈测试结果:
   - "已修复" → 进入收尾归档
   - "没修复" → 继续调整
   - "需要重新设计" → 回到方案制定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### 📦 Finalization: 收尾归档（子代理执行）

**前置条件**:
- Implementation阶段已完成
- 用户已确认修复完成

**父代理规则**:

**允许的工具**:
- ✅ Task - 启动收尾子代理
- ✅ Read - 读取元数据

**禁止的工具**:
- ❌ Write - 禁止直接Write（必须通过子代理）
- ❌ Edit - 禁止直接Edit（必须通过子代理）
- ❌ Bash - 禁止执行Bash命令

**工作流程**:
1. 父代理启动收尾子代理（使用Task工具）
2. 子代理执行:
   - 删除DEBUG代码（print/console.log等）
   - 更新文档（如需要）
   - 更新.task-meta.json标记完成
3. 系统自动归档任务到tasks/<task_id>/目录

**PreToolUse拦截示例**（Finalization阶段父代理尝试Write）:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⛔ 工具调用被拒绝
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
当前阶段: 📦 收尾归档
尝试工具: Write
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 拒绝原因:
父代理禁止直接Write，必须通过子代理

✅ 正确做法:
使用Task工具启动收尾子代理:
  - 任务描述: "文档更新和代码收尾"
  - 子代理类型: general-purpose

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 工作流强制执行 - 违规操作已被阻止
请按照上述"正确做法"继续操作
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🎨 用户交互指南

### 确认方案（Planning → Implementation）

当AI向你展示方案时，你可以：

- ✅ **同意方案**: 输入"同意"、"可以"、"OK"
  - 系统推进到Implementation阶段，AI开始修改代码

- ❌ **拒绝方案**: 输入"不对"、"不行"、"重来"
  - 系统回到Activation阶段，重新识别任务

- 💬 **提供建议**: 输入其他反馈
  - AI根据你的建议优化方案，再次展示给你确认

### 反馈修改结果（Implementation轮次循环）

每轮修改后Stop Hook会展示摘要，你需要反馈：

- ✅ **修复完成**: 输入"已修复"、"修复完成"、"好了"
  - 系统推进到Finalization阶段，启动收尾子代理

- ❌ **没修复**: 输入"没修复"、"不对"、"需要调整"
  - 系统回到Planning阶段，重新设计方案

- 🔄 **继续修改**: 输入"继续"、"再试试"
  - 系统保持Implementation阶段，AI开始下一轮修改

- 💬 **提供详细反馈**: 描述具体问题
  - AI根据你的反馈优化代码，继续修改

---

## 🛠️ 高级功能

### 专家审查（BUG修复自动触发）

BUG修复任务在Planning阶段完成后，系统会自动启动专家审查子代理：
- 检查方案是否违反CRITICAL规范
- 提供改进建议
- 如未通过审查，AI会根据建议调整方案

### 玩法包匹配（功能设计推荐）

功能设计任务在Planning阶段，系统会推荐相似的玩法包：
- 提供完整代码参考
- 降低文档查阅要求（2个文档即可）
- 加速开发流程

### 轮次超限专家审查

Implementation阶段如果超过限定轮次（BUG修复3轮，功能设计5轮），系统会：
- 自动触发专家审查子代理
- 分析问题根因
- 提供深度优化建议

---

## 📐 核心设计理念

### 1. Hook驱动 > AI自主

**PreToolUse拦截 > PostToolUse提示**
- 在AI执行工具之前验证，而不是执行后提示
- 违规操作100%阻断，零容忍

### 2. 用户主导 > AI推进

**关键转移点需要用户确认**
- Planning → Implementation: 用户确认方案
- Implementation → Finalization: 用户确认修复完成
- Implementation → Planning: 用户反馈"需要调整"

### 3. 差异化 > 统一流程

**BUG修复 vs 功能设计使用不同规则**
- BUG修复: 无强制文档 + 自动专家审查
- 功能设计: 强制3个文档 + 玩法包匹配

### 4. 轮次边界 > 连续执行

**Stop Hook强制用户反馈**
- 每轮结束阻止会话，展示摘要
- 用户必须反馈才能继续
- 防止AI无限循环修改

---

## 🚀 快速参考

| 阶段 | 允许工具 | 完成条件 | 推进方式 |
|------|---------|---------|---------|
| Activation | 无（自动） | 任务类型识别 | 自动推进 |
| Planning | Read/Grep/Glob/Task | 用户确认方案 | 用户输入"同意" |
| Implementation | Read/Write/Edit/Bash/等 | 用户确认修复 | 用户输入"已修复" |
| Finalization | Task/Read（父代理） | 子代理完成 | 自动归档 |

---

**版本**: v3.0 Final
**最后更新**: 2025-11-15
**架构**: 完整4步语义化状态机 + 差异化流程 + Hook驱动
