# Finalization Stage Rules - æ”¶å°¾å½’æ¡£é˜¶æ®µè§„åˆ™
# Version: v3.0 Final
# å¼ºåˆ¶å­ä»£ç†æ‰§è¡Œï¼šçˆ¶ä»£ç†åªèƒ½å¯åŠ¨Taskï¼Œå­ä»£ç†æ‰§è¡Œå®é™…æ”¶å°¾å·¥ä½œ

display_name: "æ”¶å°¾å½’æ¡£"
description: "æ–‡æ¡£æ›´æ–°ã€DEBUGæ¸…ç†ã€ä»»åŠ¡å½’æ¡£ï¼ˆå¼ºåˆ¶å­ä»£ç†æ‰§è¡Œï¼‰"

# å…è®¸çš„å·¥å…·åˆ—è¡¨ï¼ˆçˆ¶ä»£ç†ï¼‰
allowed_tools:
  - "Task"  # çˆ¶ä»£ç†åªèƒ½å¯åŠ¨å­ä»£ç†
  - "Read"  # çˆ¶ä»£ç†å¯ä»¥è¯»å–å…ƒæ•°æ®

# å‰ç½®æ¡ä»¶
preconditions:
  - "planning_completed"  # planningé˜¶æ®µå·²å®Œæˆ
  - "user_confirmed"  # ç”¨æˆ·å·²ç¡®è®¤ä¿®å¤å®Œæˆ

# è·¯å¾„è§„åˆ™ï¼ˆçˆ¶ä»£ç†ï¼‰
path_rules:
  Task:
    required_params:
      subagent_type: "general-purpose"
      description_pattern: ".*æ–‡æ¡£æ›´æ–°.*æ”¶å°¾.*"
    description: "çˆ¶ä»£ç†åªèƒ½é€šè¿‡Taskå·¥å…·å¯åŠ¨æ”¶å°¾å­ä»£ç†"

  Read:
    whitelist:
      - ".claude/.agent-doc-update.txt"
      - ".task-meta.json"
      - "tasks/**/*.json"
    description: "çˆ¶ä»£ç†å¯ä»¥è¯»å–å­ä»£ç†ä»»åŠ¡æè¿°å’Œå…ƒæ•°æ®"

# è¯­ä¹‰è§„åˆ™ï¼ˆçˆ¶ä»£ç†ï¼‰
semantic_rules:
  Task:
    purpose: "launch_cleanup_subagent"
    max_launches: 1  # åªèƒ½å¯åŠ¨ä¸€æ¬¡æ”¶å°¾å­ä»£ç†
    creates_lock: true  # åˆ›å»º.cleanup-subagent.locké”æ–‡ä»¶
    description: "å¯åŠ¨æ”¶å°¾å­ä»£ç†ï¼Œåˆ›å»ºé”æ–‡ä»¶"

  Write:
    forbidden_in_parent: true
    reason: "çˆ¶ä»£ç†ç¦æ­¢ç›´æ¥Writeï¼Œå¿…é¡»é€šè¿‡å­ä»£ç†"

  Edit:
    forbidden_in_parent: true
    reason: "çˆ¶ä»£ç†ç¦æ­¢ç›´æ¥Editï¼Œå¿…é¡»é€šè¿‡å­ä»£ç†"

  Bash:
    forbidden_in_parent: true
    reason: "çˆ¶ä»£ç†ç¦æ­¢æ‰§è¡ŒBashå‘½ä»¤"

# å­ä»£ç†è§„åˆ™ï¼ˆæ£€æµ‹åˆ°.cleanup-subagent.lockåç”Ÿæ•ˆï¼‰
subagent_rules:
  allowed_tools:
    - "Read"
    - "Write"
    - "Edit"
    - "Grep"
    - "Glob"

  path_rules:
    Write:
      whitelist:
        - ".task-meta.json"
        - "markdown/**/*.md"
        - "docs/**/*.md"
        - "tasks/**/*.json"
      description: "å­ä»£ç†å¯ä»¥æ›´æ–°å…ƒæ•°æ®å’Œæ–‡æ¡£"

    Edit:
      whitelist_patterns:
        - "markdown/**/*.md"
        - "docs/**/*.md"
        - "behavior_packs/**/*.py"
        - "resource_packs/**/*.json"
        - "scripts/**/*.js"
        - "scripts/**/*.py"
      blacklist_patterns:
        - "**/test_*.py"  # ä¸åˆ é™¤æµ‹è¯•æ–‡ä»¶
      description: "å­ä»£ç†å¯ä»¥ç¼–è¾‘æ–‡æ¡£å’Œæ¸…ç†DEBUGä»£ç "

  semantic_rules:
    Write:
      purpose: "update_metadata_and_docs"
      required_updates:
        ".task-meta.json":
          field: "steps.finalization.status"
          value: "completed"
          description: "å­ä»£ç†å¿…é¡»æ ‡è®°finalizationä¸ºcompleted"

    Edit:
      purpose: "cleanup_debug_code"
      allowed_modifications:
        - "åˆ é™¤printè¯­å¥"
        - "åˆ é™¤console.log"
        - "åˆ é™¤ä¸´æ—¶DEBUGä»£ç "
        - "æ›´æ–°æ–‡æ¡£æ³¨é‡Š"
      forbidden_modifications:
        - "ä¿®æ”¹ä¸šåŠ¡é€»è¾‘"
        - "åˆ é™¤æµ‹è¯•æ–‡ä»¶"

  ai_guidance: |
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“¦ æ”¶å°¾å­ä»£ç†ä»»åŠ¡
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    **ä½ çš„ä»»åŠ¡**ï¼ˆå­ä»£ç†ï¼‰ï¼š

    1. **æ¸…ç†DEBUGä»£ç **ï¼š
       - åˆ é™¤æ‰€æœ‰printè¯­å¥ï¼ˆPythonï¼‰
       - åˆ é™¤æ‰€æœ‰console.logï¼ˆJavaScriptï¼‰
       - åˆ é™¤ä¸´æ—¶DEBUGä»£ç 
       - âš ï¸ ä¸è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
       - âš ï¸ ä¸è¦åˆ é™¤æµ‹è¯•æ–‡ä»¶

    2. **æ›´æ–°æ–‡æ¡£**ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
       - æ›´æ–°README.md
       - æ›´æ–°æŠ€æœ¯æ–‡æ¡£
       - æ·»åŠ ä½¿ç”¨è¯´æ˜

    3. **æ›´æ–°å…ƒæ•°æ®**ï¼ˆå¿…é¡»ï¼‰ï¼š
       - æ ‡è®° finalization.status = "completed"
       - è®°å½•ä¿®æ”¹æ‘˜è¦
       - æ›´æ–°æ—¶é—´æˆ³

    **å®Œæˆå**ï¼š
    ç³»ç»Ÿå°†è‡ªåŠ¨å½’æ¡£ä»»åŠ¡åˆ° tasks/<task_id>/ ç›®å½•ã€‚

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# å®Œæˆæ¡ä»¶
completion_condition:
  type: "subagent_completion"
  trigger_expr: "steps.finalization.status == 'completed'"
  auto_advance: false
  next_step: null  # æœ€åä¸€æ­¥ï¼Œæ— next_step
  description: "å­ä»£ç†æ ‡è®°finalization.status=completedåï¼Œpost-archive-hookè‡ªåŠ¨å½’æ¡£ä»»åŠ¡"

# AIå¼•å¯¼æç¤ºï¼ˆçˆ¶ä»£ç†ï¼‰
ai_guidance: |
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ“¦ å½“å‰é˜¶æ®µ: æ”¶å°¾å½’æ¡£ï¼ˆFinalizationï¼‰
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  **çˆ¶ä»£ç†ä»»åŠ¡**ï¼š

  ä½ å¿…é¡»å¯åŠ¨æ”¶å°¾å­ä»£ç†æ¥å®Œæˆæœ€åçš„å·¥ä½œï¼š

  1. **å¯åŠ¨å­ä»£ç†**ï¼š
     ```
     ä½¿ç”¨Taskå·¥å…·å¯åŠ¨general-purposeå­ä»£ç†
     ä»»åŠ¡æè¿°ï¼šæ–‡æ¡£æ›´æ–°å’Œä»£ç æ”¶å°¾
     ```

  2. **ç¦æ­¢ç›´æ¥æ“ä½œ**ï¼š
     - âŒ ç¦æ­¢ç›´æ¥Write/Editæ–‡ä»¶
     - âŒ ç¦æ­¢æ‰§è¡ŒBashå‘½ä»¤
     - âœ… åªèƒ½é€šè¿‡Taskå¯åŠ¨å­ä»£ç†

  3. **ç­‰å¾…å­ä»£ç†å®Œæˆ**ï¼š
     - å­ä»£ç†å°†è‡ªåŠ¨æ‰§è¡Œæ”¶å°¾å·¥ä½œ
     - å®Œæˆåç³»ç»Ÿè‡ªåŠ¨å½’æ¡£ä»»åŠ¡

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# å½’æ¡£é…ç½®
archiving:
  enabled: true
  archive_path: "tasks/{task_id}/"
  archive_contents:
    - ".task-meta.json"
    - ".task-meta.json.backup"
    - ".conversation.jsonl"
    - "code_changes.log"
  cleanup_after_archive:
    - ".task-active.json"
    - ".cleanup-subagent.lock"
  description: "å½’æ¡£ä»»åŠ¡åˆ°tasksç›®å½•ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶"
