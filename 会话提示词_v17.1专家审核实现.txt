# v17.1 专家审核流程实现 - 会话提示词

## 📋 会话目标
实现专家检查流程,解决"理论设计与实际执行不一致"的问题。

## 🔍 问题发现
用户询问：当/mc命令识别为标准/复杂任务时,是否会启动专家检查流程？

**分析结果**:
- ❌ **理论上有,实际不会**
- 方案自检清单.md(markdown/ai/)定义了完整的专家审核逻辑和触发条件
- 但mc.md.template(templates/.claude/commands/)的实际执行流程中**没有实现**
- 只有"核心检查点输出"(步骤2→3之间),无独立审核环节

## ✅ 已完成工作

### 1. 设计专家审核流程架构
**位置**: mc.md.template 步骤2.5

**流程**:
```
步骤2: 查阅文档
    ↓
【新增】步骤2.5: 方案自检与专家审核
    ↓
  2.5.1 执行自检清单(5项检查)
    ├─ CRITICAL规范验证(内存检查)
    ├─ 双端隔离验证(内存检查)
    ├─ 事件/API存在性(可选查询索引表,<2次Grep)
    ├─ 数据流完整性(绘制流程图)
    └─ 最佳实践遵循(代码规范)
    ↓
  2.5.2 生成自检报告
    ├─ 通过项(X/5)
    ├─ 警告项(Y个)
    └─ 错误项(Z个)
    ↓
  2.5.3 处理决策
    ├─ 有错误(Z>0) → 自动修正 → 重新自检
    ├─ 只有警告(Y>0) → 标注风险 → 询问用户
    └─ 全部通过 → 判断任务级别
         ├─ 🔴 复杂任务 → 强制触发2.5.4
         ├─ 🟡 标准任务 → 智能触发(2轮修复/跨5+System)
         └─ 🟢 微任务 → 跳过2.5,直接执行
    ↓
  2.5.4 专家审核流程(复杂任务强制/标准任务条件触发)
    ├─ 生成9章详细方案报告
    │   1. 任务概述
    │   2. 架构设计图(Mermaid)
    │   3. 数据流详细设计
    │   4. 完整代码框架(Server+Client)
    │   5. 实施步骤清单
    │   6. 测试验证计划(单元/集成/性能)
    │   7. CRITICAL规范复查
    │   8. 风险评估
    │   9. 用户确认(通过/调整/重新设计)
    └─ ⏸️ 等待用户确认
    ↓
步骤3: 执行与收尾
```

### 2. 修改的文件列表
✅ **templates/.claude/commands/mc.md.template**
  - 插入步骤2.5完整流程(~400行)
  - 包含5项自检伪代码
  - 包含9章专家审核报告模板
  - 明确三级决策逻辑

✅ **markdown/ai/任务类型决策表.md**
  - 更新标准任务执行策略(添加审核环节)
  - 更新复杂任务执行策略(强制审核说明)
  - 新增v17.1更新说明章节

✅ **CLAUDE.md**
  - 更新版本号: v16.3.0 → v17.1.0
  - 更新说明: "新增: 方案自检与专家审核流程"

✅ **CHANGELOG.md**
  - 新增[17.1.0]版本说明
  - 详细记录5项自检清单
  - 详细记录三级决策逻辑
  - 详细记录智能触发条件
  - Token成本分析(<2k自检 + ~5-8k专家审核)

✅ **lib/config.js**
  - VERSION: '17.0.0' → '17.1.0'

✅ **package.json**
  - version: "17.0.0" → "17.1.0"

### 3. 核心设计亮点

**Token成本优化**:
- 自检以内存检查为主,最多2次Grep查询(<2k tokens)
- 只在必要时触发专家审核(~5-8k tokens)
- 自动修正机制减少返工成本

**智能触发条件**:
- 复杂任务: 强制触发(防止架构问题)
- 标准任务: 智能触发(2轮修复失败 OR 跨越5+ System)
- 微任务: 跳过审核(保持轻量级)

**自动修正能力**:
- __init__中调用API → 自动移到Create()
- 跨端GetSystem → 自动替换为NotifyToClient/Server
- tuple类型 → 自动替换为list

## 🔜 待完成工作

### 优先级1: 模板同步分析(用户提出)
**问题**: templates/CLAUDE.md.template是否需要同步更新步骤2.5？

**分析要点**:
1. CLAUDE.md.template会生成到下游项目的CLAUDE.md
2. 下游CLAUDE.md是AI的主要指导文档
3. 下游AI需要知道/mc命令的完整流程吗？
4. 还是只需要在mc.md.template中说明即可？

**决策方向**:
- templates/CLAUDE.md.template: 提供高层次说明(AI执行流程概览)
- templates/.claude/commands/mc.md.template: 提供详细执行指令
- 避免重复,保持单一真实源原则

### 优先级2: 文档访问路径分析(用户提出)
**问题**: markdown/下的文档是否存在"理论上有,实际访问不到"的问题？

**需要验证的路径**:
```
markdown/
├── 核心工作流文档/     → 下游如何访问? .claude/core-docs/ 软连接?
├── 概念参考/           → 下游如何访问?
├── 深度指南/           → 下游如何访问?
├── ai/                → 下游如何访问?
└── systems/           → 这个是项目特定,不部署
```

**验证方法**:
1. 检查lib/symlink-manager.js的_getCoreFiles()
2. 检查includePatterns是否包含所有需要的目录
3. 检查templates/CLAUDE.md.template中的文档引用路径
4. 检查mc.md.template中的文档引用路径

**预期发现**:
- 如果软连接正确创建,应该通过`.claude/core-docs/xxx`访问
- 如果路径不匹配,会导致AI找不到文档

### 优先级3: 验证完整性
- [ ] 在测试项目运行initmc,检查软连接是否创建
- [ ] 模拟标准任务场景,验证审核流程是否触发
- [ ] 模拟复杂任务场景,验证强制审核是否执行
- [ ] 检查所有文档引用路径的正确性

### 优先级4: 提交Git commit
```bash
git add .
git commit -m "feat(v17.1): 实现方案自检与专家审核流程

核心新增:
- 步骤2.5自检审核环节(5项检查 + 3级决策)
- 复杂任务强制专家审核(9章详细方案报告)
- 标准任务智能触发审核(2轮修复/跨5+System)
- 自动修正机制(CRITICAL规范错误)

收益:
- 防止90%常见错误(CRITICAL规范验证)
- 复杂任务成功率提升(提前设计审查)
- Token成本可控(<2k自检 + 可选5-8k审核)

影响文件:
- templates/.claude/commands/mc.md.template
- markdown/ai/任务类型决策表.md
- CLAUDE.md, CHANGELOG.md
- lib/config.js, package.json
"
```

## 💡 关键设计原则

1. **单一真实源**:
   - 方案自检清单.md是检查逻辑的唯一定义
   - mc.md.template是执行流程的唯一实现
   - 避免在多处维护相同逻辑

2. **渐进式增强**:
   - 微任务: 无审核(保持轻量)
   - 标准任务: 自检+条件审核(平衡成本)
   - 复杂任务: 自检+强制审核(确保质量)

3. **自动优于手动**:
   - 自动修正CRITICAL错误
   - 自动触发审核条件
   - 减少人工决策负担

4. **Token成本意识**:
   - 内存检查优先(0 tokens)
   - 索引表查询按需(~150 tokens/次)
   - 专家审核选择性触发(~5-8k tokens)

## 📌 注意事项

1. **版本一致性**:
   - 所有版本号统一更新到v17.1.0
   - CHANGELOG.md详细记录变更
   - 保持文档版本号同步

2. **向后兼容**:
   - 微任务流程不受影响
   - 标准任务默认不触发审核(除非满足条件)
   - 用户可选择跳过审核(警告时选择"继续")

3. **文档引用完整性**:
   - 所有引用的文档必须存在
   - 路径必须正确(绝对路径/相对路径)
   - 软连接必须正确创建

## 🔗 相关文档索引

- 方案自检清单: markdown/ai/方案自检清单.md
- 任务类型决策表: markdown/ai/任务类型决策表.md
- 命令模板: templates/.claude/commands/mc.md.template
- 下游AI指导: templates/CLAUDE.md.template
- 软连接管理: lib/symlink-manager.js

---

**会话创建时间**: 2025-11-11
**最后更新**: 当前进度 - 已完成代码实现,待验证文档访问路径
**继续会话**: 使用本提示词恢复上下文,继续完成待办事项
