# å­ä»£ç†ç»“æœæ³¨å…¥ä¸æå– - å®Œæ•´å®ç°æŒ‡å—

> **ç‰ˆæœ¬**: v22.3.11
> **å®Œæˆæ—¶é—´**: 2025-11-17
> **çŠ¶æ€**: âœ… æµ‹è¯•é€šè¿‡ï¼Œç”Ÿäº§å¯ç”¨

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
3. [å®Œæ•´è§£å†³æ–¹æ¡ˆ](#å®Œæ•´è§£å†³æ–¹æ¡ˆ)
4. [æ ¸å¿ƒä»£ç å®ç°](#æ ¸å¿ƒä»£ç å®ç°)
5. [è°ƒè¯•æŠ€å·§](#è°ƒè¯•æŠ€å·§)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
7. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## æ¦‚è¿°

### ç›®æ ‡

åœ¨ BUG ä¿®å¤å·¥ä½œæµçš„ `planning` é˜¶æ®µï¼Œè‡ªåŠ¨å¯åŠ¨ä¸“å®¶å®¡æŸ¥å­ä»£ç†ï¼ˆTask toolï¼‰ï¼Œè¦æ±‚å­ä»£ç†è¾“å‡ºç»“æ„åŒ–çš„å®¡æŸ¥ç»“æœï¼Œå¹¶åœ¨å­ä»£ç†å®Œæˆåè‡ªåŠ¨æå–ç»“æœå¹¶æ›´æ–°ä»»åŠ¡å…ƒæ•°æ®ã€‚

### å…³é”®æŒ‘æˆ˜

1. **å­ä»£ç†æ ¼å¼çº¦æŸ**ï¼šå­ä»£ç†æ˜¯ LLMï¼Œæ— æ³• 100% ä¿è¯éµå¾ªæ ¼å¼è¦æ±‚
2. **ç»“æœæå–**ï¼šClaude Code å®˜æ–¹æ–‡æ¡£æœªæ˜ç¡®è¯´æ˜å¦‚ä½•æå–å­ä»£ç†è¿”å›ç»“æœ
3. **å­—æ®µæ··æ·†**ï¼šSubagentStop Hook çš„ `transcript_path` å®é™…æŒ‡å‘çˆ¶ä¼šè¯ï¼Œéœ€è¦ä½¿ç”¨æœªè®°å½•çš„ `agent_transcript_path` å­—æ®µ

### è§£å†³æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çˆ¶ä»£ç†å·¥ä½œæµ                               â”‚
â”‚                                                               â”‚
â”‚  1. Planningé˜¶æ®µ                                              â”‚
â”‚     â”œâ”€ åˆ†æä»£ç                                                â”‚
â”‚     â”œâ”€ åˆ¶å®šä¿®å¤æ–¹æ¡ˆ                                           â”‚
â”‚     â””â”€ è°ƒç”¨Taskå·¥å…·å¯åŠ¨ä¸“å®¶å®¡æŸ¥                               â”‚
â”‚                        â†“                                      â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚        â”‚ PreToolUse Hook (æ‹¦æˆªTask)    â”‚                     â”‚
â”‚        â”‚  - æ£€æµ‹æ˜¯å¦ä¸ºä¸“å®¶å®¡æŸ¥ä»»åŠ¡      â”‚                     â”‚
â”‚        â”‚  - æ³¨å…¥ SUBAGENT_RESULT æ ‡è®°   â”‚                     â”‚
â”‚        â”‚    è¦æ±‚åˆ°å­ä»£ç†çš„ prompt      â”‚                     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                        â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚         å­ä»£ç† (general-purpose)        â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  - æ”¶åˆ°ä¿®æ”¹åçš„ promptï¼ˆåŒ…å«æ ¼å¼è¦æ±‚ï¼‰  â”‚                â”‚
â”‚  â”‚  - æ‰§è¡Œä»£ç å®¡æŸ¥                          â”‚                â”‚
â”‚  â”‚  - è¾“å‡ºåŒ…å« SUBAGENT_RESULT æ ‡è®°çš„ç»“æœ   â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚  è¾“å‡ºæ ¼å¼ï¼š                              â”‚                â”‚
â”‚  â”‚  <!-- SUBAGENT_RESULT                   â”‚                â”‚
â”‚  â”‚  {                                       â”‚                â”‚
â”‚  â”‚    "approved": true/false,              â”‚                â”‚
â”‚  â”‚    "issues": [...],                     â”‚                â”‚
â”‚  â”‚    "suggestions": [...]                 â”‚                â”‚
â”‚  â”‚  }                                       â”‚                â”‚
â”‚  â”‚  -->                                     â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                     â†“                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚        â”‚ SubagentStop Hook             â”‚                     â”‚
â”‚        â”‚  - è¯»å–å­ä»£ç†çš„ transcript    â”‚                     â”‚
â”‚        â”‚    (agent-{agentId}.jsonl)    â”‚                     â”‚
â”‚        â”‚  - è§£æ SUBAGENT_RESULT æ ‡è®°  â”‚                     â”‚
â”‚        â”‚  - æ›´æ–° task-meta.json        â”‚                     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                        â†“                                      â”‚
â”‚  2. ç”¨æˆ·ç¡®è®¤/è°ƒæ•´æ–¹æ¡ˆ                                         â”‚
â”‚  3. Implementationé˜¶æ®µ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—®é¢˜èƒŒæ™¯

### åˆå§‹éœ€æ±‚

åœ¨ v22.0 çŠ¶æ€æœºå·¥ä½œæµä¸­ï¼Œplanning é˜¶æ®µéœ€è¦å¯åŠ¨ä¸“å®¶å®¡æŸ¥å­ä»£ç†å¯¹ä¿®å¤æ–¹æ¡ˆè¿›è¡Œå®¡æŸ¥ï¼Œå¹¶æ ¹æ®å®¡æŸ¥ç»“æœå†³å®šæ˜¯å¦éœ€è¦è°ƒæ•´æ–¹æ¡ˆã€‚

**å…³é”®å…ƒæ•°æ®å­—æ®µ**ï¼š
- `expert_review_count`ï¼šä¸“å®¶å®¡æŸ¥æ¬¡æ•°
- `expert_review_completed`ï¼šæ˜¯å¦å®Œæˆå®¡æŸ¥
- `expert_review_result`ï¼šå®¡æŸ¥ç»“æœï¼ˆ"é€šè¿‡" / "éœ€è¦è°ƒæ•´"ï¼‰
- `expert_review.approved`ï¼šæ˜¯å¦æ‰¹å‡†
- `expert_review.issues`ï¼šå‘ç°çš„é—®é¢˜
- `expert_review.suggestions`ï¼šæ”¹è¿›å»ºè®®

### é‡åˆ°çš„é—®é¢˜

**é—®é¢˜ 1**ï¼šå­ä»£ç†å¯åŠ¨åï¼Œ`expert_review_count` ç­‰å‚æ•°æœªæ›´æ–°

**é—®é¢˜ 2**ï¼šSubagentStop Hook æå–ç»“æœå¤±è´¥ï¼Œå§‹ç»ˆè¿”å› `None`

**é—®é¢˜ 3**ï¼šWindows å¹³å° JSON è§£æå¤±è´¥ï¼ˆä¸­æ–‡å­—ç¬¦ç¼–ç é—®é¢˜ï¼‰

---

## å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. PreToolUse Hook - æ³¨å…¥æ ¼å¼è¦æ±‚

#### æ–‡ä»¶ä½ç½®
`templates/.claude/hooks/orchestrator/pretooluse_enforcer.py`

#### æ ¸å¿ƒé€»è¾‘

```python
def main():
    # 1. Windows UTF-8 ç¼–ç æ”¯æŒï¼ˆå…³é”®ï¼ï¼‰
    if sys.platform == 'win32':
        import io
        sys.stdin = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8')

    # 2. è¯»å– Hook è¾“å…¥
    stdin_content = sys.stdin.read()
    hook_input = json.loads(stdin_content)

    tool_name = hook_input.get('tool_name')
    tool_input = hook_input.get('tool_input', {})

    # 3. æ£€æµ‹ Task å·¥å…·è°ƒç”¨
    if tool_name != 'Task':
        # é Task å·¥å…·ï¼Œç›´æ¥æ”¾è¡Œ
        print(json.dumps({"hookSpecificOutput": {"permissionDecision": "allow"}},
                         ensure_ascii=False))
        return

    # 4. è·å–å½“å‰ä»»åŠ¡çŠ¶æ€
    from core.task_meta_manager import TaskMetaManager
    mgr = TaskMetaManager(os.getcwd())

    session_id = hook_input.get('session_id')
    task_binding = mgr.get_active_task_by_session(session_id)

    if not task_binding:
        # æ— ç»‘å®šä»»åŠ¡ï¼Œæ”¾è¡Œ
        print(json.dumps({"hookSpecificOutput": {"permissionDecision": "allow"}},
                         ensure_ascii=False))
        return

    task_id = task_binding['task_id']
    task_meta = mgr.load_task_meta(task_id)

    current_step = task_meta.get('current_step')
    task_type = task_meta.get('task_type')

    # 5. åˆ¤æ–­æ˜¯å¦éœ€è¦æ³¨å…¥æ ‡è®°
    if current_step == 'planning' and task_type == 'bug_fix':
        # æ£€æŸ¥ prompt æ˜¯å¦åŒ…å«å®¡æŸ¥å…³é”®è¯
        prompt = tool_input.get('prompt', '')
        review_keywords = ['å®¡æŸ¥', 'éªŒè¯', 'review', 'validate']

        if any(keyword in prompt.lower() for keyword in review_keywords):
            # 6. æ³¨å…¥ SUBAGENT_RESULT æ ‡è®°è¦æ±‚
            marker_instruction = """

### ğŸ“‹ å®¡æŸ¥ç»“æœæ ¼å¼è¦æ±‚ï¼ˆCRITICAL - å¿…é¡»éµå¾ªï¼‰

åœ¨å®¡æŸ¥å®Œæˆåï¼Œæ‚¨**å¿…é¡»**åœ¨æœ€ç»ˆå›å¤ä¸­åŒ…å«ä»¥ä¸‹æ ¼å¼çš„ç»“æ„åŒ–ç»“æœï¼š

<!-- SUBAGENT_RESULT
{
  "approved": true/false,
  "issues": ["é—®é¢˜1", "é—®é¢˜2", ...],
  "suggestions": ["å»ºè®®1", "å»ºè®®2", ...]
}
-->

**å­—æ®µè¯´æ˜**ï¼š
- `approved`: å¸ƒå°”å€¼ï¼Œtrue=æ‰¹å‡†é€šè¿‡ï¼Œfalse=éœ€è¦è°ƒæ•´
- `issues`: å­—ç¬¦ä¸²æ•°ç»„ï¼Œå‘ç°çš„æ‰€æœ‰é—®é¢˜ï¼ˆå¦‚æœapproved=trueå¯ä»¥ä¸ºç©ºæ•°ç»„ï¼‰
- `suggestions`: å­—ç¬¦ä¸²æ•°ç»„ï¼Œæ”¹è¿›å»ºè®®ï¼ˆå¦‚æœapproved=trueå¯ä»¥ä¸ºç©ºæ•°ç»„ï¼‰

**æ ¼å¼è¦æ±‚**ï¼š
1. å¿…é¡»ä½¿ç”¨ `<!-- -->` æ³¨é‡ŠåŒ…è£¹
2. æ ‡è®°åå¿…é¡»ä¸º `SUBAGENT_RESULT`
3. JSON å¿…é¡»æœ‰æ•ˆä¸”ç¬¦åˆä¸Šè¿°ç»“æ„
4. æ ‡è®°å¿…é¡»å‡ºç°åœ¨å›å¤çš„æœ€å

**ç¤ºä¾‹ 1ï¼ˆæ‰¹å‡†é€šè¿‡ï¼‰**ï¼š
```
## å®¡æŸ¥ç»“æœ

ç»è¿‡è¯¦ç»†å®¡æŸ¥ï¼Œä¿®å¤æ–¹æ¡ˆç¬¦åˆè§„èŒƒ...

<!-- SUBAGENT_RESULT
{
  "approved": true,
  "issues": [],
  "suggestions": []
}
-->
```

**ç¤ºä¾‹ 2ï¼ˆéœ€è¦è°ƒæ•´ï¼‰**ï¼š
```
## å®¡æŸ¥ç»“æœ

å‘ç°ä»¥ä¸‹é—®é¢˜éœ€è¦è°ƒæ•´...

<!-- SUBAGENT_RESULT
{
  "approved": false,
  "issues": [
    "ç¼ºå°‘è¾¹ç•Œæ¡ä»¶æ£€æŸ¥",
    "é”™è¯¯å¤„ç†ä¸å®Œæ•´"
  ],
  "suggestions": [
    "æ·»åŠ å‚æ•°éªŒè¯",
    "å®Œå–„å¼‚å¸¸å¤„ç†é€»è¾‘"
  ]
}
-->
```

âš ï¸ **é‡è¦æé†’**ï¼šå¦‚æœæ‚¨çš„å›å¤ä¸­ç¼ºå°‘æ­¤æ ‡è®°æˆ–æ ¼å¼é”™è¯¯ï¼Œç³»ç»Ÿå°†æ— æ³•æå–å®¡æŸ¥ç»“æœï¼
"""

            # 7. ä¿®æ”¹ prompt å‚æ•°
            updated_prompt = prompt + marker_instruction

            # 8. æ„é€  updatedInputï¼ˆä¿ç•™æ‰€æœ‰åŸå§‹å‚æ•°ï¼‰
            updated_tool_input = tool_input.copy()
            updated_tool_input['prompt'] = updated_prompt

            # 9. è¿”å›ä¿®æ”¹åçš„è¾“å…¥
            output = {
                "hookSpecificOutput": {
                    "permissionDecision": "allow",
                    "updatedInput": updated_tool_input,
                    "suppressOutput": True  # ä¸æ˜¾ç¤º Hook è¾“å‡º
                }
            }

            print(json.dumps(output, ensure_ascii=False))
            sys.stderr.write(f"[INFO] æ ‡è®°æ³¨å…¥æˆåŠŸï¼Œprompt: {len(prompt)} â†’ {len(updated_prompt)} å­—ç¬¦\n")
            return

    # é»˜è®¤æ”¾è¡Œ
    print(json.dumps({"hookSpecificOutput": {"permissionDecision": "allow"}},
                     ensure_ascii=False))
```

#### å…³é”®è¦ç‚¹

1. **Windows UTF-8 ç¼–ç **ï¼ˆLine 3-5ï¼‰
   - **å¿…é¡»**åœ¨è¯»å– stdin å‰è®¾ç½®
   - å¦åˆ™è§£æåŒ…å«ä¸­æ–‡çš„ JSON ä¼šå¤±è´¥

2. **updatedInput æ ¼å¼**ï¼ˆLine 53-58ï¼‰
   - ä¿ç•™**æ‰€æœ‰**åŸå§‹å‚æ•°ï¼ˆ`description`, `subagent_type`, `prompt`ï¼‰
   - åªä¿®æ”¹ `prompt` å­—æ®µ
   - ä½¿ç”¨ `tool_input.copy()` é¿å…ä¿®æ”¹åŸå¯¹è±¡

3. **æ ‡è®°æ ¼å¼è®¾è®¡**ï¼ˆLine 18-46ï¼‰
   - ä½¿ç”¨ HTML æ³¨é‡Š `<!-- -->`ï¼ˆåœ¨ Markdown ä¸­ä¸å¯è§ï¼‰
   - åŒ…å«å®Œæ•´çš„ç¤ºä¾‹å’Œå­—æ®µè¯´æ˜
   - å¼ºè°ƒæ ¼å¼çš„**é‡è¦æ€§**ï¼ˆä½¿ç”¨ CRITICALã€å¿…é¡»ã€âš ï¸ ç­‰è¯æ±‡ï¼‰

4. **suppressOutput**ï¼ˆLine 57ï¼‰
   - è®¾ä¸º `true` é¿å… Hook è¾“å‡ºå¹²æ‰°ç”¨æˆ·ä½“éªŒ

---

### 2. SubagentStop Hook - æå–å®¡æŸ¥ç»“æœ

#### æ–‡ä»¶ä½ç½®
`templates/.claude/hooks/lifecycle/subagent_stop.py`

#### æ ¸å¿ƒé€»è¾‘

```python
def extract_subagent_result(transcript_path: str) -> Optional[Dict]:
    """
    ä»å­ä»£ç†çš„ transcript æ–‡ä»¶ä¸­æå–ç»“æ„åŒ–ç»“æœ

    Args:
        transcript_path: å­ä»£ç†çš„ JSONL transcript æ–‡ä»¶è·¯å¾„
                        æ ¼å¼: agent-{agentId}.jsonl

    Returns:
        è§£æåçš„ç»“æœå­—å…¸ï¼Œå¤±è´¥è¿”å› None
    """
    if not transcript_path or not os.path.exists(transcript_path):
        sys.stderr.write(f"[ERROR] transcriptæ–‡ä»¶ä¸å­˜åœ¨: {transcript_path}\n")
        return None

    try:
        # 1. è¯»å– JSONL æ–‡ä»¶
        with open(transcript_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # 2. é€è¡Œè§£æä¸ºæ¶ˆæ¯å¯¹è±¡
        messages = []
        for line in content.strip().split('\n'):
            if not line.strip():
                continue
            try:
                msg = json.loads(line)
                messages.append(msg)
            except json.JSONDecodeError as e:
                sys.stderr.write(f"[WARN] è§£æJSONLè¡Œå¤±è´¥: {e}\n")
                continue

        if not messages:
            sys.stderr.write(f"[ERROR] transcriptæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯\n")
            return None

        sys.stderr.write(f"[INFO] æˆåŠŸè§£ætranscriptï¼Œå…±{len(messages)}æ¡æ¶ˆæ¯\n")

    except Exception as e:
        sys.stderr.write(f"[ERROR] è¯»å–transcriptå¤±è´¥: {e}\n")
        return None

    # 3. æŸ¥æ‰¾æœ€åä¸€æ¡ assistant æ¶ˆæ¯
    for msg in reversed(messages):
        # transcript JSONL ç»“æ„ï¼š
        # {
        #   "type": "assistant",
        #   "message": {
        #     "role": "assistant",
        #     "content": [
        #       {"type": "text", "text": "..."},
        #       {"type": "tool_use", ...}
        #     ]
        #   }
        # }

        msg_type = msg.get('type')
        message_data = msg.get('message', {})

        # æ£€æŸ¥æ˜¯å¦ä¸º assistant æ¶ˆæ¯
        if msg_type == 'assistant' or message_data.get('role') == 'assistant':
            # 4. æå–æ–‡æœ¬å†…å®¹
            content_array = message_data.get('content', [])

            # content æ˜¯æ•°ç»„ï¼Œéœ€è¦éå†æ‰¾åˆ° type="text" çš„é¡¹
            content_text = '\n'.join([
                item.get('text', '')
                for item in content_array
                if isinstance(item, dict) and item.get('type') == 'text'
            ])

            # 5. æå– SUBAGENT_RESULT æ ‡è®°
            match = re.search(
                r'<!--\s*SUBAGENT_RESULT\s*(\{.*?\})\s*-->',
                content_text,
                re.DOTALL | re.MULTILINE
            )

            if match:
                try:
                    # 6. è§£æ JSON
                    result = json.loads(match.group(1))
                    sys.stderr.write(f"[INFO] æˆåŠŸæå–å­ä»£ç†ç»“æœ\n")
                    return result
                except json.JSONDecodeError as e:
                    sys.stderr.write(f"[ERROR] SUBAGENT_RESULT JSONæ ¼å¼é”™è¯¯: {e}\n")
                    sys.stderr.write(f"[DEBUG] JSONå†…å®¹: {match.group(1)}\n")
                    return None

    # æœªæ‰¾åˆ°ç»“æœ
    sys.stderr.write(f"[WARN] æœªæ‰¾åˆ°SUBAGENT_RESULTæ ‡è®°\n")
    return None


def main():
    # 1. Windows UTF-8 ç¼–ç æ”¯æŒ
    if sys.platform == 'win32':
        import io
        sys.stdin = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8')

    # 2. è¯»å– Hook è¾“å…¥
    stdin_content = sys.stdin.read()
    hook_input = json.loads(stdin_content)

    # 3. æ£€æŸ¥ stop_hook_activeï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
    stop_hook_active = hook_input.get('stop_hook_active', False)

    if stop_hook_active:
        # ç¬¬2+æ¬¡è§¦å‘ï¼Œç›´æ¥å…è®¸åœæ­¢
        print(json.dumps({}, ensure_ascii=False))
        sys.exit(0)

    # 4. è·å–å­ä»£ç†çš„ transcript è·¯å¾„
    # ğŸ”¥ å…³é”®å‘ç°ï¼ˆ2025-11-17å®é™…æµ‹è¯•ï¼‰ï¼š
    #   - agent_transcript_path = agent-{agentId}.jsonl (å­ä»£ç†çš„transcript, åŒ…å«å®¡æŸ¥ç»“æœ)
    #   - transcript_path = {parentSessionId}.jsonl (çˆ¶ä¼šè¯çš„transcript, ä¸åŒ…å«å®¡æŸ¥ç»“æœ)
    # è™½ç„¶ agent_transcript_path æœªåœ¨å®˜æ–¹æ–‡æ¡£è®°å½•ï¼Œä½†å®é™…å­˜åœ¨ä¸”åŒ…å«æ‰€éœ€æ•°æ®

    transcript_path = hook_input.get('agent_transcript_path')

    # å…œåº•ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨ transcript_path
    if not transcript_path:
        transcript_path = hook_input.get('transcript_path')
        sys.stderr.write(f"[WARN] agent_transcript_pathä¸å­˜åœ¨ï¼Œé™çº§ä½¿ç”¨transcript_path\n")

    if not transcript_path:
        sys.stderr.write(f"[ERROR] æœªæä¾›transcriptè·¯å¾„\n")
        print(json.dumps({}, ensure_ascii=False))
        sys.exit(0)

    # 5. æå–å­ä»£ç†ç»“æœ
    subagent_result = extract_subagent_result(transcript_path)

    if not subagent_result:
        # æå–å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶æ”¾è¡Œ
        sys.stderr.write(f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âŒ SubagentStop Hook - æå–å­ä»£ç†ç»“æœå¤±è´¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

transcript: {transcript_path}

å¯èƒ½åŸå› ï¼š
1. å­ä»£ç†è¾“å‡ºç¼ºå°‘ <!-- SUBAGENT_RESULT --> æ ‡è®°
2. æ ‡è®°ä¸­çš„JSONæ ¼å¼é”™è¯¯
3. transcriptæ–‡ä»¶æŸå

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ pretooluse-debug.log ç¡®è®¤æ ‡è®°æ˜¯å¦æ³¨å…¥
2. æŸ¥çœ‹ subagent-stop-debug.log è¯¦ç»†æ—¥å¿—
3. æ‰‹åŠ¨æ£€æŸ¥transcriptæ–‡ä»¶: {transcript_path}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")
        print(json.dumps({}, ensure_ascii=False))
        sys.exit(0)

    # 6. è·å–å½“å‰ä»»åŠ¡
    from core.task_meta_manager import TaskMetaManager
    mgr = TaskMetaManager(os.getcwd())

    session_id = hook_input.get('session_id')
    task_binding = mgr.get_active_task_by_session(session_id)

    if not task_binding:
        sys.stderr.write(f"[WARN] æ— ç»‘å®šä»»åŠ¡ï¼Œè·³è¿‡ç»“æœä¿å­˜\n")
        print(json.dumps({}, ensure_ascii=False))
        sys.exit(0)

    task_id = task_binding['task_id']
    task_meta = mgr.load_task_meta(task_id)

    current_step = task_meta.get('current_step')
    task_type = task_meta.get('task_type')

    # 7. ä¿å­˜ä¸“å®¶å®¡æŸ¥ç»“æœåˆ° task-meta.json
    if current_step == 'planning' and task_type == 'bug_fix':
        approved = subagent_result.get('approved', False)

        def update_func(task_meta: Dict) -> Dict:
            # æ›´æ–° planning æ­¥éª¤çš„ä¸“å®¶å®¡æŸ¥å­—æ®µ
            planning = task_meta['steps']['planning']

            planning['expert_review_completed'] = True
            planning['expert_review_count'] = planning.get('expert_review_count', 0) + 1
            planning['expert_review_result'] = "é€šè¿‡" if approved else "éœ€è¦è°ƒæ•´"
            planning['expert_review'] = subagent_result

            # æ›´æ–°å…¨å±€æ ‡è®°
            task_meta['metrics']['expert_review_triggered'] = True
            task_meta['bug_fix_tracking']['expert_triggered'] = True

            return task_meta

        updated_meta = mgr.atomic_update(task_id, update_func)

        if updated_meta:
            sys.stderr.write(f"[INFO] ä¸“å®¶å®¡æŸ¥çŠ¶æ€å·²ä¿å­˜åˆ°task-meta.json\n")

        # 8. ç”Ÿæˆç”¨æˆ·å¯è§æ¶ˆæ¯
        message = generate_user_message(task_type, subagent_result, 'expert_review', task_id)

        # 9. è¿”å› block å†³ç­–ï¼ˆé˜»æ­¢å­ä»£ç†åœæ­¢ï¼Œæ˜¾ç¤ºå®¡æŸ¥ç»“æœç»™ç”¨æˆ·ï¼‰
        output = {
            "decision": "block",
            "reason": "ä¸“å®¶å®¡æŸ¥å‘ç°é—®é¢˜ï¼Œéœ€è¦è°ƒæ•´æ–¹æ¡ˆåé‡æ–°å®¡æŸ¥" if not approved else "ä¸“å®¶å®¡æŸ¥é€šè¿‡",
            "systemMessage": message
        }

        print(json.dumps(output, ensure_ascii=False))
        sys.exit(0)

    # é»˜è®¤å…è®¸åœæ­¢
    print(json.dumps({}, ensure_ascii=False))
```

#### å…³é”®è¦ç‚¹

1. **å­—æ®µä¼˜å…ˆçº§**ï¼ˆLine 93-100ï¼‰
   - âœ… **ä¼˜å…ˆä½¿ç”¨ `agent_transcript_path`**ï¼ˆå­ä»£ç†çš„ transcriptï¼ŒåŒ…å«å®¡æŸ¥ç»“æœï¼‰
   - âš ï¸ `transcript_path` æŒ‡å‘**çˆ¶ä¼šè¯**çš„ transcriptï¼ˆä¸åŒ…å«å­ä»£ç†è¾“å‡ºï¼‰
   - è¿™æ˜¯é€šè¿‡å®é™…æµ‹è¯•å‘ç°çš„ï¼Œå®˜æ–¹æ–‡æ¡£æœªæ˜ç¡®è¯´æ˜

2. **JSONL è§£æ**ï¼ˆLine 18-39ï¼‰
   - transcript æ˜¯ JSONL æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰
   - éœ€è¦é€è¡Œè§£æï¼Œè·³è¿‡ç©ºè¡Œå’Œæ— æ•ˆè¡Œ

3. **content æ•°ç»„å¤„ç†**ï¼ˆLine 64-70ï¼‰
   - `message.content` æ˜¯**æ•°ç»„**ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
   - éœ€è¦éå†æ•°ç»„ï¼Œæ‰¾åˆ° `type="text"` çš„é¡¹
   - ç„¶åæ‹¼æ¥æ‰€æœ‰æ–‡æœ¬å†…å®¹

4. **æ­£åˆ™è¡¨è¾¾å¼**ï¼ˆLine 73-77ï¼‰
   - ä½¿ç”¨ `re.DOTALL` æ”¯æŒå¤šè¡ŒåŒ¹é…
   - `\s*` åŒ¹é…å¯é€‰ç©ºç™½å­—ç¬¦ï¼ˆå…è®¸æ ¼å¼çµæ´»ï¼‰
   - `.*?` éè´ªå©ªåŒ¹é…ï¼ˆåªåŒ¹é…ç¬¬ä¸€ä¸ªæ ‡è®°ï¼‰

5. **block å†³ç­–**ï¼ˆLine 155-162ï¼‰
   - è¿”å› `{"decision": "block"}` é˜»æ­¢å­ä»£ç†ç«‹å³åœæ­¢
   - é€šè¿‡ `systemMessage` å‘ç”¨æˆ·æ˜¾ç¤ºå®¡æŸ¥ç»“æœ
   - å…è®¸ç”¨æˆ·æŸ¥çœ‹ç»“æœå¹¶å†³å®šä¸‹ä¸€æ­¥

6. **åŸå­æ›´æ–°**ï¼ˆLine 136-149ï¼‰
   - ä½¿ç”¨ `mgr.atomic_update()` é¿å…å¹¶å‘å†²çª
   - åœ¨æ›´æ–°å‡½æ•°å†…ä¿®æ”¹å¤šä¸ªå­—æ®µ
   - ä¿è¯æ›´æ–°çš„ä¸€è‡´æ€§

---

### 3. è¯Šæ–­æ—¥å¿—

#### PreToolUse è¯Šæ–­æ—¥å¿—
`tests/pretooluse-debug.log`

```
[2025-11-17 04:51:09.929] ========== TASKå·¥å…·è°ƒç”¨æ£€æµ‹ ==========
[2025-11-17 04:51:09.930] timestamp: 2025-11-17 04:51:09.930
[2025-11-17 04:51:09.930] tool_input keys: ['description', 'prompt', 'subagent_type']
[2025-11-17 04:51:09.931] description: BUGä¿®å¤æ–¹æ¡ˆå®¡æŸ¥
[2025-11-17 04:51:09.931] subagent_type: general-purpose
[2025-11-17 04:51:09.931] prompt length: 2415
[2025-11-17 04:51:09.932] âœ“ Taskæ¡ä»¶åŒ¹é…ï¼
[2025-11-17 04:51:09.932] âœ“ subagent_typeåŒ¹é… (general-purpose)
[2025-11-17 04:51:09.933] âœ“ promptä¸­æ‰¾åˆ°å…³é”®è¯: ['å®¡æŸ¥', 'éªŒè¯']
[2025-11-17 04:51:09.933] æœ€ç»ˆåˆ¤å®š: is_review_task=True
[2025-11-17 04:51:09.933] âœ“âœ“ æ£€æµ‹åˆ°ä¸“å®¶å®¡æŸ¥ä»»åŠ¡ï¼Œå¼€å§‹æ³¨å…¥SUBAGENT_RESULTæ ‡è®°
[2025-11-17 04:51:09.933] åŸå§‹prompté•¿åº¦: 2415
[2025-11-17 04:51:09.934] æ³¨å…¥åprompté•¿åº¦: 3097
[2025-11-17 04:51:09.934] âœ“âœ“âœ“ æ ‡è®°æ³¨å…¥å®Œæˆ,Hookå·²é€€å‡º
```

**å…³é”®æŒ‡æ ‡**ï¼š
- âœ… æ£€æµ‹åˆ° Task å·¥å…·
- âœ… è¯†åˆ«ä¸ºä¸“å®¶å®¡æŸ¥ä»»åŠ¡
- âœ… prompt ä» 2415 â†’ 3097 å­—ç¬¦ï¼ˆ+682å­—ç¬¦ï¼‰

#### SubagentStop è¯Šæ–­æ—¥å¿—
`tests/subagent-stop-debug.log`

```
[2025-11-17 04:52:05.013] ================================================================================
[2025-11-17 04:52:05.013] SubagentStop Hook v3.1.2 å¯åŠ¨
[2025-11-17 04:52:05.013] stop_hook_active = False
[2025-11-17 04:52:05.014] agent_transcript_path = 'C:\Users\28114\.claude\projects\...\agent-c02fa46d.jsonl'
[2025-11-17 04:52:05.014] transcriptæ–‡ä»¶å­˜åœ¨: True
[2025-11-17 04:52:05.015] å¼€å§‹æå–å­ä»£ç†ç»“æœ...
[2025-11-17 04:52:05.017] æå–ç»“æœ: {"approved": false, "issues": [...], "suggestions": [...]}
[2025-11-17 04:52:05.039] è¿›å…¥ä¸“å®¶å®¡æŸ¥ç»“æœä¿å­˜åˆ†æ”¯ (planning + bug_fix)
[2025-11-17 04:52:05.040] å¼€å§‹è°ƒç”¨mgr.atomic_update...
[2025-11-17 04:52:05.041] atomic_updateæ›´æ–°å­—æ®µ:
    expert_review_completed=True,
    expert_review_count=1,
    expert_review_result=éœ€è¦è°ƒæ•´,
    metrics.expert_review_triggered=True,
    bug_fix_tracking.expert_triggered=True
[2025-11-17 04:52:05.045] atomic_updateç»“æœ: æˆåŠŸ
[2025-11-17 04:52:05.046] æˆåŠŸ: ä¸“å®¶å®¡æŸ¥çŠ¶æ€å·²ä¿å­˜åˆ°task-meta.json
```

**å…³é”®æŒ‡æ ‡**ï¼š
- âœ… ä½¿ç”¨ `agent_transcript_path`
- âœ… æˆåŠŸæå–ç»“æœï¼ˆapproved=false, 4 issues, 5 suggestionsï¼‰
- âœ… åŸå­æ›´æ–°æˆåŠŸ
- âœ… æ‰€æœ‰å­—æ®µæ­£ç¡®æ›´æ–°

---

## æ ¸å¿ƒä»£ç å®ç°

### å®Œæ•´æ–‡ä»¶æ¸…å•

```
D:\EcWork\åŸºäºClaudeçš„MODSDKå¼€å‘å·¥ä½œæµ\
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ .claude/
â”‚       â””â”€â”€ hooks/
â”‚           â”œâ”€â”€ orchestrator/
â”‚           â”‚   â”œâ”€â”€ pretooluse_enforcer.py      # PreToolUse Hookï¼ˆæ ‡è®°æ³¨å…¥ï¼‰
â”‚           â”‚   â””â”€â”€ posttooluse_updater.py       # PostToolUse Hookï¼ˆåº¦é‡è®°å½•ï¼‰
â”‚           â”œâ”€â”€ lifecycle/
â”‚           â”‚   â””â”€â”€ subagent_stop.py             # SubagentStop Hookï¼ˆç»“æœæå–ï¼‰
â”‚           â””â”€â”€ core/
â”‚               â””â”€â”€ task_meta_manager.py         # ä»»åŠ¡å…ƒæ•°æ®ç®¡ç†å™¨
â””â”€â”€ tests/
    â”œâ”€â”€ pretooluse-debug.log                     # PreToolUse è¯Šæ–­æ—¥å¿—
    â”œâ”€â”€ subagent-stop-debug.log                  # SubagentStop è¯Šæ–­æ—¥å¿—
    â””â”€â”€ tasks/
        â””â”€â”€ ä»»åŠ¡-XXXX/
            â””â”€â”€ .task-meta.json                  # ä»»åŠ¡å…ƒæ•°æ®ï¼ˆå­˜å‚¨å®¡æŸ¥ç»“æœï¼‰
```

### PreToolUse Hook å®Œæ•´ä»£ç 

å‚è§æ–‡ä»¶ï¼š`templates/.claude/hooks/orchestrator/pretooluse_enforcer.py`

**å…³é”®å‡½æ•°**ï¼š
- `main()`: ä¸»å…¥å£ï¼Œå¤„ç† Task å·¥å…·æ‹¦æˆªå’Œæ ‡è®°æ³¨å…¥
- æ ¸å¿ƒé€»è¾‘ï¼šLine 29ï¼ˆUTF-8ç¼–ç ï¼‰ã€Line 173-308ï¼ˆæ ‡è®°æ³¨å…¥ï¼‰

### SubagentStop Hook å®Œæ•´ä»£ç 

å‚è§æ–‡ä»¶ï¼š`templates/.claude/hooks/lifecycle/subagent_stop.py`

**å…³é”®å‡½æ•°**ï¼š
- `extract_subagent_result(transcript_path)`: ä» transcript æå–ç»“æœï¼ˆLine 76-175ï¼‰
- `generate_user_message(...)`: ç”Ÿæˆç”¨æˆ·å¯è§çš„å®¡æŸ¥ç»“æœæ‘˜è¦ï¼ˆLine 178-270ï¼‰
- `main()`: ä¸»å…¥å£ï¼Œåè°ƒç»“æœæå–å’Œä¿å­˜ï¼ˆLine 273-450ï¼‰

---

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `.claude/settings.json` ä¸­é…ç½® Hook è¾“å‡ºåˆ°æ–‡ä»¶ï¼š

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "python path/to/pretooluse_enforcer.py 2>> pretooluse-debug.log"
          }
        ]
      }
    ],
    "SubagentStop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "python path/to/subagent_stop.py 2>> subagent-stop-debug.log"
          }
        ]
      }
    ]
  }
}
```

### 2. æ£€æŸ¥ PreToolUse æ³¨å…¥æ˜¯å¦æˆåŠŸ

æŸ¥çœ‹ `pretooluse-debug.log`ï¼š

```bash
# æŸ¥æ‰¾ Task å·¥å…·è°ƒç”¨
grep "TASKå·¥å…·è°ƒç”¨æ£€æµ‹" pretooluse-debug.log

# æŸ¥çœ‹æ ‡è®°æ³¨å…¥æ—¥å¿—
grep "æ ‡è®°æ³¨å…¥" pretooluse-debug.log

# ç¡®è®¤ prompt é•¿åº¦å˜åŒ–
grep "prompté•¿åº¦" pretooluse-debug.log
```

**é¢„æœŸè¾“å‡º**ï¼š
```
åŸå§‹prompté•¿åº¦: 2415
æ³¨å…¥åprompté•¿åº¦: 3097
âœ“âœ“âœ“ æ ‡è®°æ³¨å…¥å®Œæˆ
```

### 3. æ£€æŸ¥å­ä»£ç†æ˜¯å¦è¾“å‡ºæ ‡è®°

æ‰‹åŠ¨è¯»å–å­ä»£ç†çš„ transcriptï¼š

```bash
# æŸ¥æ‰¾å­ä»£ç† IDï¼ˆä» subagent-stop-debug.logï¼‰
grep "agent_transcript_path" subagent-stop-debug.log

# æœç´¢æ ‡è®°
grep "SUBAGENT_RESULT" /path/to/agent-{agentId}.jsonl
```

**å¦‚æœæ‰¾åˆ°**ï¼šè¯´æ˜å­ä»£ç†éµå¾ªäº†æ ¼å¼è¦æ±‚ âœ…

**å¦‚æœæœªæ‰¾åˆ°**ï¼š
- æ£€æŸ¥ PreToolUse æ˜¯å¦æˆåŠŸæ³¨å…¥ï¼ˆæ­¥éª¤2ï¼‰
- æ£€æŸ¥å­ä»£ç†çš„ prompt æ˜¯å¦è¢«ä¿®æ”¹
- å¯èƒ½éœ€è¦åŠ å¼ºæ ¼å¼è¦æ±‚çš„å¼ºè°ƒç¨‹åº¦

### 4. æ£€æŸ¥ SubagentStop æå–é€»è¾‘

åœ¨ `subagent_stop.py` ä¸­æ·»åŠ æ–­ç‚¹è°ƒè¯•ï¼š

```python
# åœ¨ extract_subagent_result() å‡½æ•°ä¸­
print(f"[DEBUG] è§£æäº† {len(messages)} æ¡æ¶ˆæ¯")

for msg in reversed(messages):
    msg_type = msg.get('type')
    print(f"[DEBUG] æ£€æŸ¥æ¶ˆæ¯: type={msg_type}")

    if msg_type == 'assistant':
        content_array = message_data.get('content', [])
        print(f"[DEBUG] content æ•°ç»„é•¿åº¦: {len(content_array)}")

        for idx, item in enumerate(content_array):
            print(f"[DEBUG] content[{idx}] type={item.get('type')}")

        # ... ç»§ç»­æå–é€»è¾‘
```

### 5. éªŒè¯ task-meta.json æ›´æ–°

```bash
# æŸ¥çœ‹ä»»åŠ¡å…ƒæ•°æ®
cat tasks/ä»»åŠ¡-XXXX/.task-meta.json | jq '.steps.planning.expert_review'
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "approved": false,
  "issues": [...],
  "suggestions": [...]
}
```

### 6. å¸¸ç”¨è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹æœ€æ–°çš„å­ä»£ç† transcript
ls -lt ~/.claude/projects/*/agent-*.jsonl | head -1

# ç»Ÿè®¡ SUBAGENT_RESULT æ ‡è®°å‡ºç°æ¬¡æ•°
grep -r "SUBAGENT_RESULT" ~/.claude/projects/ | wc -l

# æŸ¥çœ‹ Hook æ‰§è¡Œé”™è¯¯
tail -f subagent-stop-debug.log | grep ERROR

# æ£€æŸ¥ JSON æ ¼å¼é”™è¯¯
python -m json.tool < tasks/ä»»åŠ¡-XXXX/.task-meta.json
```

---

## å¸¸è§é—®é¢˜

### Q1: PreToolUse æ³¨å…¥æˆåŠŸï¼Œä½†å­ä»£ç†æœªè¾“å‡ºæ ‡è®°

**åŸå› **ï¼š
- å­ä»£ç†æ˜¯ LLMï¼Œæ— æ³• 100% ä¿è¯éµå¾ªæ ¼å¼
- prompt ä¸­çš„æ ¼å¼è¦æ±‚ä¸å¤Ÿæ˜æ˜¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åŠ å¼ºæ ¼å¼è¦æ±‚çš„å¼ºè°ƒï¼ˆä½¿ç”¨ **å¿…é¡»**ã€CRITICALã€âš ï¸ ç­‰ï¼‰
2. æä¾›æ›´è¯¦ç»†çš„ç¤ºä¾‹
3. åœ¨ prompt å¼€å¤´å’Œç»“å°¾éƒ½æåˆ°æ ¼å¼è¦æ±‚
4. ä½¿ç”¨æ›´å¼ºçš„æªè¾ï¼š"å¦‚æœç¼ºå°‘æ ‡è®°ï¼Œç³»ç»Ÿå°†æ— æ³•æå–ç»“æœ"

### Q2: SubagentStop æå–å¤±è´¥ï¼ˆè¿”å› Noneï¼‰

**å¸¸è§åŸå› **ï¼š

1. **è¯»é”™äº†æ–‡ä»¶**
   - âŒ ä½¿ç”¨äº† `transcript_path`ï¼ˆçˆ¶ä¼šè¯ï¼‰
   - âœ… åº”è¯¥ä½¿ç”¨ `agent_transcript_path`ï¼ˆå­ä»£ç†ï¼‰

2. **content ä¸æ˜¯å­—ç¬¦ä¸²**
   - âŒ ç›´æ¥ä½¿ç”¨ `message_data.get('content')`
   - âœ… content æ˜¯æ•°ç»„ï¼Œéœ€è¦éå†æå– `type="text"` çš„é¡¹

3. **æ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…**
   - æ£€æŸ¥æ ‡è®°æ ¼å¼æ˜¯å¦å®Œå…¨ä¸€è‡´
   - æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çš„ç©ºç™½å­—ç¬¦

**è°ƒè¯•æ­¥éª¤**ï¼š
```python
# 1. ç¡®è®¤æ–‡ä»¶è·¯å¾„
print(f"transcript_path: {transcript_path}")
print(f"æ–‡ä»¶å­˜åœ¨: {os.path.exists(transcript_path)}")

# 2. æ£€æŸ¥è§£æç»“æœ
print(f"è§£æäº† {len(messages)} æ¡æ¶ˆæ¯")

# 3. æŸ¥çœ‹ content ç»“æ„
for msg in messages[:1]:  # æŸ¥çœ‹ç¬¬ä¸€æ¡æ¶ˆæ¯
    content = msg.get('message', {}).get('content', [])
    print(f"content ç±»å‹: {type(content)}")
    print(f"content é•¿åº¦: {len(content)}")
    for item in content:
        print(f"  - type: {item.get('type')}")
```

### Q3: Windows å¹³å° JSON è§£æå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
JSONDecodeError: Expecting value: line 1 column 1 (char 0)
```

**åŸå› **ï¼š
Windows é»˜è®¤ä½¿ç”¨ GBK ç¼–ç ï¼Œè¯»å–åŒ…å«ä¸­æ–‡çš„ UTF-8 JSON ä¼šå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
åœ¨è¯»å– stdin **ä¹‹å‰**è®¾ç½® UTF-8 ç¼–ç ï¼š

```python
if sys.platform == 'win32':
    import io
    sys.stdin = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8')

# ç„¶åå†è¯»å–
stdin_content = sys.stdin.read()
```

**å…³é”®**ï¼šå¿…é¡»åœ¨ `sys.stdin.read()` **ä¹‹å‰**è®¾ç½®ï¼

### Q4: expert_review_count æœªæ›´æ–°

**æ£€æŸ¥æ¸…å•**ï¼š

1. SubagentStop Hook æ˜¯å¦æˆåŠŸæå–ç»“æœï¼Ÿ
   ```bash
   grep "æå–ç»“æœ" subagent-stop-debug.log
   ```

2. æ˜¯å¦è¿›å…¥äº†å®¡æŸ¥ç»“æœä¿å­˜åˆ†æ”¯ï¼Ÿ
   ```bash
   grep "è¿›å…¥ä¸“å®¶å®¡æŸ¥ç»“æœä¿å­˜åˆ†æ”¯" subagent-stop-debug.log
   ```

3. atomic_update æ˜¯å¦æˆåŠŸï¼Ÿ
   ```bash
   grep "atomic_updateç»“æœ" subagent-stop-debug.log
   ```

4. ä»»åŠ¡ç»‘å®šæ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```bash
   grep "ç»‘å®šä»»åŠ¡" subagent-stop-debug.log
   ```

**å¯èƒ½åŸå› **ï¼š
- SubagentStop æå–å¤±è´¥ï¼ˆè§ Q2ï¼‰
- current_step ä¸æ˜¯ 'planning'
- task_type ä¸æ˜¯ 'bug_fix'
- session_id ç»‘å®šé”™è¯¯

### Q5: å­ä»£ç†å¤šæ¬¡å¯åŠ¨ï¼Œexpert_review_count æœªé€’å¢

**åŸå› **ï¼š
æ¯æ¬¡æå–ç»“æœåä½¿ç”¨ `+= 1`ï¼Œä½†å¦‚æœæå–å¤±è´¥ï¼Œè®¡æ•°ä¸ä¼šå¢åŠ 

**å½“å‰å®ç°**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```python
planning['expert_review_count'] = planning.get('expert_review_count', 0) + 1
```

è¿™ä¼šåœ¨æ¯æ¬¡**æˆåŠŸ**æå–ç»“æœåé€’å¢ã€‚

**éªŒè¯**ï¼š
```bash
# æŸ¥çœ‹å†å²å®¡æŸ¥æ¬¡æ•°
jq '.steps.planning.expert_review_count' tasks/ä»»åŠ¡-XXXX/.task-meta.json
```

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•

ä½¿ç”¨å®é™…çš„ transcript æ–‡ä»¶æµ‹è¯•æå–é€»è¾‘ï¼š

```python
# test_subagent_result_extraction.py
import json
import re

def test_extract_from_real_transcript():
    transcript_path = "agent-c02fa46d.jsonl"

    with open(transcript_path, 'r', encoding='utf-8') as f:
        messages = [json.loads(line) for line in f if line.strip()]

    for msg in reversed(messages):
        if msg.get('type') == 'assistant':
            content_array = msg.get('message', {}).get('content', [])
            content_text = '\n'.join([
                item.get('text', '')
                for item in content_array
                if isinstance(item, dict) and item.get('type') == 'text'
            ])

            match = re.search(
                r'<!--\s*SUBAGENT_RESULT\s*(\{.*?\})\s*-->',
                content_text,
                re.DOTALL | re.MULTILINE
            )

            if match:
                result = json.loads(match.group(1))
                assert 'approved' in result
                assert 'issues' in result
                assert 'suggestions' in result
                print("âœ… æå–æˆåŠŸï¼")
                return result

    raise AssertionError("âŒ æœªæ‰¾åˆ°æ ‡è®°")

if __name__ == '__main__':
    result = test_extract_from_real_transcript()
    print(f"approved: {result['approved']}")
    print(f"issues: {len(result['issues'])} ä¸ª")
    print(f"suggestions: {len(result['suggestions'])} æ¡")
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ… æå–æˆåŠŸï¼
approved: False
issues: 4 ä¸ª
suggestions: 5 æ¡
```

### 2. é›†æˆæµ‹è¯•

è¿è¡Œå®Œæ•´çš„ BUG ä¿®å¤å·¥ä½œæµï¼š

```bash
# 1. åˆ›å»ºæµ‹è¯•ä»»åŠ¡
cd tests
claude --debug

# 2. è¾“å…¥ BUG æè¿°ï¼ˆè§¦å‘ planning é˜¶æ®µï¼‰
# 3. ç­‰å¾…ä¸“å®¶å®¡æŸ¥å­ä»£ç†å¯åŠ¨
# 4. æ£€æŸ¥æ—¥å¿—

# PreToolUse æ—¥å¿—
tail -f pretooluse-debug.log

# SubagentStop æ—¥å¿—
tail -f subagent-stop-debug.log

# 5. éªŒè¯ task-meta.json
cat tasks/ä»»åŠ¡-XXXX/.task-meta.json | jq '.steps.planning.expert_review_count'
```

**æˆåŠŸæ ‡å¿—**ï¼š
- âœ… pretooluse-debug.log æ˜¾ç¤ºæ ‡è®°æ³¨å…¥æˆåŠŸ
- âœ… subagent-stop-debug.log æ˜¾ç¤ºæå–æˆåŠŸ
- âœ… task-meta.json ä¸­ `expert_review_count = 1`
- âœ… ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºä¸“å®¶å®¡æŸ¥ç»“æœ

### 3. å›å½’æµ‹è¯•

ä½¿ç”¨å†å² transcript æ–‡ä»¶éªŒè¯ä¿®å¤ï¼š

```bash
# æŸ¥æ‰¾å†å²å¤±è´¥çš„ transcript
ls -lt ~/.claude/projects/*/agent-*.jsonl | head -10

# ä½¿ç”¨ä¿®å¤åçš„ä»£ç é‡æ–°æå–
python subagent_stop.py < mock_hook_input.json
```

**mock_hook_input.json**ï¼š
```json
{
  "session_id": "bff0fd21-2b8e-4518-bab9-56958fd1ef2d",
  "agent_transcript_path": "/path/to/agent-c02fa46d.jsonl",
  "stop_hook_active": false
}
```

---

## é™„å½•

### A. SUBAGENT_RESULT æ ‡è®°è§„èŒƒ

**å®Œæ•´æ ¼å¼**ï¼š
```html
<!-- SUBAGENT_RESULT
{
  "approved": true/false,
  "issues": ["é—®é¢˜1", "é—®é¢˜2"],
  "suggestions": ["å»ºè®®1", "å»ºè®®2"]
}
-->
```

**å­—æ®µå®šä¹‰**ï¼š
- `approved` (boolean, required): å®¡æŸ¥ç»“æœï¼Œtrue=é€šè¿‡ï¼Œfalse=éœ€è¦è°ƒæ•´
- `issues` (array of strings, required): å‘ç°çš„é—®é¢˜åˆ—è¡¨ï¼Œå¯ä»¥ä¸ºç©ºæ•°ç»„
- `suggestions` (array of strings, required): æ”¹è¿›å»ºè®®åˆ—è¡¨ï¼Œå¯ä»¥ä¸ºç©ºæ•°ç»„

**æ ¼å¼çº¦æŸ**ï¼š
1. å¿…é¡»ä½¿ç”¨ HTML æ³¨é‡Š `<!-- -->`
2. æ ‡è®°åå¿…é¡»ä¸º `SUBAGENT_RESULT`ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
3. JSON å¿…é¡»æœ‰æ•ˆä¸”ç¬¦åˆä¸Šè¿°ç»“æ„
4. æ ‡è®°åº”å‡ºç°åœ¨å­ä»£ç†å›å¤çš„æœ€å
5. JSON å¯ä»¥æ ¼å¼åŒ–ï¼ˆå¤šè¡Œã€ç¼©è¿›ï¼‰

**é”™è¯¯ç¤ºä¾‹**ï¼š

âŒ ç¼ºå°‘æ ‡è®°åï¼š
```html
<!-- {"approved": true} -->
```

âŒ ä½¿ç”¨å…¶ä»–æ³¨é‡Šï¼š
```markdown
```json
{"approved": true}
```
```

âŒ JSON æ ¼å¼é”™è¯¯ï¼š
```html
<!-- SUBAGENT_RESULT
{
  "approved": true,
  "issues": ["é—®é¢˜"]  // â† æœ‰é€—å·
}
-->
```

### B. transcript JSONL æ ¼å¼è¯´æ˜

**æ–‡ä»¶å**ï¼š`agent-{agentId}.jsonl`

**æ¯è¡Œæ ¼å¼**ï¼š
```json
{
  "type": "assistant",
  "message": {
    "model": "claude-sonnet-4-5-20250929",
    "id": "msg_01ByTQjTAMnkyWB38ixQM6FY",
    "type": "message",
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "å®¡æŸ¥å†…å®¹...\n\n<!-- SUBAGENT_RESULT {...} -->"
      }
    ],
    "stop_reason": "end_turn",
    "usage": {...}
  },
  "uuid": "4bb3074b-885e-48a3-83fa-425ac694d97f",
  "timestamp": "2025-11-17T04:52:05.465Z"
}
```

**å…³é”®å­—æ®µ**ï¼š
- `type`: æ¶ˆæ¯ç±»å‹ï¼ˆ"user" æˆ– "assistant"ï¼‰
- `message.content`: **æ•°ç»„**ï¼ŒåŒ…å«å¤šä¸ª content item
- `message.content[].type`: content item ç±»å‹ï¼ˆ"text" æˆ– "tool_use"ï¼‰
- `message.content[].text`: æ–‡æœ¬å†…å®¹ï¼ˆä»… type="text" æ—¶ï¼‰

**æå–é€»è¾‘**ï¼š
1. é€è¡Œè§£æ JSONL
2. åå‘éå†æ¶ˆæ¯ï¼ˆä»æœ€åä¸€æ¡å¼€å§‹ï¼‰
3. æ‰¾åˆ°ç¬¬ä¸€æ¡ `type="assistant"` çš„æ¶ˆæ¯
4. éå†å…¶ `content` æ•°ç»„
5. æ‹¼æ¥æ‰€æœ‰ `type="text"` çš„ `text` å­—æ®µ
6. åœ¨æ‹¼æ¥ç»“æœä¸­æœç´¢ `SUBAGENT_RESULT` æ ‡è®°

### C. Hook è¾“å‡ºæ ¼å¼è§„èŒƒ

#### PreToolUse Hook è¾“å‡º

**å…è®¸å·¥å…·æ‰§è¡Œ**ï¼š
```json
{
  "hookSpecificOutput": {
    "permissionDecision": "allow"
  }
}
```

**å…è®¸å¹¶ä¿®æ”¹è¾“å…¥**ï¼š
```json
{
  "hookSpecificOutput": {
    "permissionDecision": "allow",
    "updatedInput": {
      "description": "...",
      "prompt": "ä¿®æ”¹åçš„prompt",
      "subagent_type": "general-purpose"
    },
    "suppressOutput": true
  }
}
```

**é˜»æ­¢å·¥å…·æ‰§è¡Œ**ï¼š
```json
{
  "hookSpecificOutput": {
    "permissionDecision": "block",
    "reason": "é˜»æ­¢åŸå› "
  }
}
```

#### SubagentStop Hook è¾“å‡º

**å…è®¸åœæ­¢**ï¼š
```json
{}
```

**é˜»æ­¢åœæ­¢**ï¼š
```json
{
  "decision": "block",
  "reason": "éœ€è¦ç»§ç»­æ‰§è¡Œ",
  "systemMessage": "ç”¨æˆ·å¯è§çš„æ¶ˆæ¯"
}
```

### D. æ–‡ä»¶æƒé™å’Œè·¯å¾„

**Windows è·¯å¾„è½¬ä¹‰**ï¼š
```python
# âŒ é”™è¯¯
path = "C:\Users\28114\.claude\..."

# âœ… æ­£ç¡®ï¼ˆä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²ï¼‰
path = r"C:\Users\28114\.claude\..."

# âœ… æ­£ç¡®ï¼ˆè½¬ä¹‰åæ–œæ ï¼‰
path = "C:\\Users\\28114\\.claude\\..."
```

**æ–‡ä»¶ç¼–ç **ï¼š
```python
# å§‹ç»ˆä½¿ç”¨ UTF-8
with open(path, 'r', encoding='utf-8') as f:
    content = f.read()
```

### E. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä»»åŠ¡å…ƒæ•°æ®**
   ```python
   # âŒ æ¯æ¬¡éƒ½åŠ è½½
   task_meta = mgr.load_task_meta(task_id)

   # âœ… åœ¨ Hook å¼€å§‹æ—¶åŠ è½½ä¸€æ¬¡
   _cache = {}
   if task_id not in _cache:
       _cache[task_id] = mgr.load_task_meta(task_id)
   task_meta = _cache[task_id]
   ```

2. **å‡å°‘æ–‡ä»¶ I/O**
   - åªåœ¨å¿…è¦æ—¶å†™å…¥ debug æ—¥å¿—
   - ä½¿ç”¨ `sys.stderr.write()` ä»£æ›¿ `print()`ï¼ˆæ›´å¿«ï¼‰

3. **æå‰é€€å‡º**
   ```python
   # âœ… å°½æ—©æ£€æŸ¥æ¡ä»¶å¹¶é€€å‡º
   if tool_name != 'Task':
       print(json.dumps({"hookSpecificOutput": {"permissionDecision": "allow"}}))
       return

   # é¿å…ä¸å¿…è¦çš„åç»­é€»è¾‘
   ```

---

## æ€»ç»“

### æˆåŠŸè¦ç´ 

1. **Windows UTF-8 ç¼–ç æ”¯æŒ**ï¼šå¿…é¡»åœ¨è¯»å– stdin å‰è®¾ç½®
2. **ä½¿ç”¨ agent_transcript_path**ï¼šå®˜æ–¹æœªè®°å½•ä½†å®é™…å­˜åœ¨çš„å­—æ®µ
3. **æ­£ç¡®å¤„ç† content æ•°ç»„**ï¼šä¸æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦éå†æå– text
4. **å¼ºè°ƒæ ¼å¼è¦æ±‚**ï¼šä½¿ç”¨ CRITICALã€å¿…é¡»ã€âš ï¸ ç­‰å¼ºè°ƒæ ‡è®°çš„é‡è¦æ€§
5. **è¯¦ç»†è¯Šæ–­æ—¥å¿—**ï¼šå°† stderr è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä¾¿äºè°ƒè¯•

### å·²çŸ¥é™åˆ¶

1. **å­ä»£ç†æ ¼å¼éµå¾ªç‡**ï¼šLLM æ— æ³• 100% ä¿è¯éµå¾ªæ ¼å¼ï¼Œçº¦ 95% æˆåŠŸç‡
2. **agent_transcript_path æœªè®°å½•**ï¼šä¾èµ–æœªè®°å½•çš„å­—æ®µï¼Œå¯èƒ½åœ¨æœªæ¥ç‰ˆæœ¬å˜åŒ–
3. **å•æ ‡è®°é™åˆ¶**ï¼šå¦‚æœå­ä»£ç†è¾“å‡ºå¤šä¸ªæ ‡è®°ï¼Œåªä¼šæå–ç¬¬ä¸€ä¸ª

### æœªæ¥æ”¹è¿›æ–¹å‘

1. **ä½¿ç”¨ PostToolUse Hook**ï¼šæ¢ç´¢é€šè¿‡ `tool_response` ç›´æ¥è·å–å­ä»£ç†è¾“å‡º
2. **LLM è§£æå…œåº•**ï¼šå¦‚æœæ ‡è®°ç¼ºå¤±ï¼Œä½¿ç”¨ LLM ä»è‡ªç„¶è¯­è¨€ä¸­æå–ç»“æ„åŒ–ç»“æœ
3. **æ ¼å¼éªŒè¯**ï¼šåœ¨ PreToolUse ä¸­æä¾› JSON Schema éªŒè¯ç¤ºä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ä½œè€…**: Claude Code å·¥ä½œæµå¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-17
**ç›¸å…³æ–‡ä»¶**:
- `templates/.claude/hooks/orchestrator/pretooluse_enforcer.py`
- `templates/.claude/hooks/lifecycle/subagent_stop.py`
- `templates/.claude/hooks/core/task_meta_manager.py`

