# 安装与配置

> **基于Claude的MODSDK开发工作流 - 快速部署指南 v2.0**
>
> 一次安装，到处使用

---

## 🎯 目标

完成安装后，你可以在**任意MODSDK项目**中使用 `initmc` 命令，自动部署完整的AI辅助开发工作流。

---

## 📋 前置要求

### 必需环境
- **Node.js** - 版本 ≥ 12.x（用于运行安装脚本和部署命令）
- **Claude Code** - AI辅助开发工具
- **Git** - 用于克隆项目

### 验证环境
```bash
# 检查Node.js
node --version
# 应显示: v12.x 或更高版本

# 检查Git
git --version
```

---

## 🚀 快速安装（2步）

> ⚠️ **Windows用户特别注意**：安装过程中需要配置PATH环境变量，请仔细阅读步骤2的说明！

### 步骤1: 克隆项目

```bash
# 克隆到你的工作目录（任意位置均可）
cd D:\EcWork  # 或你的工作目录
git clone <项目仓库地址> 基于Claude的MODSDK开发工作流
cd 基于Claude的MODSDK开发工作流
```

### 步骤2.1: 安装依赖（⚠️ 必须执行！）

```bash
# 安装项目依赖（包括 fs-extra 等必需模块）
npm install
```

> ⚠️ **重要警告**：
> - 此步骤是**必须的**，不能跳过！
> - 如果跳过此步骤，运行 `initmc` 时会报错：`Error: Cannot find module 'fs-extra'`
> - 安装脚本会自动检测依赖，缺失时会提示并尝试自动安装

### 步骤2.2: 全局安装

```bash
# 运行全局安装脚本
npm run install-global
```

**安装脚本会自动：**
- ✅ 检查依赖是否已安装（如未安装会自动执行 `npm install`）
- ✅ 将工作流文件复制到 `~/.claude-modsdk-workflow/`
- ✅ 创建全局命令 `initmc`
  - **Windows**: 在用户目录创建 `initmc.cmd`（如 `C:\Users\你的用户名\initmc.cmd`）
  - **Unix/Mac**: 添加alias到 `~/.bashrc` 或 `~/.zshrc`

**⚠️ Windows用户必读**：

安装脚本会检测你的PATH配置，如果显示以下警告：

```
⚠️  需要手动添加到PATH:
   1. 打开"环境变量"设置
   2. 在"用户变量"中找到"Path"
   3. 添加: C:\Users\你的用户名
   4. 重启终端
```

**请务必按照提示操作**，否则 `initmc` 命令将无法识别。

**详细配置步骤**：
```bash
# 1. 按 Win+R，输入 sysdm.cpl，回车
# 2. 点击"高级"选项卡 → "环境变量"
# 3. 在"用户变量"区域找到"Path"，双击编辑
# 4. 点击"新建"，添加: C:\Users\你的用户名
# 5. 点击"确定"保存
# 6. 重新打开终端（必须重启）
```

**验证安装：**
```bash
# 检查全局工作流目录
ls ~/.claude-modsdk-workflow/

# Windows:
dir "%USERPROFILE%\.claude-modsdk-workflow\"

# 检查命令是否可用
which initmc  # Unix/Mac
where initmc  # Windows

# Windows应显示:
# C:\Users\你的用户名\initmc.cmd
```

---

## ✅ 使用 initmc 命令部署工作流

### 基本用法

```bash
# 1. 打开任意MODSDK项目根目录（包含 modMain.py 的目录）
cd <你的MODSDK项目目录>

# 2. 执行部署命令
initmc

# 3. 等待部署完成（约10-30秒）

# 4. 重启Claude Code（如果已打开）

# 5. 立即开始开发
/cc 创建一个玩家加入事件监听System
```

### 部署内容（最小化部署）

**核心工作流文件**：

- ✅ **3个命令文件**：
  - `/cc` - 标准工作流任务执行器（支持被动文档维护）
  - `/validate-docs` - AI驱动的文档审计与规范化
  - `/enhance-docs` - AI驱动的文档内容生成

- ✅ **完整的 CLAUDE.md**：
  - 核心规范（CRITICAL规范，防止90%错误）
  - 三步工作流程（理解任务 → 查阅文档 → 执行与收尾）
  - 三级任务分类（微任务/标准任务/复杂任务）

- ✅ **markdown/ 目录**：
  - `开发规范.md` - MODSDK开发规范（34KB）
  - `问题排查.md` - 常见问题和解决方案（21KB）
  - `快速开始.md` - 5分钟快速上手（7KB）
  - `开发指南.md` - 完整开发工作流（20KB）
  - `API速查.md` - 常用API代码片段（15KB）
  - `MODSDK核心概念.md` - System/Component/Event/Entity速查（12KB）

- ✅ **markdown/ai/ 目录**：
  - `任务类型决策表.md` - 任务分级指南
  - `快速通道流程.md` - 微任务流程
  - `上下文管理规范.md` - 模板系统

- ✅ **目录结构**：
  - `tasks/` - 任务上下文管理
  - `markdown/systems/` - 系统文档目录（空，待生成）

**注意**：业务组件文档（Systems/States/Presets等）不会在部署时生成，而是通过 `/validate-docs` 命令由AI发现和规范化。

### 优势

- ✅ **可靠性高** - 不依赖AI理解，使用Node.js脚本直接复制文件
- ✅ **自动验证** - 每个文件复制后验证大小，确保不是空文件
- ✅ **快速部署** - 10-30秒完成（只部署核心工作流）
- ✅ **定制化配置** - 自动替换项目路径等占位符
- ✅ **友好的错误提示** - 彩色输出，清晰的错误信息
- ✅ **文档驱动** - 业务文档由AI按需生成，避免生成无用占位符

### 注意事项

- ⚠️ 必须在 MODSDK 项目根目录（包含 `modMain.py` 的目录）执行
- ⚠️ 命令会自动检测并阻止在工作流项目本身执行
- ⚠️ 如果目标目录已有工作流文件，会被覆盖

---

## 🎯 首次配置（重要！）

执行 `initmc` 完成基础部署后，**请在Claude Code中按顺序执行以下命令**：

> ⚠️ **重要区分**:
> - `initmc` - 全局命令（在终端执行）
> - `/initmc` - Slash command（已废弃，不要使用）

### 步骤0：自适应项目结构发现（新增！）⭐

```bash
/discover
```

**该命令将：**
1. **自动扫描项目代码** - 识别所有Python类和组件类型
2. **发现MODSDK官方概念** - System（ServerSystem/ClientSystem）、Component
3. **识别项目自定义模式** - State、Preset、Manager等任意自定义组织方式
4. **推断文档目录结构** - 根据项目实际使用的模式推断文档路径
5. **生成映射文件** - 输出 `.claude/discovered-patterns.json`（供后续工具使用）

**预期时间**：5-10秒（纯代码分析，不消耗Token）

⚠️ **重要**：后续的 `/validate-docs` 和 `/enhance-docs` 都依赖此文件！

---

### 步骤1：文档审计与规范化

```bash
/validate-docs
```

**该命令将：**
1. **读取自适应发现结果** - 从 `.claude/discovered-patterns.json` 获取组件列表
2. **AI智能推断规范化文档名** - AI阅读源代码，推断准确的中文文档名
   - 示例：`ShopServerSystem.py` → "商店购买系统.md"
   - 示例：`WaitingState.py` → "等待阶段状态.md"
3. **检查文档覆盖率** - 对比发现的组件和已有文档
4. **生成文档待补充清单** - 供后续 `/enhance-docs` 使用
5. **（可选）创建文档占位符** - 询问是否创建占位文档

**预期Token消耗**：10-15k tokens（使用 haiku 模型）

**预期时间**：15-30分钟（取决于项目规模）

---

### 步骤2（可选）：批量生成文档内容

```bash
/enhance-docs
```

**该命令将：**
1. 读取文档待补充清单
2. AI深度分析源代码
3. 生成高质量文档内容（1500-3000字/文档）
4. 包含完整的架构设计、API文档、代码示例、常见问题

**建议策略**：
- 🎯 **首次使用**：只补充核心组件（如：主要的Systems）
- 📊 **分批补充**：避免一次性消耗过多Token
- 🔄 **渐进式完善**：依靠 `/cc` 命令的被动维护机制逐步完善文档

**预期Token消耗**：5-10k tokens/文档（使用 sonnet 模型）

**预期时间**：10-20分钟/文档

---

### 步骤3：开始开发

```bash
/cc "任务描述"
```

**文档驱动的开发工作流**：

1. **任务开始时** - AI查阅相关文档，避免常见错误
2. **任务执行中** - 记录代码修改和新增知识
3. **任务完成时** - AI自动更新相关文档，补充新发现的内容

**被动维护机制**：
- ✅ 发现缺失文档时，自动添加到待补充清单
- ✅ 修复BUG时，自动更新"问题排查.md"
- ✅ 任务完成时，自动补充相关文档（≤2个自动，>2个询问）

**真正实现"文档越用越完善"的理念。**

---

## 📚 完整工作流总结

**工作流四段式**：
1. `initmc` → 最小化部署（只部署核心工作流）
2. `/discover` → 自适应发现项目结构（新增！5-10秒，零Token）⭐
3. `/validate-docs` → AI审计文档完整性（依赖discover结果）
4. `/enhance-docs` → AI批量生成高质量文档内容
5. `/cc` → 开发时被动维护文档

**工作流特点**：
- **最小化部署** - initmc只部署核心工作流，无无用占位符
- **自适应发现** - discover自动识别任意项目架构，零配置 ⭐
- **智能映射** - 自动推断组件→文档路径映射规则
- **AI驱动审计** - validate-docs基于发现结果验证文档覆盖率
- **按需生成** - enhance-docs支持分批、分类生成文档
- **自我完善** - cc命令在开发过程中自动维护文档

---

## 📊 部署示例输出

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  MODSDK 工作流部署工具 v2.0
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ℹ️  当前目录: D:\MyProjects\MyMod

✅ 检测到 MODSDK 项目

🔍 检测全局工作流目录...
✅ 找到全局工作流目录: C:\Users\<用户名>\.claude-modsdk-workflow

📋 复制命令文件...
  ✅ enhance-docs.md - 5.3 KB
  ✅ validate-docs.md - 6.6 KB
  ✅ cc.md - 11.6 KB (定制化)

📚 复制通用文档...
  ✅ 开发规范.md - 34.4 KB
  ✅ 问题排查.md - 21.4 KB
  ✅ 快速开始.md - 7.0 KB
  ✅ 开发指南.md - 19.7 KB
  ✅ API速查.md - 14.6 KB
  ✅ MODSDK核心概念.md - 12.0 KB

🤖 复制 AI 辅助文档...
  ✅ 任务类型决策表.md - 5.5 KB
  ✅ 快速通道流程.md - 6.6 KB
  ✅ 上下文管理规范.md - 11.6 KB

⚙️  生成定制化配置...
  ✅ CLAUDE.md - 12.2 KB

📁 创建目录结构...
  ✅ tasks/
  ✅ markdown/systems/

🔍 验证部署结果...
  ✅ .claude/commands/cc.md - 11.6 KB
  ✅ .claude/commands/enhance-docs.md - 5.3 KB
  ✅ .claude/commands/validate-docs.md - 6.6 KB
  ✅ CLAUDE.md - 12.2 KB
  ✅ markdown/开发规范.md - 34.4 KB
  ✅ markdown/问题排查.md - 21.4 KB

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 工作流部署完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 部署统计:
  ✅ 命令文件: 3 个
  ✅ 通用文档: 6 个
  ✅ AI 文档: 3 个
  ✅ 配置文件: 1 个

📝 后续步骤:
  1. 查阅 CLAUDE.md 了解 AI 工作流程
  2. 使用 /cc "任务描述" 快速创建/继续任务
  3. 查阅 markdown/ 目录下的文档

🎯 可用命令:
  /cc "任务描述" - 快速任务执行器
  /enhance-docs - 批量补充文档
  /validate-docs - 验证文档完整性

🎉 开始高效开发吧！
```

---

## 🔍 工作原理

### 全局安装后的文件位置

```
~/.claude-modsdk-workflow/
├── CLAUDE.md                    # 核心工作流配置（模板）
├── .claude/                     # Claude Code配置
│   └── commands/
│       ├── cc.md                # /cc 命令定义（模板）
│       ├── enhance-docs.md      # /enhance-docs 命令定义
│       ├── validate-docs.md     # /validate-docs 命令定义
│       └── initmc.md            # /initmc 命令定义（已废弃）
├── markdown/                    # 完整文档库
│   ├── 开发规范.md
│   ├── 问题排查.md
│   ├── 开发指南.md
│   ├── 快速开始.md
│   ├── API速查.md
│   ├── MODSDK核心概念.md
│   └── ai/                      # AI辅助文档
│       ├── 任务类型决策表.md
│       ├── 快速通道流程.md
│       └── 上下文管理规范.md
├── scripts/                     # 核心脚本
│   └── initmc.js                # 部署脚本（核心逻辑）
└── bin/                         # 全局命令入口
    └── initmc.js                # initmc 命令入口
```

### initmc 命令的工作流程

1. **检测项目类型**
   - 验证当前目录是否为MODSDK项目（检查 `modMain.py`）
   - 检测是否为工作流项目本身（防止循环部署）

2. **检测全局工作流目录**
   - 查找 `~/.claude-modsdk-workflow/`
   - 如果找不到，提示用户运行 `npm run install-global`

3. **复制命令文件**
   - 创建 `.claude/commands/` 目录
   - 复制 `enhance-docs.md` 和 `validate-docs.md`（完整内容，>5KB）
   - 生成定制化的 `cc.md`（替换项目路径占位符）

4. **复制通用文档**
   - 复制 6 个通用文档到 `markdown/` 目录
   - 复制 3 个AI辅助文档到 `markdown/ai/` 目录
   - 所有文档都验证大小（确保不是空文件）

5. **生成配置文件**
   - 生成定制化的 `CLAUDE.md`（替换项目路径和日期）

6. **创建目录结构**
   - 创建 `tasks/` 目录
   - 创建 `markdown/systems/` 目录

7. **验证部署结果**
   - 检查所有关键文件是否存在
   - 验证文件大小（>1KB，防止空文件）
   - 输出详细的部署报告

---

## ❓ 常见问题

### Q0: 执行 `initmc` 提示 "Error: Cannot find module 'fs-extra'"

**现象**: 运行 `initmc` 时出现类似以下错误：

```
Error: Cannot find module 'fs-extra'
Require stack:
  - C:\Users\用户名\.claude-modsdk-workflow\scripts\initmc.js
  - C:\Users\用户名\.claude-modsdk-workflow\bin\initmc.js
```

**原因**: 跳过了 `npm install` 步骤，导致 `fs-extra` 等依赖未安装

**解决方案（推荐顺序）**:

**方法1: 自动修复（重新执行全局安装）**
```bash
# 1. 进入工作流项目目录
cd D:\EcWork\基于Claude的MODSDK开发工作流  # 替换为你的实际路径

# 2. 重新执行全局安装（脚本会自动检测并安装依赖）
npm run install-global
```

**方法2: 手动安装依赖**
```bash
# 1. 进入工作流项目目录
cd D:\EcWork\基于Claude的MODSDK开发工作流  # 替换为你的实际路径

# 2. 安装依赖
npm install

# 3. 验证 fs-extra 已安装
dir node_modules\fs-extra  # Windows
ls node_modules/fs-extra   # Unix/Mac

# 4. 重新执行全局安装
npm run install-global
```

**方法3: 清理并重新安装**
```bash
# 1. 进入工作流项目目录
cd D:\EcWork\基于Claude的MODSDK开发工作流

# 2. 清理旧的安装
npm run uninstall  # 清理全局命令

# 3. 删除旧的依赖（可选）
rmdir /s /q node_modules  # Windows
rm -rf node_modules       # Unix/Mac

# 4. 重新安装
npm install
npm run install-global
```

**验证修复**：
```bash
# 在任意 MODSDK 项目中测试
cd <你的MODSDK项目目录>
initmc
# 应该不再报错
```

> 💡 **预防提示**：
> - 从 v15.1 版本开始，`npm run install-global` 会自动检测并安装缺失的依赖
> - 如果你使用的是旧版本，强烈建议更新到最新版本

---

### Q1: 执行 `initmc` 提示 "找不到命令"

**原因**: Windows用户目录未添加到PATH环境变量中

**⚠️ 重要**：在Windows系统上，`npm run install-global` 会在用户目录（如 `C:\Users\你的用户名\`）创建 `initmc.cmd` 批处理文件。如果该目录不在PATH中，Windows将无法识别 `initmc` 命令。

**解决方案（Windows）**:

**方法1: 添加用户目录到PATH（推荐）**
```bash
# 1. 按 Win+R，输入 sysdm.cpl，回车
# 2. 点击"高级"选项卡 → "环境变量"
# 3. 在"用户变量"区域找到"Path"，双击编辑
# 4. 点击"新建"，添加你的用户目录路径，例如：
#    C:\Users\你的用户名
# 5. 点击"确定"保存
# 6. 重新打开终端（必须重启终端才能生效）

# 验证是否生效
where initmc
# 应显示: C:\Users\你的用户名\initmc.cmd
```

**方法2: 使用npm全局bin目录（备选）**
```bash
# 检查npm全局目录
npm config get prefix
# 输出示例: C:\Users\<用户名>\AppData\Roaming\npm

# 该路径通常已在PATH中（npm安装时自动添加）
# 如果未在PATH中，参考方法1添加该路径
```

**方法3: 直接调用脚本（临时方案）**
```bash
# 不添加PATH，每次直接调用完整路径
node "%USERPROFILE%\.claude-modsdk-workflow\bin\initmc.js"
```

**解决方案（Unix/Mac）**:
```bash
# 添加到 .bashrc 或 .zshrc
export PATH="$HOME/.npm-global/bin:$PATH"
source ~/.bashrc  # 或 ~/.zshrc
```

**验证是否解决**：
```bash
# 测试命令是否可用
initmc --help

# 或者进入一个MODSDK项目目录测试
cd <你的MODSDK项目>
initmc
```

### Q2: 执行 `initmc` 提示 "找不到全局工作流目录"

**原因**: 未执行全局安装

**解决方案**:
```bash
cd <工作流项目目录>
npm install
npm run install-global
```

### Q3: 部署后某些命令文件为空或过小

**原因**: 全局工作流目录文件损坏

**解决方案**:
```bash
# 重新执行全局安装
cd <工作流项目目录>
npm run install-global

# 然后重新部署
cd <MODSDK项目目录>
initmc
```

### Q4: 想在工作流项目本身测试 `initmc`

**说明**: 不能在工作流项目本身执行 `initmc`，命令会自动检测并阻止。

**解决方案**: 应该在其他MODSDK项目中测试。

### Q5: 执行 `initmc` 提示 "当前目录不是 MODSDK 项目"

**原因**: 当前目录不包含 `modMain.py` 文件

**解决方案**:
- 确保在 MODSDK 项目根目录执行（包含 `modMain.py` 的目录）
- 如果你的项目结构特殊（如 `modMain.py` 在子目录），需要在正确的目录执行

---

## 🔄 更新工作流

如果工作流项目有更新：

```bash
# 1. 拉取最新代码
cd <工作流项目目录>
git pull

# 2. 安装新依赖（如果有）
npm install

# 3. 重新全局安装
npm run install-global

# 4. 在MODSDK项目中重新部署（可选）
cd <MODSDK项目目录>
initmc
```

---

## 🗑️ 卸载工作流

```bash
# 1. 卸载全局命令
cd <工作流项目目录>
npm run uninstall

# 2. 删除全局工作流目录（可选）
rm -rf ~/.claude-modsdk-workflow

# Windows:
rmdir /s /q "%USERPROFILE%\.claude-modsdk-workflow"
```

---

## 📚 相关文档

- **[CLAUDE.md](./CLAUDE.md)** - 工作流核心配置和使用指南
- **[Claude指令参考.md](./Claude指令参考.md)** - AI指令编写规范
- **[CHANGELOG.md](./CHANGELOG.md)** - 版本更新日志

---

## 🆕 版本更新日志

### v2.1.0 (2025-11-10) - 当前版本

**核心更新**：
- ✅ 新增 `/discover` 命令 - 自适应项目结构发现
- ✅ 完善首次配置流程 - 添加步骤0（/discover）
- ✅ 集成到文档维护工具 - /validate-docs 和 /enhance-docs 使用发现结果
- ✅ 零配置，5-10秒完成，不消耗Token

**技术亮点**：
- 📦 自动识别任意项目架构
- 🔮 智能推断文档路径映射规则
- 🗺️ 完全通用，适配任意MODSDK项目

---

### v2.0.0 (2025-11-09)

**重大变更**：
- ✅ 使用独立脚本替代 AI 驱动的 `/initmc` slash command
- ✅ 新增全局命令 `initmc`（Node.js脚本）
- ✅ 100% 可靠的文件复制（自动验证，防止空文件）
- ✅ 快速部署（10-30秒 vs 原来的3-15分钟）
- ✅ 废弃 `/initmc` slash command（标记为已废弃）

---

**版本**: v2.1.0
**最后更新**: 2025-11-10
**维护者**: MODSDK Team
