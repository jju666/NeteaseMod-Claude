# SessionStart Hook ä»ªè¡¨ç›˜ä¸æ˜¾ç¤º - âœ… v27.0 å®Œå…¨è§£å†³

> **ç¯å¢ƒ**: Windows 11, Python 3.8+, Claude Code v2.0.46
> **åŸé—®é¢˜**: SessionStart Hook è¾“å‡ºçš„ä»ªè¡¨ç›˜ä¸æ˜¾ç¤ºç»™ç”¨æˆ·
> **çœŸæ­£æ ¹æœ¬åŸå› **: **SessionStart Hook åº”è¯¥ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼Œè€Œä¸æ˜¯ JSONï¼**
> **è§£å†³æ–¹æ¡ˆ**: ç§»é™¤æ‰€æœ‰ JSON åŒ…è£…ï¼Œç›´æ¥ `print(dashboard)` è¾“å‡ºçº¯æ–‡æœ¬

---

## âœ… v27.0 çœŸæ­£çš„æ ¹æœ¬åŸå› 

### ğŸ¯ è®¾è®¡æ€è·¯é”™è¯¯

**å…³é”®å‘ç°**ï¼šé€šè¿‡å’¨è¯¢å®˜æ–¹Claudeï¼Œæˆ‘ä»¬å‘ç°æ•´ä¸ªv26.0/v26.1çš„è®¾è®¡æ€è·¯éƒ½æ˜¯**é”™è¯¯çš„**ã€‚

#### âŒ é”™è¯¯çš„è®¾è®¡ï¼ˆv26.0/v26.1ï¼‰

æˆ‘ä»¬ä¸€ç›´è®¤ä¸º SessionStart Hook åº”è¯¥è¾“å‡º JSON æ ¼å¼ï¼š

```python
# âŒ é”™è¯¯çš„v26.0/v26.1è®¾è®¡
dashboard = generate_status_dashboard(task_id, task_meta)

output = {
    "systemMessage": dashboard,  # âŒ è®¤ä¸ºéœ€è¦åŒ…è£…æˆJSON
    "hookSpecificOutput": {
        "hookEventName": "SessionStart",
        "additionalContext": guidance
    }
}

sys.stdout.flush()
print(json.dumps(output, ensure_ascii=False), flush=True)
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯é”™çš„ï¼Ÿ**
- Claude Code æ—¥å¿—æ˜¾ç¤ºï¼š`"Hook output does not start with {, treating as plain text"`
- æˆ‘ä»¬è¯¯ä»¥ä¸ºè¿™æ˜¯ä¸ªé”™è¯¯ï¼Œæ‹¼å‘½æƒ³è®©è¾“å‡ºä»¥ `{` å¼€å¤´
- å®é™…ä¸Šï¼Œ**è¿™ä¸ªæ—¥å¿—æœ¬èº«å°±è¯´æ˜äº†æ­£ç¡®çš„è¡Œä¸º**ï¼šSessionStart Hook çš„è¾“å‡º**åº”è¯¥è¢«å½“ä½œçº¯æ–‡æœ¬**ï¼

#### âœ… æ­£ç¡®çš„è®¾è®¡ï¼ˆv27.0ï¼‰

æ ¹æ®å®˜æ–¹Claudeçš„å»ºè®®ï¼š

```python
# âœ… æ­£ç¡®çš„v27.0è®¾è®¡
dashboard = """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ MODSDKå·¥ä½œæµçŠ¶æ€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡ID: ...
ä»»åŠ¡ç±»å‹: ...
...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""

sys.stdout.flush()
print(dashboard, flush=True)  # âœ… ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬
sys.exit(0)
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯å¯¹çš„ï¼Ÿ**
- SessionStart Hook çš„ stdout ä¼š**ç›´æ¥æ˜¾ç¤ºç»™ç”¨æˆ·**
- ä¸éœ€è¦ä»»ä½• JSON åŒ…è£…
- ä¸éœ€è¦ `systemMessage` æˆ– `hookSpecificOutput` å­—æ®µ
- å°±åƒåœ¨ç»ˆç«¯é‡Œ `echo` ä¸€æ ·ç®€å•

### ğŸ“ å®˜æ–¹Claudeçš„æŒ‡å¯¼

ç”¨æˆ·å’¨è¯¢å®˜æ–¹æ—¶å¾—åˆ°çš„å…³é”®å»ºè®®ï¼š

> **é—®é¢˜**ï¼šå¦‚æœæˆ‘æƒ³ä½¿ç”¨ hook å®ç°å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡å¼€å§‹ä½¿ç”¨ä¸€ä¸ª commands è‡ªå®šä¹‰å‘½ä»¤å¼€å§‹ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œåœ¨ä¼šè¯çª—å£è¾“å‡ºä¸€ä¸ªæ ¼å¼åŒ–å¥½çš„ä»ªè¡¨ç›˜è®©ç”¨æˆ·çŸ¥é“ä»»åŠ¡å¯åŠ¨äº†ï¼Œæˆ‘åº”è¯¥ç”¨å“ªä¸ª hookï¼Œæ€ä¹ˆç¼–å†™ï¼Ÿ
>
> **å®˜æ–¹å›ç­”**ï¼šä½¿ç”¨ SessionStart Hookï¼Œç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬å³å¯ã€‚ç¤ºä¾‹ä»£ç ï¼š
>
> ```python
> dashboard = """
> â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
> â•‘   ä»»åŠ¡å·²å¯åŠ¨ / ç»§ç»­æ‰§è¡Œ        â•‘
> â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
> """
> print(dashboard)  # ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼Œä¸æ˜¯JSON
> sys.exit(0)
> ```

è¿™å½»åº•æ¨ç¿»äº†æˆ‘ä»¬v26.0/v26.1çš„æ•´ä¸ªè®¾è®¡æ€è·¯ã€‚

### ğŸ”§ v27.0 ä¿®å¤è¯¦æƒ…

ä¿®æ”¹äº† [session_start.py](tests/.claude/hooks/lifecycle/session_start.py) çš„ä¸‰ä¸ªä»£ç åˆ†æ”¯ï¼Œå…¨éƒ¨æ”¹ä¸ºç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼š

#### 1. æ­£å¸¸å¯åŠ¨åˆ†æ”¯ï¼ˆç¬¬359-366è¡Œï¼‰
```python
# ========== åŸæœ‰é€»è¾‘ï¼šæ˜¾ç¤ºçŠ¶æ€ä»ªè¡¨ç›˜ ==========
dashboard = generate_status_dashboard(task_id, task_meta)

# ğŸ”¥ v27.0 å…³é”®ä¿®å¤ï¼šæ ¹æ®å®˜ç½‘Claudeå»ºè®®ï¼ŒSessionStart Hook åº”è¯¥ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬
# ä¸è¦è¾“å‡º JSONï¼çº¯æ–‡æœ¬ä¼šç›´æ¥æ˜¾ç¤ºç»™ç”¨æˆ·
sys.stdout.flush()
print(dashboard, flush=True)

sys.exit(0)
```

#### 2. å‹ç¼©æ¢å¤åˆ†æ”¯ï¼ˆç¬¬241-247è¡Œï¼‰
```python
# ========== v3.1æ–°å¢ï¼šå‹ç¼©æ¢å¤é€»è¾‘ ==========
if source == "compact":
    # ğŸ”¥ v27.0ä¿®å¤ï¼šç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼ˆæ ¹æ®å®˜ç½‘Claudeå»ºè®®ï¼‰
    recovery_prompt = generate_compact_recovery_prompt(task_id, task_meta, current_step)

    sys.stdout.flush()
    print(recovery_prompt, flush=True)
    sys.exit(0)
```

#### 3. Finalizationåˆ†æ”¯ï¼ˆç¬¬277-345è¡Œï¼‰
```python
if not is_subagent:
    # çˆ¶ä»£ç†åœ¨finalizationé˜¶æ®µï¼Œä½†æœªå¯åŠ¨å­ä»£ç†
    # ğŸ”¥ v27.0ä¿®å¤ï¼šç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼ˆæ ¹æ®å®˜ç½‘Claudeå»ºè®®ï¼‰

    finalization_prompt = u"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ Finalizationé˜¶æ®µ - å¿…é¡»å¯åŠ¨æ”¶å°¾å­ä»£ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[... å®Œæ•´æç¤ºå†…å®¹ ...]
"""

    sys.stdout.flush()
    print(finalization_prompt, flush=True)
    sys.exit(0)
```

### ğŸ“Š å¯¹æ¯”æ€»ç»“

| ç‰ˆæœ¬ | è®¾è®¡æ€è·¯ | è¾“å‡ºæ–¹å¼ | ç»“æœ |
|------|---------|---------|------|
| v26.0/v26.1 | SessionStart Hook åº”è¯¥è¾“å‡º JSON | `print(json.dumps({...}))` | âŒ ä»ªè¡¨ç›˜ä¸æ˜¾ç¤º |
| v27.0 | SessionStart Hook åº”è¯¥è¾“å‡ºçº¯æ–‡æœ¬ | `print(dashboard)` | âœ… ä»ªè¡¨ç›˜æ­£ç¡®æ˜¾ç¤º |

### ğŸ’¡ å…³é”®æ•™è®­

1. **"treating as plain text" ä¸æ˜¯é”™è¯¯**
   - è¿™ä¸ªæ—¥å¿—è¯´æ˜ Hook è¾“å‡º**åº”è¯¥**æ˜¯çº¯æ–‡æœ¬
   - æˆ‘ä»¬å´è¯¯ä»¥ä¸ºå®ƒæ˜¯é”™è¯¯ï¼Œæ‹¼å‘½æƒ³è¾“å‡ºJSON

2. **å®˜æ–¹æ–‡æ¡£çš„éšè—å‡è®¾**
   - å®˜æ–¹æ–‡æ¡£æåˆ° `hookSpecificOutput` å’Œ `systemMessage`
   - ä½†æ²¡æœ‰æ˜ç¡®è¯´æ˜ SessionStart çš„ç‰¹æ®Šæ€§
   - éœ€è¦ç›´æ¥å’¨è¯¢æ‰èƒ½å¾—åˆ°æ­£ç¡®ç­”æ¡ˆ

3. **ç®€å•å°±æ˜¯ç¾**
   - æ­£ç¡®çš„å®ç°éå¸¸ç®€å•ï¼š`print(dashboard)`
   - æˆ‘ä»¬å´ç»•äº†ä¸€å¤§åœˆç”¨JSONåŒ…è£…

---

## ğŸ—‚ï¸ é”™è¯¯å†ç¨‹å½’æ¡£ï¼ˆv26.0/v26.1ï¼‰

ä»¥ä¸‹æ˜¯v26.0/v26.1çš„é”™è¯¯å°è¯•ï¼Œä¿ç•™ä¾›å‚è€ƒå’Œè­¦ç¤ºï¼š

### v26.0/v26.1 çš„é”™è¯¯å‡è®¾

æˆ‘ä»¬å½“æ—¶è®¤ä¸ºé—®é¢˜æ˜¯ï¼š

1. âŒ **compact å’Œ finalization åˆ†æ”¯åœ¨ JSON è¾“å‡ºå‰æœ‰ stderr è¾“å‡º**
   - è®¤ä¸º stderr æ±¡æŸ“äº† stdout
   - å®é™…ä¸Šæ ¹æœ¬ä¸åº”è¯¥è¾“å‡ºJSON

2. âŒ **ç¼ºå°‘ `systemMessage` å­—æ®µ**
   - è®¤ä¸ºéœ€è¦åœ¨JSONä¸­æ·»åŠ è¿™ä¸ªå­—æ®µ
   - å®é™…ä¸Šä¸åº”è¯¥ç”¨JSONåŒ…è£…

3. âŒ **ç¼ºå°‘ç¼“å†²åŒºåˆ·æ–°**
   - è®¤ä¸ºéœ€è¦ `flush=True`
   - è¿™ä¸ªç¡®å®éœ€è¦ï¼Œä½†ä¸æ˜¯æ ¸å¿ƒé—®é¢˜

### v26.0/v26.1 çš„é”™è¯¯ä¿®å¤

```python
# âŒ v26.0/v26.1çš„é”™è¯¯ä¿®å¤
output = {
    "systemMessage": dashboard,  # ä»¥ä¸ºè¿™æ ·å°±èƒ½æ˜¾ç¤ºç»™ç”¨æˆ·
    "hookSpecificOutput": {
        "hookEventName": "SessionStart",
        "additionalContext": guidance
    }
}

sys.stdout.flush()
print(json.dumps(output, ensure_ascii=False), flush=True)
```

**ç»“æœ**ï¼šä»ªè¡¨ç›˜ä¾ç„¶ä¸æ˜¾ç¤ºï¼Œå› ä¸ºæ•´ä¸ªè®¾è®¡æ€è·¯å°±æ˜¯é”™çš„ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Claude Code Hooks å®˜æ–¹æ–‡æ¡£](https://code.claude.com/docs/en/hooks)
- [session_start.py v27.0 å®Œæ•´ä»£ç ](tests/.claude/hooks/lifecycle/session_start.py)
- [å®˜æ–¹Claudeå…³äºSessionStartçš„å»ºè®®](#å®˜æ–¹claudeçš„æŒ‡å¯¼)

---

## âœ… é—®é¢˜å·²å®Œå…¨è§£å†³

v27.0 é€šè¿‡ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬çš„æ–¹å¼ï¼Œå½»åº•è§£å†³äº†SessionStart Hookä»ªè¡¨ç›˜ä¸æ˜¾ç¤ºçš„é—®é¢˜ã€‚

**éªŒè¯æ–¹å¼**ï¼š
1. å¯åŠ¨ä¸€ä¸ªæ–°ä¼šè¯
2. è§¦å‘ SessionStart Hookï¼ˆé€šè¿‡ `/mc is running...` ç­‰å‘½ä»¤ï¼‰
3. ç¡®è®¤ä»ªè¡¨ç›˜æ­£ç¡®æ˜¾ç¤ºåœ¨ä¼šè¯çª—å£ä¸­

**æ„Ÿè°¢å®˜æ–¹Claudeçš„æŒ‡å¯¼ï¼** ğŸ™
